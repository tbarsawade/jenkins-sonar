Imports System.Data
Imports System.Data.SqlClient
Imports System.IO
Imports System.Drawing
Imports System.Net
Imports System.Xml
Imports System.Net.Security
Imports System.Net.HttpWebRequest
Imports System.Net.HttpWebResponse
Imports System.Security.Cryptography.X509Certificates
Imports System.Web.Services
Imports Newtonsoft.Json.Linq
Imports Newtonsoft.Json

Partial Class NewDocuments
    Inherits System.Web.UI.Page
    'Ajeet kumar
    Protected Sub Page_PreInit(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.PreInit
        If Request.QueryString("public") = "1" Then
            Page.MasterPageFile = "PublicMaster.master"
        End If
    End Sub
    Protected Sub grdTextBoxRule_TextChanged(sender As Object, e As EventArgs)
        Try


            Dim txt As Control = TryCast(sender, Control)
            Dim id As String = Right(txt.ID, txt.ID.Length - 3)
            Dim gvRow As GridViewRow = TryCast(txt.Parent.Parent, GridViewRow)
            Dim txtID As String = txt.ID
            txtID = txtID.Substring(0, txtID.Length - (gvRow.RowIndex.ToString).Length)
            txtID = Right(txtID, txtID.Length - 3)
            Dim GRID As GridView = CType(pnlFields.FindControl("GRD" & id), GridView)
            Dim dtField As DataTable
            Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
            Dim con As SqlConnection = New SqlConnection(conStr)
            Dim ODA As SqlDataAdapter = New SqlDataAdapter("", con)
            If con.State = ConnectionState.Closed Then
                con.Open()
            End If
            ODA.SelectCommand.CommandText = "select documenttype from mmm_mst_fields where fieldid=" & txtID
            Dim formname As String = ODA.SelectCommand.ExecuteScalar()
            con.Dispose()
            dtField = Session("D" & formname)
            Dim obj As New DynamicForm()
            Dim retObj As New RuleResponse()
            Dim lstData As New List(Of UserData)
            Dim dt As DataTable = Session("PFieldsData")
            lstData = obj.CreateCollection(pnlFields, dt)

            'lstData = CType(Session("pColl"), List(Of UserData))
            Dim lstChildData As New List(Of UserData)

            'obj.CreateCollection(pnlFields, dtField)
            Dim onlyFiltered As DataView = dtField.DefaultView
            onlyFiltered.RowFilter = "InlineEditing='1'"
            Dim dtFields As DataTable = onlyFiltered.Table.DefaultView.ToTable()
            lstChildData = obj.CreateGVCollection(gvRow, dtFields, gvRow.RowIndex)
            Dim objRule As New RuleEngin(Session("EID"), formname, "CREATED", "CONTROL")
            Dim dsrule As DataSet = objRule.GetRules()
            Dim dtrule As New DataTable
            dtrule = dsrule.Tables(1)

            ExecuteControllevelRulegrd(txtID, GRID, gvRow.RowIndex, formname, lstChildData, lstData, "", gvRow)
        Catch ex As Exception
            Throw
        End Try
    End Sub


    Public Sub ExecuteControllevelRulegrd(ctrlID As String, grd As GridView, RowNum As Integer, screenname As String, lstDataC As List(Of UserData), lstData As List(Of UserData), ctrlvalue As String, gvRow As GridViewRow)
        Dim ObjRet As New RuleResponse()
        Dim objD As New DynamicForm()

        Dim ObjRule As New RuleEngin(HttpContext.Current.Session("EID"), screenname, "CREATED", "CONTROL", ctrlID.ToString, ctrlvalue)
        Dim dsrule As DataSet = ObjRule.GetRules()
        Dim dtrule As New DataTable
        dtrule = dsrule.Tables(1)
        For Each dr As DataRow In dsrule.Tables(0).Rows
            ObjRet = ObjRule.ExecuteRule(lstData, lstDataC, True, "", dr, dtrule)
            If Not ObjRet.Success Then
                If Convert.ToString(ObjRet.FailActionType).ToUpper = "ALERT" Then
                    ObjRule.ShowAlert(Page, ObjRet.ErrorMessage)
                    'ScriptManager.RegisterStartupScript(Me, Me.GetType(), "popup", "alert('" + ObjRet.ErrorMessage + "');", True)
                    Exit Sub
                End If
            End If
        Next
        'Exit Sub
    End Sub

    Protected Sub Page_PreInit1(ByVal sender As Object, ByVal e As EventArgs) Handles Me.PreInit
        Try
            If Not Session("CTheme") Is Nothing And Not Session("CTheme") = String.Empty Then
                Page.Theme = Convert.ToString(Session("CTheme"))
            Else
                Page.Theme = "Default"
            End If
        Catch ex As Exception
        End Try

    End Sub
    Protected Sub TextBoxRule_TextChanged(sender As Object, e As EventArgs)
        Try
            Dim txt As Control = TryCast(sender, Control)
            Dim id As String = Right(txt.ID, txt.ID.Length - 3)
            Dim id1 As Integer = CInt(id)
            Dim screenname = Request.QueryString("SC").ToString
            Dim dt As DataTable = Session("PFieldsData")
            ExecuteControllevelRule(id1, pnlFields, Nothing, screenname, dt, Nothing, lblTab, False)
        Catch ex As Exception
            Throw
        End Try
    End Sub
    Protected Sub Page_Init(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Init
        If Not IsPostBack Then
            Session("AddedRow") = Nothing
        End If

        Session("FilterAddedRow") = Nothing
        Session("ALLCHILD") = Nothing
        Session("FNS") = Nothing
        'Uncommnet after Testing 05/06/17

        'Dim strPreviousPage As String = ""
        'If Request.UrlReferrer <> Nothing Then
        '    strPreviousPage = Request.UrlReferrer.Segments(Request.UrlReferrer.Segments.Length - 1)
        'End If
        'If strPreviousPage = "" Then
        '    Response.Redirect("~/Invalidaction.aspx")
        'End If
        ' Session("CHILD") = Nothing
        If Request.QueryString("SC") Is Nothing Then
        Else
            Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
            Dim con As SqlConnection = New SqlConnection(conStr)
            Dim scrname As String = Request.QueryString("SC").ToString()
            If Not Request.QueryString("TID") Is Nothing Then
                Dim tid As String = Request.QueryString("TID").ToString()
                Session("DRAFT") = "ISDRAFT"
                'With(nolock) added by Himank on 29th sep 2015
                Dim da As New SqlDataAdapter("Select Count(tid) from mmm_mst_doc_draft With(nolock)  where tid=" & tid, con)
                If con.State <> ConnectionState.Open Then
                    con.Open()
                End If
                Dim cnt As Integer = da.SelectCommand.ExecuteScalar()
                If cnt < 1 Then
                    Dim str As String = Request.RawUrl
                    If str.Contains("&tid=") Then
                        str = str.Replace("&tid=" & Request.QueryString("TID").ToString(), "")
                    End If
                    Response.Redirect(str)
                End If

            End If
            Dim str1 As String = Request.UrlReferrer.ToString().Replace(" ", String.Empty)
            Dim str2 As String = Request.Url.ToString().Replace("+", String.Empty)
            str2 = str2.Replace(" ", String.Empty)
            If str1 <> str2 Then
                Session("dtNew") = Nothing
            End If
            'With(nolock) added by Himank on 29th sep 2015
            ' Dim oda As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF With(nolock)  left outer JOIN MMM_MST_FORMS F   With(nolock) on F.FormName = FF.DocumentType and F.EID = FF.EID   where (FF.isactive=1 or FF.fieldType='Separator') and F.EID=" & Session("EID").ToString() & " and FormName = '" & scrname & "' order by displayOrder", con)
            Dim oda As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF With(nolock)  left outer JOIN MMM_MST_FORMS F   With(nolock) on F.FormName = FF.DocumentType and F.EID = FF.EID   where (FF.isactive=1) and F.EID=" & Session("EID").ToString() & " and FormName = '" & scrname & "' order by displayOrder", con)
            Dim ds As New DataSet()
            oda.Fill(ds, "data")
            Session("PFieldsData") = ds.Tables("data")
            Page.Title = ds.Tables("data").Rows(0).Item("FormDesc").ToString()
            'Added for Shwo Existing values START HERE
            If Not IsDBNull(ds.Tables("data").Rows(0).Item("Show_Existing")) Then
                If Not String.IsNullOrEmpty(ds.Tables("data").Rows(0).Item("Show_Existing")) Then
                    ShowExist.Visible = True
                    btnShowExist.Text = Convert.ToString(ds.Tables("data").Rows(0).Item("Show_Existing"))
                Else
                    ShowExist.Visible = False
                    btnShowExist.Text = ""
                End If
            Else
                ShowExist.Visible = False
                btnShowExist.Text = ""
            End If
            'Added for Shwo Existing values End HERE
            Dim messageStrip As String = ""
            Try
                messageStrip = Session("HEADERSTRIP").ToString()
            Catch ex As Exception
            End Try

            If messageStrip.Length > 1 Then
                lblCaption.Text = "<div class=""doc_header"" >" & ds.Tables("data").Rows(0).Item("Formcaption").ToString() & "</div>"
            Else
                'lblCaption.Text = ds.Tables("data").Rows(0).Item("Formcaption").ToString()
                lblCaption.Text = "<div class=""doc_header"" >" & ds.Tables("data").Rows(0).Item("Formcaption").ToString() & "</div>"
            End If

            Session("Document") = ds.Tables("data").Rows(0).Item("Documenttype").ToString()
            Dim ob As New DynamicForm()

            btnview.Visible = False

            'Calculate Button by Komal on 18March2014
            Dim Formula() As DataRow = ds.Tables("data").Select("fieldtype='Formula Field' and invisible=0")
            If Formula.Length > 0 Then
                Button1.Visible = True
            Else
                Button1.Visible = False
            End If

            If ds.Tables("data").Rows(0).Item("enabledraft").ToString.Length > 0 Then
                btnDraft.Visible = True
                btnDraft.Text = ds.Tables("data").Rows(0).Item("enabledraft").ToString
            Else
                btnDraft.Visible = False
            End If
            If Not Request.QueryString("TID") Is Nothing Then
                EDITHIT()
            Else
                ob.CreateControlsOnPanel(ds.Tables("data"), pnlFields, UpdatePanel1, btnActEdit, 0, Session("DDL"))
                Dim row123() As DataRow = ds.Tables("data").Select("fieldtype='LookupDDL'   and (ddllookupvalue is not null or multilookUpVal is not null or HasRule='1')")
                If (row123.Length > 0) Then
                    For we As Integer = 0 To row123.Length - 1
                        Dim DDL As DropDownList = TryCast(pnlFields.FindControl("fld" & row123(we).Item("FieldID").ToString()), DropDownList)
                        Dim id As String = Right(DDL.ID, DDL.ID.Length - 3)
                        DDL.AutoPostBack = True
                        AddHandler DDL.TextChanged, AddressOf bindvalue
                    Next
                End If
                'This line of code is commentted by Ajeet Dated:21-Jan-2014 For Enabling Control level Rule
                'History Transaction start from here		
                Dim ROWHistory() As DataRow = ds.Tables("data").Select("fieldtype='DROP DOWN' or fieldtype='AUTOCOMPLETE'  and (DROPDOWNTYPE='MASTER VALUED')")
                If ROWHistory.Length > 0 Then
                    For i As Integer = 0 To ROWHistory.Length - 1
                        Dim btnHistory As ImageButton = TryCast(pnlFields.FindControl("btnHistory_" & ROWHistory(i).Item("FieldID").ToString()), ImageButton)
                        If Not IsNothing(btnHistory) Then
                            AddHandler btnHistory.Click, AddressOf ShowHistory
                        End If
                    Next
                End If
                'History Transaction End here
                'Dim ROW1() As DataRow = ds.Tables("data").Select("fieldtype='DROP DOWN' and (dropdowntype='MASTER VALUED' OR dropdowntype='CHILD VALUED' OR dropdowntype='SESSION VALUED')  and (lookupvalue is not null or ddllookupvalue is not null)")
                Dim ROW1() As DataRow = ds.Tables("data").Select("fieldtype='DROP DOWN'   and (lookupvalue is not null or ddllookupvalue is not null or multilookUpVal is not null or ltlookupval is not null or HasRule='1')")
                If ROW1.Length > 0 Then
                    For i As Integer = 0 To ROW1.Length - 1
                        Dim check As Integer = 0
                        Dim DDL As DropDownList = TryCast(pnlFields.FindControl("fld" & ROW1(i).Item("FieldID").ToString()), DropDownList)
                        Dim id As String = Right(DDL.ID, DDL.ID.Length - 3)
                        DDL.AutoPostBack = True
                        'Change By V 24 Dec
                        If ds.Tables("data").Rows.Count > 0 Then
                            For j As Integer = 0 To ds.Tables("data").Rows.Count - 1
                                If ds.Tables("data").Rows(j).Item("KC_LOGIC").ToString.Contains(id) = True Then
                                    DDL.AutoPostBack = True
                                    AddHandler DDL.TextChanged, AddressOf bindvalue2
                                    check = check + 1
                                End If
                            Next
                        End If
                        If check = 0 Then
                            AddHandler DDL.TextChanged, AddressOf bindvalue
                            Dim screenname = Request.QueryString("SC").ToString
                            'ExecuteControllevelRule(CInt(id), pnlFields, Nothing, screenname, ds.Tables("data"), Nothing, lblTab, False)
                        End If
                    Next
                End If
                'Code For Rule Post back handler for text box controls
                'Added By Himank :11th-september-2015
                'Dim RuleRow() As DataRow = ds.Tables("data").Select("fieldtype='Text Box' and  HasRule='1'")
                Dim RuleRow() As DataRow = ds.Tables("data").Select("HasRule='1'")
                If RuleRow.Length > 0 Then
                    Session("ALLRULE") = RuleRow
                    For r As Integer = 0 To RuleRow.Length - 1
                        Dim FieldType = RuleRow(r).Item("FieldType").ToString()
                        Select Case FieldType.ToUpper
                            Case "TEXT BOX"
                                Dim TextBox As TextBox = TryCast(pnlFields.FindControl("fld" & RuleRow(r).Item("FieldID").ToString()), TextBox)
                                Dim id As String = Right(TextBox.ID, TextBox.ID.Length - 3)
                                TextBox.AutoPostBack = True
                                AddHandler TextBox.TextChanged, AddressOf TextBoxRule_TextChanged
                            Case "CHECK BOX"
                                Dim CheckBox As CheckBox = TryCast(pnlFields.FindControl("fld" & RuleRow(r).Item("FieldID").ToString()), CheckBox)
                                Dim id As String = Right(CheckBox.ID, CheckBox.ID.Length - 3)
                                CheckBox.AutoPostBack = True
                                AddHandler CheckBox.CheckedChanged, AddressOf TextBoxRule_TextChanged
                        End Select
                    Next
                End If
                '' for inline grid ddl filter from main ddl by sunil 31_july_14
                Dim ROWC() As DataRow = ds.Tables("data").Select("fieldtype='Child Item' and len(isnull(KC_LOGIC,''))>2")
                If ROWC.Length > 0 Then
                    For i As Integer = 0 To ROWC.Length - 1
                        Dim st() As String = ROWC(i).Item("kc_logic").ToString().Split("-")

                        Dim DDL As DropDownList = TryCast(pnlFields.FindControl("fld" & st(0).ToString), DropDownList)
                        Dim id As String = Right(DDL.ID, DDL.ID.Length - 3)
                        DDL.AutoPostBack = True
                        AddHandler DDL.TextChanged, AddressOf bindvalue2
                    Next
                End If
                '' for inline grid ddl filter from main ddl by sunil 31_july_14


                Dim dtchild As DataTable = ds.Tables("data")
                If ds.Tables("data").Rows(0).Item("Iscalendar").ToString() = "1" Then
                    Dim btncldr As Button = TryCast(pnlFields.FindControl("BTNCLNDR"), Button)
                    AddHandler btncldr.Click, AddressOf ADDTASK
                    Dim Grd1 As GridView = TryCast(pnlFields.FindControl("GRDCLNDR"), GridView)
                    AddHandler Grd1.RowDataBound, AddressOf addTemplateField
                    AddHandler Grd1.RowCommand, AddressOf DeleteTask
                    AddHandler Grd1.RowDeleting, AddressOf DeletedTask
                    Grd1.DataSource = Session("dtNew")
                    Grd1.DataBind()
                End If
                Dim row() As DataRow = dtchild.Select("FieldType='CHILD ITEM'")
                If Session("ALLCHILD") Is Nothing Then
                    Session("ALLCHILD") = row
                End If

                If row.Length > 0 Then
                    Dim btn1 As New Button
                    For i As Integer = 0 To row.Length - 1
                        '' removed frm here by sp 13-jan-14
                        'btn1 = pnlFields.FindControl("BTN" & row(i).Item("FieldID").ToString())
                        'AddHandler btn1.Click, AddressOf ShowChildForm
                        Dim PRitem() As String = row(i).Item("dropdown").ToString().Split("-")
                        If PRitem.Length > 1 Then
                            Dim BTN2 As Button = pnlFields.FindControl("BTN" & PRitem(1).ToString & "-" & row(i).Item("FIELDID").ToString())
                            AddHandler BTN2.Click, AddressOf INSERTCHILDITEM
                        End If

                        Session("FNS") = Session("FNS") & PRitem(0).ToString() & ":" & row(i).Item("Fieldid").ToString() & ":"

                        ' Dim array3Ds(,,) As String = New String(,,) {}

                        Dim ColHEAD() As String = {}
                        Dim DDLTXT() As String = {}
                        Dim DDLVAL() As String = {}

                        Session("COLHEAD") = ColHEAD
                        Session("DDLTXT") = DDLTXT
                        Session("DDLVAL") = DDLVAL
                        '' by sunil for def value 16-dec-13 - ends

                        Dim GRD As GridView = pnlFields.FindControl("GRD" & row(i).Item("Fieldid").ToString())
                        ''AddHandler GRD.RowDataBound, AddressOf totalrow  '' moved frm here to below


                        AddHandler GRD.RowCommand, AddressOf Delete
                        AddHandler GRD.RowDeleting, AddressOf Deleting
                        ' AddHandler GRD.RowDataBound, AddressOf addTemplateField


                        '' by sunil for def value insert for Aggrawal  16-dec-13 - starts
                        Dim strDF As String = "select * from mmm_mst_forms  With(nolock)  where formname='" & PRitem(0).ToString() & "' and formsource='DETAIL FORM' and EID=" & Session("EID").ToString() & " and (isnull(HasDefaultValue,0)=1 or isnull(isinlineediting,0)=1 or  isnull(NullIf(IsDefaultRows,''),0)<>0) "
                        Dim oda1 As SqlDataAdapter = New SqlDataAdapter("", con)
                        Dim dtIsdv As New DataTable
                        oda.SelectCommand.CommandText = strDF
                        oda.Fill(dtIsdv)

                        If dtIsdv.Rows.Count = 1 Then '' found hasdefvalue prop. true proceed to display button 
                            ' Dim btnIDV As New Button
                            ' btnIDV = pnlFields.FindControl("BTN_" & row(i).Item("FieldID").ToString())  '  "BTN" & "_" & ROWCHILD(i).Item("FIELDID").ToString()
                            AddHandler GRD.RowDataBound, AddressOf gvData_InlineEdit
                            'BTNFLTER
                            'By balli 
                            'If Not IsNothing(Session("BindGrdOnDdl")) = True Then
                            '    Dim ddlGrd As String() = Split(Session("BindGrdOnDdl"), "-")
                            '    If DynamicForm.GetControl(pnlFields, "fld" & ddlGrd(0)) Then
                            '        Dim ddl As DropDownList = CType(pnlFields.FindControl("fld" & ddlGrd(0)), DropDownList)
                            '        AddHandler ddl.SelectedIndexChanged, AddressOf DynamicGrdFilter
                            '    End If
                            'End If
                            Dim filterROW1() As DataRow = dtIsdv.Select("inlinefilter is not null")
                            If filterROW1.Length > 0 Then
                                Dim filter = filterROW1(0).Item("inlinefilter").ToString().Split("~")
                                For f As Integer = 0 To filter.Length - 1
                                    Dim SD As String() = Split(filter(f), "-")
                                    Dim Opr As String() = Split(SD(1), "|")
                                    If SD(0).ToUpper = "D" Then
                                        'Session("BindGrdOnDdl") = Opr(2) & "-" & filterROW1(0).Item("FormName")
                                        Dim ddlfilter As DropDownList = CType(pnlFields.FindControl("fld" & Opr(2)), DropDownList)
                                        If Not IsNothing(ddlfilter) Then
                                            ddlfilter.AutoPostBack = True
                                            AddHandler ddlfilter.SelectedIndexChanged, AddressOf DynamicGrdFilter
                                        End If
                                    End If
                                Next
                            End If
                            'end here
                            'By ajeet 
                            Dim str = "BTNFLTER" & row(i).Item("FIELDID").ToString() & "_" & row(i).Item("DROPDOWN").ToString().Replace(" ", "_")
                            btn1 = pnlFields.FindControl(str)
                            If Not btn1 Is Nothing Then
                                AddHandler btn1.Click, AddressOf Filter ' use for dynamic filter  
                            End If
                            'prashant_10_7

                            '  If Not String.IsNullOrEmpty(dtIsdv.Rows(0).Item("IsDefaultRows").ToString) Then
                            Dim BTNUpload As Button = pnlFields.FindControl("BTNUpload" & row(i).Item("FIELDID").ToString())
                            'ShowChildItemUploadForm
                            If Not BTNUpload Is Nothing Then
                                AddHandler BTNUpload.Click, AddressOf ShowChildItemUploadForm
                            End If

                            Dim imgExport As ImageButton = pnlFields.FindControl("btnExportError" & row(i).Item("FIELDID").ToString())
                            'ShowChildItemUploadForm
                            If Not imgExport Is Nothing Then
                                AddHandler imgExport.Click, AddressOf Me.imgExport_Click
                            End If

                            ' End If

                            'prashant_10_7


                            'prashant_11_7
                            'If Not String.IsNullOrEmpty(row(i).Item("isinlineediting").ToString.Trim()) Then
                            '    If Convert.ToInt32(row(i).Item("isinlineediting").ToString.Trim()) > 0 Then
                            '        Dim grid As GridView
                            '        grid = pnlFields.FindControl("GRD" & row(i).Item("FIELDID").ToString())
                            '        If Not grid Is Nothing Then
                            Dim btn As Button
                            btn = pnlFields.FindControl("bntCalFromGrid_" & row(i).Item("FIELDID").ToString())
                            If Not btn Is Nothing Then
                                AddHandler btn.Click, AddressOf CalculateFromGrid
                            End If

                            Dim btn2 As Button
                            btn2 = pnlFields.FindControl("BtnAddRow_" & row(i).Item("FIELDID").ToString())
                            If Not btn2 Is Nothing Then
                                AddHandler btn2.Click, AddressOf AddRow
                                Dim doc = row(i).Item("dropdown").ToString()
                                Dim qry = "Select EnableAddRow from mmm_mst_Forms where formName='" & doc & "' and Eid=" & Session("Eid")
                                oda.SelectCommand.CommandText = qry
                                con.Open()
                                Dim enable As Integer = Convert.ToInt32(oda.SelectCommand.ExecuteScalar)
                                con.Close()
                                If enable = 0 Then
                                    btn2.Visible = False
                                End If
                            End If


                        Else


                            AddHandler GRD.RowDataBound, AddressOf totalrow
                            btn1 = pnlFields.FindControl("BTN" & row(i).Item("FieldID").ToString())
                            AddHandler btn1.Click, AddressOf ShowChildForm
                            'For Child Item uploder button
                            Dim BTNUpload As Button = pnlFields.FindControl("BTNUpload" & row(i).Item("FIELDID").ToString())
                            'ShowChildItemUploadForm
                            If Not BTNUpload Is Nothing Then
                                AddHandler BTNUpload.Click, AddressOf ShowChildItemUploadForm
                            End If
                            Dim imgExport As ImageButton = pnlFields.FindControl("btnExportError" & row(i).Item("FIELDID").ToString())
                            If Not imgExport Is Nothing Then
                                AddHandler imgExport.Click, AddressOf Me.imgExport_Click
                            End If

                        End If

                        ' oda.Dispose()
                        dtIsdv.Dispose()
                        ' filter for grid bind by balli


                        oda.SelectCommand.CommandType = CommandType.StoredProcedure
                        oda.SelectCommand.CommandText = "uspGetDetailITEM"
                        oda.SelectCommand.Parameters.Clear()
                        oda.SelectCommand.CommandType = CommandType.StoredProcedure
                        oda.SelectCommand.Parameters.AddWithValue("SID", Session.SessionID)
                        oda.SelectCommand.Parameters.AddWithValue("FN", PRitem(0).ToString())
                        oda.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
                        ds.Tables.Clear()
                        oda.Fill(ds, "ITEM")
                        oda.SelectCommand.CommandType = CommandType.Text
                        'oda.SelectCommand.CommandText = "SELECT F1.FieldID,F2.displayName,F1.FieldType FROM MMM_MST_FIELDS F1 INNER JOIN MMM_MST_FIELDS F2 ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType  in ('CHILD ITEM MAX','CHILD ITEM TOTAL')  AND F2.DocumentType ='" & row(i).Item("dropdown").ToString() & "' AND F1.DOCUMENTTYPE='" & scrname & "'"
                        'With(nolock) added by Himank on 29th sep 2015
                        oda.SelectCommand.CommandText = "SELECT F1.FieldID,F2.displayName,F1.FieldType,F1.child_specific_text FROM MMM_MST_FIELDS F1   WITH(NOLOCK)  INNER JOIN MMM_MST_FIELDS F2  WITH(NOLOCK)  ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType  in ('CHILD ITEM MAX','CHILD ITEM TOTAL')  AND F2.DocumentType ='" & row(i).Item("dropdown").ToString() & "' AND F1.DOCUMENTTYPE='" & scrname & "' union all Select FieldID,displayName,fieldtype,child_specific_text  from mmm_mst_fields  WITH(NOLOCK)  where eid=" & Session("EID") & " and DOCUMENTTYPE='" & scrname & "' and Child_Specific_text is not null "
                        oda.Fill(ds, "TOTAL")

                        If Not IsPostBack Then
                            Session(PRitem(0)) = Nothing
                        End If

                        If Not Session(PRitem(0)) Is Nothing Then
                            ob.BINDITEMGRID1(Session(PRitem(0)), pnlFields, row(i).Item("fieldid"), UpdatePanel1, ds.Tables("TOTAL"), -1, -1, scrname, row(i).Item("dropdown").ToString(), Convert.ToInt32(Session("EID")))
                        Else

                        End If
                    Next

                    If Not Session("CHILD") Is Nothing Then
                        ob.CreateControlsOnPanel(Session("CHILD"), pnlFields1, updpnlchild, Button2, 0, Session("DDL"))
                        'Code Block is Modified by Ajeet For control level Rule Engine Dated:21-Jan-2014
                        Dim ROW2() As DataRow = Session("CHILD").Select("fieldtype='DROP DOWN'   and (lookupvalue is not null or ddllookupvalue is not null or multilookUpVal is not null or HasRule='1') ")
                        If ROW2.Length > 0 Then
                            For i As Integer = 0 To ROW2.Length - 1
                                Dim DDL As DropDownList = TryCast(pnlFields1.FindControl("fld" & ROW2(i).Item("FieldID").ToString()), DropDownList)
                                DDL.AutoPostBack = True
                                AddHandler DDL.TextChanged, AddressOf bindvalue1
                            Next
                        End If
                        ChildFormddlRendering(row, 2)
                    End If
                End If
            End If
            con.Close()
            oda.Dispose()
            con.Dispose()
            If Page.IsPostBack Then
                If IsNothing(Session("GRDID")) = False Then
                    Dim grdname As String = Session("GRDID")
                    Dim GRD As GridView = pnlFields.FindControl("GRD" & grdname)
                    Session("Grid") = GRD

                    Dim FileuploadList = New List(Of FileUpload)()

                    For Each c In Me.Page.Controls
                        If c.GetType() Is GetType(FileUpload) Then
                            FileuploadList.Add(c)
                        End If

                    Next

                    'Session("FileUploads") = FileuploadList

                End If
            End If

        End If
    End Sub

    '' my running page load
    '' my running 18-dec
    '' prev. page load - with old menu code 
    'Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
    '    If Not IsPostBack Then
    '        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '        Dim con As SqlConnection = New SqlConnection(conStr)
    '        Dim oda As SqlDataAdapter = New SqlDataAdapter("SELECT username,uid FROM MMM_MST_USER WHERE EID=" & Session("EID").ToString() & "", con)
    '        Dim ds As New DataSet()
    '        oda.Fill(ds, "USER")
    '        For i As Integer = 0 To ds.Tables("USER").Rows.Count - 1
    '            ddluser.Items.Add(ds.Tables("USER").Rows(i).Item("USERNAME").ToString())
    '            ddluser.Items(i).Value = ds.Tables("USER").Rows(i).Item("UID")
    '        Next
    '        ddluser.Items.Insert(0, "SELECT ONE")
    '        UpdPnlAddTask.Update()

    '        GetMenuData()
    '        If ViewState("numval") = 1 Then
    '            btnActEdit.Visible = False
    '        ElseIf ViewState("numval") = 4 Then
    '            btnActEdit.Visible = False
    '        ElseIf ViewState("numval") = 5 Then
    '            btnActEdit.Visible = False
    '        ElseIf ViewState("numval") = 8 Then
    '            btnActEdit.Visible = False
    '        ElseIf ViewState("numval") = 9 Then
    '            btnActEdit.Visible = False
    '        ElseIf ViewState("numval") = 12 Then
    '            btnActEdit.Visible = False
    '        ElseIf ViewState("numval") = 13 Then
    '            btnActEdit.Visible = False
    '        End If

    '        ' above is for loading def values from master by sp
    '        Call ShowDefaultValuesinGrid()

    '        oda.Dispose()
    '        con.Dispose()
    '    End If
    'End Sub

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        If Not IsPostBack Then
            Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
            Dim con As SqlConnection = New SqlConnection(conStr)
            'With(nolock) added by Himank on 29th sep 2015
            Dim oda As SqlDataAdapter = New SqlDataAdapter("SELECT username,uid FROM MMM_MST_USER   WITH(NOLOCK) WHERE EID=" & Session("EID").ToString() & "", con)
            Dim ds As New DataSet()
            oda.Fill(ds, "USER")
            For i As Integer = 0 To ds.Tables("USER").Rows.Count - 1
                ddluser.Items.Add(ds.Tables("USER").Rows(i).Item("USERNAME").ToString())
                ddluser.Items(i).Value = ds.Tables("USER").Rows(i).Item("UID")
            Next
            ddluser.Items.Insert(0, "SELECT ONE")
            UpdPnlAddTask.Update()

            'below function is for rights of create view edit and delete
            Call GetMenuandroles()
            'Commented by balli
            ' above is for loading def values from master by sp
            'Ajeet1
            If Request.QueryString("TID") Is Nothing Then
                Call ShowDefaultValuesinGrid()
            End If

            oda.Dispose()
            con.Dispose()
            Session("AddedRow") = Nothing
            Dim dr As DataRow()
            dr = Session("ALLRULE")
            If Not IsNothing(dr) Then
                Dim dtAllData As DataTable = Session("PFieldsData")
                Dim screenname = Request.QueryString("SC").ToString
                For r As Integer = 0 To dr.Length - 1
                    ExecuteControllevelRule(CInt(dr(r).Item("fieldid")), pnlFields, Nothing, screenname, dtAllData, Nothing, lblTab, False)
                Next
            End If
        Else
            'Prashat 30-6-2014
            ResetGrid()


        End If



    End Sub

    'Private Sub ShowDefaultValuesinGrid()
    '    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '    Dim con As SqlConnection = New SqlConnection(conStr)
    '    Dim row() As DataRow = Session("ALLCHILD")


    '    If row.Length > 0 Then
    '        Dim btn1 As New Button
    '        For i As Integer = 0 To row.Length - 1
    '            ' btn1 = pnlFields.FindControl("BTN" & row(i).Item("FieldID").ToString())
    '            ' AddHandler btn1.Click, AddressOf ShowChildForm
    '            Dim PRitem() As String = row(i).Item("dropdown").ToString().Split("-")

    '            Dim strDF As String = "select * from mmm_mst_forms where formname='" & PRitem(0).ToString() & "' and formsource='DETAIL FORM' and EID=" & Session("EID").ToString() & " and isnull(HasDefaultValue,0)=1"
    '            Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '            Dim dtIsdv As New DataTable
    '            oda.SelectCommand.CommandText = strDF
    '            oda.Fill(dtIsdv)
    '            If dtIsdv.Rows.Count = 1 Then '' found hasdefvalue prop. true proceed to display button 
    '                INSERT_DEFAULTVALUES(PRitem(0).ToString, row(i).Item("FieldID").ToString())  '  "BTN" & "_" & ROWCHILD(i).Item("FIELDID").ToString()
    '            End If
    '            oda.Dispose()
    '            dtIsdv.Dispose()
    '        Next
    '    End If
    '    con.Close()
    'End Sub  ' 28 may comented and implemented inline editing

    Private Sub ShowDefaultValuesinGrid()
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim row() As DataRow = Session("ALLCHILD")

        If row.Length > 0 Then
            Dim btn1 As New Button
            For i As Integer = 0 To row.Length - 1
                ' btn1 = pnlFields.FindControl("BTN" & row(i).Item("FieldID").ToString())
                ' AddHandler btn1.Click, AddressOf ShowChildForm
                Dim PRitem() As String = row(i).Item("dropdown").ToString().Split("-")
                'aaaa   
                'With(nolock) added by Himank on 29th sep 2015
                Dim strDF As String = "select * from mmm_mst_forms   WITH(NOLOCK) where formname='" & PRitem(0).ToString() & "' and formsource='DETAIL FORM' and EID=" & Session("EID").ToString() & " and isnull(HasDefaultValue,0)=1"
                Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
                Dim dtIsdv As New DataTable

                oda.SelectCommand.CommandText = strDF
                oda.Fill(dtIsdv)

                'aaaa
                Dim dtIsDef As New DataTable
                'With(nolock) added by Himank on 29th sep 2015
                Dim str As String = "select * from mmm_mst_forms   WITH(NOLOCK) where formname='" & PRitem(0).ToString() & "' and formsource='DETAIL FORM' and EID=" & Session("EID").ToString() & " and isnull(IsDefaultRows,0)>0"
                oda.SelectCommand.CommandText = str
                oda.Fill(dtIsDef)


                'aaaa 
                If dtIsdv.Rows.Count = 1 Then '' found hasdefvalue prop. true proceed to display button 
                    'If dtIsdv.Rows(0).Item("hasdefaultvalue").ToString() = "1" Then
                    If Request.QueryString("TID") Is Nothing Then
                        INSERT_DEFAULTVALUES(PRitem(0).ToString, row(i).Item("FieldID").ToString(), dtIsdv)  '  "BTN" & "_" & ROWCHILD(i).Item("FIELDID").ToString()
                    Else
                        INSERT_DEFAULTVALUES_draft(PRitem(0).ToString, row(i).Item("FieldID").ToString(), dtIsdv)
                    End If

                    'End If
                ElseIf dtIsDef.Rows.Count = 1 Then
                    If Request.QueryString("TID") Is Nothing Then
                        INSERT_DEFAULTVALUES(PRitem(0).ToString, row(i).Item("FieldID").ToString(), dtIsDef)
                    Else
                        INSERT_DEFAULTVALUES_draft(PRitem(0).ToString, row(i).Item("FieldID").ToString(), dtIsDef)
                    End If

                Else
                    'With(nolock) added by Himank on 29th sep 2015
                    strDF = "select * from mmm_mst_forms  WITH(NOLOCK)  where formname='" & PRitem(0).ToString() & "' and formsource='DETAIL FORM' and EID=" & Session("EID").ToString() & " and isnull(isinlineediting,0)=1"
                    oda.SelectCommand.CommandText = strDF
                    oda.Fill(dtIsdv)
                    If dtIsdv.Rows.Count > 0 Then
                        insert_InlineEditing_Draft(PRitem(0).ToString, row(i).Item("FieldID").ToString(), Convert.ToInt32(Request.QueryString("TID")))
                    End If
                End If
                oda.Dispose()
                dtIsdv.Dispose()
            Next
        End If
        con.Close()
    End Sub

    Public Sub insert_InlineEditing_Draft(ByVal FN As String, ByVal fldID As String, Optional ByVal draftID As Int32 = 0)
        Dim scrname As String = Request.QueryString("SC").ToString()
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim da As New SqlDataAdapter("", con)
        Dim dss As New DataTable
        Try
            Dim formname As String = FN
            Dim FormnameDVM As String = ""
            Session("FN") = formname
            Session("ID") = fldID.ToString  'ID(1).ToString
            ViewState("ID") = "BTN" & fldID.ToString  'ID(1).ToString
            Dim ob As New DynamicForm
            Dim DS As New DataSet
            'With(nolock) added by Himank on 29th sep 2015
            Dim oda As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF   WITH(NOLOCK) left outer JOIN MMM_MST_FORMS F  WITH(NOLOCK)  on F.FormName = FF.DocumentType and F.EID = FF.EID  where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FormName = '" & formname & "' order by displayOrder", con)
            oda.Fill(DS, "CHILD")
            'Uncheck After Testing 19/10/2016
            'Session("CHILD") = DS.Tables("CHILD")
            Session("D" & formname) = DS.Tables("CHILD")

            Dim sqlStrF As String = ""
            'With(nolock) added by Himank on 29th sep 2015
            da.SelectCommand.CommandText = "select * from MMM_MST_forms  WITH(NOLOCK)  where eid=" & Session("EID") & " and formname='" & FN & "'"
            'Dim DS As New DataSet
            Dim DSM As New DataTable
            Dim DSF As New DataTable
            Dim TempDt As New DataTable
            Dim field As New DataTable
            Dim field1 As New DataTable
            da.Fill(DS, "inlineediting")


            If DS.Tables("inlineediting").Rows.Count > 0 Then
                Dim inlineSDoc As String = DS.Tables("inlineediting").Rows(0).Item("inlinesourceDoc").ToString
                Dim inlineType As String = DS.Tables("inlineediting").Rows(0).Item("inlineType").ToString
                'Dim inlineFilter As String() = Split(DS.Tables("inlineediting").Rows(0).Item("inlinefilter"), ":")

                Dim inlineFilter As String() = Split(DS.Tables("inlineediting").Rows(0).Item("inlinefilter"), "~")

                Dim tablename As String = ""
                Dim Pid As String = ""
                If inlineType.ToUpper = "MASTER" Then
                    tablename = "MMM_MST_MASTER"
                    Pid = "TID"
                ElseIf inlineType.ToUpper = "DOCUMENT" Then
                    tablename = "MMM_MST_DOC"
                    Pid = "TID"
                ElseIf inlineType.ToUpper = "DETAIL FORM" Then
                    tablename = "MMM_MST_DOC_ITEM"
                    Pid = "TID"
                End If

                Dim sqlStrM As String = ""
                Dim sqlStrMfld As String = ""
                'With(nolock) added by Himank on 29th sep 2015
                da.SelectCommand.CommandText = "select * from MMM_MST_Fields   WITH(NOLOCK) where documenttype='" & FN & "' and eid=" & Session("EID") & " and inlinemapping is not null order by displayorder "
                da.Fill(field)


                Dim filterRows() As DataRow
                Dim filterRows1() As DataRow
                filterRows = field.Select("inlinemapping is not null and inlinemapping <>''", "DisplayOrder")
                filterRows1 = field.Select("InLineEditing=1 and inlinemapping is null", "DisplayOrder")
                If filterRows.Length > 0 Then
                    field = filterRows.CopyToDataTable()
                    If filterRows1.Length > 0 Then
                        field.Merge(filterRows1.CopyToDataTable())
                    End If
                Else
                    field = filterRows1.CopyToDataTable()
                End If
                Dim arrExcludeColumns As New ArrayList()
                Dim arrSelectColumns As New ArrayList()
                If field.Rows.Count > 0 Then
                    For i As Integer = 0 To field.Rows.Count - 1
                        sqlStrM = sqlStrM & " " & field.Rows(i).Item("inlinemapping").ToString() & "[" & field.Rows(i).Item("displayname") & "],"
                        sqlStrMfld = sqlStrMfld & " |" & field.Rows(i).Item("inlinemapping").ToString() & "|,"
                        arrExcludeColumns.Add("'" & field.Rows(i).Item("inlinemapping").ToString() & "'")
                    Next
                    sqlStrM = Left(sqlStrM, sqlStrM.Length - 1)
                    sqlStrMfld = Left(sqlStrMfld, sqlStrMfld.Length - 1)

                    Dim filter As String = ""
                    Dim flag As Int16 = 0   ' flag for checking multiple condition and adding 'and' operator to the sql query 
                    For k As Integer = 0 To inlineFilter.Length - 1
                        Dim SD As String() = Split(inlineFilter(k), "-")  ' check for static or dynamic filter
                        Dim Opr As String() = Split(SD(1), "|")
                        If SD.Length > 1 Then
                            If SD(0).ToUpper = "S" Then  ' for static check S
                                If flag = 1 Then
                                    'filter &= " and " & " convert(float," & Opr(0) & ") " & Opr(1) & " '" & Opr(2) & "'"
                                    'filter &= " and " & " Cast(Replace(Replace(" & Opr(0) & ",',','.'),'.','') AS FLOAT) " & Opr(1) & " '" & Opr(2) & "'"
                                    filter &= " and " & Opr(0) & Opr(1) & " '" & Opr(2) & "'"
                                Else
                                    'filter = "convert(float," & Opr(0) & ") " & Opr(1) & " '" & Opr(2) & "'"
                                    'filter = "Cast(Replace(Replace(" & Opr(0) & ",',','.'),'.','') AS FLOAT) " & Opr(1) & " '" & Opr(2) & "'"
                                    filter = Opr(0) & Opr(1) & " '" & Opr(2) & "'"

                                End If
                                flag = 1

                            Else  ' for dynamic check D
                                If DynamicForm.GetControl(pnlFields, "fld" & Opr(2)) Then
                                    Dim ddl As New DropDownList
                                    ddl = pnlFields.FindControl("fld" & Opr(2))
                                    Session("BindGrdOnDdl") = Opr(2) & "-" & FN    ' this is used in page init and DynamicGrdFilter
                                    If flag = 1 Then
                                        If ViewState("ddlChange") = 1 Then
                                            'filter &= "and " & " convert(float," & Opr(0) & ") " & Opr(1) & " '" & ddl.SelectedItem.Value.Trim & "'"
                                            ' filter &= "and " & " Cast(Replace(Replace(" & Opr(0) & ",',','.'),'.','') AS FLOAT)  " & Opr(1) & " '" & ddl.SelectedItem.Value.Trim & "'"
                                            ''filter &= "and " & Opr(0) & Opr(1) & " '" & ddl.SelectedItem.Value.Trim & "'"

                                            filter &= "and " & Opr(0) & Opr(1) & " '" & IIf(DS.Tables("inlineediting").Rows(0).Item("InLineMathType").ToString.ToUpper = "VALUE", ddl.SelectedItem.Value.Trim, ddl.SelectedItem.Text.Trim) & "'"

                                        Else
                                            'filter &= "and " & " convert(float," & Opr(0) & ") " & Opr(1) & " " & ddl.SelectedItem.Value & ""
                                            'filter &= "and " & " Cast(Replace(Replace(" & Opr(0) & ",',','.'),'.','') AS FLOAT)  " & Opr(1) & " '" & ddl.SelectedItem.Value & "'"   ' this is commenting because first time dynamic condition is not applied
                                            Exit Sub
                                        End If
                                    Else
                                        If ViewState("ddlChange") = 1 Then
                                            'filter = " convert(float," & Opr(0) & ") " & Opr(1) & " '" & ddl.SelectedItem.Value.Trim & "'"
                                            'filter = " Cast(Replace(Replace(" & Opr(0) & ",',','.'),'.','') AS FLOAT) " & Opr(1) & " '" & ddl.SelectedItem.Value.Trim & "'"

                                            filter = Opr(0) & Opr(1) & " '" & IIf(DS.Tables("inlineediting").Rows(0).Item("InLineMathType").ToString.ToUpper = "VALUE", ddl.SelectedItem.Value.Trim, ddl.SelectedItem.Text.Trim) & "'"
                                        Else
                                            'Exit Sub
                                            filter = Opr(0) & Opr(1) & " '" & IIf(DS.Tables("inlineediting").Rows(0).Item("InLineMathType").ToString.ToUpper = "VALUE", ddl.SelectedItem.Value.Trim, ddl.SelectedItem.Text.Trim) & "'"
                                            ''filter = " convert(float," & Opr(0) & ") " & Opr(1) & " " & ddl.SelectedItem.Value & ""
                                        End If
                                    End If
                                    flag = 1
                                End If
                            End If
                        End If
                        'sqlStrMfld = Replace(Left(sqlStrMfld, sqlStrMfld.Length - 1), "'", "''")
                    Next
                    da.SelectCommand.CommandText = "uspGetInlineValuesFromMaster_new1"
                    da.SelectCommand.CommandType = CommandType.StoredProcedure
                    da.SelectCommand.Parameters.AddWithValue("FN", inlineSDoc)
                    da.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
                    da.SelectCommand.Parameters.AddWithValue("childDoctype", FN)
                    da.SelectCommand.Parameters.AddWithValue("sqlMfld", sqlStrMfld)
                    da.SelectCommand.Parameters.AddWithValue("tablename", tablename)
                    ' parameters for filtering 
                    da.SelectCommand.Parameters.AddWithValue("filter", filter)

                    DSM.Columns.Add("All", GetType(String)) ' adding checkbox for grid to select All
                    da.Fill(DSM)

                    If DSM.Rows.Count < 1 Then  ' if no data then dispose the Dynamic grid and show the message
                        Dim lbl As Label = CType(pnlFields.FindControl("LblGrd" & fldID.ToString), Label)
                        lbl.Text = "as per rule defined data not fined "
                        lbl.Visible = True
                        'UpdatePanel1.Update()
                        'Exit Sub
                    Else
                        Dim lbl As Label = CType(pnlFields.FindControl("LblGrd" & fldID.ToString), Label)
                        lbl.Text = ""
                        lbl.Visible = False
                    End If
                End If
                'With(nolock) added by Himank on 29th sep 2015
                da.SelectCommand.CommandText = "select * from MMM_MST_Fields   WITH(NOLOCK)  where documenttype='" & FN & "' and eid=" & Session("EID") & " and inlineediting=1 order by InLineEditing, displayorder "
                da.SelectCommand.CommandType = CommandType.Text
                da.Fill(field1)
                Dim excludeColumns As String = String.Join(",", arrExcludeColumns.ToArray()).ToString()
                If field1.Rows.Count > 0 Then
                    For i As Integer = 0 To field1.Rows.Count - 1
                        sqlStrF = sqlStrF & " " & field1.Rows(i).Item("fieldmapping").ToString() & "[" & field1.Rows(i).Item("displayname") & "],"
                        If (Not excludeColumns.Contains("'" & field1.Rows(i).Item("fieldmapping").ToString() & "'")) Then
                            arrSelectColumns.Add(field1.Rows(i).Item("fieldmapping").ToString() & "[" & field1.Rows(i).Item("displayname") & "]")
                        End If
                    Next
                    sqlStrF = Left(sqlStrF, sqlStrF.Length - 1)
                    'da.SelectCommand.CommandText = "select " & sqlStrF & " from " & tablename & " where documenttype='" & inlineSDoc & "' and eid=" & Session("EID") & ""
                    'With(nolock) added by Himank on 29th sep 2015
                    da.SelectCommand.CommandText = "select " & sqlStrF & " from MMM_MST_DOC_ITEM_draft  WITH(NOLOCK)  where documenttype='" & FN & "' and 1=0"
                    da.SelectCommand.CommandType = CommandType.Text
                    da.Fill(DSF)
                End If
                DSM.Merge(DSF, True, MissingSchemaAction.Add)


                DSM.Merge(DSF, True, MissingSchemaAction.Add)
                DSM.Columns.Item("cmastertid").SetOrdinal(DSM.Columns.Count - 1)
                DSM.Columns.Item("tid").SetOrdinal(DSM.Columns.Count - 1)
                DSM.DefaultView.ToTable()
                da.SelectCommand.CommandText = "select tid ," & String.Join(",", arrSelectColumns.ToArray()) & " from MMM_MST_DOC_ITEM_draft  WITH(NOLOCK)  where documenttype='" & FN & "' and docid=" & draftID & " order by tid "
                da.SelectCommand.CommandType = CommandType.Text
                da.Fill(TempDt)
                Dim count = 0
                For Each dr As DataRow In TempDt.Rows
                    For Each dc As DataColumn In TempDt.Columns
                        Dim data As String = dr(dc)
                        DSM.Rows(count)(dc.ColumnName) = dr(dc)
                    Next
                    count = count + 1
                Next
            End If
            ADD_DV_ITEMSTOGRID(FN, DSM, DSM)
            'ADD_DV_ITEMSTOGRID(FN, DSF, DSF)
            '        Dim oda As New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF left outer JOIN MMM_MST_FORMS F on F.FormName = FF.DocumentType and F.EID = FF.EID  where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FormName = '" & formname & "' order by displayOrder", con)
            da.Dispose()
            con.Close()
            DS.Dispose()

        Catch ex As Exception
        Finally
            con.Dispose()
            da.Dispose()
            con.Close()
        End Try
    End Sub



    ' added on 28 may 14 for inline editing
    'Public Sub insert_InlineEditing(ByVal FN As String, ByVal fldID As String)
    '    Dim scrname As String = Request.QueryString("SC").ToString()
    '    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '    Dim con As SqlConnection = New SqlConnection(conStr)
    '    Dim da As New SqlDataAdapter("", con)
    '    Dim dss As New DataTable
    '    Try
    '        Dim formname As String = FN
    '        Dim FormnameDVM As String = ""
    '        'formname = Right(formname, formname.Length - 8).Trim()
    '        Session("FN") = formname

    '        'Dim ID() As String = btnDetails.ID.Split("_")
    '        Session("ID") = fldID.ToString  'ID(1).ToString
    '        ViewState("ID") = "BTN" & fldID.ToString  'ID(1).ToString
    '        Dim ob As New DynamicForm
    '        Dim DS As New DataSet

    '        Dim oda As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF left outer JOIN MMM_MST_FORMS F on F.FormName = FF.DocumentType and F.EID = FF.EID  where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FormName = '" & formname & "' order by displayOrder", con)
    '        oda.Fill(DS, "CHILD")
    '        Session("CHILD") = DS.Tables("CHILD")
    '        Session("D" & formname) = DS.Tables("CHILD")

    '        Dim sqlStrF As String = ""
    '        da.SelectCommand.CommandText = "select * from MMM_MST_forms where eid=" & Session("EID") & " and formname='" & FN & "'"
    '        'Dim DS As New DataSet
    '        Dim DSM As New DataTable
    '        Dim DSF As New DataTable
    '        Dim field As New DataTable
    '        Dim field1 As New DataTable
    '        da.Fill(DS, "inlineediting")


    '        If DS.Tables("inlineediting").Rows.Count > 0 Then
    '            Dim inlineSDoc As String = DS.Tables("inlineediting").Rows(0).Item("inlinesourceDoc").ToString
    '            Dim inlineType As String = DS.Tables("inlineediting").Rows(0).Item("inlineType").ToString
    '            'Dim inlineFilter As String() = Split(DS.Tables("inlineediting").Rows(0).Item("inlinefilter"), ":")

    '            Dim inlineFilter As String() = Split(DS.Tables("inlineediting").Rows(0).Item("inlinefilter"), "~")

    '            Dim tablename As String = ""
    '            Dim Pid As String = ""
    '            If inlineType.ToUpper = "MASTER" Then
    '                tablename = "MMM_MST_MASTER"
    '                Pid = "TID"
    '            ElseIf inlineType.ToUpper = "DOCUMENT" Then
    '                tablename = "MMM_MST_DOC"
    '                Pid = "TID"
    '            ElseIf inlineType.ToUpper = "DETAIL FORM" Then
    '                tablename = "MMM_MST_DOC_ITEM"
    '                Pid = "TID"
    '            End If

    '            Dim sqlStrM As String = ""
    '            Dim sqlStrMfld As String = ""
    '            da.SelectCommand.CommandText = "select * from MMM_MST_Fields where documenttype='" & FN & "' and eid=" & Session("EID") & " and inlinemapping is not null order by displayorder "
    '            da.Fill(field)
    '            If field.Rows.Count > 0 Then
    '                For i As Integer = 0 To field.Rows.Count - 1
    '                    sqlStrM = sqlStrM & " " & field.Rows(i).Item("inlinemapping").ToString() & "[" & field.Rows(i).Item("displayname") & "],"
    '                    sqlStrMfld = sqlStrMfld & " |" & field.Rows(i).Item("inlinemapping").ToString() & "|,"
    '                Next
    '                sqlStrM = Left(sqlStrM, sqlStrM.Length - 1)
    '                sqlStrMfld = Left(sqlStrMfld, sqlStrMfld.Length - 1)

    '                Dim filter As String = ""
    '                Dim flag As Int16 = 0   ' flag for checking multiple condition and adding 'and' operator to the sql query 
    '                For k As Integer = 0 To inlineFilter.Length - 1
    '                    Dim SD As String() = Split(inlineFilter(k), "-")  ' check for static or dynamic filter
    '                    Dim Opr As String() = Split(SD(1), "|")
    '                    If SD.Length > 1 Then
    '                        If SD(0).ToUpper = "S" Then  ' for static check S
    '                            If flag = 1 Then
    '                                'filter &= " and " & " convert(float," & Opr(0) & ") " & Opr(1) & " '" & Opr(2) & "'"
    '                                filter &= " and " & " Cast(Replace(Replace(" & Opr(0) & ",',','.'),'.','') AS FLOAT) " & Opr(1) & " '" & Opr(2) & "'"
    '                            Else
    '                                'filter = "convert(float," & Opr(0) & ") " & Opr(1) & " '" & Opr(2) & "'"
    '                                filter = "Cast(Replace(Replace(" & Opr(0) & ",',','.'),'.','') AS FLOAT) " & Opr(1) & " '" & Opr(2) & "'"
    '                            End If
    '                            flag = 1
    '                        Else  ' for dynamic check D
    '                            If DynamicForm.GetControl(pnlFields, "fld" & Opr(2)) Then
    '                                Dim ddl As New DropDownList
    '                                ddl = pnlFields.FindControl("fld" & Opr(2))
    '                                Session("BindGrdOnDdl") = Opr(2) & "-" & FN    ' this is used in page init and DynamicGrdFilter
    '                                If flag = 1 Then
    '                                    If ViewState("ddlChange") = 1 Then
    '                                        'filter &= "and " & " convert(float," & Opr(0) & ") " & Opr(1) & " '" & ddl.SelectedItem.Value.Trim & "'"
    '                                        filter &= "and " & " Cast(Replace(Replace(" & Opr(0) & ",',','.'),'.','') AS FLOAT)  " & Opr(1) & " '" & ddl.SelectedItem.Value.Trim & "'"

    '                                    Else
    '                                        'filter &= "and " & " convert(float," & Opr(0) & ") " & Opr(1) & " " & ddl.SelectedItem.Value & ""
    '                                        'filter &= "and " & " Cast(Replace(Replace(" & Opr(0) & ",',','.'),'.','') AS FLOAT)  " & Opr(1) & " '" & ddl.SelectedItem.Value & "'"   ' this is commenting because first time dynamic condition is not applied
    '                                        Exit Sub
    '                                    End If
    '                                Else
    '                                    If ViewState("ddlChange") = 1 Then
    '                                        'filter = " convert(float," & Opr(0) & ") " & Opr(1) & " '" & ddl.SelectedItem.Value.Trim & "'"
    '                                        filter = " Cast(Replace(Replace(" & Opr(0) & ",',','.'),'.','') AS FLOAT) " & Opr(1) & " '" & ddl.SelectedItem.Value.Trim & "'"
    '                                    Else
    '                                        Exit Sub
    '                                        ''filter = " convert(float," & Opr(0) & ") " & Opr(1) & " " & ddl.SelectedItem.Value & ""
    '                                    End If
    '                                End If
    '                                flag = 1
    '                            End If
    '                        End If
    '                    End If
    '                    'sqlStrMfld = Replace(Left(sqlStrMfld, sqlStrMfld.Length - 1), "'", "''")
    '                Next
    '                da.SelectCommand.CommandText = "uspGetInlineValuesFromMaster"
    '                da.SelectCommand.CommandType = CommandType.StoredProcedure
    '                da.SelectCommand.Parameters.AddWithValue("FN", inlineSDoc)
    '                da.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
    '                da.SelectCommand.Parameters.AddWithValue("childDoctype", FN)
    '                da.SelectCommand.Parameters.AddWithValue("sqlMfld", sqlStrMfld)
    '                da.SelectCommand.Parameters.AddWithValue("tablename", tablename)
    '                ' parameters for filtering 
    '                da.SelectCommand.Parameters.AddWithValue("filter", filter)


    '                DSM.Columns.Add("All", GetType(String)) ' adding checkbox for grid to select All
    '                da.Fill(DSM)

    '                'If DSM.Rows.Count < 1 Then  ' if no data then dispose the Dynamic grid and show the message
    '                '    Dim GV As GridView = CType(pnlFields.FindControl("GRD" & Session("ID")), GridView)
    '                '    GV.Dispose()

    '                '    Dim lbl As Label = CType(pnlFields.FindControl("LblGrd"), Label)
    '                '    lbl.Text = "as per rule defined data not fined "
    '                '    lbl.Visible = True
    '                '    UpdatePanel1.Update()
    '                '    Exit Sub
    '                'End If
    '            End If


    '            da.SelectCommand.CommandText = "select * from MMM_MST_Fields where documenttype='" & FN & "' and eid=" & Session("EID") & " and inlinemapping is null order by displayorder "
    '            da.SelectCommand.CommandType = CommandType.Text
    '            da.Fill(field1)
    '            If field1.Rows.Count > 0 Then
    '                For i As Integer = 0 To field1.Rows.Count - 1
    '                    sqlStrF = sqlStrF & " " & field1.Rows(i).Item("fieldmapping").ToString() & "[" & field1.Rows(i).Item("displayname") & "],"
    '                Next
    '                sqlStrF = Left(sqlStrF, sqlStrF.Length - 1)
    '                'da.SelectCommand.CommandText = "select " & sqlStrF & " from " & tablename & " where documenttype='" & inlineSDoc & "' and eid=" & Session("EID") & ""
    '                da.SelectCommand.CommandText = "select " & sqlStrF & " from MMM_MST_DOC_ITEM where documenttype='" & FN & "' and 1=0"
    '                da.SelectCommand.CommandType = CommandType.Text
    '                da.Fill(DSF)
    '            End If
    '            DSM.Merge(DSF, True, MissingSchemaAction.Add)
    '        End If
    '        ADD_DV_ITEMSTOGRID(FN, DSM, DSM)
    '        '        Dim oda As New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF left outer JOIN MMM_MST_FORMS F on F.FormName = FF.DocumentType and F.EID = FF.EID  where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FormName = '" & formname & "' order by displayOrder", con)
    '        da.Dispose()
    '        con.Close()
    '        DS.Dispose()

    '    Catch ex As Exception
    '    Finally
    '        con.Dispose()
    '        da.Dispose()
    '        con.Close()

    '    End Try
    'End Sub

    Public Sub insert_InlineEditing(ByVal FN As String, ByVal fldID As String)
        Dim scrname As String = Request.QueryString("SC").ToString()
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim da As New SqlDataAdapter("", con)
        Dim dss As New DataTable
        Try
            Dim formname As String = FN
            Dim FormnameDVM As String = ""
            'formname = Right(formname, formname.Length - 8).Trim()
            Session("FN") = formname

            'Dim ID() As String = btnDetails.ID.Split("_")
            Session("ID") = fldID.ToString  'ID(1).ToString
            ViewState("ID") = "BTN" & fldID.ToString  'ID(1).ToString
            Dim ob As New DynamicForm
            Dim DS As New DataSet
            'With(nolock) added by Himank on 29th sep 2015
            Dim oda As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF   WITH(NOLOCK) left outer JOIN MMM_MST_FORMS F  WITH(NOLOCK)  on F.FormName = FF.DocumentType and F.EID = FF.EID  where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FormName = '" & formname & "' order by displayOrder", con)
            oda.Fill(DS, "CHILD")
            'Uncheck After Testing 19/10/2016
            'Session("CHILD") = DS.Tables("CHILD")
            Session("D" & formname) = DS.Tables("CHILD")

            Dim sqlStrF As String = ""
            'With(nolock) added by Himank on 29th sep 2015
            da.SelectCommand.CommandText = "select * from MMM_MST_forms  WITH(NOLOCK)  where eid=" & Session("EID") & " and formname='" & FN & "'"
            'Dim DS As New DataSet
            Dim DSM As New DataTable
            Dim DSF As New DataTable
            Dim field As New DataTable
            Dim field1 As New DataTable
            da.Fill(DS, "inlineediting")


            If DS.Tables("inlineediting").Rows.Count > 0 Then
                Dim inlineSDoc As String = DS.Tables("inlineediting").Rows(0).Item("inlinesourceDoc").ToString
                Dim inlineType As String = DS.Tables("inlineediting").Rows(0).Item("inlineType").ToString
                'Dim inlineFilter As String() = Split(DS.Tables("inlineediting").Rows(0).Item("inlinefilter"), ":")

                Dim inlineFilter As String() = Split(DS.Tables("inlineediting").Rows(0).Item("inlinefilter"), "~")

                Dim tablename As String = ""
                Dim Pid As String = ""
                If inlineType.ToUpper = "MASTER" Then
                    tablename = "MMM_MST_MASTER"
                    Pid = "TID"
                ElseIf inlineType.ToUpper = "DOCUMENT" Then
                    tablename = "MMM_MST_DOC"
                    Pid = "TID"
                ElseIf inlineType.ToUpper = "DETAIL FORM" Then
                    tablename = "MMM_MST_DOC_ITEM"
                    Pid = "TID"
                End If

                Dim sqlStrM As String = ""
                Dim sqlStrMfld As String = ""
                'With(nolock) added by Himank on 29th sep 2015
                da.SelectCommand.CommandText = "select * from MMM_MST_Fields   WITH(NOLOCK) where documenttype='" & FN & "' and eid=" & Session("EID") & " and inlinemapping is not null order by displayorder "
                da.Fill(field)


                Dim filterRows() As DataRow
                Dim filterRows1() As DataRow
                filterRows = field.Select("inlinemapping is not null and inlinemapping <>''", "DisplayOrder")
                filterRows1 = field.Select("InLineEditing=1 and inlinemapping is null", "DisplayOrder")
                If filterRows.Length > 0 Then
                    field = filterRows.CopyToDataTable()
                    If filterRows1.Length > 0 Then
                        field.Merge(filterRows1.CopyToDataTable())
                    End If
                Else
                    field = filterRows1.CopyToDataTable()
                End If

                If field.Rows.Count > 0 Then
                    For i As Integer = 0 To field.Rows.Count - 1
                        sqlStrM = sqlStrM & " " & field.Rows(i).Item("inlinemapping").ToString() & "[" & field.Rows(i).Item("displayname") & "],"
                        sqlStrMfld = sqlStrMfld & " |" & field.Rows(i).Item("inlinemapping").ToString() & "|,"
                    Next
                    sqlStrM = Left(sqlStrM, sqlStrM.Length - 1)
                    sqlStrMfld = Left(sqlStrMfld, sqlStrMfld.Length - 1)

                    Dim filter As String = ""
                    Dim flag As Int16 = 0   ' flag for checking multiple condition and adding 'and' operator to the sql query 
                    For k As Integer = 0 To inlineFilter.Length - 1
                        Dim SD As String() = Split(inlineFilter(k), "-")  ' check for static or dynamic filter
                        Dim Opr As String() = Split(SD(1), "|")
                        If SD.Length > 1 Then
                            If SD(0).ToUpper = "S" Then  ' for static check S
                                If flag = 1 Then
                                    'filter &= " and " & " convert(float," & Opr(0) & ") " & Opr(1) & " '" & Opr(2) & "'"
                                    'filter &= " and " & " Cast(Replace(Replace(" & Opr(0) & ",',','.'),'.','') AS FLOAT) " & Opr(1) & " '" & Opr(2) & "'"
                                    filter &= " and " & Opr(0) & Opr(1) & " '" & Opr(2) & "'"
                                Else
                                    'filter = "convert(float," & Opr(0) & ") " & Opr(1) & " '" & Opr(2) & "'"
                                    'filter = "Cast(Replace(Replace(" & Opr(0) & ",',','.'),'.','') AS FLOAT) " & Opr(1) & " '" & Opr(2) & "'"
                                    filter = Opr(0) & Opr(1) & " '" & Opr(2) & "'"

                                End If
                                flag = 1

                            Else  ' for dynamic check D
                                If DynamicForm.GetControl(pnlFields, "fld" & Opr(2)) Then
                                    Dim ddl As New DropDownList
                                    ddl = pnlFields.FindControl("fld" & Opr(2))
                                    Session("BindGrdOnDdl") = Opr(2) & "-" & FN    ' this is used in page init and DynamicGrdFilter
                                    If flag = 1 Then
                                        If ViewState("ddlChange") = 1 Then
                                            'filter &= "and " & " convert(float," & Opr(0) & ") " & Opr(1) & " '" & ddl.SelectedItem.Value.Trim & "'"
                                            ' filter &= "and " & " Cast(Replace(Replace(" & Opr(0) & ",',','.'),'.','') AS FLOAT)  " & Opr(1) & " '" & ddl.SelectedItem.Value.Trim & "'"
                                            ''filter &= "and " & Opr(0) & Opr(1) & " '" & ddl.SelectedItem.Value.Trim & "'"

                                            filter &= "and " & Opr(0) & Opr(1) & " '" & IIf(DS.Tables("inlineediting").Rows(0).Item("InLineMathType").ToString.ToUpper = "VALUE", ddl.SelectedItem.Value.Trim, ddl.SelectedItem.Text.Trim) & "'"

                                        Else
                                            'filter &= "and " & " convert(float," & Opr(0) & ") " & Opr(1) & " " & ddl.SelectedItem.Value & ""
                                            'filter &= "and " & " Cast(Replace(Replace(" & Opr(0) & ",',','.'),'.','') AS FLOAT)  " & Opr(1) & " '" & ddl.SelectedItem.Value & "'"   ' this is commenting because first time dynamic condition is not applied
                                            Exit Sub
                                        End If
                                    Else
                                        If ViewState("ddlChange") = 1 Then
                                            'filter = " convert(float," & Opr(0) & ") " & Opr(1) & " '" & ddl.SelectedItem.Value.Trim & "'"
                                            'filter = " Cast(Replace(Replace(" & Opr(0) & ",',','.'),'.','') AS FLOAT) " & Opr(1) & " '" & ddl.SelectedItem.Value.Trim & "'"

                                            filter = Opr(0) & Opr(1) & " '" & IIf(DS.Tables("inlineediting").Rows(0).Item("InLineMathType").ToString.ToUpper = "VALUE", ddl.SelectedItem.Value.Trim, ddl.SelectedItem.Text.Trim) & "'"
                                        Else
                                            Exit Sub
                                            ''filter = " convert(float," & Opr(0) & ") " & Opr(1) & " " & ddl.SelectedItem.Value & ""
                                        End If
                                    End If
                                    flag = 1
                                End If
                            End If
                        End If
                        'sqlStrMfld = Replace(Left(sqlStrMfld, sqlStrMfld.Length - 1), "'", "''")
                    Next
                    da.SelectCommand.CommandText = "uspGetInlineValuesFromMaster_new1"
                    da.SelectCommand.CommandType = CommandType.StoredProcedure
                    da.SelectCommand.Parameters.AddWithValue("FN", inlineSDoc)
                    da.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
                    da.SelectCommand.Parameters.AddWithValue("childDoctype", FN)
                    da.SelectCommand.Parameters.AddWithValue("sqlMfld", sqlStrMfld)
                    da.SelectCommand.Parameters.AddWithValue("tablename", tablename)
                    ' parameters for filtering 
                    da.SelectCommand.Parameters.AddWithValue("filter", filter)

                    DSM.Columns.Add("All", GetType(String)) ' adding checkbox for grid to select All
                    da.Fill(DSM)

                    If DSM.Rows.Count < 1 Then  ' if no data then dispose the Dynamic grid and show the message
                        Dim lbl As Label = CType(pnlFields.FindControl("LblGrd" & fldID.ToString), Label)
                        lbl.Text = "as per rule defined data not fined "
                        lbl.Visible = True
                        'UpdatePanel1.Update()
                        'Exit Sub
                    Else
                        Dim lbl As Label = CType(pnlFields.FindControl("LblGrd" & fldID.ToString), Label)
                        lbl.Text = ""
                        lbl.Visible = False
                    End If
                End If
                'With(nolock) added by Himank on 29th sep 2015
                da.SelectCommand.CommandText = "select * from MMM_MST_Fields   WITH(NOLOCK)  where documenttype='" & FN & "' and eid=" & Session("EID") & " and inlineediting=1 order by InLineEditing, displayorder "
                da.SelectCommand.CommandType = CommandType.Text
                da.Fill(field1)
                If field1.Rows.Count > 0 Then
                    For i As Integer = 0 To field1.Rows.Count - 1
                        sqlStrF = sqlStrF & " " & field1.Rows(i).Item("fieldmapping").ToString() & "[" & field1.Rows(i).Item("displayname") & "],"
                    Next
                    sqlStrF = Left(sqlStrF, sqlStrF.Length - 1)
                    'da.SelectCommand.CommandText = "select " & sqlStrF & " from " & tablename & " where documenttype='" & inlineSDoc & "' and eid=" & Session("EID") & ""
                    'With(nolock) added by Himank on 29th sep 2015
                    da.SelectCommand.CommandText = "select " & sqlStrF & " from MMM_MST_DOC_ITEM  WITH(NOLOCK)  where documenttype='" & FN & "' and 1=0"
                    da.SelectCommand.CommandType = CommandType.Text
                    da.Fill(DSF)
                End If
                DSM.Merge(DSF, True, MissingSchemaAction.Add)
                DSM.Merge(DSF, True, MissingSchemaAction.Add)
                DSM.Columns.Item("cmastertid").SetOrdinal(DSM.Columns.Count - 1)
                DSM.Columns.Item("tid").SetOrdinal(DSM.Columns.Count - 1)
                DSM.DefaultView.ToTable()

                'For i As Integer = 1 To field1.Rows.Count - 1
                '    DSM.Columns.Item(field1.Rows(i - 1).Item("displayname").ToString).SetOrdinal(i)
                'Next

                'DSF.Merge(DSM, True, MissingSchemaAction.Add)
                'DSF.Columns.Item("cmastertid").SetOrdinal(DSM.Columns.Count - 1)
                'DSF.Columns.Item("tid").SetOrdinal(DSM.Columns.Count - 1)
                'If DSF.Columns.Contains("All") Then
                '    DSF.Columns.Item("All").SetOrdinal(0)
                'End If

                'DSF.DefaultView.ToTable()

            End If
            ADD_DV_ITEMSTOGRID(FN, DSM, DSM)
            'ADD_DV_ITEMSTOGRID(FN, DSF, DSF)
            '        Dim oda As New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF left outer JOIN MMM_MST_FORMS F on F.FormName = FF.DocumentType and F.EID = FF.EID  where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FormName = '" & formname & "' order by displayOrder", con)
            da.Dispose()
            con.Close()
            DS.Dispose()

        Catch ex As Exception
        Finally
            con.Dispose()
            da.Dispose()
            con.Close()
        End Try
    End Sub

    Public Sub INSERT_DEFAULTVALUES(ByVal FN As String, ByVal fldID As String, ByVal chidDocID As Integer, ByVal DtForm As DataTable, Optional ByVal inlineEdit As Integer = 0)

        Dim formname As String = FN
        Dim FormnameDVM As String = ""
        Session("FN") = formname
        'PRashant_30_7
        If DtForm.Rows(0).Item("hasdefaultvalue").ToString() = "1" Then
            ViewState("FN_DVM") = formname & "_MASTER"
            FormnameDVM = formname & "_MASTER"
        Else
            ViewState("FN_DVM") = formname
            FormnameDVM = formname
        End If

        ViewState("Default") = DtForm.Rows(0).Item("IsDefaultRows").ToString() & "_" & DtForm.Rows(0).Item("hasdefaultvalue").ToString()
        'PRashant_30_7


        Session("ID") = fldID.ToString  'ID(1).ToString
        ViewState("ID") = "BTN" & fldID.ToString  'ID(1).ToString


        Dim ob As New DynamicForm
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim DS As New DataSet

        'Dim oda As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF left outer JOIN MMM_MST_FORMS F on F.FormName = FF.DocumentType and F.EID = FF.EID  where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FormName = '" & formname & "' order by displayOrder", con)
        'With(nolock) added by Himank on 29th sep 2015
        Dim oda As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF   WITH(NOLOCK) left outer JOIN MMM_MST_FORMS F   WITH(NOLOCK) on F.FormName = FF.DocumentType and F.EID = FF.EID  where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FormName = '" & formname & "' order by displayOrder", con)
        oda.Fill(DS, "CHILD")
        'Uncheck After Testing 19/10/2016
        'Session("CHILD") = DS.Tables("CHILD")
        Session("D" & formname) = DS.Tables("CHILD")
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If
        'With(nolock) added by Himank on 29th sep 2015
        oda.SelectCommand.CommandText = "select documenttype from  MMM_MST_DOC   WITH(NOLOCK) where EID=" & Session("EID") & " and tid =" & chidDocID
        Dim dtdocType As New DataTable
        Dim scrname As String
        oda.Fill(dtdocType)
        If dtdocType.Rows.Count > 0 Then
            scrname = dtdocType.Rows(0).Item(0).ToString
            ViewState("MDOCTYPE") = scrname
        End If

        Dim DefValMastDoctype As String = ""
        DS.Tables.Clear()
        ' Dim ddl As DropDownList = TryCast(pnlFields.FindControl("fld" & ID(0).ToString()), DropDownList)
        ' Dim docid() As String = ddl.SelectedValue.ToString.Split("|")
        oda.SelectCommand.Parameters.Clear()
        oda.SelectCommand.CommandType = CommandType.StoredProcedure
        oda.SelectCommand.CommandText = "uspGetDetailITEMBYDOCID"
        oda.SelectCommand.CommandType = CommandType.StoredProcedure
        oda.SelectCommand.Parameters.AddWithValue("DOCID", chidDocID)
        oda.SelectCommand.Parameters.AddWithValue("FN", FN)
        oda.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
        DS.Tables.Clear()

        Dim dtitem As New DataTable
        Dim dtVal As New DataTable

        If inlineEdit = 1 Then
            dtitem.Columns.Add("All", GetType(String))
        End If

        oda.Fill(dtitem)
        'Session("ITEM") = DS.Tables("ITEM")
        Session("ITEM") = dtitem

        If inlineEdit = 1 Then
            dtVal.Columns.Add("All", GetType(String))
        End If

        oda.Fill(dtVal)
        oda.SelectCommand.CommandType = CommandType.Text
        'With(nolock) added by Himank on 29th sep 2015
        oda.SelectCommand.CommandText = "SELECT F1.FieldID,F2.displayName FROM MMM_MST_FIELDS F1   WITH(NOLOCK) INNER JOIN MMM_MST_FIELDS F2   WITH(NOLOCK) ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType ='CHILD ITEM TOTAL' AND F2.DocumentType ='" & formname & "' AND F1.DOCUMENTTYPE='" & scrname & "'"
        oda.Fill(DS, "TOTAL")

        '' WRITE here func that will add row by row values in grid ' write new function by sunil
        'ADD_DV_ITEMSTOGRID(formname, DS.Tables("ITEM"), DS.Tables("ITEM_VALS"))
        ADD_DV_ITEMSTOGRID(formname, dtitem, dtVal)

        Dim ColHead() As String = {}
        Dim DDLTxt() As String = {}
        Dim DDLval() As String = {}
        Dim aCnt As Integer = 0

        Dim dtC As DataTable = Session("D" & formname) 'DS.Tables("CHILD")

        For j = 0 To dtC.Rows.Count - 1
            If dtC.Rows(j).Item("fieldtype").ToString = "DROP DOWN" And dtC.Rows(j).Item("DROPDOWNTYPE") = "MASTER VALUED" Then
                For i As Integer = 0 To DS.Tables("item").Rows.Count - 1
                    For k As Integer = 0 To DS.Tables("item").Columns.Count - 1
                        If DS.Tables("item").Columns(k).ColumnName = dtC.Rows(j).Item("displayname").ToString Then  '' matched col. (mast. val.) 
                            ColHead(aCnt) = formname & "_" & dtC.Rows(j).Item("displayname").ToString
                            DDLTxt(aCnt) = DS.Tables("item").Rows(i).Item(DS.Tables("item").Columns(k).ColumnName).ToString
                            DDLval(aCnt) = DS.Tables("ITEM_VALS").Rows(i).Item(DS.Tables("item").Columns(k).ColumnName).ToString
                        End If
                    Next
                Next
            End If
        Next

        Session("COLHEAD") = ColHead
        Session("DDLTXT") = DDLTxt
        Session("DDLVAL") = DDLval

        dtC.Dispose()
        oda.Dispose()
        DS.Dispose()
        con.Dispose()
    End Sub

    Public Sub INSERT_DEFAULTVALUES(ByVal FN As String, ByVal fldID As String, DtForm As DataTable)
        '' new created for inserting def. values from master table in document on 17-Dec-13 by sunil pareek
        'Dim btnDetails As Button = TryCast(SENDER, Button)
        Dim formname As String = FN
        Dim FormnameDVM As String = ""
        'formname = Right(formname, formname.Length - 8).Trim()
        Session("FN") = formname
        'aaaa
        If DtForm.Rows(0).Item("hasdefaultvalue").ToString() = "1" Then
            ViewState("FN_DVM") = formname & "_MASTER"
            FormnameDVM = formname & "_MASTER"
        Else
            ViewState("FN_DVM") = formname
            FormnameDVM = formname
        End If

        'Dim ID() As String = btnDetails.ID.Split("_")
        Session("ID") = fldID.ToString  'ID(1).ToString
        ViewState("ID") = "BTN" & fldID.ToString  'ID(1).ToString

        'aaaa
        ViewState("Default") = DtForm.Rows(0).Item("IsDefaultRows").ToString() & "_" & DtForm.Rows(0).Item("hasdefaultvalue").ToString()



        Dim scrname As String = Request.QueryString("SC").ToString()
        Dim ob As New DynamicForm
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim DS As New DataSet
        'With(nolock) added by Himank on 29th sep 2015
        Dim oda As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF   WITH(NOLOCK) left outer JOIN MMM_MST_FORMS F  WITH(NOLOCK)  on F.FormName = FF.DocumentType and F.EID = FF.EID  where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FormName = '" & formname & "' order by displayOrder", con)
        oda.Fill(DS, "CHILD")
        'Uncheck After 19/10/2016
        'Session("CHILD") = DS.Tables("CHILD")
        Session("D" & formname) = DS.Tables("CHILD")
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If

        Dim dtfld = DS.Tables("CHILD")

        Dim filterRows() As DataRow 'By neha Thakar 
        filterRows = dtfld.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''", "InLineEditing, DisplayOrder")

        If filterRows.Count > 0 Then
            Dim dtfld1 = filterRows.CopyToDataTable()


            Dim filterRows1() As DataRow
            Dim filterRows2() As DataRow
            filterRows1 = dtfld1.Select("inlinemapping is not null and inlinemapping <>''", "DisplayOrder")
            filterRows2 = dtfld1.Select("InLineEditing=1 and inlinemapping is null", "DisplayOrder")

            If filterRows.Length > 0 Then
                If filterRows1.Length > 0 Then
                    dtfld1 = filterRows1.CopyToDataTable()
                    If filterRows2.Length > 0 Then
                        dtfld1.Merge(filterRows2.CopyToDataTable())
                    End If
                Else
                    If filterRows2.Length > 0 Then
                        dtfld1 = filterRows2.CopyToDataTable()
                    End If
                End If
            Else
                dtfld1 = filterRows2.CopyToDataTable()
            End If

            Dim strFlds = ""
            For i As Integer = 0 To dtfld1.Rows.Count - 1
                strFlds &= dtfld1.Rows(i).Item("FieldMapping") & ","
            Next



            Dim DefValMastDoctype As String = ""
            Dim CdocType As String = ""
            DS.Tables.Clear()
            ' Dim ddl As DropDownList = TryCast(pnlFields.FindControl("fld" & ID(0).ToString()), DropDownList)
            ' Dim docid() As String = ddl.SelectedValue.ToString.Split("|")
            oda.SelectCommand.Parameters.Clear()
            oda.SelectCommand.CommandText = "uspGetDefValuesFromMaster1"
            oda.SelectCommand.CommandType = CommandType.StoredProcedure
            oda.SelectCommand.Parameters.AddWithValue("FN", FormnameDVM)
            oda.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
            oda.SelectCommand.Parameters.AddWithValue("flds", strFlds.Substring(0, strFlds.Length - 1))
            oda.Fill(DS, "ITEM")
            '  DS.Tables("ITEM").Columns.Add("All", GetType(String)).SetOrdinal(0) ' adding checkbox for grid to select All
            '' for values 
            If Not DS.Tables("item").Columns.Contains("tid") Then
                DS.Tables("item").Columns.Add("tid", GetType(String))  ' 20 jan commentted by balli
            End If

            oda.SelectCommand.Parameters.Clear()
            oda.SelectCommand.CommandText = "uspGetDefValuesFromMaster_Vals1"
            oda.SelectCommand.CommandType = CommandType.StoredProcedure
            oda.SelectCommand.Parameters.AddWithValue("FN", FormnameDVM)
            oda.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
            oda.SelectCommand.Parameters.AddWithValue("flds", strFlds.Substring(0, strFlds.Length - 1))
            oda.Fill(DS, "ITEM_VALS")


            oda.SelectCommand.CommandType = CommandType.Text
            'With(nolock) added by Himank on 29th sep 2015
            oda.SelectCommand.CommandText = "SELECT F1.FieldID,F2.displayName,F1.FieldType FROM MMM_MST_FIELDS F1   WITH(NOLOCK) INNER JOIN MMM_MST_FIELDS F2  WITH(NOLOCK)  ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType  in ('CHILD ITEM MAX','CHILD ITEM TOTAL')  AND F2.DocumentType ='" & formname & "' AND F1.DOCUMENTTYPE='" & scrname & "'"
            oda.Fill(DS, "TOTAL")

            '' WRITE here func that will add row by row values in grid ' write new function by sunil
            ADD_DV_ITEMSTOGRID(formname, DS.Tables("ITEM"), DS.Tables("ITEM_VALS"))

            Dim ColHead() As String = {}
            Dim DDLTxt() As String = {}
            Dim DDLval() As String = {}
            Dim aCnt As Integer = 0

            Dim dtC As DataTable = Session("D" & formname) 'DS.Tables("CHILD")

            For j = 0 To dtC.Rows.Count - 1
                If dtC.Rows(j).Item("fieldtype").ToString = "DROP DOWN" And dtC.Rows(j).Item("DROPDOWNTYPE") = "MASTER VALUED" Then
                    For i As Integer = 0 To DS.Tables("item").Rows.Count - 1
                        For k As Integer = 0 To DS.Tables("item").Columns.Count - 1
                            If DS.Tables("item").Columns(k).ColumnName = dtC.Rows(j).Item("displayname").ToString Then  '' matched col. (mast. val.) 
                                ColHead(aCnt) = formname & "_" & dtC.Rows(j).Item("displayname").ToString
                                DDLTxt(aCnt) = DS.Tables("item").Rows(i).Item(DS.Tables("item").Columns(k).ColumnName).ToString
                                DDLval(aCnt) = DS.Tables("ITEM_VALS").Rows(i).Item(DS.Tables("item").Columns(k).ColumnName).ToString
                            End If
                        Next
                    Next
                End If
            Next

            Session("COLHEAD") = ColHead
            Session("DDLTXT") = DDLTxt
            Session("DDLVAL") = DDLval
            dtC.Dispose()
        End If
        '' arrays for holding master valued column data 
        'Dim array3Ds(,,) As String = New String(,,) {}

        oda.Dispose()
        DS.Dispose()
        con.Dispose()
    End Sub

    Private Sub GetMenuandroles()
        Dim screen As String = Request.QueryString("SC").ToString()
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As New SqlConnection(conStr)
        ' Dim scrname As String = Request.QueryString("SC").ToString()
        Dim da As New SqlDataAdapter("", con)
        Dim ds As New DataSet
        'Dim cr As String = Session("CODE") & "_" & Session("USERROLE")
        'With(nolock) added by Himank on 29th sep 2015
        da.SelectCommand.CommandText = "select * from mmm_mst_menu  WITH(NOLOCK)  where eid=" & Session("EID") & " and pagelink='Documents.aspx?SC=" & screen & "'"
        da.Fill(ds, "menu")
        If ds.Tables("menu").Rows.Count > 0 Then
            Dim rol As String() = ds.Tables("menu").Rows(0).Item("Roles").ToString().Split(",")

            For j As Integer = 0 To rol.Length - 1
                Dim a As String() = rol(j).ToString().Split(":")
                If Session("USERROLE") = a(0).Remove(0, 1).ToString() Then
                    ViewState("numval") = a(1).Remove(a(1).Length - 1)
                End If
            Next
            If ViewState("numval") = 1 Then
                btnActEdit.Visible = False
            ElseIf ViewState("numval") = 4 Then
                btnActEdit.Visible = False
            ElseIf ViewState("numval") = 5 Then
                btnActEdit.Visible = False
            ElseIf ViewState("numval") = 8 Then
                btnActEdit.Visible = False
            ElseIf ViewState("numval") = 9 Then
                btnActEdit.Visible = False
            ElseIf ViewState("numval") = 12 Then
                btnActEdit.Visible = False
            ElseIf ViewState("numval") = 13 Then
                btnActEdit.Visible = False
            End If
        End If


        con.Close()
        da.Dispose()
    End Sub

    'Protected Sub gvData_InlineEdit(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewRowEventArgs)
    '    Try
    '        Dim fn As String = ""
    '        'Dim dtFld1 As DataTable = ViewState(fn) ' Session(fn)
    '        Dim dtfld1 As DataTable '= ViewState(fn)
    '        Dim row As GridViewRow = e.Row

    '        Dim fns() As String = Session("FNS").ToString.Split(":")
    '        'Dim GV As GridView = 
    '        Dim GID As String = row.Parent.Parent.ID
    '        GID = Right(GID, GID.Length - 3)
    '        'Prashant 30-6-2014
    '        Session("GRDID") = GID
    '        '' new added for hiding tid - on 27 dec 8.30 pm by sp
    '        e.Row.Cells(e.Row.Cells.Count - 1).Visible = False

    '        For I As Integer = 0 To fns.Length - 1
    '            If fns(I).ToString = GID.ToString Then
    '                fn = fns(I - 1).ToString
    '                Exit For
    '            End If
    '        Next
    '        dtfld1 = Session("D" & fn)
    '        For m As Integer = 0 To row.Cells.Count - 1
    '            row.Cells(m).HorizontalAlign = HorizontalAlign.Center
    '            row.Cells(m).Width = 15
    '        Next

    '        'Dim chkadd As Integer = 0

    '        If row.RowType = DataControlRowType.Header Then  ' for header bind checkbox to check all in grid 
    '            If row.Cells(0).Text = "All" Then
    '                Dim chk As New CheckBox
    '                chk.Text = "All"
    '                chk.Attributes.Add("onclick", "javascript:checkAll('" & GID & "');")
    '                row.Cells(0).Controls.Add(chk)
    '                ViewState("chkadd") = 1
    '            End If
    '            If row.Cells(e.Row.Cells.Count - 2).Text = "cmasterTid" Then
    '                ViewState("cmasterId") = 1
    '                row.Cells(e.Row.Cells.Count - 2).Visible = False
    '            End If

    '            For i As Integer = 0 To row.Cells.Count - 1
    '                If row.Cells(i).Text.ToUpper = "TID" Then
    '                    row.Cells(i).Visible = False
    '                    ViewState("Tid") = i
    '                End If
    '            Next
    '        End If

    '        If row.RowType = DataControlRowType.DataRow Then
    '            ' For j As Integer = 0 To row.Cells.Count - 1
    '            If ViewState("cmasterId") = 1 Then 'by neha thakar to hide CmasterId  
    '                row.Cells(row.Cells.Count - 2).Visible = False
    '            End If

    '            If Not IsNothing(ViewState("Tid")) Then
    '                row.Cells(Convert.ToInt32(ViewState("Tid"))).Visible = False
    '            End If

    '            Dim controlWdth As Integer = 100
    '            If row.Cells(0).Text.ToUpper <> "TOTAL" Then
    '                If ViewState("chkadd") = 1 Then  'this is for adding child check box 
    '                    Dim chk As New CheckBox
    '                    chk.ID = "fld" & row.RowIndex
    '                    row.Cells(0).Controls.Add(chk)
    '                End If
    '                'By Neha Thakar 23-01-15
    '                ' To add new row when add Data Button is clicked in Child item
    '                If Not IsNothing(Session("FilterAddedRow")) Then
    '                    Session("AddedRow") = Session("FilterAddedRow")
    '                End If
    '                Dim DICT As New Dictionary(Of Integer, Integer)
    '                DICT = CType(Session("AddedRow"), Dictionary(Of Integer, Integer))

    '                If Not IsNothing(DICT) Then

    '                    If Not IsNothing(Session("AddedRow")) And DICT.ContainsKey(row.RowIndex) Then
    '                        Dim filterRows() As DataRow 'By neha Thakar 
    '                        filterRows = dtfld1.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''", "InLineEditing, DisplayOrder")
    '                        'filterRows = dtfld1.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''", "InLineEditing, DisplayOrder")
    '                        dtfld1 = filterRows.CopyToDataTable()

    '                        Dim filterRows1() As DataRow
    '                        Dim filterRows2() As DataRow
    '                        filterRows1 = dtfld1.Select("inlinemapping is not null and inlinemapping <>''", "DisplayOrder")
    '                        filterRows2 = dtfld1.Select("InLineEditing=1 and inlinemapping is null", "DisplayOrder")
    '                        If filterRows.Length > 0 Then
    '                            If filterRows1.Length > 0 Then
    '                                dtfld1 = filterRows1.CopyToDataTable()
    '                                If filterRows2.Length > 0 Then
    '                                    dtfld1.Merge(filterRows2.CopyToDataTable())
    '                                End If
    '                            Else
    '                                If filterRows2.Length > 0 Then
    '                                    dtfld1 = filterRows2.CopyToDataTable()
    '                                End If
    '                            End If

    '                        Else
    '                            dtfld1 = filterRows2.CopyToDataTable()
    '                        End If

    '                        For l As Integer = 0 To dtfld1.Rows.Count - 1
    '                            Dim colValue As String = row.DataItem(l).ToString()
    '                            Dim ftype1 As String = dtfld1.Rows(l).Item("fieldtype").ToString()
    '                            Dim ilEdit1 As Integer = dtfld1.Rows(l).Item("inlineEditing").ToString()
    '                            Dim datatype1 As String = dtfld1.Rows(l).Item("datatype").ToString() 'Prashant_10_7
    '                            Dim controlWdth1 As Integer = 100

    '                            Dim FldID1 As String = dtfld1.Rows(l).Item("fieldid").ToString()
    '                            Dim Formula1 = Convert.ToString(dtfld1.Rows(l).Item("cal_text"))
    '                            Dim DisplayName1 = Convert.ToString(dtfld1.Rows(l).Item("DisplayName"))
    '                            ' If ilEdit1 = 1 Then
    '                            If ftype1.ToUpper() = "TEXT BOX" Or ftype1.ToUpper() = "CALCULATIVE FIELD" Or ftype1.ToUpper() = "LOOKUP" Or ftype1.ToUpper() = "PARENT VALUE" Then
    '                                Dim cb As New TextBox
    '                                'cb.ID = "fld" & l.ToString() & "_" & row.RowIndex
    '                                cb.Width = 55
    '                                cb.ID = "fld" & FldID1 & row.RowIndex

    '                                'Prashant_10_7
    '                                If dtfld1.Rows(l).Item("defaultfieldval").ToString().Length > 0 Then
    '                                    cb.Text = dtfld1.Rows(l).Item("defaultfieldval").ToString()
    '                                Else
    '                                    If datatype1.ToUpper() = "NUMERIC" Then
    '                                        cb.Text = "0"
    '                                    End If
    '                                End If
    '                                If Val(dtfld1.Rows(l).Item("isDescription").ToString()) = 1 Then
    '                                    cb.ToolTip = dtfld1.Rows(l).Item("Description").ToString()
    '                                End If
    '                                'If dtfld1.Rows(l).Item("iseditable") = 0 Then
    '                                '    cb.Attributes.Add("READONLY", "READONLY")
    '                                '    cb.Attributes.Add("COLOR", "GRAY")
    '                                'End If


    '                                If ftype1.ToUpper() = "CALCULATIVE FIELD" Then
    '                                    colValue = "0"
    '                                    cb.Attributes.Add("READONLY", "READONLY")
    '                                    cb.Attributes.Add("COLOR", "GRAY")
    '                                End If

    '                                If ViewState("chkadd") = 1 Then
    '                                    l = l + 1
    '                                End If

    '                                If ftype1.ToUpper() = "LOOKUP" Then
    '                                    If datatype1.ToUpper() = "NUMERIC" Then
    '                                        colValue = "0"
    '                                    End If
    '                                Else
    '                                    If Val(colValue) = 0 Then
    '                                        If ftype1.ToUpper() = "TEXT BOX" And datatype1.ToUpper() = "NUMERIC" Then
    '                                            colValue = "0"
    '                                        End If
    '                                    End If
    '                                End If

    '                                If Not row.Cells(l).Text.Trim = "&nbsp;" And Not row.Cells(l).Text.Trim = "" Then
    '                                    colValue = row.Cells(l).Text.Trim
    '                                End If

    '                                cb.Text = colValue
    '                                cb.Width = controlWdth1
    '                                row.Cells(l).Controls.Add(cb)

    '                                If datatype1.ToUpper.Trim = "DATETIME" Then
    '                                    Dim CLNDR As New AjaxControlToolkit.CalendarExtender
    '                                    CLNDR.Controls.Clear()
    '                                    CLNDR.ID = "CLNDR" & dtfld1.Rows(l).Item("FieldID").ToString()
    '                                    CLNDR.Format = "dd/MM/yy"
    '                                    CLNDR.TargetControlID = cb.ID
    '                                    cb.Enabled = True
    '                                    If Request.QueryString("TID") Is Nothing Then
    '                                        cb.Text = String.Format("{0:dd/MM/yy}", Date.Now())
    '                                    End If

    '                                    row.Cells(l).Controls.Add(CLNDR) '
    '                                End If

    '                                If Not Formula1 Is Nothing And Formula1 <> "" Then
    '                                    'Dim arrFor As String() = Formula.Split(",")
    '                                    Dim jScript = GenerateJQueryScript(dtfld1, GID, row.RowIndex, Formula1, FldID1)
    '                                    If jScript <> "" Then
    '                                        cb.Attributes.Add("onblur", jScript)
    '                                    End If
    '                                End If


    '                            ElseIf ftype1.ToUpper() = "AUTOCOMPLETE" Then

    '                                Dim txtbox As New TextBox
    '                                txtbox.ID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
    '                                txtbox.Width = controlWdth - 10
    '                                txtbox.CssClass = "txtBox"
    '                                txtbox.Attributes.Add("placeholder", "Please begin typing a " & DisplayName1)

    '                                txtbox.AutoPostBack = True
    '                                AddHandler txtbox.TextChanged, AddressOf txtbox_TextChanged
    '                                ' adding handler for binding lookup or other dropdown or filter

    '                                Dim autofilExtender As New AjaxControlToolkit.AutoCompleteExtender
    '                                autofilExtender.ID = "extenderID" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex

    '                                autofilExtender.TargetControlID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
    '                                autofilExtender.ServiceMethod = "GetCompletionList" ' THIS SERVICE METHOD IS WRITTEN ON DOCUMENT PAGE 
    '                                autofilExtender.DelimiterCharacters = ""
    '                                autofilExtender.ContextKey = dtfld1.Rows(l).Item("DROPDOWN").ToString() & "-" & dtfld1.Rows(l).Item("FieldID").ToString() & "-" & dtfld1.Rows(l).Item("DROPDOWNTYPE").ToString() & "-" & dtfld1.Rows(l).Item("AUTOFILTER").ToString() & "-" & dtfld1.Rows(l).Item("InitialFilter").ToString()
    '                                'context key contain  : dropdown-fieldid-dropdowntype-autofilter-InitialFilter' adding the fieldid in context key because later on we need id of field in web method 
    '                                autofilExtender.Enabled = True
    '                                autofilExtender.CompletionSetCount = 5
    '                                autofilExtender.OnClientShown = "onDataShown"  ' by sunil
    '                                '   autofilExtender.CompletionListElementID = "ACsugestlist"
    '                                autofilExtender.MinimumPrefixLength = 1  ' start searching when entered one characters
    '                                'autofilExtender.OnClientItemSelected = "ace_itemSelected('" & ds.Rows(i).Item("FieldID").ToString() & "')"
    '                                autofilExtender.OnClientItemSelected = "ace_itemSelected"
    '                                row.Cells(l).Controls.Add(txtbox)
    '                                'pnlFields.Controls.Add(txtbox)

    '                                Dim hdnfld As New HiddenField
    '                                hdnfld.ID = "HDN" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
    '                                row.Cells(l).Controls.Add(hdnfld)
    '                                'pnlFields.Controls.Add(img)
    '                                'pnlFields.Controls.Add(prgBar)
    '                                row.Cells(l).Controls.Add(autofilExtender)
    '                                'pnlFields.Controls.Add(autofilExtender)

    '                            ElseIf ftype1.ToUpper() = "FORMULA FIELD" Then
    '                                Dim txtBox As New TextBox
    '                                txtBox.ID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
    '                                txtBox.Width = controlWdth - 10
    '                                txtBox.CssClass = "txtBox"
    '                                If dtfld1.Rows(l).Item("isEditable").ToString() = "1" Then
    '                                    txtBox.Enabled = True
    '                                Else
    '                                    txtBox.Enabled = False
    '                                End If

    '                                If ViewState("chkadd") = 1 Then
    '                                    l = l + 1
    '                                End If
    '                                If Not row.Cells(l).Text = "" And Not row.Cells(l).Text = "&nbsp;" Then
    '                                    txtBox.Text = row.Cells(l).Text
    '                                Else
    '                                    txtBox.Text = "0"
    '                                End If

    '                                row.Cells(l).Controls.Add(txtBox)

    '                            ElseIf ftype1.ToUpper() = "TEXT AREA" Then
    '                                Dim txtBox As New TextBox
    '                                txtBox.ID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
    '                                txtBox.Width = controlWdth + 50
    '                                txtBox.Height = 50
    '                                txtBox.TextMode = TextBoxMode.MultiLine
    '                                txtBox.Columns = 4
    '                                txtBox.Rows = 10
    '                                txtBox.CssClass = "txtBox"
    '                                If dtfld1.Rows(l).Item("isEditable").ToString() = "1" Then
    '                                    txtBox.Enabled = True
    '                                Else
    '                                    txtBox.Enabled = False
    '                                End If

    '                                If ViewState("chkadd") = 1 Then
    '                                    l = l + 1
    '                                End If
    '                                If Not row.Cells(l).Text = "" And Not row.Cells(l).Text = "&nbsp;" Then
    '                                    txtBox.Text = row.Cells(l).Text
    '                                End If

    '                                row.Cells(l).Controls.Add(txtBox)

    '                            ElseIf ftype1.ToUpper() = "MULTI LOOKUP" Then
    '                                Dim txtBox As New TextBox
    '                                txtBox.ID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
    '                                txtBox.Width = controlWdth - 10
    '                                txtBox.CssClass = "txtBox"
    '                                If dtfld1.Rows(l).Item("isEditable").ToString() = "1" Then
    '                                    txtBox.Enabled = True
    '                                Else
    '                                    txtBox.Enabled = False
    '                                End If

    '                                If ViewState("chkadd") = 1 Then
    '                                    l = l + 1
    '                                End If
    '                                If Not row.Cells(l).Text = "" And Not row.Cells(l).Text = "&nbsp;" Then
    '                                    txtBox.Text = row.Cells(l).Text
    '                                End If

    '                                row.Cells(l).Controls.Add(txtBox)

    '                            ElseIf ftype1.ToUpper() = "MULTI LOOKUPDDL" Then

    '                                Dim ddl As New DropDownList
    '                                ddl.ID = "fld" & FldID1 & "_" & row.RowIndex
    '                                ddl.CssClass = "txtBox"
    '                                ddl.Width = 150

    '                                Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                Dim con As SqlConnection = New SqlConnection(conStr)
    '                                Dim ddlText As String = dtfld1.Rows(l).Item("dropdown").ToString()
    '                                Dim od As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                Dim dt As New DataTable
    '                                Dim dtval As New DataTable
    '                                Dim fieldid As String()
    '                                Dim ddlval As String()
    '                                If (ddlText.ToString() <> String.Empty) Then
    '                                    fieldid = ddlText.ToString().Split(",")
    '                                    od.SelectCommand.CommandText = "select ddlMultilookupval from mmm_mst_fields where fieldid = " & fieldid(0).ToString() & ""
    '                                    od.Fill(dtval)
    '                                    If (dtval.Rows.Count > 0) Then
    '                                        ddlval = dtval.Rows(0)("ddlMultilookupval").ToString().Split(",")
    '                                        For q As Integer = 0 To ddlval.Length - 1
    '                                            If (ddlval(q).ToString().Contains("-" & dtfld1.Rows(l).Item("FieldID").ToString())) Then
    '                                                Dim temp() As String = ddlval(q).ToString().Split("-")
    '                                                od.SelectCommand.CommandText = "select * from MMM_MST_FIELDS where DOCUMENTTYPE='" & temp(0).ToString() & "' and eid=" & HttpContext.Current.Session("EID") & " and fieldmapping in('" & temp(1).ToString() & "')"
    '                                                Dim checkval As New DataTable
    '                                                od.Fill(checkval)
    '                                                Dim ddlText1 As String = checkval.Rows(0).Item("dropdown").ToString()
    '                                                Dim dropdowntype As String = checkval.Rows(0).Item("dropdowntype").ToString()
    '                                                Dim arr() As String
    '                                                If UCase(dropdowntype) = "MASTER VALUED" Then
    '                                                    Dim ob As New DynamicForm
    '                                                    arr = ddlText1.Split("-")
    '                                                    Dim TID As String = "TID"
    '                                                    Dim TABLENAME As String = ""
    '                                                    If UCase(arr(0).ToString()) = "MASTER" Then
    '                                                        TABLENAME = "MMM_MST_MASTER"
    '                                                    ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                                        TABLENAME = "MMM_MST_DOC"
    '                                                    ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                                        TABLENAME = "MMM_MST_DOC_ITEM"
    '                                                    ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                                        If arr(1).ToString.ToUpper = "USER" Then
    '                                                            TABLENAME = "MMM_MST_USER"
    '                                                            TID = "UID"
    '                                                        ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                            TABLENAME = "MMM_MST_LOCATION"
    '                                                            TID = "LOCID"
    '                                                        End If
    '                                                    End If
    '                                                    Dim lookUpqry As String = ""
    '                                                    Dim str As String = ""
    '                                                    If arr(0).ToUpper() = "CHILD" Then
    '                                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                    ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                    Else
    '                                                        If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                                            str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M "
    '                                                        Else
    '                                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                                        End If
    '                                                    End If

    '                                                    Dim xwhr As String = ""
    '                                                    Dim tids As String = ""
    '                                                    'Dim tidarr() As String

    '                                                    ''FILTER THE DATA ACCORDING TO USER 
    '                                                    tids = ob.UserDataFilter(dtfld1.Rows(l).Item("documenttype").ToString(), arr(1).ToString())

    '                                                    If tids.Length >= 2 Then
    '                                                        'tidarr = tids.Split("-")
    '                                                        xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                                    ElseIf tids = "0" Then
    '                                                        pnlFields.Visible = False
    '                                                        btnActEdit.Visible = False
    '                                                        UpdatePanel1.Update()
    '                                                        xwhr = ""
    '                                                    End If
    '                                                    str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                    Dim AutoFilter As String = dtfld1.Rows(l).Item("AutoFilter").ToString()
    '                                                    If AutoFilter.Length > 0 Then
    '                                                        If arr(0).ToUpper() = "CHILD" Then
    '                                                            If AutoFilter.ToUpper = "DOCID" Then
    '                                                                str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
    '                                                            Else
    '                                                                str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
    '                                                            End If
    '                                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                                            str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                        Else
    '                                                            str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & Session("EID") & " "
    '                                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                        End If
    '                                                    End If


    '                                                    Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                                    Dim dss As New DataSet
    '                                                    If str.Length > 0 Then
    '                                                        oda.SelectCommand.CommandText = str
    '                                                        oda.Fill(dss, "FV")
    '                                                        Dim isAddJquery As Integer = 0
    '                                                        ddl.Items.Add("Select")
    '                                                        ddl.Items(0).Value = "0"
    '                                                        For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                                            ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
    '                                                            Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
    '                                                            ddl.Items(J1 + 1).Value = lookddlVal
    '                                                        Next
    '                                                        oda.Dispose()
    '                                                        dss.Dispose()
    '                                                        'prashant_2_7

    '                                                        Dim lookupvalue As String = dtfld1.Rows(l).Item("lookupvalue").ToString()
    '                                                        Dim multilookup As String = dtfld1.Rows(l).Item("multilookUpVal").ToString()

    '                                                        If lookupvalue.Length > 0 Or multilookup.Length > 0 Then
    '                                                            ddl.AutoPostBack = True
    '                                                            AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged
    '                                                        End If

    '                                                        If ddl.Items.FindByText(row.Cells(l).Text) IsNot Nothing Then
    '                                                            ddl.Items.FindByText(row.Cells(l).Text).Selected = True
    '                                                        End If
    '                                                        If ViewState("chkadd") = 1 Then
    '                                                            l = l + 1
    '                                                        End If

    '                                                        If ddl.Items.FindByText(row.Cells(l).Text) IsNot Nothing Then
    '                                                            'ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                                            ddl.SelectedValue = ddl.Items.FindByText(row.Cells(l).Text).Value
    '                                                        End If
    '                                                        row.Cells(l).Controls.Add(ddl)
    '                                                        If isAddJquery = 1 Then
    '                                                            Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
    '                                                        End If
    '                                                    End If
    '                                                    con.Dispose()
    '                                                    oda.Dispose()
    '                                                    dss.Dispose()
    '                                                ElseIf UCase(dropdowntype) = "SESSION VALUED" Then

    '                                                End If
    '                                            End If
    '                                        Next
    '                                    End If
    '                                End If

    '                            ElseIf ftype1.ToUpper() = "DROP DOWN" Then
    '                                Dim ddl As New DropDownList

    '                                ddl.ID = "fld" & FldID1 & "_" & row.RowIndex
    '                                ddl.CssClass = "txtBox"
    '                                ddl.Width = 150
    '                                Dim ddlText As String = dtfld1.Rows(l).Item("dropdown").ToString()
    '                                Dim dropdowntype As String = dtfld1.Rows(l).Item("dropdowntype").ToString()
    '                                Dim arr() As String
    '                                If dtfld1.Rows(l).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                    'Dim cb As New DropDownList
    '                                    ' cb.ID = "fld" & FldID & row.RowIndex
    '                                    ddl.Items.Add("Select")
    '                                    ddl.Items(0).Value = "0"

    '                                    Dim ARR1() As String = dtfld1.Rows(l).Item("dropdown").ToString().Split(",")
    '                                    For K As Integer = 0 To ARR1.Length - 1
    '                                        ddl.Items.Add(ARR1(K).ToString)
    '                                    Next

    '                                    If ViewState("chkadd") = 1 Then
    '                                        l = l + 1
    '                                    End If

    '                                    If ddl.Items.FindByText(row.Cells(l).Text) IsNot Nothing Then
    '                                        ddl.Items.FindByText(row.Cells(l).Text).Selected = True
    '                                    End If

    '                                    row.Cells(l).Controls.Add(ddl)
    '                                    'Prashant_10_7
    '                                    If dtfld1.Rows(l).Item("iseditable") = 1 Then
    '                                        ddl.Enabled = True
    '                                    Else
    '                                        ddl.Enabled = False
    '                                    End If


    '                                ElseIf dtfld1.Rows(l).Item("dropdowntype").ToString() = "MASTER VALUED" Then
    '                                    '' code for getting master valued 
    '                                    Dim ob As New DynamicForm
    '                                    arr = ddlText.Split("-")
    '                                    Dim TID As String = "TID"
    '                                    Dim TABLENAME As String = ""
    '                                    If UCase(arr(0).ToString()) = "MASTER" Then
    '                                        TABLENAME = "MMM_MST_MASTER"
    '                                    ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                        TABLENAME = "MMM_MST_DOC"
    '                                    ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                        TABLENAME = "MMM_MST_DOC_ITEM"
    '                                    ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                        If arr(1).ToString.ToUpper = "USER" Then
    '                                            TABLENAME = "MMM_MST_USER"
    '                                            TID = "UID"
    '                                        ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                            TABLENAME = "MMM_MST_LOCATION"
    '                                            TID = "LOCID"
    '                                        End If
    '                                    End If


    '                                    Dim lookUpqry As String = ""
    '                                    Dim str As String = ""
    '                                    If arr(0).ToUpper() = "CHILD" Then
    '                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                    ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                    Else
    '                                        If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                            str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M "
    '                                        Else
    '                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                        End If
    '                                    End If

    '                                    Dim xwhr As String = ""
    '                                    Dim tids As String = ""
    '                                    'Dim tidarr() As String

    '                                    ''FILTER THE DATA ACCORDING TO USER 
    '                                    tids = ob.UserDataFilter(dtfld1.Rows(l).Item("documenttype").ToString(), arr(1).ToString())

    '                                    If tids.Length >= 2 Then
    '                                        'tidarr = tids.Split("-")
    '                                        xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                    ElseIf tids = "0" Then
    '                                        pnlFields.Visible = False
    '                                        btnActEdit.Visible = False
    '                                        UpdatePanel1.Update()
    '                                        xwhr = ""
    '                                    End If
    '                                    str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                    Dim AutoFilter As String = dtfld1.Rows(l).Item("AutoFilter").ToString()
    '                                    If AutoFilter.Length > 0 Then
    '                                        If arr(0).ToUpper() = "CHILD" Then
    '                                            If AutoFilter.ToUpper = "DOCID" Then
    '                                                str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
    '                                            Else
    '                                                str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
    '                                            End If
    '                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                            str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                        Else
    '                                            str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & Session("EID") & " "
    '                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                        End If
    '                                    End If

    '                                    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                    Dim con As SqlConnection = New SqlConnection(conStr)
    '                                    Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                    Dim dss As New DataSet

    '                                    If str.Length > 0 Then
    '                                        oda.SelectCommand.CommandText = str
    '                                        oda.Fill(dss, "FV")
    '                                        Dim isAddJquery As Integer = 0
    '                                        ddl.Items.Add("Select")
    '                                        ddl.Items(0).Value = "0"
    '                                        For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                            ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
    '                                            Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
    '                                            ddl.Items(J1 + 1).Value = lookddlVal
    '                                        Next
    '                                        oda.Dispose()
    '                                        dss.Dispose()
    '                                        'prashant_2_7

    '                                        Dim lookupvalue As String = dtfld1.Rows(l).Item("lookupvalue").ToString()
    '                                        Dim multilookup As String = dtfld1.Rows(l).Item("multilookUpVal").ToString()
    '                                        Dim ddlmultilookup As String = dtfld1.Rows(l).Item("ddlmultilookUpVal").ToString()

    '                                        If lookupvalue.Length > 0 Or multilookup.Length > 0 Or ddlmultilookup.Length > 0 Then
    '                                            ddl.AutoPostBack = True
    '                                            AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged

    '                                        End If

    '                                        If ddl.Items.FindByText(row.Cells(l).Text) IsNot Nothing Then
    '                                            ddl.Items.FindByText(row.Cells(l).Text).Selected = True
    '                                        End If
    '                                        If ViewState("chkadd") = 1 Then
    '                                            l = l + 1
    '                                        End If

    '                                        If ddl.Items.FindByText(row.Cells(l).Text) IsNot Nothing Then
    '                                            ddl.Items.FindByText(row.Cells(l).Text).Selected = True
    '                                        End If

    '                                        row.Cells(l).Controls.Add(ddl)

    '                                        If isAddJquery = 1 Then
    '                                            Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
    '                                        End If
    '                                    End If
    '                                    con.Dispose()
    '                                    oda.Dispose()
    '                                    dss.Dispose()
    '                                    '' ends here for getting master valued 
    '                                End If

    '                            ElseIf ftype1.ToUpper() = "CHECKBOX LIST" Then
    '                                Dim CHKlIST As New CheckBoxList()
    '                                Dim dynmdiv As System.Web.UI.HtmlControls.HtmlGenericControl = New System.Web.UI.HtmlControls.HtmlGenericControl("DIV")
    '                                dynmdiv.ID = "div_" & FldID1
    '                                Dim ddlText As String = dtfld1.Rows(l).Item("dropdown").ToString()
    '                                CHKlIST.ID = "fld" & FldID1 & "_" & row.RowIndex
    '                                If dtfld1.Rows(l).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                    Dim arr = ddlText.Split(",")
    '                                    For ii As Integer = 0 To arr.Count - 1
    '                                        CHKlIST.Items.Add(arr(ii).ToUpper())
    '                                    Next

    '                                ElseIf dtfld1.Rows(l).Item("dropdowntype").ToString() = "MASTER VALUED" Then
    '                                    Dim arr = ddlText.Split("-")
    '                                    Dim TID As String = "TID"
    '                                    Dim TABLENAME As String = ""
    '                                    If UCase(arr(0).ToString()) = "MASTER" Then
    '                                        TABLENAME = "MMM_MST_MASTER"
    '                                    ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                        TABLENAME = "MMM_MST_DOC"
    '                                    ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                        TABLENAME = "MMM_MST_DOC_ITEM"
    '                                    ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                        If arr(1).ToString.ToUpper = "USER" Then
    '                                            TABLENAME = "MMM_MST_USER"
    '                                            TID = "UID"
    '                                        ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                            TABLENAME = "MMM_MST_LOCATION"
    '                                            TID = "LOCID"
    '                                        End If
    '                                    End If
    '                                    Dim lookUpqry As String = ""
    '                                    Dim str As String = ""
    '                                    If arr(0).ToUpper() = "CHILD" Then
    '                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                    ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                    Else
    '                                        If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                            str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M "
    '                                        Else
    '                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                        End If
    '                                    End If
    '                                    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                    Dim con As SqlConnection = New SqlConnection(conStr)
    '                                    Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                    oda = New SqlDataAdapter("", con)
    '                                    Dim dss As New DataSet
    '                                    oda.SelectCommand.CommandText = str
    '                                    oda.Fill(dss, "FV")
    '                                    For JJ As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                        CHKlIST.Items.Add(dss.Tables("FV").Rows(JJ).Item(0))
    '                                        CHKlIST.Items(JJ).Value = dss.Tables("FV").Rows(JJ).Item(1)
    '                                    Next
    '                                    oda.Dispose()
    '                                    dss.Dispose()
    '                                End If

    '                                dynmdiv.Style.Add(HtmlTextWriterStyle.Width, "200px")
    '                                dynmdiv.Style.Add(HtmlTextWriterStyle.Height, "100px")
    '                                dynmdiv.Style.Add(HtmlTextWriterStyle.Overflow, "Scroll")
    '                                dynmdiv.Controls.Add(CHKlIST)
    '                                row.Cells(l).Controls.Add(dynmdiv)



    '                            ElseIf ftype1.ToUpper = "LOOKUPDDL" Then

    '                                ' DataType = dtfld1.Rows(j).Item("datatype").ToString().ToUpper()
    '                                Dim fieldtypee As String = dtfld1.Rows(l).Item("FieldType").ToString().ToUpper()
    '                                Dim ddl As New DropDownList
    '                                ddl.ID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & "_" & row.RowIndex
    '                                ddl.Width = controlWdth - 10
    '                                ddl.CssClass = "txtBox"
    '                                Dim ddlText As String = dtfld1.Rows(l).Item("dropdown").ToString()
    '                                Dim dropdowntype As String = dtfld1.Rows(l).Item("dropdowntype").ToString()
    '                                Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                Dim con As SqlConnection = New SqlConnection(conStr)
    '                                Dim od As SqlDataAdapter = New SqlDataAdapter("select dropdown,DDllookupvalue from MMM_MST_FIELDS where FieldID='" & ddlText & "'", con)
    '                                ' Dim dsMonth As New DataSet
    '                                Dim dt As New DataTable
    '                                od.Fill(dt)
    '                                Dim arr() As String
    '                                Dim darr() As String
    '                                Dim type As String = dt.Rows(0).Item("dropdown").ToString()
    '                                arr = type.Split("-")
    '                                Dim documenttype As String = arr(1).ToString()
    '                                Dim field As String = dt.Rows(0).Item("DDllookupvalue").ToString()
    '                                field = field.Substring(0, field.Length - 1)
    '                                darr = field.Split(",")
    '                                For k As Integer = 0 To darr.Count - 1
    '                                    Dim fieldmping As String
    '                                    Dim str As String = ""
    '                                    Dim feild As String
    '                                    Dim s = darr(k).Split("-")
    '                                    feild = s(0).ToString()
    '                                    fieldmping = s(1).ToString()

    '                                    Dim TID As String = "TID"
    '                                    Dim TABLENAME As String = ""
    '                                    Dim str1 As String = ""
    '                                    Dim lookUpqry As String = ""

    '                                    Dim xwhr As String = ""
    '                                    Dim tids As String = ""
    '                                    Dim Rtids As String = ""   ' for prerole data filter

    '                                    If feild = dtfld1.Rows(l).Item("FieldID").ToString() Then
    '                                        'If arr(0) = "SESSION" And Not (fieldmping.Contains("fld")) Then
    '                                        '    If arr(1).ToString.ToUpper = "USER" Then
    '                                        '        TABLENAME = "MMM_MST_USER"
    '                                        '        TID = "UID"
    '                                        '    End If
    '                                        '    ' str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                        '    str1 = "select " & fieldmping.ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                        'Else
    '                                        od.SelectCommand.CommandText = "select dropdown from MMM_MST_FIELDS where EID=" & HttpContext.Current.Session("EID") & " and documenttype='" & documenttype & "' and FieldMapping in('" & fieldmping & "')"
    '                                        Dim dt1 As New DataTable
    '                                        od.Fill(dt1)
    '                                        Dim dropdown As String = dt1.Rows(0).Item("dropdown").ToString()
    '                                        arr = dropdown.Split("-")

    '                                        If UCase(arr(0).ToString()) = "MASTER" Then
    '                                            TABLENAME = "MMM_MST_MASTER"
    '                                        ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                            TABLENAME = "MMM_MST_DOC"
    '                                        ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                            TABLENAME = "MMM_MST_DOC_ITEM"
    '                                        ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                            If arr(1).ToString.ToUpper = "USER" Then
    '                                                TABLENAME = "MMM_MST_USER"
    '                                                TID = "UID"
    '                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                TABLENAME = "MMM_MST_LOCATION"
    '                                                TID = "LOCID"
    '                                            End If
    '                                        ElseIf UCase(arr(0).ToString) = "SESSION" Then
    '                                            If arr(1).ToString.ToUpper = "USER" Then
    '                                                TABLENAME = "MMM_MST_USER"
    '                                                TID = "UID"
    '                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                TABLENAME = "MMM_MST_LOCATION"
    '                                                TID = "LOCID"
    '                                            End If
    '                                        End If

    '                                        If arr(0).ToUpper() = "CHILD" Then
    '                                            str1 = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                        ElseIf arr(0).ToUpper() = "SESSION" Then
    '                                            str1 = "Select " & IIf(arr(1).ToString.ToUpper = "USER", "UserName, ", "LocationName, ") & TID & " from " & TABLENAME & " M where EID=" & HttpContext.Current.Session("EID") & " AND " & arr(2) & "='" & HttpContext.Current.Session(arr(2)) & "'"
    '                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                            str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                        Else
    '                                            If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                                str1 = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M "
    '                                            Else
    '                                                str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                            End If
    '                                        End If
    '                                        '  End If

    '                                        'Dim tidarr() As String

    '                                        ''FILTER THE DATA ACCORDING TO USER 
    '                                        Dim ob = New DynamicForm()
    '                                        tids = ob.UserDataFilter(dtfld1.Rows(l).Item("documenttype").ToString(), arr(1).ToString())
    '                                        Rtids = ob.UserDataFilter_PreRole(arr(1).ToString(), TABLENAME)  '' new by sunil for pre role data filter 22-feb

    '                                        '' for multiuse of document by sp on 08_apr_15
    '                                        Dim Sdtype As String = arr(1).ToString
    '                                        Dim da As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                        da.SelectCommand.CommandType = CommandType.Text
    '                                        da.SelectCommand.CommandText = "select isnull(Allowmultiuse,0) from mmm_mst_forms where eid='" & HttpContext.Current.Session("EID").ToString & "' AND FORMNAME='" & Sdtype & "'"
    '                                        If con.State <> ConnectionState.Open Then
    '                                            con.Open()
    '                                        End If
    '                                        Dim isMultiUse As Integer = Convert.ToInt32(da.SelectCommand.ExecuteScalar())

    '                                        Dim CurrDoctype As String = dtfld1.Rows(l).Item("documenttype").ToString()
    '                                        Dim CurrFieldMapping As String = dtfld1.Rows(l).Item("fieldmapping").ToString()

    '                                        Dim qry As String = ""
    '                                        Dim MTids As String = ""
    '                                        If UCase(arr(0).ToString()) <> "CHILD" And UCase(arr(0).ToString) <> "STATIC" And UCase(arr(0).ToString) <> "SESSION" Then
    '                                            da.SelectCommand.CommandType = CommandType.Text
    '                                            da.SelectCommand.CommandText = "SELECT SUBSTRING((SELECT ',' + CONVERT(NVARCHAR," & CurrFieldMapping & ")  FROM " & TABLENAME & " where EID=" & HttpContext.Current.Session("eid") & " and documenttype='" & CurrDoctype & "'" & " FOR XML PATH('')),2,1000) AS CSV"
    '                                            MTids = Convert.ToString(da.SelectCommand.ExecuteScalar())
    '                                        End If
    '                                        ''ends  for multiuse of document by sp on 08_apr_15


    '                                        If tids.Length >= 2 Then
    '                                            xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                        ElseIf tids = "0" Then
    '                                            pnlFields.Visible = False
    '                                            btnActEdit.Visible = False
    '                                            UpdatePanel1.Update()
    '                                            xwhr = ""
    '                                        End If
    '                                        '' new by sunil for pre role data filter 22-feb
    '                                        If Rtids <> "" Then
    '                                            If xwhr.ToString = "" Then
    '                                                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & Rtids & ")"
    '                                            Else
    '                                                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & "," & Rtids & ")"
    '                                            End If
    '                                        End If

    '                                        '' new by sunil for multiuse of docs
    '                                        If MTids.Length > 2 And isMultiUse = 1 Then
    '                                            If Right(MTids, 1) = "," Then
    '                                                MTids = Left(MTids, Len(MTids) - 1)
    '                                            End If
    '                                            xwhr = xwhr & " AND CONVERT(NVARCHAR(10),TID) not IN (" & MTids & ") "
    '                                        End If
    '                                        '' new by sunil for multiuse of docs

    '                                        str1 = str1 & "  AND M.isauth>0 " & xwhr & " order by " & arr(2).ToString()
    '                                        'Dim documenttype2 As String = arr1(1).ToString()
    '                                        'Dim fieldmping2 As String = arr1(2).ToString()
    '                                        'pnlFields.Controls.Add(ddl)
    '                                        Dim dt2 As New DataTable
    '                                        'oda.SelectCommand.CommandText = "select " & fieldmping2 & " from " & TABLENAME & " where EID=" & HttpContext.Current.Session("EID") & " and documenttype = '" & documenttype2 & "'"

    '                                        If str1.Length > 0 Then
    '                                            pnlFields.Controls.Add(ddl)
    '                                            od.SelectCommand.CommandText = str1
    '                                            od.Fill(dt2)
    '                                            Dim isAddJquery As Integer = 0
    '                                            ddl.Items.Add("Select")
    '                                            ddl.Items(0).Value = "0"
    '                                            For JK As Integer = 0 To dt2.Rows.Count - 1
    '                                                ddl.Items.Add(dt2.Rows(JK).Item(0).ToString())
    '                                                Dim lookddlVal As String = dt2.Rows(JK).Item(1).ToString()
    '                                                ddl.Items(JK + 1).Value = lookddlVal
    '                                            Next
    '                                            dt2.Dispose()
    '                                        End If
    '                                        If dtfld1.Rows(l).Item("isEditable").ToString() = "1" Then
    '                                            ddl.Enabled = True
    '                                        Else
    '                                            ddl.Enabled = False
    '                                        End If
    '                                    End If
    '                                Next

    '                                row.Cells(l).Controls.Add(ddl)

    '                            ElseIf ftype1.ToUpper() = "FILE UPLOADER" Then
    '                                Dim txtBox As New FileUpload

    '                                'Prashant 30-6-2014
    '                                Dim txtBox1 As New HiddenField

    '                                Dim lbl1 As New Label
    '                                lbl1.ID = "lblf_" & FldID1
    '                                lbl1.Text = ""
    '                                lbl1.ClientIDMode = ClientIDMode.Static

    '                                txtBox1.ID = "hdn_" & FldID1
    '                                txtBox1.Value = ""
    '                                txtBox1.ClientIDMode = ClientIDMode.Static
    '                                If Not Request.QueryString("TID") Is Nothing Then
    '                                    txtBox.Attributes.Add("onchange", "UtilJs.UploadFile1(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
    '                                Else
    '                                    txtBox.Attributes.Add("onchange", "UtilJs.UploadFile(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
    '                                End If

    '                                txtBox.ID = "fld_" & FldID1 & "_" & row.RowIndex  ' added  id  with _ by balli
    '                                txtBox.CssClass = "txtBox"

    '                                txtBox.Width = 180


    '                                Dim hdnflag As New HiddenField
    '                                If Not Request.QueryString("TID") Is Nothing Then
    '                                    hdnflag.ID = "hdnf_" & FldID1
    '                                    hdnflag.Value = "0"
    '                                    Dim str As String = row.Cells(l).Text

    '                                    str = After(str, "/")

    '                                    txtBox1.Value = str 'row.Cells(j).Text
    '                                    lbl1.Text = str ' row.Cells(j).Text
    '                                    row.Cells(l).Text = str
    '                                End If
    '                                If ViewState("chkadd") = 1 Then
    '                                    l = l + 1
    '                                End If
    '                                row.Cells(l).Controls.Add(txtBox)
    '                                'Prashant 30-6-2014
    '                                row.Cells(l).Controls.Add(txtBox1)
    '                                row.Cells(l).Controls.Add(lbl1)
    '                                row.Cells(l).Controls.Add(hdnflag)

    '                                Dim pstback As New PostBackTrigger
    '                                pstback.ControlID = btnActEdit.ID
    '                                UpdatePanel1.Triggers.Add(pstback)

    '                            End If
    '                            If ViewState("chkadd") = 1 Then
    '                                l = l - 1    ' added for incremental 
    '                            End If
    '                        Next
    '                    Else

    '                        Dim filterRows() As DataRow
    '                        filterRows = dtfld1.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''", "InLineEditing,DisplayOrder")
    '                        dtfld1 = filterRows.CopyToDataTable()

    '                        Dim filterRows1() As DataRow
    '                        Dim filterRows2() As DataRow
    '                        filterRows1 = dtfld1.Select("inlinemapping is not null and inlinemapping <>''", "DisplayOrder")
    '                        filterRows2 = dtfld1.Select("InLineEditing=1 and inlinemapping is null", "DisplayOrder")
    '                        If filterRows1.Length > 0 Then
    '                            dtfld1 = filterRows1.CopyToDataTable()
    '                            dtfld1.Merge(filterRows2.CopyToDataTable())
    '                        Else
    '                            dtfld1 = filterRows2.CopyToDataTable()
    '                        End If

    '                        For j As Integer = 0 To filterRows.Count - 1

    '                            Dim ftype As String = dtfld1.Rows(j).Item("fieldtype").ToString()

    '                            Dim datatype As String = dtfld1(j).Item("datatype").ToString() 'Prashant_10_7

    '                            Dim colValue As String = row.DataItem(j).ToString()
    '                            Dim ilEdit As Integer = dtfld1.Rows(j).Item("inlineEditing").ToString()
    '                            Dim FldID As String = dtfld1.Rows(j).Item("fieldid").ToString()
    '                            Dim Formula = Convert.ToString(dtfld1.Rows(j).Item("cal_text"))
    '                            Dim DisplayName = Convert.ToString(dtfld1.Rows(j).Item("DisplayName"))
    '                            If ilEdit = 1 Then
    '                                If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Or ftype.ToUpper() = "PARENT VALUE" Then
    '                                    Dim cb As New TextBox
    '                                    'cb.ID = "fld" & j.ToString() & "_" & row.RowIndex
    '                                    cb.Width = 55
    '                                    cb.ID = "fld" & FldID & row.RowIndex

    '                                    'Prashant_10_7
    '                                    If dtfld1.Rows(j).Item("defaultfieldval").ToString().Length > 0 Then
    '                                        cb.Text = dtfld1.Rows(j).Item("defaultfieldval").ToString()
    '                                    Else
    '                                        If datatype.ToUpper() = "NUMERIC" Then
    '                                            cb.Text = "0"
    '                                        End If
    '                                    End If
    '                                    If Val(dtfld1.Rows(j).Item("isDescription").ToString()) = 1 Then
    '                                        cb.ToolTip = dtfld1.Rows(j).Item("Description").ToString()
    '                                    End If
    '                                    If dtfld1.Rows(j).Item("iseditable") = 0 Then
    '                                        cb.Attributes.Add("READONLY", "READONLY")
    '                                        cb.Attributes.Add("COLOR", "GRAY")
    '                                    End If
    '                                    If ftype.ToUpper() = "CALCULATIVE FIELD" Then
    '                                        colValue = "0"
    '                                        cb.Attributes.Add("READONLY", "READONLY")
    '                                        cb.Attributes.Add("COLOR", "GRAY")
    '                                    End If
    '                                    If ViewState("chkadd") = 1 Then
    '                                        j = j + 1
    '                                    End If
    '                                    colValue = row.DataItem(j).ToString()
    '                                    If ftype.ToUpper() = "LOOKUP" Then
    '                                        If datatype.ToUpper() = "NUMERIC" Then
    '                                            colValue = "0"
    '                                        End If
    '                                    Else
    '                                        If Val(colValue) = 0 Then
    '                                            If ftype.ToUpper() = "TEXT BOX" And datatype.ToUpper() = "NUMERIC" Then
    '                                                colValue = "0"
    '                                            End If
    '                                        End If
    '                                    End If

    '                                    If Not row.Cells(j).Text.Trim = "&nbsp;" And Not row.Cells(j).Text.Trim = "" Then
    '                                        colValue = row.Cells(j).Text.Trim
    '                                    End If

    '                                    cb.Text = colValue
    '                                    cb.Width = controlWdth
    '                                    row.Cells(j).Controls.Add(cb)

    '                                    If datatype.ToUpper.Trim = "DATETIME" Then
    '                                        Dim CLNDR As New AjaxControlToolkit.CalendarExtender
    '                                        CLNDR.Controls.Clear()
    '                                        CLNDR.ID = "CLNDR" & dtfld1.Rows(j).Item("FieldID").ToString()
    '                                        CLNDR.Format = "dd/MM/yy"
    '                                        CLNDR.TargetControlID = cb.ID
    '                                        cb.Enabled = True
    '                                        If Request.QueryString("TID") Is Nothing Then
    '                                            cb.Text = String.Format("{0:dd/MM/yy}", Date.Now())
    '                                        End If
    '                                        row.Cells(j).Controls.Add(CLNDR) '
    '                                    End If


    '                                    'Code For calculative field
    '                                    'Code End Here !!!!!!
    '                                    'If ftype = "Calculative Field" Then
    '                                    '    cb.Attributes.Add("READONLY", "READONLY")
    '                                    '    cb.Attributes.Add("COLOR", "GRAY")
    '                                    '    ' cb.ReadOnly = True
    '                                    'End If


    '                                    If Not Formula Is Nothing And Formula <> "" Then
    '                                        'Dim arrFor As String() = Formula.Split(",")
    '                                        Dim jScript = GenerateJQueryScript(dtfld1, GID, row.RowIndex, Formula, FldID)
    '                                        If jScript <> "" Then
    '                                            cb.Attributes.Add("onblur", jScript)
    '                                        End If
    '                                    End If


    '                                ElseIf ftype.ToUpper() = "AUTOCOMPLETE" Then

    '                                    Dim txtbox As New TextBox
    '                                    txtbox.ID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
    '                                    txtbox.Width = controlWdth - 10
    '                                    txtbox.CssClass = "txtBox"
    '                                    txtbox.Attributes.Add("placeholder", "Please begin typing a " & DisplayName)
    '                                    txtbox.AutoPostBack = True
    '                                    AddHandler txtbox.TextChanged, AddressOf txtbox_TextChanged
    '                                    ' adding handler for binding lookup or other dropdown or filter

    '                                    Dim autofilExtender As New AjaxControlToolkit.AutoCompleteExtender
    '                                    autofilExtender.ID = "extenderID" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex

    '                                    autofilExtender.TargetControlID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
    '                                    autofilExtender.ServiceMethod = "GetCompletionList" ' THIS SERVICE METHOD IS WRITTEN ON DOCUMENT PAGE 
    '                                    autofilExtender.DelimiterCharacters = ""
    '                                    autofilExtender.ContextKey = dtfld1.Rows(j).Item("DROPDOWN").ToString() & "-" & dtfld1.Rows(j).Item("FieldID").ToString() & "-" & dtfld1.Rows(j).Item("DROPDOWNTYPE").ToString() & "-" & dtfld1.Rows(j).Item("AUTOFILTER").ToString() & "-" & dtfld1.Rows(j).Item("inlinefilter").ToString()
    '                                    'context key contain  : dropdown-fieldid-dropdowntype-autofilter-InitialFilter' adding the fieldid in context key because later on we need id of field in web method 
    '                                    autofilExtender.Enabled = True
    '                                    autofilExtender.CompletionSetCount = 5
    '                                    autofilExtender.OnClientShown = "onDataShown"  ' by sunil
    '                                    '   autofilExtender.CompletionListElementID = "ACsugestlist"
    '                                    autofilExtender.MinimumPrefixLength = 1  ' start searching when entered one characters
    '                                    'autofilExtender.OnClientItemSelected = "ace_itemSelected('" & ds.Rows(i).Item("FieldID").ToString() & "')"
    '                                    autofilExtender.OnClientItemSelected = "ace_itemSelected"
    '                                    row.Cells(j).Controls.Add(txtbox)
    '                                    'pnlFields.Controls.Add(txtbox)

    '                                    Dim hdnfld As New HiddenField
    '                                    hdnfld.ID = "HDN" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
    '                                    row.Cells(j).Controls.Add(hdnfld)
    '                                    'pnlFields.Controls.Add(img)
    '                                    'pnlFields.Controls.Add(prgBar)
    '                                    row.Cells(j).Controls.Add(autofilExtender)
    '                                    'pnlFields.Controls.Add(autofilExtender)

    '                                ElseIf ftype.ToUpper() = "FORMULA FIELD" Then
    '                                    Dim txtBox As New TextBox
    '                                    txtBox.ID = "fld" & FldID & row.RowIndex
    '                                    txtBox.Width = controlWdth - 10
    '                                    txtBox.CssClass = "txtBox"
    '                                    If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                        txtBox.Enabled = True
    '                                    Else
    '                                        txtBox.Enabled = False
    '                                    End If

    '                                    If ViewState("chkadd") = 1 Then
    '                                        j = j + 1
    '                                    End If
    '                                    If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
    '                                        txtBox.Text = row.Cells(j).Text
    '                                    Else
    '                                        txtBox.Text = "0"
    '                                    End If

    '                                    row.Cells(j).Controls.Add(txtBox)

    '                                ElseIf ftype.ToUpper() = "TEXT AREA" Then
    '                                    Dim txtBox As New TextBox
    '                                    txtBox.ID = "fld" & FldID & row.RowIndex
    '                                    txtBox.Width = controlWdth + 50
    '                                    txtBox.Height = 50
    '                                    txtBox.TextMode = TextBoxMode.MultiLine
    '                                    txtBox.Columns = 4
    '                                    txtBox.Rows = 10
    '                                    txtBox.CssClass = "txtBox"
    '                                    If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                        txtBox.Enabled = True
    '                                    Else
    '                                        txtBox.Enabled = False
    '                                    End If

    '                                    If ViewState("chkadd") = 1 Then
    '                                        j = j + 1
    '                                    End If
    '                                    If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
    '                                        txtBox.Text = row.Cells(j).Text
    '                                    End If

    '                                    row.Cells(j).Controls.Add(txtBox)


    '                                ElseIf ftype.ToUpper() = "MULTI LOOKUP" Then
    '                                    Dim txtBox As New TextBox
    '                                    txtBox.ID = "fld" & FldID & row.RowIndex
    '                                    txtBox.Width = controlWdth - 10
    '                                    txtBox.CssClass = "txtBox"
    '                                    If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                        txtBox.Enabled = True
    '                                    Else
    '                                        txtBox.Enabled = False
    '                                    End If
    '                                    If ViewState("chkadd") = 1 Then
    '                                        j = j + 1
    '                                    End If
    '                                    If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
    '                                        txtBox.Text = row.Cells(j).Text
    '                                    End If
    '                                    row.Cells(j).Controls.Add(txtBox)

    '                                ElseIf ftype.ToUpper() = "MULTI LOOKUPDDL" Then

    '                                    Dim ddl As New DropDownList
    '                                    ddl.ID = "fld" & FldID & "_" & row.RowIndex
    '                                    ddl.CssClass = "txtBox"
    '                                    ddl.Width = 150

    '                                    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                    Dim con As SqlConnection = New SqlConnection(conStr)
    '                                    Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
    '                                    Dim od As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                    Dim dt As New DataTable
    '                                    Dim dtval As New DataTable
    '                                    Dim fieldid As String()
    '                                    Dim ddlval As String()
    '                                    If (ddlText.ToString() <> String.Empty) Then
    '                                        fieldid = ddlText.ToString().Split(",")
    '                                        od.SelectCommand.CommandText = "select ddlMultilookupval from mmm_mst_fields where fieldid = " & fieldid(0).ToString() & ""
    '                                        od.Fill(dtval)
    '                                        If (dtval.Rows.Count > 0) Then
    '                                            ddlval = dtval.Rows(0)("ddlMultilookupval").ToString().Split(",")
    '                                            For q As Integer = 0 To ddlval.Length - 1
    '                                                If (ddlval(q).ToString().Contains("-" & dtfld1.Rows(j).Item("FieldID").ToString())) Then
    '                                                    Dim temp() As String = ddlval(q).ToString().Split("-")
    '                                                    od.SelectCommand.CommandText = "select * from MMM_MST_FIELDS where DOCUMENTTYPE='" & temp(0).ToString() & "' and eid=" & HttpContext.Current.Session("EID") & " and fieldmapping in('" & temp(1).ToString() & "')"
    '                                                    Dim checkval As New DataTable
    '                                                    od.Fill(checkval)
    '                                                    Dim ddlText1 As String = checkval.Rows(0).Item("dropdown").ToString()
    '                                                    Dim dropdowntype As String = checkval.Rows(0).Item("dropdowntype").ToString()
    '                                                    Dim arr() As String
    '                                                    If UCase(dropdowntype) = "MASTER VALUED" Then
    '                                                        Dim ob As New DynamicForm
    '                                                        arr = ddlText1.Split("-")
    '                                                        Dim TID As String = "TID"
    '                                                        Dim TABLENAME As String = ""
    '                                                        If UCase(arr(0).ToString()) = "MASTER" Then
    '                                                            TABLENAME = "MMM_MST_MASTER"
    '                                                        ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                                            TABLENAME = "MMM_MST_DOC"
    '                                                        ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                                            TABLENAME = "MMM_MST_DOC_ITEM"
    '                                                        ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                                            If arr(1).ToString.ToUpper = "USER" Then
    '                                                                TABLENAME = "MMM_MST_USER"
    '                                                                TID = "UID"
    '                                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                                TABLENAME = "MMM_MST_LOCATION"
    '                                                                TID = "LOCID"
    '                                                            End If
    '                                                        End If
    '                                                        Dim lookUpqry As String = ""
    '                                                        Dim str As String = ""
    '                                                        If arr(0).ToUpper() = "CHILD" Then
    '                                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                        Else
    '                                                            If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                                                str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M "
    '                                                            Else
    '                                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                                            End If
    '                                                        End If

    '                                                        Dim xwhr As String = ""
    '                                                        Dim tids As String = ""
    '                                                        'Dim tidarr() As String

    '                                                        ''FILTER THE DATA ACCORDING TO USER 
    '                                                        tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())

    '                                                        If tids.Length >= 2 Then
    '                                                            'tidarr = tids.Split("-")
    '                                                            xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                                        ElseIf tids = "0" Then
    '                                                            pnlFields.Visible = False
    '                                                            btnActEdit.Visible = False
    '                                                            UpdatePanel1.Update()
    '                                                            xwhr = ""
    '                                                        End If
    '                                                        str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                        Dim AutoFilter As String = dtfld1.Rows(j).Item("AutoFilter").ToString()
    '                                                        If AutoFilter.Length > 0 Then
    '                                                            If arr(0).ToUpper() = "CHILD" Then
    '                                                                If AutoFilter.ToUpper = "DOCID" Then
    '                                                                    str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
    '                                                                Else
    '                                                                    str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
    '                                                                End If
    '                                                            ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                                                str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                                str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                            Else
    '                                                                str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & Session("EID") & " "
    '                                                                str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                            End If
    '                                                        End If


    '                                                        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                                        Dim dss As New DataSet
    '                                                        If str.Length > 0 Then
    '                                                            oda.SelectCommand.CommandText = str
    '                                                            oda.Fill(dss, "FV")
    '                                                            Dim isAddJquery As Integer = 0
    '                                                            ddl.Items.Add("Select")
    '                                                            ddl.Items(0).Value = "0"
    '                                                            For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                                                ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
    '                                                                Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
    '                                                                ddl.Items(J1 + 1).Value = lookddlVal
    '                                                            Next
    '                                                            oda.Dispose()
    '                                                            dss.Dispose()
    '                                                            'prashant_2_7

    '                                                            Dim lookupvalue As String = dtfld1.Rows(j).Item("lookupvalue").ToString()
    '                                                            Dim multilookup As String = dtfld1.Rows(j).Item("multilookUpVal").ToString()
    '                                                            Dim ddlmultilookup As String = dtfld1.Rows(j).Item("ddlmultilookUpVal").ToString()

    '                                                            If lookupvalue.Length > 0 Or multilookup.Length > 0 Or ddlmultilookup.Length > 0 Then
    '                                                                ddl.AutoPostBack = True
    '                                                                AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged
    '                                                            End If

    '                                                            If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                                                ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                                            End If
    '                                                            If ViewState("chkadd") = 1 Then
    '                                                                j = j + 1
    '                                                            End If

    '                                                            If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                                                'ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                                                ddl.SelectedValue = ddl.Items.FindByText(row.Cells(j).Text).Value
    '                                                            End If

    '                                                            row.Cells(j).Controls.Add(ddl)

    '                                                            If isAddJquery = 1 Then
    '                                                                Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
    '                                                            End If
    '                                                        End If
    '                                                        con.Dispose()
    '                                                        oda.Dispose()
    '                                                        dss.Dispose()
    '                                                    ElseIf UCase(dropdowntype) = "SESSION VALUED" Then

    '                                                    End If
    '                                                End If
    '                                            Next
    '                                        End If
    '                                    End If

    '                                ElseIf ftype.ToUpper() = "DROP DOWN" Then
    '                                    Dim ddl As New DropDownList

    '                                    ddl.ID = "fld" & FldID & "_" & row.RowIndex
    '                                    ddl.CssClass = "txtBox"
    '                                    ddl.Width = 150
    '                                    Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
    '                                    Dim dropdowntype As String = dtfld1.Rows(j).Item("dropdowntype").ToString()
    '                                    Dim arr() As String
    '                                    If dtfld1.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                        'Dim cb As New DropDownList
    '                                        ' cb.ID = "fld" & FldID & row.RowIndex
    '                                        ddl.Items.Add("Select")
    '                                        ddl.Items(0).Value = "0"

    '                                        Dim ARR1() As String = dtfld1.Rows(j).Item("dropdown").ToString().Split(",")
    '                                        For K As Integer = 0 To ARR1.Length - 1
    '                                            ddl.Items.Add(ARR1(K).ToString)
    '                                        Next
    '                                        If ViewState("chkadd") = 1 Then
    '                                            j = j + 1
    '                                        End If

    '                                        If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                            ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                        End If

    '                                        row.Cells(j).Controls.Add(ddl)
    '                                        'Prashant_10_7
    '                                        If dtfld1.Rows(j).Item("iseditable") = 1 Then
    '                                            ddl.Enabled = True
    '                                        Else
    '                                            ddl.Enabled = False
    '                                        End If

    '                                    ElseIf dtfld1.Rows(j).Item("dropdowntype").ToString() = "MASTER VALUED" Then
    '                                        '' code for getting master valued 
    '                                        Dim ob As New DynamicForm
    '                                        arr = ddlText.Split("-")
    '                                        Dim TID As String = "TID"
    '                                        Dim TABLENAME As String = ""
    '                                        If UCase(arr(0).ToString()) = "MASTER" Then
    '                                            TABLENAME = "MMM_MST_MASTER"
    '                                        ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                            TABLENAME = "MMM_MST_DOC"
    '                                        ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                            TABLENAME = "MMM_MST_DOC_ITEM"
    '                                        ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                            If arr(1).ToString.ToUpper = "USER" Then
    '                                                TABLENAME = "MMM_MST_USER"
    '                                                TID = "UID"
    '                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                TABLENAME = "MMM_MST_LOCATION"
    '                                                TID = "LOCID"
    '                                            End If
    '                                        End If
    '                                        Dim lookUpqry As String = ""
    '                                        Dim str As String = ""
    '                                        If arr(0).ToUpper() = "CHILD" Then
    '                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                        Else
    '                                            If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                                str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M "
    '                                            Else
    '                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                            End If
    '                                        End If

    '                                        Dim xwhr As String = ""
    '                                        Dim tids As String = ""
    '                                        'Dim tidarr() As String

    '                                        ''FILTER THE DATA ACCORDING TO USER 
    '                                        tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())

    '                                        If tids.Length >= 2 Then
    '                                            'tidarr = tids.Split("-")
    '                                            xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                        ElseIf tids = "0" Then
    '                                            pnlFields.Visible = False
    '                                            btnActEdit.Visible = False
    '                                            UpdatePanel1.Update()
    '                                            xwhr = ""
    '                                        End If
    '                                        str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                        Dim AutoFilter As String = dtfld1.Rows(j).Item("AutoFilter").ToString()
    '                                        If AutoFilter.Length > 0 Then
    '                                            If arr(0).ToUpper() = "CHILD" Then
    '                                                If AutoFilter.ToUpper = "DOCID" Then
    '                                                    str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
    '                                                Else
    '                                                    str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
    '                                                End If
    '                                            ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                                str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                            Else
    '                                                str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & Session("EID") & " "
    '                                                str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                            End If
    '                                        End If

    '                                        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                        Dim con As SqlConnection = New SqlConnection(conStr)
    '                                        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                        Dim dss As New DataSet

    '                                        If str.Length > 0 Then
    '                                            oda.SelectCommand.CommandText = str
    '                                            oda.Fill(dss, "FV")
    '                                            Dim isAddJquery As Integer = 0
    '                                            ddl.Items.Add("Select")
    '                                            ddl.Items(0).Value = "0"
    '                                            For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                                ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
    '                                                Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
    '                                                ddl.Items(J1 + 1).Value = lookddlVal
    '                                            Next
    '                                            oda.Dispose()
    '                                            dss.Dispose()
    '                                            'prashant_2_7

    '                                            Dim lookupvalue As String = dtfld1.Rows(j).Item("lookupvalue").ToString()
    '                                            Dim multilookup As String = dtfld1.Rows(j).Item("multilookUpVal").ToString()
    '                                            Dim ddlmultilookup As String = dtfld1.Rows(j).Item("ddlmultilookUpVal").ToString()

    '                                            If lookupvalue.Length > 0 Or multilookup.Length > 0 Or ddlmultilookup.Length > 0 Then
    '                                                ddl.AutoPostBack = True
    '                                                AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged
    '                                            End If

    '                                            If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                                ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                            End If
    '                                            If ViewState("chkadd") = 1 Then
    '                                                j = j + 1
    '                                            End If

    '                                            If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                                ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                            End If

    '                                            row.Cells(j).Controls.Add(ddl)

    '                                            If isAddJquery = 1 Then
    '                                                Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
    '                                            End If
    '                                        End If
    '                                        con.Dispose()
    '                                        oda.Dispose()
    '                                        dss.Dispose()
    '                                        '' ends here for getting master valued 

    '                                    End If


    '                                ElseIf ftype.ToUpper() = "CHECKBOX LIST" Then
    '                                    Dim CHKlIST As New CheckBoxList()
    '                                    Dim dynmdiv As System.Web.UI.HtmlControls.HtmlGenericControl = New System.Web.UI.HtmlControls.HtmlGenericControl("DIV")
    '                                    dynmdiv.ID = "div_" & FldID
    '                                    Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
    '                                    CHKlIST.ID = "fld" & FldID & "_" & row.RowIndex
    '                                    If dtfld1.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                        Dim arr = ddlText.Split(",")
    '                                        For ii As Integer = 0 To arr.Count - 1
    '                                            CHKlIST.Items.Add(arr(ii).ToUpper())
    '                                        Next

    '                                    ElseIf dtfld1.Rows(j).Item("dropdowntype").ToString() = "MASTER VALUED" Then
    '                                        Dim arr = ddlText.Split("-")
    '                                        Dim TID As String = "TID"
    '                                        Dim TABLENAME As String = ""
    '                                        If UCase(arr(0).ToString()) = "MASTER" Then
    '                                            TABLENAME = "MMM_MST_MASTER"
    '                                        ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                            TABLENAME = "MMM_MST_DOC"
    '                                        ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                            TABLENAME = "MMM_MST_DOC_ITEM"
    '                                        ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                            If arr(1).ToString.ToUpper = "USER" Then
    '                                                TABLENAME = "MMM_MST_USER"
    '                                                TID = "UID"
    '                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                TABLENAME = "MMM_MST_LOCATION"
    '                                                TID = "LOCID"
    '                                            End If
    '                                        End If
    '                                        Dim lookUpqry As String = ""
    '                                        Dim str As String = ""
    '                                        If arr(0).ToUpper() = "CHILD" Then
    '                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                        Else
    '                                            If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                                str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M "
    '                                            Else
    '                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                            End If
    '                                        End If
    '                                        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                        Dim con As SqlConnection = New SqlConnection(conStr)
    '                                        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                        oda = New SqlDataAdapter("", con)
    '                                        Dim dss As New DataSet
    '                                        oda.SelectCommand.CommandText = str
    '                                        oda.Fill(dss, "FV")
    '                                        For JJ As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                            CHKlIST.Items.Add(dss.Tables("FV").Rows(JJ).Item(0))
    '                                            CHKlIST.Items(JJ).Value = dss.Tables("FV").Rows(JJ).Item(1)
    '                                        Next
    '                                        oda.Dispose()
    '                                        dss.Dispose()
    '                                    End If

    '                                    dynmdiv.Style.Add(HtmlTextWriterStyle.Width, "200px")
    '                                    dynmdiv.Style.Add(HtmlTextWriterStyle.Height, "100px")
    '                                    dynmdiv.Style.Add(HtmlTextWriterStyle.Overflow, "Scroll")
    '                                    dynmdiv.Controls.Add(CHKlIST)
    '                                    row.Cells(j).Controls.Add(dynmdiv)

    '                                ElseIf ftype.ToUpper = "LOOKUPDDL" Then

    '                                    datatype = dtfld1.Rows(j).Item("datatype").ToString().ToUpper()
    '                                    Dim fieldtypee As String = dtfld1.Rows(j).Item("FieldType").ToString().ToUpper()
    '                                    Dim ddl As New DropDownList
    '                                    ddl.ID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & "_" & row.RowIndex
    '                                    ddl.Width = controlWdth - 10
    '                                    ddl.CssClass = "txtBox"
    '                                    Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
    '                                    Dim dropdowntype As String = dtfld1.Rows(j).Item("dropdowntype").ToString()
    '                                    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                    Dim con As SqlConnection = New SqlConnection(conStr)
    '                                    Dim od As SqlDataAdapter = New SqlDataAdapter("select dropdown,DDllookupvalue from MMM_MST_FIELDS where FieldID='" & ddlText & "'", con)
    '                                    ' Dim dsMonth As New DataSet
    '                                    Dim dt As New DataTable
    '                                    od.Fill(dt)
    '                                    Dim arr() As String
    '                                    Dim darr() As String
    '                                    Dim type As String = dt.Rows(0).Item("dropdown").ToString()
    '                                    arr = type.Split("-")
    '                                    Dim documenttype As String = arr(1).ToString()
    '                                    Dim field As String = dt.Rows(0).Item("DDllookupvalue").ToString()
    '                                    field = field.Substring(0, field.Length - 1)
    '                                    darr = field.Split(",")
    '                                    For k As Integer = 0 To darr.Count - 1
    '                                        Dim fieldmping As String
    '                                        Dim str As String = ""
    '                                        Dim feild As String
    '                                        Dim s = darr(k).Split("-")
    '                                        feild = s(0).ToString()
    '                                        fieldmping = s(1).ToString()

    '                                        Dim TID As String = "TID"
    '                                        Dim TABLENAME As String = ""
    '                                        Dim str1 As String = ""
    '                                        Dim lookUpqry As String = ""

    '                                        Dim xwhr As String = ""
    '                                        Dim tids As String = ""
    '                                        Dim Rtids As String = ""   ' for prerole data filter


    '                                        If feild = dtfld1.Rows(j).Item("FieldID").ToString() Then
    '                                            'If arr(0) = "SESSION" And Not (fieldmping.Contains("fld")) Then
    '                                            '    If arr(1).ToString.ToUpper = "USER" Then
    '                                            '        TABLENAME = "MMM_MST_USER"
    '                                            '        TID = "UID"
    '                                            '    End If
    '                                            '    ' str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                            '    str1 = "select " & fieldmping.ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                            'Else
    '                                            od.SelectCommand.CommandText = "select dropdown from MMM_MST_FIELDS where EID=" & HttpContext.Current.Session("EID") & " and documenttype='" & documenttype & "' and FieldMapping in('" & fieldmping & "')"
    '                                            Dim dt1 As New DataTable
    '                                            od.Fill(dt1)
    '                                            Dim dropdown As String = dt1.Rows(0).Item("dropdown").ToString()
    '                                            arr = dropdown.Split("-")

    '                                            If UCase(arr(0).ToString()) = "MASTER" Then
    '                                                TABLENAME = "MMM_MST_MASTER"
    '                                            ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                                TABLENAME = "MMM_MST_DOC"
    '                                            ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                                TABLENAME = "MMM_MST_DOC_ITEM"
    '                                            ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                                If arr(1).ToString.ToUpper = "USER" Then
    '                                                    TABLENAME = "MMM_MST_USER"
    '                                                    TID = "UID"
    '                                                ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                    TABLENAME = "MMM_MST_LOCATION"
    '                                                    TID = "LOCID"
    '                                                End If
    '                                            ElseIf UCase(arr(0).ToString) = "SESSION" Then
    '                                                If arr(1).ToString.ToUpper = "USER" Then
    '                                                    TABLENAME = "MMM_MST_USER"
    '                                                    TID = "UID"
    '                                                ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                    TABLENAME = "MMM_MST_LOCATION"
    '                                                    TID = "LOCID"
    '                                                End If
    '                                            End If

    '                                            If arr(0).ToUpper() = "CHILD" Then
    '                                                str1 = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                            ElseIf arr(0).ToUpper() = "SESSION" Then
    '                                                str1 = "Select " & IIf(arr(1).ToString.ToUpper = "USER", "UserName, ", "LocationName, ") & TID & " from " & TABLENAME & " M where EID=" & HttpContext.Current.Session("EID") & " AND " & arr(2) & "='" & HttpContext.Current.Session(arr(2)) & "'"
    '                                            ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                                str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                            Else
    '                                                If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                                    str1 = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M "
    '                                                Else
    '                                                    str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                                End If
    '                                            End If
    '                                            '  End If

    '                                            'Dim tidarr() As String

    '                                            ''FILTER THE DATA ACCORDING TO USER 
    '                                            Dim ob = New DynamicForm()
    '                                            tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())
    '                                            Rtids = ob.UserDataFilter_PreRole(arr(1).ToString(), TABLENAME)  '' new by sunil for pre role data filter 22-feb

    '                                            '' for multiuse of document by sp on 08_apr_15
    '                                            Dim Sdtype As String = arr(1).ToString
    '                                            Dim da As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                            da.SelectCommand.CommandType = CommandType.Text
    '                                            da.SelectCommand.CommandText = "select isnull(Allowmultiuse,0) from mmm_mst_forms where eid='" & HttpContext.Current.Session("EID").ToString & "' AND FORMNAME='" & Sdtype & "'"
    '                                            If con.State <> ConnectionState.Open Then
    '                                                con.Open()
    '                                            End If
    '                                            Dim isMultiUse As Integer = Convert.ToInt32(da.SelectCommand.ExecuteScalar())

    '                                            Dim CurrDoctype As String = dtfld1.Rows(j).Item("documenttype").ToString()
    '                                            Dim CurrFieldMapping As String = dtfld1.Rows(j).Item("fieldmapping").ToString()

    '                                            Dim qry As String = ""
    '                                            Dim MTids As String = ""
    '                                            If UCase(arr(0).ToString()) <> "CHILD" And UCase(arr(0).ToString) <> "STATIC" And UCase(arr(0).ToString) <> "SESSION" Then
    '                                                da.SelectCommand.CommandType = CommandType.Text
    '                                                da.SelectCommand.CommandText = "SELECT SUBSTRING((SELECT ',' + CONVERT(NVARCHAR," & CurrFieldMapping & ")  FROM " & TABLENAME & " where EID=" & HttpContext.Current.Session("eid") & " and documenttype='" & CurrDoctype & "'" & " FOR XML PATH('')),2,1000) AS CSV"
    '                                                MTids = Convert.ToString(da.SelectCommand.ExecuteScalar())
    '                                            End If
    '                                            ''ends  for multiuse of document by sp on 08_apr_15


    '                                            If tids.Length >= 2 Then
    '                                                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                            ElseIf tids = "0" Then
    '                                                pnlFields.Visible = False
    '                                                btnActEdit.Visible = False
    '                                                UpdatePanel1.Update()
    '                                                xwhr = ""
    '                                            End If
    '                                            '' new by sunil for pre role data filter 22-feb
    '                                            If Rtids <> "" Then
    '                                                If xwhr.ToString = "" Then
    '                                                    xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & Rtids & ")"
    '                                                Else
    '                                                    xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & "," & Rtids & ")"
    '                                                End If
    '                                            End If

    '                                            '' new by sunil for multiuse of docs
    '                                            If MTids.Length > 2 And isMultiUse = 1 Then
    '                                                If Right(MTids, 1) = "," Then
    '                                                    MTids = Left(MTids, Len(MTids) - 1)
    '                                                End If
    '                                                xwhr = xwhr & " AND CONVERT(NVARCHAR(10),TID) not IN (" & MTids & ") "
    '                                            End If
    '                                            '' new by sunil for multiuse of docs

    '                                            str1 = str1 & "  AND M.isauth>0 " & xwhr & " order by " & arr(2).ToString()
    '                                            'Dim documenttype2 As String = arr1(1).ToString()
    '                                            'Dim fieldmping2 As String = arr1(2).ToString()
    '                                            'pnlFields.Controls.Add(ddl)
    '                                            Dim dt2 As New DataTable
    '                                            'oda.SelectCommand.CommandText = "select " & fieldmping2 & " from " & TABLENAME & " where EID=" & HttpContext.Current.Session("EID") & " and documenttype = '" & documenttype2 & "'"

    '                                            If str1.Length > 0 Then
    '                                                pnlFields.Controls.Add(ddl)
    '                                                od.SelectCommand.CommandText = str1
    '                                                od.Fill(dt2)
    '                                                Dim isAddJquery As Integer = 0
    '                                                ddl.Items.Add("Select")
    '                                                ddl.Items(0).Value = "0"
    '                                                For JK As Integer = 0 To dt2.Rows.Count - 1
    '                                                    ddl.Items.Add(dt2.Rows(JK).Item(0).ToString())
    '                                                    Dim lookddlVal As String = dt2.Rows(JK).Item(1).ToString()
    '                                                    ddl.Items(JK + 1).Value = lookddlVal
    '                                                Next
    '                                                dt2.Dispose()
    '                                            End If
    '                                            If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                                ddl.Enabled = True
    '                                            Else
    '                                                ddl.Enabled = False
    '                                            End If
    '                                        End If
    '                                    Next
    '                                    row.Cells(j).Controls.Add(ddl)

    '                                ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
    '                                    Dim txtBox As New FileUpload

    '                                    'Prashant 30-6-2014
    '                                    Dim txtBox1 As New HiddenField

    '                                    Dim lbl1 As New Label
    '                                    lbl1.ID = "lblf_" & FldID
    '                                    lbl1.Text = ""
    '                                    lbl1.ClientIDMode = ClientIDMode.Static

    '                                    txtBox1.ID = "hdn_" & FldID
    '                                    txtBox1.Value = ""
    '                                    txtBox1.ClientIDMode = ClientIDMode.Static
    '                                    If Not Request.QueryString("TID") Is Nothing Then
    '                                        txtBox.Attributes.Add("onchange", "UtilJs.UploadFile1(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
    '                                    Else
    '                                        txtBox.Attributes.Add("onchange", "UtilJs.UploadFile(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
    '                                    End If



    '                                    txtBox.ID = "fld_" & FldID & "_" & row.RowIndex  ' added  id  with _ by balli
    '                                    txtBox.CssClass = "txtBox"

    '                                    txtBox.Width = 180


    '                                    Dim hdnflag As New HiddenField
    '                                    If Not Request.QueryString("TID") Is Nothing Then
    '                                        hdnflag.ID = "hdnf_" & FldID
    '                                        hdnflag.Value = "0"
    '                                        Dim str As String = row.Cells(j).Text

    '                                        str = After(str, "/")

    '                                        txtBox1.Value = str 'row.Cells(j).Text
    '                                        lbl1.Text = str ' row.Cells(j).Text
    '                                        row.Cells(j).Text = str
    '                                    End If
    '                                    If ViewState("chkadd") = 1 Then
    '                                        j = j + 1
    '                                    End If
    '                                    row.Cells(j).Controls.Add(txtBox)
    '                                    'Prashant 30-6-2014
    '                                    row.Cells(j).Controls.Add(txtBox1)
    '                                    row.Cells(j).Controls.Add(lbl1)
    '                                    row.Cells(j).Controls.Add(hdnflag)

    '                                    Dim pstback As New PostBackTrigger
    '                                    pstback.ControlID = btnActEdit.ID
    '                                    UpdatePanel1.Triggers.Add(pstback)

    '                                End If
    '                                If ViewState("chkadd") = 1 Then
    '                                    j = j - 1    ' added for incremental 
    '                                End If
    '                            End If

    '                        Next
    '                    End If

    '                    ' By Neha Thakar 24-01-15
    '                Else
    '                    Dim filterRows2() As DataRow
    '                    filterRows2 = dtfld1.Select("HasDefaultValue=1")
    '                    'Uncomment it
    '                    'If filterRows.Length > 0 Then
    '                    '    dtfld1 = filterRows.CopyToDataTable()
    '                    'Else
    '                    '    filterRows = dtfld1.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''", "inlinemapping,DisplayOrder")
    '                    '    dtfld1 = filterRows.CopyToDataTable()
    '                    'End If


    '                    Dim filterRows() As DataRow
    '                    Dim filterRows1() As DataRow
    '                    filterRows = dtfld1.Select("inlinemapping is not null and inlinemapping <>''", "DisplayOrder")
    '                    filterRows1 = dtfld1.Select("InLineEditing=1 and inlinemapping is null", "DisplayOrder")
    '                    If filterRows.Length > 0 Then
    '                        dtfld1 = filterRows.CopyToDataTable()
    '                        dtfld1.Merge(filterRows1.CopyToDataTable())
    '                    Else
    '                        dtfld1 = filterRows1.CopyToDataTable()
    '                    End If


    '                    For j As Integer = 0 To dtfld1.Rows.Count - 1

    '                        Dim ftype As String = dtfld1.Rows(j).Item("fieldtype").ToString()

    '                        Dim datatype As String = dtfld1(j).Item("datatype").ToString() 'Prashant_10_7

    '                        Dim colValue As String = row.DataItem(j).ToString()
    '                        Dim ilEdit As Integer = dtfld1.Rows(j).Item("inlineEditing").ToString()
    '                        Dim FldID As String = dtfld1.Rows(j).Item("fieldid").ToString()
    '                        Dim Formula = Convert.ToString(dtfld1.Rows(j).Item("cal_text"))
    '                        Dim DisplayName = Convert.ToString(dtfld1.Rows(j).Item("DisplayName"))
    '                        Dim InlineMap = Convert.ToString(dtfld1.Rows(j).Item("inlinemapping"))
    '                        If ilEdit = 1 Then
    '                            If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Or ftype.ToUpper() = "PARENT VALUE" Then
    '                                Dim cb As New TextBox
    '                                'cb.ID = "fld" & j.ToString() & "_" & row.RowIndex
    '                                cb.Width = 55
    '                                cb.ID = "fld" & FldID & row.RowIndex

    '                                'Prashant_10_7
    '                                If dtfld1.Rows(j).Item("defaultfieldval").ToString().Length > 0 Then
    '                                    cb.Text = dtfld1.Rows(j).Item("defaultfieldval").ToString()
    '                                Else
    '                                    If datatype.ToUpper() = "NUMERIC" Then
    '                                        cb.Text = "0"
    '                                    End If
    '                                End If
    '                                If Val(dtfld1.Rows(j).Item("isDescription").ToString()) = 1 Then
    '                                    cb.ToolTip = dtfld1.Rows(j).Item("Description").ToString()
    '                                End If
    '                                If dtfld1.Rows(j).Item("iseditable") = 0 Then
    '                                    cb.Attributes.Add("READONLY", "READONLY")
    '                                    cb.Attributes.Add("COLOR", "GRAY")
    '                                End If
    '                                If ftype.ToUpper() = "CALCULATIVE FIELD" Then
    '                                    colValue = "0"
    '                                    cb.Attributes.Add("READONLY", "READONLY")
    '                                    cb.Attributes.Add("COLOR", "GRAY")
    '                                End If



    '                                If ftype.ToUpper() = "LOOKUP" Then
    '                                    If datatype.ToUpper() = "NUMERIC" Then
    '                                        colValue = "0"
    '                                    End If
    '                                Else
    '                                    If Val(colValue) = 0 Then
    '                                        If ftype.ToUpper() = "TEXT BOX" And datatype.ToUpper() = "NUMERIC" Then
    '                                            colValue = "0"
    '                                        End If
    '                                    End If
    '                                End If

    '                                If ViewState("chkadd") = 1 Then
    '                                    j = j + 1
    '                                End If

    '                                If Not row.Cells(j).Text.Trim = "&nbsp;" And Not row.Cells(j).Text.Trim = "" Then
    '                                    colValue = row.Cells(j).Text.Trim
    '                                Else
    '                                    colValue = cb.Text
    '                                End If

    '                                cb.Text = colValue
    '                                cb.Width = controlWdth
    '                                row.Cells(j).Controls.Add(cb)

    '                                If datatype.ToUpper.Trim = "DATETIME" Then
    '                                    Dim CLNDR As New AjaxControlToolkit.CalendarExtender
    '                                    CLNDR.Controls.Clear()
    '                                    CLNDR.ID = "CLNDR" & dtfld1.Rows(j).Item("FieldID").ToString()
    '                                    CLNDR.Format = "dd/MM/yy"
    '                                    CLNDR.TargetControlID = cb.ID
    '                                    cb.Enabled = True

    '                                    cb.Text = String.Format("{0:dd/MM/yy}", Date.Now())

    '                                    'If ViewState("chkadd") = 1 Then
    '                                    '    j = j + 1
    '                                    'End If
    '                                    row.Cells(j).Controls.Add(CLNDR) '
    '                                End If

    '                                If Not Formula Is Nothing And Formula <> "" Then
    '                                    'Dim arrFor As String() = Formula.Split(",")
    '                                    Dim jScript = GenerateJQueryScript(dtfld1, GID, row.RowIndex, Formula, FldID)
    '                                    If jScript <> "" Then
    '                                        cb.Attributes.Add("onblur", jScript)
    '                                    End If
    '                                End If


    '                            ElseIf ftype.ToUpper() = "MULTI LOOKUP" Then
    '                                Dim txtBox As New TextBox
    '                                txtBox.ID = "fld" & FldID & row.RowIndex
    '                                txtBox.Width = controlWdth - 10
    '                                txtBox.CssClass = "txtBox"
    '                                If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                    txtBox.Enabled = True
    '                                Else
    '                                    txtBox.Enabled = False
    '                                End If

    '                                If ViewState("chkadd") = 1 Then
    '                                    j = j + 1
    '                                End If
    '                                If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
    '                                    txtBox.Text = row.Cells(j).Text
    '                                End If

    '                                row.Cells(j).Controls.Add(txtBox)

    '                            ElseIf ftype.ToUpper() = "FORMULA FIELD" Then
    '                                Dim txtBox As New TextBox
    '                                txtBox.ID = "fld" & FldID & row.RowIndex
    '                                txtBox.Width = controlWdth - 10
    '                                txtBox.CssClass = "txtBox"
    '                                If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                    txtBox.Enabled = True
    '                                Else
    '                                    txtBox.Enabled = False
    '                                End If

    '                                If ViewState("chkadd") = 1 Then
    '                                    j = j + 1
    '                                End If
    '                                If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
    '                                    txtBox.Text = row.Cells(j).Text
    '                                Else
    '                                    txtBox.Text = "0"
    '                                End If

    '                                row.Cells(j).Controls.Add(txtBox)

    '                            ElseIf ftype.ToUpper() = "TEXT AREA" Then
    '                                Dim txtBox As New TextBox
    '                                txtBox.ID = "fld" & FldID & row.RowIndex
    '                                txtBox.Width = controlWdth + 50
    '                                txtBox.Height = 50
    '                                txtBox.TextMode = TextBoxMode.MultiLine
    '                                txtBox.Columns = 4
    '                                txtBox.Rows = 10
    '                                txtBox.CssClass = "txtBox"
    '                                If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                    txtBox.Enabled = True
    '                                Else
    '                                    txtBox.Enabled = False
    '                                End If

    '                                If ViewState("chkadd") = 1 Then
    '                                    j = j + 1
    '                                End If
    '                                If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
    '                                    txtBox.Text = row.Cells(j).Text
    '                                End If

    '                                row.Cells(j).Controls.Add(txtBox)

    '                            ElseIf ftype.ToUpper() = "AUTOCOMPLETE" Then

    '                                Dim txtbox As New TextBox
    '                                txtbox.ID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
    '                                txtbox.Width = controlWdth - 10
    '                                txtbox.CssClass = "txtBox"
    '                                txtbox.Attributes.Add("placeholder", "Please begin typing a " & DisplayName)
    '                                txtbox.AutoPostBack = True
    '                                AddHandler txtbox.TextChanged, AddressOf txtbox_TextChanged
    '                                ' adding handler for binding lookup or other dropdown or filter

    '                                Dim autofilExtender As New AjaxControlToolkit.AutoCompleteExtender
    '                                autofilExtender.ID = "extenderID" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex

    '                                autofilExtender.TargetControlID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
    '                                autofilExtender.ServiceMethod = "GetCompletionList" ' THIS SERVICE METHOD IS WRITTEN ON DOCUMENT PAGE 
    '                                autofilExtender.DelimiterCharacters = ""
    '                                autofilExtender.ContextKey = dtfld1.Rows(j).Item("DROPDOWN").ToString() & "-" & dtfld1.Rows(j).Item("FieldID").ToString() & "-" & dtfld1.Rows(j).Item("DROPDOWNTYPE").ToString() & "-" & dtfld1.Rows(j).Item("AUTOFILTER").ToString() & "-" & dtfld1.Rows(j).Item("inlinefilter").ToString()
    '                                'context key contain  : dropdown-fieldid-dropdowntype-autofilter-InitialFilter' adding the fieldid in context key because later on we need id of field in web method 
    '                                autofilExtender.Enabled = True
    '                                autofilExtender.CompletionSetCount = 5
    '                                autofilExtender.OnClientShown = "onDataShown"  ' by sunil
    '                                '   autofilExtender.CompletionListElementID = "ACsugestlist"
    '                                autofilExtender.MinimumPrefixLength = 1  ' start searching when entered one characters
    '                                'autofilExtender.OnClientItemSelected = "ace_itemSelected('" & ds.Rows(i).Item("FieldID").ToString() & "')"
    '                                autofilExtender.OnClientItemSelected = "ace_itemSelected"
    '                                row.Cells(j).Controls.Add(txtbox)
    '                                'pnlFields.Controls.Add(txtbox)

    '                                Dim hdnfld As New HiddenField
    '                                hdnfld.ID = "HDN" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
    '                                row.Cells(j).Controls.Add(hdnfld)
    '                                'pnlFields.Controls.Add(img)
    '                                'pnlFields.Controls.Add(prgBar)
    '                                row.Cells(j).Controls.Add(autofilExtender)
    '                                'pnlFields.Controls.Add(autofilExtender)



    '                            ElseIf ftype.ToUpper() = "MULTI LOOKUPDDL" Then

    '                                Dim ddl As New DropDownList
    '                                ddl.ID = "fld" & FldID & "_" & row.RowIndex
    '                                ddl.CssClass = "txtBox"
    '                                ddl.Width = 150

    '                                Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                Dim con As SqlConnection = New SqlConnection(conStr)
    '                                Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
    '                                Dim od As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                Dim dt As New DataTable
    '                                Dim dtval As New DataTable
    '                                Dim fieldid As String()
    '                                Dim ddlval As String()
    '                                If (ddlText.ToString() <> String.Empty) Then
    '                                    fieldid = ddlText.ToString().Split(",")
    '                                    od.SelectCommand.CommandText = "select ddlMultilookupval from mmm_mst_fields where fieldid = " & fieldid(0).ToString() & ""
    '                                    od.Fill(dtval)
    '                                    If (dtval.Rows.Count > 0) Then
    '                                        ddlval = dtval.Rows(0)("ddlMultilookupval").ToString().Split(",")
    '                                        For q As Integer = 0 To ddlval.Length - 1
    '                                            If (ddlval(q).ToString().Contains("-" & dtfld1.Rows(j).Item("FieldID").ToString())) Then
    '                                                Dim temp() As String = ddlval(q).ToString().Split("-")
    '                                                od.SelectCommand.CommandText = "select * from MMM_MST_FIELDS where DOCUMENTTYPE='" & temp(0).ToString() & "' and eid=" & HttpContext.Current.Session("EID") & " and fieldmapping in('" & temp(1).ToString() & "')"
    '                                                Dim checkval As New DataTable
    '                                                od.Fill(checkval)
    '                                                Dim ddlText1 As String = checkval.Rows(0).Item("dropdown").ToString()
    '                                                Dim dropdowntype As String = checkval.Rows(0).Item("dropdowntype").ToString()
    '                                                Dim arr() As String
    '                                                If UCase(dropdowntype) = "MASTER VALUED" Then
    '                                                    Dim ob As New DynamicForm
    '                                                    arr = ddlText1.Split("-")
    '                                                    Dim TID As String = "TID"
    '                                                    Dim TABLENAME As String = ""
    '                                                    If UCase(arr(0).ToString()) = "MASTER" Then
    '                                                        TABLENAME = "MMM_MST_MASTER"
    '                                                    ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                                        TABLENAME = "MMM_MST_DOC"
    '                                                    ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                                        TABLENAME = "MMM_MST_DOC_ITEM"
    '                                                    ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                                        If arr(1).ToString.ToUpper = "USER" Then
    '                                                            TABLENAME = "MMM_MST_USER"
    '                                                            TID = "UID"
    '                                                        ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                            TABLENAME = "MMM_MST_LOCATION"
    '                                                            TID = "LOCID"
    '                                                        End If
    '                                                    ElseIf UCase(arr(0).ToString) = "SESSION" Then
    '                                                        If arr(1).ToString.ToUpper = "USER" Then
    '                                                            TABLENAME = "MMM_MST_USER"
    '                                                            TID = "UID"
    '                                                        ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                            TABLENAME = "MMM_MST_LOCATION"
    '                                                            TID = "LOCID"
    '                                                        End If
    '                                                    End If
    '                                                    Dim lookUpqry As String = ""
    '                                                    Dim str As String = ""
    '                                                    If arr(0).ToUpper() = "CHILD" Then
    '                                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                    ElseIf arr(0).ToUpper() = "SESSION" Then
    '                                                        str = "Select " & IIf(arr(1).ToString.ToUpper = "USER", "UserName, ", "LocationName, ") & TID & " from " & TABLENAME & " M where EID=" & HttpContext.Current.Session("EID") & " AND " & arr(2) & "='" & HttpContext.Current.Session(arr(2)) & "'"
    '                                                    ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                    Else
    '                                                        If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                                            str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M "
    '                                                        Else
    '                                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                                        End If
    '                                                    End If

    '                                                    Dim xwhr As String = ""
    '                                                    Dim tids As String = ""
    '                                                    'Dim tidarr() As String

    '                                                    ''FILTER THE DATA ACCORDING TO USER 
    '                                                    tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())

    '                                                    If tids.Length >= 2 Then
    '                                                        'tidarr = tids.Split("-")
    '                                                        xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                                    ElseIf tids = "0" Then
    '                                                        pnlFields.Visible = False
    '                                                        btnActEdit.Visible = False
    '                                                        UpdatePanel1.Update()
    '                                                        xwhr = ""
    '                                                    End If
    '                                                    str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                    Dim AutoFilter As String = dtfld1.Rows(j).Item("AutoFilter").ToString()
    '                                                    If AutoFilter.Length > 0 Then
    '                                                        If arr(0).ToUpper() = "CHILD" Then
    '                                                            If AutoFilter.ToUpper = "DOCID" Then
    '                                                                str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
    '                                                            Else
    '                                                                str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
    '                                                            End If
    '                                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                                            str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                        Else
    '                                                            str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & Session("EID") & " "
    '                                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                        End If
    '                                                    End If


    '                                                    Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                                    Dim dss As New DataSet
    '                                                    If str.Length > 0 Then
    '                                                        oda.SelectCommand.CommandText = str
    '                                                        oda.Fill(dss, "FV")
    '                                                        Dim isAddJquery As Integer = 0
    '                                                        ddl.Items.Add("Select")
    '                                                        ddl.Items(0).Value = "0"
    '                                                        For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                                            ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
    '                                                            Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
    '                                                            ddl.Items(J1 + 1).Value = lookddlVal
    '                                                        Next
    '                                                        oda.Dispose()
    '                                                        dss.Dispose()
    '                                                        'prashant_2_7

    '                                                        Dim lookupvalue As String = dtfld1.Rows(j).Item("lookupvalue").ToString()
    '                                                        Dim multilookup As String = dtfld1.Rows(j).Item("multilookUpVal").ToString()
    '                                                        Dim ddlmultilookup As String = dtfld1.Rows(j).Item("ddlmultilookUpVal").ToString()

    '                                                        If lookupvalue.Length > 0 Or multilookup.Length > 0 Or ddlmultilookup.Length > 0 Then
    '                                                            ddl.AutoPostBack = True
    '                                                            AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged
    '                                                        End If

    '                                                        If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                                            ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                                        End If
    '                                                        If ViewState("chkadd") = 1 Then
    '                                                            j = j + 1
    '                                                        End If

    '                                                        If ddl.Items.FindByValue(row.Cells(j).Text) IsNot Nothing Then
    '                                                            'ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                                            ddl.SelectedValue = ddl.Items.FindByValue(row.Cells(j).Text).Value
    '                                                        End If

    '                                                        row.Cells(j).Controls.Add(ddl)

    '                                                        If isAddJquery = 1 Then
    '                                                            Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
    '                                                        End If
    '                                                    End If
    '                                                    con.Dispose()
    '                                                    oda.Dispose()
    '                                                    dss.Dispose()
    '                                                ElseIf UCase(dropdowntype) = "SESSION VALUED" Then

    '                                                End If
    '                                            End If
    '                                        Next
    '                                    End If
    '                                End If


    '                            ElseIf ftype.ToUpper() = "DROP DOWN" Then
    '                                Dim ddl As New DropDownList

    '                                ddl.ID = "fld" & FldID & "_" & row.RowIndex
    '                                ddl.CssClass = "txtBox"
    '                                ddl.Width = 150
    '                                Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
    '                                Dim dropdowntype As String = dtfld1.Rows(j).Item("dropdowntype").ToString()
    '                                Dim arr() As String
    '                                If dtfld1.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                    'Dim cb As New DropDownList
    '                                    ' cb.ID = "fld" & FldID & row.RowIndex
    '                                    ddl.Items.Add("Select")
    '                                    ddl.Items(0).Value = "0"

    '                                    Dim ARR1() As String = dtfld1.Rows(j).Item("dropdown").ToString().Split(",")
    '                                    For K As Integer = 0 To ARR1.Length - 1
    '                                        ddl.Items.Add(ARR1(K).ToString)
    '                                    Next
    '                                    If ViewState("chkadd") = 1 Then
    '                                        j = j + 1
    '                                    End If
    '                                    If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                        'ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                        ddl.SelectedValue = ddl.Items.FindByText(row.Cells(j).Text).Value
    '                                    End If

    '                                    row.Cells(j).Controls.Add(ddl)
    '                                    'Prashant_10_7
    '                                    If dtfld1.Rows(j).Item("iseditable") = 1 Then
    '                                        ddl.Enabled = True
    '                                    Else
    '                                        ddl.Enabled = False
    '                                    End If

    '                                ElseIf dtfld1.Rows(j).Item("dropdowntype").ToString() = "MASTER VALUED" Then
    '                                    '' code for getting master valued 
    '                                    Dim ob As New DynamicForm
    '                                    arr = ddlText.Split("-")
    '                                    Dim TID As String = "TID"
    '                                    Dim TABLENAME As String = ""
    '                                    If UCase(arr(0).ToString()) = "MASTER" Then
    '                                        TABLENAME = "MMM_MST_MASTER"
    '                                    ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                        TABLENAME = "MMM_MST_DOC"
    '                                    ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                        TABLENAME = "MMM_MST_DOC_ITEM"
    '                                    ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                        If arr(1).ToString.ToUpper = "USER" Then
    '                                            TABLENAME = "MMM_MST_USER"
    '                                            TID = "UID"
    '                                        ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                            TABLENAME = "MMM_MST_LOCATION"
    '                                            TID = "LOCID"
    '                                        End If
    '                                    End If
    '                                    Dim lookUpqry As String = ""
    '                                    Dim str As String = ""
    '                                    If arr(0).ToUpper() = "CHILD" Then
    '                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                    ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                    Else
    '                                        If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                            str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M "
    '                                        Else
    '                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                        End If
    '                                    End If

    '                                    Dim xwhr As String = ""
    '                                    Dim tids As String = ""
    '                                    'Dim tidarr() As String

    '                                    ''FILTER THE DATA ACCORDING TO USER 
    '                                    tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())

    '                                    If tids.Length >= 2 Then
    '                                        'tidarr = tids.Split("-")
    '                                        xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                    ElseIf tids = "0" Then
    '                                        pnlFields.Visible = False
    '                                        btnActEdit.Visible = False
    '                                        UpdatePanel1.Update()
    '                                        xwhr = ""
    '                                    End If
    '                                    str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                    Dim AutoFilter As String = dtfld1.Rows(j).Item("AutoFilter").ToString()
    '                                    If AutoFilter.Length > 0 Then
    '                                        If arr(0).ToUpper() = "CHILD" Then
    '                                            If AutoFilter.ToUpper = "DOCID" Then
    '                                                str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
    '                                            Else
    '                                                str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
    '                                            End If
    '                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                            str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                        Else
    '                                            str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & Session("EID") & " "
    '                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                        End If
    '                                    End If

    '                                    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                    Dim con As SqlConnection = New SqlConnection(conStr)
    '                                    Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                    Dim dss As New DataSet

    '                                    If str.Length > 0 Then
    '                                        oda.SelectCommand.CommandText = str
    '                                        oda.Fill(dss, "FV")
    '                                        Dim isAddJquery As Integer = 0
    '                                        ddl.Items.Add("Select")
    '                                        ddl.Items(0).Value = "0"
    '                                        For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                            ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
    '                                            Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
    '                                            ddl.Items(J1 + 1).Value = lookddlVal
    '                                        Next
    '                                        oda.Dispose()
    '                                        dss.Dispose()
    '                                        'prashant_2_7

    '                                        Dim lookupvalue As String = dtfld1.Rows(j).Item("lookupvalue").ToString()
    '                                        Dim multilookup As String = dtfld1.Rows(j).Item("multilookUpVal").ToString()
    '                                        Dim ddlmultilookup As String = dtfld1.Rows(j).Item("ddlmultilookUpVal").ToString()

    '                                        If lookupvalue.Length > 0 Or multilookup.Length > 0 Or ddlmultilookup.Length > 0 Then
    '                                            ddl.AutoPostBack = True
    '                                            AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged
    '                                        End If

    '                                        If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                            ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                        End If
    '                                        If ViewState("chkadd") = 1 Then
    '                                            j = j + 1
    '                                        End If

    '                                        If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                            'ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                            ddl.SelectedValue = ddl.Items.FindByText(row.Cells(j).Text).Value
    '                                        End If

    '                                        row.Cells(j).Controls.Add(ddl)

    '                                        If isAddJquery = 1 Then
    '                                            Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
    '                                        End If
    '                                    End If
    '                                    con.Dispose()
    '                                    oda.Dispose()
    '                                    dss.Dispose()
    '                                    '' ends here for getting master valued 

    '                                End If
    '                            ElseIf ftype.ToUpper() = "CHECKBOX LIST" Then
    '                                Dim CHKlIST As New CheckBoxList()
    '                                Dim dynmdiv As System.Web.UI.HtmlControls.HtmlGenericControl = New System.Web.UI.HtmlControls.HtmlGenericControl("DIV")
    '                                dynmdiv.ID = "div_" & FldID
    '                                Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
    '                                CHKlIST.ID = "fld" & FldID & "_" & row.RowIndex
    '                                If dtfld1.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                    Dim arr = ddlText.Split(",")
    '                                    For ii As Integer = 0 To arr.Count - 1
    '                                        CHKlIST.Items.Add(arr(ii).ToUpper())
    '                                    Next

    '                                ElseIf dtfld1.Rows(j).Item("dropdowntype").ToString() = "MASTER VALUED" Then
    '                                    Dim arr = ddlText.Split("-")
    '                                    Dim TID As String = "TID"
    '                                    Dim TABLENAME As String = ""
    '                                    If UCase(arr(0).ToString()) = "MASTER" Then
    '                                        TABLENAME = "MMM_MST_MASTER"
    '                                    ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                        TABLENAME = "MMM_MST_DOC"
    '                                    ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                        TABLENAME = "MMM_MST_DOC_ITEM"
    '                                    ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                        If arr(1).ToString.ToUpper = "USER" Then
    '                                            TABLENAME = "MMM_MST_USER"
    '                                            TID = "UID"
    '                                        ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                            TABLENAME = "MMM_MST_LOCATION"
    '                                            TID = "LOCID"
    '                                        End If
    '                                    End If
    '                                    Dim lookUpqry As String = ""
    '                                    Dim str As String = ""
    '                                    If arr(0).ToUpper() = "CHILD" Then
    '                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                    ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                    Else
    '                                        If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                            str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M "
    '                                        Else
    '                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                        End If
    '                                    End If
    '                                    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                    Dim con As SqlConnection = New SqlConnection(conStr)
    '                                    Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                    oda = New SqlDataAdapter("", con)
    '                                    Dim dss As New DataSet
    '                                    oda.SelectCommand.CommandText = str
    '                                    oda.Fill(dss, "FV")
    '                                    For JJ As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                        CHKlIST.Items.Add(dss.Tables("FV").Rows(JJ).Item(0))
    '                                        CHKlIST.Items(JJ).Value = dss.Tables("FV").Rows(JJ).Item(1)
    '                                    Next
    '                                    oda.Dispose()
    '                                    dss.Dispose()
    '                                End If

    '                                dynmdiv.Style.Add(HtmlTextWriterStyle.Width, "200px")
    '                                dynmdiv.Style.Add(HtmlTextWriterStyle.Height, "100px")
    '                                dynmdiv.Style.Add(HtmlTextWriterStyle.Overflow, "Scroll")
    '                                dynmdiv.Controls.Add(CHKlIST)
    '                                row.Cells(j).Controls.Add(dynmdiv)

    '                            ElseIf ftype.ToUpper = "LOOKUPDDL" Then

    '                                datatype = dtfld1.Rows(j).Item("datatype").ToString().ToUpper()
    '                                Dim fieldtypee As String = dtfld1.Rows(j).Item("FieldType").ToString().ToUpper()
    '                                Dim ddl As New DropDownList
    '                                ddl.ID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & "_" & row.RowIndex
    '                                ddl.Width = controlWdth - 10
    '                                ddl.CssClass = "txtBox"
    '                                Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
    '                                Dim dropdowntype As String = dtfld1.Rows(j).Item("dropdowntype").ToString()
    '                                Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                Dim con As SqlConnection = New SqlConnection(conStr)
    '                                Dim od As SqlDataAdapter = New SqlDataAdapter("select dropdown,DDllookupvalue from MMM_MST_FIELDS where FieldID='" & ddlText & "'", con)
    '                                ' Dim dsMonth As New DataSet
    '                                Dim dt As New DataTable
    '                                od.Fill(dt)
    '                                Dim arr() As String
    '                                Dim darr() As String
    '                                Dim type As String = dt.Rows(0).Item("dropdown").ToString()
    '                                arr = type.Split("-")
    '                                Dim documenttype As String = arr(1).ToString()
    '                                Dim field As String = dt.Rows(0).Item("DDllookupvalue").ToString()
    '                                field = field.Substring(0, field.Length - 1)
    '                                darr = field.Split(",")
    '                                For k As Integer = 0 To darr.Count - 1
    '                                    Dim fieldmping As String
    '                                    Dim str As String = ""
    '                                    Dim feild As String
    '                                    Dim s = darr(k).Split("-")
    '                                    feild = s(0).ToString()
    '                                    fieldmping = s(1).ToString()

    '                                    Dim TID As String = "TID"
    '                                    Dim TABLENAME As String = ""
    '                                    Dim str1 As String = ""
    '                                    Dim lookUpqry As String = ""

    '                                    Dim xwhr As String = ""
    '                                    Dim tids As String = ""
    '                                    Dim Rtids As String = ""   ' for prerole data filter


    '                                    If feild = dtfld1.Rows(j).Item("FieldID").ToString() Then
    '                                        'If arr(0) = "SESSION" And Not (fieldmping.Contains("fld")) Then
    '                                        '    If arr(1).ToString.ToUpper = "USER" Then
    '                                        '        TABLENAME = "MMM_MST_USER"
    '                                        '        TID = "UID"
    '                                        '    End If
    '                                        '    ' str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                        '    str1 = "select " & fieldmping.ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                        'Else
    '                                        od.SelectCommand.CommandText = "select dropdown from MMM_MST_FIELDS where EID=" & HttpContext.Current.Session("EID") & " and documenttype='" & documenttype & "' and FieldMapping in('" & fieldmping & "')"
    '                                        Dim dt1 As New DataTable
    '                                        od.Fill(dt1)
    '                                        Dim dropdown As String = dt1.Rows(0).Item("dropdown").ToString()
    '                                        arr = dropdown.Split("-")

    '                                        If UCase(arr(0).ToString()) = "MASTER" Then
    '                                            TABLENAME = "MMM_MST_MASTER"
    '                                        ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                            TABLENAME = "MMM_MST_DOC"
    '                                        ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                            TABLENAME = "MMM_MST_DOC_ITEM"
    '                                        ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                            If arr(1).ToString.ToUpper = "USER" Then
    '                                                TABLENAME = "MMM_MST_USER"
    '                                                TID = "UID"
    '                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                TABLENAME = "MMM_MST_LOCATION"
    '                                                TID = "LOCID"
    '                                            End If
    '                                        ElseIf UCase(arr(0).ToString) = "SESSION" Then
    '                                            If arr(1).ToString.ToUpper = "USER" Then
    '                                                TABLENAME = "MMM_MST_USER"
    '                                                TID = "UID"
    '                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                TABLENAME = "MMM_MST_LOCATION"
    '                                                TID = "LOCID"
    '                                            End If
    '                                        End If

    '                                        If arr(0).ToUpper() = "CHILD" Then
    '                                            str1 = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                        ElseIf arr(0).ToUpper() = "SESSION" Then
    '                                            str1 = "Select " & IIf(arr(1).ToString.ToUpper = "USER", "UserName, ", "LocationName, ") & TID & " from " & TABLENAME & " M where EID=" & HttpContext.Current.Session("EID") & " AND " & arr(2) & "='" & HttpContext.Current.Session(arr(2)) & "'"
    '                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                            str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                        Else
    '                                            If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                                str1 = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M "
    '                                            Else
    '                                                str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                            End If
    '                                        End If
    '                                        '  End If

    '                                        'Dim tidarr() As String

    '                                        ''FILTER THE DATA ACCORDING TO USER 
    '                                        Dim ob = New DynamicForm()
    '                                        tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())
    '                                        Rtids = ob.UserDataFilter_PreRole(arr(1).ToString(), TABLENAME)  '' new by sunil for pre role data filter 22-feb

    '                                        '' for multiuse of document by sp on 08_apr_15
    '                                        Dim Sdtype As String = arr(1).ToString
    '                                        Dim da As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                        da.SelectCommand.CommandType = CommandType.Text
    '                                        da.SelectCommand.CommandText = "select isnull(Allowmultiuse,0) from mmm_mst_forms where eid='" & HttpContext.Current.Session("EID").ToString & "' AND FORMNAME='" & Sdtype & "'"
    '                                        If con.State <> ConnectionState.Open Then
    '                                            con.Open()
    '                                        End If
    '                                        Dim isMultiUse As Integer = Convert.ToInt32(da.SelectCommand.ExecuteScalar())

    '                                        Dim CurrDoctype As String = dtfld1.Rows(j).Item("documenttype").ToString()
    '                                        Dim CurrFieldMapping As String = dtfld1.Rows(j).Item("fieldmapping").ToString()

    '                                        Dim qry As String = ""
    '                                        Dim MTids As String = ""
    '                                        If UCase(arr(0).ToString()) <> "CHILD" And UCase(arr(0).ToString) <> "STATIC" And UCase(arr(0).ToString) <> "SESSION" Then
    '                                            da.SelectCommand.CommandType = CommandType.Text
    '                                            da.SelectCommand.CommandText = "SELECT SUBSTRING((SELECT ',' + CONVERT(NVARCHAR," & CurrFieldMapping & ")  FROM " & TABLENAME & " where EID=" & HttpContext.Current.Session("eid") & " and documenttype='" & CurrDoctype & "'" & " FOR XML PATH('')),2,1000) AS CSV"
    '                                            MTids = Convert.ToString(da.SelectCommand.ExecuteScalar())
    '                                        End If
    '                                        ''ends  for multiuse of document by sp on 08_apr_15


    '                                        If tids.Length >= 2 Then
    '                                            xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                        ElseIf tids = "0" Then
    '                                            pnlFields.Visible = False
    '                                            btnActEdit.Visible = False
    '                                            UpdatePanel1.Update()
    '                                            xwhr = ""
    '                                        End If
    '                                        '' new by sunil for pre role data filter 22-feb
    '                                        If Rtids <> "" Then
    '                                            If xwhr.ToString = "" Then
    '                                                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & Rtids & ")"
    '                                            Else
    '                                                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & "," & Rtids & ")"
    '                                            End If
    '                                        End If

    '                                        '' new by sunil for multiuse of docs
    '                                        If MTids.Length > 2 And isMultiUse = 1 Then
    '                                            If Right(MTids, 1) = "," Then
    '                                                MTids = Left(MTids, Len(MTids) - 1)
    '                                            End If
    '                                            xwhr = xwhr & " AND CONVERT(NVARCHAR(10),TID) not IN (" & MTids & ") "
    '                                        End If
    '                                        '' new by sunil for multiuse of docs

    '                                        str1 = str1 & "  AND M.isauth>0 " & xwhr & " order by " & arr(2).ToString()
    '                                        'Dim documenttype2 As String = arr1(1).ToString()
    '                                        'Dim fieldmping2 As String = arr1(2).ToString()
    '                                        'pnlFields.Controls.Add(ddl)
    '                                        Dim dt2 As New DataTable
    '                                        'oda.SelectCommand.CommandText = "select " & fieldmping2 & " from " & TABLENAME & " where EID=" & HttpContext.Current.Session("EID") & " and documenttype = '" & documenttype2 & "'"

    '                                        If str1.Length > 0 Then
    '                                            pnlFields.Controls.Add(ddl)
    '                                            od.SelectCommand.CommandText = str1
    '                                            od.Fill(dt2)
    '                                            Dim isAddJquery As Integer = 0
    '                                            ddl.Items.Add("Select")
    '                                            ddl.Items(0).Value = "0"
    '                                            For JK As Integer = 0 To dt2.Rows.Count - 1
    '                                                ddl.Items.Add(dt2.Rows(JK).Item(0).ToString())
    '                                                Dim lookddlVal As String = dt2.Rows(JK).Item(1).ToString()
    '                                                ddl.Items(JK + 1).Value = lookddlVal
    '                                            Next
    '                                            dt2.Dispose()
    '                                        End If
    '                                        If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                            ddl.Enabled = True
    '                                        Else
    '                                            ddl.Enabled = False
    '                                        End If
    '                                    End If
    '                                Next
    '                                row.Cells(j).Controls.Add(ddl)

    '                            ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
    '                                Dim txtBox As New FileUpload

    '                                'Prashant 30-6-2014
    '                                Dim txtBox1 As New HiddenField

    '                                Dim lbl1 As New Label
    '                                lbl1.ID = "lblf_" & FldID
    '                                lbl1.Text = ""
    '                                lbl1.ClientIDMode = ClientIDMode.Static

    '                                txtBox1.ID = "hdn_" & FldID
    '                                txtBox1.Value = ""
    '                                txtBox1.ClientIDMode = ClientIDMode.Static
    '                                If Not Request.QueryString("TID") Is Nothing Then
    '                                    txtBox.Attributes.Add("onchange", "UtilJs.UploadFile1(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
    '                                Else
    '                                    txtBox.Attributes.Add("onchange", "UtilJs.UploadFile(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
    '                                End If



    '                                txtBox.ID = "fld_" & FldID & "_" & row.RowIndex  ' added  id  with _ by balli
    '                                txtBox.CssClass = "txtBox"

    '                                txtBox.Width = 180


    '                                Dim hdnflag As New HiddenField
    '                                If Not Request.QueryString("TID") Is Nothing Then
    '                                    hdnflag.ID = "hdnf_" & FldID
    '                                    hdnflag.Value = "0"
    '                                    Dim str As String = row.Cells(j).Text

    '                                    str = After(str, "/")

    '                                    txtBox1.Value = str 'row.Cells(j).Text
    '                                    lbl1.Text = str ' row.Cells(j).Text
    '                                    row.Cells(j).Text = str
    '                                End If
    '                                If ViewState("chkadd") = 1 Then
    '                                    j = j + 1
    '                                End If
    '                                row.Cells(j).Controls.Add(txtBox)
    '                                'Prashant 30-6-2014
    '                                row.Cells(j).Controls.Add(txtBox1)
    '                                row.Cells(j).Controls.Add(lbl1)
    '                                row.Cells(j).Controls.Add(hdnflag)

    '                                Dim pstback As New PostBackTrigger
    '                                pstback.ControlID = btnActEdit.ID
    '                                UpdatePanel1.Triggers.Add(pstback)

    '                            End If
    '                            If ViewState("chkadd") = 1 Then
    '                                j = j - 1    ' added for incremental 
    '                            End If
    '                        End If

    '                    Next
    '                End If
    '            End If
    '        End If
    '    Catch ex As Exception

    '    End Try
    'End Sub


    Protected Sub gvData_InlineEdit(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewRowEventArgs)
        Try
            Dim fn As String = ""
            Dim objDC As New DataClass
            'Dim dtFld1 As DataTable = ViewState(fn) ' Session(fn)
            Dim dtfld1 As DataTable '= ViewState(fn)
            Dim row As GridViewRow = e.Row

            Dim fns() As String = Session("FNS").ToString.Split(":")
            'Dim GV As GridView = 
            Dim GID As String = row.Parent.Parent.ID
            GID = Right(GID, GID.Length - 3)
            'Prashant 30-6-2014
            Session("GRDID") = GID
            '' new added for hiding tid - on 27 dec 8.30 pm by sp
            e.Row.Cells(e.Row.Cells.Count - 1).Visible = False

            For I As Integer = 0 To fns.Length - 1
                If fns(I).ToString = GID.ToString Then
                    fn = fns(I - 1).ToString
                    Exit For
                End If
            Next
            dtfld1 = Session("D" & fn)
            For m As Integer = 0 To row.Cells.Count - 1
                row.Cells(m).HorizontalAlign = HorizontalAlign.Center
                row.Cells(m).Width = 15
            Next

            'Dim chkadd As Integer = 0

            If row.RowType = DataControlRowType.Header Then  ' for header bind checkbox to check all in grid 
                If row.Cells(0).Text = "All" Then
                    Dim chk As New CheckBox
                    chk.Text = "All"
                    chk.Attributes.Add("onclick", "javascript:checkAll('" & GID & "');")
                    row.Cells(0).Controls.Add(chk)
                    ViewState("chkadd") = 1
                End If
                If row.Cells(e.Row.Cells.Count - 2).Text = "cmasterTid" Then
                    ViewState("cmasterId") = 1
                    row.Cells(e.Row.Cells.Count - 2).Visible = False
                End If

                For i As Integer = 0 To row.Cells.Count - 1
                    If row.Cells(i).Text.ToUpper = "TID" Then
                        row.Cells(i).Visible = False
                        ViewState("Tid") = i
                    End If
                Next
            End If

            If row.RowType = DataControlRowType.DataRow Then
                ' For j As Integer = 0 To row.Cells.Count - 1
                If ViewState("cmasterId") = 1 Then 'by neha thakar to hide CmasterId  
                    row.Cells(row.Cells.Count - 2).Visible = False
                End If

                If Not IsNothing(ViewState("Tid")) Then
                    row.Cells(Convert.ToInt32(ViewState("Tid"))).Visible = False
                End If

                Dim controlWdth As Integer = 100
                If row.Cells(0).Text.ToUpper <> "TOTAL" Then
                    If ViewState("chkadd") = 1 Then  'this is for adding child check box 
                        Dim chk As New CheckBox
                        chk.ID = "fld" & row.RowIndex
                        row.Cells(0).Controls.Add(chk)
                    End If
                    'By Neha Thakar 23-01-15
                    ' To add new row when add Data Button is clicked in Child item
                    If Not IsNothing(Session("FilterAddedRow")) Then
                        Session("AddedRow") = Session("FilterAddedRow")
                    End If
                    Dim DICT As New Dictionary(Of Integer, Integer)
                    DICT = CType(Session("AddedRow"), Dictionary(Of Integer, Integer))

                    If Not IsNothing(DICT) Then

                        If Not IsNothing(Session("AddedRow")) And DICT.ContainsKey(row.RowIndex) Then
                            Dim filterRows() As DataRow 'By neha Thakar 
                            filterRows = dtfld1.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''", "InLineEditing, DisplayOrder")
                            'filterRows = dtfld1.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''", "InLineEditing, DisplayOrder")
                            dtfld1 = filterRows.CopyToDataTable()

                            Dim filterRows1() As DataRow
                            Dim filterRows2() As DataRow
                            filterRows1 = dtfld1.Select("inlinemapping is not null and inlinemapping <>''", "DisplayOrder")
                            filterRows2 = dtfld1.Select("InLineEditing=1 and inlinemapping is null", "DisplayOrder")
                            If filterRows.Length > 0 Then
                                If filterRows1.Length > 0 Then
                                    dtfld1 = filterRows1.CopyToDataTable()
                                    If filterRows2.Length > 0 Then
                                        dtfld1.Merge(filterRows2.CopyToDataTable())
                                    End If
                                Else
                                    If filterRows2.Length > 0 Then
                                        dtfld1 = filterRows2.CopyToDataTable()
                                    End If
                                End If

                            Else
                                dtfld1 = filterRows2.CopyToDataTable()
                            End If

                            For l As Integer = 0 To dtfld1.Rows.Count - 1
                                Dim colValue As String = row.DataItem(l).ToString()
                                Dim ftype1 As String = dtfld1.Rows(l).Item("fieldtype").ToString()
                                Dim ilEdit1 As Integer = dtfld1.Rows(l).Item("inlineEditing").ToString()
                                Dim datatype1 As String = dtfld1.Rows(l).Item("datatype").ToString() 'Prashant_10_7
                                Dim controlWdth1 As Integer = 100

                                Dim FldID1 As String = dtfld1.Rows(l).Item("fieldid").ToString()
                                Dim Formula1 = Convert.ToString(dtfld1.Rows(l).Item("cal_text"))
                                Dim DisplayName1 = Convert.ToString(dtfld1.Rows(l).Item("DisplayName"))
                                ' If ilEdit1 = 1 Then
                                If ftype1.ToUpper() = "TEXT BOX" Or ftype1.ToUpper() = "CALCULATIVE FIELD" Or ftype1.ToUpper() = "LOOKUP" Or ftype1.ToUpper() = "PARENT VALUE" Then
                                    Dim cb As New TextBox
                                    'cb.ID = "fld" & l.ToString() & "_" & row.RowIndex
                                    cb.Width = 55
                                    cb.ID = "fld" & FldID1 & row.RowIndex

                                    'Prashant_10_7
                                    If dtfld1.Rows(l).Item("defaultfieldval").ToString().Length > 0 Then
                                        cb.Text = dtfld1.Rows(l).Item("defaultfieldval").ToString()
                                    Else
                                        If datatype1.ToUpper() = "NUMERIC" Then
                                            cb.Text = "0"
                                        End If
                                    End If
                                    If Val(dtfld1.Rows(l).Item("isDescription").ToString()) = 1 Then
                                        cb.ToolTip = dtfld1.Rows(l).Item("Description").ToString()
                                    End If
                                    'If dtfld1.Rows(l).Item("iseditable") = 0 Then
                                    '    cb.Attributes.Add("READONLY", "READONLY")
                                    '    cb.Attributes.Add("COLOR", "GRAY")
                                    'End If


                                    If ftype1.ToUpper() = "CALCULATIVE FIELD" Then
                                        colValue = "0"
                                        cb.Attributes.Add("READONLY", "READONLY")
                                        cb.Attributes.Add("COLOR", "GRAY")
                                    End If

                                    If ViewState("chkadd") = 1 Then
                                        l = l + 1
                                    End If

                                    If ftype1.ToUpper() = "LOOKUP" Then
                                        If datatype1.ToUpper() = "NUMERIC" Then
                                            colValue = "0"
                                        End If
                                    Else
                                        If Val(colValue) = 0 Then
                                            If ftype1.ToUpper() = "TEXT BOX" And datatype1.ToUpper() = "NUMERIC" Then
                                                colValue = "0"
                                            End If
                                        End If
                                    End If

                                    If Not row.Cells(l).Text.Trim = "&nbsp;" And Not row.Cells(l).Text.Trim = "" Then
                                        colValue = row.Cells(l).Text.Trim
                                    End If

                                    cb.Text = colValue
                                    cb.Width = controlWdth1
                                    row.Cells(l).Controls.Add(cb)

                                    If datatype1.ToUpper.Trim = "DATETIME" Then
                                        If Convert.ToString(dtfld1.Rows(l).Item("iseditable")) = "1" Then
                                            Dim CLNDR As New AjaxControlToolkit.CalendarExtender
                                            CLNDR.Controls.Clear()
                                            CLNDR.ID = "CLNDR" & dtfld1.Rows(l).Item("FieldID").ToString()
                                            CLNDR.Format = "dd/MM/yy"
                                            CLNDR.TargetControlID = cb.ID
                                            cb.Enabled = True
                                            If Request.QueryString("TID") Is Nothing Then
                                                cb.Text = String.Format("{0:dd/MM/yy}", Date.Now())
                                            End If

                                            row.Cells(l).Controls.Add(CLNDR) '
                                        End If

                                    End If

                                    If Not Formula1 Is Nothing And Formula1 <> "" Then
                                        'Dim arrFor As String() = Formula.Split(",")
                                        Dim jScript = GenerateJQueryScript(dtfld1, GID, row.RowIndex, Formula1, FldID1)
                                        If jScript <> "" Then
                                            cb.Attributes.Add("onblur", jScript)
                                        End If
                                    End If
                                    If Val(dtfld1.Rows(l).Item("HasRule").ToString()) = 1 Then
                                        cb.AutoPostBack = True
                                        AddHandler cb.TextChanged, AddressOf grdTextBoxRule_TextChanged
                                    End If




                                ElseIf ftype1.ToUpper() = "AUTOCOMPLETE" Then

                                    Dim txtbox As New TextBox
                                    txtbox.ID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
                                    txtbox.Width = controlWdth - 10
                                    txtbox.CssClass = "txtBox"
                                    txtbox.Attributes.Add("placeholder", "Please begin typing a " & DisplayName1)

                                    txtbox.AutoPostBack = True
                                    AddHandler txtbox.TextChanged, AddressOf txtbox_TextChanged
                                    ' adding handler for binding lookup or other dropdown or filter

                                    Dim autofilExtender As New AjaxControlToolkit.AutoCompleteExtender
                                    autofilExtender.ID = "extenderID" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex

                                    autofilExtender.TargetControlID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
                                    autofilExtender.ServiceMethod = "GetCompletionList" ' THIS SERVICE METHOD IS WRITTEN ON DOCUMENT PAGE 
                                    autofilExtender.DelimiterCharacters = ""
                                    autofilExtender.ContextKey = dtfld1.Rows(l).Item("DROPDOWN").ToString() & "-" & dtfld1.Rows(l).Item("FieldID").ToString() & "-" & dtfld1.Rows(l).Item("DROPDOWNTYPE").ToString() & "-" & dtfld1.Rows(l).Item("AUTOFILTER").ToString() & "-" & dtfld1.Rows(l).Item("InitialFilter").ToString()
                                    'context key contain  : dropdown-fieldid-dropdowntype-autofilter-InitialFilter' adding the fieldid in context key because later on we need id of field in web method 
                                    autofilExtender.Enabled = True
                                    autofilExtender.CompletionSetCount = 5
                                    autofilExtender.OnClientShown = "onDataShown"  ' by sunil
                                    '   autofilExtender.CompletionListElementID = "ACsugestlist"
                                    autofilExtender.MinimumPrefixLength = 1  ' start searching when entered one characters
                                    'autofilExtender.OnClientItemSelected = "ace_itemSelected('" & ds.Rows(i).Item("FieldID").ToString() & "')"
                                    autofilExtender.OnClientItemSelected = "ace_itemSelected"
                                    row.Cells(l).Controls.Add(txtbox)
                                    'pnlFields.Controls.Add(txtbox)

                                    Dim hdnfld As New HiddenField
                                    hdnfld.ID = "HDN" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
                                    row.Cells(l).Controls.Add(hdnfld)
                                    'pnlFields.Controls.Add(img)
                                    'pnlFields.Controls.Add(prgBar)
                                    row.Cells(l).Controls.Add(autofilExtender)
                                    'pnlFields.Controls.Add(autofilExtender)

                                ElseIf ftype1.ToUpper() = "FORMULA FIELD" Then
                                    Dim txtBox As New TextBox
                                    txtBox.ID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
                                    txtBox.Width = controlWdth - 10
                                    txtBox.CssClass = "txtBox"
                                    If dtfld1.Rows(l).Item("isEditable").ToString() = "1" Then
                                        txtBox.Enabled = True
                                    Else
                                        txtBox.Enabled = False
                                    End If

                                    If ViewState("chkadd") = 1 Then
                                        l = l + 1
                                    End If
                                    If Not row.Cells(l).Text = "" And Not row.Cells(l).Text = "&nbsp;" Then
                                        txtBox.Text = row.Cells(l).Text
                                    Else
                                        txtBox.Text = "0"
                                    End If

                                    row.Cells(l).Controls.Add(txtBox)

                                ElseIf ftype1.ToUpper() = "TEXT AREA" Then
                                    Dim txtBox As New TextBox
                                    txtBox.ID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
                                    txtBox.Width = controlWdth + 50
                                    txtBox.Height = 50
                                    txtBox.TextMode = TextBoxMode.MultiLine
                                    txtBox.Columns = 4
                                    txtBox.Rows = 10
                                    txtBox.CssClass = "txtBox"
                                    If dtfld1.Rows(l).Item("isEditable").ToString() = "1" Then
                                        txtBox.Enabled = True
                                    Else
                                        txtBox.Enabled = False
                                    End If

                                    If ViewState("chkadd") = 1 Then
                                        l = l + 1
                                    End If
                                    If Not row.Cells(l).Text = "" And Not row.Cells(l).Text = "&nbsp;" Then
                                        txtBox.Text = row.Cells(l).Text
                                    End If

                                    row.Cells(l).Controls.Add(txtBox)

                                ElseIf ftype1.ToUpper() = "MULTI LOOKUP" Then
                                    Dim txtBox As New TextBox
                                    txtBox.ID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
                                    txtBox.Width = controlWdth - 10
                                    txtBox.CssClass = "txtBox"
                                    If dtfld1.Rows(l).Item("isEditable").ToString() = "1" Then
                                        txtBox.Enabled = True
                                    Else
                                        txtBox.Enabled = False
                                    End If

                                    If ViewState("chkadd") = 1 Then
                                        l = l + 1
                                    End If
                                    If Not row.Cells(l).Text = "" And Not row.Cells(l).Text = "&nbsp;" Then
                                        txtBox.Text = row.Cells(l).Text
                                    End If

                                    row.Cells(l).Controls.Add(txtBox)

                                ElseIf ftype1.ToUpper() = "MULTI LOOKUPDDL" Then

                                    Dim ddl As New DropDownList
                                    ddl.ID = "fld" & FldID1 & "_" & row.RowIndex
                                    ddl.CssClass = "txtBox"
                                    ddl.Width = 150

                                    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
                                    Dim con As SqlConnection = New SqlConnection(conStr)
                                    Dim ddlText As String = dtfld1.Rows(l).Item("dropdown").ToString()
                                    Dim od As SqlDataAdapter = New SqlDataAdapter("", con)
                                    Dim dt As New DataTable
                                    Dim dtval As New DataTable
                                    Dim fieldid As String()
                                    Dim ddlval As String()
                                    If (ddlText.ToString() <> String.Empty) Then
                                        fieldid = ddlText.ToString().Split(",")
                                        'With(nolock) added by Himank on 29th sep 2015
                                        od.SelectCommand.CommandText = "select ddlMultilookupval from mmm_mst_fields  WITH(NOLOCK)  where fieldid = " & fieldid(0).ToString() & ""
                                        od.Fill(dtval)
                                        If (dtval.Rows.Count > 0) Then
                                            ddlval = dtval.Rows(0)("ddlMultilookupval").ToString().Split(",")
                                            For q As Integer = 0 To ddlval.Length - 1
                                                If (ddlval(q).ToString().Contains("-" & dtfld1.Rows(l).Item("FieldID").ToString())) Then
                                                    Dim temp() As String = ddlval(q).ToString().Split("-")
                                                    'With(nolock) added by Himank on 29th sep 2015
                                                    od.SelectCommand.CommandText = "select * from MMM_MST_FIELDS  WITH(NOLOCK)  where DOCUMENTTYPE='" & temp(0).ToString() & "' and eid=" & HttpContext.Current.Session("EID") & " and fieldmapping in('" & temp(1).ToString() & "')"
                                                    Dim checkval As New DataTable
                                                    od.Fill(checkval)
                                                    Dim ddlText1 As String = checkval.Rows(0).Item("dropdown").ToString()
                                                    Dim dropdowntype As String = checkval.Rows(0).Item("dropdowntype").ToString()
                                                    Dim arr() As String
                                                    If UCase(dropdowntype) = "MASTER VALUED" Then
                                                        Dim ob As New DynamicForm
                                                        arr = ddlText1.Split("-")
                                                        Dim TID As String = "TID"
                                                        Dim TABLENAME As String = ""
                                                        If UCase(arr(0).ToString()) = "MASTER" Then
                                                            TABLENAME = "MMM_MST_MASTER"
                                                        ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
                                                            TABLENAME = "MMM_MST_DOC"
                                                        ElseIf UCase(arr(0).ToString()) = "CHILD" Then
                                                            TABLENAME = "MMM_MST_DOC_ITEM"
                                                        ElseIf UCase(arr(0).ToString) = "STATIC" Then
                                                            If arr(1).ToString.ToUpper = "USER" Then
                                                                TABLENAME = "MMM_MST_USER"
                                                                TID = "UID"
                                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
                                                                TABLENAME = "MMM_MST_LOCATION"
                                                                TID = "LOCID"
                                                            End If
                                                        End If
                                                        Dim lookUpqry As String = ""
                                                        Dim str As String = ""
                                                        'With(nolock) added by Himank on 29th sep 2015
                                                        If arr(0).ToUpper() = "CHILD" Then
                                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
                                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                                        Else
                                                            If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
                                                                str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
                                                            Else
                                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                                            End If
                                                        End If

                                                        Dim xwhr As String = ""
                                                        Dim tids As String = ""
                                                        'Dim tidarr() As String

                                                        ''FILTER THE DATA ACCORDING TO USER 
                                                        tids = ob.UserDataFilter(dtfld1.Rows(l).Item("documenttype").ToString(), arr(1).ToString())

                                                        If tids.Length >= 2 Then
                                                            'tidarr = tids.Split("-")
                                                            xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
                                                        ElseIf tids = "0" Then
                                                            pnlFields.Visible = False
                                                            btnActEdit.Visible = False
                                                            UpdatePanel1.Update()
                                                            xwhr = ""
                                                        End If
                                                        str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                                        Dim AutoFilter As String = dtfld1.Rows(l).Item("AutoFilter").ToString()
                                                        If AutoFilter.Length > 0 Then
                                                            If arr(0).ToUpper() = "CHILD" Then
                                                                If AutoFilter.ToUpper = "DOCID" Then
                                                                    str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
                                                                Else
                                                                    str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
                                                                End If
                                                                'With(nolock) added by Himank on 29th sep 2015
                                                            ElseIf arr(0).ToUpper() <> "STATIC" Then
                                                                str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                                                str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                                            Else
                                                                str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " "
                                                                str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                                            End If
                                                        End If


                                                        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
                                                        Dim dss As New DataSet
                                                        If str.Length > 0 Then
                                                            oda.SelectCommand.CommandText = str
                                                            oda.Fill(dss, "FV")
                                                            Dim isAddJquery As Integer = 0
                                                            ddl.Items.Add("Select")
                                                            ddl.Items(0).Value = "0"
                                                            For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
                                                                ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
                                                                Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
                                                                ddl.Items(J1 + 1).Value = lookddlVal
                                                            Next
                                                            oda.Dispose()
                                                            dss.Dispose()
                                                            'prashant_2_7

                                                            Dim lookupvalue As String = dtfld1.Rows(l).Item("lookupvalue").ToString()
                                                            Dim multilookup As String = dtfld1.Rows(l).Item("multilookUpVal").ToString()

                                                            If lookupvalue.Length > 0 Or multilookup.Length > 0 Then
                                                                ddl.AutoPostBack = True
                                                                AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged
                                                            End If

                                                            If ddl.Items.FindByText(row.Cells(l).Text) IsNot Nothing Then
                                                                ddl.Items.FindByText(row.Cells(l).Text).Selected = True
                                                            End If
                                                            If ViewState("chkadd") = 1 Then
                                                                l = l + 1
                                                            End If

                                                            If ddl.Items.FindByText(row.Cells(l).Text) IsNot Nothing Then
                                                                'ddl.Items.FindByText(row.Cells(j).Text).Selected = True
                                                                ddl.SelectedValue = ddl.Items.FindByText(row.Cells(l).Text).Value
                                                            End If
                                                            row.Cells(l).Controls.Add(ddl)
                                                            If isAddJquery = 1 Then
                                                                Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
                                                            End If
                                                        End If
                                                        con.Dispose()
                                                        oda.Dispose()
                                                        dss.Dispose()
                                                    ElseIf UCase(dropdowntype) = "SESSION VALUED" Then

                                                    End If
                                                End If
                                            Next
                                        End If
                                    End If

                                ElseIf ftype1.ToUpper() = "DROP DOWN" Then
                                    Dim ddl As New DropDownList

                                    ddl.ID = "fld" & FldID1 & "_" & row.RowIndex
                                    ddl.CssClass = "txtBox"
                                    ddl.Width = 150
                                    Dim ddlText As String = dtfld1.Rows(l).Item("dropdown").ToString()
                                    Dim dropdowntype As String = dtfld1.Rows(l).Item("dropdowntype").ToString()
                                    Dim arr() As String
                                    If dtfld1.Rows(l).Item("dropdowntype").ToString() = "FIX VALUED" Then
                                        'Dim cb As New DropDownList
                                        ' cb.ID = "fld" & FldID & row.RowIndex
                                        ddl.Items.Add("Select")
                                        ddl.Items(0).Value = "0"

                                        Dim ARR1() As String = dtfld1.Rows(l).Item("dropdown").ToString().Split(",")
                                        For K As Integer = 0 To ARR1.Length - 1
                                            ddl.Items.Add(ARR1(K).ToString)
                                        Next

                                        If ViewState("chkadd") = 1 Then
                                            l = l + 1
                                        End If

                                        '' for default value selection
                                        'If dtfld1.Rows(l).Item("ddlval").ToString().Length > 1 Then
                                        '    Dim dropdowntypeFill As String = ds.Rows(l).Item("ddlval").ToString().ToUpper()
                                        '    ddl.SelectedIndex = ddl.Items.IndexOf(ddl.Items.FindByText(dropdowntypeFill))
                                        'End If

                                        If ddl.Items.FindByText(row.Cells(l).Text) IsNot Nothing Then
                                            ddl.Items.FindByText(row.Cells(l).Text).Selected = True
                                        End If

                                        row.Cells(l).Controls.Add(ddl)
                                        'Prashant_10_7
                                        If dtfld1.Rows(l).Item("iseditable") = 1 Then
                                            ddl.Enabled = True
                                        Else
                                            ddl.Enabled = False
                                        End If


                                    ElseIf dtfld1.Rows(l).Item("dropdowntype").ToString() = "MASTER VALUED" Then
                                        '' code for getting master valued 
                                        Dim ob As New DynamicForm
                                        arr = ddlText.Split("-")
                                        Dim TID As String = "TID"
                                        Dim TABLENAME As String = ""
                                        If UCase(arr(0).ToString()) = "MASTER" Then
                                            TABLENAME = "MMM_MST_MASTER"
                                        ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
                                            TABLENAME = "MMM_MST_DOC"
                                        ElseIf UCase(arr(0).ToString()) = "CHILD" Then
                                            TABLENAME = "MMM_MST_DOC_ITEM"
                                        ElseIf UCase(arr(0).ToString) = "STATIC" Then
                                            If arr(1).ToString.ToUpper = "USER" Then
                                                TABLENAME = "MMM_MST_USER"
                                                TID = "UID"
                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
                                                TABLENAME = "MMM_MST_LOCATION"
                                                TID = "LOCID"
                                            End If
                                        End If


                                        Dim lookUpqry As String = ""
                                        Dim str As String = ""
                                        'With(nolock) added by Himank on 29th sep 2015
                                        If arr(0).ToUpper() = "CHILD" Then
                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M   WITH(NOLOCK) WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                        Else
                                            If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
                                                str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
                                            Else
                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                            End If
                                        End If

                                        Dim xwhr As String = ""
                                        Dim tids As String = ""
                                        'Dim tidarr() As String

                                        ''FILTER THE DATA ACCORDING TO USER 
                                        tids = ob.UserDataFilter(dtfld1.Rows(l).Item("documenttype").ToString(), arr(1).ToString())

                                        If tids.Length >= 2 Then
                                            'tidarr = tids.Split("-")
                                            xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
                                        ElseIf tids = "0" Then
                                            pnlFields.Visible = False
                                            btnActEdit.Visible = False
                                            UpdatePanel1.Update()
                                            xwhr = ""
                                        End If
                                        str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                        Dim AutoFilter As String = dtfld1.Rows(l).Item("AutoFilter").ToString()
                                        If AutoFilter.Length > 0 Then
                                            If arr(0).ToUpper() = "CHILD" Then
                                                If AutoFilter.ToUpper = "DOCID" Then
                                                    str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
                                                Else
                                                    str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
                                                End If
                                                'With(nolock) added by Himank on 29th sep 2015
                                            ElseIf arr(0).ToUpper() <> "STATIC" Then
                                                str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                                str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                            Else
                                                str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) WHERE EID=" & Session("EID") & " "
                                                str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                            End If
                                        End If

                                        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
                                        Dim con As SqlConnection = New SqlConnection(conStr)
                                        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
                                        Dim dss As New DataSet

                                        If str.Length > 0 Then
                                            oda.SelectCommand.CommandText = str
                                            oda.Fill(dss, "FV")
                                            Dim isAddJquery As Integer = 0
                                            ddl.Items.Add("Select")
                                            ddl.Items(0).Value = "0"
                                            For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
                                                ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
                                                Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
                                                ddl.Items(J1 + 1).Value = lookddlVal
                                            Next
                                            oda.Dispose()
                                            dss.Dispose()
                                            'prashant_2_7

                                            Dim lookupvalue As String = dtfld1.Rows(l).Item("lookupvalue").ToString()
                                            Dim multilookup As String = dtfld1.Rows(l).Item("multilookUpVal").ToString()
                                            Dim ddlmultilookup As String = dtfld1.Rows(l).Item("ddlmultilookUpVal").ToString()
                                            'LT Lookupval changes
                                            Dim LTLookupval As String = Convert.ToString(dtfld1.Rows(l).Item("LTlookupval"))
                                            If lookupvalue.Length > 0 Or multilookup.Length > 0 Or ddlmultilookup.Length > 0 Or LTLookupval.Length > 0 Then
                                                ddl.AutoPostBack = True
                                                AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged

                                            End If

                                            ' '' new by sp on 18-nov-15 for Burgerking ticket
                                            'If Len(Convert.ToString(dtfld1.Rows(l).Item("ddlval"))) > 1 Then
                                            '    Dim DDldefaultVal As String = Convert.ToString(dtfld1.Rows(l).Item("ddlval"))
                                            '    ddl.SelectedIndex = ddl.Items.IndexOf(ddl.Items.FindByValue(DDldefaultVal))
                                            '    Dim id As String = Right(ddl.ID, ddl.ID.Length - 3)
                                            '    Dim ar() As String = id.Split("_")
                                            '    Dim id1 As Integer = CInt(ar(0))
                                            '    BindGRidLookup(ar(1), id1, ddl)
                                            '    Dim ob1 As New DynamicForm()
                                            '    ob1.GridMultiLookup(ar(1), id1, ddl, lblTab, pnlFields)
                                            '    ob1.GridLTLookup(ar(1), id1, ddl, lblTab, pnlFields)
                                            '    BindGRidLookupDDL(ar(1), id1, ddl)
                                            'End If
                                            ' '' new by sp on 18-nov-15 for Burgerking ticket - ends 
                                            ' '' below in for popups from dyn. form
                                            ''If ds.Rows(i).Item("ddlval").ToString().Length > 1 Then
                                            ''    Dim ddl As New DropDownList
                                            ''    ddl = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), DropDownList)
                                            ''    Dim dropdowntypeFill As String = ds.Rows(i).Item("ddlval").ToString().ToUpper().Trim()
                                            ''    ddl.SelectedIndex = ddl.Items.IndexOf(ddl.Items.FindByValue(dropdowntypeFill))
                                            ''    '''''For filling lookup and lookupddl according drop down'''''''
                                            ''    Dim id As String = Right(ddl.ID, ddl.ID.Length - 3)
                                            ''    Dim id1 As Integer = CInt(id)
                                            ''    bind(id, pnlFields, ddl)
                                            ''    bindlookupddl(id, pnlFields, ddl)
                                            ''End If


                                            If ddl.Items.FindByText(row.Cells(l).Text) IsNot Nothing Then
                                                ddl.Items.FindByText(row.Cells(l).Text).Selected = True
                                            End If
                                            If ViewState("chkadd") = 1 Then
                                                l = l + 1
                                            End If

                                            If ddl.Items.FindByText(row.Cells(l).Text) IsNot Nothing Then
                                                ddl.Items.FindByText(row.Cells(l).Text).Selected = True
                                            End If

                                            row.Cells(l).Controls.Add(ddl)

                                            If isAddJquery = 1 Then
                                                Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
                                            End If
                                        End If
                                        con.Dispose()
                                        oda.Dispose()
                                        dss.Dispose()
                                        '' ends here for getting master valued 
                                    End If

                                ElseIf ftype1.ToUpper() = "CHECKBOX LIST" Then
                                    Dim CHKlIST As New CheckBoxList()
                                    Dim dynmdiv As System.Web.UI.HtmlControls.HtmlGenericControl = New System.Web.UI.HtmlControls.HtmlGenericControl("DIV")
                                    dynmdiv.ID = "div_" & FldID1
                                    Dim ddlText As String = dtfld1.Rows(l).Item("dropdown").ToString()
                                    CHKlIST.ID = "fld" & FldID1 & "_" & row.RowIndex
                                    If dtfld1.Rows(l).Item("dropdowntype").ToString() = "FIX VALUED" Then
                                        Dim arr = ddlText.Split(",")
                                        For ii As Integer = 0 To arr.Count - 1
                                            CHKlIST.Items.Add(arr(ii).ToUpper())
                                        Next

                                    ElseIf dtfld1.Rows(l).Item("dropdowntype").ToString() = "MASTER VALUED" Then
                                        Dim arr = ddlText.Split("-")
                                        Dim TID As String = "TID"
                                        Dim TABLENAME As String = ""
                                        If UCase(arr(0).ToString()) = "MASTER" Then
                                            TABLENAME = "MMM_MST_MASTER"
                                        ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
                                            TABLENAME = "MMM_MST_DOC"
                                        ElseIf UCase(arr(0).ToString()) = "CHILD" Then
                                            TABLENAME = "MMM_MST_DOC_ITEM"
                                        ElseIf UCase(arr(0).ToString) = "STATIC" Then
                                            If arr(1).ToString.ToUpper = "USER" Then
                                                TABLENAME = "MMM_MST_USER"
                                                TID = "UID"
                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
                                                TABLENAME = "MMM_MST_LOCATION"
                                                TID = "LOCID"
                                            End If
                                        End If
                                        Dim lookUpqry As String = ""
                                        Dim str As String = ""
                                        'With(nolock) added by Himank on 29th sep 2015
                                        If arr(0).ToUpper() = "CHILD" Then
                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                        Else
                                            If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
                                                str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
                                            Else
                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                            End If
                                        End If
                                        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
                                        Dim con As SqlConnection = New SqlConnection(conStr)
                                        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
                                        oda = New SqlDataAdapter("", con)
                                        Dim dss As New DataSet
                                        oda.SelectCommand.CommandText = str
                                        oda.Fill(dss, "FV")
                                        For JJ As Integer = 0 To dss.Tables("FV").Rows.Count - 1
                                            CHKlIST.Items.Add(dss.Tables("FV").Rows(JJ).Item(0))
                                            CHKlIST.Items(JJ).Value = dss.Tables("FV").Rows(JJ).Item(1)
                                        Next
                                        oda.Dispose()
                                        dss.Dispose()
                                    End If

                                    dynmdiv.Style.Add(HtmlTextWriterStyle.Width, "200px")
                                    dynmdiv.Style.Add(HtmlTextWriterStyle.Height, "100px")
                                    dynmdiv.Style.Add(HtmlTextWriterStyle.Overflow, "Scroll")
                                    dynmdiv.Controls.Add(CHKlIST)
                                    row.Cells(l).Controls.Add(dynmdiv)



                                ElseIf ftype1.ToUpper = "LOOKUPDDL" Then

                                    ' DataType = dtfld1.Rows(j).Item("datatype").ToString().ToUpper()
                                    Dim fieldtypee As String = dtfld1.Rows(l).Item("FieldType").ToString().ToUpper()
                                    Dim ddl As New DropDownList
                                    ddl.ID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & "_" & row.RowIndex
                                    ddl.Width = controlWdth - 10
                                    ddl.CssClass = "txtBox"
                                    Dim ddlText As String = dtfld1.Rows(l).Item("dropdown").ToString()
                                    Dim dropdowntype As String = dtfld1.Rows(l).Item("dropdowntype").ToString()
                                    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
                                    Dim con As SqlConnection = New SqlConnection(conStr)
                                    'With(nolock) added by Himank on 29th sep 2015
                                    Dim od As SqlDataAdapter = New SqlDataAdapter("select dropdown,DDllookupvalue from MMM_MST_FIELDS  WITH(NOLOCK)  where FieldID='" & ddlText & "'", con)
                                    ' Dim dsMonth As New DataSet
                                    Dim dt As New DataTable
                                    od.Fill(dt)
                                    Dim arr() As String
                                    Dim darr() As String
                                    Dim type As String = dt.Rows(0).Item("dropdown").ToString()
                                    arr = type.Split("-")
                                    Dim documenttype As String = arr(1).ToString()
                                    Dim field As String = dt.Rows(0).Item("DDllookupvalue").ToString()
                                    field = field.Substring(0, field.Length - 1)
                                    darr = field.Split(",")
                                    For k As Integer = 0 To darr.Count - 1
                                        Dim fieldmping As String
                                        Dim str As String = ""
                                        Dim feild As String
                                        Dim s = darr(k).Split("-")
                                        feild = s(0).ToString()
                                        fieldmping = s(1).ToString()

                                        Dim TID As String = "TID"
                                        Dim TABLENAME As String = ""
                                        Dim str1 As String = ""
                                        Dim lookUpqry As String = ""

                                        Dim xwhr As String = ""
                                        Dim tids As String = ""
                                        Dim Rtids As String = ""   ' for prerole data filter

                                        If feild = dtfld1.Rows(l).Item("FieldID").ToString() Then
                                            'If arr(0) = "SESSION" And Not (fieldmping.Contains("fld")) Then
                                            '    If arr(1).ToString.ToUpper = "USER" Then
                                            '        TABLENAME = "MMM_MST_USER"
                                            '        TID = "UID"
                                            '    End If
                                            '    ' str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                            '    str1 = "select " & fieldmping.ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                            'Else

                                            'With(nolock) added by Himank on 29th sep 2015
                                            od.SelectCommand.CommandText = "select dropdown from MMM_MST_FIELDS  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("EID") & " and documenttype='" & documenttype & "' and FieldMapping in('" & fieldmping & "')"
                                            Dim dt1 As New DataTable
                                            od.Fill(dt1)
                                            Dim dropdown As String = dt1.Rows(0).Item("dropdown").ToString()
                                            arr = dropdown.Split("-")

                                            If UCase(arr(0).ToString()) = "MASTER" Then
                                                TABLENAME = "MMM_MST_MASTER"
                                            ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
                                                TABLENAME = "MMM_MST_DOC"
                                            ElseIf UCase(arr(0).ToString()) = "CHILD" Then
                                                TABLENAME = "MMM_MST_DOC_ITEM"
                                            ElseIf UCase(arr(0).ToString) = "STATIC" Then
                                                If arr(1).ToString.ToUpper = "USER" Then
                                                    TABLENAME = "MMM_MST_USER"
                                                    TID = "UID"
                                                ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
                                                    TABLENAME = "MMM_MST_LOCATION"
                                                    TID = "LOCID"
                                                End If
                                            ElseIf UCase(arr(0).ToString) = "SESSION" Then
                                                If arr(1).ToString.ToUpper = "USER" Then
                                                    TABLENAME = "MMM_MST_USER"
                                                    TID = "UID"
                                                ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
                                                    TABLENAME = "MMM_MST_LOCATION"
                                                    TID = "LOCID"
                                                End If
                                            End If
                                            'With(nolock) added by Himank on 29th sep 2015
                                            If arr(0).ToUpper() = "CHILD" Then
                                                str1 = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                            ElseIf arr(0).ToUpper() = "SESSION" Then
                                                str1 = "Select " & IIf(arr(1).ToString.ToUpper = "USER", "UserName, ", "LocationName, ") & TID & " from " & TABLENAME & " M  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("EID") & " AND " & arr(2) & "='" & HttpContext.Current.Session(arr(2)) & "'"
                                            ElseIf arr(0).ToUpper() <> "STATIC" Then
                                                str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                            Else
                                                If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
                                                    str1 = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
                                                Else
                                                    str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                                End If
                                            End If
                                            '  End If

                                            'Dim tidarr() As String

                                            ''FILTER THE DATA ACCORDING TO USER 
                                            Dim ob = New DynamicForm()
                                            tids = ob.UserDataFilter(dtfld1.Rows(l).Item("documenttype").ToString(), arr(1).ToString())
                                            Rtids = ob.UserDataFilter_PreRole(arr(1).ToString(), TABLENAME)  '' new by sunil for pre role data filter 22-feb

                                            '' for multiuse of document by sp on 08_apr_15
                                            Dim Sdtype As String = arr(1).ToString
                                            Dim da As SqlDataAdapter = New SqlDataAdapter("", con)
                                            da.SelectCommand.CommandType = CommandType.Text
                                            'With(nolock) added by Himank on 29th sep 2015
                                            da.SelectCommand.CommandText = "select isnull(Allowmultiuse,0) from mmm_mst_forms   WITH(NOLOCK) where eid='" & HttpContext.Current.Session("EID").ToString & "' AND FORMNAME='" & Sdtype & "'"
                                            If con.State <> ConnectionState.Open Then
                                                con.Open()
                                            End If
                                            Dim isMultiUse As Integer = Convert.ToInt32(da.SelectCommand.ExecuteScalar())

                                            Dim CurrDoctype As String = dtfld1.Rows(l).Item("documenttype").ToString()
                                            Dim CurrFieldMapping As String = dtfld1.Rows(l).Item("fieldmapping").ToString()

                                            Dim qry As String = ""
                                            Dim MTids As String = ""
                                            If UCase(arr(0).ToString()) <> "CHILD" And UCase(arr(0).ToString) <> "STATIC" And UCase(arr(0).ToString) <> "SESSION" Then
                                                da.SelectCommand.CommandType = CommandType.Text
                                                da.SelectCommand.CommandText = "SELECT SUBSTRING((SELECT ',' + CONVERT(NVARCHAR," & CurrFieldMapping & ")  FROM " & TABLENAME & " where EID=" & HttpContext.Current.Session("eid") & " and documenttype='" & CurrDoctype & "'" & " FOR XML PATH('')),2,1000) AS CSV"
                                                MTids = Convert.ToString(da.SelectCommand.ExecuteScalar())
                                            End If
                                            ''ends  for multiuse of document by sp on 08_apr_15


                                            If tids.Length >= 2 Then
                                                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
                                            ElseIf tids = "0" Then
                                                pnlFields.Visible = False
                                                btnActEdit.Visible = False
                                                UpdatePanel1.Update()
                                                xwhr = ""
                                            End If
                                            '' new by sunil for pre role data filter 22-feb
                                            If Rtids <> "" Then
                                                If xwhr.ToString = "" Then
                                                    xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & Rtids & ")"
                                                Else
                                                    xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & "," & Rtids & ")"
                                                End If
                                            End If

                                            '' new by sunil for multiuse of docs
                                            If MTids.Length > 2 And isMultiUse = 1 Then
                                                If Right(MTids, 1) = "," Then
                                                    MTids = Left(MTids, Len(MTids) - 1)
                                                End If
                                                xwhr = xwhr & " AND CONVERT(NVARCHAR(10),TID) not IN (" & MTids & ") "
                                            End If
                                            '' new by sunil for multiuse of docs

                                            str1 = str1 & "  AND M.isauth>0 " & xwhr & " order by " & arr(2).ToString()
                                            'Dim documenttype2 As String = arr1(1).ToString()
                                            'Dim fieldmping2 As String = arr1(2).ToString()
                                            'pnlFields.Controls.Add(ddl)
                                            Dim dt2 As New DataTable
                                            'oda.SelectCommand.CommandText = "select " & fieldmping2 & " from " & TABLENAME & " where EID=" & HttpContext.Current.Session("EID") & " and documenttype = '" & documenttype2 & "'"

                                            If str1.Length > 0 Then
                                                pnlFields.Controls.Add(ddl)
                                                od.SelectCommand.CommandText = str1
                                                od.Fill(dt2)
                                                Dim isAddJquery As Integer = 0
                                                ddl.Items.Add("Select")
                                                ddl.Items(0).Value = "0"
                                                For JK As Integer = 0 To dt2.Rows.Count - 1
                                                    ddl.Items.Add(dt2.Rows(JK).Item(0).ToString())
                                                    Dim lookddlVal As String = dt2.Rows(JK).Item(1).ToString()
                                                    ddl.Items(JK + 1).Value = lookddlVal
                                                Next
                                                dt2.Dispose()
                                            End If
                                            If dtfld1.Rows(l).Item("isEditable").ToString() = "1" Then
                                                ddl.Enabled = True
                                            Else
                                                ddl.Enabled = False
                                            End If
                                        End If
                                    Next

                                    row.Cells(l).Controls.Add(ddl)

                                ElseIf ftype1.ToUpper() = "FILE UPLOADER" Then
                                    Dim txtBox As New FileUpload

                                    'Prashant 30-6-2014
                                    Dim txtBox1 As New HiddenField

                                    Dim lbl1 As New Label
                                    lbl1.ID = "lblf_" & FldID1
                                    lbl1.Text = ""
                                    lbl1.ClientIDMode = ClientIDMode.Static

                                    txtBox1.ID = "hdn_" & FldID1
                                    txtBox1.Value = ""
                                    txtBox1.ClientIDMode = ClientIDMode.Static
                                    If Not Request.QueryString("TID") Is Nothing Then
                                        txtBox.Attributes.Add("onchange", "UtilJs.UploadFile1(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
                                    Else
                                        txtBox.Attributes.Add("onchange", "UtilJs.UploadFile(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
                                    End If

                                    txtBox.ID = "fld_" & FldID1 & "_" & row.RowIndex  ' added  id  with _ by balli
                                    txtBox.CssClass = "txtBox"

                                    txtBox.Width = 180


                                    Dim hdnflag As New HiddenField
                                    If Not Request.QueryString("TID") Is Nothing Then
                                        hdnflag.ID = "hdnf_" & FldID1
                                        hdnflag.Value = "0"
                                        Dim str As String = row.Cells(l).Text

                                        str = After(str, "/")

                                        txtBox1.Value = str 'row.Cells(j).Text
                                        lbl1.Text = str ' row.Cells(j).Text
                                        row.Cells(l).Text = str
                                    End If
                                    If ViewState("chkadd") = 1 Then
                                        l = l + 1
                                    End If
                                    row.Cells(l).Controls.Add(txtBox)
                                    'Prashant 30-6-2014
                                    row.Cells(l).Controls.Add(txtBox1)
                                    row.Cells(l).Controls.Add(lbl1)
                                    row.Cells(l).Controls.Add(hdnflag)

                                    Dim pstback As New PostBackTrigger
                                    pstback.ControlID = btnActEdit.ID
                                    UpdatePanel1.Triggers.Add(pstback)

                                End If
                                If ViewState("chkadd") = 1 Then
                                    l = l - 1    ' added for incremental 
                                End If
                            Next
                        Else

                            Dim filterRows() As DataRow
                            filterRows = dtfld1.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''", "InLineEditing,DisplayOrder")
                            dtfld1 = filterRows.CopyToDataTable()

                            Dim filterRows1() As DataRow
                            Dim filterRows2() As DataRow
                            filterRows1 = dtfld1.Select("inlinemapping is not null and inlinemapping <>''", "DisplayOrder")
                            filterRows2 = dtfld1.Select("InLineEditing=1 and inlinemapping is null", "DisplayOrder")
                            If filterRows1.Length > 0 Then
                                dtfld1 = filterRows1.CopyToDataTable()
                                dtfld1.Merge(filterRows2.CopyToDataTable())
                            Else
                                dtfld1 = filterRows2.CopyToDataTable()
                            End If

                            For j As Integer = 0 To filterRows.Count - 1

                                Dim ftype As String = dtfld1.Rows(j).Item("fieldtype").ToString()

                                Dim datatype As String = dtfld1(j).Item("datatype").ToString() 'Prashant_10_7

                                Dim colValue As String = row.DataItem(j).ToString()
                                Dim ilEdit As Integer = dtfld1.Rows(j).Item("inlineEditing").ToString()
                                Dim FldID As String = dtfld1.Rows(j).Item("fieldid").ToString()
                                Dim Formula = Convert.ToString(dtfld1.Rows(j).Item("cal_text"))
                                Dim DisplayName = Convert.ToString(dtfld1.Rows(j).Item("DisplayName"))
                                If ilEdit = 1 Then
                                    If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Or ftype.ToUpper() = "PARENT VALUE" Then
                                        Dim cb As New TextBox
                                        'cb.ID = "fld" & j.ToString() & "_" & row.RowIndex
                                        cb.Width = 55
                                        cb.ID = "fld" & FldID & row.RowIndex

                                        'Prashant_10_7
                                        If dtfld1.Rows(j).Item("defaultfieldval").ToString().Length > 0 Then
                                            cb.Text = dtfld1.Rows(j).Item("defaultfieldval").ToString()
                                        Else
                                            If datatype.ToUpper() = "NUMERIC" Then
                                                cb.Text = "0"
                                            End If
                                        End If
                                        If Val(dtfld1.Rows(j).Item("isDescription").ToString()) = 1 Then
                                            cb.ToolTip = dtfld1.Rows(j).Item("Description").ToString()
                                        End If
                                        If dtfld1.Rows(j).Item("iseditable") = 0 Then
                                            cb.Attributes.Add("READONLY", "READONLY")
                                            cb.Attributes.Add("COLOR", "GRAY")
                                        End If
                                        If ftype.ToUpper() = "CALCULATIVE FIELD" Then
                                            colValue = "0"
                                            cb.Attributes.Add("READONLY", "READONLY")
                                            cb.Attributes.Add("COLOR", "GRAY")
                                        End If
                                        If ViewState("chkadd") = 1 Then
                                            j = j + 1
                                        End If
                                        colValue = row.DataItem(j).ToString()
                                        If ftype.ToUpper() = "LOOKUP" Then
                                            If datatype.ToUpper() = "NUMERIC" Then
                                                colValue = "0"
                                            End If
                                        Else
                                            If Val(colValue) = 0 Then
                                                If ftype.ToUpper() = "TEXT BOX" And datatype.ToUpper() = "NUMERIC" Then
                                                    colValue = "0"
                                                End If
                                            End If
                                        End If

                                        If Not row.Cells(j).Text.Trim = "&nbsp;" And Not row.Cells(j).Text.Trim = "" Then
                                            colValue = row.Cells(j).Text.Trim
                                        End If

                                        cb.Text = colValue
                                        cb.Width = controlWdth
                                        row.Cells(j).Controls.Add(cb)

                                        If datatype.ToUpper.Trim = "DATETIME" Then
                                            Dim CLNDR As New AjaxControlToolkit.CalendarExtender
                                            CLNDR.Controls.Clear()
                                            CLNDR.ID = "CLNDR" & dtfld1.Rows(j).Item("FieldID").ToString()
                                            CLNDR.Format = "dd/MM/yy"
                                            CLNDR.TargetControlID = cb.ID
                                            cb.Enabled = True
                                            If Request.QueryString("TID") Is Nothing Then
                                                cb.Text = String.Format("{0:dd/MM/yy}", Date.Now())
                                            End If
                                            row.Cells(j).Controls.Add(CLNDR) '
                                        End If


                                        'Code For calculative field
                                        'Code End Here !!!!!!
                                        'If ftype = "Calculative Field" Then
                                        '    cb.Attributes.Add("READONLY", "READONLY")
                                        '    cb.Attributes.Add("COLOR", "GRAY")
                                        '    ' cb.ReadOnly = True
                                        'End If


                                        If Not Formula Is Nothing And Formula <> "" Then
                                            'Dim arrFor As String() = Formula.Split(",")
                                            Dim jScript = GenerateJQueryScript(dtfld1, GID, row.RowIndex, Formula, FldID)
                                            If jScript <> "" Then
                                                cb.Attributes.Add("onblur", jScript)
                                            End If
                                        End If
                                        If Val(dtfld1.Rows(j).Item("HasRule").ToString()) = 1 Then
                                            cb.AutoPostBack = True
                                            AddHandler cb.TextChanged, AddressOf grdTextBoxRule_TextChanged
                                        End If

                                    ElseIf ftype.ToUpper() = "AUTOCOMPLETE" Then

                                        Dim txtbox As New TextBox
                                        txtbox.ID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
                                        txtbox.Width = controlWdth - 10
                                        txtbox.CssClass = "txtBox"
                                        txtbox.Attributes.Add("placeholder", "Please begin typing a " & DisplayName)
                                        txtbox.AutoPostBack = True
                                        AddHandler txtbox.TextChanged, AddressOf txtbox_TextChanged
                                        ' adding handler for binding lookup or other dropdown or filter

                                        Dim autofilExtender As New AjaxControlToolkit.AutoCompleteExtender
                                        autofilExtender.ID = "extenderID" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex

                                        autofilExtender.TargetControlID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
                                        autofilExtender.ServiceMethod = "GetCompletionList" ' THIS SERVICE METHOD IS WRITTEN ON DOCUMENT PAGE 
                                        autofilExtender.DelimiterCharacters = ""
                                        autofilExtender.ContextKey = dtfld1.Rows(j).Item("DROPDOWN").ToString() & "-" & dtfld1.Rows(j).Item("FieldID").ToString() & "-" & dtfld1.Rows(j).Item("DROPDOWNTYPE").ToString() & "-" & dtfld1.Rows(j).Item("AUTOFILTER").ToString() & "-" & dtfld1.Rows(j).Item("inlinefilter").ToString()
                                        'context key contain  : dropdown-fieldid-dropdowntype-autofilter-InitialFilter' adding the fieldid in context key because later on we need id of field in web method 
                                        autofilExtender.Enabled = True
                                        autofilExtender.CompletionSetCount = 5
                                        autofilExtender.OnClientShown = "onDataShown"  ' by sunil
                                        '   autofilExtender.CompletionListElementID = "ACsugestlist"
                                        autofilExtender.MinimumPrefixLength = 1  ' start searching when entered one characters
                                        'autofilExtender.OnClientItemSelected = "ace_itemSelected('" & ds.Rows(i).Item("FieldID").ToString() & "')"
                                        autofilExtender.OnClientItemSelected = "ace_itemSelected"
                                        row.Cells(j).Controls.Add(txtbox)
                                        'pnlFields.Controls.Add(txtbox)

                                        Dim hdnfld As New HiddenField
                                        hdnfld.ID = "HDN" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
                                        row.Cells(j).Controls.Add(hdnfld)
                                        'pnlFields.Controls.Add(img)
                                        'pnlFields.Controls.Add(prgBar)
                                        row.Cells(j).Controls.Add(autofilExtender)
                                        'pnlFields.Controls.Add(autofilExtender)

                                        'LT Lookupval Changes
                                    ElseIf ftype.ToUpper() = "LT LOOKUP" Then
                                        Dim txtBox As New TextBox
                                        txtBox.ID = "fld" & FldID & row.RowIndex
                                        txtBox.Width = controlWdth - 10
                                        txtBox.CssClass = "txtBox"
                                        If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
                                            txtBox.Enabled = True
                                        Else
                                            txtBox.Enabled = False
                                        End If

                                        If ViewState("chkadd") = 1 Then
                                            j = j + 1
                                        End If
                                        If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
                                            txtBox.Text = row.Cells(j).Text
                                        End If

                                        row.Cells(j).Controls.Add(txtBox)
                                    ElseIf ftype.ToUpper() = "FORMULA FIELD" Then
                                        Dim txtBox As New TextBox
                                        txtBox.ID = "fld" & FldID & row.RowIndex
                                        txtBox.Width = controlWdth - 10
                                        txtBox.CssClass = "txtBox"
                                        If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
                                            txtBox.Enabled = True
                                        Else
                                            txtBox.Enabled = False
                                        End If

                                        If ViewState("chkadd") = 1 Then
                                            j = j + 1
                                        End If
                                        If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
                                            txtBox.Text = row.Cells(j).Text
                                        Else
                                            txtBox.Text = "0"
                                        End If

                                        row.Cells(j).Controls.Add(txtBox)

                                    ElseIf ftype.ToUpper() = "TEXT AREA" Then
                                        Dim txtBox As New TextBox
                                        txtBox.ID = "fld" & FldID & row.RowIndex
                                        txtBox.Width = controlWdth + 50
                                        txtBox.Height = 50
                                        txtBox.TextMode = TextBoxMode.MultiLine
                                        txtBox.Columns = 4
                                        txtBox.Rows = 10
                                        txtBox.CssClass = "txtBox"
                                        If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
                                            txtBox.Enabled = True
                                        Else
                                            txtBox.Enabled = False
                                        End If

                                        If ViewState("chkadd") = 1 Then
                                            j = j + 1
                                        End If
                                        If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
                                            txtBox.Text = row.Cells(j).Text
                                        End If

                                        row.Cells(j).Controls.Add(txtBox)


                                    ElseIf ftype.ToUpper() = "MULTI LOOKUP" Then
                                        Dim txtBox As New TextBox
                                        txtBox.ID = "fld" & FldID & row.RowIndex
                                        txtBox.Width = controlWdth - 10
                                        txtBox.CssClass = "txtBox"
                                        If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
                                            txtBox.Enabled = True
                                        Else
                                            txtBox.Enabled = False
                                        End If
                                        If ViewState("chkadd") = 1 Then
                                            j = j + 1
                                        End If
                                        If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
                                            txtBox.Text = row.Cells(j).Text
                                        End If
                                        row.Cells(j).Controls.Add(txtBox)

                                    ElseIf ftype.ToUpper() = "MULTI LOOKUPDDL" Then

                                        Dim ddl As New DropDownList
                                        ddl.ID = "fld" & FldID & "_" & row.RowIndex
                                        ddl.CssClass = "txtBox"
                                        ddl.Width = 150

                                        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
                                        Dim con As SqlConnection = New SqlConnection(conStr)
                                        Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
                                        Dim od As SqlDataAdapter = New SqlDataAdapter("", con)
                                        Dim dt As New DataTable
                                        Dim dtval As New DataTable
                                        Dim fieldid As String()
                                        Dim ddlval As String()
                                        If (ddlText.ToString() <> String.Empty) Then
                                            fieldid = ddlText.ToString().Split(",")
                                            'With(nolock) added by Himank on 29th sep 2015
                                            od.SelectCommand.CommandText = "select ddlMultilookupval from mmm_mst_fields  WITH(NOLOCK)  where fieldid = " & fieldid(0).ToString() & ""
                                            od.Fill(dtval)
                                            If (dtval.Rows.Count > 0) Then
                                                ddlval = dtval.Rows(0)("ddlMultilookupval").ToString().Split(",")
                                                For q As Integer = 0 To ddlval.Length - 1
                                                    If (ddlval(q).ToString().Contains("-" & dtfld1.Rows(j).Item("FieldID").ToString())) Then
                                                        Dim temp() As String = ddlval(q).ToString().Split("-")
                                                        'With(nolock) added by Himank on 29th sep 2015
                                                        od.SelectCommand.CommandText = "select * from MMM_MST_FIELDS  WITH(NOLOCK)  where DOCUMENTTYPE='" & temp(0).ToString() & "' and eid=" & HttpContext.Current.Session("EID") & " and fieldmapping in('" & temp(1).ToString() & "')"
                                                        Dim checkval As New DataTable
                                                        od.Fill(checkval)
                                                        Dim ddlText1 As String = checkval.Rows(0).Item("dropdown").ToString()
                                                        Dim dropdowntype As String = checkval.Rows(0).Item("dropdowntype").ToString()
                                                        Dim arr() As String
                                                        If UCase(dropdowntype) = "MASTER VALUED" Then
                                                            Dim ob As New DynamicForm
                                                            arr = ddlText1.Split("-")
                                                            Dim TID As String = "TID"
                                                            Dim TABLENAME As String = ""
                                                            If UCase(arr(0).ToString()) = "MASTER" Then
                                                                TABLENAME = "MMM_MST_MASTER"
                                                            ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
                                                                TABLENAME = "MMM_MST_DOC"
                                                            ElseIf UCase(arr(0).ToString()) = "CHILD" Then
                                                                TABLENAME = "MMM_MST_DOC_ITEM"
                                                            ElseIf UCase(arr(0).ToString) = "STATIC" Then
                                                                If arr(1).ToString.ToUpper = "USER" Then
                                                                    TABLENAME = "MMM_MST_USER"
                                                                    TID = "UID"
                                                                ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
                                                                    TABLENAME = "MMM_MST_LOCATION"
                                                                    TID = "LOCID"
                                                                End If
                                                            End If
                                                            Dim lookUpqry As String = ""
                                                            Dim str As String = ""
                                                            'With(nolock) added by Himank on 29th sep 2015
                                                            If arr(0).ToUpper() = "CHILD" Then
                                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                                            ElseIf arr(0).ToUpper() <> "STATIC" Then
                                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                                            Else
                                                                If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
                                                                    str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
                                                                Else
                                                                    str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                                                End If
                                                            End If

                                                            Dim xwhr As String = ""
                                                            Dim tids As String = ""
                                                            'Dim tidarr() As String

                                                            ''FILTER THE DATA ACCORDING TO USER 
                                                            tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())

                                                            If tids.Length >= 2 Then
                                                                'tidarr = tids.Split("-")
                                                                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
                                                            ElseIf tids = "0" Then
                                                                pnlFields.Visible = False
                                                                btnActEdit.Visible = False
                                                                UpdatePanel1.Update()
                                                                xwhr = ""
                                                            End If
                                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                                            Dim AutoFilter As String = dtfld1.Rows(j).Item("AutoFilter").ToString()
                                                            If AutoFilter.Length > 0 Then
                                                                If arr(0).ToUpper() = "CHILD" Then
                                                                    If AutoFilter.ToUpper = "DOCID" Then
                                                                        str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
                                                                    Else
                                                                        str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
                                                                    End If
                                                                    'With(nolock) added by Himank on 29th sep 2015
                                                                ElseIf arr(0).ToUpper() <> "STATIC" Then
                                                                    str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                                                    str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                                                Else
                                                                    str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " "
                                                                    str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                                                End If
                                                            End If


                                                            Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
                                                            Dim dss As New DataSet
                                                            If str.Length > 0 Then
                                                                oda.SelectCommand.CommandText = str
                                                                oda.Fill(dss, "FV")
                                                                Dim isAddJquery As Integer = 0
                                                                ddl.Items.Add("Select")
                                                                ddl.Items(0).Value = "0"
                                                                For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
                                                                    ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
                                                                    Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
                                                                    ddl.Items(J1 + 1).Value = lookddlVal
                                                                Next
                                                                oda.Dispose()
                                                                dss.Dispose()
                                                                'prashant_2_7

                                                                Dim lookupvalue As String = dtfld1.Rows(j).Item("lookupvalue").ToString()
                                                                Dim multilookup As String = dtfld1.Rows(j).Item("multilookUpVal").ToString()
                                                                Dim ddlmultilookup As String = dtfld1.Rows(j).Item("ddlmultilookUpVal").ToString()
                                                                'LT Lookupval changes
                                                                Dim LTLookupval As String = Convert.ToString(dtfld1.Rows(j).Item("LTlookupval"))
                                                                If lookupvalue.Length > 0 Or multilookup.Length > 0 Or ddlmultilookup.Length > 0 Or LTLookupval.Length > 0 Then
                                                                    ddl.AutoPostBack = True
                                                                    AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged
                                                                End If

                                                                If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
                                                                    ddl.Items.FindByText(row.Cells(j).Text).Selected = True
                                                                End If
                                                                If ViewState("chkadd") = 1 Then
                                                                    j = j + 1
                                                                End If

                                                                If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
                                                                    'ddl.Items.FindByText(row.Cells(j).Text).Selected = True
                                                                    ddl.SelectedValue = ddl.Items.FindByText(row.Cells(j).Text).Value
                                                                End If

                                                                row.Cells(j).Controls.Add(ddl)

                                                                If isAddJquery = 1 Then
                                                                    Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
                                                                End If
                                                            End If
                                                            con.Dispose()
                                                            oda.Dispose()
                                                            dss.Dispose()
                                                        ElseIf UCase(dropdowntype) = "SESSION VALUED" Then

                                                        End If
                                                    End If
                                                Next
                                            End If
                                        End If

                                    ElseIf ftype.ToUpper() = "DROP DOWN" Then
                                        Dim ddl As New DropDownList

                                        ddl.ID = "fld" & FldID & "_" & row.RowIndex
                                        ddl.CssClass = "txtBox"
                                        ddl.Width = 150
                                        Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
                                        Dim dropdowntype As String = dtfld1.Rows(j).Item("dropdowntype").ToString()
                                        Dim arr() As String
                                        If dtfld1.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
                                            'Dim cb As New DropDownList
                                            ' cb.ID = "fld" & FldID & row.RowIndex
                                            ddl.Items.Add("Select")
                                            ddl.Items(0).Value = "0"

                                            Dim ARR1() As String = dtfld1.Rows(j).Item("dropdown").ToString().Split(",")
                                            For K As Integer = 0 To ARR1.Length - 1
                                                ddl.Items.Add(ARR1(K).ToString)
                                            Next
                                            If ViewState("chkadd") = 1 Then
                                                j = j + 1
                                            End If

                                            '' for default value selection
                                            'If dtfld1.Rows(l).Item("ddlval").ToString().Length > 1 Then
                                            '    Dim dropdowntypeFill As String = ds.Rows(l).Item("ddlval").ToString().ToUpper()
                                            '    ddl.SelectedIndex = ddl.Items.IndexOf(ddl.Items.FindByText(dropdowntypeFill))
                                            'End If


                                            If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
                                                ddl.Items.FindByText(row.Cells(j).Text).Selected = True
                                            End If

                                            row.Cells(j).Controls.Add(ddl)
                                            'Prashant_10_7
                                            If dtfld1.Rows(j).Item("iseditable") = 1 Then
                                                ddl.Enabled = True
                                            Else
                                                ddl.Enabled = False
                                            End If

                                        ElseIf dtfld1.Rows(j).Item("dropdowntype").ToString() = "MASTER VALUED" Then
                                            '' code for getting master valued 
                                            Dim ob As New DynamicForm
                                            arr = ddlText.Split("-")
                                            Dim TID As String = "TID"
                                            Dim TABLENAME As String = ""
                                            If UCase(arr(0).ToString()) = "MASTER" Then
                                                TABLENAME = "MMM_MST_MASTER"
                                            ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
                                                TABLENAME = "MMM_MST_DOC"
                                            ElseIf UCase(arr(0).ToString()) = "CHILD" Then
                                                TABLENAME = "MMM_MST_DOC_ITEM"
                                            ElseIf UCase(arr(0).ToString) = "STATIC" Then
                                                If arr(1).ToString.ToUpper = "USER" Then
                                                    TABLENAME = "MMM_MST_USER"
                                                    TID = "UID"
                                                ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
                                                    TABLENAME = "MMM_MST_LOCATION"
                                                    TID = "LOCID"
                                                End If
                                            End If
                                            Dim lookUpqry As String = ""
                                            Dim str As String = ""
                                            'With(nolock) added by Himank on 29th sep 2015
                                            If arr(0).ToUpper() = "CHILD" Then
                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                            ElseIf arr(0).ToUpper() <> "STATIC" Then
                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                            Else
                                                If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
                                                    str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
                                                Else
                                                    str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                                End If
                                            End If

                                            Dim xwhr As String = ""
                                            Dim tids As String = ""
                                            'Dim tidarr() As String

                                            ''FILTER THE DATA ACCORDING TO USER 
                                            tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())

                                            If tids.Length >= 2 Then
                                                'tidarr = tids.Split("-")
                                                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
                                            ElseIf tids = "0" Then
                                                pnlFields.Visible = False
                                                btnActEdit.Visible = False
                                                UpdatePanel1.Update()
                                                xwhr = ""
                                            End If
                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                            Dim AutoFilter As String = dtfld1.Rows(j).Item("AutoFilter").ToString()
                                            If AutoFilter.Length > 0 Then
                                                If arr(0).ToUpper() = "CHILD" Then
                                                    If AutoFilter.ToUpper = "DOCID" Then
                                                        str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
                                                    Else
                                                        str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
                                                    End If
                                                    'With(nolock) added by Himank on 29th sep 2015
                                                ElseIf arr(0).ToUpper() <> "STATIC" Then
                                                    str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                                    str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                                Else
                                                    str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " "
                                                    str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                                End If
                                            End If

                                            Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
                                            Dim con As SqlConnection = New SqlConnection(conStr)
                                            Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
                                            Dim dss As New DataSet

                                            If str.Length > 0 Then
                                                oda.SelectCommand.CommandText = str
                                                oda.Fill(dss, "FV")
                                                Dim isAddJquery As Integer = 0
                                                ddl.Items.Add("Select")
                                                ddl.Items(0).Value = "0"
                                                For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
                                                    ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
                                                    Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
                                                    ddl.Items(J1 + 1).Value = lookddlVal
                                                Next
                                                oda.Dispose()
                                                dss.Dispose()
                                                'prashant_2_7

                                                Dim lookupvalue As String = dtfld1.Rows(j).Item("lookupvalue").ToString()
                                                Dim multilookup As String = dtfld1.Rows(j).Item("multilookUpVal").ToString()
                                                Dim ddlmultilookup As String = dtfld1.Rows(j).Item("ddlmultilookUpVal").ToString()
                                                'LT Lookupval changes
                                                Dim LTLookupval As String = Convert.ToString(dtfld1.Rows(j).Item("LTlookupval"))

                                                If lookupvalue.Length > 0 Or multilookup.Length > 0 Or ddlmultilookup.Length > 0 Or LTLookupval.Length > 0 Then
                                                    ddl.AutoPostBack = True
                                                    AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged
                                                End If


                                                ' '' new by sp on 18-nov-15 for Burgerking ticket
                                                'If Len(Convert.ToString(dtfld1.Rows(j).Item("ddlval"))) > 1 Then
                                                '    Dim DDldefaultVal As String = Convert.ToString(dtfld1.Rows(j).Item("ddlval"))
                                                '    ddl.SelectedIndex = ddl.Items.IndexOf(ddl.Items.FindByValue(DDldefaultVal))
                                                '    Dim id As String = Right(ddl.ID, ddl.ID.Length - 3)
                                                '    Dim ar() As String = id.Split("_")
                                                '    Dim id1 As Integer = CInt(ar(0))
                                                '    BindGRidLookup(ar(1), id1, ddl)
                                                '    Dim ob1 As New DynamicForm()
                                                '    ob1.GridMultiLookup(ar(1), id1, ddl, lblTab, pnlFields)
                                                '    ob1.GridLTLookup(ar(1), id1, ddl, lblTab, pnlFields)
                                                '    BindGRidLookupDDL(ar(1), id1, ddl)
                                                'End If
                                                ' '' new by sp on 18-nov-15 for Burgerking ticket - ends 
                                                ''If ds.Rows(i).Item("ddlval").ToString().Length > 1 Then
                                                ''    Dim ddl As New DropDownList
                                                ''    ddl = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), DropDownList)
                                                ''    Dim dropdowntypeFill As String = ds.Rows(i).Item("ddlval").ToString().ToUpper().Trim()
                                                ''    ddl.SelectedIndex = ddl.Items.IndexOf(ddl.Items.FindByValue(dropdowntypeFill))
                                                ''    '''''For filling lookup and lookupddl according drop down'''''''
                                                ''    Dim id As String = Right(ddl.ID, ddl.ID.Length - 3)
                                                ''    Dim id1 As Integer = CInt(id)
                                                ''    bind(id, pnlFields, ddl)
                                                ''    bindlookupddl(id, pnlFields, ddl)
                                                ''End If


                                                If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
                                                    ddl.Items.FindByText(row.Cells(j).Text).Selected = True
                                                End If
                                                If ViewState("chkadd") = 1 Then
                                                    j = j + 1
                                                End If

                                                If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
                                                    ddl.Items.FindByText(row.Cells(j).Text).Selected = True
                                                End If

                                                row.Cells(j).Controls.Add(ddl)

                                                If isAddJquery = 1 Then
                                                    Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
                                                End If
                                            End If
                                            con.Dispose()
                                            oda.Dispose()
                                            dss.Dispose()
                                            '' ends here for getting master valued 

                                        End If


                                    ElseIf ftype.ToUpper() = "CHECKBOX LIST" Then
                                        Dim CHKlIST As New CheckBoxList()
                                        Dim dynmdiv As System.Web.UI.HtmlControls.HtmlGenericControl = New System.Web.UI.HtmlControls.HtmlGenericControl("DIV")
                                        dynmdiv.ID = "div_" & FldID
                                        Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
                                        CHKlIST.ID = "fld" & FldID & "_" & row.RowIndex
                                        If dtfld1.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
                                            Dim arr = ddlText.Split(",")
                                            For ii As Integer = 0 To arr.Count - 1
                                                CHKlIST.Items.Add(arr(ii).ToUpper())
                                            Next

                                        ElseIf dtfld1.Rows(j).Item("dropdowntype").ToString() = "MASTER VALUED" Then
                                            Dim arr = ddlText.Split("-")
                                            Dim TID As String = "TID"
                                            Dim TABLENAME As String = ""
                                            If UCase(arr(0).ToString()) = "MASTER" Then
                                                TABLENAME = "MMM_MST_MASTER"
                                            ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
                                                TABLENAME = "MMM_MST_DOC"
                                            ElseIf UCase(arr(0).ToString()) = "CHILD" Then
                                                TABLENAME = "MMM_MST_DOC_ITEM"
                                            ElseIf UCase(arr(0).ToString) = "STATIC" Then
                                                If arr(1).ToString.ToUpper = "USER" Then
                                                    TABLENAME = "MMM_MST_USER"
                                                    TID = "UID"
                                                ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
                                                    TABLENAME = "MMM_MST_LOCATION"
                                                    TID = "LOCID"
                                                End If
                                            End If
                                            Dim lookUpqry As String = ""
                                            Dim str As String = ""
                                            'With(nolock) added by Himank on 29th sep 2015
                                            If arr(0).ToUpper() = "CHILD" Then
                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                            ElseIf arr(0).ToUpper() <> "STATIC" Then
                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                            Else
                                                If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
                                                    str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
                                                Else
                                                    str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                                End If
                                            End If
                                            Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
                                            Dim con As SqlConnection = New SqlConnection(conStr)
                                            Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
                                            oda = New SqlDataAdapter("", con)
                                            Dim dss As New DataSet
                                            oda.SelectCommand.CommandText = str
                                            oda.Fill(dss, "FV")
                                            For JJ As Integer = 0 To dss.Tables("FV").Rows.Count - 1
                                                CHKlIST.Items.Add(dss.Tables("FV").Rows(JJ).Item(0))
                                                CHKlIST.Items(JJ).Value = dss.Tables("FV").Rows(JJ).Item(1)
                                            Next
                                            oda.Dispose()
                                            dss.Dispose()
                                        End If

                                        dynmdiv.Style.Add(HtmlTextWriterStyle.Width, "200px")
                                        dynmdiv.Style.Add(HtmlTextWriterStyle.Height, "100px")
                                        dynmdiv.Style.Add(HtmlTextWriterStyle.Overflow, "Scroll")
                                        dynmdiv.Controls.Add(CHKlIST)
                                        row.Cells(j).Controls.Add(dynmdiv)

                                    ElseIf ftype.ToUpper = "LOOKUPDDL" Then

                                        datatype = dtfld1.Rows(j).Item("datatype").ToString().ToUpper()
                                        Dim fieldtypee As String = dtfld1.Rows(j).Item("FieldType").ToString().ToUpper()
                                        Dim ddl As New DropDownList
                                        ddl.ID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & "_" & row.RowIndex
                                        ddl.Width = controlWdth - 10
                                        ddl.CssClass = "txtBox"
                                        Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
                                        Dim dropdowntype As String = dtfld1.Rows(j).Item("dropdowntype").ToString()
                                        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
                                        Dim con As SqlConnection = New SqlConnection(conStr)
                                        'With(nolock) added by Himank on 29th sep 2015
                                        Dim od As SqlDataAdapter = New SqlDataAdapter("select dropdown,DDllookupvalue from MMM_MST_FIELDS  WITH(NOLOCK)  where FieldID='" & ddlText & "'", con)
                                        ' Dim dsMonth As New DataSet
                                        Dim dt As New DataTable
                                        od.Fill(dt)
                                        Dim arr() As String
                                        Dim darr() As String
                                        Dim type As String = dt.Rows(0).Item("dropdown").ToString()
                                        arr = type.Split("-")
                                        Dim documenttype As String = arr(1).ToString()
                                        Dim field As String = dt.Rows(0).Item("DDllookupvalue").ToString()
                                        field = field.Substring(0, field.Length - 1)
                                        darr = field.Split(",")
                                        For k As Integer = 0 To darr.Count - 1
                                            Dim fieldmping As String
                                            Dim str As String = ""
                                            Dim feild As String
                                            Dim s = darr(k).Split("-")
                                            feild = s(0).ToString()
                                            fieldmping = s(1).ToString()

                                            Dim TID As String = "TID"
                                            Dim TABLENAME As String = ""
                                            Dim str1 As String = ""
                                            Dim lookUpqry As String = ""

                                            Dim xwhr As String = ""
                                            Dim tids As String = ""
                                            Dim Rtids As String = ""   ' for prerole data filter


                                            If feild = dtfld1.Rows(j).Item("FieldID").ToString() Then
                                                'If arr(0) = "SESSION" And Not (fieldmping.Contains("fld")) Then
                                                '    If arr(1).ToString.ToUpper = "USER" Then
                                                '        TABLENAME = "MMM_MST_USER"
                                                '        TID = "UID"
                                                '    End If
                                                '    ' str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                                '    str1 = "select " & fieldmping.ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                                'Else

                                                'With(nolock) added by Himank on 29th sep 2015
                                                od.SelectCommand.CommandText = "select dropdown from MMM_MST_FIELDS  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("EID") & " and documenttype='" & documenttype & "' and FieldMapping in('" & fieldmping & "')"
                                                Dim dt1 As New DataTable
                                                od.Fill(dt1)
                                                Dim dropdown As String = dt1.Rows(0).Item("dropdown").ToString()
                                                arr = dropdown.Split("-")

                                                If UCase(arr(0).ToString()) = "MASTER" Then
                                                    TABLENAME = "MMM_MST_MASTER"
                                                ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
                                                    TABLENAME = "MMM_MST_DOC"
                                                ElseIf UCase(arr(0).ToString()) = "CHILD" Then
                                                    TABLENAME = "MMM_MST_DOC_ITEM"
                                                ElseIf UCase(arr(0).ToString) = "STATIC" Then
                                                    If arr(1).ToString.ToUpper = "USER" Then
                                                        TABLENAME = "MMM_MST_USER"
                                                        TID = "UID"
                                                    ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
                                                        TABLENAME = "MMM_MST_LOCATION"
                                                        TID = "LOCID"
                                                    End If
                                                ElseIf UCase(arr(0).ToString) = "SESSION" Then
                                                    If arr(1).ToString.ToUpper = "USER" Then
                                                        TABLENAME = "MMM_MST_USER"
                                                        TID = "UID"
                                                    ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
                                                        TABLENAME = "MMM_MST_LOCATION"
                                                        TID = "LOCID"
                                                    End If
                                                End If
                                                'With(nolock) added by Himank on 29th sep 2015
                                                If arr(0).ToUpper() = "CHILD" Then
                                                    str1 = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                                ElseIf arr(0).ToUpper() = "SESSION" Then
                                                    str1 = "Select " & IIf(arr(1).ToString.ToUpper = "USER", "UserName, ", "LocationName, ") & TID & " from " & TABLENAME & " M  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("EID") & " AND " & arr(2) & "='" & HttpContext.Current.Session(arr(2)) & "'"
                                                ElseIf arr(0).ToUpper() <> "STATIC" Then
                                                    str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                                Else
                                                    If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
                                                        str1 = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  "
                                                    Else
                                                        str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                                    End If
                                                End If
                                                '  End If

                                                'Dim tidarr() As String

                                                ''FILTER THE DATA ACCORDING TO USER 
                                                Dim ob = New DynamicForm()
                                                tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())
                                                Rtids = ob.UserDataFilter_PreRole(arr(1).ToString(), TABLENAME)  '' new by sunil for pre role data filter 22-feb

                                                '' for multiuse of document by sp on 08_apr_15
                                                Dim Sdtype As String = arr(1).ToString
                                                Dim da As SqlDataAdapter = New SqlDataAdapter("", con)
                                                da.SelectCommand.CommandType = CommandType.Text
                                                'With(nolock) added by Himank on 29th sep 2015
                                                da.SelectCommand.CommandText = "select isnull(Allowmultiuse,0) from mmm_mst_forms  WITH(NOLOCK)  where eid='" & HttpContext.Current.Session("EID").ToString & "' AND FORMNAME='" & Sdtype & "'"
                                                If con.State <> ConnectionState.Open Then
                                                    con.Open()
                                                End If
                                                Dim isMultiUse As Integer = Convert.ToInt32(da.SelectCommand.ExecuteScalar())

                                                Dim CurrDoctype As String = dtfld1.Rows(j).Item("documenttype").ToString()
                                                Dim CurrFieldMapping As String = dtfld1.Rows(j).Item("fieldmapping").ToString()

                                                Dim qry As String = ""
                                                Dim MTids As String = ""
                                                If UCase(arr(0).ToString()) <> "CHILD" And UCase(arr(0).ToString) <> "STATIC" And UCase(arr(0).ToString) <> "SESSION" Then
                                                    da.SelectCommand.CommandType = CommandType.Text
                                                    'With(nolock) added by Himank on 29th sep 2015
                                                    da.SelectCommand.CommandText = "SELECT SUBSTRING((SELECT ',' + CONVERT(NVARCHAR," & CurrFieldMapping & ")  FROM " & TABLENAME & "  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("eid") & " and documenttype='" & CurrDoctype & "'" & " FOR XML PATH('')),2,1000) AS CSV"
                                                    MTids = Convert.ToString(da.SelectCommand.ExecuteScalar())
                                                End If
                                                ''ends  for multiuse of document by sp on 08_apr_15


                                                If tids.Length >= 2 Then
                                                    xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
                                                ElseIf tids = "0" Then
                                                    pnlFields.Visible = False
                                                    btnActEdit.Visible = False
                                                    UpdatePanel1.Update()
                                                    xwhr = ""
                                                End If
                                                '' new by sunil for pre role data filter 22-feb
                                                If Rtids <> "" Then
                                                    If xwhr.ToString = "" Then
                                                        xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & Rtids & ")"
                                                    Else
                                                        xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & "," & Rtids & ")"
                                                    End If
                                                End If

                                                '' new by sunil for multiuse of docs
                                                If MTids.Length > 2 And isMultiUse = 1 Then
                                                    If Right(MTids, 1) = "," Then
                                                        MTids = Left(MTids, Len(MTids) - 1)
                                                    End If
                                                    xwhr = xwhr & " AND CONVERT(NVARCHAR(10),TID) not IN (" & MTids & ") "
                                                End If
                                                '' new by sunil for multiuse of docs

                                                str1 = str1 & "  AND M.isauth>0 " & xwhr & " order by " & arr(2).ToString()
                                                'Dim documenttype2 As String = arr1(1).ToString()
                                                'Dim fieldmping2 As String = arr1(2).ToString()
                                                'pnlFields.Controls.Add(ddl)
                                                Dim dt2 As New DataTable
                                                'oda.SelectCommand.CommandText = "select " & fieldmping2 & " from " & TABLENAME & " where EID=" & HttpContext.Current.Session("EID") & " and documenttype = '" & documenttype2 & "'"

                                                If str1.Length > 0 Then
                                                    pnlFields.Controls.Add(ddl)
                                                    od.SelectCommand.CommandText = str1
                                                    od.Fill(dt2)
                                                    Dim isAddJquery As Integer = 0
                                                    ddl.Items.Add("Select")
                                                    ddl.Items(0).Value = "0"
                                                    For JK As Integer = 0 To dt2.Rows.Count - 1
                                                        ddl.Items.Add(dt2.Rows(JK).Item(0).ToString())
                                                        Dim lookddlVal As String = dt2.Rows(JK).Item(1).ToString()
                                                        ddl.Items(JK + 1).Value = lookddlVal
                                                    Next
                                                    dt2.Dispose()
                                                End If
                                                If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
                                                    ddl.Enabled = True
                                                Else
                                                    ddl.Enabled = False
                                                End If
                                            End If
                                        Next
                                        row.Cells(j).Controls.Add(ddl)

                                    ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
                                        Dim txtBox As New FileUpload

                                        'Prashant 30-6-2014
                                        Dim txtBox1 As New HiddenField

                                        Dim lbl1 As New Label
                                        lbl1.ID = "lblf_" & FldID
                                        lbl1.Text = ""
                                        lbl1.ClientIDMode = ClientIDMode.Static

                                        txtBox1.ID = "hdn_" & FldID
                                        txtBox1.Value = ""
                                        txtBox1.ClientIDMode = ClientIDMode.Static
                                        If Not Request.QueryString("TID") Is Nothing Then
                                            txtBox.Attributes.Add("onchange", "UtilJs.UploadFile1(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
                                        Else
                                            txtBox.Attributes.Add("onchange", "UtilJs.UploadFile(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
                                        End If



                                        txtBox.ID = "fld_" & FldID & "_" & row.RowIndex  ' added  id  with _ by balli
                                        txtBox.CssClass = "txtBox"

                                        txtBox.Width = 180


                                        Dim hdnflag As New HiddenField
                                        If Not Request.QueryString("TID") Is Nothing Then
                                            hdnflag.ID = "hdnf_" & FldID
                                            hdnflag.Value = "0"
                                            Dim str As String = row.Cells(j).Text

                                            str = After(str, "/")

                                            txtBox1.Value = str 'row.Cells(j).Text
                                            lbl1.Text = str ' row.Cells(j).Text
                                            row.Cells(j).Text = str
                                        End If
                                        If ViewState("chkadd") = 1 Then
                                            j = j + 1
                                        End If
                                        row.Cells(j).Controls.Add(txtBox)
                                        'Prashant 30-6-2014
                                        row.Cells(j).Controls.Add(txtBox1)
                                        row.Cells(j).Controls.Add(lbl1)
                                        row.Cells(j).Controls.Add(hdnflag)

                                        Dim pstback As New PostBackTrigger
                                        pstback.ControlID = btnActEdit.ID
                                        UpdatePanel1.Triggers.Add(pstback)

                                    End If
                                    If ViewState("chkadd") = 1 Then
                                        j = j - 1    ' added for incremental 
                                    End If
                                End If

                            Next
                        End If

                        ' By Neha Thakar 24-01-15
                    Else
                        Dim filterRows2() As DataRow
                        filterRows2 = dtfld1.Select("HasDefaultValue=1")
                        'Uncomment it
                        'If filterRows.Length > 0 Then
                        '    dtfld1 = filterRows.CopyToDataTable()
                        'Else
                        '    filterRows = dtfld1.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''", "inlinemapping,DisplayOrder")
                        '    dtfld1 = filterRows.CopyToDataTable()
                        'End If


                        Dim filterRows() As DataRow
                        Dim filterRows1() As DataRow
                        filterRows = dtfld1.Select("inlinemapping is not null and inlinemapping <>''", "DisplayOrder")
                        filterRows1 = dtfld1.Select("InLineEditing=1 and inlinemapping is null", "DisplayOrder")
                        If filterRows.Length > 0 Then
                            dtfld1 = filterRows.CopyToDataTable()
                            dtfld1.Merge(filterRows1.CopyToDataTable())
                        Else
                            dtfld1 = filterRows1.CopyToDataTable()
                        End If


                        For j As Integer = 0 To dtfld1.Rows.Count - 1

                            Dim ftype As String = dtfld1.Rows(j).Item("fieldtype").ToString()

                            Dim datatype As String = dtfld1(j).Item("datatype").ToString() 'Prashant_10_7

                            Dim colValue As String = row.DataItem(j).ToString()
                            Dim ilEdit As Integer = dtfld1.Rows(j).Item("inlineEditing").ToString()
                            Dim FldID As String = dtfld1.Rows(j).Item("fieldid").ToString()
                            Dim Formula = Convert.ToString(dtfld1.Rows(j).Item("cal_text"))
                            Dim DisplayName = Convert.ToString(dtfld1.Rows(j).Item("DisplayName"))
                            Dim InlineMap = Convert.ToString(dtfld1.Rows(j).Item("inlinemapping"))
                            If ilEdit = 1 Then
                                If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Or ftype.ToUpper() = "PARENT VALUE" Then
                                    Dim cb As New TextBox
                                    'cb.ID = "fld" & j.ToString() & "_" & row.RowIndex
                                    cb.Width = 35
                                    cb.ID = "fld" & FldID & row.RowIndex

                                    'Prashant_10_7
                                    If dtfld1.Rows(j).Item("defaultfieldval").ToString().Length > 0 Then
                                        cb.Text = dtfld1.Rows(j).Item("defaultfieldval").ToString()
                                    Else
                                        If datatype.ToUpper() = "NUMERIC" Then
                                            cb.Text = "0"
                                        End If
                                    End If
                                    If Val(dtfld1.Rows(j).Item("isDescription").ToString()) = 1 Then
                                        cb.ToolTip = dtfld1.Rows(j).Item("Description").ToString()
                                    End If
                                    If dtfld1.Rows(j).Item("iseditable") = 0 Then
                                        cb.Attributes.Add("READONLY", "READONLY")
                                        cb.Attributes.Add("COLOR", "GRAY")
                                    End If
                                    If ftype.ToUpper() = "CALCULATIVE FIELD" Then
                                        colValue = "0"
                                        cb.Attributes.Add("READONLY", "READONLY")
                                        cb.Attributes.Add("COLOR", "GRAY")
                                    End If



                                    If ftype.ToUpper() = "LOOKUP" Then
                                        If datatype.ToUpper() = "NUMERIC" Then
                                            colValue = "0"
                                        End If
                                    Else
                                        If Val(colValue) = 0 Then
                                            If ftype.ToUpper() = "TEXT BOX" And datatype.ToUpper() = "NUMERIC" Then
                                                colValue = "0"
                                            End If
                                        End If
                                    End If

                                    If ViewState("chkadd") = 1 Then
                                        j = j + 1
                                    End If

                                    If Not row.Cells(j).Text.Trim = "&nbsp;" And Not row.Cells(j).Text.Trim = "" Then
                                        colValue = row.Cells(j).Text.Trim
                                    Else
                                        colValue = cb.Text
                                    End If

                                    cb.Text = colValue
                                    cb.Width = controlWdth

                                    If cb.Text.Length > 15 Then
                                        cb.TextMode = TextBoxMode.MultiLine
                                        cb.Height = 30
                                    End If

                                    row.Cells(j).Controls.Add(cb)

                                    If datatype.ToUpper.Trim = "DATETIME" Then
                                        If dtfld1.Rows(j).Item("iseditable") = 1 Then
                                            Dim CLNDR As New AjaxControlToolkit.CalendarExtender
                                            CLNDR.Controls.Clear()
                                            CLNDR.ID = "CLNDR" & dtfld1.Rows(j).Item("FieldID").ToString()
                                            CLNDR.Format = "dd/MM/yy"
                                            CLNDR.TargetControlID = cb.ID
                                            cb.Enabled = True

                                            cb.Text = String.Format("{0:dd/MM/yy}", Date.Now())

                                            'If ViewState("chkadd") = 1 Then
                                            '    j = j + 1
                                            'End If
                                            row.Cells(j).Controls.Add(CLNDR) '
                                        End If

                                    End If

                                    If Not Formula Is Nothing And Formula <> "" Then
                                        'Dim arrFor As String() = Formula.Split(",")
                                        Dim jScript = GenerateJQueryScript(dtfld1, GID, row.RowIndex, Formula, FldID)
                                        If jScript <> "" Then
                                            cb.Attributes.Add("onblur", jScript)
                                        End If
                                    End If
                                    If Val(dtfld1.Rows(j).Item("HasRule").ToString()) = 1 Then
                                        cb.AutoPostBack = True
                                        AddHandler cb.TextChanged, AddressOf grdTextBoxRule_TextChanged
                                    End If
                                    If Not Convert.ToString(dtfld1.Rows(j).Item("Colwidth")) = String.Empty Then
                                        cb.Width = Convert.ToString(dtfld1.Rows(j).Item("Colwidth"))
                                    End If

                                ElseIf ftype.ToUpper() = "MULTI LOOKUP" Then
                                    Dim txtBox As New TextBox
                                    txtBox.ID = "fld" & FldID & row.RowIndex
                                    txtBox.Width = controlWdth - 10
                                    txtBox.CssClass = "txtBox"
                                    If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
                                        txtBox.Enabled = True
                                    Else
                                        txtBox.Enabled = False
                                    End If

                                    If ViewState("chkadd") = 1 Then
                                        j = j + 1
                                    End If
                                    If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
                                        txtBox.Text = row.Cells(j).Text
                                    End If
                                    If Not Convert.ToString(dtfld1.Rows(j).Item("Colwidth")) = String.Empty Then
                                        txtBox.Width = Convert.ToString(dtfld1.Rows(j).Item("Colwidth"))
                                    End If
                                    row.Cells(j).Controls.Add(txtBox)

                                ElseIf ftype.ToUpper() = "FORMULA FIELD" Then
                                    Dim txtBox As New TextBox
                                    txtBox.ID = "fld" & FldID & row.RowIndex
                                    txtBox.Width = controlWdth - 10
                                    txtBox.CssClass = "txtBox"
                                    If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
                                        txtBox.Enabled = True
                                    Else
                                        txtBox.Enabled = False
                                    End If

                                    If ViewState("chkadd") = 1 Then
                                        j = j + 1
                                    End If
                                    If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
                                        txtBox.Text = row.Cells(j).Text
                                    Else
                                        txtBox.Text = "0"
                                    End If
                                    If Not Convert.ToString(dtfld1.Rows(j).Item("Colwidth")) = String.Empty Then
                                        txtBox.Width = Convert.ToString(dtfld1.Rows(j).Item("Colwidth"))
                                    End If
                                    row.Cells(j).Controls.Add(txtBox)

                                ElseIf ftype.ToUpper() = "TEXT AREA" Then
                                    Dim txtBox As New TextBox
                                    txtBox.ID = "fld" & FldID & row.RowIndex
                                    txtBox.Width = controlWdth + 50
                                    txtBox.Height = 50
                                    txtBox.TextMode = TextBoxMode.MultiLine
                                    txtBox.Columns = 4
                                    txtBox.Rows = 10
                                    txtBox.CssClass = "txtBox"
                                    If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
                                        txtBox.Enabled = True
                                    Else
                                        txtBox.Enabled = False
                                    End If

                                    If ViewState("chkadd") = 1 Then
                                        j = j + 1
                                    End If
                                    If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
                                        txtBox.Text = row.Cells(j).Text
                                    End If
                                    If Not Convert.ToString(dtfld1.Rows(j).Item("Colwidth")) = String.Empty Then
                                        txtBox.Width = Convert.ToString(dtfld1.Rows(j).Item("Colwidth"))
                                    End If
                                    row.Cells(j).Controls.Add(txtBox)

                                ElseIf ftype.ToUpper() = "AUTOCOMPLETE" Then

                                    Dim txtbox As New TextBox
                                    txtbox.ID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
                                    txtbox.Width = controlWdth - 10
                                    txtbox.CssClass = "txtBox"
                                    txtbox.Attributes.Add("placeholder", "Please begin typing a " & DisplayName)
                                    txtbox.AutoPostBack = True
                                    AddHandler txtbox.TextChanged, AddressOf txtbox_TextChanged
                                    ' adding handler for binding lookup or other dropdown or filter

                                    Dim autofilExtender As New AjaxControlToolkit.AutoCompleteExtender
                                    autofilExtender.ID = "extenderID" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex

                                    autofilExtender.TargetControlID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
                                    autofilExtender.ServiceMethod = "GetCompletionList" ' THIS SERVICE METHOD IS WRITTEN ON DOCUMENT PAGE 
                                    autofilExtender.DelimiterCharacters = ""
                                    autofilExtender.ContextKey = dtfld1.Rows(j).Item("DROPDOWN").ToString() & "-" & dtfld1.Rows(j).Item("FieldID").ToString() & "-" & dtfld1.Rows(j).Item("DROPDOWNTYPE").ToString() & "-" & dtfld1.Rows(j).Item("AUTOFILTER").ToString() & "-" & dtfld1.Rows(j).Item("inlinefilter").ToString()
                                    'context key contain  : dropdown-fieldid-dropdowntype-autofilter-InitialFilter' adding the fieldid in context key because later on we need id of field in web method 
                                    autofilExtender.Enabled = True
                                    autofilExtender.CompletionSetCount = 5
                                    autofilExtender.OnClientShown = "onDataShown"  ' by sunil
                                    '   autofilExtender.CompletionListElementID = "ACsugestlist"
                                    autofilExtender.MinimumPrefixLength = 1  ' start searching when entered one characters
                                    'autofilExtender.OnClientItemSelected = "ace_itemSelected('" & ds.Rows(i).Item("FieldID").ToString() & "')"
                                    autofilExtender.OnClientItemSelected = "ace_itemSelected"
                                    If Not Convert.ToString(dtfld1.Rows(j).Item("Colwidth")) = String.Empty Then
                                        txtbox.Width = Convert.ToString(dtfld1.Rows(j).Item("Colwidth"))
                                    End If
                                    row.Cells(j).Controls.Add(txtbox)

                                    'pnlFields.Controls.Add(txtbox)

                                    Dim hdnfld As New HiddenField
                                    hdnfld.ID = "HDN" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
                                    row.Cells(j).Controls.Add(hdnfld)
                                    'pnlFields.Controls.Add(img)
                                    'pnlFields.Controls.Add(prgBar)
                                    row.Cells(j).Controls.Add(autofilExtender)
                                    'pnlFields.Controls.Add(autofilExtender)



                                ElseIf ftype.ToUpper() = "MULTI LOOKUPDDL" Then

                                    Dim ddl As New DropDownList
                                    ddl.ID = "fld" & FldID & "_" & row.RowIndex
                                    ddl.CssClass = "txtBox"
                                    ddl.Width = 150

                                    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
                                    Dim con As SqlConnection = New SqlConnection(conStr)
                                    Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
                                    Dim od As SqlDataAdapter = New SqlDataAdapter("", con)
                                    Dim dt As New DataTable
                                    Dim dtval As New DataTable
                                    Dim fieldid As String()
                                    Dim ddlval As String()
                                    If (ddlText.ToString() <> String.Empty) Then
                                        fieldid = ddlText.ToString().Split(",")
                                        'With(nolock) added by Himank on 29th sep 2015
                                        od.SelectCommand.CommandText = "select ddlMultilookupval from mmm_mst_fields  WITH(NOLOCK)  where fieldid = " & fieldid(0).ToString() & ""
                                        od.Fill(dtval)
                                        If (dtval.Rows.Count > 0) Then
                                            ddlval = dtval.Rows(0)("ddlMultilookupval").ToString().Split(",")
                                            For q As Integer = 0 To ddlval.Length - 1
                                                If (ddlval(q).ToString().Contains("-" & dtfld1.Rows(j).Item("FieldID").ToString())) Then
                                                    Dim temp() As String = ddlval(q).ToString().Split("-")
                                                    'With(nolock) added by Himank on 29th sep 2015
                                                    od.SelectCommand.CommandText = "select * from MMM_MST_FIELDS  WITH(NOLOCK)  where DOCUMENTTYPE='" & temp(0).ToString() & "' and eid=" & HttpContext.Current.Session("EID") & " and fieldmapping in('" & temp(1).ToString() & "')"
                                                    Dim checkval As New DataTable
                                                    od.Fill(checkval)
                                                    Dim ddlText1 As String = checkval.Rows(0).Item("dropdown").ToString()
                                                    Dim dropdowntype As String = checkval.Rows(0).Item("dropdowntype").ToString()
                                                    Dim arr() As String
                                                    If UCase(dropdowntype) = "MASTER VALUED" Then
                                                        Dim ob As New DynamicForm
                                                        arr = ddlText1.Split("-")
                                                        Dim TID As String = "TID"
                                                        Dim TABLENAME As String = ""
                                                        If UCase(arr(0).ToString()) = "MASTER" Then
                                                            TABLENAME = "MMM_MST_MASTER"
                                                        ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
                                                            TABLENAME = "MMM_MST_DOC"
                                                        ElseIf UCase(arr(0).ToString()) = "CHILD" Then
                                                            TABLENAME = "MMM_MST_DOC_ITEM"
                                                        ElseIf UCase(arr(0).ToString) = "STATIC" Then
                                                            If arr(1).ToString.ToUpper = "USER" Then
                                                                TABLENAME = "MMM_MST_USER"
                                                                TID = "UID"
                                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
                                                                TABLENAME = "MMM_MST_LOCATION"
                                                                TID = "LOCID"
                                                            End If
                                                        ElseIf UCase(arr(0).ToString) = "SESSION" Then
                                                            If arr(1).ToString.ToUpper = "USER" Then
                                                                TABLENAME = "MMM_MST_USER"
                                                                TID = "UID"
                                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
                                                                TABLENAME = "MMM_MST_LOCATION"
                                                                TID = "LOCID"
                                                            End If
                                                        End If
                                                        Dim lookUpqry As String = ""
                                                        Dim str As String = ""
                                                        'With(nolock) added by Himank on 29th sep 2015
                                                        If arr(0).ToUpper() = "CHILD" Then
                                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M   WITH(NOLOCK) WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                                        ElseIf arr(0).ToUpper() = "SESSION" Then
                                                            str = "Select " & IIf(arr(1).ToString.ToUpper = "USER", "UserName, ", "LocationName, ") & TID & " from " & TABLENAME & " M  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("EID") & " AND " & arr(2) & "='" & HttpContext.Current.Session(arr(2)) & "'"
                                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
                                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                                        Else
                                                            If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
                                                                str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  "
                                                            Else
                                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                                            End If
                                                        End If

                                                        Dim xwhr As String = ""
                                                        Dim tids As String = ""
                                                        'Dim tidarr() As String

                                                        ''FILTER THE DATA ACCORDING TO USER 
                                                        tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())

                                                        If tids.Length >= 2 Then
                                                            'tidarr = tids.Split("-")
                                                            xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
                                                        ElseIf tids = "0" Then
                                                            pnlFields.Visible = False
                                                            btnActEdit.Visible = False
                                                            UpdatePanel1.Update()
                                                            xwhr = ""
                                                        End If
                                                        str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                                        Dim AutoFilter As String = dtfld1.Rows(j).Item("AutoFilter").ToString()
                                                        If AutoFilter.Length > 0 Then
                                                            If arr(0).ToUpper() = "CHILD" Then
                                                                If AutoFilter.ToUpper = "DOCID" Then
                                                                    str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
                                                                Else
                                                                    str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
                                                                End If
                                                                'With(nolock) added by Himank on 29th sep 2015
                                                            ElseIf arr(0).ToUpper() <> "STATIC" Then
                                                                str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                                                str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                                            Else
                                                                str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " "
                                                                str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                                            End If
                                                        End If


                                                        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
                                                        Dim dss As New DataSet
                                                        If str.Length > 0 Then
                                                            oda.SelectCommand.CommandText = str
                                                            oda.Fill(dss, "FV")
                                                            Dim isAddJquery As Integer = 0
                                                            ddl.Items.Add("Select")
                                                            ddl.Items(0).Value = "0"
                                                            For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
                                                                ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
                                                                Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
                                                                ddl.Items(J1 + 1).Value = lookddlVal
                                                            Next
                                                            oda.Dispose()
                                                            dss.Dispose()
                                                            'prashant_2_7

                                                            Dim lookupvalue As String = dtfld1.Rows(j).Item("lookupvalue").ToString()
                                                            Dim multilookup As String = dtfld1.Rows(j).Item("multilookUpVal").ToString()
                                                            Dim ddlmultilookup As String = dtfld1.Rows(j).Item("ddlmultilookUpVal").ToString()

                                                            If lookupvalue.Length > 0 Or multilookup.Length > 0 Or ddlmultilookup.Length > 0 Then
                                                                ddl.AutoPostBack = True
                                                                AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged
                                                            End If

                                                            If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
                                                                ddl.Items.FindByText(row.Cells(j).Text).Selected = True
                                                            End If
                                                            If ViewState("chkadd") = 1 Then
                                                                j = j + 1
                                                            End If

                                                            If ddl.Items.FindByValue(row.Cells(j).Text) IsNot Nothing Then
                                                                'ddl.Items.FindByText(row.Cells(j).Text).Selected = True
                                                                ddl.SelectedValue = ddl.Items.FindByValue(row.Cells(j).Text).Value
                                                            End If
                                                            If Not Convert.ToString(dtfld1.Rows(j).Item("Colwidth")) = String.Empty Then
                                                                ddl.Width = Convert.ToString(dtfld1.Rows(j).Item("Colwidth"))
                                                            End If
                                                            row.Cells(j).Controls.Add(ddl)

                                                            If isAddJquery = 1 Then
                                                                Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
                                                            End If
                                                        End If
                                                        con.Dispose()
                                                        oda.Dispose()
                                                        dss.Dispose()
                                                    ElseIf UCase(dropdowntype) = "SESSION VALUED" Then

                                                    End If
                                                End If
                                            Next
                                        End If
                                    End If


                                ElseIf ftype.ToUpper() = "DROP DOWN" Then
                                    Dim ddl As New DropDownList
                                    '' this is for isinlineediting and inlinemapping (import from master/document/other child)
                                    ddl.ID = "fld" & FldID & "_" & row.RowIndex
                                    ddl.CssClass = "txtBox"
                                    ddl.Width = 150
                                    If Not Convert.ToString(dtfld1.Rows(j).Item("Colwidth")) = String.Empty Then
                                        ddl.Width = Convert.ToString(dtfld1.Rows(j).Item("Colwidth"))
                                    End If
                                    Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
                                    Dim dropdowntype As String = dtfld1.Rows(j).Item("dropdowntype").ToString()
                                    Dim arr() As String
                                    If dtfld1.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
                                        'Dim cb As New DropDownList
                                        ' cb.ID = "fld" & FldID & row.RowIndex
                                        ddl.Items.Add("Select")
                                        ddl.Items(0).Value = "0"

                                        Dim ARR1() As String = dtfld1.Rows(j).Item("dropdown").ToString().Split(",")
                                        For K As Integer = 0 To ARR1.Length - 1
                                            ddl.Items.Add(ARR1(K).ToString)
                                        Next

                                        '' for default value selection
                                        If dtfld1.Rows(j).Item("ddlval").ToString().Length > 0 Then
                                            Dim dropdowntypeFill As String = dtfld1.Rows(j).Item("ddlval").ToString().ToUpper()
                                            ddl.SelectedIndex = ddl.Items.IndexOf(ddl.Items.FindByText(dropdowntypeFill))
                                        End If

                                        ' If dtfld1.Rows(j).Item("maxlen").ToString() = "" Then
                                        ddl.Width = 70
                                        ' End If

                                        If ViewState("chkadd") = 1 Then
                                            j = j + 1
                                        End If





                                        If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
                                            'ddl.Items.FindByText(row.Cells(j).Text).Selected = True
                                            ddl.SelectedValue = ddl.Items.FindByText(row.Cells(j).Text).Value
                                        End If

                                        row.Cells(j).Controls.Add(ddl)
                                        'Prashant_10_7
                                        If dtfld1.Rows(j).Item("iseditable") = 1 Then
                                            ddl.Enabled = True
                                        Else
                                            ddl.Enabled = False
                                        End If

                                    ElseIf dtfld1.Rows(j).Item("dropdowntype").ToString() = "MASTER VALUED" Then
                                        '' code for getting master valued 
                                        Dim ob As New DynamicForm
                                        arr = ddlText.Split("-")
                                        Dim TID As String = "TID"
                                        Dim TABLENAME As String = ""
                                        If UCase(arr(0).ToString()) = "MASTER" Then
                                            TABLENAME = "MMM_MST_MASTER"
                                        ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
                                            TABLENAME = "MMM_MST_DOC"
                                        ElseIf UCase(arr(0).ToString()) = "CHILD" Then
                                            TABLENAME = "MMM_MST_DOC_ITEM"
                                        ElseIf UCase(arr(0).ToString) = "STATIC" Then
                                            If arr(1).ToString.ToUpper = "USER" Then
                                                TABLENAME = "MMM_MST_USER"
                                                TID = "UID"
                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
                                                TABLENAME = "MMM_MST_LOCATION"
                                                TID = "LOCID"
                                            End If
                                        End If
                                        Dim lookUpqry As String = ""
                                        Dim str As String = ""
                                        'With(nolock) added by Himank on 29th sep 2015
                                        If arr(0).ToUpper() = "CHILD" Then
                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M   WITH(NOLOCK) WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                        Else
                                            If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
                                                str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
                                            Else
                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                            End If
                                        End If

                                        Dim xwhr As String = ""
                                        Dim tids As String = ""
                                        'Dim tidarr() As String

                                        ''FILTER THE DATA ACCORDING TO USER 
                                        tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())

                                        If tids.Length >= 2 Then
                                            'tidarr = tids.Split("-")
                                            xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
                                        ElseIf tids = "0" Then
                                            pnlFields.Visible = False
                                            btnActEdit.Visible = False
                                            UpdatePanel1.Update()
                                            xwhr = ""
                                        End If
                                        str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                        Dim AutoFilter As String = dtfld1.Rows(j).Item("AutoFilter").ToString()
                                        If AutoFilter.Length > 0 Then
                                            If arr(0).ToUpper() = "CHILD" Then
                                                If AutoFilter.ToUpper = "DOCID" Then
                                                    str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
                                                Else
                                                    str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
                                                End If
                                                'With(nolock) added by Himank on 29th sep 2015
                                            ElseIf arr(0).ToUpper() <> "STATIC" Then
                                                str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                                str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                            Else
                                                str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " "
                                                str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
                                            End If
                                        End If

                                        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
                                        Dim con As SqlConnection = New SqlConnection(conStr)
                                        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
                                        Dim dss As New DataSet

                                        If str.Length > 0 Then
                                            oda.SelectCommand.CommandText = str
                                            oda.Fill(dss, "FV")
                                            Dim isAddJquery As Integer = 0
                                            ddl.Items.Add("Select")
                                            ddl.Items(0).Value = "0"
                                            For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
                                                ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
                                                Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
                                                ddl.Items(J1 + 1).Value = lookddlVal
                                            Next
                                            oda.Dispose()
                                            dss.Dispose()
                                            'prashant_2_7

                                            Dim lookupvalue As String = dtfld1.Rows(j).Item("lookupvalue").ToString()
                                            Dim multilookup As String = dtfld1.Rows(j).Item("multilookUpVal").ToString()
                                            Dim ddlmultilookup As String = dtfld1.Rows(j).Item("ddlmultilookUpVal").ToString()
                                            'LT Lookupval changes
                                            Dim LTLookupval As String = Convert.ToString(dtfld1.Rows(j).Item("LTlookupval"))

                                            If lookupvalue.Length > 0 Or multilookup.Length > 0 Or ddlmultilookup.Length > 0 Or LTLookupval.Length > 0 Then
                                                ddl.AutoPostBack = True
                                                AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged
                                            End If


                                            ' '' new by sp on 18-nov-15 for Burgerking ticket
                                            'If Len(Convert.ToString(dtfld1.Rows(j).Item("ddlval"))) > 1 Then
                                            '    Dim DDldefaultVal As String = Convert.ToString(dtfld1.Rows(j).Item("ddlval"))
                                            '    ddl.SelectedIndex = ddl.Items.IndexOf(ddl.Items.FindByValue(DDldefaultVal))
                                            '    Dim id As String = Right(ddl.ID, ddl.ID.Length - 3)
                                            '    Dim ar() As String = id.Split("_")
                                            '    Dim id1 As Integer = CInt(ar(0))
                                            '    BindGRidLookup(ar(1), id1, ddl)
                                            '    Dim ob1 As New DynamicForm()
                                            '    ob1.GridMultiLookup(ar(1), id1, ddl, lblTab, pnlFields)
                                            '    ob1.GridLTLookup(ar(1), id1, ddl, lblTab, pnlFields)
                                            '    BindGRidLookupDDL(ar(1), id1, ddl)
                                            'End If
                                            ' '' new by sp on 18-nov-15 for Burgerking ticket - ends 

                                            If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
                                                ddl.Items.FindByText(row.Cells(j).Text).Selected = True
                                            End If
                                            If ViewState("chkadd") = 1 Then
                                                j = j + 1
                                            End If

                                            If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
                                                'ddl.Items.FindByText(row.Cells(j).Text).Selected = True
                                                ddl.SelectedValue = ddl.Items.FindByText(row.Cells(j).Text).Value
                                            End If

                                            row.Cells(j).Controls.Add(ddl)

                                            If isAddJquery = 1 Then
                                                Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
                                            End If
                                        End If
                                        con.Dispose()
                                        oda.Dispose()
                                        dss.Dispose()
                                        '' ends here for getting master valued -- changed by sp on 04_May_16
                                        If dtfld1.Rows(j).Item("iseditable") = 0 Then
                                            ddl.Enabled = False
                                        End If
                                    End If
                                ElseIf ftype.ToUpper() = "CHECKBOX LIST" Then
                                    Dim CHKlIST As New CheckBoxList()
                                    Dim dynmdiv As System.Web.UI.HtmlControls.HtmlGenericControl = New System.Web.UI.HtmlControls.HtmlGenericControl("DIV")
                                    dynmdiv.ID = "div_" & FldID
                                    Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
                                    CHKlIST.ID = "fld" & FldID & "_" & row.RowIndex
                                    If dtfld1.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
                                        Dim arr = ddlText.Split(",")
                                        For ii As Integer = 0 To arr.Count - 1
                                            CHKlIST.Items.Add(arr(ii).ToUpper())
                                        Next

                                    ElseIf dtfld1.Rows(j).Item("dropdowntype").ToString() = "MASTER VALUED" Then
                                        Dim arr = ddlText.Split("-")
                                        Dim TID As String = "TID"
                                        Dim TABLENAME As String = ""
                                        If UCase(arr(0).ToString()) = "MASTER" Then
                                            TABLENAME = "MMM_MST_MASTER"
                                        ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
                                            TABLENAME = "MMM_MST_DOC"
                                        ElseIf UCase(arr(0).ToString()) = "CHILD" Then
                                            TABLENAME = "MMM_MST_DOC_ITEM"
                                        ElseIf UCase(arr(0).ToString) = "STATIC" Then
                                            If arr(1).ToString.ToUpper = "USER" Then
                                                TABLENAME = "MMM_MST_USER"
                                                TID = "UID"
                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
                                                TABLENAME = "MMM_MST_LOCATION"
                                                TID = "LOCID"
                                            End If
                                        End If
                                        Dim lookUpqry As String = ""
                                        Dim str As String = ""
                                        'With(nolock) added by Himank on 29th sep 2015
                                        If arr(0).ToUpper() = "CHILD" Then
                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                        Else
                                            If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
                                                str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
                                            Else
                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                            End If
                                        End If
                                        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
                                        Dim con As SqlConnection = New SqlConnection(conStr)
                                        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
                                        oda = New SqlDataAdapter("", con)
                                        Dim dss As New DataSet
                                        oda.SelectCommand.CommandText = str
                                        oda.Fill(dss, "FV")
                                        For JJ As Integer = 0 To dss.Tables("FV").Rows.Count - 1
                                            CHKlIST.Items.Add(dss.Tables("FV").Rows(JJ).Item(0))
                                            CHKlIST.Items(JJ).Value = dss.Tables("FV").Rows(JJ).Item(1)
                                        Next
                                        oda.Dispose()
                                        dss.Dispose()
                                    End If

                                    dynmdiv.Style.Add(HtmlTextWriterStyle.Width, "200px")
                                    dynmdiv.Style.Add(HtmlTextWriterStyle.Height, "100px")
                                    dynmdiv.Style.Add(HtmlTextWriterStyle.Overflow, "Scroll")
                                    If Not Convert.ToString(dtfld1.Rows(j).Item("Colwidth")) = String.Empty Then
                                        CHKlIST.Width = Convert.ToString(dtfld1.Rows(j).Item("Colwidth"))
                                    End If
                                    dynmdiv.Controls.Add(CHKlIST)
                                    row.Cells(j).Controls.Add(dynmdiv)

                                ElseIf ftype.ToUpper = "LOOKUPDDL" Then

                                    datatype = dtfld1.Rows(j).Item("datatype").ToString().ToUpper()
                                    Dim fieldtypee As String = dtfld1.Rows(j).Item("FieldType").ToString().ToUpper()
                                    Dim ddl As New DropDownList
                                    ddl.ID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & "_" & row.RowIndex
                                    ddl.Width = controlWdth - 10
                                    ddl.CssClass = "txtBox"
                                    Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
                                    Dim dropdowntype As String = dtfld1.Rows(j).Item("dropdowntype").ToString()
                                    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
                                    Dim con As SqlConnection = New SqlConnection(conStr)
                                    'With(nolock) added by Himank on 29th sep 2015
                                    Dim od As SqlDataAdapter = New SqlDataAdapter("select dropdown,DDllookupvalue from MMM_MST_FIELDS   WITH(NOLOCK) where FieldID='" & ddlText & "'", con)
                                    ' Dim dsMonth As New DataSet
                                    Dim dt As New DataTable
                                    od.Fill(dt)
                                    Dim arr() As String
                                    Dim darr() As String
                                    Dim type As String = dt.Rows(0).Item("dropdown").ToString()
                                    arr = type.Split("-")
                                    Dim documenttype As String = arr(1).ToString()
                                    Dim field As String = dt.Rows(0).Item("DDllookupvalue").ToString()
                                    field = field.Substring(0, field.Length - 1)
                                    darr = field.Split(",")
                                    For k As Integer = 0 To darr.Count - 1
                                        Dim fieldmping As String
                                        Dim str As String = ""
                                        Dim feild As String
                                        Dim s = darr(k).Split("-")
                                        feild = s(0).ToString()
                                        fieldmping = s(1).ToString()

                                        Dim TID As String = "TID"
                                        Dim TABLENAME As String = ""
                                        Dim str1 As String = ""
                                        Dim lookUpqry As String = ""

                                        Dim xwhr As String = ""
                                        Dim tids As String = ""
                                        Dim Rtids As String = ""   ' for prerole data filter


                                        If feild = dtfld1.Rows(j).Item("FieldID").ToString() Then
                                            'If arr(0) = "SESSION" And Not (fieldmping.Contains("fld")) Then
                                            '    If arr(1).ToString.ToUpper = "USER" Then
                                            '        TABLENAME = "MMM_MST_USER"
                                            '        TID = "UID"
                                            '    End If
                                            '    ' str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                            '    str1 = "select " & fieldmping.ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                            'Else

                                            'With(nolock) added by Himank on 29th sep 2015
                                            od.SelectCommand.CommandText = "select dropdown from MMM_MST_FIELDS  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("EID") & " and documenttype='" & documenttype & "' and FieldMapping in('" & fieldmping & "')"
                                            Dim dt1 As New DataTable
                                            od.Fill(dt1)
                                            Dim dropdown As String = dt1.Rows(0).Item("dropdown").ToString()
                                            arr = dropdown.Split("-")

                                            If UCase(arr(0).ToString()) = "MASTER" Then
                                                TABLENAME = "MMM_MST_MASTER"
                                            ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
                                                TABLENAME = "MMM_MST_DOC"
                                            ElseIf UCase(arr(0).ToString()) = "CHILD" Then
                                                TABLENAME = "MMM_MST_DOC_ITEM"
                                            ElseIf UCase(arr(0).ToString) = "STATIC" Then
                                                If arr(1).ToString.ToUpper = "USER" Then
                                                    TABLENAME = "MMM_MST_USER"
                                                    TID = "UID"
                                                ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
                                                    TABLENAME = "MMM_MST_LOCATION"
                                                    TID = "LOCID"
                                                End If
                                            ElseIf UCase(arr(0).ToString) = "SESSION" Then
                                                If arr(1).ToString.ToUpper = "USER" Then
                                                    TABLENAME = "MMM_MST_USER"
                                                    TID = "UID"
                                                ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
                                                    TABLENAME = "MMM_MST_LOCATION"
                                                    TID = "LOCID"
                                                End If
                                            End If
                                            'With(nolock) added by Himank on 29th sep 2015
                                            If arr(0).ToUpper() = "CHILD" Then
                                                str1 = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                            ElseIf arr(0).ToUpper() = "SESSION" Then
                                                str1 = "Select " & IIf(arr(1).ToString.ToUpper = "USER", "UserName, ", "LocationName, ") & TID & " from " & TABLENAME & " M  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("EID") & " AND " & arr(2) & "='" & HttpContext.Current.Session(arr(2)) & "'"
                                            ElseIf arr(0).ToUpper() <> "STATIC" Then
                                                str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                                            Else
                                                If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
                                                    str1 = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  "
                                                Else
                                                    str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
                                                End If
                                            End If
                                            '  End If

                                            'Dim tidarr() As String

                                            ''FILTER THE DATA ACCORDING TO USER 
                                            Dim ob = New DynamicForm()
                                            tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())
                                            Rtids = ob.UserDataFilter_PreRole(arr(1).ToString(), TABLENAME)  '' new by sunil for pre role data filter 22-feb

                                            '' for multiuse of document by sp on 08_apr_15
                                            Dim Sdtype As String = arr(1).ToString
                                            Dim da As SqlDataAdapter = New SqlDataAdapter("", con)
                                            da.SelectCommand.CommandType = CommandType.Text
                                            'With(nolock) added by Himank on 29th sep 2015
                                            da.SelectCommand.CommandText = "select isnull(Allowmultiuse,0) from mmm_mst_forms  WITH(NOLOCK)  where eid='" & HttpContext.Current.Session("EID").ToString & "' AND FORMNAME='" & Sdtype & "'"
                                            If con.State <> ConnectionState.Open Then
                                                con.Open()
                                            End If
                                            Dim isMultiUse As Integer = Convert.ToInt32(da.SelectCommand.ExecuteScalar())

                                            Dim CurrDoctype As String = dtfld1.Rows(j).Item("documenttype").ToString()
                                            Dim CurrFieldMapping As String = dtfld1.Rows(j).Item("fieldmapping").ToString()

                                            Dim qry As String = ""
                                            Dim MTids As String = ""
                                            If UCase(arr(0).ToString()) <> "CHILD" And UCase(arr(0).ToString) <> "STATIC" And UCase(arr(0).ToString) <> "SESSION" Then
                                                da.SelectCommand.CommandType = CommandType.Text
                                                da.SelectCommand.CommandText = "SELECT SUBSTRING((SELECT ',' + CONVERT(NVARCHAR," & CurrFieldMapping & ")  FROM " & TABLENAME & " where EID=" & HttpContext.Current.Session("eid") & " and documenttype='" & CurrDoctype & "'" & " FOR XML PATH('')),2,1000) AS CSV"
                                                MTids = Convert.ToString(da.SelectCommand.ExecuteScalar())
                                            End If
                                            ''ends  for multiuse of document by sp on 08_apr_15


                                            If tids.Length >= 2 Then
                                                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
                                            ElseIf tids = "0" Then
                                                pnlFields.Visible = False
                                                btnActEdit.Visible = False
                                                UpdatePanel1.Update()
                                                xwhr = ""
                                            End If
                                            '' new by sunil for pre role data filter 22-feb
                                            If Rtids <> "" Then
                                                If xwhr.ToString = "" Then
                                                    xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & Rtids & ")"
                                                Else
                                                    xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & "," & Rtids & ")"
                                                End If
                                            End If

                                            '' new by sunil for multiuse of docs
                                            If MTids.Length > 2 And isMultiUse = 1 Then
                                                If Right(MTids, 1) = "," Then
                                                    MTids = Left(MTids, Len(MTids) - 1)
                                                End If
                                                xwhr = xwhr & " AND CONVERT(NVARCHAR(10),TID) not IN (" & MTids & ") "
                                            End If
                                            '' new by sunil for multiuse of docs

                                            str1 = str1 & "  AND M.isauth>0 " & xwhr & " order by " & arr(2).ToString()
                                            'Dim documenttype2 As String = arr1(1).ToString()
                                            'Dim fieldmping2 As String = arr1(2).ToString()
                                            'pnlFields.Controls.Add(ddl)
                                            Dim dt2 As New DataTable
                                            'oda.SelectCommand.CommandText = "select " & fieldmping2 & " from " & TABLENAME & " where EID=" & HttpContext.Current.Session("EID") & " and documenttype = '" & documenttype2 & "'"

                                            If str1.Length > 0 Then
                                                pnlFields.Controls.Add(ddl)
                                                od.SelectCommand.CommandText = str1
                                                od.Fill(dt2)
                                                Dim isAddJquery As Integer = 0
                                                ddl.Items.Add("Select")
                                                ddl.Items(0).Value = "0"
                                                For JK As Integer = 0 To dt2.Rows.Count - 1
                                                    ddl.Items.Add(dt2.Rows(JK).Item(0).ToString())
                                                    Dim lookddlVal As String = dt2.Rows(JK).Item(1).ToString()
                                                    ddl.Items(JK + 1).Value = lookddlVal
                                                Next
                                                dt2.Dispose()
                                            End If
                                            If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
                                                ddl.Enabled = True
                                            Else
                                                ddl.Enabled = False
                                            End If
                                        End If
                                    Next
                                    If Not Convert.ToString(dtfld1.Rows(j).Item("Colwidth")) = String.Empty Then
                                        ddl.Width = Convert.ToString(dtfld1.Rows(j).Item("Colwidth"))
                                    End If
                                    row.Cells(j).Controls.Add(ddl)

                                ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
                                    Dim txtBox As New FileUpload

                                    'Prashant 30-6-2014
                                    Dim txtBox1 As New HiddenField

                                    Dim lbl1 As New Label
                                    lbl1.ID = "lblf_" & FldID
                                    lbl1.Text = ""
                                    lbl1.ClientIDMode = ClientIDMode.Static

                                    txtBox1.ID = "hdn_" & FldID
                                    txtBox1.Value = ""
                                    txtBox1.ClientIDMode = ClientIDMode.Static
                                    If Convert.ToInt32(objDC.ExecuteQryScaller("select count(*) from  mmm_hdmail_schdule where  eid=" & dtfld1.Rows(j).Item("EID").ToString() & " and DocumentType in(select documenttype from mmm_mst_fields where dropdown='" & dtfld1.Rows(j).Item("documenttype").ToString() & "' and eid=" & dtfld1.Rows(j).Item("EID").ToString() & ")")) > 0 Then
                                        If Not Request.QueryString("TID") Is Nothing Then
                                            txtBox.Attributes.Add("onchange", "TicketUtils.UploadFile1(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
                                        Else
                                            txtBox.Attributes.Add("onchange", "TicketUtils.UploadFile(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
                                        End If
                                    Else
                                        If Not Request.QueryString("TID") Is Nothing Then
                                            txtBox.Attributes.Add("onchange", "UtilJs.UploadFile1(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
                                        Else
                                            txtBox.Attributes.Add("onchange", "UtilJs.UploadFile(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
                                        End If
                                    End If
                                    'If Not Request.QueryString("TID") Is Nothing Then
                                    '    txtBox.Attributes.Add("onchange", "UtilJs.UploadFile1(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
                                    'Else
                                    '    txtBox.Attributes.Add("onchange", "UtilJs.UploadFile(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
                                    'End If



                                    txtBox.ID = "fld_" & FldID & "_" & row.RowIndex  ' added  id  with _ by balli
                                    txtBox.CssClass = "txtBox"

                                    txtBox.Width = 180
                                    If Not Convert.ToString(dtfld1.Rows(j).Item("Colwidth")) = String.Empty Then
                                        txtBox.Width = Convert.ToString(dtfld1.Rows(j).Item("Colwidth"))
                                    End If

                                    Dim hdnflag As New HiddenField
                                    If Not Request.QueryString("TID") Is Nothing Then
                                        hdnflag.ID = "hdnf_" & FldID
                                        hdnflag.Value = "0"
                                        Dim str As String = row.Cells(j).Text

                                        str = After(str, "/")

                                        txtBox1.Value = str 'row.Cells(j).Text
                                        lbl1.Text = str ' row.Cells(j).Text
                                        row.Cells(j).Text = str
                                    End If
                                    If ViewState("chkadd") = 1 Then
                                        j = j + 1
                                    End If
                                    row.Cells(j).Controls.Add(txtBox)
                                    'Prashant 30-6-2014
                                    row.Cells(j).Controls.Add(txtBox1)
                                    row.Cells(j).Controls.Add(lbl1)
                                    row.Cells(j).Controls.Add(hdnflag)

                                    Dim pstback As New PostBackTrigger
                                    pstback.ControlID = btnActEdit.ID
                                    UpdatePanel1.Triggers.Add(pstback)
                                    'Changes for LT Lookup
                                ElseIf ftype.ToUpper() = "LT LOOKUP" Then
                                    Dim txtBox As New TextBox
                                    txtBox.ID = "fld" & FldID & row.RowIndex
                                    txtBox.Width = controlWdth - 10
                                    txtBox.CssClass = "txtBox"
                                    If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
                                        txtBox.Enabled = True
                                    Else
                                        txtBox.Enabled = False
                                    End If

                                    If ViewState("chkadd") = 1 Then
                                        j = j + 1
                                    End If
                                    If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
                                        txtBox.Text = row.Cells(j).Text
                                    End If
                                    If Not Convert.ToString(dtfld1.Rows(j).Item("Colwidth")) = String.Empty Then
                                        txtBox.Width = Convert.ToString(dtfld1.Rows(j).Item("Colwidth"))
                                    End If
                                    row.Cells(j).Controls.Add(txtBox)

                                End If
                                If ViewState("chkadd") = 1 Then
                                    j = j - 1    ' added for incremental 
                                End If
                            End If

                        Next
                    End If
                End If
            End If
        Catch ex As Exception
            Dim a As String = ""
        End Try
    End Sub

    ''''bkup 15-jul-16

    'Protected Sub gvData_InlineEdit(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewRowEventArgs)
    '    Try
    '        Dim fn As String = ""
    '        Dim objDC As New DataClass
    '        'Dim dtFld1 As DataTable = ViewState(fn) ' Session(fn)
    '        Dim dtfld1 As DataTable '= ViewState(fn)
    '        Dim row As GridViewRow = e.Row

    '        Dim fns() As String = Session("FNS").ToString.Split(":")
    '        'Dim GV As GridView = 
    '        Dim GID As String = row.Parent.Parent.ID
    '        GID = Right(GID, GID.Length - 3)
    '        'Prashant 30-6-2014
    '        Session("GRDID") = GID
    '        '' new added for hiding tid - on 27 dec 8.30 pm by sp
    '        e.Row.Cells(e.Row.Cells.Count - 1).Visible = False

    '        For I As Integer = 0 To fns.Length - 1
    '            If fns(I).ToString = GID.ToString Then
    '                fn = fns(I - 1).ToString
    '                Exit For
    '            End If
    '        Next
    '        dtfld1 = Session("D" & fn)
    '        For m As Integer = 0 To row.Cells.Count - 1
    '            row.Cells(m).HorizontalAlign = HorizontalAlign.Center
    '            row.Cells(m).Width = 15
    '        Next

    '        'Dim chkadd As Integer = 0

    '        If row.RowType = DataControlRowType.Header Then  ' for header bind checkbox to check all in grid 
    '            If row.Cells(0).Text = "All" Then
    '                Dim chk As New CheckBox
    '                chk.Text = "All"
    '                chk.Attributes.Add("onclick", "javascript:checkAll('" & GID & "');")
    '                row.Cells(0).Controls.Add(chk)
    '                ViewState("chkadd") = 1
    '            End If
    '            If row.Cells(e.Row.Cells.Count - 2).Text = "cmasterTid" Then
    '                ViewState("cmasterId") = 1
    '                row.Cells(e.Row.Cells.Count - 2).Visible = False
    '            End If

    '            For i As Integer = 0 To row.Cells.Count - 1
    '                If row.Cells(i).Text.ToUpper = "TID" Then
    '                    row.Cells(i).Visible = False
    '                    ViewState("Tid") = i
    '                End If
    '            Next
    '        End If

    '        If row.RowType = DataControlRowType.DataRow Then
    '            ' For j As Integer = 0 To row.Cells.Count - 1
    '            If ViewState("cmasterId") = 1 Then 'by neha thakar to hide CmasterId  
    '                row.Cells(row.Cells.Count - 2).Visible = False
    '            End If

    '            If Not IsNothing(ViewState("Tid")) Then
    '                row.Cells(Convert.ToInt32(ViewState("Tid"))).Visible = False
    '            End If

    '            Dim controlWdth As Integer = 100
    '            If row.Cells(0).Text.ToUpper <> "TOTAL" Then
    '                If ViewState("chkadd") = 1 Then  'this is for adding child check box 
    '                    Dim chk As New CheckBox
    '                    chk.ID = "fld" & row.RowIndex
    '                    row.Cells(0).Controls.Add(chk)
    '                End If
    '                'By Neha Thakar 23-01-15
    '                ' To add new row when add Data Button is clicked in Child item
    '                If Not IsNothing(Session("FilterAddedRow")) Then
    '                    Session("AddedRow") = Session("FilterAddedRow")
    '                End If
    '                Dim DICT As New Dictionary(Of Integer, Integer)
    '                DICT = CType(Session("AddedRow"), Dictionary(Of Integer, Integer))

    '                If Not IsNothing(DICT) Then

    '                    If Not IsNothing(Session("AddedRow")) And DICT.ContainsKey(row.RowIndex) Then
    '                        Dim filterRows() As DataRow 'By neha Thakar 
    '                        filterRows = dtfld1.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''", "InLineEditing, DisplayOrder")
    '                        'filterRows = dtfld1.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''", "InLineEditing, DisplayOrder")
    '                        dtfld1 = filterRows.CopyToDataTable()

    '                        Dim filterRows1() As DataRow
    '                        Dim filterRows2() As DataRow
    '                        filterRows1 = dtfld1.Select("inlinemapping is not null and inlinemapping <>''", "DisplayOrder")
    '                        filterRows2 = dtfld1.Select("InLineEditing=1 and inlinemapping is null", "DisplayOrder")
    '                        If filterRows.Length > 0 Then
    '                            If filterRows1.Length > 0 Then
    '                                dtfld1 = filterRows1.CopyToDataTable()
    '                                If filterRows2.Length > 0 Then
    '                                    dtfld1.Merge(filterRows2.CopyToDataTable())
    '                                End If
    '                            Else
    '                                If filterRows2.Length > 0 Then
    '                                    dtfld1 = filterRows2.CopyToDataTable()
    '                                End If
    '                            End If

    '                        Else
    '                            dtfld1 = filterRows2.CopyToDataTable()
    '                        End If

    '                        For l As Integer = 0 To dtfld1.Rows.Count - 1
    '                            Dim colValue As String = row.DataItem(l).ToString()
    '                            Dim ftype1 As String = dtfld1.Rows(l).Item("fieldtype").ToString()
    '                            Dim ilEdit1 As Integer = dtfld1.Rows(l).Item("inlineEditing").ToString()
    '                            Dim datatype1 As String = dtfld1.Rows(l).Item("datatype").ToString() 'Prashant_10_7
    '                            Dim controlWdth1 As Integer = 100

    '                            Dim FldID1 As String = dtfld1.Rows(l).Item("fieldid").ToString()
    '                            Dim Formula1 = Convert.ToString(dtfld1.Rows(l).Item("cal_text"))
    '                            Dim DisplayName1 = Convert.ToString(dtfld1.Rows(l).Item("DisplayName"))
    '                            ' If ilEdit1 = 1 Then
    '                            If ftype1.ToUpper() = "TEXT BOX" Or ftype1.ToUpper() = "CALCULATIVE FIELD" Or ftype1.ToUpper() = "LOOKUP" Or ftype1.ToUpper() = "PARENT VALUE" Then
    '                                Dim cb As New TextBox
    '                                'cb.ID = "fld" & l.ToString() & "_" & row.RowIndex
    '                                cb.Width = 55
    '                                cb.ID = "fld" & FldID1 & row.RowIndex

    '                                'Prashant_10_7
    '                                If dtfld1.Rows(l).Item("defaultfieldval").ToString().Length > 0 Then
    '                                    cb.Text = dtfld1.Rows(l).Item("defaultfieldval").ToString()
    '                                Else
    '                                    If datatype1.ToUpper() = "NUMERIC" Then
    '                                        cb.Text = "0"
    '                                    End If
    '                                End If
    '                                If Val(dtfld1.Rows(l).Item("isDescription").ToString()) = 1 Then
    '                                    cb.ToolTip = dtfld1.Rows(l).Item("Description").ToString()
    '                                End If
    '                                'If dtfld1.Rows(l).Item("iseditable") = 0 Then
    '                                '    cb.Attributes.Add("READONLY", "READONLY")
    '                                '    cb.Attributes.Add("COLOR", "GRAY")
    '                                'End If


    '                                If ftype1.ToUpper() = "CALCULATIVE FIELD" Then
    '                                    colValue = "0"
    '                                    cb.Attributes.Add("READONLY", "READONLY")
    '                                    cb.Attributes.Add("COLOR", "GRAY")
    '                                End If

    '                                If ViewState("chkadd") = 1 Then
    '                                    l = l + 1
    '                                End If

    '                                If ftype1.ToUpper() = "LOOKUP" Then
    '                                    If datatype1.ToUpper() = "NUMERIC" Then
    '                                        colValue = "0"
    '                                    End If
    '                                Else
    '                                    If Val(colValue) = 0 Then
    '                                        If ftype1.ToUpper() = "TEXT BOX" And datatype1.ToUpper() = "NUMERIC" Then
    '                                            colValue = "0"
    '                                        End If
    '                                    End If
    '                                End If

    '                                If Not row.Cells(l).Text.Trim = "&nbsp;" And Not row.Cells(l).Text.Trim = "" Then
    '                                    colValue = row.Cells(l).Text.Trim
    '                                End If

    '                                cb.Text = colValue
    '                                cb.Width = controlWdth1
    '                                row.Cells(l).Controls.Add(cb)

    '                                If datatype1.ToUpper.Trim = "DATETIME" Then
    '                                    If Convert.ToString(dtfld1.Rows(l).Item("iseditable")) = "1" Then
    '                                        Dim CLNDR As New AjaxControlToolkit.CalendarExtender
    '                                        CLNDR.Controls.Clear()
    '                                        CLNDR.ID = "CLNDR" & dtfld1.Rows(l).Item("FieldID").ToString()
    '                                        CLNDR.Format = "dd/MM/yy"
    '                                        CLNDR.TargetControlID = cb.ID
    '                                        cb.Enabled = True
    '                                        If Request.QueryString("TID") Is Nothing Then
    '                                            cb.Text = String.Format("{0:dd/MM/yy}", Date.Now())
    '                                        End If

    '                                        row.Cells(l).Controls.Add(CLNDR) '
    '                                    End If

    '                                End If

    '                                If Not Formula1 Is Nothing And Formula1 <> "" Then
    '                                    'Dim arrFor As String() = Formula.Split(",")
    '                                    Dim jScript = GenerateJQueryScript(dtfld1, GID, row.RowIndex, Formula1, FldID1)
    '                                    If jScript <> "" Then
    '                                        cb.Attributes.Add("onblur", jScript)
    '                                    End If
    '                                End If
    '                                If Val(dtfld1.Rows(l).Item("HasRule").ToString()) = 1 Then
    '                                    cb.AutoPostBack = True
    '                                    AddHandler cb.TextChanged, AddressOf grdTextBoxRule_TextChanged
    '                                End If




    '                            ElseIf ftype1.ToUpper() = "AUTOCOMPLETE" Then

    '                                Dim txtbox As New TextBox
    '                                txtbox.ID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
    '                                txtbox.Width = controlWdth - 10
    '                                txtbox.CssClass = "txtBox"
    '                                txtbox.Attributes.Add("placeholder", "Please begin typing a " & DisplayName1)

    '                                txtbox.AutoPostBack = True
    '                                AddHandler txtbox.TextChanged, AddressOf txtbox_TextChanged
    '                                ' adding handler for binding lookup or other dropdown or filter

    '                                Dim autofilExtender As New AjaxControlToolkit.AutoCompleteExtender
    '                                autofilExtender.ID = "extenderID" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex

    '                                autofilExtender.TargetControlID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
    '                                autofilExtender.ServiceMethod = "GetCompletionList" ' THIS SERVICE METHOD IS WRITTEN ON DOCUMENT PAGE 
    '                                autofilExtender.DelimiterCharacters = ""
    '                                autofilExtender.ContextKey = dtfld1.Rows(l).Item("DROPDOWN").ToString() & "-" & dtfld1.Rows(l).Item("FieldID").ToString() & "-" & dtfld1.Rows(l).Item("DROPDOWNTYPE").ToString() & "-" & dtfld1.Rows(l).Item("AUTOFILTER").ToString() & "-" & dtfld1.Rows(l).Item("InitialFilter").ToString()
    '                                'context key contain  : dropdown-fieldid-dropdowntype-autofilter-InitialFilter' adding the fieldid in context key because later on we need id of field in web method 
    '                                autofilExtender.Enabled = True
    '                                autofilExtender.CompletionSetCount = 5
    '                                autofilExtender.OnClientShown = "onDataShown"  ' by sunil
    '                                '   autofilExtender.CompletionListElementID = "ACsugestlist"
    '                                autofilExtender.MinimumPrefixLength = 1  ' start searching when entered one characters
    '                                'autofilExtender.OnClientItemSelected = "ace_itemSelected('" & ds.Rows(i).Item("FieldID").ToString() & "')"
    '                                autofilExtender.OnClientItemSelected = "ace_itemSelected"
    '                                row.Cells(l).Controls.Add(txtbox)
    '                                'pnlFields.Controls.Add(txtbox)

    '                                Dim hdnfld As New HiddenField
    '                                hdnfld.ID = "HDN" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
    '                                row.Cells(l).Controls.Add(hdnfld)
    '                                'pnlFields.Controls.Add(img)
    '                                'pnlFields.Controls.Add(prgBar)
    '                                row.Cells(l).Controls.Add(autofilExtender)
    '                                'pnlFields.Controls.Add(autofilExtender)

    '                            ElseIf ftype1.ToUpper() = "FORMULA FIELD" Then
    '                                Dim txtBox As New TextBox
    '                                txtBox.ID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
    '                                txtBox.Width = controlWdth - 10
    '                                txtBox.CssClass = "txtBox"
    '                                If dtfld1.Rows(l).Item("isEditable").ToString() = "1" Then
    '                                    txtBox.Enabled = True
    '                                Else
    '                                    txtBox.Enabled = False
    '                                End If

    '                                If ViewState("chkadd") = 1 Then
    '                                    l = l + 1
    '                                End If
    '                                If Not row.Cells(l).Text = "" And Not row.Cells(l).Text = "&nbsp;" Then
    '                                    txtBox.Text = row.Cells(l).Text
    '                                Else
    '                                    txtBox.Text = "0"
    '                                End If

    '                                row.Cells(l).Controls.Add(txtBox)

    '                            ElseIf ftype1.ToUpper() = "TEXT AREA" Then
    '                                Dim txtBox As New TextBox
    '                                txtBox.ID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
    '                                txtBox.Width = controlWdth + 50
    '                                txtBox.Height = 50
    '                                txtBox.TextMode = TextBoxMode.MultiLine
    '                                txtBox.Columns = 4
    '                                txtBox.Rows = 10
    '                                txtBox.CssClass = "txtBox"
    '                                If dtfld1.Rows(l).Item("isEditable").ToString() = "1" Then
    '                                    txtBox.Enabled = True
    '                                Else
    '                                    txtBox.Enabled = False
    '                                End If

    '                                If ViewState("chkadd") = 1 Then
    '                                    l = l + 1
    '                                End If
    '                                If Not row.Cells(l).Text = "" And Not row.Cells(l).Text = "&nbsp;" Then
    '                                    txtBox.Text = row.Cells(l).Text
    '                                End If

    '                                row.Cells(l).Controls.Add(txtBox)

    '                            ElseIf ftype1.ToUpper() = "MULTI LOOKUP" Then
    '                                Dim txtBox As New TextBox
    '                                txtBox.ID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & row.RowIndex
    '                                txtBox.Width = controlWdth - 10
    '                                txtBox.CssClass = "txtBox"
    '                                If dtfld1.Rows(l).Item("isEditable").ToString() = "1" Then
    '                                    txtBox.Enabled = True
    '                                Else
    '                                    txtBox.Enabled = False
    '                                End If

    '                                If ViewState("chkadd") = 1 Then
    '                                    l = l + 1
    '                                End If
    '                                If Not row.Cells(l).Text = "" And Not row.Cells(l).Text = "&nbsp;" Then
    '                                    txtBox.Text = row.Cells(l).Text
    '                                End If

    '                                row.Cells(l).Controls.Add(txtBox)

    '                            ElseIf ftype1.ToUpper() = "MULTI LOOKUPDDL" Then

    '                                Dim ddl As New DropDownList
    '                                ddl.ID = "fld" & FldID1 & "_" & row.RowIndex
    '                                ddl.CssClass = "txtBox"
    '                                ddl.Width = 150

    '                                Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                Dim con As SqlConnection = New SqlConnection(conStr)
    '                                Dim ddlText As String = dtfld1.Rows(l).Item("dropdown").ToString()
    '                                Dim od As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                Dim dt As New DataTable
    '                                Dim dtval As New DataTable
    '                                Dim fieldid As String()
    '                                Dim ddlval As String()
    '                                If (ddlText.ToString() <> String.Empty) Then
    '                                    fieldid = ddlText.ToString().Split(",")
    '                                    'With(nolock) added by Himank on 29th sep 2015
    '                                    od.SelectCommand.CommandText = "select ddlMultilookupval from mmm_mst_fields  WITH(NOLOCK)  where fieldid = " & fieldid(0).ToString() & ""
    '                                    od.Fill(dtval)
    '                                    If (dtval.Rows.Count > 0) Then
    '                                        ddlval = dtval.Rows(0)("ddlMultilookupval").ToString().Split(",")
    '                                        For q As Integer = 0 To ddlval.Length - 1
    '                                            If (ddlval(q).ToString().Contains("-" & dtfld1.Rows(l).Item("FieldID").ToString())) Then
    '                                                Dim temp() As String = ddlval(q).ToString().Split("-")
    '                                                'With(nolock) added by Himank on 29th sep 2015
    '                                                od.SelectCommand.CommandText = "select * from MMM_MST_FIELDS  WITH(NOLOCK)  where DOCUMENTTYPE='" & temp(0).ToString() & "' and eid=" & HttpContext.Current.Session("EID") & " and fieldmapping in('" & temp(1).ToString() & "')"
    '                                                Dim checkval As New DataTable
    '                                                od.Fill(checkval)
    '                                                Dim ddlText1 As String = checkval.Rows(0).Item("dropdown").ToString()
    '                                                Dim dropdowntype As String = checkval.Rows(0).Item("dropdowntype").ToString()
    '                                                Dim arr() As String
    '                                                If UCase(dropdowntype) = "MASTER VALUED" Then
    '                                                    Dim ob As New DynamicForm
    '                                                    arr = ddlText1.Split("-")
    '                                                    Dim TID As String = "TID"
    '                                                    Dim TABLENAME As String = ""
    '                                                    If UCase(arr(0).ToString()) = "MASTER" Then
    '                                                        TABLENAME = "MMM_MST_MASTER"
    '                                                    ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                                        TABLENAME = "MMM_MST_DOC"
    '                                                    ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                                        TABLENAME = "MMM_MST_DOC_ITEM"
    '                                                    ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                                        If arr(1).ToString.ToUpper = "USER" Then
    '                                                            TABLENAME = "MMM_MST_USER"
    '                                                            TID = "UID"
    '                                                        ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                            TABLENAME = "MMM_MST_LOCATION"
    '                                                            TID = "LOCID"
    '                                                        End If
    '                                                    End If
    '                                                    Dim lookUpqry As String = ""
    '                                                    Dim str As String = ""
    '                                                    'With(nolock) added by Himank on 29th sep 2015
    '                                                    If arr(0).ToUpper() = "CHILD" Then
    '                                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                    ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                    Else
    '                                                        If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                                            str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
    '                                                        Else
    '                                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                                        End If
    '                                                    End If

    '                                                    Dim xwhr As String = ""
    '                                                    Dim tids As String = ""
    '                                                    'Dim tidarr() As String

    '                                                    ''FILTER THE DATA ACCORDING TO USER 
    '                                                    tids = ob.UserDataFilter(dtfld1.Rows(l).Item("documenttype").ToString(), arr(1).ToString())

    '                                                    If tids.Length >= 2 Then
    '                                                        'tidarr = tids.Split("-")
    '                                                        xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                                    ElseIf tids = "0" Then
    '                                                        pnlFields.Visible = False
    '                                                        btnActEdit.Visible = False
    '                                                        UpdatePanel1.Update()
    '                                                        xwhr = ""
    '                                                    End If
    '                                                    str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                    Dim AutoFilter As String = dtfld1.Rows(l).Item("AutoFilter").ToString()
    '                                                    If AutoFilter.Length > 0 Then
    '                                                        If arr(0).ToUpper() = "CHILD" Then
    '                                                            If AutoFilter.ToUpper = "DOCID" Then
    '                                                                str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
    '                                                            Else
    '                                                                str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
    '                                                            End If
    '                                                            'With(nolock) added by Himank on 29th sep 2015
    '                                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                                            str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                        Else
    '                                                            str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " "
    '                                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                        End If
    '                                                    End If


    '                                                    Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                                    Dim dss As New DataSet
    '                                                    If str.Length > 0 Then
    '                                                        oda.SelectCommand.CommandText = str
    '                                                        oda.Fill(dss, "FV")
    '                                                        Dim isAddJquery As Integer = 0
    '                                                        ddl.Items.Add("Select")
    '                                                        ddl.Items(0).Value = "0"
    '                                                        For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                                            ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
    '                                                            Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
    '                                                            ddl.Items(J1 + 1).Value = lookddlVal
    '                                                        Next
    '                                                        oda.Dispose()
    '                                                        dss.Dispose()
    '                                                        'prashant_2_7

    '                                                        Dim lookupvalue As String = dtfld1.Rows(l).Item("lookupvalue").ToString()
    '                                                        Dim multilookup As String = dtfld1.Rows(l).Item("multilookUpVal").ToString()

    '                                                        If lookupvalue.Length > 0 Or multilookup.Length > 0 Then
    '                                                            ddl.AutoPostBack = True
    '                                                            AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged
    '                                                        End If

    '                                                        If ddl.Items.FindByText(row.Cells(l).Text) IsNot Nothing Then
    '                                                            ddl.Items.FindByText(row.Cells(l).Text).Selected = True
    '                                                        End If
    '                                                        If ViewState("chkadd") = 1 Then
    '                                                            l = l + 1
    '                                                        End If

    '                                                        If ddl.Items.FindByText(row.Cells(l).Text) IsNot Nothing Then
    '                                                            'ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                                            ddl.SelectedValue = ddl.Items.FindByText(row.Cells(l).Text).Value
    '                                                        End If
    '                                                        row.Cells(l).Controls.Add(ddl)
    '                                                        If isAddJquery = 1 Then
    '                                                            Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
    '                                                        End If
    '                                                    End If
    '                                                    con.Dispose()
    '                                                    oda.Dispose()
    '                                                    dss.Dispose()
    '                                                ElseIf UCase(dropdowntype) = "SESSION VALUED" Then

    '                                                End If
    '                                            End If
    '                                        Next
    '                                    End If
    '                                End If

    '                            ElseIf ftype1.ToUpper() = "DROP DOWN" Then
    '                                Dim ddl As New DropDownList

    '                                ddl.ID = "fld" & FldID1 & "_" & row.RowIndex
    '                                ddl.CssClass = "txtBox"
    '                                ddl.Width = 150
    '                                Dim ddlText As String = dtfld1.Rows(l).Item("dropdown").ToString()
    '                                Dim dropdowntype As String = dtfld1.Rows(l).Item("dropdowntype").ToString()
    '                                Dim arr() As String
    '                                If dtfld1.Rows(l).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                    'Dim cb As New DropDownList
    '                                    ' cb.ID = "fld" & FldID & row.RowIndex
    '                                    ddl.Items.Add("Select")
    '                                    ddl.Items(0).Value = "0"

    '                                    Dim ARR1() As String = dtfld1.Rows(l).Item("dropdown").ToString().Split(",")
    '                                    For K As Integer = 0 To ARR1.Length - 1
    '                                        ddl.Items.Add(ARR1(K).ToString)
    '                                    Next

    '                                    If ViewState("chkadd") = 1 Then
    '                                        l = l + 1
    '                                    End If

    '                                    '' for default value selection
    '                                    'If dtfld1.Rows(l).Item("ddlval").ToString().Length > 1 Then
    '                                    '    Dim dropdowntypeFill As String = ds.Rows(l).Item("ddlval").ToString().ToUpper()
    '                                    '    ddl.SelectedIndex = ddl.Items.IndexOf(ddl.Items.FindByText(dropdowntypeFill))
    '                                    'End If

    '                                    If ddl.Items.FindByText(row.Cells(l).Text) IsNot Nothing Then
    '                                        ddl.Items.FindByText(row.Cells(l).Text).Selected = True
    '                                    End If

    '                                    row.Cells(l).Controls.Add(ddl)
    '                                    'Prashant_10_7
    '                                    If dtfld1.Rows(l).Item("iseditable") = 1 Then
    '                                        ddl.Enabled = True
    '                                    Else
    '                                        ddl.Enabled = False
    '                                    End If


    '                                ElseIf dtfld1.Rows(l).Item("dropdowntype").ToString() = "MASTER VALUED" Then
    '                                    '' code for getting master valued 
    '                                    Dim ob As New DynamicForm
    '                                    arr = ddlText.Split("-")
    '                                    Dim TID As String = "TID"
    '                                    Dim TABLENAME As String = ""
    '                                    If UCase(arr(0).ToString()) = "MASTER" Then
    '                                        TABLENAME = "MMM_MST_MASTER"
    '                                    ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                        TABLENAME = "MMM_MST_DOC"
    '                                    ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                        TABLENAME = "MMM_MST_DOC_ITEM"
    '                                    ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                        If arr(1).ToString.ToUpper = "USER" Then
    '                                            TABLENAME = "MMM_MST_USER"
    '                                            TID = "UID"
    '                                        ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                            TABLENAME = "MMM_MST_LOCATION"
    '                                            TID = "LOCID"
    '                                        End If
    '                                    End If


    '                                    Dim lookUpqry As String = ""
    '                                    Dim str As String = ""
    '                                    'With(nolock) added by Himank on 29th sep 2015
    '                                    If arr(0).ToUpper() = "CHILD" Then
    '                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M   WITH(NOLOCK) WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                    ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                    Else
    '                                        If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                            str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
    '                                        Else
    '                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                        End If
    '                                    End If

    '                                    Dim xwhr As String = ""
    '                                    Dim tids As String = ""
    '                                    'Dim tidarr() As String

    '                                    ''FILTER THE DATA ACCORDING TO USER 
    '                                    tids = ob.UserDataFilter(dtfld1.Rows(l).Item("documenttype").ToString(), arr(1).ToString())

    '                                    If tids.Length >= 2 Then
    '                                        'tidarr = tids.Split("-")
    '                                        xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                    ElseIf tids = "0" Then
    '                                        pnlFields.Visible = False
    '                                        btnActEdit.Visible = False
    '                                        UpdatePanel1.Update()
    '                                        xwhr = ""
    '                                    End If
    '                                    str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                    Dim AutoFilter As String = dtfld1.Rows(l).Item("AutoFilter").ToString()
    '                                    If AutoFilter.Length > 0 Then
    '                                        If arr(0).ToUpper() = "CHILD" Then
    '                                            If AutoFilter.ToUpper = "DOCID" Then
    '                                                str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
    '                                            Else
    '                                                str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
    '                                            End If
    '                                            'With(nolock) added by Himank on 29th sep 2015
    '                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                            str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                        Else
    '                                            str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) WHERE EID=" & Session("EID") & " "
    '                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                        End If
    '                                    End If

    '                                    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                    Dim con As SqlConnection = New SqlConnection(conStr)
    '                                    Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                    Dim dss As New DataSet

    '                                    If str.Length > 0 Then
    '                                        oda.SelectCommand.CommandText = str
    '                                        oda.Fill(dss, "FV")
    '                                        Dim isAddJquery As Integer = 0
    '                                        ddl.Items.Add("Select")
    '                                        ddl.Items(0).Value = "0"
    '                                        For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                            ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
    '                                            Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
    '                                            ddl.Items(J1 + 1).Value = lookddlVal
    '                                        Next
    '                                        oda.Dispose()
    '                                        dss.Dispose()
    '                                        'prashant_2_7

    '                                        Dim lookupvalue As String = dtfld1.Rows(l).Item("lookupvalue").ToString()
    '                                        Dim multilookup As String = dtfld1.Rows(l).Item("multilookUpVal").ToString()
    '                                        Dim ddlmultilookup As String = dtfld1.Rows(l).Item("ddlmultilookUpVal").ToString()
    '                                        'LT Lookupval changes
    '                                        Dim LTLookupval As String = Convert.ToString(dtfld1.Rows(l).Item("LTlookupval"))
    '                                        If lookupvalue.Length > 0 Or multilookup.Length > 0 Or ddlmultilookup.Length > 0 Or LTLookupval.Length > 0 Then
    '                                            ddl.AutoPostBack = True
    '                                            AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged

    '                                        End If

    '                                        ' '' new by sp on 18-nov-15 for Burgerking ticket
    '                                        'If Len(Convert.ToString(dtfld1.Rows(l).Item("ddlval"))) > 1 Then
    '                                        '    Dim DDldefaultVal As String = Convert.ToString(dtfld1.Rows(l).Item("ddlval"))
    '                                        '    ddl.SelectedIndex = ddl.Items.IndexOf(ddl.Items.FindByValue(DDldefaultVal))
    '                                        '    Dim id As String = Right(ddl.ID, ddl.ID.Length - 3)
    '                                        '    Dim ar() As String = id.Split("_")
    '                                        '    Dim id1 As Integer = CInt(ar(0))
    '                                        '    BindGRidLookup(ar(1), id1, ddl)
    '                                        '    Dim ob1 As New DynamicForm()
    '                                        '    ob1.GridMultiLookup(ar(1), id1, ddl, lblTab, pnlFields)
    '                                        '    ob1.GridLTLookup(ar(1), id1, ddl, lblTab, pnlFields)
    '                                        '    BindGRidLookupDDL(ar(1), id1, ddl)
    '                                        'End If
    '                                        ' '' new by sp on 18-nov-15 for Burgerking ticket - ends 
    '                                        ' '' below in for popups from dyn. form
    '                                        ''If ds.Rows(i).Item("ddlval").ToString().Length > 1 Then
    '                                        ''    Dim ddl As New DropDownList
    '                                        ''    ddl = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), DropDownList)
    '                                        ''    Dim dropdowntypeFill As String = ds.Rows(i).Item("ddlval").ToString().ToUpper().Trim()
    '                                        ''    ddl.SelectedIndex = ddl.Items.IndexOf(ddl.Items.FindByValue(dropdowntypeFill))
    '                                        ''    '''''For filling lookup and lookupddl according drop down'''''''
    '                                        ''    Dim id As String = Right(ddl.ID, ddl.ID.Length - 3)
    '                                        ''    Dim id1 As Integer = CInt(id)
    '                                        ''    bind(id, pnlFields, ddl)
    '                                        ''    bindlookupddl(id, pnlFields, ddl)
    '                                        ''End If


    '                                        If ddl.Items.FindByText(row.Cells(l).Text) IsNot Nothing Then
    '                                            ddl.Items.FindByText(row.Cells(l).Text).Selected = True
    '                                        End If
    '                                        If ViewState("chkadd") = 1 Then
    '                                            l = l + 1
    '                                        End If

    '                                        If ddl.Items.FindByText(row.Cells(l).Text) IsNot Nothing Then
    '                                            ddl.Items.FindByText(row.Cells(l).Text).Selected = True
    '                                        End If

    '                                        row.Cells(l).Controls.Add(ddl)

    '                                        If isAddJquery = 1 Then
    '                                            Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
    '                                        End If
    '                                    End If
    '                                    con.Dispose()
    '                                    oda.Dispose()
    '                                    dss.Dispose()
    '                                    '' ends here for getting master valued 
    '                                End If

    '                            ElseIf ftype1.ToUpper() = "CHECKBOX LIST" Then
    '                                Dim CHKlIST As New CheckBoxList()
    '                                Dim dynmdiv As System.Web.UI.HtmlControls.HtmlGenericControl = New System.Web.UI.HtmlControls.HtmlGenericControl("DIV")
    '                                dynmdiv.ID = "div_" & FldID1
    '                                Dim ddlText As String = dtfld1.Rows(l).Item("dropdown").ToString()
    '                                CHKlIST.ID = "fld" & FldID1 & "_" & row.RowIndex
    '                                If dtfld1.Rows(l).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                    Dim arr = ddlText.Split(",")
    '                                    For ii As Integer = 0 To arr.Count - 1
    '                                        CHKlIST.Items.Add(arr(ii).ToUpper())
    '                                    Next

    '                                ElseIf dtfld1.Rows(l).Item("dropdowntype").ToString() = "MASTER VALUED" Then
    '                                    Dim arr = ddlText.Split("-")
    '                                    Dim TID As String = "TID"
    '                                    Dim TABLENAME As String = ""
    '                                    If UCase(arr(0).ToString()) = "MASTER" Then
    '                                        TABLENAME = "MMM_MST_MASTER"
    '                                    ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                        TABLENAME = "MMM_MST_DOC"
    '                                    ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                        TABLENAME = "MMM_MST_DOC_ITEM"
    '                                    ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                        If arr(1).ToString.ToUpper = "USER" Then
    '                                            TABLENAME = "MMM_MST_USER"
    '                                            TID = "UID"
    '                                        ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                            TABLENAME = "MMM_MST_LOCATION"
    '                                            TID = "LOCID"
    '                                        End If
    '                                    End If
    '                                    Dim lookUpqry As String = ""
    '                                    Dim str As String = ""
    '                                    'With(nolock) added by Himank on 29th sep 2015
    '                                    If arr(0).ToUpper() = "CHILD" Then
    '                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                    ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                    Else
    '                                        If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                            str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
    '                                        Else
    '                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                        End If
    '                                    End If
    '                                    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                    Dim con As SqlConnection = New SqlConnection(conStr)
    '                                    Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                    oda = New SqlDataAdapter("", con)
    '                                    Dim dss As New DataSet
    '                                    oda.SelectCommand.CommandText = str
    '                                    oda.Fill(dss, "FV")
    '                                    For JJ As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                        CHKlIST.Items.Add(dss.Tables("FV").Rows(JJ).Item(0))
    '                                        CHKlIST.Items(JJ).Value = dss.Tables("FV").Rows(JJ).Item(1)
    '                                    Next
    '                                    oda.Dispose()
    '                                    dss.Dispose()
    '                                End If

    '                                dynmdiv.Style.Add(HtmlTextWriterStyle.Width, "200px")
    '                                dynmdiv.Style.Add(HtmlTextWriterStyle.Height, "100px")
    '                                dynmdiv.Style.Add(HtmlTextWriterStyle.Overflow, "Scroll")
    '                                dynmdiv.Controls.Add(CHKlIST)
    '                                row.Cells(l).Controls.Add(dynmdiv)



    '                            ElseIf ftype1.ToUpper = "LOOKUPDDL" Then

    '                                ' DataType = dtfld1.Rows(j).Item("datatype").ToString().ToUpper()
    '                                Dim fieldtypee As String = dtfld1.Rows(l).Item("FieldType").ToString().ToUpper()
    '                                Dim ddl As New DropDownList
    '                                ddl.ID = "fld" & dtfld1.Rows(l).Item("FieldID").ToString() & "_" & row.RowIndex
    '                                ddl.Width = controlWdth - 10
    '                                ddl.CssClass = "txtBox"
    '                                Dim ddlText As String = dtfld1.Rows(l).Item("dropdown").ToString()
    '                                Dim dropdowntype As String = dtfld1.Rows(l).Item("dropdowntype").ToString()
    '                                Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                Dim con As SqlConnection = New SqlConnection(conStr)
    '                                'With(nolock) added by Himank on 29th sep 2015
    '                                Dim od As SqlDataAdapter = New SqlDataAdapter("select dropdown,DDllookupvalue from MMM_MST_FIELDS  WITH(NOLOCK)  where FieldID='" & ddlText & "'", con)
    '                                ' Dim dsMonth As New DataSet
    '                                Dim dt As New DataTable
    '                                od.Fill(dt)
    '                                Dim arr() As String
    '                                Dim darr() As String
    '                                Dim type As String = dt.Rows(0).Item("dropdown").ToString()
    '                                arr = type.Split("-")
    '                                Dim documenttype As String = arr(1).ToString()
    '                                Dim field As String = dt.Rows(0).Item("DDllookupvalue").ToString()
    '                                field = field.Substring(0, field.Length - 1)
    '                                darr = field.Split(",")
    '                                For k As Integer = 0 To darr.Count - 1
    '                                    Dim fieldmping As String
    '                                    Dim str As String = ""
    '                                    Dim feild As String
    '                                    Dim s = darr(k).Split("-")
    '                                    feild = s(0).ToString()
    '                                    fieldmping = s(1).ToString()

    '                                    Dim TID As String = "TID"
    '                                    Dim TABLENAME As String = ""
    '                                    Dim str1 As String = ""
    '                                    Dim lookUpqry As String = ""

    '                                    Dim xwhr As String = ""
    '                                    Dim tids As String = ""
    '                                    Dim Rtids As String = ""   ' for prerole data filter

    '                                    If feild = dtfld1.Rows(l).Item("FieldID").ToString() Then
    '                                        'If arr(0) = "SESSION" And Not (fieldmping.Contains("fld")) Then
    '                                        '    If arr(1).ToString.ToUpper = "USER" Then
    '                                        '        TABLENAME = "MMM_MST_USER"
    '                                        '        TID = "UID"
    '                                        '    End If
    '                                        '    ' str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                        '    str1 = "select " & fieldmping.ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                        'Else

    '                                        'With(nolock) added by Himank on 29th sep 2015
    '                                        od.SelectCommand.CommandText = "select dropdown from MMM_MST_FIELDS  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("EID") & " and documenttype='" & documenttype & "' and FieldMapping in('" & fieldmping & "')"
    '                                        Dim dt1 As New DataTable
    '                                        od.Fill(dt1)
    '                                        Dim dropdown As String = dt1.Rows(0).Item("dropdown").ToString()
    '                                        arr = dropdown.Split("-")

    '                                        If UCase(arr(0).ToString()) = "MASTER" Then
    '                                            TABLENAME = "MMM_MST_MASTER"
    '                                        ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                            TABLENAME = "MMM_MST_DOC"
    '                                        ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                            TABLENAME = "MMM_MST_DOC_ITEM"
    '                                        ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                            If arr(1).ToString.ToUpper = "USER" Then
    '                                                TABLENAME = "MMM_MST_USER"
    '                                                TID = "UID"
    '                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                TABLENAME = "MMM_MST_LOCATION"
    '                                                TID = "LOCID"
    '                                            End If
    '                                        ElseIf UCase(arr(0).ToString) = "SESSION" Then
    '                                            If arr(1).ToString.ToUpper = "USER" Then
    '                                                TABLENAME = "MMM_MST_USER"
    '                                                TID = "UID"
    '                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                TABLENAME = "MMM_MST_LOCATION"
    '                                                TID = "LOCID"
    '                                            End If
    '                                        End If
    '                                        'With(nolock) added by Himank on 29th sep 2015
    '                                        If arr(0).ToUpper() = "CHILD" Then
    '                                            str1 = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                        ElseIf arr(0).ToUpper() = "SESSION" Then
    '                                            str1 = "Select " & IIf(arr(1).ToString.ToUpper = "USER", "UserName, ", "LocationName, ") & TID & " from " & TABLENAME & " M  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("EID") & " AND " & arr(2) & "='" & HttpContext.Current.Session(arr(2)) & "'"
    '                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                            str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                        Else
    '                                            If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                                str1 = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
    '                                            Else
    '                                                str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                            End If
    '                                        End If
    '                                        '  End If

    '                                        'Dim tidarr() As String

    '                                        ''FILTER THE DATA ACCORDING TO USER 
    '                                        Dim ob = New DynamicForm()
    '                                        tids = ob.UserDataFilter(dtfld1.Rows(l).Item("documenttype").ToString(), arr(1).ToString())
    '                                        Rtids = ob.UserDataFilter_PreRole(arr(1).ToString(), TABLENAME)  '' new by sunil for pre role data filter 22-feb

    '                                        '' for multiuse of document by sp on 08_apr_15
    '                                        Dim Sdtype As String = arr(1).ToString
    '                                        Dim da As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                        da.SelectCommand.CommandType = CommandType.Text
    '                                        'With(nolock) added by Himank on 29th sep 2015
    '                                        da.SelectCommand.CommandText = "select isnull(Allowmultiuse,0) from mmm_mst_forms   WITH(NOLOCK) where eid='" & HttpContext.Current.Session("EID").ToString & "' AND FORMNAME='" & Sdtype & "'"
    '                                        If con.State <> ConnectionState.Open Then
    '                                            con.Open()
    '                                        End If
    '                                        Dim isMultiUse As Integer = Convert.ToInt32(da.SelectCommand.ExecuteScalar())

    '                                        Dim CurrDoctype As String = dtfld1.Rows(l).Item("documenttype").ToString()
    '                                        Dim CurrFieldMapping As String = dtfld1.Rows(l).Item("fieldmapping").ToString()

    '                                        Dim qry As String = ""
    '                                        Dim MTids As String = ""
    '                                        If UCase(arr(0).ToString()) <> "CHILD" And UCase(arr(0).ToString) <> "STATIC" And UCase(arr(0).ToString) <> "SESSION" Then
    '                                            da.SelectCommand.CommandType = CommandType.Text
    '                                            da.SelectCommand.CommandText = "SELECT SUBSTRING((SELECT ',' + CONVERT(NVARCHAR," & CurrFieldMapping & ")  FROM " & TABLENAME & " where EID=" & HttpContext.Current.Session("eid") & " and documenttype='" & CurrDoctype & "'" & " FOR XML PATH('')),2,1000) AS CSV"
    '                                            MTids = Convert.ToString(da.SelectCommand.ExecuteScalar())
    '                                        End If
    '                                        ''ends  for multiuse of document by sp on 08_apr_15


    '                                        If tids.Length >= 2 Then
    '                                            xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                        ElseIf tids = "0" Then
    '                                            pnlFields.Visible = False
    '                                            btnActEdit.Visible = False
    '                                            UpdatePanel1.Update()
    '                                            xwhr = ""
    '                                        End If
    '                                        '' new by sunil for pre role data filter 22-feb
    '                                        If Rtids <> "" Then
    '                                            If xwhr.ToString = "" Then
    '                                                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & Rtids & ")"
    '                                            Else
    '                                                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & "," & Rtids & ")"
    '                                            End If
    '                                        End If

    '                                        '' new by sunil for multiuse of docs
    '                                        If MTids.Length > 2 And isMultiUse = 1 Then
    '                                            If Right(MTids, 1) = "," Then
    '                                                MTids = Left(MTids, Len(MTids) - 1)
    '                                            End If
    '                                            xwhr = xwhr & " AND CONVERT(NVARCHAR(10),TID) not IN (" & MTids & ") "
    '                                        End If
    '                                        '' new by sunil for multiuse of docs

    '                                        str1 = str1 & "  AND M.isauth>0 " & xwhr & " order by " & arr(2).ToString()
    '                                        'Dim documenttype2 As String = arr1(1).ToString()
    '                                        'Dim fieldmping2 As String = arr1(2).ToString()
    '                                        'pnlFields.Controls.Add(ddl)
    '                                        Dim dt2 As New DataTable
    '                                        'oda.SelectCommand.CommandText = "select " & fieldmping2 & " from " & TABLENAME & " where EID=" & HttpContext.Current.Session("EID") & " and documenttype = '" & documenttype2 & "'"

    '                                        If str1.Length > 0 Then
    '                                            pnlFields.Controls.Add(ddl)
    '                                            od.SelectCommand.CommandText = str1
    '                                            od.Fill(dt2)
    '                                            Dim isAddJquery As Integer = 0
    '                                            ddl.Items.Add("Select")
    '                                            ddl.Items(0).Value = "0"
    '                                            For JK As Integer = 0 To dt2.Rows.Count - 1
    '                                                ddl.Items.Add(dt2.Rows(JK).Item(0).ToString())
    '                                                Dim lookddlVal As String = dt2.Rows(JK).Item(1).ToString()
    '                                                ddl.Items(JK + 1).Value = lookddlVal
    '                                            Next
    '                                            dt2.Dispose()
    '                                        End If
    '                                        If dtfld1.Rows(l).Item("isEditable").ToString() = "1" Then
    '                                            ddl.Enabled = True
    '                                        Else
    '                                            ddl.Enabled = False
    '                                        End If
    '                                    End If
    '                                Next

    '                                row.Cells(l).Controls.Add(ddl)

    '                            ElseIf ftype1.ToUpper() = "FILE UPLOADER" Then
    '                                Dim txtBox As New FileUpload

    '                                'Prashant 30-6-2014
    '                                Dim txtBox1 As New HiddenField

    '                                Dim lbl1 As New Label
    '                                lbl1.ID = "lblf_" & FldID1
    '                                lbl1.Text = ""
    '                                lbl1.ClientIDMode = ClientIDMode.Static

    '                                txtBox1.ID = "hdn_" & FldID1
    '                                txtBox1.Value = ""
    '                                txtBox1.ClientIDMode = ClientIDMode.Static
    '                                If Not Request.QueryString("TID") Is Nothing Then
    '                                    txtBox.Attributes.Add("onchange", "UtilJs.UploadFile1(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
    '                                Else
    '                                    txtBox.Attributes.Add("onchange", "UtilJs.UploadFile(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
    '                                End If

    '                                txtBox.ID = "fld_" & FldID1 & "_" & row.RowIndex  ' added  id  with _ by balli
    '                                txtBox.CssClass = "txtBox"

    '                                txtBox.Width = 180


    '                                Dim hdnflag As New HiddenField
    '                                If Not Request.QueryString("TID") Is Nothing Then
    '                                    hdnflag.ID = "hdnf_" & FldID1
    '                                    hdnflag.Value = "0"
    '                                    Dim str As String = row.Cells(l).Text

    '                                    str = After(str, "/")

    '                                    txtBox1.Value = str 'row.Cells(j).Text
    '                                    lbl1.Text = str ' row.Cells(j).Text
    '                                    row.Cells(l).Text = str
    '                                End If
    '                                If ViewState("chkadd") = 1 Then
    '                                    l = l + 1
    '                                End If
    '                                row.Cells(l).Controls.Add(txtBox)
    '                                'Prashant 30-6-2014
    '                                row.Cells(l).Controls.Add(txtBox1)
    '                                row.Cells(l).Controls.Add(lbl1)
    '                                row.Cells(l).Controls.Add(hdnflag)

    '                                Dim pstback As New PostBackTrigger
    '                                pstback.ControlID = btnActEdit.ID
    '                                UpdatePanel1.Triggers.Add(pstback)

    '                            End If
    '                            If ViewState("chkadd") = 1 Then
    '                                l = l - 1    ' added for incremental 
    '                            End If
    '                        Next
    '                    Else

    '                        Dim filterRows() As DataRow
    '                        filterRows = dtfld1.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''", "InLineEditing,DisplayOrder")
    '                        dtfld1 = filterRows.CopyToDataTable()

    '                        Dim filterRows1() As DataRow
    '                        Dim filterRows2() As DataRow
    '                        filterRows1 = dtfld1.Select("inlinemapping is not null and inlinemapping <>''", "DisplayOrder")
    '                        filterRows2 = dtfld1.Select("InLineEditing=1 and inlinemapping is null", "DisplayOrder")
    '                        If filterRows1.Length > 0 Then
    '                            dtfld1 = filterRows1.CopyToDataTable()
    '                            dtfld1.Merge(filterRows2.CopyToDataTable())
    '                        Else
    '                            dtfld1 = filterRows2.CopyToDataTable()
    '                        End If

    '                        For j As Integer = 0 To filterRows.Count - 1

    '                            Dim ftype As String = dtfld1.Rows(j).Item("fieldtype").ToString()

    '                            Dim datatype As String = dtfld1(j).Item("datatype").ToString() 'Prashant_10_7

    '                            Dim colValue As String = row.DataItem(j).ToString()
    '                            Dim ilEdit As Integer = dtfld1.Rows(j).Item("inlineEditing").ToString()
    '                            Dim FldID As String = dtfld1.Rows(j).Item("fieldid").ToString()
    '                            Dim Formula = Convert.ToString(dtfld1.Rows(j).Item("cal_text"))
    '                            Dim DisplayName = Convert.ToString(dtfld1.Rows(j).Item("DisplayName"))
    '                            If ilEdit = 1 Then
    '                                If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Or ftype.ToUpper() = "PARENT VALUE" Then
    '                                    Dim cb As New TextBox
    '                                    'cb.ID = "fld" & j.ToString() & "_" & row.RowIndex
    '                                    cb.Width = 55
    '                                    cb.ID = "fld" & FldID & row.RowIndex

    '                                    'Prashant_10_7
    '                                    If dtfld1.Rows(j).Item("defaultfieldval").ToString().Length > 0 Then
    '                                        cb.Text = dtfld1.Rows(j).Item("defaultfieldval").ToString()
    '                                    Else
    '                                        If datatype.ToUpper() = "NUMERIC" Then
    '                                            cb.Text = "0"
    '                                        End If
    '                                    End If
    '                                    If Val(dtfld1.Rows(j).Item("isDescription").ToString()) = 1 Then
    '                                        cb.ToolTip = dtfld1.Rows(j).Item("Description").ToString()
    '                                    End If
    '                                    If dtfld1.Rows(j).Item("iseditable") = 0 Then
    '                                        cb.Attributes.Add("READONLY", "READONLY")
    '                                        cb.Attributes.Add("COLOR", "GRAY")
    '                                    End If
    '                                    If ftype.ToUpper() = "CALCULATIVE FIELD" Then
    '                                        colValue = "0"
    '                                        cb.Attributes.Add("READONLY", "READONLY")
    '                                        cb.Attributes.Add("COLOR", "GRAY")
    '                                    End If
    '                                    If ViewState("chkadd") = 1 Then
    '                                        j = j + 1
    '                                    End If
    '                                    colValue = row.DataItem(j).ToString()
    '                                    If ftype.ToUpper() = "LOOKUP" Then
    '                                        If datatype.ToUpper() = "NUMERIC" Then
    '                                            colValue = "0"
    '                                        End If
    '                                    Else
    '                                        If Val(colValue) = 0 Then
    '                                            If ftype.ToUpper() = "TEXT BOX" And datatype.ToUpper() = "NUMERIC" Then
    '                                                colValue = "0"
    '                                            End If
    '                                        End If
    '                                    End If

    '                                    If Not row.Cells(j).Text.Trim = "&nbsp;" And Not row.Cells(j).Text.Trim = "" Then
    '                                        colValue = row.Cells(j).Text.Trim
    '                                    End If

    '                                    cb.Text = colValue
    '                                    cb.Width = controlWdth
    '                                    row.Cells(j).Controls.Add(cb)

    '                                    If datatype.ToUpper.Trim = "DATETIME" Then
    '                                        Dim CLNDR As New AjaxControlToolkit.CalendarExtender
    '                                        CLNDR.Controls.Clear()
    '                                        CLNDR.ID = "CLNDR" & dtfld1.Rows(j).Item("FieldID").ToString()
    '                                        CLNDR.Format = "dd/MM/yy"
    '                                        CLNDR.TargetControlID = cb.ID
    '                                        cb.Enabled = True
    '                                        If Request.QueryString("TID") Is Nothing Then
    '                                            cb.Text = String.Format("{0:dd/MM/yy}", Date.Now())
    '                                        End If
    '                                        row.Cells(j).Controls.Add(CLNDR) '
    '                                    End If


    '                                    'Code For calculative field
    '                                    'Code End Here !!!!!!
    '                                    'If ftype = "Calculative Field" Then
    '                                    '    cb.Attributes.Add("READONLY", "READONLY")
    '                                    '    cb.Attributes.Add("COLOR", "GRAY")
    '                                    '    ' cb.ReadOnly = True
    '                                    'End If


    '                                    If Not Formula Is Nothing And Formula <> "" Then
    '                                        'Dim arrFor As String() = Formula.Split(",")
    '                                        Dim jScript = GenerateJQueryScript(dtfld1, GID, row.RowIndex, Formula, FldID)
    '                                        If jScript <> "" Then
    '                                            cb.Attributes.Add("onblur", jScript)
    '                                        End If
    '                                    End If
    '                                    If Val(dtfld1.Rows(j).Item("HasRule").ToString()) = 1 Then
    '                                        cb.AutoPostBack = True
    '                                        AddHandler cb.TextChanged, AddressOf grdTextBoxRule_TextChanged
    '                                    End If

    '                                ElseIf ftype.ToUpper() = "AUTOCOMPLETE" Then

    '                                    Dim txtbox As New TextBox
    '                                    txtbox.ID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
    '                                    txtbox.Width = controlWdth - 10
    '                                    txtbox.CssClass = "txtBox"
    '                                    txtbox.Attributes.Add("placeholder", "Please begin typing a " & DisplayName)
    '                                    txtbox.AutoPostBack = True
    '                                    AddHandler txtbox.TextChanged, AddressOf txtbox_TextChanged
    '                                    ' adding handler for binding lookup or other dropdown or filter

    '                                    Dim autofilExtender As New AjaxControlToolkit.AutoCompleteExtender
    '                                    autofilExtender.ID = "extenderID" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex

    '                                    autofilExtender.TargetControlID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
    '                                    autofilExtender.ServiceMethod = "GetCompletionList" ' THIS SERVICE METHOD IS WRITTEN ON DOCUMENT PAGE 
    '                                    autofilExtender.DelimiterCharacters = ""
    '                                    autofilExtender.ContextKey = dtfld1.Rows(j).Item("DROPDOWN").ToString() & "-" & dtfld1.Rows(j).Item("FieldID").ToString() & "-" & dtfld1.Rows(j).Item("DROPDOWNTYPE").ToString() & "-" & dtfld1.Rows(j).Item("AUTOFILTER").ToString() & "-" & dtfld1.Rows(j).Item("inlinefilter").ToString()
    '                                    'context key contain  : dropdown-fieldid-dropdowntype-autofilter-InitialFilter' adding the fieldid in context key because later on we need id of field in web method 
    '                                    autofilExtender.Enabled = True
    '                                    autofilExtender.CompletionSetCount = 5
    '                                    autofilExtender.OnClientShown = "onDataShown"  ' by sunil
    '                                    '   autofilExtender.CompletionListElementID = "ACsugestlist"
    '                                    autofilExtender.MinimumPrefixLength = 1  ' start searching when entered one characters
    '                                    'autofilExtender.OnClientItemSelected = "ace_itemSelected('" & ds.Rows(i).Item("FieldID").ToString() & "')"
    '                                    autofilExtender.OnClientItemSelected = "ace_itemSelected"
    '                                    row.Cells(j).Controls.Add(txtbox)
    '                                    'pnlFields.Controls.Add(txtbox)

    '                                    Dim hdnfld As New HiddenField
    '                                    hdnfld.ID = "HDN" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
    '                                    row.Cells(j).Controls.Add(hdnfld)
    '                                    'pnlFields.Controls.Add(img)
    '                                    'pnlFields.Controls.Add(prgBar)
    '                                    row.Cells(j).Controls.Add(autofilExtender)
    '                                    'pnlFields.Controls.Add(autofilExtender)

    '                                    'LT Lookupval Changes
    '                                ElseIf ftype.ToUpper() = "LT LOOKUP" Then
    '                                    Dim txtBox As New TextBox
    '                                    txtBox.ID = "fld" & FldID & row.RowIndex
    '                                    txtBox.Width = controlWdth - 10
    '                                    txtBox.CssClass = "txtBox"
    '                                    If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                        txtBox.Enabled = True
    '                                    Else
    '                                        txtBox.Enabled = False
    '                                    End If

    '                                    If ViewState("chkadd") = 1 Then
    '                                        j = j + 1
    '                                    End If
    '                                    If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
    '                                        txtBox.Text = row.Cells(j).Text
    '                                    End If

    '                                    row.Cells(j).Controls.Add(txtBox)
    '                                ElseIf ftype.ToUpper() = "FORMULA FIELD" Then
    '                                    Dim txtBox As New TextBox
    '                                    txtBox.ID = "fld" & FldID & row.RowIndex
    '                                    txtBox.Width = controlWdth - 10
    '                                    txtBox.CssClass = "txtBox"
    '                                    If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                        txtBox.Enabled = True
    '                                    Else
    '                                        txtBox.Enabled = False
    '                                    End If

    '                                    If ViewState("chkadd") = 1 Then
    '                                        j = j + 1
    '                                    End If
    '                                    If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
    '                                        txtBox.Text = row.Cells(j).Text
    '                                    Else
    '                                        txtBox.Text = "0"
    '                                    End If

    '                                    row.Cells(j).Controls.Add(txtBox)

    '                                ElseIf ftype.ToUpper() = "TEXT AREA" Then
    '                                    Dim txtBox As New TextBox
    '                                    txtBox.ID = "fld" & FldID & row.RowIndex
    '                                    txtBox.Width = controlWdth + 50
    '                                    txtBox.Height = 50
    '                                    txtBox.TextMode = TextBoxMode.MultiLine
    '                                    txtBox.Columns = 4
    '                                    txtBox.Rows = 10
    '                                    txtBox.CssClass = "txtBox"
    '                                    If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                        txtBox.Enabled = True
    '                                    Else
    '                                        txtBox.Enabled = False
    '                                    End If

    '                                    If ViewState("chkadd") = 1 Then
    '                                        j = j + 1
    '                                    End If
    '                                    If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
    '                                        txtBox.Text = row.Cells(j).Text
    '                                    End If

    '                                    row.Cells(j).Controls.Add(txtBox)


    '                                ElseIf ftype.ToUpper() = "MULTI LOOKUP" Then
    '                                    Dim txtBox As New TextBox
    '                                    txtBox.ID = "fld" & FldID & row.RowIndex
    '                                    txtBox.Width = controlWdth - 10
    '                                    txtBox.CssClass = "txtBox"
    '                                    If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                        txtBox.Enabled = True
    '                                    Else
    '                                        txtBox.Enabled = False
    '                                    End If
    '                                    If ViewState("chkadd") = 1 Then
    '                                        j = j + 1
    '                                    End If
    '                                    If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
    '                                        txtBox.Text = row.Cells(j).Text
    '                                    End If
    '                                    row.Cells(j).Controls.Add(txtBox)

    '                                ElseIf ftype.ToUpper() = "MULTI LOOKUPDDL" Then

    '                                    Dim ddl As New DropDownList
    '                                    ddl.ID = "fld" & FldID & "_" & row.RowIndex
    '                                    ddl.CssClass = "txtBox"
    '                                    ddl.Width = 150

    '                                    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                    Dim con As SqlConnection = New SqlConnection(conStr)
    '                                    Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
    '                                    Dim od As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                    Dim dt As New DataTable
    '                                    Dim dtval As New DataTable
    '                                    Dim fieldid As String()
    '                                    Dim ddlval As String()
    '                                    If (ddlText.ToString() <> String.Empty) Then
    '                                        fieldid = ddlText.ToString().Split(",")
    '                                        'With(nolock) added by Himank on 29th sep 2015
    '                                        od.SelectCommand.CommandText = "select ddlMultilookupval from mmm_mst_fields  WITH(NOLOCK)  where fieldid = " & fieldid(0).ToString() & ""
    '                                        od.Fill(dtval)
    '                                        If (dtval.Rows.Count > 0) Then
    '                                            ddlval = dtval.Rows(0)("ddlMultilookupval").ToString().Split(",")
    '                                            For q As Integer = 0 To ddlval.Length - 1
    '                                                If (ddlval(q).ToString().Contains("-" & dtfld1.Rows(j).Item("FieldID").ToString())) Then
    '                                                    Dim temp() As String = ddlval(q).ToString().Split("-")
    '                                                    'With(nolock) added by Himank on 29th sep 2015
    '                                                    od.SelectCommand.CommandText = "select * from MMM_MST_FIELDS  WITH(NOLOCK)  where DOCUMENTTYPE='" & temp(0).ToString() & "' and eid=" & HttpContext.Current.Session("EID") & " and fieldmapping in('" & temp(1).ToString() & "')"
    '                                                    Dim checkval As New DataTable
    '                                                    od.Fill(checkval)
    '                                                    Dim ddlText1 As String = checkval.Rows(0).Item("dropdown").ToString()
    '                                                    Dim dropdowntype As String = checkval.Rows(0).Item("dropdowntype").ToString()
    '                                                    Dim arr() As String
    '                                                    If UCase(dropdowntype) = "MASTER VALUED" Then
    '                                                        Dim ob As New DynamicForm
    '                                                        arr = ddlText1.Split("-")
    '                                                        Dim TID As String = "TID"
    '                                                        Dim TABLENAME As String = ""
    '                                                        If UCase(arr(0).ToString()) = "MASTER" Then
    '                                                            TABLENAME = "MMM_MST_MASTER"
    '                                                        ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                                            TABLENAME = "MMM_MST_DOC"
    '                                                        ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                                            TABLENAME = "MMM_MST_DOC_ITEM"
    '                                                        ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                                            If arr(1).ToString.ToUpper = "USER" Then
    '                                                                TABLENAME = "MMM_MST_USER"
    '                                                                TID = "UID"
    '                                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                                TABLENAME = "MMM_MST_LOCATION"
    '                                                                TID = "LOCID"
    '                                                            End If
    '                                                        End If
    '                                                        Dim lookUpqry As String = ""
    '                                                        Dim str As String = ""
    '                                                        'With(nolock) added by Himank on 29th sep 2015
    '                                                        If arr(0).ToUpper() = "CHILD" Then
    '                                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                        Else
    '                                                            If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                                                str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
    '                                                            Else
    '                                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                                            End If
    '                                                        End If

    '                                                        Dim xwhr As String = ""
    '                                                        Dim tids As String = ""
    '                                                        'Dim tidarr() As String

    '                                                        ''FILTER THE DATA ACCORDING TO USER 
    '                                                        tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())

    '                                                        If tids.Length >= 2 Then
    '                                                            'tidarr = tids.Split("-")
    '                                                            xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                                        ElseIf tids = "0" Then
    '                                                            pnlFields.Visible = False
    '                                                            btnActEdit.Visible = False
    '                                                            UpdatePanel1.Update()
    '                                                            xwhr = ""
    '                                                        End If
    '                                                        str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                        Dim AutoFilter As String = dtfld1.Rows(j).Item("AutoFilter").ToString()
    '                                                        If AutoFilter.Length > 0 Then
    '                                                            If arr(0).ToUpper() = "CHILD" Then
    '                                                                If AutoFilter.ToUpper = "DOCID" Then
    '                                                                    str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
    '                                                                Else
    '                                                                    str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
    '                                                                End If
    '                                                                'With(nolock) added by Himank on 29th sep 2015
    '                                                            ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                                                str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                                str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                            Else
    '                                                                str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " "
    '                                                                str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                            End If
    '                                                        End If


    '                                                        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                                        Dim dss As New DataSet
    '                                                        If str.Length > 0 Then
    '                                                            oda.SelectCommand.CommandText = str
    '                                                            oda.Fill(dss, "FV")
    '                                                            Dim isAddJquery As Integer = 0
    '                                                            ddl.Items.Add("Select")
    '                                                            ddl.Items(0).Value = "0"
    '                                                            For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                                                ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
    '                                                                Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
    '                                                                ddl.Items(J1 + 1).Value = lookddlVal
    '                                                            Next
    '                                                            oda.Dispose()
    '                                                            dss.Dispose()
    '                                                            'prashant_2_7

    '                                                            Dim lookupvalue As String = dtfld1.Rows(j).Item("lookupvalue").ToString()
    '                                                            Dim multilookup As String = dtfld1.Rows(j).Item("multilookUpVal").ToString()
    '                                                            Dim ddlmultilookup As String = dtfld1.Rows(j).Item("ddlmultilookUpVal").ToString()
    '                                                            'LT Lookupval changes
    '                                                            Dim LTLookupval As String = Convert.ToString(dtfld1.Rows(j).Item("LTlookupval"))
    '                                                            If lookupvalue.Length > 0 Or multilookup.Length > 0 Or ddlmultilookup.Length > 0 Or LTLookupval.Length > 0 Then
    '                                                                ddl.AutoPostBack = True
    '                                                                AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged
    '                                                            End If

    '                                                            If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                                                ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                                            End If
    '                                                            If ViewState("chkadd") = 1 Then
    '                                                                j = j + 1
    '                                                            End If

    '                                                            If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                                                'ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                                                ddl.SelectedValue = ddl.Items.FindByText(row.Cells(j).Text).Value
    '                                                            End If

    '                                                            row.Cells(j).Controls.Add(ddl)

    '                                                            If isAddJquery = 1 Then
    '                                                                Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
    '                                                            End If
    '                                                        End If
    '                                                        con.Dispose()
    '                                                        oda.Dispose()
    '                                                        dss.Dispose()
    '                                                    ElseIf UCase(dropdowntype) = "SESSION VALUED" Then

    '                                                    End If
    '                                                End If
    '                                            Next
    '                                        End If
    '                                    End If

    '                                ElseIf ftype.ToUpper() = "DROP DOWN" Then
    '                                    Dim ddl As New DropDownList

    '                                    ddl.ID = "fld" & FldID & "_" & row.RowIndex
    '                                    ddl.CssClass = "txtBox"
    '                                    ddl.Width = 150
    '                                    Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
    '                                    Dim dropdowntype As String = dtfld1.Rows(j).Item("dropdowntype").ToString()
    '                                    Dim arr() As String
    '                                    If dtfld1.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                        'Dim cb As New DropDownList
    '                                        ' cb.ID = "fld" & FldID & row.RowIndex
    '                                        ddl.Items.Add("Select")
    '                                        ddl.Items(0).Value = "0"

    '                                        Dim ARR1() As String = dtfld1.Rows(j).Item("dropdown").ToString().Split(",")
    '                                        For K As Integer = 0 To ARR1.Length - 1
    '                                            ddl.Items.Add(ARR1(K).ToString)
    '                                        Next
    '                                        If ViewState("chkadd") = 1 Then
    '                                            j = j + 1
    '                                        End If

    '                                        '' for default value selection
    '                                        'If dtfld1.Rows(l).Item("ddlval").ToString().Length > 1 Then
    '                                        '    Dim dropdowntypeFill As String = ds.Rows(l).Item("ddlval").ToString().ToUpper()
    '                                        '    ddl.SelectedIndex = ddl.Items.IndexOf(ddl.Items.FindByText(dropdowntypeFill))
    '                                        'End If


    '                                        If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                            ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                        End If

    '                                        row.Cells(j).Controls.Add(ddl)
    '                                        'Prashant_10_7
    '                                        If dtfld1.Rows(j).Item("iseditable") = 1 Then
    '                                            ddl.Enabled = True
    '                                        Else
    '                                            ddl.Enabled = False
    '                                        End If

    '                                    ElseIf dtfld1.Rows(j).Item("dropdowntype").ToString() = "MASTER VALUED" Then
    '                                        '' code for getting master valued 
    '                                        Dim ob As New DynamicForm
    '                                        arr = ddlText.Split("-")
    '                                        Dim TID As String = "TID"
    '                                        Dim TABLENAME As String = ""
    '                                        If UCase(arr(0).ToString()) = "MASTER" Then
    '                                            TABLENAME = "MMM_MST_MASTER"
    '                                        ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                            TABLENAME = "MMM_MST_DOC"
    '                                        ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                            TABLENAME = "MMM_MST_DOC_ITEM"
    '                                        ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                            If arr(1).ToString.ToUpper = "USER" Then
    '                                                TABLENAME = "MMM_MST_USER"
    '                                                TID = "UID"
    '                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                TABLENAME = "MMM_MST_LOCATION"
    '                                                TID = "LOCID"
    '                                            End If
    '                                        End If
    '                                        Dim lookUpqry As String = ""
    '                                        Dim str As String = ""
    '                                        'With(nolock) added by Himank on 29th sep 2015
    '                                        If arr(0).ToUpper() = "CHILD" Then
    '                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                        Else
    '                                            If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                                str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
    '                                            Else
    '                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                            End If
    '                                        End If

    '                                        Dim xwhr As String = ""
    '                                        Dim tids As String = ""
    '                                        'Dim tidarr() As String

    '                                        ''FILTER THE DATA ACCORDING TO USER 
    '                                        tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())

    '                                        If tids.Length >= 2 Then
    '                                            'tidarr = tids.Split("-")
    '                                            xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                        ElseIf tids = "0" Then
    '                                            pnlFields.Visible = False
    '                                            btnActEdit.Visible = False
    '                                            UpdatePanel1.Update()
    '                                            xwhr = ""
    '                                        End If
    '                                        str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                        Dim AutoFilter As String = dtfld1.Rows(j).Item("AutoFilter").ToString()
    '                                        If AutoFilter.Length > 0 Then
    '                                            If arr(0).ToUpper() = "CHILD" Then
    '                                                If AutoFilter.ToUpper = "DOCID" Then
    '                                                    str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
    '                                                Else
    '                                                    str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
    '                                                End If
    '                                                'With(nolock) added by Himank on 29th sep 2015
    '                                            ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                                str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                            Else
    '                                                str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " "
    '                                                str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                            End If
    '                                        End If

    '                                        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                        Dim con As SqlConnection = New SqlConnection(conStr)
    '                                        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                        Dim dss As New DataSet

    '                                        If str.Length > 0 Then
    '                                            oda.SelectCommand.CommandText = str
    '                                            oda.Fill(dss, "FV")
    '                                            Dim isAddJquery As Integer = 0
    '                                            ddl.Items.Add("Select")
    '                                            ddl.Items(0).Value = "0"
    '                                            For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                                ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
    '                                                Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
    '                                                ddl.Items(J1 + 1).Value = lookddlVal
    '                                            Next
    '                                            oda.Dispose()
    '                                            dss.Dispose()
    '                                            'prashant_2_7

    '                                            Dim lookupvalue As String = dtfld1.Rows(j).Item("lookupvalue").ToString()
    '                                            Dim multilookup As String = dtfld1.Rows(j).Item("multilookUpVal").ToString()
    '                                            Dim ddlmultilookup As String = dtfld1.Rows(j).Item("ddlmultilookUpVal").ToString()
    '                                            'LT Lookupval changes
    '                                            Dim LTLookupval As String = Convert.ToString(dtfld1.Rows(j).Item("LTlookupval"))

    '                                            If lookupvalue.Length > 0 Or multilookup.Length > 0 Or ddlmultilookup.Length > 0 Or LTLookupval.Length > 0 Then
    '                                                ddl.AutoPostBack = True
    '                                                AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged
    '                                            End If


    '                                            ' '' new by sp on 18-nov-15 for Burgerking ticket
    '                                            'If Len(Convert.ToString(dtfld1.Rows(j).Item("ddlval"))) > 1 Then
    '                                            '    Dim DDldefaultVal As String = Convert.ToString(dtfld1.Rows(j).Item("ddlval"))
    '                                            '    ddl.SelectedIndex = ddl.Items.IndexOf(ddl.Items.FindByValue(DDldefaultVal))
    '                                            '    Dim id As String = Right(ddl.ID, ddl.ID.Length - 3)
    '                                            '    Dim ar() As String = id.Split("_")
    '                                            '    Dim id1 As Integer = CInt(ar(0))
    '                                            '    BindGRidLookup(ar(1), id1, ddl)
    '                                            '    Dim ob1 As New DynamicForm()
    '                                            '    ob1.GridMultiLookup(ar(1), id1, ddl, lblTab, pnlFields)
    '                                            '    ob1.GridLTLookup(ar(1), id1, ddl, lblTab, pnlFields)
    '                                            '    BindGRidLookupDDL(ar(1), id1, ddl)
    '                                            'End If
    '                                            ' '' new by sp on 18-nov-15 for Burgerking ticket - ends 
    '                                            ''If ds.Rows(i).Item("ddlval").ToString().Length > 1 Then
    '                                            ''    Dim ddl As New DropDownList
    '                                            ''    ddl = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), DropDownList)
    '                                            ''    Dim dropdowntypeFill As String = ds.Rows(i).Item("ddlval").ToString().ToUpper().Trim()
    '                                            ''    ddl.SelectedIndex = ddl.Items.IndexOf(ddl.Items.FindByValue(dropdowntypeFill))
    '                                            ''    '''''For filling lookup and lookupddl according drop down'''''''
    '                                            ''    Dim id As String = Right(ddl.ID, ddl.ID.Length - 3)
    '                                            ''    Dim id1 As Integer = CInt(id)
    '                                            ''    bind(id, pnlFields, ddl)
    '                                            ''    bindlookupddl(id, pnlFields, ddl)
    '                                            ''End If


    '                                            If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                                ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                            End If
    '                                            If ViewState("chkadd") = 1 Then
    '                                                j = j + 1
    '                                            End If

    '                                            If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                                ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                            End If

    '                                            row.Cells(j).Controls.Add(ddl)

    '                                            If isAddJquery = 1 Then
    '                                                Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
    '                                            End If
    '                                        End If
    '                                        con.Dispose()
    '                                        oda.Dispose()
    '                                        dss.Dispose()
    '                                        '' ends here for getting master valued 

    '                                    End If


    '                                ElseIf ftype.ToUpper() = "CHECKBOX LIST" Then
    '                                    Dim CHKlIST As New CheckBoxList()
    '                                    Dim dynmdiv As System.Web.UI.HtmlControls.HtmlGenericControl = New System.Web.UI.HtmlControls.HtmlGenericControl("DIV")
    '                                    dynmdiv.ID = "div_" & FldID
    '                                    Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
    '                                    CHKlIST.ID = "fld" & FldID & "_" & row.RowIndex
    '                                    If dtfld1.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                        Dim arr = ddlText.Split(",")
    '                                        For ii As Integer = 0 To arr.Count - 1
    '                                            CHKlIST.Items.Add(arr(ii).ToUpper())
    '                                        Next

    '                                    ElseIf dtfld1.Rows(j).Item("dropdowntype").ToString() = "MASTER VALUED" Then
    '                                        Dim arr = ddlText.Split("-")
    '                                        Dim TID As String = "TID"
    '                                        Dim TABLENAME As String = ""
    '                                        If UCase(arr(0).ToString()) = "MASTER" Then
    '                                            TABLENAME = "MMM_MST_MASTER"
    '                                        ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                            TABLENAME = "MMM_MST_DOC"
    '                                        ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                            TABLENAME = "MMM_MST_DOC_ITEM"
    '                                        ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                            If arr(1).ToString.ToUpper = "USER" Then
    '                                                TABLENAME = "MMM_MST_USER"
    '                                                TID = "UID"
    '                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                TABLENAME = "MMM_MST_LOCATION"
    '                                                TID = "LOCID"
    '                                            End If
    '                                        End If
    '                                        Dim lookUpqry As String = ""
    '                                        Dim str As String = ""
    '                                        'With(nolock) added by Himank on 29th sep 2015
    '                                        If arr(0).ToUpper() = "CHILD" Then
    '                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                        Else
    '                                            If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                                str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
    '                                            Else
    '                                                str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                            End If
    '                                        End If
    '                                        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                        Dim con As SqlConnection = New SqlConnection(conStr)
    '                                        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                        oda = New SqlDataAdapter("", con)
    '                                        Dim dss As New DataSet
    '                                        oda.SelectCommand.CommandText = str
    '                                        oda.Fill(dss, "FV")
    '                                        For JJ As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                            CHKlIST.Items.Add(dss.Tables("FV").Rows(JJ).Item(0))
    '                                            CHKlIST.Items(JJ).Value = dss.Tables("FV").Rows(JJ).Item(1)
    '                                        Next
    '                                        oda.Dispose()
    '                                        dss.Dispose()
    '                                    End If

    '                                    dynmdiv.Style.Add(HtmlTextWriterStyle.Width, "200px")
    '                                    dynmdiv.Style.Add(HtmlTextWriterStyle.Height, "100px")
    '                                    dynmdiv.Style.Add(HtmlTextWriterStyle.Overflow, "Scroll")
    '                                    dynmdiv.Controls.Add(CHKlIST)
    '                                    row.Cells(j).Controls.Add(dynmdiv)

    '                                ElseIf ftype.ToUpper = "LOOKUPDDL" Then

    '                                    datatype = dtfld1.Rows(j).Item("datatype").ToString().ToUpper()
    '                                    Dim fieldtypee As String = dtfld1.Rows(j).Item("FieldType").ToString().ToUpper()
    '                                    Dim ddl As New DropDownList
    '                                    ddl.ID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & "_" & row.RowIndex
    '                                    ddl.Width = controlWdth - 10
    '                                    ddl.CssClass = "txtBox"
    '                                    Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
    '                                    Dim dropdowntype As String = dtfld1.Rows(j).Item("dropdowntype").ToString()
    '                                    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                    Dim con As SqlConnection = New SqlConnection(conStr)
    '                                    'With(nolock) added by Himank on 29th sep 2015
    '                                    Dim od As SqlDataAdapter = New SqlDataAdapter("select dropdown,DDllookupvalue from MMM_MST_FIELDS  WITH(NOLOCK)  where FieldID='" & ddlText & "'", con)
    '                                    ' Dim dsMonth As New DataSet
    '                                    Dim dt As New DataTable
    '                                    od.Fill(dt)
    '                                    Dim arr() As String
    '                                    Dim darr() As String
    '                                    Dim type As String = dt.Rows(0).Item("dropdown").ToString()
    '                                    arr = type.Split("-")
    '                                    Dim documenttype As String = arr(1).ToString()
    '                                    Dim field As String = dt.Rows(0).Item("DDllookupvalue").ToString()
    '                                    field = field.Substring(0, field.Length - 1)
    '                                    darr = field.Split(",")
    '                                    For k As Integer = 0 To darr.Count - 1
    '                                        Dim fieldmping As String
    '                                        Dim str As String = ""
    '                                        Dim feild As String
    '                                        Dim s = darr(k).Split("-")
    '                                        feild = s(0).ToString()
    '                                        fieldmping = s(1).ToString()

    '                                        Dim TID As String = "TID"
    '                                        Dim TABLENAME As String = ""
    '                                        Dim str1 As String = ""
    '                                        Dim lookUpqry As String = ""

    '                                        Dim xwhr As String = ""
    '                                        Dim tids As String = ""
    '                                        Dim Rtids As String = ""   ' for prerole data filter


    '                                        If feild = dtfld1.Rows(j).Item("FieldID").ToString() Then
    '                                            'If arr(0) = "SESSION" And Not (fieldmping.Contains("fld")) Then
    '                                            '    If arr(1).ToString.ToUpper = "USER" Then
    '                                            '        TABLENAME = "MMM_MST_USER"
    '                                            '        TID = "UID"
    '                                            '    End If
    '                                            '    ' str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                            '    str1 = "select " & fieldmping.ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                            'Else

    '                                            'With(nolock) added by Himank on 29th sep 2015
    '                                            od.SelectCommand.CommandText = "select dropdown from MMM_MST_FIELDS  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("EID") & " and documenttype='" & documenttype & "' and FieldMapping in('" & fieldmping & "')"
    '                                            Dim dt1 As New DataTable
    '                                            od.Fill(dt1)
    '                                            Dim dropdown As String = dt1.Rows(0).Item("dropdown").ToString()
    '                                            arr = dropdown.Split("-")

    '                                            If UCase(arr(0).ToString()) = "MASTER" Then
    '                                                TABLENAME = "MMM_MST_MASTER"
    '                                            ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                                TABLENAME = "MMM_MST_DOC"
    '                                            ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                                TABLENAME = "MMM_MST_DOC_ITEM"
    '                                            ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                                If arr(1).ToString.ToUpper = "USER" Then
    '                                                    TABLENAME = "MMM_MST_USER"
    '                                                    TID = "UID"
    '                                                ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                    TABLENAME = "MMM_MST_LOCATION"
    '                                                    TID = "LOCID"
    '                                                End If
    '                                            ElseIf UCase(arr(0).ToString) = "SESSION" Then
    '                                                If arr(1).ToString.ToUpper = "USER" Then
    '                                                    TABLENAME = "MMM_MST_USER"
    '                                                    TID = "UID"
    '                                                ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                    TABLENAME = "MMM_MST_LOCATION"
    '                                                    TID = "LOCID"
    '                                                End If
    '                                            End If
    '                                            'With(nolock) added by Himank on 29th sep 2015
    '                                            If arr(0).ToUpper() = "CHILD" Then
    '                                                str1 = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                            ElseIf arr(0).ToUpper() = "SESSION" Then
    '                                                str1 = "Select " & IIf(arr(1).ToString.ToUpper = "USER", "UserName, ", "LocationName, ") & TID & " from " & TABLENAME & " M  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("EID") & " AND " & arr(2) & "='" & HttpContext.Current.Session(arr(2)) & "'"
    '                                            ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                                str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                            Else
    '                                                If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                                    str1 = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  "
    '                                                Else
    '                                                    str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                                End If
    '                                            End If
    '                                            '  End If

    '                                            'Dim tidarr() As String

    '                                            ''FILTER THE DATA ACCORDING TO USER 
    '                                            Dim ob = New DynamicForm()
    '                                            tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())
    '                                            Rtids = ob.UserDataFilter_PreRole(arr(1).ToString(), TABLENAME)  '' new by sunil for pre role data filter 22-feb

    '                                            '' for multiuse of document by sp on 08_apr_15
    '                                            Dim Sdtype As String = arr(1).ToString
    '                                            Dim da As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                            da.SelectCommand.CommandType = CommandType.Text
    '                                            'With(nolock) added by Himank on 29th sep 2015
    '                                            da.SelectCommand.CommandText = "select isnull(Allowmultiuse,0) from mmm_mst_forms  WITH(NOLOCK)  where eid='" & HttpContext.Current.Session("EID").ToString & "' AND FORMNAME='" & Sdtype & "'"
    '                                            If con.State <> ConnectionState.Open Then
    '                                                con.Open()
    '                                            End If
    '                                            Dim isMultiUse As Integer = Convert.ToInt32(da.SelectCommand.ExecuteScalar())

    '                                            Dim CurrDoctype As String = dtfld1.Rows(j).Item("documenttype").ToString()
    '                                            Dim CurrFieldMapping As String = dtfld1.Rows(j).Item("fieldmapping").ToString()

    '                                            Dim qry As String = ""
    '                                            Dim MTids As String = ""
    '                                            If UCase(arr(0).ToString()) <> "CHILD" And UCase(arr(0).ToString) <> "STATIC" And UCase(arr(0).ToString) <> "SESSION" Then
    '                                                da.SelectCommand.CommandType = CommandType.Text
    '                                                'With(nolock) added by Himank on 29th sep 2015
    '                                                da.SelectCommand.CommandText = "SELECT SUBSTRING((SELECT ',' + CONVERT(NVARCHAR," & CurrFieldMapping & ")  FROM " & TABLENAME & "  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("eid") & " and documenttype='" & CurrDoctype & "'" & " FOR XML PATH('')),2,1000) AS CSV"
    '                                                MTids = Convert.ToString(da.SelectCommand.ExecuteScalar())
    '                                            End If
    '                                            ''ends  for multiuse of document by sp on 08_apr_15


    '                                            If tids.Length >= 2 Then
    '                                                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                            ElseIf tids = "0" Then
    '                                                pnlFields.Visible = False
    '                                                btnActEdit.Visible = False
    '                                                UpdatePanel1.Update()
    '                                                xwhr = ""
    '                                            End If
    '                                            '' new by sunil for pre role data filter 22-feb
    '                                            If Rtids <> "" Then
    '                                                If xwhr.ToString = "" Then
    '                                                    xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & Rtids & ")"
    '                                                Else
    '                                                    xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & "," & Rtids & ")"
    '                                                End If
    '                                            End If

    '                                            '' new by sunil for multiuse of docs
    '                                            If MTids.Length > 2 And isMultiUse = 1 Then
    '                                                If Right(MTids, 1) = "," Then
    '                                                    MTids = Left(MTids, Len(MTids) - 1)
    '                                                End If
    '                                                xwhr = xwhr & " AND CONVERT(NVARCHAR(10),TID) not IN (" & MTids & ") "
    '                                            End If
    '                                            '' new by sunil for multiuse of docs

    '                                            str1 = str1 & "  AND M.isauth>0 " & xwhr & " order by " & arr(2).ToString()
    '                                            'Dim documenttype2 As String = arr1(1).ToString()
    '                                            'Dim fieldmping2 As String = arr1(2).ToString()
    '                                            'pnlFields.Controls.Add(ddl)
    '                                            Dim dt2 As New DataTable
    '                                            'oda.SelectCommand.CommandText = "select " & fieldmping2 & " from " & TABLENAME & " where EID=" & HttpContext.Current.Session("EID") & " and documenttype = '" & documenttype2 & "'"

    '                                            If str1.Length > 0 Then
    '                                                pnlFields.Controls.Add(ddl)
    '                                                od.SelectCommand.CommandText = str1
    '                                                od.Fill(dt2)
    '                                                Dim isAddJquery As Integer = 0
    '                                                ddl.Items.Add("Select")
    '                                                ddl.Items(0).Value = "0"
    '                                                For JK As Integer = 0 To dt2.Rows.Count - 1
    '                                                    ddl.Items.Add(dt2.Rows(JK).Item(0).ToString())
    '                                                    Dim lookddlVal As String = dt2.Rows(JK).Item(1).ToString()
    '                                                    ddl.Items(JK + 1).Value = lookddlVal
    '                                                Next
    '                                                dt2.Dispose()
    '                                            End If
    '                                            If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                                ddl.Enabled = True
    '                                            Else
    '                                                ddl.Enabled = False
    '                                            End If
    '                                        End If
    '                                    Next
    '                                    row.Cells(j).Controls.Add(ddl)

    '                                ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
    '                                    Dim txtBox As New FileUpload

    '                                    'Prashant 30-6-2014
    '                                    Dim txtBox1 As New HiddenField

    '                                    Dim lbl1 As New Label
    '                                    lbl1.ID = "lblf_" & FldID
    '                                    lbl1.Text = ""
    '                                    lbl1.ClientIDMode = ClientIDMode.Static

    '                                    txtBox1.ID = "hdn_" & FldID
    '                                    txtBox1.Value = ""
    '                                    txtBox1.ClientIDMode = ClientIDMode.Static
    '                                    If Not Request.QueryString("TID") Is Nothing Then
    '                                        txtBox.Attributes.Add("onchange", "UtilJs.UploadFile1(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
    '                                    Else
    '                                        txtBox.Attributes.Add("onchange", "UtilJs.UploadFile(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
    '                                    End If



    '                                    txtBox.ID = "fld_" & FldID & "_" & row.RowIndex  ' added  id  with _ by balli
    '                                    txtBox.CssClass = "txtBox"

    '                                    txtBox.Width = 180


    '                                    Dim hdnflag As New HiddenField
    '                                    If Not Request.QueryString("TID") Is Nothing Then
    '                                        hdnflag.ID = "hdnf_" & FldID
    '                                        hdnflag.Value = "0"
    '                                        Dim str As String = row.Cells(j).Text

    '                                        str = After(str, "/")

    '                                        txtBox1.Value = str 'row.Cells(j).Text
    '                                        lbl1.Text = str ' row.Cells(j).Text
    '                                        row.Cells(j).Text = str
    '                                    End If
    '                                    If ViewState("chkadd") = 1 Then
    '                                        j = j + 1
    '                                    End If
    '                                    row.Cells(j).Controls.Add(txtBox)
    '                                    'Prashant 30-6-2014
    '                                    row.Cells(j).Controls.Add(txtBox1)
    '                                    row.Cells(j).Controls.Add(lbl1)
    '                                    row.Cells(j).Controls.Add(hdnflag)

    '                                    Dim pstback As New PostBackTrigger
    '                                    pstback.ControlID = btnActEdit.ID
    '                                    UpdatePanel1.Triggers.Add(pstback)

    '                                End If
    '                                If ViewState("chkadd") = 1 Then
    '                                    j = j - 1    ' added for incremental 
    '                                End If
    '                            End If

    '                        Next
    '                    End If

    '                    ' By Neha Thakar 24-01-15
    '                Else
    '                    Dim filterRows2() As DataRow
    '                    filterRows2 = dtfld1.Select("HasDefaultValue=1")
    '                    'Uncomment it
    '                    'If filterRows.Length > 0 Then
    '                    '    dtfld1 = filterRows.CopyToDataTable()
    '                    'Else
    '                    '    filterRows = dtfld1.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''", "inlinemapping,DisplayOrder")
    '                    '    dtfld1 = filterRows.CopyToDataTable()
    '                    'End If


    '                    Dim filterRows() As DataRow
    '                    Dim filterRows1() As DataRow
    '                    filterRows = dtfld1.Select("inlinemapping is not null and inlinemapping <>''", "DisplayOrder")
    '                    filterRows1 = dtfld1.Select("InLineEditing=1 and inlinemapping is null", "DisplayOrder")
    '                    If filterRows.Length > 0 Then
    '                        dtfld1 = filterRows.CopyToDataTable()
    '                        dtfld1.Merge(filterRows1.CopyToDataTable())
    '                    Else
    '                        dtfld1 = filterRows1.CopyToDataTable()
    '                    End If


    '                    For j As Integer = 0 To dtfld1.Rows.Count - 1

    '                        Dim ftype As String = dtfld1.Rows(j).Item("fieldtype").ToString()

    '                        Dim datatype As String = dtfld1(j).Item("datatype").ToString() 'Prashant_10_7

    '                        Dim colValue As String = row.DataItem(j).ToString()
    '                        Dim ilEdit As Integer = dtfld1.Rows(j).Item("inlineEditing").ToString()
    '                        Dim FldID As String = dtfld1.Rows(j).Item("fieldid").ToString()
    '                        Dim Formula = Convert.ToString(dtfld1.Rows(j).Item("cal_text"))
    '                        Dim DisplayName = Convert.ToString(dtfld1.Rows(j).Item("DisplayName"))
    '                        Dim InlineMap = Convert.ToString(dtfld1.Rows(j).Item("inlinemapping"))
    '                        If ilEdit = 1 Then
    '                            If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Or ftype.ToUpper() = "PARENT VALUE" Then
    '                                Dim cb As New TextBox
    '                                'cb.ID = "fld" & j.ToString() & "_" & row.RowIndex
    '                                cb.Width = 35
    '                                cb.ID = "fld" & FldID & row.RowIndex

    '                                'Prashant_10_7
    '                                If dtfld1.Rows(j).Item("defaultfieldval").ToString().Length > 0 Then
    '                                    cb.Text = dtfld1.Rows(j).Item("defaultfieldval").ToString()
    '                                Else
    '                                    If datatype.ToUpper() = "NUMERIC" Then
    '                                        cb.Text = "0"
    '                                    End If
    '                                End If
    '                                If Val(dtfld1.Rows(j).Item("isDescription").ToString()) = 1 Then
    '                                    cb.ToolTip = dtfld1.Rows(j).Item("Description").ToString()
    '                                End If
    '                                If dtfld1.Rows(j).Item("iseditable") = 0 Then
    '                                    cb.Attributes.Add("READONLY", "READONLY")
    '                                    cb.Attributes.Add("COLOR", "GRAY")
    '                                End If
    '                                If ftype.ToUpper() = "CALCULATIVE FIELD" Then
    '                                    colValue = "0"
    '                                    cb.Attributes.Add("READONLY", "READONLY")
    '                                    cb.Attributes.Add("COLOR", "GRAY")
    '                                End If



    '                                If ftype.ToUpper() = "LOOKUP" Then
    '                                    If datatype.ToUpper() = "NUMERIC" Then
    '                                        colValue = "0"
    '                                    End If
    '                                Else
    '                                    If Val(colValue) = 0 Then
    '                                        If ftype.ToUpper() = "TEXT BOX" And datatype.ToUpper() = "NUMERIC" Then
    '                                            colValue = "0"
    '                                        End If
    '                                    End If
    '                                End If

    '                                If ViewState("chkadd") = 1 Then
    '                                    j = j + 1
    '                                End If

    '                                If Not row.Cells(j).Text.Trim = "&nbsp;" And Not row.Cells(j).Text.Trim = "" Then
    '                                    colValue = row.Cells(j).Text.Trim
    '                                Else
    '                                    colValue = cb.Text
    '                                End If

    '                                cb.Text = colValue
    '                                cb.Width = controlWdth

    '                                If cb.Text.Length > 15 Then
    '                                    cb.TextMode = TextBoxMode.MultiLine
    '                                    cb.Height = 30
    '                                End If

    '                                row.Cells(j).Controls.Add(cb)

    '                                If datatype.ToUpper.Trim = "DATETIME" Then
    '                                    If dtfld1.Rows(j).Item("iseditable") = 1 Then
    '                                        Dim CLNDR As New AjaxControlToolkit.CalendarExtender
    '                                        CLNDR.Controls.Clear()
    '                                        CLNDR.ID = "CLNDR" & dtfld1.Rows(j).Item("FieldID").ToString()
    '                                        CLNDR.Format = "dd/MM/yy"
    '                                        CLNDR.TargetControlID = cb.ID
    '                                        cb.Enabled = True

    '                                        cb.Text = String.Format("{0:dd/MM/yy}", Date.Now())

    '                                        'If ViewState("chkadd") = 1 Then
    '                                        '    j = j + 1
    '                                        'End If
    '                                        row.Cells(j).Controls.Add(CLNDR) '
    '                                    End If

    '                                End If

    '                                If Not Formula Is Nothing And Formula <> "" Then
    '                                    'Dim arrFor As String() = Formula.Split(",")
    '                                    Dim jScript = GenerateJQueryScript(dtfld1, GID, row.RowIndex, Formula, FldID)
    '                                    If jScript <> "" Then
    '                                        cb.Attributes.Add("onblur", jScript)
    '                                    End If
    '                                End If
    '                                If Val(dtfld1.Rows(j).Item("HasRule").ToString()) = 1 Then
    '                                    cb.AutoPostBack = True
    '                                    AddHandler cb.TextChanged, AddressOf grdTextBoxRule_TextChanged
    '                                End If

    '                            ElseIf ftype.ToUpper() = "MULTI LOOKUP" Then
    '                                Dim txtBox As New TextBox
    '                                txtBox.ID = "fld" & FldID & row.RowIndex
    '                                txtBox.Width = controlWdth - 10
    '                                txtBox.CssClass = "txtBox"
    '                                If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                    txtBox.Enabled = True
    '                                Else
    '                                    txtBox.Enabled = False
    '                                End If

    '                                If ViewState("chkadd") = 1 Then
    '                                    j = j + 1
    '                                End If
    '                                If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
    '                                    txtBox.Text = row.Cells(j).Text
    '                                End If

    '                                row.Cells(j).Controls.Add(txtBox)

    '                            ElseIf ftype.ToUpper() = "FORMULA FIELD" Then
    '                                Dim txtBox As New TextBox
    '                                txtBox.ID = "fld" & FldID & row.RowIndex
    '                                txtBox.Width = controlWdth - 10
    '                                txtBox.CssClass = "txtBox"
    '                                If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                    txtBox.Enabled = True
    '                                Else
    '                                    txtBox.Enabled = False
    '                                End If

    '                                If ViewState("chkadd") = 1 Then
    '                                    j = j + 1
    '                                End If
    '                                If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
    '                                    txtBox.Text = row.Cells(j).Text
    '                                Else
    '                                    txtBox.Text = "0"
    '                                End If

    '                                row.Cells(j).Controls.Add(txtBox)

    '                            ElseIf ftype.ToUpper() = "TEXT AREA" Then
    '                                Dim txtBox As New TextBox
    '                                txtBox.ID = "fld" & FldID & row.RowIndex
    '                                txtBox.Width = controlWdth + 50
    '                                txtBox.Height = 50
    '                                txtBox.TextMode = TextBoxMode.MultiLine
    '                                txtBox.Columns = 4
    '                                txtBox.Rows = 10
    '                                txtBox.CssClass = "txtBox"
    '                                If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                    txtBox.Enabled = True
    '                                Else
    '                                    txtBox.Enabled = False
    '                                End If

    '                                If ViewState("chkadd") = 1 Then
    '                                    j = j + 1
    '                                End If
    '                                If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
    '                                    txtBox.Text = row.Cells(j).Text
    '                                End If

    '                                row.Cells(j).Controls.Add(txtBox)

    '                            ElseIf ftype.ToUpper() = "AUTOCOMPLETE" Then

    '                                Dim txtbox As New TextBox
    '                                txtbox.ID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
    '                                txtbox.Width = controlWdth - 10
    '                                txtbox.CssClass = "txtBox"
    '                                txtbox.Attributes.Add("placeholder", "Please begin typing a " & DisplayName)
    '                                txtbox.AutoPostBack = True
    '                                AddHandler txtbox.TextChanged, AddressOf txtbox_TextChanged
    '                                ' adding handler for binding lookup or other dropdown or filter

    '                                Dim autofilExtender As New AjaxControlToolkit.AutoCompleteExtender
    '                                autofilExtender.ID = "extenderID" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex

    '                                autofilExtender.TargetControlID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
    '                                autofilExtender.ServiceMethod = "GetCompletionList" ' THIS SERVICE METHOD IS WRITTEN ON DOCUMENT PAGE 
    '                                autofilExtender.DelimiterCharacters = ""
    '                                autofilExtender.ContextKey = dtfld1.Rows(j).Item("DROPDOWN").ToString() & "-" & dtfld1.Rows(j).Item("FieldID").ToString() & "-" & dtfld1.Rows(j).Item("DROPDOWNTYPE").ToString() & "-" & dtfld1.Rows(j).Item("AUTOFILTER").ToString() & "-" & dtfld1.Rows(j).Item("inlinefilter").ToString()
    '                                'context key contain  : dropdown-fieldid-dropdowntype-autofilter-InitialFilter' adding the fieldid in context key because later on we need id of field in web method 
    '                                autofilExtender.Enabled = True
    '                                autofilExtender.CompletionSetCount = 5
    '                                autofilExtender.OnClientShown = "onDataShown"  ' by sunil
    '                                '   autofilExtender.CompletionListElementID = "ACsugestlist"
    '                                autofilExtender.MinimumPrefixLength = 1  ' start searching when entered one characters
    '                                'autofilExtender.OnClientItemSelected = "ace_itemSelected('" & ds.Rows(i).Item("FieldID").ToString() & "')"
    '                                autofilExtender.OnClientItemSelected = "ace_itemSelected"
    '                                row.Cells(j).Controls.Add(txtbox)
    '                                'pnlFields.Controls.Add(txtbox)

    '                                Dim hdnfld As New HiddenField
    '                                hdnfld.ID = "HDN" & dtfld1.Rows(j).Item("FieldID").ToString() & row.RowIndex
    '                                row.Cells(j).Controls.Add(hdnfld)
    '                                'pnlFields.Controls.Add(img)
    '                                'pnlFields.Controls.Add(prgBar)
    '                                row.Cells(j).Controls.Add(autofilExtender)
    '                                'pnlFields.Controls.Add(autofilExtender)



    '                            ElseIf ftype.ToUpper() = "MULTI LOOKUPDDL" Then

    '                                Dim ddl As New DropDownList
    '                                ddl.ID = "fld" & FldID & "_" & row.RowIndex
    '                                ddl.CssClass = "txtBox"
    '                                ddl.Width = 150

    '                                Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                Dim con As SqlConnection = New SqlConnection(conStr)
    '                                Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
    '                                Dim od As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                Dim dt As New DataTable
    '                                Dim dtval As New DataTable
    '                                Dim fieldid As String()
    '                                Dim ddlval As String()
    '                                If (ddlText.ToString() <> String.Empty) Then
    '                                    fieldid = ddlText.ToString().Split(",")
    '                                    'With(nolock) added by Himank on 29th sep 2015
    '                                    od.SelectCommand.CommandText = "select ddlMultilookupval from mmm_mst_fields  WITH(NOLOCK)  where fieldid = " & fieldid(0).ToString() & ""
    '                                    od.Fill(dtval)
    '                                    If (dtval.Rows.Count > 0) Then
    '                                        ddlval = dtval.Rows(0)("ddlMultilookupval").ToString().Split(",")
    '                                        For q As Integer = 0 To ddlval.Length - 1
    '                                            If (ddlval(q).ToString().Contains("-" & dtfld1.Rows(j).Item("FieldID").ToString())) Then
    '                                                Dim temp() As String = ddlval(q).ToString().Split("-")
    '                                                'With(nolock) added by Himank on 29th sep 2015
    '                                                od.SelectCommand.CommandText = "select * from MMM_MST_FIELDS  WITH(NOLOCK)  where DOCUMENTTYPE='" & temp(0).ToString() & "' and eid=" & HttpContext.Current.Session("EID") & " and fieldmapping in('" & temp(1).ToString() & "')"
    '                                                Dim checkval As New DataTable
    '                                                od.Fill(checkval)
    '                                                Dim ddlText1 As String = checkval.Rows(0).Item("dropdown").ToString()
    '                                                Dim dropdowntype As String = checkval.Rows(0).Item("dropdowntype").ToString()
    '                                                Dim arr() As String
    '                                                If UCase(dropdowntype) = "MASTER VALUED" Then
    '                                                    Dim ob As New DynamicForm
    '                                                    arr = ddlText1.Split("-")
    '                                                    Dim TID As String = "TID"
    '                                                    Dim TABLENAME As String = ""
    '                                                    If UCase(arr(0).ToString()) = "MASTER" Then
    '                                                        TABLENAME = "MMM_MST_MASTER"
    '                                                    ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                                        TABLENAME = "MMM_MST_DOC"
    '                                                    ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                                        TABLENAME = "MMM_MST_DOC_ITEM"
    '                                                    ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                                        If arr(1).ToString.ToUpper = "USER" Then
    '                                                            TABLENAME = "MMM_MST_USER"
    '                                                            TID = "UID"
    '                                                        ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                            TABLENAME = "MMM_MST_LOCATION"
    '                                                            TID = "LOCID"
    '                                                        End If
    '                                                    ElseIf UCase(arr(0).ToString) = "SESSION" Then
    '                                                        If arr(1).ToString.ToUpper = "USER" Then
    '                                                            TABLENAME = "MMM_MST_USER"
    '                                                            TID = "UID"
    '                                                        ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                            TABLENAME = "MMM_MST_LOCATION"
    '                                                            TID = "LOCID"
    '                                                        End If
    '                                                    End If
    '                                                    Dim lookUpqry As String = ""
    '                                                    Dim str As String = ""
    '                                                    'With(nolock) added by Himank on 29th sep 2015
    '                                                    If arr(0).ToUpper() = "CHILD" Then
    '                                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M   WITH(NOLOCK) WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                    ElseIf arr(0).ToUpper() = "SESSION" Then
    '                                                        str = "Select " & IIf(arr(1).ToString.ToUpper = "USER", "UserName, ", "LocationName, ") & TID & " from " & TABLENAME & " M  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("EID") & " AND " & arr(2) & "='" & HttpContext.Current.Session(arr(2)) & "'"
    '                                                    ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                    Else
    '                                                        If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                                            str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  "
    '                                                        Else
    '                                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                                        End If
    '                                                    End If

    '                                                    Dim xwhr As String = ""
    '                                                    Dim tids As String = ""
    '                                                    'Dim tidarr() As String

    '                                                    ''FILTER THE DATA ACCORDING TO USER 
    '                                                    tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())

    '                                                    If tids.Length >= 2 Then
    '                                                        'tidarr = tids.Split("-")
    '                                                        xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                                    ElseIf tids = "0" Then
    '                                                        pnlFields.Visible = False
    '                                                        btnActEdit.Visible = False
    '                                                        UpdatePanel1.Update()
    '                                                        xwhr = ""
    '                                                    End If
    '                                                    str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                    Dim AutoFilter As String = dtfld1.Rows(j).Item("AutoFilter").ToString()
    '                                                    If AutoFilter.Length > 0 Then
    '                                                        If arr(0).ToUpper() = "CHILD" Then
    '                                                            If AutoFilter.ToUpper = "DOCID" Then
    '                                                                str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
    '                                                            Else
    '                                                                str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
    '                                                            End If
    '                                                            'With(nolock) added by Himank on 29th sep 2015
    '                                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                                            str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                        Else
    '                                                            str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " "
    '                                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                                        End If
    '                                                    End If


    '                                                    Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                                    Dim dss As New DataSet
    '                                                    If str.Length > 0 Then
    '                                                        oda.SelectCommand.CommandText = str
    '                                                        oda.Fill(dss, "FV")
    '                                                        Dim isAddJquery As Integer = 0
    '                                                        ddl.Items.Add("Select")
    '                                                        ddl.Items(0).Value = "0"
    '                                                        For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                                            ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
    '                                                            Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
    '                                                            ddl.Items(J1 + 1).Value = lookddlVal
    '                                                        Next
    '                                                        oda.Dispose()
    '                                                        dss.Dispose()
    '                                                        'prashant_2_7

    '                                                        Dim lookupvalue As String = dtfld1.Rows(j).Item("lookupvalue").ToString()
    '                                                        Dim multilookup As String = dtfld1.Rows(j).Item("multilookUpVal").ToString()
    '                                                        Dim ddlmultilookup As String = dtfld1.Rows(j).Item("ddlmultilookUpVal").ToString()

    '                                                        If lookupvalue.Length > 0 Or multilookup.Length > 0 Or ddlmultilookup.Length > 0 Then
    '                                                            ddl.AutoPostBack = True
    '                                                            AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged
    '                                                        End If

    '                                                        If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                                            ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                                        End If
    '                                                        If ViewState("chkadd") = 1 Then
    '                                                            j = j + 1
    '                                                        End If

    '                                                        If ddl.Items.FindByValue(row.Cells(j).Text) IsNot Nothing Then
    '                                                            'ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                                            ddl.SelectedValue = ddl.Items.FindByValue(row.Cells(j).Text).Value
    '                                                        End If

    '                                                        row.Cells(j).Controls.Add(ddl)

    '                                                        If isAddJquery = 1 Then
    '                                                            Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
    '                                                        End If
    '                                                    End If
    '                                                    con.Dispose()
    '                                                    oda.Dispose()
    '                                                    dss.Dispose()
    '                                                ElseIf UCase(dropdowntype) = "SESSION VALUED" Then

    '                                                End If
    '                                            End If
    '                                        Next
    '                                    End If
    '                                End If


    '                            ElseIf ftype.ToUpper() = "DROP DOWN" Then
    '                                Dim ddl As New DropDownList
    '                                '' this is for isinlineediting and inlinemapping (import from master/document/other child)
    '                                ddl.ID = "fld" & FldID & "_" & row.RowIndex
    '                                ddl.CssClass = "txtBox"
    '                                ddl.Width = 150
    '                                Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
    '                                Dim dropdowntype As String = dtfld1.Rows(j).Item("dropdowntype").ToString()
    '                                Dim arr() As String
    '                                If dtfld1.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                    'Dim cb As New DropDownList
    '                                    ' cb.ID = "fld" & FldID & row.RowIndex
    '                                    ddl.Items.Add("Select")
    '                                    ddl.Items(0).Value = "0"

    '                                    Dim ARR1() As String = dtfld1.Rows(j).Item("dropdown").ToString().Split(",")
    '                                    For K As Integer = 0 To ARR1.Length - 1
    '                                        ddl.Items.Add(ARR1(K).ToString)
    '                                    Next

    '                                    '' for default value selection
    '                                    If dtfld1.Rows(j).Item("ddlval").ToString().Length > 0 Then
    '                                        Dim dropdowntypeFill As String = dtfld1.Rows(j).Item("ddlval").ToString().ToUpper()
    '                                        ddl.SelectedIndex = ddl.Items.IndexOf(ddl.Items.FindByText(dropdowntypeFill))
    '                                    End If

    '                                    ' If dtfld1.Rows(j).Item("maxlen").ToString() = "" Then
    '                                    ddl.Width = 70
    '                                    ' End If

    '                                    If ViewState("chkadd") = 1 Then
    '                                        j = j + 1
    '                                    End If





    '                                    If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                        'ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                        ddl.SelectedValue = ddl.Items.FindByText(row.Cells(j).Text).Value
    '                                    End If

    '                                    row.Cells(j).Controls.Add(ddl)
    '                                    'Prashant_10_7
    '                                    If dtfld1.Rows(j).Item("iseditable") = 1 Then
    '                                        ddl.Enabled = True
    '                                    Else
    '                                        ddl.Enabled = False
    '                                    End If

    '                                ElseIf dtfld1.Rows(j).Item("dropdowntype").ToString() = "MASTER VALUED" Then
    '                                    '' code for getting master valued 
    '                                    Dim ob As New DynamicForm
    '                                    arr = ddlText.Split("-")
    '                                    Dim TID As String = "TID"
    '                                    Dim TABLENAME As String = ""
    '                                    If UCase(arr(0).ToString()) = "MASTER" Then
    '                                        TABLENAME = "MMM_MST_MASTER"
    '                                    ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                        TABLENAME = "MMM_MST_DOC"
    '                                    ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                        TABLENAME = "MMM_MST_DOC_ITEM"
    '                                    ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                        If arr(1).ToString.ToUpper = "USER" Then
    '                                            TABLENAME = "MMM_MST_USER"
    '                                            TID = "UID"
    '                                        ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                            TABLENAME = "MMM_MST_LOCATION"
    '                                            TID = "LOCID"
    '                                        End If
    '                                    End If
    '                                    Dim lookUpqry As String = ""
    '                                    Dim str As String = ""
    '                                    'With(nolock) added by Himank on 29th sep 2015
    '                                    If arr(0).ToUpper() = "CHILD" Then
    '                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M   WITH(NOLOCK) WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                    ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                    Else
    '                                        If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                            str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
    '                                        Else
    '                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                        End If
    '                                    End If

    '                                    Dim xwhr As String = ""
    '                                    Dim tids As String = ""
    '                                    'Dim tidarr() As String

    '                                    ''FILTER THE DATA ACCORDING TO USER 
    '                                    tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())

    '                                    If tids.Length >= 2 Then
    '                                        'tidarr = tids.Split("-")
    '                                        xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                    ElseIf tids = "0" Then
    '                                        pnlFields.Visible = False
    '                                        btnActEdit.Visible = False
    '                                        UpdatePanel1.Update()
    '                                        xwhr = ""
    '                                    End If
    '                                    str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                    Dim AutoFilter As String = dtfld1.Rows(j).Item("AutoFilter").ToString()
    '                                    If AutoFilter.Length > 0 Then
    '                                        If arr(0).ToUpper() = "CHILD" Then
    '                                            If AutoFilter.ToUpper = "DOCID" Then
    '                                                str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
    '                                            Else
    '                                                str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
    '                                            End If
    '                                            'With(nolock) added by Himank on 29th sep 2015
    '                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                            str = "select " & arr(2).ToString() & ",convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                        Else
    '                                            str = "select " & arr(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & Session("EID") & " "
    '                                            str = str & "  AND M.isauth=1 " & xwhr & " order by " & arr(2).ToString()
    '                                        End If
    '                                    End If

    '                                    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                    Dim con As SqlConnection = New SqlConnection(conStr)
    '                                    Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                    Dim dss As New DataSet

    '                                    If str.Length > 0 Then
    '                                        oda.SelectCommand.CommandText = str
    '                                        oda.Fill(dss, "FV")
    '                                        Dim isAddJquery As Integer = 0
    '                                        ddl.Items.Add("Select")
    '                                        ddl.Items(0).Value = "0"
    '                                        For J1 As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                            ddl.Items.Add(dss.Tables("FV").Rows(J1).Item(0).ToString())
    '                                            Dim lookddlVal As String = dss.Tables("FV").Rows(J1).Item(1).ToString()
    '                                            ddl.Items(J1 + 1).Value = lookddlVal
    '                                        Next
    '                                        oda.Dispose()
    '                                        dss.Dispose()
    '                                        'prashant_2_7

    '                                        Dim lookupvalue As String = dtfld1.Rows(j).Item("lookupvalue").ToString()
    '                                        Dim multilookup As String = dtfld1.Rows(j).Item("multilookUpVal").ToString()
    '                                        Dim ddlmultilookup As String = dtfld1.Rows(j).Item("ddlmultilookUpVal").ToString()
    '                                        'LT Lookupval changes
    '                                        Dim LTLookupval As String = Convert.ToString(dtfld1.Rows(j).Item("LTlookupval"))

    '                                        If lookupvalue.Length > 0 Or multilookup.Length > 0 Or ddlmultilookup.Length > 0 Or LTLookupval.Length > 0 Then
    '                                            ddl.AutoPostBack = True
    '                                            AddHandler ddl.TextChanged, AddressOf GridDdl_TextChanged
    '                                        End If


    '                                        ' '' new by sp on 18-nov-15 for Burgerking ticket
    '                                        'If Len(Convert.ToString(dtfld1.Rows(j).Item("ddlval"))) > 1 Then
    '                                        '    Dim DDldefaultVal As String = Convert.ToString(dtfld1.Rows(j).Item("ddlval"))
    '                                        '    ddl.SelectedIndex = ddl.Items.IndexOf(ddl.Items.FindByValue(DDldefaultVal))
    '                                        '    Dim id As String = Right(ddl.ID, ddl.ID.Length - 3)
    '                                        '    Dim ar() As String = id.Split("_")
    '                                        '    Dim id1 As Integer = CInt(ar(0))
    '                                        '    BindGRidLookup(ar(1), id1, ddl)
    '                                        '    Dim ob1 As New DynamicForm()
    '                                        '    ob1.GridMultiLookup(ar(1), id1, ddl, lblTab, pnlFields)
    '                                        '    ob1.GridLTLookup(ar(1), id1, ddl, lblTab, pnlFields)
    '                                        '    BindGRidLookupDDL(ar(1), id1, ddl)
    '                                        'End If
    '                                        ' '' new by sp on 18-nov-15 for Burgerking ticket - ends 

    '                                        If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                            ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                        End If
    '                                        If ViewState("chkadd") = 1 Then
    '                                            j = j + 1
    '                                        End If

    '                                        If ddl.Items.FindByText(row.Cells(j).Text) IsNot Nothing Then
    '                                            'ddl.Items.FindByText(row.Cells(j).Text).Selected = True
    '                                            ddl.SelectedValue = ddl.Items.FindByText(row.Cells(j).Text).Value
    '                                        End If

    '                                        row.Cells(j).Controls.Add(ddl)

    '                                        If isAddJquery = 1 Then
    '                                            Dim JQuertStr As String = "var r1 = $('#ContentPlaceHolder1_" & ddl.ClientID & "').val(); var l = 0; var mycars = new Array(); for (var i = 0; i < r1.length; i++) { if (r1[i] == '|') { l++; mycars[l] = i; } } for (var i1 = 1; i1 < l; i1++) { var outpu = r1.substring(mycars[i1] + 1, mycars[i1 + 1]); var outpu1 = outpu.substring(0, outpu.indexOf(':')); var outpu2 = outpu.substring(outpu.indexOf(':') + 1); if (outpu2 == 'S') { var out = r1.substring(0, mycars[1]); var x = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option').length; var options = ''; txt = ''; for (i = 0; i < x; i++) { var strUser = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').val(); var sel = strUser.substring(strUser.indexOf('-') + 1);  if (out == sel) { var finalshow = $('#ContentPlaceHolder1_tmp' + outpu1 + ' option:eq(' + i + ')').text();  options = options + '<option value=' + finalshow + '>' + finalshow + '</option>\n'; } } $('#ContentPlaceHolder1_' + outpu1 + '').html(options); } else { $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); } $('#ContentPlaceHolder1_' + outpu1 + '').val(outpu2); }"
    '                                        End If
    '                                    End If
    '                                    con.Dispose()
    '                                    oda.Dispose()
    '                                    dss.Dispose()
    '                                    '' ends here for getting master valued -- changed by sp on 04_May_16
    '                                    If dtfld1.Rows(j).Item("iseditable") = 0 Then
    '                                        ddl.Enabled = False
    '                                    End If
    '                                End If
    '                            ElseIf ftype.ToUpper() = "CHECKBOX LIST" Then
    '                                Dim CHKlIST As New CheckBoxList()
    '                                Dim dynmdiv As System.Web.UI.HtmlControls.HtmlGenericControl = New System.Web.UI.HtmlControls.HtmlGenericControl("DIV")
    '                                dynmdiv.ID = "div_" & FldID
    '                                Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
    '                                CHKlIST.ID = "fld" & FldID & "_" & row.RowIndex
    '                                If dtfld1.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                    Dim arr = ddlText.Split(",")
    '                                    For ii As Integer = 0 To arr.Count - 1
    '                                        CHKlIST.Items.Add(arr(ii).ToUpper())
    '                                    Next

    '                                ElseIf dtfld1.Rows(j).Item("dropdowntype").ToString() = "MASTER VALUED" Then
    '                                    Dim arr = ddlText.Split("-")
    '                                    Dim TID As String = "TID"
    '                                    Dim TABLENAME As String = ""
    '                                    If UCase(arr(0).ToString()) = "MASTER" Then
    '                                        TABLENAME = "MMM_MST_MASTER"
    '                                    ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                        TABLENAME = "MMM_MST_DOC"
    '                                    ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                        TABLENAME = "MMM_MST_DOC_ITEM"
    '                                    ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                        If arr(1).ToString.ToUpper = "USER" Then
    '                                            TABLENAME = "MMM_MST_USER"
    '                                            TID = "UID"
    '                                        ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                            TABLENAME = "MMM_MST_LOCATION"
    '                                            TID = "LOCID"
    '                                        End If
    '                                    End If
    '                                    Dim lookUpqry As String = ""
    '                                    Dim str As String = ""
    '                                    'With(nolock) added by Himank on 29th sep 2015
    '                                    If arr(0).ToUpper() = "CHILD" Then
    '                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                    ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                        str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                    Else
    '                                        If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                            str = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) "
    '                                        Else
    '                                            str = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                        End If
    '                                    End If
    '                                    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                    Dim con As SqlConnection = New SqlConnection(conStr)
    '                                    Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                    oda = New SqlDataAdapter("", con)
    '                                    Dim dss As New DataSet
    '                                    oda.SelectCommand.CommandText = str
    '                                    oda.Fill(dss, "FV")
    '                                    For JJ As Integer = 0 To dss.Tables("FV").Rows.Count - 1
    '                                        CHKlIST.Items.Add(dss.Tables("FV").Rows(JJ).Item(0))
    '                                        CHKlIST.Items(JJ).Value = dss.Tables("FV").Rows(JJ).Item(1)
    '                                    Next
    '                                    oda.Dispose()
    '                                    dss.Dispose()
    '                                End If

    '                                dynmdiv.Style.Add(HtmlTextWriterStyle.Width, "200px")
    '                                dynmdiv.Style.Add(HtmlTextWriterStyle.Height, "100px")
    '                                dynmdiv.Style.Add(HtmlTextWriterStyle.Overflow, "Scroll")
    '                                dynmdiv.Controls.Add(CHKlIST)
    '                                row.Cells(j).Controls.Add(dynmdiv)

    '                            ElseIf ftype.ToUpper = "LOOKUPDDL" Then

    '                                datatype = dtfld1.Rows(j).Item("datatype").ToString().ToUpper()
    '                                Dim fieldtypee As String = dtfld1.Rows(j).Item("FieldType").ToString().ToUpper()
    '                                Dim ddl As New DropDownList
    '                                ddl.ID = "fld" & dtfld1.Rows(j).Item("FieldID").ToString() & "_" & row.RowIndex
    '                                ddl.Width = controlWdth - 10
    '                                ddl.CssClass = "txtBox"
    '                                Dim ddlText As String = dtfld1.Rows(j).Item("dropdown").ToString()
    '                                Dim dropdowntype As String = dtfld1.Rows(j).Item("dropdowntype").ToString()
    '                                Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '                                Dim con As SqlConnection = New SqlConnection(conStr)
    '                                'With(nolock) added by Himank on 29th sep 2015
    '                                Dim od As SqlDataAdapter = New SqlDataAdapter("select dropdown,DDllookupvalue from MMM_MST_FIELDS   WITH(NOLOCK) where FieldID='" & ddlText & "'", con)
    '                                ' Dim dsMonth As New DataSet
    '                                Dim dt As New DataTable
    '                                od.Fill(dt)
    '                                Dim arr() As String
    '                                Dim darr() As String
    '                                Dim type As String = dt.Rows(0).Item("dropdown").ToString()
    '                                arr = type.Split("-")
    '                                Dim documenttype As String = arr(1).ToString()
    '                                Dim field As String = dt.Rows(0).Item("DDllookupvalue").ToString()
    '                                field = field.Substring(0, field.Length - 1)
    '                                darr = field.Split(",")
    '                                For k As Integer = 0 To darr.Count - 1
    '                                    Dim fieldmping As String
    '                                    Dim str As String = ""
    '                                    Dim feild As String
    '                                    Dim s = darr(k).Split("-")
    '                                    feild = s(0).ToString()
    '                                    fieldmping = s(1).ToString()

    '                                    Dim TID As String = "TID"
    '                                    Dim TABLENAME As String = ""
    '                                    Dim str1 As String = ""
    '                                    Dim lookUpqry As String = ""

    '                                    Dim xwhr As String = ""
    '                                    Dim tids As String = ""
    '                                    Dim Rtids As String = ""   ' for prerole data filter


    '                                    If feild = dtfld1.Rows(j).Item("FieldID").ToString() Then
    '                                        'If arr(0) = "SESSION" And Not (fieldmping.Contains("fld")) Then
    '                                        '    If arr(1).ToString.ToUpper = "USER" Then
    '                                        '        TABLENAME = "MMM_MST_USER"
    '                                        '        TID = "UID"
    '                                        '    End If
    '                                        '    ' str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                        '    str1 = "select " & fieldmping.ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                        'Else

    '                                        'With(nolock) added by Himank on 29th sep 2015
    '                                        od.SelectCommand.CommandText = "select dropdown from MMM_MST_FIELDS  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("EID") & " and documenttype='" & documenttype & "' and FieldMapping in('" & fieldmping & "')"
    '                                        Dim dt1 As New DataTable
    '                                        od.Fill(dt1)
    '                                        Dim dropdown As String = dt1.Rows(0).Item("dropdown").ToString()
    '                                        arr = dropdown.Split("-")

    '                                        If UCase(arr(0).ToString()) = "MASTER" Then
    '                                            TABLENAME = "MMM_MST_MASTER"
    '                                        ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
    '                                            TABLENAME = "MMM_MST_DOC"
    '                                        ElseIf UCase(arr(0).ToString()) = "CHILD" Then
    '                                            TABLENAME = "MMM_MST_DOC_ITEM"
    '                                        ElseIf UCase(arr(0).ToString) = "STATIC" Then
    '                                            If arr(1).ToString.ToUpper = "USER" Then
    '                                                TABLENAME = "MMM_MST_USER"
    '                                                TID = "UID"
    '                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                TABLENAME = "MMM_MST_LOCATION"
    '                                                TID = "LOCID"
    '                                            End If
    '                                        ElseIf UCase(arr(0).ToString) = "SESSION" Then
    '                                            If arr(1).ToString.ToUpper = "USER" Then
    '                                                TABLENAME = "MMM_MST_USER"
    '                                                TID = "UID"
    '                                            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
    '                                                TABLENAME = "MMM_MST_LOCATION"
    '                                                TID = "LOCID"
    '                                            End If
    '                                        End If
    '                                        'With(nolock) added by Himank on 29th sep 2015
    '                                        If arr(0).ToUpper() = "CHILD" Then
    '                                            str1 = "select " & arr(2).ToString() & "," & TID & "[tid]  from " & TABLENAME & " M  WITH(NOLOCK)  WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                        ElseIf arr(0).ToUpper() = "SESSION" Then
    '                                            str1 = "Select " & IIf(arr(1).ToString.ToUpper = "USER", "UserName, ", "LocationName, ") & TID & " from " & TABLENAME & " M  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("EID") & " AND " & arr(2) & "='" & HttpContext.Current.Session(arr(2)) & "'"
    '                                        ElseIf arr(0).ToUpper() <> "STATIC" Then
    '                                            str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
    '                                        Else
    '                                            If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
    '                                                str1 = "select DISTINCT " & arr(2).ToString() & ",SID [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  "
    '                                            Else
    '                                                str1 = "select " & arr(2).ToString() & "," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
    '                                            End If
    '                                        End If
    '                                        '  End If

    '                                        'Dim tidarr() As String

    '                                        ''FILTER THE DATA ACCORDING TO USER 
    '                                        Dim ob = New DynamicForm()
    '                                        tids = ob.UserDataFilter(dtfld1.Rows(j).Item("documenttype").ToString(), arr(1).ToString())
    '                                        Rtids = ob.UserDataFilter_PreRole(arr(1).ToString(), TABLENAME)  '' new by sunil for pre role data filter 22-feb

    '                                        '' for multiuse of document by sp on 08_apr_15
    '                                        Dim Sdtype As String = arr(1).ToString
    '                                        Dim da As SqlDataAdapter = New SqlDataAdapter("", con)
    '                                        da.SelectCommand.CommandType = CommandType.Text
    '                                        'With(nolock) added by Himank on 29th sep 2015
    '                                        da.SelectCommand.CommandText = "select isnull(Allowmultiuse,0) from mmm_mst_forms  WITH(NOLOCK)  where eid='" & HttpContext.Current.Session("EID").ToString & "' AND FORMNAME='" & Sdtype & "'"
    '                                        If con.State <> ConnectionState.Open Then
    '                                            con.Open()
    '                                        End If
    '                                        Dim isMultiUse As Integer = Convert.ToInt32(da.SelectCommand.ExecuteScalar())

    '                                        Dim CurrDoctype As String = dtfld1.Rows(j).Item("documenttype").ToString()
    '                                        Dim CurrFieldMapping As String = dtfld1.Rows(j).Item("fieldmapping").ToString()

    '                                        Dim qry As String = ""
    '                                        Dim MTids As String = ""
    '                                        If UCase(arr(0).ToString()) <> "CHILD" And UCase(arr(0).ToString) <> "STATIC" And UCase(arr(0).ToString) <> "SESSION" Then
    '                                            da.SelectCommand.CommandType = CommandType.Text
    '                                            da.SelectCommand.CommandText = "SELECT SUBSTRING((SELECT ',' + CONVERT(NVARCHAR," & CurrFieldMapping & ")  FROM " & TABLENAME & " where EID=" & HttpContext.Current.Session("eid") & " and documenttype='" & CurrDoctype & "'" & " FOR XML PATH('')),2,1000) AS CSV"
    '                                            MTids = Convert.ToString(da.SelectCommand.ExecuteScalar())
    '                                        End If
    '                                        ''ends  for multiuse of document by sp on 08_apr_15


    '                                        If tids.Length >= 2 Then
    '                                            xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
    '                                        ElseIf tids = "0" Then
    '                                            pnlFields.Visible = False
    '                                            btnActEdit.Visible = False
    '                                            UpdatePanel1.Update()
    '                                            xwhr = ""
    '                                        End If
    '                                        '' new by sunil for pre role data filter 22-feb
    '                                        If Rtids <> "" Then
    '                                            If xwhr.ToString = "" Then
    '                                                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & Rtids & ")"
    '                                            Else
    '                                                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & "," & Rtids & ")"
    '                                            End If
    '                                        End If

    '                                        '' new by sunil for multiuse of docs
    '                                        If MTids.Length > 2 And isMultiUse = 1 Then
    '                                            If Right(MTids, 1) = "," Then
    '                                                MTids = Left(MTids, Len(MTids) - 1)
    '                                            End If
    '                                            xwhr = xwhr & " AND CONVERT(NVARCHAR(10),TID) not IN (" & MTids & ") "
    '                                        End If
    '                                        '' new by sunil for multiuse of docs

    '                                        str1 = str1 & "  AND M.isauth>0 " & xwhr & " order by " & arr(2).ToString()
    '                                        'Dim documenttype2 As String = arr1(1).ToString()
    '                                        'Dim fieldmping2 As String = arr1(2).ToString()
    '                                        'pnlFields.Controls.Add(ddl)
    '                                        Dim dt2 As New DataTable
    '                                        'oda.SelectCommand.CommandText = "select " & fieldmping2 & " from " & TABLENAME & " where EID=" & HttpContext.Current.Session("EID") & " and documenttype = '" & documenttype2 & "'"

    '                                        If str1.Length > 0 Then
    '                                            pnlFields.Controls.Add(ddl)
    '                                            od.SelectCommand.CommandText = str1
    '                                            od.Fill(dt2)
    '                                            Dim isAddJquery As Integer = 0
    '                                            ddl.Items.Add("Select")
    '                                            ddl.Items(0).Value = "0"
    '                                            For JK As Integer = 0 To dt2.Rows.Count - 1
    '                                                ddl.Items.Add(dt2.Rows(JK).Item(0).ToString())
    '                                                Dim lookddlVal As String = dt2.Rows(JK).Item(1).ToString()
    '                                                ddl.Items(JK + 1).Value = lookddlVal
    '                                            Next
    '                                            dt2.Dispose()
    '                                        End If
    '                                        If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                            ddl.Enabled = True
    '                                        Else
    '                                            ddl.Enabled = False
    '                                        End If
    '                                    End If
    '                                Next
    '                                row.Cells(j).Controls.Add(ddl)

    '                            ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
    '                                Dim txtBox As New FileUpload

    '                                'Prashant 30-6-2014
    '                                Dim txtBox1 As New HiddenField

    '                                Dim lbl1 As New Label
    '                                lbl1.ID = "lblf_" & FldID
    '                                lbl1.Text = ""
    '                                lbl1.ClientIDMode = ClientIDMode.Static

    '                                txtBox1.ID = "hdn_" & FldID
    '                                txtBox1.Value = ""
    '                                txtBox1.ClientIDMode = ClientIDMode.Static
    '                                If Convert.ToInt32(objDC.ExecuteQryScaller("select count(*) from  mmm_hdmail_schdule where  eid=" & dtfld1.Rows(j).Item("EID").ToString() & " and DocumentType in(select documenttype from mmm_mst_fields where dropdown='" & dtfld1.Rows(j).Item("documenttype").ToString() & "' and eid=" & dtfld1.Rows(j).Item("EID").ToString() & ")")) > 0 Then
    '                                    If Not Request.QueryString("TID") Is Nothing Then
    '                                        txtBox.Attributes.Add("onchange", "TicketUtils.UploadFile1(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
    '                                    Else
    '                                        txtBox.Attributes.Add("onchange", "TicketUtils.UploadFile(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
    '                                    End If
    '                                Else
    '                                    If Not Request.QueryString("TID") Is Nothing Then
    '                                        txtBox.Attributes.Add("onchange", "UtilJs.UploadFile1(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
    '                                    Else
    '                                        txtBox.Attributes.Add("onchange", "UtilJs.UploadFile(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
    '                                    End If
    '                                End If
    '                                'If Not Request.QueryString("TID") Is Nothing Then
    '                                '    txtBox.Attributes.Add("onchange", "UtilJs.UploadFile1(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
    '                                'Else
    '                                '    txtBox.Attributes.Add("onchange", "UtilJs.UploadFile(this,'" & txtBox1.ID.ToString() & "','" & lbl1.ID.ToString() & "')")
    '                                'End If



    '                                txtBox.ID = "fld_" & FldID & "_" & row.RowIndex  ' added  id  with _ by balli
    '                                txtBox.CssClass = "txtBox"

    '                                txtBox.Width = 180


    '                                Dim hdnflag As New HiddenField
    '                                If Not Request.QueryString("TID") Is Nothing Then
    '                                    hdnflag.ID = "hdnf_" & FldID
    '                                    hdnflag.Value = "0"
    '                                    Dim str As String = row.Cells(j).Text

    '                                    str = After(str, "/")

    '                                    txtBox1.Value = str 'row.Cells(j).Text
    '                                    lbl1.Text = str ' row.Cells(j).Text
    '                                    row.Cells(j).Text = str
    '                                End If
    '                                If ViewState("chkadd") = 1 Then
    '                                    j = j + 1
    '                                End If
    '                                row.Cells(j).Controls.Add(txtBox)
    '                                'Prashant 30-6-2014
    '                                row.Cells(j).Controls.Add(txtBox1)
    '                                row.Cells(j).Controls.Add(lbl1)
    '                                row.Cells(j).Controls.Add(hdnflag)

    '                                Dim pstback As New PostBackTrigger
    '                                pstback.ControlID = btnActEdit.ID
    '                                UpdatePanel1.Triggers.Add(pstback)
    '                                'Changes for LT Lookup
    '                            ElseIf ftype.ToUpper() = "LT LOOKUP" Then
    '                                Dim txtBox As New TextBox
    '                                txtBox.ID = "fld" & FldID & row.RowIndex
    '                                txtBox.Width = controlWdth - 10
    '                                txtBox.CssClass = "txtBox"
    '                                If dtfld1.Rows(j).Item("isEditable").ToString() = "1" Then
    '                                    txtBox.Enabled = True
    '                                Else
    '                                    txtBox.Enabled = False
    '                                End If

    '                                If ViewState("chkadd") = 1 Then
    '                                    j = j + 1
    '                                End If
    '                                If Not row.Cells(j).Text = "" And Not row.Cells(j).Text = "&nbsp;" Then
    '                                    txtBox.Text = row.Cells(j).Text
    '                                End If

    '                                row.Cells(j).Controls.Add(txtBox)

    '                            End If
    '                            If ViewState("chkadd") = 1 Then
    '                                j = j - 1    ' added for incremental 
    '                            End If
    '                        End If

    '                    Next
    '                End If
    '            End If
    '        End If
    '    Catch ex As Exception
    '        Dim a As String = ""
    '    End Try
    'End Sub


    Public Function GenerateJQueryScript(ByVal dt As DataTable, ByVal GridID As String, ByVal RowID As Integer, ByVal Formula As String, ByVal FieldID As Integer) As String
        Dim result = ""
        Try
            Dim CurRow As DataRow() = dt.Select("FieldID='" & FieldID & "'")
            Dim DisplayName = Convert.ToString(CurRow(0).Item("DisplayName"))
            Dim strFormula = ""
            'appending , in case when only one formula exists
            Formula = "," & Formula
            Dim FormulaField = ""
            'Formula = Formula.Remove("{", "").Remove("}", "")
            'Spliting all the formula with ,
            Dim arrFor As String() = Formula.Split(",")
            Dim liverFormula = From fldMapping In arrFor Where fldMapping <> "" And Not fldMapping Is Nothing Select fldMapping
            For Each Formula1 In liverFormula
                Dim arr As String() = Formula1.Split("=")
                FormulaField = arr(0).Replace("{", "").Replace("}", "")
                strFormula = arr(1)
                If arr(1).Contains("{" & DisplayName & "}") Then
                    Dim str As String() = arr(1).Split("+", "-", "*", "/", "%")
                    For Each str1 In str

                        str1 = str1.Replace("{", "").Replace("}", "")
                        Dim DR As DataRow() = dt.Select("DisplayName='" & str1 & "'")
                        If DR.Length > 0 Then
                            If strFormula.Contains("{" & DR(0).Item("DisplayName") & "}") Then
                                strFormula = strFormula.Replace("{" & DR(0).Item("DisplayName") & "}", "parseFloat($('#ContentPlaceHolder1_GRD" & GridID & "_fld" & DR(0).Item("FieldID") & RowID & "_" & RowID & "').val())")
                            End If
                        Else
                            If IsNumeric(str1) Then
                                If strFormula.Contains("{" & str1 & "}") Then
                                    strFormula = strFormula.Replace("{" & str1 & "}", str1)
                                End If
                            End If
                        End If

                    Next
                    Dim DR1 As DataRow() = dt.Select("DisplayName='" & FormulaField & "'")
                    strFormula = "parseFloat($('#ContentPlaceHolder1_GRD" & GridID & "_fld" & DR1(0).Item("FieldID") & RowID & "_" & RowID & "').val(" & strFormula & "))"
                    If result = "" Then
                        result = strFormula
                    Else
                        result = result & ";" & strFormula
                    End If
                End If
            Next
        Catch ex As Exception
            Return ""
        End Try
        Return result
    End Function

    Public Sub bindvalue(ByVal sender As Object, ByVal e As EventArgs)
        Dim ddl As DropDownList = TryCast(sender, DropDownList)
        Dim id As String = Right(ddl.ID, ddl.ID.Length - 3)
        Dim id1 As Integer = CInt(id)
        Dim ob As New DynamicForm()
        ob.bind(id, pnlFields, ddl)
        ob.bindlookupddl(id, pnlFields, ddl)
        ob.bindMultiLookUP(id, pnlFields, ddl)
        ob.bindddlMultiLookUP(id, pnlFields, ddl)
        ob.bindLTLookUP(id, pnlFields, ddl)
        GetFiles()
        'Code By Ajeet.Added on 21-January-2015 For Rule Engine Execution on control level
        Try
            Dim screenname = Request.QueryString("SC").ToString
            Dim dt As DataTable = Session("PFieldsData")
            ExecuteControllevelRule(id1, pnlFields, Nothing, screenname, dt, Nothing, lblTab, False)
        Catch ex As Exception
            Throw
        End Try

        'Code By Ajeet.Added on 02-March-2016 For Dropdown filter 
        'Please Note:Its hard code for filterring Activity dropdown  from following
        '1.Activity Type
        '2.Site
        '3.Act
        '4.Frequency of Activity(Only As needed)
        'This code will only be used in ecompliancebeta
        Try
            'Allow this code only on selection change of Act
            If (id1.ToString.Trim() = "25274" Or id1.ToString.Trim() = "25451") Then
                Dim Act As String = "0"
                Dim ActivityType As String = "0"
                Dim Site As String = "0"
                Dim ddlList As New DropDownList()
                Dim ddlPEActivity As New DropDownList()
                Dim ddlContActivity As New DropDownList()
                ddlPEActivity = TryCast(pnlFields1.FindControl("fld25663"), DropDownList)
                ddlContActivity = TryCast(pnlFields1.FindControl("fld25579"), DropDownList)
                ddlPEActivity.Items.Clear()
                ddlContActivity.Items.Clear()
                ddlList = TryCast(pnlFields1.FindControl("fld25274"), DropDownList)
                If Not (ddlList Is Nothing) Then
                    Act = ddlList.SelectedItem.Value()
                End If
                ddlList = TryCast(pnlFields1.FindControl("fld25675"), DropDownList)
                If Not (ddlList Is Nothing) Then
                    ActivityType = ddlList.SelectedItem.Value()
                End If
                ddlList = TryCast(pnlFields1.FindControl("fld25451"), DropDownList)
                If Not (ddlList Is Nothing) Then
                    Site = ddlList.SelectedItem.Value()
                End If
                If (Act <> "0" And ActivityType <> "SELECT" And Site <> 0) Then
                    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
                    Dim dsData As New DataSet()
                    Using con As New SqlConnection(conStr)
                        Using da As New SqlDataAdapter("getActvity", con)
                            da.SelectCommand.CommandType = CommandType.StoredProcedure
                            da.SelectCommand.Parameters.AddWithValue("@Site", Site)
                            da.SelectCommand.Parameters.AddWithValue("@ActToSite", Act)
                            da.SelectCommand.Parameters.AddWithValue("@ActivityType", ActivityType)
                            da.Fill(dsData)
                        End Using
                    End Using
                    If (ActivityType.Trim = "CONTRACTOR") Then
                        ddlContActivity.DataSource = dsData.Tables(0)
                        ddlContActivity.DataTextField = "fld112"
                        ddlContActivity.DataValueField = "tid"
                        ddlContActivity.DataBind()
                        ddlContActivity.Items.Insert(0, New ListItem("SELECT"))
                        ddlPEActivity.Items.Insert(0, New ListItem("SELECT"))
                        ddlPEActivity.DataBind()
                    ElseIf (ActivityType = "PE") Then
                        ddlPEActivity.DataSource = dsData.Tables(0)
                        ddlPEActivity.DataTextField = "fld112"
                        ddlPEActivity.DataValueField = "tid"
                        ddlPEActivity.DataBind()
                        ddlPEActivity.Items.Insert(0, New ListItem("SELECT"))
                        ddlContActivity.Items.Insert(0, New ListItem("SELECT"))
                        ddlContActivity.DataBind()
                    End If
                Else
                    ddlContActivity.Items.Insert(0, New ListItem("SELECT"))
                    ddlContActivity.DataBind()
                    ddlPEActivity.Items.Insert(0, New ListItem("SELECT"))
                    ddlPEActivity.DataBind()
                End If

            End If
        Catch ex As Exception
            Throw
        End Try


    End Sub

    Public Sub ExecuteControllevelRule(ctrlID As String, pnlP As Panel, pnlC As Panel, screenname As String, dtparent As DataTable, dtChild As DataTable, ErrorLbl As Label, Optional IsChildForm As Boolean = False)
        Dim RE As New RuleEngin()
        RE.ExecuteControllevelRule(ctrlID, pnlP, pnlC, screenname, dtparent, dtChild, ErrorLbl, IsChildForm, HttpContext.Current.CurrentHandler)
    End Sub

    Public Sub bindvalue1(ByVal sender As Object, ByVal e As EventArgs)
        Dim c As Control = GetPostBackControl(Me.Page)
        '...
        If c IsNot Nothing Then
        End If
        If TypeOf c Is System.Web.UI.WebControls.DropDownList Then
            Dim ddl As DropDownList = TryCast(c, DropDownList)
            Dim id As String = Right(ddl.ID, ddl.ID.Length - 3)
            Dim id1 As Integer = CInt(id)
            Dim ob As New DynamicForm()
            ob.bind(id, pnlFields1, ddl)
            ob.bindlookupddl(id, pnlFields, ddl)
            ob.bindMultiLookUP(id, pnlFields, ddl)
            ob.bindddlMultiLookUP(id, pnlFields, ddl)
            '''''Shalini
            GetFiles()
            'Code By Ajeet.Added on 21-January-2015 For Rule Engine Execution on control level
            Try
                Dim screenname = "N/A"
                Dim dtC As DataTable = CType(Session("CHILD"), DataTable)
                If (dtC.Rows.Count > 0) Then
                    screenname = dtC.Rows(0).Item("DocumentType")
                End If
                Dim dt As DataTable = Session("PFieldsData")
                ExecuteControllevelRule(id1, pnlFields, pnlFields1, screenname, dt, Session("CHILD"), lblTab1, True)
            Catch ex As Exception
                Throw
            End Try
        End If
        updpnlchild.Update()
    End Sub

    'Change By V 24 Dec
    Public Sub bindvalue2(ByVal sender As Object, ByVal e As EventArgs)
        Dim ddl As DropDownList = TryCast(sender, DropDownList)
        Session("DDL") = ddl
        Dim id As String = Right(ddl.ID, ddl.ID.Length - 3)
        Dim id1 As Integer = CInt(id)
        Dim ob As New DynamicForm()
        ob.bind(id, pnlFields, ddl)
        Call FilterILgrid(id)  '' new by sunil 31_july_14
        ob.bindMultiLookUP(id, pnlFields, ddl)
        ob.bindddlMultiLookUP(id, pnlFields, ddl)
        GetFiles()
        'Code By Ajeet.Added on 21-January-2015 For Rule Engine Execution on control level
        Try
            Dim screenname = Request.QueryString("SC").ToString
            Dim dt As DataTable = Session("PFieldsData")
            ExecuteControllevelRule(id1, pnlFields, Nothing, screenname, dt, Nothing, lblTab, False)
        Catch ex As Exception
            Throw
        End Try

    End Sub

    Public Sub FilterILgrid(ByVal ID As Integer)
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)

        If con.State <> ConnectionState.Open Then
            con.Open()
        End If
        'With(nolock) added by Himank on 29th sep 2015
        Dim da As SqlDataAdapter = New SqlDataAdapter("SELECT  documenttype,dropdown from MMM_MST_FIELDS  WITH(NOLOCK)  where fieldID=" & ID, con)
        Dim dsp As New DataSet
        da.Fill(dsp, "fields")
        Dim Dtype As String = dsp.Tables(0).Rows(0).Item("documenttype").ToString()
        'With(nolock) added by Himank on 29th sep 2015
        da.SelectCommand.CommandText = "SELECT fieldid from MMM_MST_FIELDS  WITH(NOLOCK)  where EID=" & Session("EID").ToString() & " and documenttype='" & Dtype & "' and fieldtype='Child Item' and len(isnull(kc_logic,''))>2"

        Dim dt As New DataTable
        da.Fill(dt)

        con.Close()
        con.Dispose()
        da.Dispose()
        If dt.Rows.Count <> 0 Then
            Call FilterChildGridDDL(dt.Rows(0).Item(0).ToString)
        End If
        dt.Dispose()
    End Sub

    Protected Sub FilterChildGridDDL(ByVal fldId As Integer)
        Dim c As Control = GetPostBackControl(Me.Page)
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)

        If con.State <> ConnectionState.Open Then
            con.Open()
        End If
        'With(nolock) added by Himank on 29th sep 2015
        Dim da As SqlDataAdapter = New SqlDataAdapter("SELECT  kc_logic,dropdown from MMM_MST_FIELDS  WITH(NOLOCK)  where fieldID=" & fldId, con)
        Dim dsp As New DataSet
        da.Fill(dsp, "fields")
        Dim tab As String = dsp.Tables(0).Rows(0).Item("dropdown").ToString()
        Dim kc As String = dsp.Tables(0).Rows(0).Item("kc_logic").ToString()
        Dim kcL() As String = dsp.Tables(0).Rows(0).Item("kc_logic").ToString().Split("-")

        'With(nolock) added by Himank on 29th sep 2015
        da = New SqlDataAdapter("SELECT  isEditable,isactive  from MMM_MST_FIELDS   WITH(NOLOCK) where EID=" & Session("EID").ToString() & " and fieldid=" & kcL(1).ToString & "", con)

        Dim dt As New DataTable
        da.Fill(dt)


        ' If Not DDLM Is Nothing Then
        Dim grd As GridView = CType(pnlFields.FindControl("GRD" & fldId.ToString), GridView)
        If Not grd Is Nothing Then
            ' For Each dr As DataRow In dt.Rows
            For Each gr As GridViewRow In grd.Rows
                If gr.RowIndex < grd.Rows.Count - 1 Then

                    Dim DDLM As DropDownList = DirectCast(pnlFields.FindControl("fld" & kcL(0).ToString), DropDownList)

                    If Not DDLM Is Nothing Then
                        Dim ddl1 As DropDownList = DirectCast(gr.FindControl("fld" & kcL(1).ToString & "_" & gr.RowIndex.ToString), DropDownList)
                        If Not ddl1 Is Nothing Then
                            ' cell = i
                            If IsNothing(ddl1) Then
                            Else
                                ddl1.Items.Clear()
                            End If

                            If dt.Rows(0).Item(0).ToString = "1" And dt.Rows(0).Item(1).ToString = "1" Then
                                '  ddl1.Items.Insert(0, "SELECT")  ' comment by sunil on 16_dec_14
                                ddl1.Enabled = True
                                '  ddl1.SelectedIndex = 0   ' comment by sunil on 16_dec_14
                                Dim li As ListItem = DDLM.SelectedItem
                                Dim tn As String = li.Text
                                Dim vl As String = li.Value
                                ddl1.Items.Add(tn)
                                ddl1.Items(0).Value = vl
                                '' here code to run lookup/filter if any by sunil 06 oct 14  - starts
                                ddl1.SelectedIndex = ddl1.Items.IndexOf(ddl1.Items.Item(0))

                                Dim id As String = Right(ddl1.ID, ddl1.ID.Length - 3)
                                Dim ar() As String = id.Split("_")
                                Dim id1 As Integer = CInt(ar(0))
                                BindGRidLookup(ar(1), id1, ddl1)
                                '' here code to run lookup/filter if any by sunil 06 oct 14  - ends
                            ElseIf dt.Rows(0).Item(0).ToString = "0" And dt.Rows(0).Item(1).ToString = "1" Then
                                Dim li As ListItem = DDLM.SelectedItem
                                Dim tn As String = li.Text
                                Dim vl As String = li.Value
                                ddl1.Items.Add(tn)
                                ddl1.Items(0).Value = vl
                                ddl1.Enabled = False
                                '' here code to run lookup/filter if any by sunil 06 oct 14  - starts
                                ddl1.SelectedIndex = ddl1.Items.IndexOf(ddl1.Items.Item(0))

                                Dim id As String = Right(ddl1.ID, ddl1.ID.Length - 3)
                                Dim ar() As String = id.Split("_")
                                Dim id1 As Integer = CInt(ar(0))
                                BindGRidLookup(ar(1), id1, ddl1)
                                '' here code to run lookup/filter if any by sunil 06 oct 14  - ends
                            Else
                            End If
                        End If
                    End If ' here
                End If
            Next
            updpnlchild.Update()
        End If
        ' End If

        con.Close()
        con.Dispose()
        da.Dispose()
        dt.Dispose()
        dsp.Dispose()
    End Sub

    Public Sub bind(ByVal id1 As Integer, ByRef pnlFields As Panel, ByRef ddl As DropDownList)
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If
        'With(nolock) added by Himank on 29th sep 2015
        Dim oda As SqlDataAdapter = New SqlDataAdapter("select LOOKUPVALUE,dropdown from MMM_MST_FIELDS   WITH(NOLOCK) WHERE FIELDID=" & id1 & "", con)
        Dim DS As New DataSet
        oda.Fill(DS, "data")
        Dim LOOKUPVALUE As String = DS.Tables("data").Rows(0).Item("lookupvalue").ToString()
        Dim documenttype() As String = DS.Tables("data").Rows(0).Item("dropdown").ToString.Split("-")
        If LOOKUPVALUE.Length > 0 Then
            Dim lookfld() As String = LOOKUPVALUE.ToString().Split(",")
            If lookfld.Length > 0 Then
                For iLookFld As Integer = 0 To lookfld.Length - 1
                    Dim fldPair() As String = lookfld(iLookFld).Split("-")
                    If fldPair.Length > 1 Then
                        oda = New SqlDataAdapter("SELECT * FROM MMM_MST_FIELDS WHERE FIELDID=" & fldPair(0) & "", con)
                        oda.Fill(DS, "FIELD")
                        Dim STR As String = ""
                        Dim DROPDOWN As String() = DS.Tables("FIELD").Rows(0).Item("DROPDOWN").ToString.Split("-")
                        Dim TABLENAME As String = ""
                        Dim TID As String = "TID"
                        If UCase(DROPDOWN(0).ToString()) = "MASTER" Then
                            TABLENAME = "MMM_MST_MASTER"
                        ElseIf UCase(DROPDOWN(0).ToString()) = "DOCUMENT" Then
                            TABLENAME = "MMM_MST_DOC"
                        ElseIf UCase(DROPDOWN(0).ToString()) = "STATIC" Then
                            TABLENAME = "MMM_MST_USER"
                            TID = "UID"
                        Else
                            TABLENAME = DS.Tables("FIELD").Rows(0).Item("DBTABLENAME").ToString
                        End If
                        Dim SLVALUE As String() = ddl.SelectedValue.Split("|")
                        If DS.Tables("FIELD").Rows(0).Item("fieldtype").ToString.ToUpper() = "DROP DOWN" Then
                            Dim AUTOFILTER As String = DS.Tables("FIELD").Rows(0).Item("AUTOFILTER").ToString()
                            'With(nolock) added by Himank on 29th sep 2015
                            If TABLENAME <> "MMM_MST_USER" Then
                                STR = "select " & DROPDOWN(2).ToString() & ",convert(nvarchar(10),tid) [tid] from " & TABLENAME & " P  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & DROPDOWN(1).ToString() & "' AND " & AUTOFILTER & "=" & SLVALUE(0) & "  "
                            Else
                                STR = "select " & DROPDOWN(2).ToString() & ",convert(nvarchar(10)," & TID & ")  [tid] from " & TABLENAME & " P  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " AND " & AUTOFILTER & "=" & SLVALUE(0) & " "
                            End If
                            oda.SelectCommand.CommandText = STR
                            oda.Fill(DS, "final")

                            Dim ddlo As DropDownList = TryCast(pnlFields.FindControl("fld" & fldPair(0).ToString()), DropDownList)
                            For i As Integer = 0 To DS.Tables("final").Rows.Count - 1
                                ddlo.Items.Add(DS.Tables("final").Rows(i).Item(0).ToString())
                                ddlo.Items(i).Value = DS.Tables("final").Rows(i).Item("tID")
                            Next
                        Else
                            oda = New SqlDataAdapter("", con)
                            oda.SelectCommand.CommandType = CommandType.StoredProcedure
                            oda.SelectCommand.Parameters.Clear()
                            oda.SelectCommand.CommandText = "uspGetMasterValue"
                            oda.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
                            oda.SelectCommand.Parameters.AddWithValue("documentType", documenttype(1))
                            oda.SelectCommand.Parameters.AddWithValue("Type", documenttype(0))
                            oda.SelectCommand.Parameters.AddWithValue("TID", ddl.SelectedValue)
                            oda.SelectCommand.Parameters.AddWithValue("FLDMAPPING", fldPair(1))
                            If con.State <> ConnectionState.Open Then
                                con.Open()
                            End If
                            Dim value As String = oda.SelectCommand.ExecuteScalar()
                            Dim TXTBOX As TextBox = TryCast(pnlFields.FindControl("fld" & fldPair(0).ToString()), TextBox)
                            TXTBOX.Text = value
                        End If
                    End If
                Next
            End If
        End If
        con.Dispose()
        oda.Dispose()
    End Sub
    Protected Sub ValidateData()
        Dim EID As Integer = 0
        EID = Convert.ToInt32(Session("Eid"))
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        'Tr
        Dim tran As SqlTransaction = Nothing
        Dim con As SqlConnection = New SqlConnection(conStr)
        con.Open()
        tran = con.BeginTransaction()
        Dim screenname As String = Request.QueryString("SC").ToString()
        Dim da As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF left outer JOIN MMM_MST_FORMS F on F.FormName = FF.DocumentType and F.EID = FF.EID where (FF.isactive=1 or Fieldtype='auto number' or fieldtype='New Auto Number') and F.EID=" & Session("EID").ToString() & " and FormName = '" & screenname & "' order by displayOrder", con)
        da.SelectCommand.Transaction = tran
        Dim ds As New DataSet
        da.Fill(ds, "fields")
        Dim ob As New DynamicForm
        Dim FinalQry As String
        Dim msgAN As String = ""
        Dim DocID As Integer = 0
        Dim childvalidation As String = ""
        ' here is the code for calculation inline grid 
        Dim childDt() As DataRow = ds.Tables("fields").Select("fieldtype='child item'")
        For K As Integer = 0 To childDt.Length - 1
            CalculateGRid(screenname, childDt(K).Item("fieldid").ToString())
        Next
        'Code for Advance formula execution Dated:18-Feb-2015 added By Ajeet Kumar
        'Code For Rule Engine By Ajeet Kumar Dated :30-july-2014
        Dim dv As DataView = ds.Tables("fields").DefaultView
        dv.RowFilter = "IsActive=1"
        Dim theFields As DataTable = dv.ToTable
        Dim lstData As New List(Of UserData)
        'Creating collection for rule engine execution
        Dim obj As New DynamicForm()
        lstData = obj.CreateCollection(pnlFields, theFields)
        'Setting it to session for getting it's value for child Item validation
        Session("pColl") = lstData
        'Creating object of rule response
        Dim AdvanceFormula() As DataRow = ds.Tables("fields").Select("Fieldtype='Advance Formula'")
        Dim ObjFormula As New FormulaEngine()
        Dim AdFormula As String = ""
        If AdvanceFormula.Length > 0 Then
            For Each AFField As DataRow In AdvanceFormula
                Dim FieldID = AFField.Item("FieldID")
                ObjFormula.EID = Session("EID")
                ObjFormula.FormulaFIeld = FieldID
                AdFormula = AFField.Item("Advance_formula")
                Dim val = ObjFormula.ExecuteFormula(AdFormula, Session("EID"), lstData, Nothing, False)
                Dim fField As New TextBox()
                fField = CType(pnlFields.FindControl("fld" & FieldID), TextBox)
                If (Not fField Is Nothing) Then
                    fField.Text = Convert.ToString(val)
                    lstData = obj.CreateCollection(pnlFields, theFields)
                End If
                'forvalue = formulaeditorr.ExecuteFormula(CField.Item("KC_LOGIC"), DocID, "v" + Session("eid").ToString + viewdoc, Session("eid").ToString, 0)
            Next
        End If
        'End here
        Try

            FinalQry = ob.ValidateAndGenrateQueryForControls("ADD", "INSERT INTO MMM_MST_DOC(EID,Documenttype,oUID,adate,", "VALUES (" & Session("EID").ToString() & ",'" & screenname & "'," & Session("UID").ToString() & ",getdate(),", ds.Tables("fields"), pnlFields, 0)
            If Trim(Left(FinalQry, 6)).ToUpper() = "PLEASE" Then
                lblTab.Text = FinalQry
            Else
                '' for checking the value of allowed size if file is valid or not 
                If IsDBNull(ds.Tables("fields").Rows(0).Item("AttahcedFileSize")) = True Or Val(ds.Tables("fields").Rows(0).Item("AttahcedFileSize").ToString()) = 0 Then
                Else
                    If Session("FileSize") > Val(Val(ds.Tables("fields").Rows(0).Item("AttahcedFileSize").ToString()) * 1024 * 1024) Then
                        lblTab.Text = "Please note your attachment cannot be uploaded as it exceeds prescribed limit. Please ensure that file size does not exceed '" & ds.Tables("fields").Rows(0).Item("attahcedfilesize").ToString() & "' MB and try again"
                        Session("FileSize") = Nothing
                        Exit Sub
                    End If
                End If

                'Code For Rule Engine By Ajeet Kumar Dated :30-july-2014
                'Creating object of rule response
                Dim ObjRet As New RuleResponse()
                Dim errorlist As New ArrayList

                Dim dtruleD As New DataTable

                '' new for duplicacy check rule - enhancement
                Dim Ruleduplicacy As New RuleEngin(Session("EID"), screenname, "CREATED", "DUPLICACY")
                Dim DSDuplicacyRule As DataSet = Ruleduplicacy.GetRules()
                dtruleD = DSDuplicacyRule.Tables(1)
                For Each dr As DataRow In DSDuplicacyRule.Tables(0).Rows
                    ObjRet = Ruleduplicacy.ExecuteRule(lstData, Nothing, False, screenname, dr, dtruleD)
                    If ObjRet.Success = False Then
                        errorlist.Add(Convert.ToString(ObjRet.ErrorMessage))
                    End If
                Next
                If errorlist.Count > 0 Then
                    lblTab.Text = String.Join("<br/>", errorlist.ToArray())
                    lblTab.ForeColor = Color.Red
                    Exit Sub
                End If
                '' new for duplicacy check rule - enhancement

                'Initialising rule Object
                Dim ObjRule As New RuleEngin(Session("EID"), screenname, "CREATED", "SUBMIT")
                'Uncomment
                Dim dsrule As DataSet = ObjRule.GetRules()
                Dim dtrule As New DataTable
                dtrule = dsrule.Tables(1)


                For Each dr As DataRow In dsrule.Tables(0).Rows
                    If dr("ruledesc").ToString().Contains("TNE") Then
                        ObjRet = ObjRule.ExecuteRuleTNE(lstData, Nothing, False, screenname, dr, dtrule)
                    Else
                        ObjRet = ObjRule.ExecuteRule(lstData, Nothing, False, screenname, dr, dtrule)
                    End If
                    'ObjRet = ObjRule.ExecuteRule(lstData, Nothing, False, screenname, dr, dtrule)
                    If ObjRet.Success = False Then
                        errorlist.Add(Convert.ToString(ObjRet.ErrorMessage))
                    End If
                Next
                If errorlist.Count > 0 Then
                    lblTab.Text = String.Join("<br/>", errorlist.ToArray())
                    lblTab.ForeColor = Color.Red
                    Exit Sub
                End If

                'For Each dr As DataRow In dsrule.Tables(0).Rows
                '    ObjRet = ObjRule.ExecuteRule(lstData, Nothing, False, screenname, dr, dtrule)
                '    If ObjRet.Success = False Then
                '        lblTab.Text = ObjRet.ErrorMessage
                '        Exit Sub
                '    End If
                'Next


                'validation for child item inline item 
                Dim validatechilditem() As DataRow = ds.Tables("fields").Select("Fieldtype='CHILD ITEM'")
                If validatechilditem.Length > 0 Then
                    For Each DR As DataRow In validatechilditem
                        '' new added for saving differently if def. value feature is on
                        Dim strDF As String = "select * from mmm_mst_forms where formname='" & DR.Item("DROPDOWN") & "' and formsource='DETAIL FORM' and EID=" & Session("EID") & " and (isnull(HasDefaultValue,0)=1  or isnull(isinlineediting,0)=1 or isnull(IsDefaultRows,0)>0)"
                        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
                        Dim dtIsdv As New DataTable
                        oda.SelectCommand.CommandText = strDF
                        oda.SelectCommand.Transaction = tran
                        oda.Fill(dtIsdv)
                        If dtIsdv.Rows.Count > 0 Then
                            childvalidation = ValidatingChildItem_DV(DR.Item("DROPDOWN"))
                        End If
                        If childvalidation.Length > 5 Then
                            lblTab.Text = childvalidation
                            Exit Sub
                        End If
                    Next
                End If
                'chidvalidation = ValidatingChildItem_DV(DR.Item("DROPDOWN"), fileid)
                FinalQry = FinalQry & ";Select @@identity"
                'save the data
                lblTab.Text = ""
                da.SelectCommand.CommandText = FinalQry
                Dim fileid As Integer = da.SelectCommand.ExecuteScalar()
                DocID = fileid
                Session("docid") = fileid
                If Not Request.QueryString("TID") Is Nothing Then
                    If fileid > 0 Then
                        da.SelectCommand.CommandText = "Delete from mmm_mst_doc_draft where tid= " & Request.QueryString("TID") & ""

                        da.SelectCommand.ExecuteNonQuery()

                    End If
                End If
                '' change from here by sunil for new auto number 03_Aug_14
                Dim row As DataRow() = ds.Tables("fields").Select("Fieldtype='Auto Number' or Fieldtype='New Auto Number'")
                If row.Length > 0 Then
                    For I As Integer = 0 To row.Length - 1
                        Select Case row(I).Item("fieldtype").ToString
                            Case "Auto Number"
                                da.SelectCommand.Parameters.Clear()
                                da.SelectCommand.Transaction = tran
                                da.SelectCommand.CommandText = "usp_GetAutoNoNew"
                                da.SelectCommand.CommandType = CommandType.StoredProcedure
                                da.SelectCommand.Parameters.AddWithValue("Fldid", row(I).Item("fieldid"))
                                da.SelectCommand.Parameters.AddWithValue("docid", fileid)
                                da.SelectCommand.Parameters.AddWithValue("fldmapping", row(I).Item("fieldmapping"))
                                da.SelectCommand.Parameters.AddWithValue("FormType", "Document")
                                Dim an As String = da.SelectCommand.ExecuteScalar()
                                msgAN = "<br/> " & row(I).Item("displayname") & " is " & an & ""
                                da.SelectCommand.Parameters.Clear()
                            Case "New Auto Number"
                                da.SelectCommand.Parameters.Clear()
                                da.SelectCommand.CommandText = "usp_GetAutoNoNew_New"
                                da.SelectCommand.CommandType = CommandType.StoredProcedure
                                da.SelectCommand.Parameters.AddWithValue("Fldid", row(I).Item("fieldid"))
                                da.SelectCommand.Parameters.AddWithValue("SearchFldid", row(I).Item("dropdown").ToString)
                                da.SelectCommand.Parameters.AddWithValue("docid", fileid)
                                da.SelectCommand.Parameters.AddWithValue("fldmapping", row(I).Item("fieldmapping"))
                                da.SelectCommand.Parameters.AddWithValue("FormType", "Document")
                                Dim an As String = da.SelectCommand.ExecuteScalar()
                                msgAN = "<br/> " & row(I).Item("displayname") & " is " & an & ""
                                da.SelectCommand.Parameters.Clear()
                        End Select
                    Next
                End If


                Dim df As New DynamicForm()
                '' new for checking priority field and setting doc's static field to 1 if found - by sunil on 28_apr_14
                Call df.ChecknUpdatePriorityFieldvaluesT(DocID, con, tran)

                '' change from here by sunil for new auto number 03_Aug_14

                Dim childitem() As DataRow = ds.Tables("fields").Select("Fieldtype='CHILD ITEM'")
                If childitem.Length > 0 Then

                    For Each DR As DataRow In childitem
                        '' new added for saving differently if def. value feature is on
                        '' by sunil for def value 13-jan-14 - starts
                        'aaaa
                        Dim strDF As String = "select * from mmm_mst_forms where formname='" & DR.Item("DROPDOWN") & "' and formsource='DETAIL FORM' and EID=" & Session("EID") & " and (isnull(HasDefaultValue,0)=1 or isnull(isinlineediting,0)=1 or isnull(IsDefaultRows,0)>0)"
                        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
                        Dim dtIsdv As New DataTable
                        oda.SelectCommand.CommandText = strDF
                        oda.SelectCommand.Transaction = tran
                        oda.Fill(dtIsdv)
                        If dtIsdv.Rows.Count = 0 Then
                            'If Not Request.QueryString("TID") Is Nothing Then
                            '    oda.SelectCommand.CommandText = "InsertDocItemFromDraftItem"
                            '    oda.SelectCommand.CommandType = CommandType.StoredProcedure
                            '    oda.SelectCommand.Parameters.AddWithValue("@eid", Session("EID"))
                            '    oda.SelectCommand.Parameters.AddWithValue("@docid", Session("docid"))
                            '    oda.SelectCommand.Parameters.AddWithValue("@draftid", Request.QueryString("TID").ToString())
                            '    oda.SelectCommand.Transaction = tran
                            '    oda.SelectCommand.ExecuteNonQuery()
                            'Else
                            '    SavingChildItem(DR.Item("DROPDOWN"), fileid, con, tran)
                            'End If
                            SavingChildItem(DR.Item("DROPDOWN"), fileid, con, tran)
                        Else
                            SavingChildItem_DV(DR.Item("DROPDOWN"), fileid, con, tran)
                        End If
                        'here for checking and updating parent value field in child items. ' 22_apr_15
                        Try
                            Call ChecknUpdateParentValueFields(DR.Item("DROPDOWN"), fileid, Session("EID"), con, tran)
                        Catch ex As Exception
                            Throw
                        End Try
                        Try
                            Dim FormName As String = DR.Item("DROPDOWN")

                            EID = Convert.ToInt32(Session("EID"))
                            If (fileid > 0) And (FormName <> "") Then
                                'Last parameter is for child item
                                Trigger.ExecuteTriggerT(FormName, EID, fileid, con, tran, 1)
                            End If
                        Catch ex As Exception
                            Throw
                        End Try
                    Next
                End If

                ' here is recalculate for bith child item and main form   28 april
                Call Recalculate_CalfieldsonSave(DocID, con, tran) 'fOR cALCULATIV fIELD   ' changes by balli  brings from above to down 

                Dim ob1 As New DMSUtil()
                Dim CalculativeField() As DataRow = ds.Tables("fields").Select("Fieldtype='Formula Field'")
                Dim viewdoc As String = screenname
                viewdoc = viewdoc.Replace(" ", "_")
                If CalculativeField.Length > 0 Then
                    For Each CField As DataRow In CalculativeField
                        Dim formulaeditorr As New formulaEditor
                        Dim forvalue As String = String.Empty
                        'Coomented By Komal on 28March2014
                        forvalue = formulaeditorr.ExecuteFormulaT(CField.Item("KC_LOGIC"), DocID, "v" + Session("eid").ToString + viewdoc, Session("eid").ToString, 0, con, tran)
                        'forvalue = formulaeditorr.ExecuteFormula(CField.Item("KC_LOGIC"), DocID, "v" + Session("eid").ToString + viewdoc, Session("eid").ToString, 0)
                        Dim upquery As String = "update " & CField.Item("DBTableName").ToString & "  set  " & CField.Item("FieldMapping").ToString & "='" & forvalue.ToString & "'  where tid =" & DocID & ""
                        da.SelectCommand.CommandText = upquery
                        da.SelectCommand.CommandType = CommandType.Text
                        da.SelectCommand.ExecuteNonQuery()
                    Next
                End If


                ''### Hardcoding for HCL Vendor portal ###
                ''### for copying retainer company field value to company field for retainer invoices case ' GetHCLVendorPortalApprovers
                If (screenname.ToUpper = "VENDOR INVOICE VP" And (EID = 46 Or EID = 124)) Then
                    'HCL_VP_CompCodeCopy(DocID, EID)
                    Dim odC As SqlDataAdapter = New SqlDataAdapter("", con)
                    odC.SelectCommand.Transaction = tran
                    Dim r As Integer
                    Try
                        odC.SelectCommand.Parameters.Clear()
                        odC.SelectCommand.CommandType = CommandType.StoredProcedure
                        If EID = 124 Then
                            odC.SelectCommand.CommandText = "GetDemoAPVendorPortalApprovers"
                        Else
                            odC.SelectCommand.CommandText = "GetHCLVendorPortalApprovers"
                        End If
                        odC.SelectCommand.Parameters.AddWithValue("@DOCID", DocID)
                        odC.SelectCommand.Parameters.AddWithValue("@EID", EID)
                        r = (Convert.ToInt32(odC.SelectCommand.ExecuteScalar()))
                        If r <= 0 Then
                            ' Throw New Exception("Error in HCL custom WF function execution.")
                            tran.Rollback()
                            lblTab.Text = "Temporarily Unable to create Invoice, please Try Again Later!"
                            Exit Sub
                        End If
                    Catch ex As Exception
                        tran.Rollback()
                        lblTab.Text = "Temporarily Unable to create Invoice, please Try Again Later!"
                        Exit Sub
                    End Try
                End If
                ''### Hardcoding for HCL Vendor portal ###

                '' starts - new by sp on 07th Nov 14 for Period wise balances
                ' Dim Rel As New Relation()
                Dim PWBres As String = ""
                PWBres = CheckUpdatePeriodwiseBalTrans(Session("eid").ToString, screenname, fileid, con, tran)
                '' ends - new by sp on 07th Nov 14 for Period wise balances

                '' insert default fiest movement of document - by sunil
                da.SelectCommand.CommandText = "InsertDefaultMovement"
                da.SelectCommand.CommandType = CommandType.StoredProcedure
                da.SelectCommand.Parameters.Clear()
                da.SelectCommand.Parameters.AddWithValue("tid", fileid)
                da.SelectCommand.Parameters.AddWithValue("CUID", Val(Session("UID").ToString()))
                da.SelectCommand.Parameters.AddWithValue("what", "UPLOADED")
                da.SelectCommand.ExecuteNonQuery()
                '' here code to approve document  - by sunil

                'Comman Code
                Dim res As String
                Dim objDC As New DataClass
                Dim objDTName As New DataTable
                'Comman Code


                objDTName = objDC.ExecuteQryDT("select RolematrixfromOrganization,Ticket_Assign_Method,AdminRole,AgentRole,Userrole from mmm_hdmail_schdule where eid=" & Session("EID") & "and documenttype='" & screenname & "'")
                If objDTName.Rows.Count > 0 Then
                    If objDTName.Rows(0)(0).ToString().ToUpper = "TRUE" Then

                        Dim tc As New TicketScheduler
                        'changes for Role ,You must assure role should be comming from configuration database

                        If ("," & Session("USERROLE").ToString().ToUpper & ",").ToString().Contains("," & Convert.ToString(objDTName.Rows(0)("AgentRole")).ToUpper() & ",") Then
                            Dim ddl As New DropDownList
                            ddl = CType(pnlFields.FindControl("fld" & objDC.ExecuteQryScaller("select fieldid from mmm_mst_fields where documenttype='" & screenname & "' and  dropdown='STATIC-USER-UserName' and eid=" & Session("EID") & "")), DropDownList)
                            Dim EmailID As String = objDC.ExecuteQryScaller("select emailid from mmm_mst_user where uid=" & ddl.SelectedValue)
                            Dim ddlSubCategory As New DropDownList
                            ddlSubCategory = CType(pnlFields.FindControl("fld" & objDC.ExecuteQryScaller("select fieldid from mmm_mst_fields where documenttype='" & screenname & "' and parsefromemail=1 and eid=" & Session("EID") & "")), DropDownList)
                            If Not IsNothing(ddl) Then
                                res = tc.GetNextUserFromOrganizatios(EmailID, Session("EID"), Convert.ToString(objDTName.Rows(0)("AdminRole")), ddlSubCategory.SelectedValue)
                                tc.AssignTicketToUserBasedOnCondition(res, fileid, "", Val(ddl.SelectedValue), con, tran, Session("EID"), objDTName.Rows(0)(0), objDTName.Rows(0)(1), screenname, "CREATE")
                                objDC.TranExecuteQryDT("Update mmm_mst_doc set " & objDC.ExecuteQryScaller("select fieldmapping from mmm_mst_fields where documenttype='Ticket' and eid=" & Session("EID") & " and mdfieldname='EmailID'") & "='" & EmailID & "'," & objDC.ExecuteQryScaller("select fieldmapping from mmm_mst_fields where documenttype='Ticket' and eid=" & Session("EID") & " and mdfieldname='Name'") & "='" & ddl.SelectedValue & "',  ouid=" & ddl.SelectedValue & " where tid=" & fileid, con, tran)
                            Else
                                res = tc.GetNextUserFromOrganizatios(EmailID, Session("EID"), Session("USERROLE"))
                                tc.AssignTicketToUserBasedOnCondition(res, fileid, "", Val(Session("UID").ToString()), con, tran, Session("EID"), objDTName.Rows(0)(0), objDTName.Rows(0)(1), screenname, "CREATE")
                            End If
                        Else
                            Dim txtBox As New TextBox
                            txtBox = CType(pnlFields.FindControl("fld" & objDC.ExecuteQryScaller("select fieldid from mmm_mst_fields where documenttype='" & screenname & "' and MDfieldName='Emailid' and eid=" & Session("EID") & "")), TextBox)
                            Dim ddl As New DropDownList
                            ddl = CType(pnlFields.FindControl("fld" & objDC.ExecuteQryScaller("select fieldid from mmm_mst_fields where documenttype='" & screenname & "' and parsefromemail=1 and eid=" & Session("EID") & "")), DropDownList)

                            If Not IsNothing(ddl) Then
                                res = tc.GetNextUserFromOrganizatios(txtBox.Text, Session("EID"), Convert.ToString(objDTName.Rows(0)("AdminRole")), ddl.SelectedValue)
                                tc.AssignTicketToUserBasedOnCondition(res, fileid, "", Val(Session("UID").ToString()), con, tran, Session("EID"), objDTName.Rows(0)(0), objDTName.Rows(0)(1), screenname, "CREATE")
                            Else
                                res = tc.GetNextUserFromOrganizatios(txtBox.Text, Session("EID"), Session("USERROLE"))
                                tc.AssignTicketToUserBasedOnCondition(res, fileid, "", Val(Session("UID").ToString()), con, tran, Session("EID"), objDTName.Rows(0)(0), objDTName.Rows(0)(1), screenname, "CREATE")
                            End If
                        End If
                    Else
                        res = ob1.GetNextUserFromRolematrixT(fileid, Val(Session("EID").ToString()), Val(Session("UID").ToString()), "", Val(Session("UID").ToString()), con, tran)
                    End If
                Else
                    res = ob1.GetNextUserFromRolematrixT(fileid, Val(Session("EID").ToString()), Val(Session("UID").ToString()), "", Val(Session("UID").ToString()), con, tran)
                End If

                'res = ob1.GetNextUserFromRolematrixT(fileid, Val(Session("EID").ToString()), Val(Session("UID").ToString()), "", Val(Session("UID").ToString()), con, tran)
                '' here code to approve document  - by sunil
                Dim sretMsgArr() As String = res.Split(":")
                'Code is commented by Ajeet Kumar becouse it will no longer be used Dated:20 August 2014
                'If ds.Tables("fields").Rows(0).Item("iscalendar").ToString = "1" And Session("dtnew") <> Nothing Then
                '    ADDTASK(fileid, screenname)
                'End If
                ob.CLEARDYNAMICFIELDS(pnlFields)
                ''INSERT INTO HISTORY 
                ob.HistoryT(Session("EID"), fileid, Session("UID"), screenname, "MMM_MST_DOC", "ADD", con, tran)
                '' new added for pusing data to master on docuement creation by sp 21-Jan-14
                If sretMsgArr(0) = "ARCHIVE" Then
                    Dim Op As New Exportdata()
                    Op.PushdataT(fileid, sretMsgArr(1), Session("EID"), con, tran)
                End If

                '''' check if no skip setting and if not allowed then don't move doc and show msg to user by sunil on 07-Oct
                If sretMsgArr(0).ToUpper() = "NO SKIP" Then
                    Dim Noskipmsg As String = "Next Approvar/User not found, please contact Admin"
                    'lblMsg.Text = "System Docid is " & fileid & " " & msgAN & "" & "<br/> " & Noskipmsg
                    'this code block is added by ajeet kumar for transaction to be rolled back
                    tran.Rollback()
                    lblTab.Text = Noskipmsg
                    Exit Sub
                Else
                    If screenname.Trim.ToUpper = "VENDOR INVOICE VP" And Session("EID") = "46" Then
                        lblMsg.Text = "System DOC ID is " & fileid & " (For HCL Internal use) " & msgAN & " (For Vendors)"
                    Else
                        lblMsg.Text = "System DOC ID is " & fileid & " " & msgAN & ""
                    End If

                End If
                ViewState("viewdocid") = fileid
                Try
                    Dim FormName As String = screenname
                    '     Dim EID As Integer = 0
                    EID = Convert.ToInt32(Session("EID"))
                    If (DocID > 0) And (FormName <> "") Then
                        Trigger.ExecuteTriggerT(FormName, EID, DocID, con, tran)
                    End If
                Catch ex As Exception
                    Throw
                End Try
                'Commiting transaction 
                'Code Added By Ajeet For Period Wise Balance Date:04-Feb-2015
                Try
                    Dim objRel As New Relation()
                    objRel.ExecutePeriodWiseBalance(EID, DocID, screenname, con, tran)
                Catch ex As Exception

                End Try
                'Again Commit Commiting transaction
                'tran.Rollback()
                tran.Commit()

                'Code For Updating Geo Point. By Ajeet Kumar.Date:24-Feb-2015
                Try
                    GisMethods.ExecuteReverseGeoCoding(EID, fileid, screenname)

                    'trans.Commit()
                Catch ex As Exception

                End Try
                ' below code used for calling webservice...

                '' code to send mail to first approver on document creation and to document owner also
                '' new added by sunil for mail sending 
                'Non transactional Query
                ob1.TemplateCalling(fileid, Session("EID"), screenname, "CREATED")
                da.SelectCommand.CommandType = CommandType.Text
                da.SelectCommand.Parameters.Clear()
                da.SelectCommand.CommandText = "select isworkflow from mmm_mst_doc where TID=" & fileid & " and eid='" & Session("EID") & "'"
                Dim dt As New DataTable
                da.Fill(dt)
                If dt.Rows.Count = 1 Then
                    If dt.Rows(0).Item(0).ToString = "1" Then
                        ob1.TemplateCalling(fileid, Session("EID"), screenname, "APPROVE")
                    End If
                End If

                Try
                    If ds.Tables("fields").Rows(0).Item("enablews").ToString = "1" Then
                        'Dim ws As New WSOutward()
                        'Dim URLIST As String = ws.WBS(screenname, Session("EID"), DocID)
                        'lblMsg.Text = lblMsg.Text & Environment.NewLine & URLIST.ToString()
                    End If
                Catch ex As Exception
                End Try
                'Code For Schedule document. By Ajeet Kumar.Date:04-June-2015
                Try
                    Dim objS As New ScheduleDocument(EID, screenname, "save")
                    objS.CreateDynamicDocument(fileid)
                Catch ex As Exception

                End Try

                ''### Hardcoding for HCL Vendor portal ###
                Try
                    Dim Result As String = ""
                    If (screenname.ToUpper = "VENDOR CREATION" And EID = 46) Then
                        Result = HCLVNEDORTOREFROLE(DocID, EID)
                    End If
                Catch ex As Exception
                End Try
                ''### Hardcoding for HCL Vendor portal ###

                Try
                    Dim objRel As New Relation()
                    Dim CreatedDocType As String, UID As Integer
                    EID = Convert.ToUInt32(Session("EID"))
                    UID = Convert.ToUInt32(Session("UID"))
                    Dim objRes As New RelationResponse()
                    CreatedDocType = screenname
                    DocID = fileid
                    objRes = objRel.ExtendRelation(EID, CreatedDocType, DocID, UID, "", False)
                    'In case of costom rule Creation

                    'Added By mayank in case of variation configuration 20-Feb-2015
                    Dim dtvarn As New DataTable

                    'Resolve after query 
                    'Dim conStrng As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
                    'Dim con1 As SqlConnection = New SqlConnection(conStr)
                    Dim dtvar As New DataTable
                    Dim qry As String
                    qry = "select fieldmapping,dropdown from mmm_mst_fields where eid=" & Session("EID") & " and documenttype='" & CreatedDocType & "' and fieldType='Variance'"
                    Dim da1 As SqlDataAdapter = New SqlDataAdapter("", con)
                    da1.SelectCommand.Transaction = tran
                    da1.SelectCommand.CommandText = qry
                    da1.SelectCommand.ExecuteNonQuery()
                    da1.Fill(dtvar)
                    Dim li As New ArrayList
                    Dim liupdate As New ArrayList
                    If (dtvar.Rows.Count > 0) Then
                        For i As Integer = 0 To dtvar.Rows.Count - 1
                            li.Add(dtvar.Rows(i).Item("dropdown").ToString())
                            liupdate.Add(dtvar.Rows(i).Item("fieldmapping").ToString())
                        Next
                        'Dim i As Integer = 0
                        'Do While (i - dtvar.Rows.Count - 1)
                        '    li.Add(dtvar.Rows(i).Item("dropdown").ToString())
                        '    i = (i + 1)
                        'Loop
                        Dim finalstr = String.Join(",", li.ToArray())
                        Dim finalUpdate = String.Join(",", liupdate.ToArray())

                        Dim ODAs As SqlDataAdapter = New SqlDataAdapter("", con)
                        'Dim scrname As String = Request.QueryString("SC").ToString()

                        Dim DSvar As New DataSet
                        ODAs.SelectCommand.Parameters.Clear()
                        ODAs.SelectCommand.Transaction = tran
                        ODAs.SelectCommand.CommandText = "uspGetHistoryDetails"
                        ODAs.SelectCommand.CommandType = CommandType.StoredProcedure
                        ODAs.SelectCommand.Parameters.AddWithValue("eid", Session("EID"))
                        ODAs.SelectCommand.Parameters.AddWithValue("docid", Session("docid"))
                        ODAs.SelectCommand.Parameters.AddWithValue("ParString", finalstr.ToString())
                        DSvar.Tables().Clear()
                        ODAs.Fill(DSvar, "variance")
                        Dim str As New StringBuilder()
                        str.Append("Update mmm_mst_doc set ")
                        If (DSvar.Tables("variance2").Rows(0)(0).ToString() = "1") Then
                            For Val As Integer = 0 To li.Count - 1
                                str.Append(liupdate(Val).ToString() & "='" & DSvar.Tables("variance1").Rows(0)(Val).ToString() & "',")
                            Next
                            str.Remove(str.Length - 1, 1)
                            str.Append("where tid=" & Session("docid") & " and eid=" & Session("EID") & "")
                        Else
                            For Val As Integer = 0 To li.Count - 1
                                Dim d As Decimal
                                d = Convert.ToDecimal(DSvar.Tables("variance1").Rows(0)(Val)) - Convert.ToDecimal(DSvar.Tables("variance").Rows(0)(Val))
                                str.Append(liupdate(Val).ToString() & "='" & d.ToString() & "',")
                            Next
                            str.Remove(str.Length - 1, 1)
                            str.Append("where tid=" & Session("docid") & " and eid=" & Session("EID") & "")
                        End If

                        Dim updateqry As String
                        updateqry = str.ToString()
                        Dim dts As New DataTable
                        Dim da2 As SqlDataAdapter = New SqlDataAdapter("", con)
                        da2.SelectCommand.Transaction = tran
                        da2.SelectCommand.CommandText = updateqry
                        da2.Fill(dts)
                    End If

                    'Added By mayank in case of variation configuration  20-Feb-2015

                    If objRes.Success = True And objRes.ShowExtend = True Then
                        Response.Redirect("ExtendRelation.aspx?DOCID=" & DocID & "&SC=" & CreatedDocType)
                    End If

                Catch ex As Exception
                End Try
                updMsg.Update()
                btnForm_ModalPopupExtender.Show()
            End If
        Catch ex As Exception
            If Not tran Is Nothing Then
                tran.Rollback()
            End If
            Throw
        Finally
            If Not da Is Nothing Then
                da.Dispose()
            End If
            If Not con Is Nothing Then
                con.Dispose()
                con.Close()
            End If
        End Try
    End Sub

    Public Function HCL_VP_CompCodeCopy(ByVal docid As Integer, ByVal EID As Integer) As String
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim da1 As SqlDataAdapter = New SqlDataAdapter("", con)
        Dim dt As New DataTable
        Try
            da1.SelectCommand.Parameters.Clear()
            da1.SelectCommand.CommandType = CommandType.Text
            da1.SelectCommand.CommandText = "update mmm_mst_doc set fld14=fld191 where eid=" & EID & " and tid=" & docid & " and fld96='1078985'"
            da1.SelectCommand.ExecuteNonQuery()
            HCL_VP_CompCodeCopy = ""
        Catch ex As Exception
        Finally
            con.Close()
            con.Dispose()
            da1.Dispose()
            dt = Nothing
        End Try
    End Function

    Public Function HCLVNEDORTOREFROLE(ByVal docid As Integer, ByVal EID As Integer) As String
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim da1 As SqlDataAdapter = New SqlDataAdapter("", con)
        Dim dt As New DataTable
        Try
            da1.SelectCommand.Parameters.Clear()
            da1.SelectCommand.CommandType = CommandType.StoredProcedure
            da1.SelectCommand.CommandText = "TestVendor"
            da1.SelectCommand.Parameters.AddWithValue("DOCID", docid)
            da1.SelectCommand.Parameters.AddWithValue("EID", EID)
            da1.Fill(dt)
        Catch ex As Exception

        Finally
            con.Close()
            con.Dispose()
            da1.Dispose()
            dt = Nothing
        End Try
    End Function


    Public Sub ChecknUpdateParentValueFields(ByVal document As String, ByVal docid As String, ByVal eid As String, ByVal con As SqlConnection, ByVal tran As SqlTransaction)
        Try
            Dim dtdocumnt As New DataTable
            Dim qry As String
            qry = "select dbtablename,fieldmapping,dropdown from mmm_mst_fields where Documenttype ='" & document & "' and eid=" & eid & " and fieldtype='Parent Value' and isactive=1"
            Dim da1 As SqlDataAdapter = New SqlDataAdapter(qry, con)
            da1.SelectCommand.Transaction = tran
            da1.Fill(dtdocumnt)
            If (dtdocumnt.Rows.Count > 0) Then
                For i As Integer = 0 To dtdocumnt.Rows.Count - 1
                    UpdateParentValue(document, dtdocumnt.Rows(i)("dbtablename").ToString(), dtdocumnt.Rows(i)("fieldmapping").ToString(), dtdocumnt.Rows(i)("dropdown").ToString(), docid, eid, con, tran)
                Next
            End If
        Catch ex As Exception
            Throw
        End Try
    End Sub


    Public Sub UpdateParentValue(ByVal DType As String, ByVal tablebname As String, ByVal fieldmapping As String, ByVal dropdown As Integer, ByVal docid As String, ByVal eid As String, ByVal con As SqlConnection, ByVal tran As SqlTransaction)
        Dim dtdocumntval As New DataSet
        If con.State = ConnectionState.Closed Then
            con.Open()
        End If
        Dim da As New SqlDataAdapter("", con)
        Try
            da.SelectCommand.Transaction = tran
            da.SelectCommand.CommandType = CommandType.StoredProcedure
            da.SelectCommand.CommandText = "sp_ParentValueExecutionSave"
            da.SelectCommand.Parameters.AddWithValue("@ufld", fieldmapping)
            da.SelectCommand.Parameters.AddWithValue("@eid", eid)
            da.SelectCommand.Parameters.AddWithValue("@fldid", dropdown)
            da.SelectCommand.Parameters.AddWithValue("@docid", docid)
            da.SelectCommand.Parameters.AddWithValue("@Dtype", DType)
            da.Fill(dtdocumntval, "doc")
        Catch ex As Exception
            Throw
        End Try
    End Sub


    Private Function ReturnMonthName(ByVal mnum As Integer) As String
        Dim mChar As String = ""
        Select Case mnum
            Case 1
                mChar = "Jan"
            Case 2
                mChar = "Feb"
            Case 3
                mChar = "Mar"
            Case 4
                mChar = "Apr"
            Case 5
                mChar = "May"
            Case 6
                mChar = "Jun"
            Case 7
                mChar = "Jul"
            Case 8
                mChar = "Aug"
            Case 9
                mChar = "Sep"
            Case 10
                mChar = "Oct"
            Case 11
                mChar = "Nov"
            Case 12
                mChar = "Dec"
        End Select
        ReturnMonthName = mChar
    End Function


    Public Function CheckUpdatePeriodwiseBalTrans(ByVal eid As Integer, ByVal DOCType As String, ByVal DocID As Integer, ByVal con As SqlConnection, ByVal tran As SqlTransaction) As String

        Dim da As SqlDataAdapter = New SqlDataAdapter("", con)
        Try
            da.SelectCommand.Transaction = tran
            Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
            Dim con1 As SqlConnection = New SqlConnection(conStr)
            Dim da1 As SqlDataAdapter = New SqlDataAdapter("Select formid,Balance_Maintenance_Mode,Effective_Date_Field,Balance_Field,Item_number from mmm_mst_forms where eid=" & eid & " and formname='" & DOCType & "' and len(isnull(Balance_Maintenance_Mode,''))>1 and  len(isnull(Effective_Date_Field,''))>1  and  len(isnull(Balance_Field,''))>1", con1)

            Dim ds As New DataSet
            Dim dt As New DataTable
            da1.Fill(dt)

            Dim Fldstr As String = ""
            If dt.Rows.Count <> 0 Then
                Fldstr = dt.Rows(0).Item("Effective_Date_Field").ToString & " [Effective_Date_Field],"
                Fldstr += dt.Rows(0).Item("Balance_Field").ToString & "[Balance_Field],"
                Fldstr += dt.Rows(0).Item("Item_number").ToString & "[Item_number]"

                da.SelectCommand.CommandText = "select " & Fldstr & " from mmm_mst_doc where tid=" & DocID & " and eid=" & eid

                Dim dtDoc As New DataTable
                da.Fill(dtDoc)

                Dim EffDt As String = dtDoc.Rows(0).Item("Effective_Date_Field").ToString
                Dim balFldval As String = dtDoc.Rows(0).Item("Balance_Field").ToString
                Dim itemNumval As String = dtDoc.Rows(0).Item("Item_number").ToString

                EffDt = EffDt.Replace("/", "-")
                Dim effdtArr As String() = EffDt.Split("-")

                Dim NewDt As String = effdtArr(0).ToString & "-" & ReturnMonthName(effdtArr(1).ToString) & "-" & effdtArr(2).ToString
                Dim insStr As String = ""

                ' Dim EffDt_Date As Date
                insStr = "insert into mmm_ssv_trans (docid,effdt,transdate,quantity,item_number,createdon) values ( '" & DocID & "','" & dtDoc.Rows(0).Item("Effective_Date_Field").ToString & "','" & NewDt & "','" & balFldval & "','" & itemNumval & "',getdate())"
                da.SelectCommand.CommandText = insStr
                'da.SelectCommand.Transaction = tran
                Dim res As String = da.SelectCommand.ExecuteNonQuery().ToString

                If res = "0" Then
                    con1.Close()
                    con1.Dispose()
                    da.Dispose()
                    da1.Dispose()
                    Return "fail"
                Else
                    con1.Close()
                    con1.Dispose()
                    da.Dispose()
                    da1.Dispose()
                    Return "fail"
                    Return "success"
                End If
            Else
                con1.Close()
                con1.Dispose()
                da.Dispose()
                da1.Dispose()
                Return "fail"
                Return "NA"
            End If

        Catch ex As Exception
            Throw
        Finally
            If Not da Is Nothing Then
                da.Dispose()
            End If
            'If Not con Is Nothing Then
            '    con.Close()
            '    con.Dispose()
            'End If
        End Try

    End Function

    '' prev b4 including child item 
    'Public Sub Recalculate_CalfieldsonSave(ByVal docid As Integer, con As SqlConnection, tran As SqlTransaction)
    '    ''''''''' Shalini;;;; For calculative field'''''''Calculative Field''''''''''''''''
    '    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '    Dim con1 As New SqlConnection(conStr)
    '    Dim da As SqlDataAdapter = New SqlDataAdapter("", con1)
    '    Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
    '    oda.SelectCommand.Transaction = tran
    '    Dim dsscal As New DataSet
    '    Dim dt5 As New DataTable
    '    Dim dt6 As New DataTable

    '    Dim cal_mpng As String = ""
    '    Dim cal_text As String = ""
    '    Dim fldmpng As String = ""
    '    Dim stringf As String = ""
    '    oda.SelectCommand.CommandText = "Select documenttype from MMM_MST_DOC where tid = " & docid & ""
    '    oda.Fill(dsscal, "caldoc")
    '    da.SelectCommand.CommandText = "Select cal_text,fieldmapping from MMM_MST_FIELDS with (nolock) where documenttype = '" & dsscal.Tables("caldoc").Rows(0).Item("documenttype").ToString() & "' and fieldtype='Calculative Field' and eid='" & Session("EID") & "' and isactive=1"
    '    da.Fill(dt5)
    '    If dt5.Rows.Count > 0 Then
    '        For n As Integer = 0 To dt5.Rows.Count - 1
    '            Dim orignlfinalstr As String = ""
    '            Dim finalstrr As String = ""
    '            Dim dt7 As New DataTable
    '            cal_text = dt5.Rows(n).Item("cal_text")
    '            cal_mpng = dt5.Rows(n).Item("fieldmapping")
    '            dt6.Rows.Clear()
    '            da.SelectCommand.CommandText = "Select displayname,fieldmapping,isactive from MMM_MST_FIELDS with(nolock) where documenttype = '" & dsscal.Tables("caldoc").Rows(0).Item("documenttype").ToString() & "' and eid = " & Session("EID") & " "
    '            da.Fill(dt6)
    '            stringf = cal_text
    '            For m As Integer = 0 To dt6.Rows.Count - 1
    '                '  If cal_text.Contains("{" & dt6.Rows(m).Item("displayname").ToString() & "}") Then
    '                If cal_text.Trim().Contains("{" & dt6.Rows(m).Item("displayname").ToString().Trim() & "}") Then
    '                    fldmpng = dt6.Rows(m).Item("fieldmapping").ToString().Trim()
    '                    stringf = stringf.Replace("{" & dt6.Rows(m).Item("displayname").ToString().Trim() & "}", "{" & fldmpng.Trim() & "}")
    '                End If
    '            Next
    '            stringf = stringf.Replace("{", "")
    '            stringf = stringf.Replace("}", "")
    '            Dim s As String() = Split(stringf, "=")
    '            Dim resultfldd As String = s(0)
    '            orignlfinalstr = s(1)

    '            If Right(orignlfinalstr, 1) = "," Then
    '                orignlfinalstr = Left(orignlfinalstr, orignlfinalstr.Length - 1)
    '            End If

    '            Dim intval As String = ""
    '            Dim spltstr() As String = orignlfinalstr.Split("(", ")", "+", "-", "*", "/")
    '            For i As Integer = 0 To spltstr.Length - 1
    '                If spltstr(i).Contains("fld") Then
    '                    finalstrr = finalstrr & spltstr(i) & ","
    '                Else
    '                    intval = intval & spltstr(i) & ","
    '                End If
    '            Next
    '            If Right(finalstrr, 1) = "," Then
    '                finalstrr = Left(finalstrr, finalstrr.Length - 1)
    '            End If
    '            'finalstrr = finalstrr.Replace("(", "")
    '            'finalstrr = finalstrr.Replace(")", "")

    '            'finalstrr = finalstrr.Replace("+", ",")
    '            'finalstrr = finalstrr.Replace("-", ",")
    '            'finalstrr = finalstrr.Replace("*", ",")
    '            'finalstrr = finalstrr.Replace("/", ",")
    '            'finalstrr = finalstrr.Replace("%", ",")
    '            Dim value As String = ""
    '            Dim opr As String = ""

    '            oda.SelectCommand.CommandText = "Select " & finalstrr & " from MMM_MST_DOC  where tid = " & docid & ""
    '            oda.Fill(dt7)
    '            Dim str As String = ""
    '            For h As Integer = 0 To dt7.Columns.Count - 1
    '                For Each c As Char In orignlfinalstr
    '                    str &= c
    '                    If str.Trim = dt7.Columns(h).ColumnName.ToString Then
    '                        value &= dt7.Rows(0).Item(dt7.Columns(h).ColumnName.ToString)
    '                        'Exit For
    '                        'orignlfinalstr = orignlfinalstr.Replace(dt7.Columns(h).ColumnName.ToString, IIf(IsDBNull(dt7.Rows(0).Item(dt7.Columns(h).ColumnName)), "0", dt7.Rows(0).Item(dt7.Columns(h).ColumnName).ToString()))

    '                    Else
    '                        If c = "+" Or c = "-" Or c = "*" Or c = "/" Or c = "%" Then
    '                            value = value & c

    '                            Dim fld As String = str & c
    '                            orignlfinalstr = Replace(orignlfinalstr, str.Trim, "")
    '                            str = ""
    '                            'orignlfinalstr = Right(orignlfinalstr, orignlfinalstr.Length - 1)
    '                            Exit For
    '                        End If
    '                    End If
    '                Next
    '                'orignlfinalstr = orignlfinalstr.Replace(dt7.Columns(h).ColumnName.ToString, "")
    '                'orignlfinalstr = Right(orignlfinalstr, orignlfinalstr.Length - 1)
    '            Next
    '            If Val(orignlfinalstr.Trim) <> 0 Then
    '                value = value & Val(orignlfinalstr.Trim)  '' removed on 01_jan_15
    '            End If
    '            Dim res = New DataTable().Compute(value, 0).ToString()
    '            'Dim res = New DataTable().Compute(orignlfinalstr, 0).ToString()
    '            ' oda.SelectCommand.CommandText = "Update MMM_MST_DOC set " & resultfldd & "=" & res & " where tid = " & docid & ""
    '            oda.SelectCommand.CommandText = "Update MMM_MST_DOC set " & cal_mpng & "=" & res & " where tid = " & docid & ""
    '            oda.SelectCommand.ExecuteNonQuery()
    '            dt7.Rows.Clear()
    '            dt7.Dispose()
    '        Next
    '    End If
    '    da.Dispose()
    '    dt5.Dispose()
    '    dt6.Dispose()

    'End Sub


    Public Sub Recalculate_CalfieldsonSave(ByVal docid As Integer, con As SqlConnection, tran As SqlTransaction)
        '''''''''For recalculation of calculative fields, if any ''''''''''''''''
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con1 As New SqlConnection(conStr)
        'Dim da As SqlDataAdapter = New SqlDataAdapter("", con1)
        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
        oda.SelectCommand.Transaction = tran
        Dim dsscal As New DataSet
        Dim dt5 As New DataTable
        Dim dt6 As New DataTable

        Dim cal_mpng As String = ""
        Dim cal_text As String = ""
        Dim fldmpng As String = ""
        Dim stringf As String = ""
        oda.SelectCommand.CommandText = "Select documenttype from MMM_MST_DOC where tid = " & docid & ""
        oda.Fill(dsscal, "caldoc")
        Dim Dtype As String = ""
        Dtype = Convert.ToString(oda.SelectCommand.ExecuteScalar())

        oda.SelectCommand.CommandText = "Select cal_text,fieldmapping from MMM_MST_FIELDS with (nolock) where documenttype ='" & Dtype & "' and fieldtype='Calculative Field' and eid='" & Session("EID") & "' and isactive=1"
        oda.Fill(dt5)
        If dt5.Rows.Count > 0 Then
            For n As Integer = 0 To dt5.Rows.Count - 1
                Dim orignlfinalstr As String = ""


                cal_text = dt5.Rows(n).Item("cal_text")
                cal_mpng = dt5.Rows(n).Item("fieldmapping")
                dt6.Rows.Clear()
                oda.SelectCommand.CommandText = "Select displayname,fieldmapping,isactive from MMM_MST_FIELDS with(nolock) where documenttype = '" & dsscal.Tables("caldoc").Rows(0).Item("documenttype").ToString() & "' and eid = " & Session("EID") & " "
                oda.Fill(dt6)
                stringf = cal_text
                For m As Integer = 0 To dt6.Rows.Count - 1
                    '  If cal_text.Contains("{" & dt6.Rows(m).Item("displayname").ToString() & "}") Then
                    If cal_text.Trim().Contains("{" & dt6.Rows(m).Item("displayname").ToString().Trim() & "}") Then
                        fldmpng = dt6.Rows(m).Item("fieldmapping").ToString().Trim()
                        stringf = stringf.Replace("{" & dt6.Rows(m).Item("displayname").ToString().Trim() & "}", "{" & fldmpng.Trim() & "}")
                    End If
                Next
                stringf = stringf.Replace("{", "")
                stringf = stringf.Replace("}", "")
                Dim st As String() = Split(stringf, ",")
                For k As Int16 = 0 To st.Length - 1
                    Dim dt7 As New DataTable
                    Dim finalstrr As String = ""
                    Dim s As String() = Split(st(k), "=")
                    If s(0).ToString.Length > 2 Then
                        Dim resultfldd As String = s(0)
                        orignlfinalstr = s(1)
                        If Right(orignlfinalstr, 1) = "," Then
                            orignlfinalstr = Left(orignlfinalstr, orignlfinalstr.Length - 1)
                        End If
                        Dim intval As String = ""
                        Dim spltstr() As String = orignlfinalstr.Split("(", ")", "+", "-", "*", "/")
                        For i As Integer = 0 To spltstr.Length - 1
                            If spltstr(i).Contains("fld") Then
                                finalstrr = finalstrr & spltstr(i) & ","
                            Else
                                intval = intval & spltstr(i) & ","
                            End If
                        Next
                        If Right(finalstrr, 1) = "," Then
                            finalstrr = Left(finalstrr, finalstrr.Length - 1)
                        End If
                        Dim value As String = ""
                        Dim Numericvalue As String = ""
                        Dim opr As String = ""
                        oda.SelectCommand.CommandText = "Select " & finalstrr & " from MMM_MST_DOC  where tid = " & docid & ""
                        oda.Fill(dt7)
                        Dim str As String = ""
                        Dim Temporignlfinalstr As String = orignlfinalstr
                        For h As Integer = 0 To dt7.Columns.Count - 1
                            For Each c As Char In orignlfinalstr
                                str &= c
                                If str.Trim = dt7.Columns(h).ColumnName.ToString Then
                                    value &= IIf(String.IsNullOrEmpty(dt7.Rows(0).Item(dt7.Columns(h).ColumnName.ToString)), "0", dt7.Rows(0).Item(dt7.Columns(h).ColumnName.ToString))
                                    'Exit For
                                    'orignlfinalstr = orignlfinalstr.Replace(dt7.Columns(h).ColumnName.ToString, IIf(IsDBNull(dt7.Rows(0).Item(dt7.Columns(h).ColumnName)), "0", dt7.Rows(0).Item(dt7.Columns(h).ColumnName).ToString()))
                                ElseIf c = "+" Or c = "-" Or c = "*" Or c = "/" Or c = "%" Then
                                    If String.IsNullOrEmpty(value) Then
                                        value = value & Numericvalue & c
                                        Numericvalue = ""
                                    Else
                                        value = value & c
                                    End If


                                    Dim fld As String = str & c
                                    orignlfinalstr = Replace(orignlfinalstr, str.Trim, "")
                                    str = ""
                                    'orignlfinalstr = Right(orignlfinalstr, orignlfinalstr.Length - 1)
                                    If h < dt7.Columns.Count - 1 Then
                                        Exit For
                                    End If
                                Else
                                    If Temporignlfinalstr.Length <> orignlfinalstr.Length Then
                                        If IsNumeric(str) Then
                                            value = value & c
                                        End If
                                    Else
                                        If IsNumeric(str) Then
                                            Numericvalue = Numericvalue & c
                                        End If
                                    End If
                                End If
                            Next
                            'orignlfinalstr = orignlfinalstr.Replace(dt7.Columns(h).ColumnName.ToString, "")
                            'orignlfinalstr = Right(orignlfinalstr, orignlfinalstr.Length - 1)
                        Next
                        If Val(orignlfinalstr.Trim) <> 0 Then
                            value = value & Val(orignlfinalstr.Trim)  '' removed on 01_jan_15
                        End If
                        Dim res = New DataTable().Compute(value, 0).ToString()
                        Dim decimalVar As Decimal
                        decimalVar = Decimal.Round(res, 2, MidpointRounding.AwayFromZero)
                        decimalVar = Math.Round(decimalVar, 2)
                        'Dim res = New DataTable().Compute(orignlfinalstr, 0).ToString()


                        oda.SelectCommand.CommandText = "Update MMM_MST_DOC set " & resultfldd & "='" & decimalVar.ToString() & "' where tid = " & docid & ""
                        oda.SelectCommand.ExecuteNonQuery()
                        dt7.Rows.Clear()
                        dt7.Dispose()
                    End If
                Next
            Next

        End If

        '''''' for child item  ' new added by sp on 14_apr_15
        oda.SelectCommand.CommandText = "Select dropdown,fieldmapping from MMM_MST_FIELDS with (nolock) where documenttype ='" & Dtype & "' and eid='" & Session("EID") & "' and isactive=1 and fieldtype='child item'"
        Dim dtC As New DataTable
        Dim dtCrows As New DataTable
        oda.Fill(dtC)
        If dtC.Rows.Count > 0 Then
            For n As Integer = 0 To dtC.Rows.Count - 1
                Dim dtCFM As New DataTable
                Dim datatCitem As New DataTable
                oda.SelectCommand.CommandText = "Select cal_text,fieldmapping from MMM_MST_FIELDS with (nolock) where documenttype ='" & dtC.Rows(n).Item("dropdown") & "' and fieldtype='Calculative Field' and eid='" & Session("EID") & "' and isactive=1"
                oda.Fill(dtCFM)
                For cf As Integer = 0 To dtCFM.Rows.Count - 1
                    'Dim dtCI As New DataTable
                    'da.SelectCommand.CommandText = "Select displayname,fieldmapping,isactive from MMM_MST_FIELDS with (nolock) where documenttype ='" & dtC.Rows(n).Item("dropdown") & "' and eid='" & Session("EID") & "' and isactive=1"
                    'da.Fill(dtCI)
                    oda.SelectCommand.CommandText = "Select * from mmm_mst_doc_item where docid=" & docid & " and documenttype='" & dtC.Rows(n).Item("dropdown") & "'"
                    oda.Fill(datatCitem)
                    For ci As Integer = 0 To datatCitem.Rows.Count - 1
                        Dim ChildTID As Integer
                        ChildTID = Convert.ToInt32(datatCitem.Rows(ci).Item("tid").ToString)
                        Dim orignlfinalstr As String = ""


                        cal_text = dtCFM.Rows(cf).Item("cal_text")
                        cal_mpng = dtCFM.Rows(cf).Item("fieldmapping")
                        dt6.Rows.Clear()
                        oda.SelectCommand.CommandText = "Select displayname,fieldmapping,isactive from MMM_MST_FIELDS with(nolock) where documenttype = '" & dtC.Rows(n).Item("dropdown").ToString() & "' and eid = " & Session("EID") & ""
                        oda.Fill(dt6)
                        stringf = cal_text
                        For m As Integer = 0 To dt6.Rows.Count - 1
                            '  If cal_text.Contains("{" & dt6.Rows(m).Item("displayname").ToString() & "}") Then
                            If cal_text.Trim().Contains("{" & dt6.Rows(m).Item("displayname").ToString().Trim() & "}") Then
                                fldmpng = dt6.Rows(m).Item("fieldmapping").ToString().Trim()
                                stringf = stringf.Replace("{" & dt6.Rows(m).Item("displayname").ToString().Trim() & "}", "{" & fldmpng.Trim() & "}")
                            End If
                        Next
                        stringf = stringf.Replace("{", "")
                        stringf = stringf.Replace("}", "")
                        Dim st As String() = Split(stringf, ",")
                        For k As Int16 = 0 To st.Length - 1

                            Dim dt7 As New DataTable
                            Dim finalstrr As String = ""
                            Dim s As String() = Split(st(k), "=")
                            If s(0).ToString.Length > 2 Then
                                Dim resultfldd As String = s(0)
                                orignlfinalstr = s(1)

                                If Right(orignlfinalstr, 1) = "," Then
                                    orignlfinalstr = Left(orignlfinalstr, orignlfinalstr.Length - 1)
                                End If

                                Dim intval As String = ""
                                Dim spltstr() As String = orignlfinalstr.Split("(", ")", "+", "-", "*", "/")
                                For i As Integer = 0 To spltstr.Length - 1
                                    If spltstr(i).Contains("fld") Then
                                        finalstrr = finalstrr & spltstr(i) & ","
                                    Else
                                        intval = intval & spltstr(i) & ","
                                    End If
                                Next
                                If Right(finalstrr, 1) = "," Then
                                    finalstrr = Left(finalstrr, finalstrr.Length - 1)
                                End If
                                Dim value As String = ""
                                Dim opr As String = ""

                                oda.SelectCommand.CommandText = "Select " & finalstrr & " from MMM_MST_DOC_item  where docid=" & docid & " and tid=" & ChildTID
                                oda.Fill(dt7)
                                Dim str As String = ""
                                For h As Integer = 0 To dt7.Columns.Count - 1
                                    For Each c As Char In orignlfinalstr
                                        str &= c
                                        If str.Trim = dt7.Columns(h).ColumnName.ToString Then
                                            value &= dt7.Rows(0).Item(dt7.Columns(h).ColumnName.ToString)
                                            'Exit For
                                            'orignlfinalstr = orignlfinalstr.Replace(dt7.Columns(h).ColumnName.ToString, IIf(IsDBNull(dt7.Rows(0).Item(dt7.Columns(h).ColumnName)), "0", dt7.Rows(0).Item(dt7.Columns(h).ColumnName).ToString()))

                                        Else
                                            If c = "+" Or c = "-" Or c = "*" Or c = "/" Or c = "%" Then
                                                value = value & c

                                                Dim fld As String = str & c
                                                orignlfinalstr = Replace(orignlfinalstr, str.Trim, "")
                                                str = ""
                                                'orignlfinalstr = Right(orignlfinalstr, orignlfinalstr.Length - 1)
                                                Exit For
                                            End If
                                        End If
                                    Next
                                    'orignlfinalstr = orignlfinalstr.Replace(dt7.Columns(h).ColumnName.ToString, "")
                                    'orignlfinalstr = Right(orignlfinalstr, orignlfinalstr.Length - 1)
                                Next
                                If Val(orignlfinalstr.Trim) <> 0 Then
                                    value = value & Val(orignlfinalstr.Trim)  '' removed on 01_jan_15
                                End If
                                Dim res = New DataTable().Compute(value, 0).ToString()
                                'Dim res = New DataTable().Compute(orignlfinalstr, 0).ToString()
                                ' oda.SelectCommand.CommandText = "Update MMM_MST_DOC set " & resultfldd & "=" & res & " where tid = " & docid & ""
                                oda.SelectCommand.CommandText = "Update MMM_MST_DOC_item set " & resultfldd & "= '" & res & "' where docid=" & docid & " and tid=" & ChildTID
                                oda.SelectCommand.ExecuteNonQuery()
                                dt7.Rows.Clear()
                                dt7.Dispose()
                            End If
                        Next
                    Next
                Next
            Next
        End If
        oda.Dispose()
        dt5.Dispose()
        dt6.Dispose()
    End Sub




    Protected Sub OpenWindow(ByVal sender As Object, ByVal e As EventArgs)
        Dim fileid As String = ViewState("viewdocid").ToString()
        Dim sb As StringBuilder = New StringBuilder("")
        Dim str As String = "window.open('DocDetail.aspx?DOCID=" + fileid + "');"
        sb.Append(str)
        ScriptManager.RegisterClientScriptBlock(Me.updMsg, Me.updMsg.GetType(), "NewClientScript", sb.ToString(), True)
    End Sub



    Protected Sub btnActEdit_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnActEdit.Click
        ResetGrid()

        ValidateData()
    End Sub

    Public Sub ShowChildForm(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Dim btnDetails As Button = TryCast(sender, Button)
        Dim formname As String = btnDetails.Text
        formname = Right(formname, formname.Length - 5).Trim()
        Session("FN") = formname
        Session("ID") = Right(btnDetails.ID, btnDetails.ID.Length - 3)
        Dim ob As New DynamicForm
        If Not IsNothing(Session("NewChildId")) Then
            ViewState("ID") = Session("NewChildId")
        End If
        If (ViewState("ID") <> btnDetails.ID) Or (ViewState("ID") Is Nothing) Or (Session("CHILD") Is Nothing) Then
            ViewState("ID") = btnDetails.ID
            Dim scrname As String = Request.QueryString("SC").ToString()
            Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
            Dim con As New SqlConnection(conStr)
            'With(nolock) added by Himank on 29th sep 2015
            Dim oda As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF  WITH(NOLOCK)  left outer JOIN MMM_MST_FORMS F  WITH(NOLOCK)  on F.FormName = FF.DocumentType and F.EID = FF.EID  where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FormName = '" & formname & "' order by displayOrder", con)
            Dim DS As New DataSet
            oda.Fill(DS, "CHILD")
            Session("CHILD") = DS.Tables("CHILD")
            ViewState(formname) = DS.Tables("CHILD")
            '' new added by sunil on 26_dec 2.34 pm
            Session("D" & formname) = DS.Tables("CHILD")
            pnlFields1.Controls.Clear()
            ob.CreateControlsOnPanel(DS.Tables("CHILD"), pnlFields1, updpnlchild, Button2, 0, Session("DDL"))
            'Calculate Button by Komal on 18March2014
            Dim Formula() As DataRow = DS.Tables("CHILD").Select("fieldtype='Formula Field'")
            If Formula.Length > 0 Then
                btnCalculate.Visible = True
            Else
                btnCalculate.Visible = False
            End If
            'Dim ROW1() As DataRow = DS.Tables("CHILD").Select("fieldtype='DROP DOWN' and (dropdowntype='MASTER VALUED' OR dropdowntype='CHILD VALUED') and (lookupvalue is not null or ddllookupvalue is not null)")
            'Code Block is Modified by Ajeet For control level Rule Engine Dated:21-Jan-2014
            Dim ROW1() As DataRow = Session("CHILD").Select("fieldtype='DROP DOWN'   and (lookupvalue is not null or ddllookupvalue is not null or multilookupval is not null or HasRule='1') ")
            If ROW1.Length > 0 Then
                For i As Integer = 0 To ROW1.Length - 1
                    Dim DDL As DropDownList = TryCast(pnlFields1.FindControl("fld" & ROW1(i).Item("FieldID").ToString()), DropDownList)
                    DDL.AutoPostBack = True
                    AddHandler DDL.TextChanged, AddressOf bindvalue1
                Next
            End If
            oda.Dispose()
            DS.Dispose()
            con.Dispose()
        End If
        '  ob.CLEARDYNAMICFIELDS(pnlFields1)
        ChildFormddlRenderingOnCreation(1)
        lblChildFormName.Visible = True
        lblChildFormName.Text = "ADD  " & Session("FN")
        updChildFormname.Update()
        updpnlchild.Update()
        Button2.Text = "Save"
        ModalPopupExtender1.Show()
    End Sub

    '' not in use as on 18-12-13
    Protected Sub ValidateChildData(ByVal actionType As String)
        'Check All Validations
        ' now validation of created controls
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim screenname As String = Session("FN")
        'With(nolock) added by Himank on 29th sep 2015
        Dim da As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF  WITH(NOLOCK)  left outer JOIN MMM_MST_FORMS F  WITH(NOLOCK)  on F.FormName = FF.DocumentType and F.EID = FF.EID where FF.isactive=1 and ff.fieldtype<>'Child Item' and F.EID=" & Session("EID").ToString() & " and FormName = '" & screenname & "' order by displayOrder", con)
        Dim ds As New DataSet
        da.Fill(ds, "fields")

        Dim ob As New DynamicForm
        Dim FinalQry As String
        If actionType = "ADD" Then
            If ds.Tables("fields").Rows(0).Item("layouttype") = "CUSTOM" Then
                FinalQry = ob.ValidateAndGenrateQueryForCustom("ADD", "INSERT INTO MMM_MST_DOC_ITEM(SESSIONID,documenttype,", "VALUES (" & Session.SessionID & ",'" & screenname & "',", ds.Tables("fields"), pnlFields1)
            Else
                FinalQry = ob.ValidateAndGenrateQueryForControls("ADD", "INSERT INTO MMM_MST_DOC_ITEM(SESSIONID,documenttype,", "VALUES ('" & Session.SessionID & "','" & screenname & "',", ds.Tables("fields"), pnlFields1, 0)
            End If

        Else
            'pass query of updation and also type
            FinalQry = ob.ValidateAndGenrateQueryForControls("UPDATE", "UPDATE MMM_MST_DOC_ITEM SET updateddate=getdate(),", "", ds.Tables("fields"), pnlFields1, ViewState("tid"))
        End If

        If Trim(Left(FinalQry, 6)).ToUpper() = "PLEASE" Then
            lblTab1.Text = FinalQry
        Else
            If actionType <> "ADD" Then
                FinalQry = FinalQry & " WHERE tID=" & ViewState("tid")
            End If
            'save the data
            lblTab1.Text = ""
            da.SelectCommand.CommandText = FinalQry
            If con.State <> ConnectionState.Open Then
                con.Open()
            End If
            da.SelectCommand.ExecuteNonQuery()
            BINDGRID()
            Session("CHILD") = Nothing
            ModalPopupExtender1.Hide()
        End If
        da.Dispose()
        con.Dispose()
    End Sub

    Protected Sub EditItem(ByVal sender As Object, ByVal e As System.EventArgs)
        'If Button2.Text = "Save" Then
        '    ValidateChildData("ADD")
        'Else
        '    ValidateChildData("EDIT")
        'End If

        'Prashant Singh 
        ResetGrid()

        If Button2.Text = "Save" Then
            Dim validchildItem As String = ADDITEMTOGRID(Session("FN"))
            If validchildItem.Length > 6 Then
                updpnlchild.Update()
                ModalPopupExtender1.Show()
            End If
        Else

            'If Not Request.QueryString("TID") Is Nothing Then
            '    ValidateChildDatad("EDIT")
            'Else
            SavingChildItemOnEdit(Session("FN"))
            'End If

        End If
    End Sub
    Protected Sub ValidateChildDatad(ByVal actionType As String)
        'Check All Validations
        ' now validation of created controls
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim screenname As String = ViewState("FN")
        'With(nolock) added by Himank on 29th sep 2015
        Dim da As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF  WITH(NOLOCK)  left outer JOIN MMM_MST_FORMS F  WITH(NOLOCK)  on F.FormName = FF.DocumentType and F.EID = FF.EID  where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FormName = '" & screenname & "' order by displayOrder", con)
        Dim ds As New DataSet
        da.Fill(ds, "fields")
        Dim pid As Integer = Convert.ToString(Request.QueryString("TID").ToString())
        Dim ob As New DynamicForm
        Dim FinalQry As String
        If actionType = "ADD" Then
            If ds.Tables("fields").Rows(0).Item("layouttype") = "CUSTOM" Then
                FinalQry = ob.ValidateAndGenrateQueryForCustom("ADD", "INSERT INTO MMM_MST_DOC_ITEM(DOCID,documenttype,", "VALUES (" & Session.SessionID & ",'" & screenname & "',", ds.Tables("fields"), pnlFields1)
                'ScriptManager.RegisterStartupScript(Me, Me.GetType(), "popup", "alert('Done Successfully!!');", True)
            Else
                FinalQry = ob.ValidateAndGenrateQueryForControls("ADD", "INSERT INTO MMM_MST_DOC_ITEM(DOCID,documenttype,", "VALUES (" & pid & ",'" & screenname & "',", ds.Tables("fields"), pnlFields1, 0)
                'ScriptManager.RegisterStartupScript(Me, Me.GetType(), "popup", "alert('Done Successfully!!');", True)
            End If
        Else
            'pass query of updation and also type
            FinalQry = ob.ValidateAndGenrateQueryForControls("UPDATE", "UPDATE MMM_MST_DOC_ITEM SET  ", "", ds.Tables("fields"), pnlFields1, pid)
        End If
        If Trim(Left(FinalQry, 6)).ToUpper() = "PLEASE" Then
            Label3.Text = FinalQry
            updpnlchild.Update()
            da.Dispose()
            con.Dispose()
        Else
            If actionType <> "ADD" Then
                FinalQry = FinalQry & " WHERE tID=" & pid

                da.SelectCommand.CommandText = "select history from MMM_MST_FORMS where EID= " & Session("EID") & " and formname='" & screenname & "' "
                da.Fill(ds, "his")
                'if formname consist history 1 then save the data in MMM_MST_HISTORY
                If ds.Tables("his").Rows(0).Item("history") = 1 Then
                    FinalQry = FinalQry & " " & ob.ValidateAndGenrateQueryForControls("ADD", ";INSERT INTO MMM_MST_HISTORY(DOCID,EID,tablename,UID,Uaction,adate,documenttype,", "VALUES (" & pid & "," & Session("EID") & ",'MMM_MST_DOC_ITEM'," & Session("UID") & ",'UPDATE',getdate(),'" & screenname & "',", ds.Tables("fields"), pnlFields1, 0)
                End If
            End If
            'save the data
            da.SelectCommand.CommandText = FinalQry
            If con.State <> ConnectionState.Open Then
                con.Open()
            End If
            da.SelectCommand.ExecuteNonQuery()
            ' ScriptManager.RegisterStartupScript(Me, Me.GetType(), "popup", "alert('Done Successfully!!');", True)
            Session("CHILD") = Nothing
            BINDGRIDch()
            ModalPopupExtender1.Hide()

        End If
        da.Dispose()
        con.Dispose()
    End Sub
    Protected Sub BINDGRIDch()

        Try

            Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
            Dim con As SqlConnection = New SqlConnection(conStr)
            Dim ODA As SqlDataAdapter = New SqlDataAdapter("", con)
            'Dim scrname As String = Request.QueryString("SC").ToString()
            Dim pid As Integer = Convert.ToString(Request.QueryString("TID").ToString())
            Dim DS As New DataSet
            ODA.SelectCommand.Parameters.Clear()
            ODA.SelectCommand.CommandText = "uspGetDetailITEMByDocid_for_draft"
            ODA.SelectCommand.CommandType = CommandType.StoredProcedure
            ODA.SelectCommand.Parameters.AddWithValue("DOCID", pid)
            ODA.SelectCommand.Parameters.AddWithValue("FN", ViewState("FN"))
            ODA.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
            DS.Tables.Clear()
            ODA.Fill(DS, "ITEM")
            Dim dt_item As DataTable = New DataTable()
            dt_item = DS.Tables("ITEM")
            ODA.SelectCommand.CommandType = CommandType.Text
            'With(nolock) added by Himank on 29th sep 2015
            ODA.SelectCommand.CommandText = "SELECT F1.FieldID,F2.displayName,F1.FieldType FROM MMM_MST_FIELDS F1  WITH(NOLOCK)  INNER JOIN MMM_MST_FIELDS F2  WITH(NOLOCK)  ON F1.dropdown =F2.Fieldid inner join mmm_mst_doc D on f1.documenttype=d.documenttype  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType ='CHILD ITEM TOTAL' AND F2.DocumentType ='" & ViewState("FN") & "' AND d.tid=" & pid & ""
            'ODA.SelectCommand.CommandText = "SELECT F1.FieldID,F2.displayName FROM MMM_MST_FIELDS F1 INNER JOIN MMM_MST_FIELDS F2 ON F1.dropdown =F2.Fieldid  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType ='CHILD ITEM TOTAL' AND F2.DocumentType ='" & ViewState("FN") & "' AND F1.DOCUMENTTYPE='" & scrname & "'"
            ODA.Fill(DS, "TOTAL")
            ODA.Dispose()
            DS.Dispose()
            Dim OB As New DynamicForm
            OB.BINDITEMGRID(dt_item, pnlFields, ViewState("ID"), UpdatePanel1, DS.Tables("TOTAL"), Eid:=Session("EID"), ScreenName:=ViewState("Doctype"), FormName:=ViewState("FN"))

        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Protected Sub BINDGRID()
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim ODA As SqlDataAdapter = New SqlDataAdapter("", con)
        Dim scrname As String = Request.QueryString("SC").ToString()
        Dim DS As New DataSet
        ODA.SelectCommand.Parameters.Clear()
        ODA.SelectCommand.CommandText = "uspGetDetailITEM"
        ODA.SelectCommand.CommandType = CommandType.StoredProcedure
        ODA.SelectCommand.Parameters.AddWithValue("SID", Session.SessionID)
        ODA.SelectCommand.Parameters.AddWithValue("FN", Session("FN"))
        ODA.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
        DS.Tables.Clear()
        ODA.Fill(DS, "ITEM")
        Dim dt_item As DataTable = New DataTable()
        dt_item = DS.Tables("ITEM")
        ODA.SelectCommand.CommandType = CommandType.Text
        'With(nolock) added by Himank on 29th sep 2015
        ODA.SelectCommand.CommandText = "SELECT F1.FieldID,F2.displayName,f1.fieldtype, FROM MMM_MST_FIELDS F1  WITH(NOLOCK)  INNER JOIN MMM_MST_FIELDS F2  WITH(NOLOCK)  ON F1.dropdown =F2.Fieldid  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType  in ('CHILD ITEM MAX','CHILD ITEM TOTAL')  AND F2.DocumentType ='" & Session("FN") & "' AND F1.DOCUMENTTYPE='" & scrname & "'"
        ODA.Fill(DS, "TOTAL")
        ODA.Dispose()
        DS.Dispose()
        Dim OB As New DynamicForm
        OB.BINDITEMGRID(dt_item, pnlFields, ViewState("ID"), UpdatePanel1, DS.Tables("TOTAL"), -1, -1, scrname, Session("FN").ToString, Convert.ToInt32(Session("EID")))
    End Sub
    '' you here on 17-dec-13 at 08.41 pm 
    'Protected Sub ADD_DV_ITEMSTOGRID(ByVal FORMNAME As String, ByVal DtDV As DataTable, ByVal DtDV_Vals As DataTable)
    '    Dim dtFD As New DataTable
    '    Dim dtField As New DataTable
    '    Dim DTVALUE As New DataTable
    '    Dim errormsg As String = "Please Enter "
    '    dtField = ViewState(FORMNAME)
    '    ' Dim OB As New DynamicForm()
    '    ' commented by balmiki on 4 july 14
    '    'If Session(FORMNAME) Is Nothing Then
    '    '    ' For Each dr As DataRow In dtField.Rows
    '    '    ' dtFD.Columns.Add(dr.Item("displayname"), GetType(String))
    '    '    ' DTVALUE.Columns.Add(dr.Item("Displayname"), GetType(String))
    '    '    ' Next
    '    '    dtFD = DtDV
    '    '    DTVALUE = DtDV_Vals
    '    '    dtFD.Columns.Add("tid", GetType(String))
    '    'Else
    '    '    dtFD = Session(FORMNAME)
    '    '    DTVALUE = Session(FORMNAME & "VAL")
    '    'End If

    '    dtFD = DtDV
    '    DTVALUE = DtDV_Vals
    '    dtFD.Columns.Add("tid", GetType(String))

    '    ''Check Form Level Validation
    '    'If dtField.Rows.Count > 0 Then
    '    '    Dim str As String = OB.validateForm(dtField.Rows(0).Item("Documenttype").ToString, Session("EID"), pnlFields, dtField, "ADD", 0)
    '    '    If str.Length > 5 Then
    '    '        str = "Please " & str
    '    '        Label3.Text = str
    '    '        Exit Sub
    '    '    End If
    '    'End If

    '    '' Remove the Total Row from Datatable
    '    ' If dtFD.Rows.Count > 1 Then
    '    ' dtFD.Rows.RemoveAt(dtFD.Rows.Count - 1)
    '    ' End If

    '    ' drnew.Item("tid") = FORMNAME & "-" & dtFD.Rows.Count & "-" & ViewState("ID")
    '    For Each dr As DataRow In dtFD.Rows
    '        dr.Item("tid") = "" ' FORMNAME & "-" & dtFD.Rows.Count & "-" & ViewState("ID")
    '    Next

    '    ' For Each dr As DataRow In DTVALUE.Rows
    '    ' dr.Item("tid") = FORMNAME & "-" & DTVALUE.Rows.Count & "-" & ViewState("ID")
    '    ' Next

    '    ' dtFD.Rows.Add(drnew)
    '    ' DTVALUE.Rows.Add(DRNEWVAL)
    '    Session(FORMNAME) = dtFD
    '    Session(FORMNAME & "VAL") = DTVALUE
    '    BINDGRID1(dtFD)
    '    ' ModalPopupExtender1.Hide()
    'End Sub


    Protected Sub ADD_DV_ITEMSTOGRID(ByVal FORMNAME As String, ByVal DtDV As DataTable, ByVal DtDV_Vals As DataTable, Optional ByVal childGdId As String = Nothing)
        Dim dtFD As New DataTable
        Dim dtField As New DataTable
        Dim DTVALUE As New DataTable
        Dim errormsg As String = "Please Enter "
        dtField = ViewState(FORMNAME)
        ' Dim OB As New DynamicForm()
        ' commented by balmiki on 4 july 14
        'If Session(FORMNAME) Is Nothing Then
        '    ' For Each dr As DataRow In dtField.Rows
        '    ' dtFD.Columns.Add(dr.Item("displayname"), GetType(String))
        '    ' DTVALUE.Columns.Add(dr.Item("Displayname"), GetType(String))
        '    ' Next
        '    dtFD = DtDV
        '    DTVALUE = DtDV_Vals
        '    dtFD.Columns.Add("tid", GetType(String))
        'Else
        '    dtFD = Session(FORMNAME)
        '    DTVALUE = Session(FORMNAME & "VAL")
        'End If

        dtFD = DtDV
        DTVALUE = DtDV_Vals
        'dtFD.Columns.Add("tid", GetType(String))  ' 20 jan commentted by balli

        ''Check Form Level Validation
        'If dtField.Rows.Count > 0 Then
        '    Dim str As String = OB.validateForm(dtField.Rows(0).Item("Documenttype").ToString, Session("EID"), pnlFields, dtField, "ADD", 0)
        '    If str.Length > 5 Then
        '        str = "Please " & str
        '        Label3.Text = str
        '        Exit Sub
        '    End If
        'End If

        '' Remove the Total Row from Datatable
        ' If dtFD.Rows.Count > 1 Then
        ' dtFD.Rows.RemoveAt(dtFD.Rows.Count - 1)
        ' End If

        ' drnew.Item("tid") = FORMNAME & "-" & dtFD.Rows.Count & "-" & ViewState("ID")
        'For Each dr As DataRow In dtFD.Rows    ' commentted by balli 20 jan
        '    dr.Item("tid") = "" ' FORMNAME & "-" & dtFD.Rows.Count & "-" & ViewState("ID")
        'Next

        ' For Each dr As DataRow In DTVALUE.Rows
        ' dr.Item("tid") = FORMNAME & "-" & DTVALUE.Rows.Count & "-" & ViewState("ID")
        ' Next

        ' dtFD.Rows.Add(drnew)
        ' DTVALUE.Rows.Add(DRNEWVAL)
        Session(FORMNAME) = dtFD
        Session(FORMNAME & "VAL") = DTVALUE
        BINDGRID1(dtFD, FORMNAME, childGdId)
        ' ModalPopupExtender1.Hide()
    End Sub

    Public Sub INSERTCHILDITEM(ByVal SENDER As Object, ByVal E As System.EventArgs)
        Dim btnDetails As Button = TryCast(SENDER, Button)
        Dim formname As String = btnDetails.Text
        formname = Right(formname, formname.Length - 8).Trim()
        Session("FN") = formname
        Dim ID() As String = btnDetails.ID.Split("-")
        ID(0) = Right(ID(0), ID(0).Length - 3).Trim()
        Dim scrname As String = Request.QueryString("SC").ToString()
        Dim ob As New DynamicForm
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim DS As New DataSet
        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If
        Dim ddl As DropDownList = TryCast(pnlFields.FindControl("fld" & ID(0).ToString()), DropDownList)
        Dim docid() As String = ddl.SelectedValue.ToString.Split("|")
        oda.SelectCommand.Parameters.Clear()
        oda.SelectCommand.CommandType = CommandType.StoredProcedure
        oda.SelectCommand.CommandText = "USP_COPY_CHILDITEM"
        oda.SelectCommand.CommandType = CommandType.StoredProcedure
        oda.SelectCommand.Parameters.AddWithValue("SID", Session.SessionID)
        oda.SelectCommand.Parameters.AddWithValue("FN", formname)
        oda.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
        oda.SelectCommand.Parameters.AddWithValue("DOCID", docid(0).ToString())
        oda.SelectCommand.ExecuteScalar()
        oda.SelectCommand.Parameters.Clear()
        oda.SelectCommand.CommandType = CommandType.StoredProcedure
        oda.SelectCommand.CommandText = "uspGetDetailITEM"
        oda.SelectCommand.CommandType = CommandType.StoredProcedure
        oda.SelectCommand.Parameters.AddWithValue("SID", Session.SessionID)
        oda.SelectCommand.Parameters.AddWithValue("FN", formname)
        oda.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
        DS.Tables.Clear()
        oda.Fill(DS, "ITEM")
        oda.SelectCommand.CommandType = CommandType.Text
        'With(nolock) added by Himank on 29th sep 2015
        oda.SelectCommand.CommandText = "SELECT F1.FieldID,F2.displayName,F1.FieldType FROM MMM_MST_FIELDS F1  WITH(NOLOCK)  INNER JOIN MMM_MST_FIELDS F2  WITH(NOLOCK)  ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType  in ('CHILD ITEM MAX','CHILD ITEM TOTAL')  AND F2.DocumentType ='" & formname & "' AND F1.DOCUMENTTYPE='" & scrname & "'"
        oda.Fill(DS, "TOTAL")
        ob.BINDITEMGRID(DS.Tables("ITEM"), pnlFields, "BTN" & ID(1).ToString(), UpdatePanel1, DS.Tables("TOTAL"), -1, -1, scrname, formname, Convert.ToInt32(Session("EID")))
        oda.Dispose()
        DS.Dispose()
        con.Dispose()
    End Sub

    Public Sub totalrow(ByVal sender As Object, ByVal e As GridViewRowEventArgs)
        Dim cnt As Integer = e.Row.Cells.Count - 1
        If e.Row.RowType = DataControlRowType.DataRow Then
            If e.Row.Cells(0).Text.ToUpper() = "TOTAL" Then
                e.Row.Font.Bold = True
                e.Row.ForeColor = Drawing.Color.Black
            Else
                Dim img As ImageButton = New ImageButton()
                img.ID = e.Row.Cells(cnt).Text
                img.ImageUrl = "~/images/Cancel.gif"
                img.CommandName = "Remove"
                img.CommandArgument = e.Row.Cells(cnt).Text
                img.Height = Unit.Parse("16")
                img.Width = Unit.Parse("16")
                e.Row.Cells(cnt).Controls.Add(img)
                e.Row.Cells(cnt).Controls.Add(New LiteralControl("&nbsp;"))
                Dim btnEdit As ImageButton = New ImageButton()
                btnEdit.ID = e.Row.Cells(cnt).Text & "Child"
                btnEdit.CommandName = "Editchild"
                btnEdit.ImageUrl = "~/images/Edit.gif"
                btnEdit.CommandArgument = e.Row.Cells(cnt).Text
                btnEdit.Height = Unit.Parse("16")
                btnEdit.Width = Unit.Parse("16")
                e.Row.Cells(cnt).Controls.Add(btnEdit)
            End If
        ElseIf e.Row.RowType = DataControlRowType.Header Then
            e.Row.Cells(cnt).Text = " "
        End If

    End Sub

    Public Sub Delete(ByVal sender As Object, ByVal e As GridViewCommandEventArgs)
        Dim btnDelete As GridView = TryCast(sender, GridView)
        Dim ID As String = btnDelete.ID
        ID = Right(ID, ID.Length - 3)
        Session("ID") = ID
        ID = "BTN" & ID
        ViewState("ID") = ID
        Dim scrname As String = Request.QueryString("SC").ToString()
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
        Dim DS As New DataSet
        Dim rw As GridViewRow = DirectCast(DirectCast(e.CommandSource, ImageButton).NamingContainer, GridViewRow)
        'Dim Pid As Integer = rw.RowIndex
        Dim PidDraft As String = btnDelete.DataKeys(rw.RowIndex).Value
        Dim Pid As String() = btnDelete.DataKeys(rw.RowIndex).Value.ToString.Split("-")
        Dim CurIndex As Integer = rw.RowIndex
        ViewState("Index") = CurIndex
        If Pid.Length > 1 Then
            ViewState("ID") = Pid(2)
        End If
        If e.CommandName = "Remove" Then
            Dim dt As DataTable = Session(Pid(0))
            If dt.Rows.Count > 1 And dt.Rows.Count = 2 Then
                dt.Rows.RemoveAt(dt.Rows.Count - 1)
            End If
            Dim DTVAL As DataTable = Session(Pid(0) & "VAL")
            If dt.Rows.Count > 0 Then
                dt.Rows.RemoveAt(CurIndex)
                DTVAL.Rows.RemoveAt(CurIndex)
                Session(Pid(0)) = dt
                Session(Pid(0) & "VAL") = DTVAL

                If con.State <> ConnectionState.Open Then
                    con.Open()
                End If
                oda.SelectCommand.CommandType = CommandType.Text
                'With(nolock) added by Himank on 29th sep 2015
                oda.SelectCommand.CommandText = "SELECT F1.FieldID,F2.displayName,F1.FieldType FROM MMM_MST_FIELDS F1   WITH(NOLOCK) INNER JOIN MMM_MST_FIELDS F2   WITH(NOLOCK) ON F1.dropdown =F2.Fieldid  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType  in ('CHILD ITEM MAX','CHILD ITEM TOTAL')  AND F2.DocumentType ='" & Session("FN") & "' AND F1.DOCUMENTTYPE='" & scrname & "'"
                oda.Fill(DS, "TOTAL")

                'oda.SelectCommand.CommandText = "Delete from MMM_MST_DOC_ITEM where tid=" & Pid & ""
                'oda.SelectCommand.ExecuteScalar()
                oda.Dispose()
                con.Dispose()
                Dim OB As New DynamicForm
                OB.BINDITEMGRID1(dt, pnlFields, Session("ID"), UpdatePanel1, DS.Tables("TOTAL"), -1, -1, scrname, Session("FN").ToString, Convert.ToInt32(Session("EID")))
            Else
                Session(Session(Pid(0))) = Nothing
                Session(Session(Pid(0) & "VAL")) = Nothing
            End If

            'BINDGRID1(dt)
            'BINDGRIDAFTERDELETION(ID)
        ElseIf e.CommandName.ToUpper = "EDITCHILD" Then
            If Not Request.QueryString("TID") Is Nothing Then
                Dim ob As New DynamicForm
                ob._CallerPage = 1
                'With(nolock) added by Himank on 29th sep 2015
                oda = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF  WITH(NOLOCK)  left outer JOIN MMM_MST_FORMS F  WITH(NOLOCK)  on F.FormName = FF.DocumentType and F.EID = FF.EID where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FORMNAME=(Select documenttype from mmm_mst_doc_item_draft where tid=" & PidDraft & ") order by displayOrder", con)
                'Dim DS As New DataSet
                oda.Fill(DS, "CHILD")
                ViewState("FN") = DS.Tables("CHILD").Rows(0).Item("DOCUMENTTYPE").ToString
                Session("FN") = DS.Tables("CHILD").Rows(0).Item("DOCUMENTTYPE").ToString
                Session("CHILD") = DS.Tables("CHILD")
                Session("D" & Session("FN")) = DS.Tables("CHILD")
                pnlFields1.Controls.Clear()
                ob.CreateControlsOnPanel(Session("CHILD"), pnlFields1, updpnlchild, Button2, 0)
                Dim ROW1() As DataRow = DS.Tables("CHILD").Select("fieldtype='DROP DOWN' and (dropdowntype='MASTER VALUED' OR DROPDOWNTYPE='SESSION VALUED') and lookupvalue is not null or multilookUpVal is not null")
                If ROW1.Length > 0 Then
                    For i As Integer = 0 To ROW1.Length - 1
                        Dim DDL As DropDownList = TryCast(pnlFields1.FindControl("fld" & ROW1(i).Item("FieldID").ToString()), DropDownList)
                        DDL.AutoPostBack = True
                        AddHandler DDL.TextChanged, AddressOf bindvalue1
                    Next
                End If
                ob.FillControlsOnPanel(Session("CHILD"), pnlFields1, "CHILDITEM", PidDraft, True)
            Else


                Dim ob As New DynamicForm
                'ob._CallerPage = 1
                'With(nolock) added by Himank on 29th sep 2015
                oda = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF  WITH(NOLOCK)  left outer JOIN MMM_MST_FORMS F  WITH(NOLOCK)  on F.FormName = FF.DocumentType and F.EID = FF.EID where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FORMNAME='" & Pid(0).ToString() & "' order by displayOrder", con)
                oda.Fill(DS, "CHILD")
                Session("FN") = DS.Tables("CHILD").Rows(0).Item("DOCUMENTTYPE").ToString
                Session("CHILD") = DS.Tables("CHILD")
                pnlFields1.Controls.Clear()
                ob.CreateControlsOnPanel(Session("CHILD"), pnlFields1, updpnlchild, Button2, 0)
                Dim ROW1() As DataRow = DS.Tables("CHILD").Select("fieldtype='DROP DOWN' and (dropdowntype='MASTER VALUED' or dropdowntype='CHILD VALUED' OR DROPDOWNTYPE='SESSION VALUED') and (lookupvalue is not null or ddllookupvalue is not null or multilookUpVal is not null)")
                If ROW1.Length > 0 Then
                    For i As Integer = 0 To ROW1.Length - 1
                        Dim DDL As DropDownList = TryCast(pnlFields1.FindControl("fld" & ROW1(i).Item("FieldID").ToString()), DropDownList)
                        DDL.AutoPostBack = True
                        AddHandler DDL.TextChanged, AddressOf bindvalue1
                    Next
                End If

                FILLCONTROLONEDIT(DS.Tables("CHILD"), Session(Pid(0).ToString), Session(Pid(0) & "VAL"), pnlFields1, updpnlchild, CurIndex)
            End If
            ''Dim ob As New DynamicForm
            ' ''ob._CallerPage = 1
            ''oda = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF left outer JOIN MMM_MST_FORMS F on F.FormName = FF.DocumentType and F.EID = FF.EID where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FORMNAME='" & Pid(0).ToString() & "' order by displayOrder", con)
            ''oda.Fill(DS, "CHILD")
            ''Session("FN") = DS.Tables("CHILD").Rows(0).Item("DOCUMENTTYPE").ToString
            ''Session("CHILD") = DS.Tables("CHILD")
            ''pnlFields1.Controls.Clear()
            ''ob.CreateControlsOnPanel(Session("CHILD"), pnlFields1, updpnlchild, Button2, 0)
            ''Dim ROW1() As DataRow = DS.Tables("CHILD").Select("fieldtype='DROP DOWN' and (dropdowntype='MASTER VALUED' or dropdowntype='CHILD VALUED' OR DROPDOWNTYPE='SESSION VALUED') and (lookupvalue is not null or ddllookupvalue is not null)")
            ''If ROW1.Length > 0 Then
            ''    For i As Integer = 0 To ROW1.Length - 1
            ''        Dim DDL As DropDownList = TryCast(pnlFields1.FindControl("fld" & ROW1(i).Item("FieldID").ToString()), DropDownList)
            ''        DDL.AutoPostBack = True
            ''        AddHandler DDL.TextChanged, AddressOf bindvalue1
            ''    Next
            ''End If
            ' '' FILLCONTROLONEDIT(DS.Tables("CHILD"), Session(Pid(0).ToString), Session(Pid(0) & "VAL"), pnlFields1, updpnlchild, CInt(Pid(1)))
            ''FILLCONTROLONEDIT(DS.Tables("CHILD"), Session(Pid(0).ToString), Session(Pid(0) & "VAL"), pnlFields1, updpnlchild, CurIndex)
            Button2.Text = "UPDATE"
            lblChildFormName.Text = "EDIT  " & Session("FN")
            updChildFormname.Update()
            updpnlchild.Update()
            ModalPopupExtender1.Show()
        End If
    End Sub

    Public Sub Deleting(ByVal Sender As Object, ByVal e As GridViewDeleteEventArgs)
        Dim btnDelete As GridView = TryCast(Sender, GridView)
        btnDelete.DataBind()
    End Sub

    Protected Sub BINDGRIDAFTERDELETION(ByVal ID As String)
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim ODA As SqlDataAdapter = New SqlDataAdapter("", con)
        Dim scrname As String = Request.QueryString("SC").ToString()
        Dim DS As New DataSet
        ODA.SelectCommand.Parameters.Clear()
        ODA.SelectCommand.CommandText = "uspGetDetailITEM"
        ODA.SelectCommand.CommandType = CommandType.StoredProcedure
        ODA.SelectCommand.Parameters.AddWithValue("SID", Session.SessionID)
        ODA.SelectCommand.Parameters.AddWithValue("FN", Session("FN"))
        ODA.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
        DS.Tables.Clear()
        ODA.Fill(DS, "ITEM")
        Dim dt_item As DataTable = New DataTable()
        dt_item = DS.Tables("ITEM")
        ODA.SelectCommand.CommandType = CommandType.Text
        'With(nolock) added by Himank on 29th sep 2015
        ODA.SelectCommand.CommandText = "SELECT F1.FieldID,F2.displayName,F1.FieldType FROM MMM_MST_FIELDS F1  WITH(NOLOCK)  INNER JOIN MMM_MST_FIELDS F2  WITH(NOLOCK)  ON F1.dropdown =F2.Fieldid  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType  in ('CHILD ITEM MAX','CHILD ITEM TOTAL')  AND F2.DocumentType ='" & Session("FN") & "' AND F1.DOCUMENTTYPE='" & scrname & "'"
        ODA.Fill(DS, "TOTAL")
        ODA.Dispose()
        DS.Dispose()
        Dim OB As New DynamicForm
        OB.BINDITEMGRID(dt_item, pnlFields, ID, UpdatePanel1, DS.Tables("TOTAL"), -1, -1, scrname, Session("FN"), Convert.ToInt32(Session("FN")))
    End Sub

    Public Sub ADDTASK(ByVal sender As System.Object, ByVal e As System.EventArgs)
        AddTask_ModalPopUp.Show()
        ddluser.SelectedIndex = 0
        txtDue_Date.Text = ""
        txtRemarks.Text = ""
        UpdPnlAddTask.Update()
    End Sub

    Protected Sub BTNTask_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles BTNTask.Click
        Dim DT_TASK As New DataTable
        If Session("dtNew") Is Nothing Then
            DT_TASK.Columns.Add("USERNAME", GetType(String))
            DT_TASK.Columns.Add("DUE_DATE", GetType(String))
            DT_TASK.Columns.Add("REMARKS", GetType(String))
            DT_TASK.Columns.Add("UID", GetType(Integer))
        Else
            DT_TASK = Session("dtNew")
        End If
        Dim DRNEW As DataRow = DT_TASK.NewRow()
        DRNEW.Item("USERNAME") = ddluser.SelectedItem.Text
        DRNEW.Item("DUE_DATE") = txtDue_Date.Text
        DRNEW.Item("REMARKS") = txtRemarks.Text
        DRNEW.Item("UID") = ddluser.SelectedValue
        DT_TASK.Rows.Add(DRNEW)
        Session("dtNew") = DT_TASK
        BINDGRIDTASK(DT_TASK)
        AddTask_ModalPopUp.Hide()
    End Sub


    Protected Function ADDITEMTOGRID(ByVal FORMNAME As String) As String
        Label3.Text = ""
        Dim dtFD As New DataTable
        Dim dtField As New DataTable
        Dim DTVALUE As New DataTable
        Dim fileSize As Integer = 0
        Dim allowedSize As Integer = 0
        Dim flagFsize As Integer = 0
        Dim errormsg As String = "Please "
        dtField = ViewState(FORMNAME)

        'Added By mayank for Advance Formula 24-03-2015 Start Here
        Dim dvs As DataView = dtField.DefaultView
        dvs.RowFilter = "IsActive=1"
        Dim theFieldss As DataTable = dvs.ToTable
        Dim lstDatas As New List(Of UserData)
        Dim OB As New DynamicForm()
        lstDatas = OB.CreateCollection(pnlFields, theFieldss)
        Session("pColl") = lstDatas
        '' OB.ADDITEMTOGRID(dtField, FORMNAME, pnlFields1)

        For Each dr As DataRow In dtField.Rows
            Dim cal_text As String = ""
            Dim cal_mpng As String = ""
            Dim stringf As String = ""
            Dim fldmpng As String = ""
            Dim orignlfinalstr As String = ""
            Dim finalstrr As String = ""
            Select Case dr.Item("FieldType").ToString().ToUpper()
                Case "CALCULATIVE FIELD"
                    Dim dispName1 As String = dr.Item("displayname").ToString()
                    Dim calfldmpng As String = dr.Item("FieldID").ToString()
                    cal_text = dr.Item("cal_text").ToString()
                    cal_mpng = dr.Item("fieldmapping").ToString()
                    'Chages fro multiple calculative Field Mayank
                    If (cal_text.Contains(",")) Then
                        Dim calar As String() = cal_text.Split(",")
                        For i As Integer = 0 To calar.Length - 1
                            Dim subcalar As String() = calar(i).ToString().Split("=")
                            If (subcalar.Length > 1) Then
                                If (subcalar(0) = "{" & dispName1 & "}") Then
                                    cal_text = ""
                                    cal_text = subcalar(0).ToString() & "=" & subcalar(1).ToString()
                                    Exit For
                                End If
                            End If
                        Next
                    Else
                        stringf = cal_text
                    End If

                    'Chages fro multiple calculative Field Mayank
                    stringf = cal_text
                    For l As Integer = 0 To dtField.Rows.Count - 1
                        If cal_text.Trim().Contains("{" & dtField.Rows(l).Item("displayname").ToString().Trim() & "}") Then
                            fldmpng = "fld" & dtField.Rows(l).Item("FieldID").ToString().Trim()
                            stringf = stringf.Replace("{" & dtField.Rows(l).Item("displayname").ToString().Trim() & "}", "{" & fldmpng.Trim() & "}")
                        End If
                    Next
                    stringf = stringf.Replace("{", "")
                    stringf = stringf.Replace("}", "")
                    Dim s As String() = Split(stringf, "=")
                    Dim resultfldd As String = s(0)
                    orignlfinalstr = s(1)
                    finalstrr = orignlfinalstr
                    Dim arr As String() = finalstrr.Split("*", "/", "-", "(", ")", "+", ",")
                    Dim ghn As String = ""
                    For i As Integer = 0 To arr.Length - 1
                        If arr(i).Contains("fld") Then
                            Dim txtBox1 As TextBox = CType(pnlFields.FindControl(arr(i)), TextBox)
                            ghn = txtBox1.Text
                            finalstrr = finalstrr.Replace(arr(i), ghn)
                        End If
                    Next
                    Dim res = New DataTable().Compute(finalstrr, 0).ToString()
                    Dim txtBox As TextBox = CType(pnlFields1.FindControl("fld" & calfldmpng), TextBox)
                    txtBox.Text = res

                Case "ADVANCE FORMULA"

                    ''  Dim ObjFormula As New FormulaEngine()
                    'Dim AdFormula As String = ""
                    'Dim FieldID = dr.Item("FieldID").ToString()
                    'ObjFormula.EID = Session("EID")
                    'ObjFormula.FormulaFIeld = FieldID
                    'AdFormula = dr.Item("Advance_formula").ToString()
                    'Dim val = ObjFormula.ExecuteFormula(AdFormula, Session("EID"), lstDatas, Nothing, False)
                    'Dim fField As New TextBox()
                    'fField = CType(pnlFields.FindControl("fld" & FieldID), TextBox)
                    'If (Not fField Is Nothing) Then
                    '    fField.Text = Convert.ToString(val)
                    '    lstDatas = OB.CreateCollection(pnlFields, theFieldss)
                    'End If
                    ''forvalue = formulaeditorr.ExecuteFormula(CField.Item("KC_LOGIC"), DocID, "v" + Session("eid").ToString + viewdoc, Session("eid").ToString, 0)

            End Select
        Next

        If Session(FORMNAME) Is Nothing Then
            For Each dr As DataRow In dtField.Rows
                dtFD.Columns.Add(dr.Item("displayname"), GetType(String))
                DTVALUE.Columns.Add(dr.Item("Displayname"), GetType(String))
            Next
            dtFD.Columns.Add("tid", GetType(String))
        Else
            dtFD = Session(FORMNAME)
            DTVALUE = Session(FORMNAME & "VAL")
        End If
        Dim drnew As DataRow = dtFD.NewRow()
        Dim DRNEWVAL As DataRow = DTVALUE.NewRow()
        For Each dr As DataRow In dtField.Rows
            Dim dispName As String = dr.Item("displayname").ToString()
            Select Case dr.Item("FieldType").ToString().ToUpper()
                Case "TEXT BOX"
                    Dim txtBox As TextBox = CType(pnlFields1.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
                    If dr.Item("isrequired").ToString() = 1 And txtBox.Text.Trim.Length < 1 Then
                        errormsg &= dispName & ","

                    End If
                    If dr.Item("datatype") = "Datetime" Then
                        Dim str1 As String() = Split(txtBox.Text, "/")
                        If str1.Length = 3 Then
                            Dim strDate1 As String = str1(1) & "/" & str1(0) & "/" & str1(2)
                            txtBox.Text = strDate1

                        Else
                            errormsg &= "Date is not in correct format at " & dispName & ","
                            Continue For
                        End If
                        If Not IsDate(txtBox.Text) Then
                            errormsg &= "Date is not in correct format at " & dispName & ","
                            Continue For
                        Else
                            txtBox.Text = Format(Convert.ToDateTime(txtBox.Text.ToString), "dd/MM/yy")
                            Dim str As String() = Split(txtBox.Text, "/")
                            Dim strDate As String = str(0).PadLeft(2, "0") & "/" & str(1).PadLeft(2, "0") & "/" & str(2).PadLeft(2, "0")
                            txtBox.Text = strDate
                        End If
                    End If
                    If txtBox.Text.Length < CInt(dr.Item("minlen").ToString) And txtBox.Text.Length > 0 And dr.Item("datatype").ToString.ToUpper <> "DATETIME" Then
                        errormsg &= "Minimum  " & dr.Item("minlen").ToString() & " character in " & dispName & ","
                        Continue For
                    End If
                    If txtBox.Text.Length > CInt(dr.Item("maxlen").ToString) And txtBox.Text.Length > 0 And dr.Item("datatype").ToString.ToUpper <> "DATETIME" Then
                        errormsg &= "Maximum  " & dr.Item("maxlen").ToString() & " character in " & dispName & ","
                        Continue For
                    End If

                    If dr.Item("isunique").ToString() = "1" Then
                        If OB.checkduplicate("ADD", 0, dr.Item("DBTABLENAME").ToString, dr.Item("Fieldmapping").ToString(), txtBox.Text, dr.Item("DOCUMENTTYPE").ToString) Then
                            errormsg &= "unique " & dispName & " ,"
                            Exit For
                        End If
                    End If
                    drnew.Item(dr.Item("displayname")) = txtBox.Text
                    DRNEWVAL.Item(dr.Item("displayname")) = txtBox.Text

                Case "DROP DOWN", "LOOKUPDDL", "MULTI LOOKUPDDL"
                    Dim txtBox As DropDownList = CType(pnlFields1.FindControl("fld" & dr.Item("FieldID").ToString()), DropDownList)
                    If dr.Item("isrequired").ToString() = 1 And txtBox.SelectedItem.Text.ToUpper = "SELECT" Then
                        errormsg &= dispName & ","
                        Continue For
                    End If
                    If UCase(dr.Item("dropdowntype").ToString()) = "FIX VALUED" Then
                        drnew.Item(dr.Item("displayname")) = txtBox.SelectedItem.Text
                        DRNEWVAL.Item(dr.Item("displayname")) = txtBox.SelectedItem.Value
                    Else
                        'Dim fldpair() As String = txtBox.SelectedValue.ToString().Split("|")
                        If dr.Item("lookupvalue").ToString().Length > 2 Then
                            Dim fldpair() As String = txtBox.SelectedValue.ToString().Split("|")
                            'dataField &= "'" & fldpair(0).ToString() & "',"
                            drnew.Item(dr.Item("displayname")) = txtBox.SelectedItem.Text
                            DRNEWVAL.Item(dr.Item("displayname")) = fldpair(0).ToString()
                        Else
                            'dataField &= "'" & txtBox.SelectedValue.ToString() & "',"
                            drnew.Item(dr.Item("displayname")) = txtBox.SelectedItem.Text
                            DRNEWVAL.Item(dr.Item("displayname")) = txtBox.SelectedItem.Value
                        End If
                    End If
                Case "CALCULATIVE FIELD"
                    Dim txtBox As TextBox = CType(pnlFields1.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
                    If dr.Item("isrequired").ToString() = 1 And txtBox.Text.Length < 1 Then
                        errormsg &= dispName & ","
                        Continue For
                    End If
                    drnew.Item(dr.Item("displayname")) = txtBox.Text
                    DRNEWVAL.Item(dr.Item("displayname")) = txtBox.Text

                Case "ADVANCE FORMULA"
                    Dim txtBox As TextBox = CType(pnlFields1.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
                    If dr.Item("isrequired").ToString() = 1 And txtBox.Text.Length < 1 Then
                        errormsg &= dispName & ","
                        Continue For
                    End If
                    drnew.Item(dr.Item("displayname")) = txtBox.Text
                    DRNEWVAL.Item(dr.Item("displayname")) = txtBox.Text
                Case "LOOKUP", "MULTI LOOKUP"
                    Dim txtBox As TextBox = CType(pnlFields1.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
                    If dr.Item("isrequired").ToString() = 1 And txtBox.Text.Length < 1 Then
                        errormsg &= dispName & ","
                        Continue For
                    End If
                    drnew.Item(dr.Item("displayname")) = txtBox.Text
                    DRNEWVAL.Item(dr.Item("displayname")) = txtBox.Text
                Case "CHECKBOX LIST"
                    Dim txtBox As CheckBoxList = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), CheckBoxList)
                    If dr.Item("isrequired").ToString() = 1 And txtBox.SelectedItem.Text.Length < 1 Then
                        errormsg &= dispName & ","
                        Continue For
                    End If
                    Dim livalue As String = ""
                    Dim litext As String = ""
                    If UCase(dr.Item("dropdowntype").ToString()) = "FIX VALUED" Then
                        For Each li As ListItem In txtBox.Items
                            If li.Selected Then
                                livalue &= li.Text & ","
                            End If
                        Next
                        livalue = Left(livalue, livalue.Length - 1)
                        'dataField &= "'" & livalue & "',"
                        drnew.Item(dr.Item("displayname")) = livalue
                        DRNEWVAL.Item(dr.Item("displayname")) = livalue
                    Else
                        For Each li As ListItem In txtBox.Items
                            If li.Selected Then
                                livalue &= li.Value & ","
                                litext &= li.Text & ","
                            End If
                        Next
                        livalue = Left(livalue, livalue.Length - 1)
                        drnew.Item(dr.Item("displayname")) = litext
                        DRNEWVAL.Item(dr.Item("displayname")) = livalue
                    End If

                Case "LIST BOX"
                    Dim txtBox As ListBox = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), ListBox)
                    If dr.Item("isrequired").ToString() = 1 And txtBox.SelectedItem.Text.Length < 1 Then
                        errormsg &= dispName & ","
                        Continue For
                    End If
                    Dim livalue As String = ""
                    Dim litext As String = ""
                    If UCase(dr.Item("dropdowntype").ToString()) = "FIX VALUED" Then
                        For Each li As ListItem In txtBox.Items
                            If li.Selected Then
                                livalue &= li.Text & ","
                            End If
                        Next
                        livalue = Left(livalue, livalue.Length - 1)
                        drnew.Item(dr.Item("displayname")) = livalue
                        DRNEWVAL.Item(dr.Item("displayname")) = livalue
                    Else
                        For Each li As ListItem In txtBox.Items
                            If li.Selected Then
                                livalue &= li.Value & ","
                                litext &= li.Text & ","
                            End If
                        Next
                        livalue = Left(livalue, livalue.Length - 1)
                        drnew.Item(dr.Item("displayname")) = litext
                        DRNEWVAL.Item(dr.Item("displayname")) = livalue
                    End If
                Case "TEXT AREA"
                    Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
                    If dr.Item("isrequired").ToString() = 1 And txtBox.Text.Length < 1 Then
                        errormsg &= dispName & ","
                        Continue For
                    End If
                    drnew.Item(dr.Item("displayname")) = OB.getSafeString(txtBox.Text)
                    DRNEWVAL.Item(dr.Item("displayname")) = OB.getSafeString(txtBox.Text)
                    'qryField &= ds.Rows(i).Item("Fieldmapping").ToString() & ","
                    'dataField &= "'" & getSafeString(txtBox.Text) & "',"

                Case "FILE UPLOADER"
                    Dim txtBox As FileUpload = CType(pnlFields1.FindControl("fld" & dr.Item("FieldID").ToString()), FileUpload)
                    'Prashant 30-6-2014
                    Dim txtBox1 As Label = CType(pnlFields1.FindControl("lblf" & dr.Item("FieldID").ToString()), Label)
                    Dim hdn As HiddenField = CType(pnlFields1.FindControl("hdnf" & dr.Item("FieldID").ToString()), HiddenField)
                    txtBox1.Text = hdn.Value

                    If dr.Item("isrequired").ToString() = 1 Then
                        ''Prashant 30 - 6 - 2014
                        If txtBox1.Text IsNot "" Then

                            Dim FN As String = ""
                            Dim ext As String = ""
                            Dim flag As Integer = 0
                            Dim Validext As String = ""

                            Dim sourceFile As String = ""
                            Dim curFileSize As Integer = 0
                            If Not Request.QueryString("TID") Is Nothing Then
                                sourceFile = Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text)
                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text))

                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                curFileSize = finfo.Length
                            Else
                                sourceFile = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))

                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                curFileSize = finfo.Length
                            End If
                            fileSize = fileSize + curFileSize
                            flagFsize = 1

                            FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
                            ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))

                            If IsDBNull(dr.Item("UploadAllowedTypes")) = True OrElse Trim(dr.Item("UploadAllowedTypes")) = "" Then
                            Else
                                Dim type As String() = Split(dr.Item("UploadAllowedTypes").ToString(), ",")

                                For k As Integer = 0 To type.Length - 1
                                    If type(k) = ext Then
                                        flag = 0 ' if file type is match then passed and saved into DB
                                        Exit For
                                    Else
                                        flag = 1 ' check for type of the not matched 
                                        Validext &= type(k).ToString() & ","
                                    End If
                                Next
                                If flag = 0 Then
                                Else
                                    errormsg &= dispName & " attach a valid file with file extension (" & Validext.Substring(0, Validext.Length - 1) & ")" & "," ' upload file is not matched
                                End If

                            End If
                            Try
                                drnew.Item(dr.Item("displayname")) = txtBox1.Text
                                DRNEWVAL.Item(dr.Item("displayname")) = Session("EID").ToString() & "/" & OB.getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dr.Item("FieldID").ToString() & "" & ext
                                File.Copy(sourceFile, Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & OB.getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dr.Item("FieldID").ToString() & ext)
                            Catch ex As Exception
                                errormsg = errormsg & "<br/> error by file uploader." & ex.Message
                            End Try
                        Else
                            errormsg &= dispName & ","
                            Continue For
                        End If


                    Else

                        ''Prashant 30 - 6 - 2014
                        If txtBox1.Text IsNot "" Then
                            Dim FN As String = ""
                            Dim ext As String = ""
                            Dim flag As Integer = 0
                            Dim Validext As String = ""
                            Dim sourceFile As String = ""
                            Dim curFileSize As Integer = 0
                            If Not Request.QueryString("TID") Is Nothing Then
                                sourceFile = Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text)
                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text))

                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                curFileSize = finfo.Length
                            Else
                                sourceFile = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))

                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                curFileSize = finfo.Length
                            End If
                            fileSize = fileSize + curFileSize
                            flagFsize = 1
                            FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
                            ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                            If IsDBNull(dr.Item("UploadAllowedTypes")) = True OrElse Trim(dr.Item("UploadAllowedTypes")) = "" Then
                            Else
                                Dim type As String() = Split(dr.Item("UploadAllowedTypes").ToString(), ",")
                                For k As Integer = 0 To type.Length - 1
                                    If type(k) = ext Then
                                        flag = 0 ' if file type is match then passed and saved into DB
                                        Exit For
                                    Else
                                        flag = 1 ' check for type of the not matched 
                                        Validext &= type(k).ToString() & ","
                                    End If
                                Next
                                If flag = 0 Then
                                Else
                                    errormsg &= dispName & " attach a valid file with file extension (" & Validext.Substring(0, Validext.Length - 1) & ")" & "," ' upload file is not matched
                                End If
                            End If

                            drnew.Item(dr.Item("displayname")) = txtBox1.Text
                            DRNEWVAL.Item(dr.Item("displayname")) = Session("EID").ToString() & "/" & OB.getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dr.Item("FieldID").ToString() & "" & ext
                            File.Copy(sourceFile, HttpContext.Current.Server.MapPath("DOCS/") & HttpContext.Current.Session("EID").ToString() & "/" & OB.getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dr.Item("FieldID").ToString() & ext)
                            ''Prashant End
                        Else
                            drnew.Item(dr.Item("displayname")) = ""
                        End If
                    End If
                Case "CHILD ITEM TOTAL"
                    Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
                    drnew.Item(dr.Item("displayname")) = txtBox.Text
                    DRNEWVAL.Item(dr.Item("displayname")) = txtBox.Text
                Case "CHILD ITEM MAX"
                    Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
                    drnew.Item(dr.Item("displayname")) = txtBox.Text
                    DRNEWVAL.Item(dr.Item("displayname")) = txtBox.Text
            End Select
        Next
        Dim constr As String = ConfigurationManager.ConnectionStrings("constr").ConnectionString
        Dim con As New SqlConnection(constr)
        Dim oda As New SqlDataAdapter("", con)
        'With(nolock) added by Himank on 29th sep 2015
        oda.SelectCommand.CommandText = "select displayName,FieldMapping,KC_LOGIC  from mmm_mst_fields   WITH(NOLOCK)   where FieldType='Formula Field' and eid=" & Session("EID") & " and documenttype='" & FORMNAME & "' and eid=" & Session("EID") & ""
        Dim dt As New DataTable()
        oda.Fill(dt)
        drnew.Item("tid") = FORMNAME & "-" & dtFD.Rows.Count & "-" & ViewState("ID")
        If dt.Rows.Count > 0 Then
            For i As Integer = 0 To dt.Rows.Count - 1
                '  dt.Rows(0)("Value") = ""
                Dim forchexec As String = String.Empty
                Dim formula As New formulaEditor()

                forchexec = formula.executeformulachielditem(dt.Rows(i).Item("KC_LOGIC"), drnew, dtFD)
                drnew.Item(dt.Rows(i).Item("displayName").ToString()) = forchexec
                DRNEWVAL.Item(dt.Rows(i).Item("displayName").ToString()) = forchexec
                ' forchexec = formula.executeformulachielditem(dt.Rows(i).Item("KC_LOGIC"), DRNEWVAL, DTVALUE)
                'DRNEWVAL.Item(dt.Rows(i).Item("displayName").ToString()) = forchexec
            Next
        End If
        '' added  code for file size validation at form lavel by balli
        If flagFsize = 1 And errormsg.Length < 7 Then
            'With(nolock) added by Himank on 29th sep 2015
            oda.SelectCommand.CommandText = "select * from MMM_MST_Forms  WITH(NOLOCK)  where eid=" & Session("EID") & " and formname='" & FORMNAME & "'"
            oda.SelectCommand.CommandType = CommandType.Text
            Dim table As New DataTable
            oda.Fill(table)
            Session("FileSize") = Val(Session("FileSize").ToString()) + fileSize
            If IsDBNull(table.Rows(0).Item("AttahcedFileSize")) = True Then
            Else
                allowedSize = Val(table.Rows(0).Item("AttahcedFileSize").ToString()) * 1024
                If fileSize > allowedSize Then
                    errormsg &= " upload file is maximum than allowed size  " & "," ' upload file is maximum than allowed size
                End If
            End If
            table.Dispose()
        End If

        con.Close()
        dt.Dispose()
        con.Dispose()
        oda.Dispose()


        ''Check Field level Properties
        If errormsg.Length > 15 Then
            'updpnlchild.Update() '' balli added mp
            Label3.Text = errormsg
            Return Label3.Text
            Exit Function
        End If

        ''Check Form Level Validation
        If dtField.Rows.Count > 0 Then
            Dim str As String = OB.validateForm(dtField.Rows(0).Item("Documenttype").ToString, Session("EID"), pnlFields, dtField, "ADD", 0)
            If str.Length > 5 Then
                str = "Please " & str
                Label3.Text = str
                Return Label3.Text
                Exit Function
            End If
        End If

        'Code For Rule Engine By Ajeet Kumar Dated :21-January-2015
        'Creating Collection of main form
        Dim retObj As New RuleResponse()
        Dim lstData As New List(Of UserData)
        Dim dtP As DataTable = Session("PFieldsData")
        lstData = OB.CreateCollection(pnlFields, dtP)
        Dim lstChildData As New List(Of UserData)
        Dim obj As New DynamicForm()
        'obj.CreateCollection(pnlFields, dtField)
        Dim onlyFiltered As DataView = dtField.DefaultView
        onlyFiltered.RowFilter = "InlineEditing='1'"
        Dim dtFields As DataTable = onlyFiltered.Table.DefaultView.ToTable()
        lstChildData = obj.CreateCollection(pnlFields1, dtField)
        'Initialising Rule objects


        Dim objRule As New RuleEngin(Session("EID"), FORMNAME, "CREATED", "Submit")
        Dim dsrule As DataSet = objRule.GetRules()
        Dim dtrule As New DataTable
        dtrule = dsrule.Tables(1)
        For Each dr As DataRow In dsrule.Tables(0).Rows
            retObj = objRule.ExecuteRule(lstData, lstChildData, True, "", dr, dtrule)
            If retObj.Success = False Then
                Label3.Text = retObj.ErrorMessage
                Return retObj.ErrorMessage
            End If
        Next

        ''Code For Rule Engine By Ajeet Kumar Dated :21-January-2015
        ''Creating Collection of main form
        'Dim dtPFields As New DataSet()
        ''dtPFields = CType(Session("PFieldsData"), DataSet)
        'Dim dtTest As DataTable = Session("PFieldsData")
        ''Dim dvp As DataView = CType(Session("PFieldsData"), DataTable).DefaultView
        'Dim lstDatap As New List(Of UserData)
        ''Creating collection for rule engine execution
        'Dim obj As New DynamicForm()
        'lstDatap = obj.CreateCollection(pnlFields, dtTest)

        'Dim dv As DataView = dtField.DefaultView
        'dv.RowFilter = "IsActive=1"
        'Dim theFields As DataTable = dv.ToTable
        'Dim lstData As New List(Of UserData)
        ''Creating collection for rule engine execution
        'lstData = obj.CreateCollection(pnlFields1, theFields)
        ''Creating object of rule response
        'Dim ObjRet As New RuleResponse()
        ''Initialising rule Object
        'Dim ObjRule As New RuleEngin(Session("EID"), dtField.Rows(0).Item("Documenttype").ToString, "CREATED", "SUBMIT")
        ''Uncomment
        'ObjRet = ObjRule.ExecuteRule(lstDatap, lstData, True)
        'If ObjRet.Success = False Then
        '    lblTab1.Text = ObjRet.ErrorMessage
        '    Return ObjRet.ErrorMessage
        '    Exit Function
        'End If
        '' Remove the Total Row from Datatable
        If dtFD.Rows.Count > 1 Then
            dtFD.Rows.RemoveAt(dtFD.Rows.Count - 1)
        End If
        drnew.Item("tid") = FORMNAME & "-" & dtFD.Rows.Count & "-" & ViewState("ID")
        dtFD.Rows.Add(drnew)
        DTVALUE.Rows.Add(DRNEWVAL)
        Session(FORMNAME) = dtFD
        Session(FORMNAME & "VAL") = DTVALUE
        BINDGRID1(dtFD)
        obj.CLEARDYNAMICFIELDS(pnlFields1)
        updpnlchild.Update()
        ModalPopupExtender1.Hide()
        Return Label3.Text
    End Function




    '' above is used when child item's save button is clicked (adds row to grid) by sunil 
    '' bkup by sunil for sh code on 21_nov_14
    'Protected Function ADDITEMTOGRID(ByVal FORMNAME As String) As String
    '    Label3.Text = ""
    '    Dim dtFD As New DataTable
    '    Dim dtField As New DataTable
    '    Dim DTVALUE As New DataTable
    '    Dim fileSize As Integer = 0
    '    Dim allowedSize As Integer = 0
    '    Dim flagFsize As Integer = 0
    '    Dim errormsg As String = "Please "
    '    dtField = ViewState(FORMNAME)
    '    Dim OB As New DynamicForm()
    '    '' OB.ADDITEMTOGRID(dtField, FORMNAME, pnlFields1)
    '    If Session(FORMNAME) Is Nothing Then
    '        For Each dr As DataRow In dtField.Rows
    '            dtFD.Columns.Add(dr.Item("displayname"), GetType(String))
    '            DTVALUE.Columns.Add(dr.Item("Displayname"), GetType(String))
    '        Next
    '        dtFD.Columns.Add("tid", GetType(String))
    '    Else
    '        dtFD = Session(FORMNAME)
    '        DTVALUE = Session(FORMNAME & "VAL")
    '    End If
    '    Dim drnew As DataRow = dtFD.NewRow()
    '    Dim DRNEWVAL As DataRow = DTVALUE.NewRow()
    '    For Each dr As DataRow In dtField.Rows
    '        Dim dispName As String = dr.Item("displayname").ToString()
    '        Select Case dr.Item("FieldType").ToString().ToUpper()
    '            Case "TEXT BOX"
    '                Dim txtBox As TextBox = CType(pnlFields1.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
    '                If dr.Item("isrequired").ToString() = 1 And txtBox.Text.Trim.Length < 1 Then
    '                    errormsg &= dispName & ","

    '                End If
    '                If dr.Item("datatype") = "Datetime" Then
    '                    Dim str1 As String() = Split(txtBox.Text, "/")
    '                    If str1.Length = 3 Then
    '                        Dim strDate1 As String = str1(1) & "/" & str1(0) & "/" & str1(2)
    '                        txtBox.Text = strDate1

    '                    Else
    '                        errormsg &= "Date is not in correct format at " & dispName & ","
    '                        Continue For
    '                    End If
    '                    If Not IsDate(txtBox.Text) Then
    '                        errormsg &= "Date is not in correct format at " & dispName & ","
    '                        Continue For
    '                    Else
    '                        txtBox.Text = Format(Convert.ToDateTime(txtBox.Text.ToString), "dd/MM/yy")
    '                        Dim str As String() = Split(txtBox.Text, "/")
    '                        Dim strDate As String = str(0).PadLeft(2, "0") & "/" & str(1).PadLeft(2, "0") & "/" & str(2).PadLeft(2, "0")
    '                        txtBox.Text = strDate
    '                    End If
    '                End If
    '                If txtBox.Text.Length < CInt(dr.Item("minlen").ToString) And txtBox.Text.Length > 0 And dr.Item("datatype").ToString.ToUpper <> "DATETIME" Then
    '                    errormsg &= "Minimum  " & dr.Item("minlen").ToString() & " character in " & dispName & ","
    '                    Continue For
    '                End If
    '                If txtBox.Text.Length > CInt(dr.Item("maxlen").ToString) And txtBox.Text.Length > 0 And dr.Item("datatype").ToString.ToUpper <> "DATETIME" Then
    '                    errormsg &= "Maximum  " & dr.Item("maxlen").ToString() & " character in " & dispName & ","
    '                    Continue For
    '                End If

    '                If dr.Item("isunique").ToString() = "1" Then
    '                    If OB.checkduplicate("ADD", 0, dr.Item("DBTABLENAME").ToString, dr.Item("Fieldmapping").ToString(), txtBox.Text, dr.Item("DOCUMENTTYPE").ToString) Then
    '                        errormsg &= "unique " & dispName & " ,"
    '                        Exit For
    '                    End If
    '                End If
    '                drnew.Item(dr.Item("displayname")) = txtBox.Text
    '                DRNEWVAL.Item(dr.Item("displayname")) = txtBox.Text

    '            Case "DROP DOWN"
    '                Dim txtBox As DropDownList = CType(pnlFields1.FindControl("fld" & dr.Item("FieldID").ToString()), DropDownList)
    '                If dr.Item("isrequired").ToString() = 1 And txtBox.SelectedItem.Text.ToUpper = "SELECT" Then
    '                    errormsg &= dispName & ","
    '                    Continue For
    '                End If
    '                If UCase(dr.Item("dropdowntype").ToString()) = "FIX VALUED" Then
    '                    drnew.Item(dr.Item("displayname")) = txtBox.SelectedItem.Text
    '                    DRNEWVAL.Item(dr.Item("displayname")) = txtBox.SelectedItem.Value
    '                Else
    '                    'Dim fldpair() As String = txtBox.SelectedValue.ToString().Split("|")
    '                    If dr.Item("lookupvalue").ToString().Length > 2 Then
    '                        Dim fldpair() As String = txtBox.SelectedValue.ToString().Split("|")
    '                        'dataField &= "'" & fldpair(0).ToString() & "',"
    '                        drnew.Item(dr.Item("displayname")) = txtBox.SelectedItem.Text
    '                        DRNEWVAL.Item(dr.Item("displayname")) = fldpair(0).ToString()
    '                    Else
    '                        'dataField &= "'" & txtBox.SelectedValue.ToString() & "',"
    '                        drnew.Item(dr.Item("displayname")) = txtBox.SelectedItem.Text
    '                        DRNEWVAL.Item(dr.Item("displayname")) = txtBox.SelectedItem.Value
    '                    End If
    '                End If
    '            Case "CALCULATIVE FIELD"
    '                Dim txtBox As TextBox = CType(pnlFields1.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
    '                If dr.Item("isrequired").ToString() = 1 And txtBox.Text.Length < 1 Then
    '                    errormsg &= dispName & ","
    '                    Continue For
    '                End If
    '                drnew.Item(dr.Item("displayname")) = txtBox.Text
    '                DRNEWVAL.Item(dr.Item("displayname")) = txtBox.Text
    '            Case "LOOKUP"
    '                Dim txtBox As TextBox = CType(pnlFields1.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
    '                If dr.Item("isrequired").ToString() = 1 And txtBox.Text.Length < 1 Then
    '                    errormsg &= dispName & ","
    '                    Continue For
    '                End If
    '                drnew.Item(dr.Item("displayname")) = txtBox.Text
    '                DRNEWVAL.Item(dr.Item("displayname")) = txtBox.Text
    '            Case "CHECKBOX LIST"
    '                Dim txtBox As CheckBoxList = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), CheckBoxList)
    '                If dr.Item("isrequired").ToString() = 1 And txtBox.SelectedItem.Text.Length < 1 Then
    '                    errormsg &= dispName & ","
    '                    Continue For
    '                End If
    '                Dim livalue As String = ""
    '                Dim litext As String = ""
    '                If UCase(dr.Item("dropdowntype").ToString()) = "FIX VALUED" Then
    '                    For Each li As ListItem In txtBox.Items
    '                        If li.Selected Then
    '                            livalue &= li.Text & ","
    '                        End If
    '                    Next
    '                    livalue = Left(livalue, livalue.Length - 1)
    '                    'dataField &= "'" & livalue & "',"
    '                    drnew.Item(dr.Item("displayname")) = livalue
    '                    DRNEWVAL.Item(dr.Item("displayname")) = livalue
    '                Else
    '                    For Each li As ListItem In txtBox.Items
    '                        If li.Selected Then
    '                            livalue &= li.Value & ","
    '                            litext &= li.Text & ","
    '                        End If
    '                    Next
    '                    livalue = Left(livalue, livalue.Length - 1)
    '                    drnew.Item(dr.Item("displayname")) = litext
    '                    DRNEWVAL.Item(dr.Item("displayname")) = livalue
    '                End If

    '            Case "LIST BOX"
    '                Dim txtBox As ListBox = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), ListBox)
    '                If dr.Item("isrequired").ToString() = 1 And txtBox.SelectedItem.Text.Length < 1 Then
    '                    errormsg &= dispName & ","
    '                    Continue For
    '                End If
    '                Dim livalue As String = ""
    '                Dim litext As String = ""
    '                If UCase(dr.Item("dropdowntype").ToString()) = "FIX VALUED" Then
    '                    For Each li As ListItem In txtBox.Items
    '                        If li.Selected Then
    '                            livalue &= li.Text & ","
    '                        End If
    '                    Next
    '                    livalue = Left(livalue, livalue.Length - 1)
    '                    drnew.Item(dr.Item("displayname")) = livalue
    '                    DRNEWVAL.Item(dr.Item("displayname")) = livalue
    '                Else
    '                    For Each li As ListItem In txtBox.Items
    '                        If li.Selected Then
    '                            livalue &= li.Value & ","
    '                            litext &= li.Text & ","
    '                        End If
    '                    Next
    '                    livalue = Left(livalue, livalue.Length - 1)
    '                    drnew.Item(dr.Item("displayname")) = litext
    '                    DRNEWVAL.Item(dr.Item("displayname")) = livalue
    '                End If
    '            Case "TEXT AREA"
    '                Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
    '                If dr.Item("isrequired").ToString() = 1 And txtBox.Text.Length < 1 Then
    '                    errormsg &= dispName & ","
    '                    Continue For
    '                End If
    '                drnew.Item(dr.Item("displayname")) = OB.getSafeString(txtBox.Text)
    '                DRNEWVAL.Item(dr.Item("displayname")) = OB.getSafeString(txtBox.Text)
    '                'qryField &= ds.Rows(i).Item("Fieldmapping").ToString() & ","
    '                'dataField &= "'" & getSafeString(txtBox.Text) & "',"

    '            Case "FILE UPLOADER"
    '                Dim txtBox As FileUpload = CType(pnlFields1.FindControl("fld" & dr.Item("FieldID").ToString()), FileUpload)

    '                'Prashant 30-6-2014
    '                Dim txtBox1 As Label = CType(pnlFields1.FindControl("lblf" & dr.Item("FieldID").ToString()), Label)

    '                Dim hdn As HiddenField = CType(pnlFields1.FindControl("hdnf" & dr.Item("FieldID").ToString()), HiddenField)
    '                txtBox1.Text = hdn.Value

    '                If dr.Item("isrequired").ToString() = 1 Then
    '                    'If txtBox.HasFile Then
    '                    '    Dim FN As String = ""
    '                    '    Dim ext As String = ""
    '                    '    Dim Validext As String = ""
    '                    '    Dim curFileSize As Integer = txtBox.PostedFile.ContentLength
    '                    '    fileSize = fileSize + curFileSize
    '                    '    flagFsize = 1
    '                    '    Dim flag As Integer = 0
    '                    '    FN = Left(txtBox.FileName, txtBox.FileName.LastIndexOf("."))
    '                    '    ext = txtBox.FileName.Substring(txtBox.FileName.LastIndexOf("."), (txtBox.FileName.Length - txtBox.FileName.LastIndexOf(".")))
    '                    '    If IsDBNull(dr.Item("UploadAllowedTypes")) = True OrElse Trim(dr.Item("UploadAllowedTypes")) = "" Then
    '                    '    Else
    '                    '        Dim type As String() = Split(Trim(dr.Item("UploadAllowedTypes").ToString()), ",")
    '                    '        ' If type.Length 
    '                    '        For k As Integer = 0 To type.Length - 1
    '                    '            If type(k) = ext Then
    '                    '                flag = 0 ' if file type is match then passed and saved into DB
    '                    '                Exit For
    '                    '            Else
    '                    '                flag = 1 ' check for type of the not matched
    '                    '                Validext &= type(k).ToString() & ","
    '                    '            End If
    '                    '        Next
    '                    '        If flag = 0 Then
    '                    '        Else
    '                    '            errormsg &= dispName & " attach a valid file with file extension (" & Validext.Substring(0, Validext.Length - 1) & ")" & "," ' upload file is not matched
    '                    '        End If
    '                    '    End If


    '                    '    drnew.Item(dr.Item("displayname")) = txtBox.FileName
    '                    '    DRNEWVAL.Item(dr.Item("displayname")) = Session("EID").ToString() & "/" & OB.getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dr.Item("FieldID").ToString() & "" & ext
    '                    '    txtBox.SaveAs(HttpContext.Current.Server.MapPath("DOCS/") & HttpContext.Current.Session("EID").ToString() & "/" & OB.getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dr.Item("FieldID").ToString() & ext)


    '                    'Else
    '                    '    errormsg &= dispName & ","
    '                    '    Continue For
    '                    'End If



    '                    ''Prashant 30 - 6 - 2014
    '                    If txtBox1.Text IsNot "" Then

    '                        Dim FN As String = ""
    '                        Dim ext As String = ""
    '                        Dim flag As Integer = 0
    '                        Dim Validext As String = ""

    '                        Dim sourceFile As String = ""
    '                        Dim curFileSize As Integer = 0
    '                        If Not Request.QueryString("TID") Is Nothing Then
    '                            sourceFile = Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text)
    '                            Dim finfo As New FileInfo(Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text))

    '                            ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                            curFileSize = finfo.Length
    '                        Else
    '                            sourceFile = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
    '                            Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))

    '                            ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                            curFileSize = finfo.Length
    '                        End If
    '                        fileSize = fileSize + curFileSize
    '                        flagFsize = 1

    '                        FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
    '                        ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))

    '                        If IsDBNull(dr.Item("UploadAllowedTypes")) = True OrElse Trim(dr.Item("UploadAllowedTypes")) = "" Then
    '                        Else
    '                            Dim type As String() = Split(dr.Item("UploadAllowedTypes").ToString(), ",")

    '                            For k As Integer = 0 To type.Length - 1
    '                                If type(k) = ext Then
    '                                    flag = 0 ' if file type is match then passed and saved into DB
    '                                    Exit For
    '                                Else
    '                                    flag = 1 ' check for type of the not matched 
    '                                    Validext &= type(k).ToString() & ","
    '                                End If
    '                            Next
    '                            If flag = 0 Then
    '                            Else
    '                                errormsg &= dispName & " attach a valid file with file extension (" & Validext.Substring(0, Validext.Length - 1) & ")" & "," ' upload file is not matched
    '                            End If

    '                        End If
    '                        Try
    '                            drnew.Item(dr.Item("displayname")) = txtBox1.Text
    '                            DRNEWVAL.Item(dr.Item("displayname")) = Session("EID").ToString() & "/" & OB.getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dr.Item("FieldID").ToString() & "" & ext
    '                            File.Copy(sourceFile, Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & OB.getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dr.Item("FieldID").ToString() & ext)
    '                        Catch ex As Exception
    '                            errormsg = errormsg & "<br/> error by file uploader." & ex.Message
    '                        End Try
    '                    Else
    '                        errormsg &= dispName & ","
    '                        Continue For
    '                    End If


    '                Else
    '                    'If txtBox.HasFile Then
    '                    '    Dim FN As String = ""
    '                    '    Dim ext As String = ""
    '                    '    Dim flag As Integer = 0
    '                    '    Dim Validext As String = ""
    '                    '    FN = Left(txtBox.FileName, txtBox.FileName.LastIndexOf("."))
    '                    '    ext = txtBox.FileName.Substring(txtBox.FileName.LastIndexOf("."), (txtBox.FileName.Length - txtBox.FileName.LastIndexOf(".")))
    '                    '    ' commented part to check file type allowed By balli
    '                    '    If IsDBNull(dr.Item("UploadAllowedTypes")) = True OrElse Trim(dr.Item("UploadAllowedTypes")) = "" Then
    '                    '    Else
    '                    '        Dim type As String() = Split(dr.Item("UploadAllowedTypes").ToString(), ",")
    '                    '        For k As Integer = 0 To type.Length - 1
    '                    '            If type(k) = ext Then
    '                    '                flag = 0 ' if file type is match then passed and saved into DB
    '                    '                Exit For
    '                    '            Else
    '                    '                flag = 1 ' check for type of the not matched 
    '                    '                Validext &= type(k).ToString() & ","
    '                    '            End If
    '                    '        Next
    '                    '        If flag = 0 Then
    '                    '        Else
    '                    '            errormsg &= dispName & " attach a valid file with file extension (" & Validext.Substring(0, Validext.Length - 1) & ")   " & "," ' upload file is not matched
    '                    '        End If
    '                    '    End If
    '                    '    drnew.Item(dr.Item("displayname")) = txtBox.FileName
    '                    '    DRNEWVAL.Item(dr.Item("displayname")) = Session("EID").ToString() & "/" & OB.getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dr.Item("FieldID").ToString() & "" & ext
    '                    '    txtBox.SaveAs(HttpContext.Current.Server.MapPath("DOCS/") & HttpContext.Current.Session("EID").ToString() & "/" & OB.getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dr.Item("FieldID").ToString() & ext)

    '                    ''Prashant 30 - 6 - 2014
    '                    If txtBox1.Text IsNot "" Then
    '                        Dim FN As String = ""
    '                        Dim ext As String = ""
    '                        Dim flag As Integer = 0
    '                        Dim Validext As String = ""
    '                        Dim sourceFile As String = ""
    '                        Dim curFileSize As Integer = 0
    '                        If Not Request.QueryString("TID") Is Nothing Then
    '                            sourceFile = Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text)
    '                            Dim finfo As New FileInfo(Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text))

    '                            ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                            curFileSize = finfo.Length
    '                        Else
    '                            sourceFile = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
    '                            Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))

    '                            ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                            curFileSize = finfo.Length
    '                        End If
    '                        fileSize = fileSize + curFileSize
    '                        flagFsize = 1
    '                        FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
    '                        ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                        If IsDBNull(dr.Item("UploadAllowedTypes")) = True OrElse Trim(dr.Item("UploadAllowedTypes")) = "" Then
    '                        Else
    '                            Dim type As String() = Split(dr.Item("UploadAllowedTypes").ToString(), ",")
    '                            For k As Integer = 0 To type.Length - 1
    '                                If type(k) = ext Then
    '                                    flag = 0 ' if file type is match then passed and saved into DB
    '                                    Exit For
    '                                Else
    '                                    flag = 1 ' check for type of the not matched 
    '                                    Validext &= type(k).ToString() & ","
    '                                End If
    '                            Next
    '                            If flag = 0 Then
    '                            Else
    '                                errormsg &= dispName & " attach a valid file with file extension (" & Validext.Substring(0, Validext.Length - 1) & ")" & "," ' upload file is not matched
    '                            End If
    '                        End If

    '                        drnew.Item(dr.Item("displayname")) = txtBox1.Text
    '                        DRNEWVAL.Item(dr.Item("displayname")) = Session("EID").ToString() & "/" & OB.getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dr.Item("FieldID").ToString() & "" & ext
    '                        File.Copy(sourceFile, HttpContext.Current.Server.MapPath("DOCS/") & HttpContext.Current.Session("EID").ToString() & "/" & OB.getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dr.Item("FieldID").ToString() & ext)
    '                        ''Prashant End
    '                    Else
    '                        drnew.Item(dr.Item("displayname")) = ""
    '                    End If
    '                End If
    '            Case "CHILD ITEM TOTAL"
    '                Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
    '                drnew.Item(dr.Item("displayname")) = txtBox.Text
    '                DRNEWVAL.Item(dr.Item("displayname")) = txtBox.Text
    '            Case "CHILD ITEM MAX"
    '                Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
    '                drnew.Item(dr.Item("displayname")) = txtBox.Text
    '                DRNEWVAL.Item(dr.Item("displayname")) = txtBox.Text

    '                'Case "SELF REFERENCE"
    '                '    Dim txtBox As Menu = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), Menu)

    '                '    If txtBox.SelectedValue = "0" Then
    '                '    Else
    '                '        drnew.Item(dr.Item("displayname")) = txtBox.SelectedItem.Text
    '                '        DRNEWVAL.Item(dr.Item("displayname")) = txtBox.SelectedItem.Value
    '                '    End If


    '                'Case "PARENT FIELD"
    '                '    Dim txtBox As Menu = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), Menu)

    '                '    If txtBox.SelectedValue = "0" Then
    '                '    Else
    '                '        drnew.Item(dr.Item("displayname")) = txtBox.SelectedItem.Text
    '                '        DRNEWVAL.Item(dr.Item("displayname")) = txtBox.SelectedItem.Value
    '                '    End If
    '        End Select
    '    Next
    '    Dim constr As String = ConfigurationManager.ConnectionStrings("constr").ConnectionString
    '    Dim con As New SqlConnection(constr)
    '    Dim oda As New SqlDataAdapter("", con)
    '    oda.SelectCommand.CommandText = "select displayName,FieldMapping,KC_LOGIC  from mmm_mst_fields  where FieldType='Formula Field' and eid=" & Session("EID") & " and documenttype='" & FORMNAME & "' and eid=" & Session("EID") & ""
    '    Dim dt As New DataTable()
    '    oda.Fill(dt)
    '    drnew.Item("tid") = FORMNAME & "-" & dtFD.Rows.Count & "-" & ViewState("ID")
    '    If dt.Rows.Count > 0 Then
    '        For i As Integer = 0 To dt.Rows.Count - 1
    '            '  dt.Rows(0)("Value") = ""
    '            Dim forchexec As String = String.Empty
    '            Dim formula As New formulaEditor()

    '            forchexec = formula.executeformulachielditem(dt.Rows(i).Item("KC_LOGIC"), drnew, dtFD)
    '            drnew.Item(dt.Rows(i).Item("displayName").ToString()) = forchexec
    '            DRNEWVAL.Item(dt.Rows(i).Item("displayName").ToString()) = forchexec
    '            ' forchexec = formula.executeformulachielditem(dt.Rows(i).Item("KC_LOGIC"), DRNEWVAL, DTVALUE)
    '            'DRNEWVAL.Item(dt.Rows(i).Item("displayName").ToString()) = forchexec
    '        Next
    '    End If
    '    '' added  code for file size validation at form lavel by balli
    '    If flagFsize = 1 And errormsg.Length < 7 Then
    '        oda.SelectCommand.CommandText = "select * from MMM_MST_Forms where eid=" & Session("EID") & " and formname='" & FORMNAME & "'"
    '        oda.SelectCommand.CommandType = CommandType.Text
    '        Dim table As New DataTable
    '        oda.Fill(table)
    '        Session("FileSize") = Val(Session("FileSize").ToString()) + fileSize
    '        If IsDBNull(table.Rows(0).Item("AttahcedFileSize")) = True Then
    '        Else
    '            allowedSize = Val(table.Rows(0).Item("AttahcedFileSize").ToString()) * 1024
    '            If fileSize > allowedSize Then
    '                errormsg &= " upload file is maximum than allowed size  " & "," ' upload file is maximum than allowed size
    '            End If
    '        End If
    '        table.Dispose()
    '    End If

    '    con.Close()
    '    dt.Dispose()
    '    con.Dispose()
    '    oda.Dispose()


    '    ''Check Field level Properties
    '    If errormsg.Length > 15 Then
    '        'updpnlchild.Update() '' balli added mp
    '        Label3.Text = errormsg
    '        Return Label3.Text
    '        Exit Function
    '    End If

    '    ''Check Form Level Validation
    '    If dtField.Rows.Count > 0 Then
    '        Dim str As String = OB.validateForm(dtField.Rows(0).Item("Documenttype").ToString, Session("EID"), pnlFields, dtField, "ADD", 0)
    '        If str.Length > 5 Then
    '            str = "Please " & str
    '            Label3.Text = str
    '            Return Label3.Text
    '            Exit Function
    '        End If
    '    End If

    '    '' Remove the Total Row from Datatable
    '    If dtFD.Rows.Count > 1 Then
    '        dtFD.Rows.RemoveAt(dtFD.Rows.Count - 1)
    '    End If
    '    drnew.Item("tid") = FORMNAME & "-" & dtFD.Rows.Count & "-" & ViewState("ID")
    '    dtFD.Rows.Add(drnew)
    '    DTVALUE.Rows.Add(DRNEWVAL)
    '    Session(FORMNAME) = dtFD
    '    Session(FORMNAME & "VAL") = DTVALUE
    '    BINDGRID1(dtFD)
    '    ModalPopupExtender1.Hide()
    '    Return Label3.Text
    'End Function

    '' above is used for binding grid (adding row to grid) when child item's save button is clicked


    Protected Sub BINDGRID1(ByVal DT As DataTable, Optional ByVal frmname As String = Nothing, Optional ByVal childGridId As String = Nothing)
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim ODA As SqlDataAdapter = New SqlDataAdapter("", con)
        Dim scrname As String = Request.QueryString("SC").ToString()
        Dim DS As New DataSet
        'ODA.SelectCommand.Parameters.Clear()
        'ODA.SelectCommand.CommandText = "uspGetDetailITEM"
        'ODA.SelectCommand.CommandType = CommandType.StoredProcedure
        'ODA.SelectCommand.Parameters.AddWithValue("SID", Session.SessionID)
        'ODA.SelectCommand.Parameters.AddWithValue("FN", Session("FN"))
        'ODA.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
        'DS.Tables.Clear()
        'ODA.Fill(DS, "ITEM")

        Dim dt_item As DataTable = New DataTable()
        dt_item = DT
        ODA.SelectCommand.CommandType = CommandType.Text
        If Not IsNothing(frmname) Then
            'With(nolock) added by Himank on 29th sep 2015
            ODA.SelectCommand.CommandText = "SELECT F1.FieldID,F2.displayName,f1.fieldtype,f1.child_specific_text FROM MMM_MST_FIELDS F1  WITH(NOLOCK)  INNER JOIN MMM_MST_FIELDS F2  WITH(NOLOCK)  ON F1.dropdown =F2.Fieldid  WHERE F1.EID=" & Session("EID") & " and F2.EID=" & Session("EID") & " AND F1.FieldType in ('CHILD ITEM MAX','CHILD ITEM TOTAL')  AND F2.DocumentType ='" & frmname & "' AND F1.DOCUMENTTYPE='" & scrname & "'union all Select FieldID,displayName,fieldtype,child_specific_text from mmm_mst_fields where eid=" & Session("EID") & " and DOCUMENTTYPE='" & scrname & "' and Child_Specific_text is not null"
        Else
            ODA.SelectCommand.CommandText = "SELECT F1.FieldID,F2.displayName,f1.fieldtype,f1.child_specific_text FROM MMM_MST_FIELDS F1   WITH(NOLOCK) INNER JOIN MMM_MST_FIELDS F2   WITH(NOLOCK) ON F1.dropdown =F2.Fieldid  WHERE F1.EID=" & Session("EID") & " and F2.EID=" & Session("EID") & " AND F1.FieldType in ('CHILD ITEM MAX','CHILD ITEM TOTAL')  AND F2.DocumentType ='" & Session("FN") & "' AND F1.DOCUMENTTYPE='" & scrname & "'union all Select FieldID,displayName,fieldtype,child_specific_text from mmm_mst_fields where eid=" & Session("EID") & " and DOCUMENTTYPE='" & scrname & "' and Child_Specific_text is not null"

        End If

        ODA.Fill(DS, "TOTAL")
        ODA.Dispose()
        DS.Dispose()
        Dim OB As New DynamicForm
        ' OB.BINDITEMGRID(dt_item, pnlFields, "BTN" & ViewState("ID"), UpdatePanel1, DS.Tables("TOTAL"))
        'aaaa
        Dim defRows As Integer = -1
        Dim hasDefVal As Integer = -1
        If IsNothing(ViewState("Default")) = False Then
            If ViewState("Default").ToString IsNot "" Then
                Dim ar() As String = ViewState("Default").ToString().Split("_")
                If ar(0).ToString IsNot "" Then
                    defRows = CInt(ar(0))
                End If

                If defRows = 0 Then
                    defRows = -1
                End If
                If Not ar(1).ToString() = "" Then
                    hasDefVal = CInt(ar(1))
                End If

            End If
        End If
        Dim Gid As String = Right(ViewState("ID").ToString(), ViewState("ID").ToString().Length - 3)
        If Not Gid = childGridId Then
            Session("NewChildId") = "BTN" & childGridId
        End If

        OB.BINDITEMGRID(dt_item, pnlFields, ViewState("ID"), UpdatePanel1, DS.Tables("TOTAL"), defRows, hasDefVal, scrname, Session("FN").ToString, Convert.ToInt32(Session("EID")), childGridId)
    End Sub

    'Public Sub bindGrid2(ByVal DS As DataTable, ByRef PNLFIELDS As Panel, ByVal ID As String, ByRef UPD As UpdatePanel)
    '    Dim GID As String = ID
    '    Dim GV As GridView = CType(PNLFIELDS.FindControl("GRD" & GID.ToString()), GridView)
    '    Try
    '        If DS.Rows.Count > 0 Then
    '            GV.DataSource = DS
    '            GV.DataBind()
    '        End If

    '    Catch ex As Exception

    '    End Try
    '    UPD.Update()
    'End Sub

    Protected Sub BINDGRIDTASK(ByVal DT As DataTable)
        Dim GRD As GridView = TryCast(pnlFields.FindControl("GRDCLNDR"), GridView)
        GRD.DataSource = DT
        GRD.DataBind()
        GRD.Caption = "MANAGE TASK"
    End Sub

    Protected Sub DeleteTask(ByVal sender As Object, ByVal e As GridViewCommandEventArgs)
        Dim btnDelete As GridView = TryCast(sender, GridView)
        Dim ID As String = btnDelete.ID
        If e.CommandName = "Delete" Then
            Dim rw As GridViewRow = DirectCast(DirectCast(e.CommandSource, ImageButton).NamingContainer, GridViewRow)
            Dim Pid As String = btnDelete.DataKeys(rw.RowIndex).Value
            Dim dt As DataTable = Session("dtNew")
            dt.Rows(rw.RowIndex).Delete()
            Session("dtNew") = dt
            BINDGRIDTASK(dt)
        End If
    End Sub

    Protected Sub AddTask(ByVal docid As Integer, ByVal doctype As String)
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
        Dim ds As New DataSet
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If
        oda.SelectCommand.CommandType = CommandType.StoredProcedure
        oda.SelectCommand.CommandText = "USP_ADDTASK"
        Dim DT As DataTable = Session("dtNew")
        For Each DR As DataRow In DT.Rows
            oda.SelectCommand.Parameters.Clear()
            oda.SelectCommand.Parameters.AddWithValue("DOCID", docid)
            oda.SelectCommand.Parameters.AddWithValue("DOCTYPE", doctype)
            oda.SelectCommand.Parameters.AddWithValue("UID", DR.Item("UID"))
            oda.SelectCommand.Parameters.AddWithValue("DD", DR.Item("DUE_DATE"))
            oda.SelectCommand.Parameters.AddWithValue("REMARKS", DR.Item("REMARKS"))
            oda.SelectCommand.ExecuteScalar()
        Next
        Session("dtNew") = Nothing
        BINDGRIDTASK(Session("dtNew"))
        oda.Dispose()
        con.Dispose()
    End Sub

    Public Sub addTemplateField(ByVal sender As Object, ByVal e As GridViewRowEventArgs)
        Dim cnt As Integer = e.Row.Cells.Count - 1
        If e.Row.RowType = DataControlRowType.DataRow Then
            If e.Row.Cells(0).Text.ToUpper() = "TOTAL" Then
                e.Row.Font.Bold = True
                e.Row.ForeColor = Drawing.Color.Black
            Else
                Dim img As ImageButton = New ImageButton()
                img.ID = e.Row.Cells(cnt).Text
                img.ImageUrl = "~/images/Cancel.gif"
                img.CommandName = "Delete"
                img.CommandArgument = e.Row.Cells(cnt).Text
                img.Height = Unit.Parse("16")
                img.Width = Unit.Parse("16")
                e.Row.Cells(cnt).Controls.Add(img)
            End If
        ElseIf e.Row.RowType = DataControlRowType.Header Then
            e.Row.Cells(cnt).Text = " "
        End If

    End Sub

    Public Sub DeletedTask()
        'Dim GRD As GridView = TryCast(pnlFields.FindControl("GRDCLNDR"), GridView)
        'GRD.DataSource = Session("dtNew")
        'GRD.DataBind()
        'GRD.Caption = "MANAGE TASK"
    End Sub

    Public Sub parentchild(ByVal cid As Integer, ByVal Pid As Integer)
        Dim DDL As DropDownList = TryCast(pnlFields.FindControl("fld" & Pid), DropDownList)
        If DDL Is Nothing Then
            Exit Sub
        End If
        Dim ddl1 As DropDownList = TryCast(pnlFields1.FindControl("fld" & cid), DropDownList)
        ddl1.Items.Clear()
        ddl1.Items.Insert(0, "Select One")
        ddl1.SelectedIndex = 0
        Dim li As ListItem = DDL.SelectedItem
        Dim tn As String = li.Text
        Dim vl As String = li.Value
        ddl1.Items.Add(tn)
        ddl1.Items(1).Value = vl
        updpnlchild.Update()
    End Sub

    Public Sub parentchild1(ByVal cid As Integer, ByVal Pid As Integer)
        'Dim DDL As DropDownList = TryCast(pnlFields.FindControl("fld" & Pid), DropDownList)
        'If DDL Is Nothing Then
        '    Exit Sub
        'End If
        'ddl1.Items.Clear()
        'Dim li As ListItem = DDL.SelectedItem
        'ddl1.Items.Add(li)
        Dim ddl1 As DropDownList = TryCast(pnlFields1.FindControl("fld" & cid), DropDownList)
        ddl1.Enabled = False
        updpnlchild.Update()
    End Sub

    Public Sub ChildFormddlRenderingOnCreation(ByVal ACTION As Integer)
        Dim c As Control = GetPostBackControl(Me.Page)
        '...
        'If c IsNot Nothing Then
        'End If
        If TypeOf c Is System.Web.UI.WebControls.Button Then

            Dim BTN As Button = TryCast(c, Button)
            If Left(BTN.Text.Trim, 3) = "ADD" Then
                Dim id As String = Right(c.ID, c.ID.Length - 3)
                Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
                Dim con As New SqlConnection(conStr)
                'With(nolock) added by Himank on 29th sep 2015
                Dim oda As SqlDataAdapter = New SqlDataAdapter("Select KC_LOGIC from mmm_mst_fields  WITH(NOLOCK)  where fieldid=" & id & "", con)
                Dim STRKC As String = ""
                If con.State <> ConnectionState.Open Then
                    con.Open()
                End If
                STRKC = oda.SelectCommand.ExecuteScalar().ToString()

                If STRKC <> "" Then
                    Dim FLDS() As String = STRKC.Split("-")
                    If ACTION = 1 Then
                        Dim DDL As DropDownList = TryCast(pnlFields.FindControl("fld" & FLDS(0)), DropDownList)
                        If DDL Is Nothing Then
                            Exit Sub
                        End If
                        If DDL.SelectedIndex = Nothing Then
                            Exit Sub
                        End If
                        Dim ddl1 As DropDownList = TryCast(pnlFields1.FindControl("fld" & FLDS(1)), DropDownList)
                        'ddl1.Items.Clear()
                        'ddl1.Items.Insert(0, "SELECT")
                        'ddl1.Enabled = True
                        'ddl1.SelectedIndex = 0
                        'Dim li As ListItem = DDL.SelectedItem
                        'Dim tn As String = li.Text
                        'Dim vl As String = li.Value
                        'ddl1.Items.Add(tn)
                        'ddl1.Items(1).Value = vl

                        'Change By V 24 Dec
                        If IsNothing(ddl1) Then
                        Else
                            ddl1.Items.Clear()
                        End If
                        'With(nolock) added by Himank on 29th sep 2015
                        oda.SelectCommand.CommandText = "select isEditable,isactive from mmm_mst_fields  WITH(NOLOCK)  where fieldid=" & FLDS(1) & " and eid=" & Session("EID") & ""
                        ' Dim edt As Integer = oda.SelectCommand.ExecuteScalar().ToString
                        Dim dt As New DataTable
                        oda.Fill(dt)
                        If dt.Rows(0).Item(0).ToString = "1" And dt.Rows(0).Item(1).ToString = "1" Then
                            ddl1.Items.Insert(0, "SELECT")
                            ddl1.Enabled = True
                            ddl1.SelectedIndex = 0
                            Dim li As ListItem = DDL.SelectedItem
                            Dim tn As String = li.Text
                            Dim vl As String = li.Value
                            ddl1.Items.Add(tn)
                            ddl1.Items(1).Value = vl
                        ElseIf dt.Rows(0).Item(0).ToString = "0" And dt.Rows(0).Item(1).ToString = "1" Then
                            Dim li As ListItem = DDL.SelectedItem
                            Dim tn As String = li.Text
                            Dim vl As String = li.Value
                            ddl1.Items.Add(tn)
                            ddl1.Items(0).Value = vl
                            ddl1.Enabled = False
                        Else
                        End If
                        updpnlchild.Update()
                    Else
                        Dim ddl1 As DropDownList = TryCast(pnlFields1.FindControl("fld" & FLDS(1)), DropDownList)
                        ddl1.Enabled = False
                    End If
                End If
            End If
        End If
    End Sub

    Public Sub ChildFormddlRendering(ByVal row As DataRow(), ByVal ACTION As Integer)
        Dim c As Control = GetPostBackControl(Me.Page)
        '...
        'If c IsNot Nothing Then
        'End If
        If row.Length > 0 Then
            'If TypeOf c Is System.Web.UI.WebControls.Button Then
            '    Dim BTN As Button = TryCast(c, Button)
            '    If Left(BTN.Text.Trim, 3) = "ADD" Then
            '        Dim id As String = Right(c.ID, c.ID.Length - 3)
            'Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
            'Dim con As New SqlConnection(conStr)
            'Dim oda As SqlDataAdapter = New SqlDataAdapter("Select KC_LOGIC from mmm_mst_fields where fieldid=" & ID & "", con)

            'If con.State <> ConnectionState.Open Then
            '    con.Open()
            'End If
            'STRKC = oda.SelectCommand.ExecuteScalar().ToString()

            Dim STRKC As String = ""

            For i As Integer = 0 To row.Length - 1
                Dim FN As String = row(i).Item("FIELDID").ToString
                If FN.ToString = Session("ID").ToString.Trim Then
                    STRKC = row(i).Item("KC_Logic").ToString
                    If STRKC <> "" Then
                        Dim FLDS() As String = STRKC.Split("-")
                        If ACTION = 1 Then
                            Dim DDL As DropDownList = TryCast(pnlFields.FindControl("fld" & FLDS(0)), DropDownList)
                            If DDL Is Nothing Then
                                Exit Sub
                            End If
                            Dim ddl1 As DropDownList = TryCast(pnlFields1.FindControl("fld" & FLDS(1)), DropDownList)
                            ddl1.Items.Clear()
                            ddl1.Items.Insert(0, "Select One")
                            ddl1.Enabled = True
                            ddl1.SelectedIndex = 0
                            Dim li As ListItem = DDL.SelectedItem
                            Dim tn As String = li.Text
                            Dim vl As String = li.Value
                            ddl1.Items.Add(tn)
                            ddl1.Items(1).Value = vl
                            updpnlchild.Update()
                        Else
                            Dim ddl1 As DropDownList = TryCast(pnlFields1.FindControl("fld" & FLDS(1)), DropDownList)
                            'ddl1.Enabled = False

                            'Change By V 27 Dec
                            If ddl1 Is Nothing Then
                            Else
                                ddl1.Enabled = False
                            End If
                        End If
                    End If
                End If
            Next
        End If
    End Sub

    Public Shared Function GetPostBackControl(ByVal page As Page) As Control
        Dim control As Control = Nothing

        Dim ctrlname As String = page.Request.Params.[Get]("__EVENTTARGET")
        If ctrlname IsNot Nothing AndAlso ctrlname <> String.Empty Then
            control = page.FindControl(ctrlname)
        Else
            For Each ctl As String In page.Request.Form
                Dim c As Control = page.FindControl(ctl)
                If TypeOf c Is System.Web.UI.WebControls.Button Then
                    control = c
                    Exit For
                End If
            Next
        End If
        Return control
    End Function

    'Protected Sub Page_PreLoad(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.PreLoad
    '    If Not Session("CHILD") Is Nothing Then
    '        Dim ROW3() As DataRow = Session("CHILD").Select("fieldtype='DROP DOWN' and dropdowntype='MASTER VALUED' and kc_logic is not null")
    '        If ROW3.Length > 0 Then
    '            For i As Integer = 0 To ROW3.Length - 1
    '                parentchild1(ROW3(i).Item("FIELDID"), CInt(ROW3(i).Item("KC_LOGIC").ToString()))
    '            Next
    '        End If
    '    End If
    'End Sub

    Public Sub Reset(ByVal sender As Object, ByVal e As EventArgs)
        Dim scrname As String = Request.QueryString("SC").ToString()
        Dim str As String = Request.RawUrl
        If str.Contains("&tid=") Then
            str = str.Replace("&tid=" & Request.QueryString("TID").ToString(), "")
        End If
        Response.Redirect(str)
    End Sub

    'Protected Sub SavingChildItem_DV(ByVal formname As String, ByVal docid As Integer, con As SqlConnection, tran As SqlTransaction)  ' this is code for HCL inline editing save code by  balli

    '    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '    Dim ODA As SqlDataAdapter = New SqlDataAdapter("", con)
    '    ODA.SelectCommand.Transaction = tran
    '    Dim dtField As New DataTable
    '    Dim updquery As String = ""
    '    Dim ob As New DynamicForm()
    '    If Session(formname & "VAL") Is Nothing Then
    '        Exit Sub
    '    End If

    '    ' dtField = ViewState(formname)
    '    dtField = Session("D" & formname)
    '    Dim dtvalue As DataTable = Session(formname & "VAL")
    '    If con.State <> ConnectionState.Open Then
    '        con.Open()
    '    End If
    '    'Session("id")
    '    Dim dt As New DataTable
    '    ODA.SelectCommand.CommandText = "select * from mmm_mst_fields where eid=" & Session("eid") & " and documenttype='" & Session("Document") & "' and dropdown='" & formname & "'"
    '    ODA.SelectCommand.CommandType = CommandType.Text
    '    ODA.SelectCommand.Parameters.Clear()
    '    ODA.Fill(dt)

    '    Dim dtTotal As New DataTable
    '    ODA.SelectCommand.CommandType = CommandType.Text
    '    ODA.SelectCommand.CommandText = "SELECT F1.FieldID [MainFieldID],F2.FieldID [ChildFieldID],F2.displayName [CdisplayName],f1.fieldtype [MFIELDTYPE] ,F1.dropdown [mDropDown],F1.displayName [MdisplayName],F1.FieldMapping [MFieldMapping]  FROM MMM_MST_FIELDS F1 INNER JOIN MMM_MST_FIELDS F2 ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType in ('CHILD ITEM MAX','CHILD ITEM TOTAL') AND F2.DocumentType ='" & formname & "' AND F1.DOCUMENTTYPE='" & Session("Document") & "'"
    '    ODA.Fill(dtTotal)

    '    Dim isTotal As Boolean = False
    '    Dim cDispName As String = ""
    '    Dim Childtotal As Double = 0
    '    If dtTotal.Rows.Count = 1 Then
    '        isTotal = True
    '        cDispName = dtTotal.Rows(0).Item("cdisplayname").ToString
    '    End If

    '    'For Each dr As DataRow In DS1.Rows
    '    '    Dim txt As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("Fieldid").ToString()), TextBox)
    '    '    txt.Text = DS.Rows(rowcount - 1).Item(dr.Item("displayname")).ToString()
    '    'Next

    '    Dim GID As String = dt.Rows(0).Item("fieldId").ToString

    '    ' GID = Right(GID, GID.Length - 3)
    '    Dim GV As GridView = CType(pnlFields.FindControl("GRD" & GID.ToString()), GridView)

    '    ' by sunil for maxvalue 
    '    Dim MaxVal As Double = -999

    '    'Prashant_21_7
    '    Dim gridCols As DataTable = GV.DataSource

    '    'Prashant_17_7
    '    Dim LastRow As Integer = 0

    '    If IsNothing(ViewState("LastRow")) = False Then
    '        If ViewState("LastRow").ToString.Trim <> "" Then
    '            LastRow = Convert.ToInt32(ViewState("LastRow"))
    '        Else
    '            LastRow = GV.Rows.Count - 1
    '        End If
    '    Else
    '        LastRow = GV.Rows.Count - 1
    '    End If

    '    'Prashant_17_7

    '    Dim cnt As Integer = 0
    '    For Each GR As GridViewRow In GV.Rows
    '        If GR.RowIndex <= LastRow Then
    '            If GR.RowType = DataControlRowType.DataRow Then
    '                If GR.Cells(0).Text.ToUpper <> "TOTAL" Then
    '                    Dim str As String = "INSERT INTO MMM_MST_DOC_ITEM("
    '                    Dim STRFld As String = ""
    '                    Dim STRVal As String = ""
    '                    updquery = ""


    '                    For j As Integer = 0 To dtField.Rows.Count - 1
    '                        STRFld &= dtField.Rows(j).Item("fieldmapping").ToString & ","  'adding  j+1 for incremental
    '                        Dim colValue As String = ""
    '                        Dim FldID As String = ""

    '                        Dim DispName = dtField.Rows(j).Item("DisplayName").ToString

    '                        FldID = dtField.Rows(j).Item("fieldid").ToString()
    '                        If dtField.Rows(j).Item("inlineediting").ToString = "1" Then
    '                            '' new added for getting child item total
    '                            'If dtField.Rows(j).Item("displayname") = cDispName And dtField.Rows(j).Item("datatype").ToString.ToUpper = "NUMERIC" Then

    '                            ' End If
    '                            '' new for getting child item total 
    '                            Dim ftype As String = dtField.Rows(j).Item("fieldtype").ToString()
    '                            If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Then
    '                                ' Dim cb As TextBox = CType(GR.FindControl("fld" & j.ToString() & "_" & cnt), TextBox)

    '                                'Prashant_21_7
    '                                'If DispName = gridCols.Columns(j).ToString Then

    '                                'End If

    '                                Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & cnt), TextBox)

    '                                If cb IsNot Nothing Then
    '                                    If (ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "LOOKUP") And dtField.Rows(j).Item("datatype").ToString().ToUpper() = "TEXT" Then
    '                                        colValue = getSafeString(cb.Text.ToString)
    '                                    Else
    '                                        colValue = cb.Text.ToString
    '                                    End If
    '                                Else
    '                                    colValue = "0"
    '                                End If

    '                                If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
    '                                    If colValue <> "" Then
    '                                        If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                            Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                        ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                            If Convert.ToDouble(colValue) > MaxVal Then
    '                                                MaxVal = Convert.ToDouble(colValue)
    '                                                Childtotal = MaxVal
    '                                            End If
    '                                        End If
    '                                    End If
    '                                End If
    '                            ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                'Dim cb As New DropDownList
    '                                Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                If cb IsNot Nothing Then
    '                                    colValue = cb.SelectedItem.Text.ToString
    '                                Else
    '                                    colValue = "0"
    '                                End If
    '                            ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdownTYPE") = "MASTER VALUED" Then
    '                                Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                If cb IsNot Nothing Then
    '                                    colValue = cb.SelectedItem.Value.ToString  ' use value bcoz it's mastervalued - needs tid
    '                                Else
    '                                    colValue = "0"
    '                                End If
    '                            ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
    '                                '' here to code for getting file 
    '                                Dim txtBox As FileUpload = CType(GR.FindControl("fld_" & FldID & "_" & cnt), FileUpload)

    '                                'Prashant 
    '                                Dim txtBox1 As Label = CType(GR.FindControl("lblf_" & FldID), Label)

    '                                If txtBox.HasFile Then
    '                                    'Dim FN As String = ""
    '                                    'Dim ext As String = ""
    '                                    'FN = Left(txtBox.FileName, txtBox.FileName.LastIndexOf("."))
    '                                    'ext = txtBox.FileName.Substring(txtBox.FileName.LastIndexOf("."), (txtBox.FileName.Length - txtBox.FileName.LastIndexOf(".")))
    '                                    'colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext
    '                                    'txtBox.SaveAs(Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)
    '                                    ''Prashant
    '                                End If
    '                                If txtBox1.Text IsNot "" Then
    '                                    Dim errormsg As String = ""
    '                                    Dim FN As String = ""
    '                                    Dim ext As String = ""
    '                                    Dim flag As Integer = 0
    '                                    Dim sourceFile As String = ""
    '                                    Dim curFileSize As Integer = 0
    '                                    If Not Request.QueryString("TID") Is Nothing Then
    '                                        sourceFile = Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text)
    '                                        Dim finfo As New FileInfo(Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text))

    '                                        ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                        curFileSize = finfo.Length
    '                                    Else
    '                                        sourceFile = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
    '                                        Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))

    '                                        ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                        curFileSize = finfo.Length
    '                                    End If
    '                                    ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                    FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
    '                                    colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext

    '                                    File.Copy(sourceFile, Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)

    '                                End If
    '                            Else

    '                                For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                    If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                        colValue = GR.Cells(index).Text.ToString()
    '                                        Exit For
    '                                    Else
    '                                        colValue = ""
    '                                    End If
    '                                Next


    '                                If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
    '                                    If colValue <> "" Then
    '                                        If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                            Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                        ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                            If Convert.ToDouble(colValue) > MaxVal Then
    '                                                MaxVal = Convert.ToDouble(colValue)
    '                                                Childtotal = MaxVal
    '                                            End If
    '                                        End If
    '                                    End If
    '                                End If
    '                            End If
    '                        Else  ' if no inline editing 
    '                            If dtField.Rows(j).Item("dropdownTYPE") = "MASTER VALUED" And dtField.Rows(j).Item("fieldtype") = "Drop Down" Then
    '                                '' here code to get tid from session arrays by sp 13-jan-13
    '                                Dim CH() As String = Session("COLHEAD")  ' {}
    '                                Dim txt() As String = Session("DDLTXT") ' {}
    '                                Dim Vals() As String = Session("DDLVAL") '{}
    '                                Dim found As Boolean = False
    '                                Dim searchHdr As String = formname & "_" & dtField.Rows(j).Item("displayname")
    '                                For a As Integer = 0 To CH.Length - 1
    '                                    If CH(a).ToString = searchHdr And txt(a).ToString = GR.Cells(j).Text.ToString() Then ' if match found in array 
    '                                        colValue = Vals(a).ToString
    '                                        found = True
    '                                        Exit For
    '                                    End If
    '                                Next
    '                                If found = False Then
    '                                    'Prashant_21_7
    '                                    For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                        If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                            colValue = dtvalue.Rows(cnt).Item(DispName).ToString()
    '                                            Exit For
    '                                        Else
    '                                            colValue = ""
    '                                        End If
    '                                    Next
    '                                    ' +1 IS ADDED FOR CELL ADJUSTMENT 
    '                                    'Else
    '                                    '    colValue = dtvalue.Rows(cnt).Item(j).ToString() ' added by balli on 2 june 
    '                                End If
    '                                'ElseIf dtField.Rows(j).Item("fieldtype") = "Child Item Total" Then

    '                            Else

    '                                For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                    If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                        colValue = GR.Cells(index).Text.ToString()
    '                                        Exit For
    '                                    Else
    '                                        colValue = ""
    '                                    End If
    '                                Next
    '                                ' +1 IS ADDED FOR CELL ADJUSTMENT 
    '                                If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
    '                                    If colValue <> "" Then
    '                                        If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                            Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                        ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                            If Convert.ToDouble(colValue) > MaxVal Then
    '                                                MaxVal = Convert.ToDouble(colValue)
    '                                                Childtotal = MaxVal
    '                                            End If
    '                                        End If
    '                                    End If
    '                                End If
    '                            End If
    '                        End If
    '                        STRVal &= "'" & colValue & "'" & ","
    '                        ' j = j - 1  ' for cell value  adjustment 


    '                    Next
    '                    ' End If
    '                    'If dtField.Rows(j).Item("KC_VALUE").ToString.Length > 5 And dtField.Rows(j).Item("KC_STATUS").ToString.Length = 0 Then
    '                    ' updquery &= ob.UPDATEKICKING(dtField.Rows(j).Item("KC_VALUE").ToString(), dtvalue.Rows(i).Item(j).ToString(), pnlFields1)
    '                    ' End If
    '                    STRFld &= "DOCID,documenttype,isauth)"
    '                    STRVal &= docid & "," & "'" & formname & "'" & ",1)"
    '                    str &= STRFld & "values(" & STRVal
    '                    ODA.SelectCommand.CommandText = str
    '                    ODA.SelectCommand.ExecuteNonQuery()
    '                    cnt += 1
    '                End If
    '            End If
    '        End If

    '    Next


    '    If isTotal Then
    '        Dim childTotalUpdstr As String = ""
    '        childTotalUpdstr = "UPDATE mmm_mst_doc set " & dtTotal.Rows(0).Item("mFieldMapping").ToString & "=" & Childtotal & " where tid=" & docid

    '        ODA.SelectCommand.CommandType = CommandType.Text
    '        ODA.SelectCommand.CommandText = childTotalUpdstr
    '        ODA.SelectCommand.ExecuteNonQuery()
    '    End If


    '    dt.Dispose()
    '    dtTotal.Dispose()
    '    dtField.Dispose()
    '    dtvalue.Dispose()

    '    Session(formname) = Nothing
    '    Session(formname & "VAL") = Nothing
    '    ODA.Dispose()
    'End Sub

    Protected Sub SavingChildItem_DV(ByVal formname As String, ByVal docid As Integer, con As SqlConnection, tran As SqlTransaction)  ' this is code for HCL inline editing save code by  balli
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim ODA As SqlDataAdapter = New SqlDataAdapter("", con)
        ODA.SelectCommand.Transaction = tran
        Dim dtField As New DataTable
        Dim updquery As String = ""
        Dim flg As Integer = 0
        Dim cmastertid As Integer = 0
        Dim ob As New DynamicForm()
        If Session(formname & "VAL") Is Nothing Then
            Exit Sub
        End If

        ' dtField = ViewState(formname)
        dtField = Session("D" & formname)
        Dim dtvalue As DataTable = Session(formname & "VAL")
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If
        'Session("id")
        Dim dt As New DataTable
        ODA.SelectCommand.CommandText = "select * from mmm_mst_fields where eid=" & Session("eid") & " and documenttype='" & Session("Document") & "' and dropdown='" & formname & "'"
        ODA.SelectCommand.CommandType = CommandType.Text
        ODA.SelectCommand.Parameters.Clear()
        ODA.Fill(dt)

        Dim dtTotal As New DataTable
        ODA.SelectCommand.CommandType = CommandType.Text
        ODA.SelectCommand.CommandText = "SELECT F1.FieldID [MainFieldID],F2.FieldID [ChildFieldID],F2.displayName [CdisplayName],f1.fieldtype [MFIELDTYPE] ,F1.dropdown [mDropDown],F1.displayName [MdisplayName],F1.FieldMapping [MFieldMapping]  FROM MMM_MST_FIELDS F1 INNER JOIN MMM_MST_FIELDS F2 ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType in ('CHILD ITEM MAX','CHILD ITEM TOTAL') AND F2.DocumentType ='" & formname & "' AND F1.DOCUMENTTYPE='" & Session("Document") & "'"
        ODA.Fill(dtTotal)

        Dim isTotal As Boolean = False
        Dim cDispName As String = ""
        Dim Childtotal As Double = 0
        If dtTotal.Rows.Count = 1 Then
            isTotal = True
            cDispName = dtTotal.Rows(0).Item("cdisplayname").ToString
        End If
        'For Each dr As DataRow In DS1.Rows
        '    Dim txt As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("Fieldid").ToString()), TextBox)
        '    txt.Text = DS.Rows(rowcount - 1).Item(dr.Item("displayname")).ToString()
        'Next
        Dim GID As String = dt.Rows(0).Item("fieldId").ToString
        ' GID = Right(GID, GID.Length - 3)
        Dim GV As GridView = CType(pnlFields.FindControl("GRD" & GID.ToString()), GridView)
        ' by sunil for maxvalue 
        Dim MaxVal As Double = -999
        'Prashant_21_7
        Dim gridCols As DataTable = GV.DataSource
        'Prashant_17_7
        Dim LastRow As Integer = 0
        If IsNothing(Session(formname.Replace(" ", "_") & "LastRow")) = False Then
            If Session(formname.Replace(" ", "_") & "LastRow").ToString.Trim <> "" Then
                LastRow = Convert.ToInt32(Session(formname.Replace(" ", "_") & "LastRow"))
            Else
                LastRow = GV.Rows.Count - 1
            End If
        Else
            LastRow = GV.Rows.Count - 1
        End If
        'Prashant_17_7


        ' by balli 
        ' check if child form has rulefilter then exculde or include the records.
        ODA.SelectCommand.CommandText = "select childfilterrule from MMM_MST_Forms where eid=" & Session("EID").ToString() & " and formname='" & formname & "' "
        Dim childitemfilter As String = ODA.SelectCommand.ExecuteScalar.ToString

        Dim cnt As Integer = 0
        For Each GR As GridViewRow In GV.Rows
            Dim FileName As String = String.Empty
            If GR.RowIndex <= LastRow Then
                If GR.RowType = DataControlRowType.DataRow Then
                    If GR.Cells(0).Text.ToUpper <> "TOTAL" Then
                        Dim str As String = "INSERT INTO MMM_MST_DOC_ITEM("
                        Dim STRFld As String = ""
                        Dim STRVal As String = ""
                        updquery = ""

                        Dim cflag As Int16 = 0
                        Dim opr As String = ""
                        Dim ExcludeFlag As Boolean = False
                        Dim cDisName As String()

                        'neha thakar 29/1/15 Code to save chilitems of Detail Form 
                        Dim DICT As New Dictionary(Of Integer, Integer)
                        DICT = CType(Session("AddedRow"), Dictionary(Of Integer, Integer))

                        If Not IsNothing(DICT) Then
                            If Not IsNothing(Session("AddedRow")) And DICT.ContainsKey(GR.RowIndex) Then
                                Dim filterRows() As DataRow
                                filterRows = dtField.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''")
                                If filterRows.Length > 0 Then
                                    dtField = filterRows.CopyToDataTable()
                                End If
                                'dtField = filterRows.CopyToDataTable()
                                For j As Integer = 0 To dtField.Rows.Count - 1
                                    'Dim FileName As String = String.Empty
                                    STRFld &= dtField.Rows(j).Item("fieldmapping").ToString & ","  'adding  j+1 for incremental
                                    Dim colValue As String = ""
                                    Dim FldID As String = ""

                                    Dim DispName = dtField.Rows(j).Item("DisplayName").ToString
                                    FldID = dtField.Rows(j).Item("fieldid").ToString()
                                    '' new for getting child item total 
                                    Dim ftype As String = dtField.Rows(j).Item("fieldtype").ToString()
                                    If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Or ftype.ToUpper = "MULTI LOOKUP" Or ftype.ToUpper = "TEXT AREA" Or ftype.ToUpper = "FORMULA FIELD" Or ftype.ToUpper() = "PARENT VALUE" Or ftype.ToUpper() = "LT LOOKUP" Then
                                        ' Dim cb As TextBox = CType(GR.FindControl("fld" & j.ToString() & "_" & cnt), TextBox)
                                        'Prashant_21_7
                                        'If DispName = gridCols.Columns(j).ToString Then
                                        'End If
                                        Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & cnt), TextBox)
                                        If cb IsNot Nothing Then
                                            If (ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "LOOKUP" Or ftype.ToUpper() = "MULTI LOOKUP" Or ftype.ToUpper = "TEXT AREA" Or ftype.ToUpper = "FORMULA FIELD" Or ftype.ToUpper() = "PARENT VALUE" Or ftype.ToUpper() = "LT LOOKUP") And dtField.Rows(j).Item("datatype").ToString().ToUpper() = "TEXT" Then
                                                colValue = getSafeString(cb.Text.ToString)
                                            Else
                                                colValue = cb.Text.ToString
                                            End If
                                        Else
                                            colValue = "0"
                                        End If
                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
                                            If colValue <> "" Then
                                                If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
                                                ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
                                                    If Convert.ToDouble(colValue) > MaxVal Then
                                                        MaxVal = Convert.ToDouble(colValue)
                                                        Childtotal = MaxVal
                                                    End If
                                                End If
                                            End If
                                        End If
                                    ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
                                        'Dim cb As New DropDownList
                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                        If cb IsNot Nothing Then
                                            colValue = cb.SelectedItem.Text.ToString
                                        Else
                                            colValue = "0"
                                        End If
                                    ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdownTYPE") = "MASTER VALUED" Then
                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                        If cb IsNot Nothing Then
                                            colValue = cb.SelectedItem.Value.ToString  ' use value bcoz it's mastervalued - needs tid
                                        Else
                                            colValue = "0"
                                        End If

                                    ElseIf ftype.ToUpper() = "AUTOCOMPLETE" And dtField.Rows(j).Item("dropdownTYPE") = "MASTER VALUED" Then
                                        Dim cb As HiddenField = CType(GR.FindControl("HDN" & FldID & cnt), HiddenField)
                                        If cb IsNot Nothing Then
                                            colValue = cb.Value.ToString  ' use value bcoz it's mastervalued - needs tid
                                        Else
                                            colValue = "0"
                                        End If

                                    ElseIf ftype.ToUpper() = "LOOKUPDDL" Or ftype.ToUpper() = "MULTI LOOKUPDDL" Then
                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                        If cb IsNot Nothing Then
                                            colValue = cb.SelectedItem.Value.ToString
                                        Else
                                            colValue = "0"
                                        End If
                                    ElseIf ftype.ToUpper() = "CHECKBOX LIST" Then
                                        Dim cb As CheckBoxList = CType(GR.FindControl("fld" & FldID & "_" & cnt), CheckBoxList)
                                        If cb IsNot Nothing Then
                                            For Each item As ListItem In cb.Items
                                                If item.Selected Then
                                                    colValue &= item.Value & ","
                                                End If
                                            Next
                                            If colValue.Length > 0 Then
                                                colValue = colValue.Substring(0, colValue.Length - 1)
                                            End If

                                        Else
                                            colValue = ""
                                        End If
                                    ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
                                        '' here to code for getting file 
                                        Dim txtBox As FileUpload = CType(GR.FindControl("fld_" & FldID & "_" & cnt), FileUpload)

                                        'Prashant 
                                        Dim txtBox1 As Label = CType(GR.FindControl("lblf_" & FldID), Label)

                                        If txtBox.HasFile Then
                                            'Dim FN As String = ""
                                            'Dim ext As String = ""
                                            'FN = Left(txtBox.FileName, txtBox.FileName.LastIndexOf("."))
                                            'ext = txtBox.FileName.Substring(txtBox.FileName.LastIndexOf("."), (txtBox.FileName.Length - txtBox.FileName.LastIndexOf(".")))
                                            'colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext
                                            'txtBox.SaveAs(Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)
                                            ''Prashant
                                        End If
                                        If txtBox1.Text IsNot "" Then
                                            Dim errormsg As String = ""
                                            Dim FN As String = ""
                                            Dim ext As String = ""
                                            Dim flag As Integer = 0
                                            Dim sourceFile As String = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
                                            Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))
                                            Dim curFileSize As Integer = finfo.Length
                                            ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                            FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
                                            colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext

                                            File.Copy(sourceFile, Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)

                                        End If
                                    Else

                                        For index As Integer = 0 To gridCols.Columns.Count - 1
                                            If DispName = gridCols.Columns(index).ColumnName.ToString Then
                                                colValue = GR.Cells(index).Text.ToString()
                                                Exit For
                                            Else
                                                colValue = ""
                                            End If
                                        Next


                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
                                            If colValue <> "" Then
                                                If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
                                                ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
                                                    If Convert.ToDouble(colValue) > MaxVal Then
                                                        MaxVal = Convert.ToDouble(colValue)
                                                        Childtotal = MaxVal
                                                    End If
                                                End If
                                            End If

                                        End If
                                    End If

                                    STRVal &= "'" & colValue & "'" & ","


                                    If childitemfilter.Length > 2 Then
                                        cDisName = childitemfilter.Split("=", "<", ">", ">=", "<=")
                                        cflag = 1
                                    End If
                                    If cflag = 1 Then
                                        If DispName.ToUpper = cDisName(0).ToUpper Then
                                            Dim comparestr As String = Replace(childitemfilter, cDisName(0), "")
                                            comparestr = colValue & comparestr
                                            ExcludeFlag = comparestring(comparestr)
                                        End If
                                    End If


                                Next
                                'neha thakar 29/1/15 

                                If ExcludeFlag = True Or childitemfilter = "" Then
                                    STRFld &= "DOCID,documenttype,isauth,cMasterTID)"
                                    STRVal &= docid & "," & "'" & formname & "'" & ",1,0)"
                                    str &= STRFld & "values(" & STRVal
                                    ODA.SelectCommand.CommandText = str
                                    If con.State <> ConnectionState.Open Then
                                        con.Open()
                                    End If
                                    ODA.SelectCommand.ExecuteNonQuery()
                                    'cnt += 1
                                End If
                                'STRFld &= "DOCID,documenttype,isauth,cMasterTID)"
                                'STRVal &= docid & "," & "'" & formname & "'" & ",1,0)"


                                'str &= STRFld & "values(" & STRVal
                                'ODA.SelectCommand.CommandText = str
                                'ODA.SelectCommand.ExecuteNonQuery()


                            Else
                                Dim filterRows() As DataRow
                                filterRows = dtField.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''")
                                If filterRows.Length > 0 Then
                                    dtField = filterRows.CopyToDataTable()
                                End If
                                'dtField = filterRows.CopyToDataTable()
                                For l As Integer = 0 To dtField.Rows.Count - 1
                                    STRFld &= dtField.Rows(l).Item("fieldmapping").ToString & ","  'adding  j+1 for incremental
                                    Dim colValue As String = ""
                                    Dim FldID As String = ""

                                    Dim DispName = dtField.Rows(l).Item("DisplayName").ToString
                                    FldID = dtField.Rows(l).Item("fieldid").ToString()



                                    If dtField.Rows(l).Item("inlineediting").ToString = "1" Then
                                        '' new added for getting child item total
                                        'If dtField.Rows(j).Item("displayname") = cDispName And dtField.Rows(j).Item("datatype").ToString.ToUpper = "NUMERIC" Then

                                        ' End If
                                        '' new for getting child item total 
                                        Dim ftype As String = dtField.Rows(l).Item("fieldtype").ToString()
                                        If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Or ftype.ToUpper = "TEXT AREA" Or ftype.ToUpper = "FORMULA FIELD" Or ftype.ToUpper() = "PARENT VALUE" Then
                                            ' Dim cb As TextBox = CType(GR.FindControl("fld" & j.ToString() & "_" & cnt), TextBox)
                                            'Prashant_21_7
                                            'If DispName = gridCols.Columns(j).ToString Then
                                            'End If
                                            Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & cnt), TextBox)
                                            If cb IsNot Nothing Then
                                                If (ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "LOOKUP" Or ftype.ToUpper = "TEXT AREA" Or ftype.ToUpper = "FORMULA FIELD" Or ftype.ToUpper() = "PARENT VALUE") And dtField.Rows(l).Item("datatype").ToString().ToUpper() = "TEXT" Then
                                                    colValue = getSafeString(cb.Text.ToString)
                                                Else
                                                    colValue = cb.Text.ToString
                                                End If
                                            Else
                                                colValue = "0"
                                            End If
                                            If dtField.Rows(l).Item("displayname") = cDispName Then  '' new for getting child total
                                                If colValue <> "" Then
                                                    If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
                                                        Childtotal = Childtotal + Convert.ToDouble(colValue)
                                                    ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
                                                        If Convert.ToDouble(colValue) > MaxVal Then
                                                            MaxVal = Convert.ToDouble(colValue)
                                                            Childtotal = MaxVal
                                                        End If
                                                    End If
                                                End If
                                            End If
                                        ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(l).Item("dropdowntype").ToString() = "FIX VALUED" Then
                                            'Dim cb As New DropDownList
                                            Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                            If cb IsNot Nothing Then
                                                colValue = cb.SelectedItem.Text.ToString
                                            Else
                                                colValue = "0"
                                            End If
                                        ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(l).Item("dropdownTYPE") = "MASTER VALUED" Then
                                            Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                            If cb IsNot Nothing Then
                                                colValue = cb.SelectedItem.Value.ToString  ' use value bcoz it's mastervalued - needs tid
                                            Else
                                                colValue = "0"
                                            End If

                                        ElseIf ftype.ToUpper() = "AUTOCOMPLETE" And dtField.Rows(l).Item("dropdownTYPE") = "MASTER VALUED" Then
                                            Dim cb As HiddenField = CType(GR.FindControl("HDN" & FldID & cnt), HiddenField)
                                            If cb IsNot Nothing Then
                                                colValue = cb.Value.ToString  ' use value bcoz it's mastervalued - needs tid
                                            Else
                                                colValue = "0"
                                            End If

                                        ElseIf ftype.ToUpper() = "CHECKBOX LIST" Then
                                            Dim cb As CheckBoxList = CType(GR.FindControl("fld" & FldID & "_" & cnt), CheckBoxList)
                                            If cb IsNot Nothing Then
                                                For Each item As ListItem In cb.Items
                                                    If item.Selected Then
                                                        colValue &= item.Value & ","
                                                    End If
                                                Next
                                                If colValue.Length > 0 Then
                                                    colValue = colValue.Substring(0, colValue.Length - 1)
                                                End If
                                            Else
                                                colValue = ""
                                            End If

                                        ElseIf ftype.ToUpper() = "LOOKUPDDL" Or ftype.ToUpper() = "MULTI LOOKUPDDL" Then
                                            Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                            If cb IsNot Nothing Then
                                                colValue = cb.SelectedItem.Value.ToString
                                            Else
                                                colValue = "0"
                                            End If
                                        ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
                                            '' here to code for getting file 
                                            Dim txtBox As FileUpload = CType(GR.FindControl("fld_" & FldID & "_" & cnt), FileUpload)

                                            'Prashant 
                                            Dim txtBox1 As Label = CType(GR.FindControl("lblf_" & FldID), Label)

                                            If txtBox.HasFile Then
                                                'Dim FN As String = ""
                                                'Dim ext As String = ""
                                                'FN = Left(txtBox.FileName, txtBox.FileName.LastIndexOf("."))
                                                'ext = txtBox.FileName.Substring(txtBox.FileName.LastIndexOf("."), (txtBox.FileName.Length - txtBox.FileName.LastIndexOf(".")))
                                                'colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext
                                                'txtBox.SaveAs(Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)
                                                ''Prashant
                                            End If
                                            If txtBox1.Text IsNot "" Then
                                                Dim errormsg As String = ""
                                                Dim FN As String = ""
                                                Dim ext As String = ""
                                                Dim flag As Integer = 0
                                                Try
                                                    Dim o As JObject = JObject.Parse(txtBox1.Text)
                                                    Dim name As String() = CType(o("result"), String).Split("|")
                                                    Dim sourceFile As String = Server.MapPath("~/DOCS/temp/" + name(0))
                                                    Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + name(0)))
                                                    Dim curFileSize As Integer = finfo.Length
                                                    ext = name(0).Substring(name(0).LastIndexOf("."), name(0).Length - name(0).LastIndexOf("."))
                                                    FN = Left(name(0), name(0).LastIndexOf("."))
                                                    Dim partofPath As String = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(l).Item("FieldID").ToString() & "" & ext
                                                    colValue = partofPath
                                                    STRFld &= "attachment,"
                                                    FileName = name(1).ToString()
                                                    File.Copy(sourceFile, Server.MapPath("DOCS/") & partofPath)
                                                Catch ex As Exception
                                                    Dim sourceFile As String = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
                                                    Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))
                                                    Dim curFileSize As Integer = finfo.Length
                                                    'ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                                    ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                                    FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
                                                    Dim partofPath As String = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(l).Item("FieldID").ToString() & "" & ext
                                                    colValue = partofPath
                                                    File.Copy(sourceFile, Server.MapPath("DOCS/") & partofPath)
                                                End Try
                                                'Dim sourceFile As String = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
                                                'Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))
                                                'Dim curFileSize As Integer = finfo.Length
                                                'ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                                'FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
                                                'colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(l).Item("FieldID").ToString() & "" & ext

                                                'File.Copy(sourceFile, Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(l).Item("FieldID").ToString() & ext)

                                            End If
                                        Else

                                            For index As Integer = 0 To gridCols.Columns.Count - 1
                                                If DispName = gridCols.Columns(index).ColumnName.ToString Then
                                                    colValue = GR.Cells(index).Text.ToString()
                                                    Exit For
                                                Else
                                                    colValue = ""
                                                End If
                                            Next


                                            If dtField.Rows(l).Item("displayname") = cDispName Then  '' new for getting child total
                                                If colValue <> "" Then
                                                    If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
                                                        Childtotal = Childtotal + Convert.ToDouble(colValue)
                                                    ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
                                                        If Convert.ToDouble(colValue) > MaxVal Then
                                                            MaxVal = Convert.ToDouble(colValue)
                                                            Childtotal = MaxVal
                                                        End If
                                                    End If
                                                End If
                                            End If
                                        End If
                                    Else  ' if no inline editing 
                                        If dtField.Rows(l).Item("dropdownTYPE") = "MASTER VALUED" And dtField.Rows(l).Item("fieldtype") = "Drop Down" Then
                                            '' here code to get tid from session arrays by sp 13-jan-13
                                            Dim CH() As String = Session("COLHEAD")  ' {}
                                            Dim txt() As String = Session("DDLTXT") ' {}
                                            Dim Vals() As String = Session("DDLVAL") '{}
                                            Dim found As Boolean = False
                                            Dim searchHdr As String = formname & "_" & dtField.Rows(l).Item("displayname")
                                            For a As Integer = 0 To CH.Length - 1
                                                If CH(a).ToString = searchHdr And txt(a).ToString = GR.Cells(l).Text.ToString() Then ' if match found in array 
                                                    colValue = Vals(a).ToString
                                                    found = True
                                                    Exit For
                                                End If

                                            Next
                                            If found = False Then
                                                'Prashant_21_7
                                                For index As Integer = 0 To gridCols.Columns.Count - 1
                                                    If DispName = gridCols.Columns(index).ColumnName.ToString Then
                                                        colValue = gridCols.Rows(cnt).Item(DispName).ToString()
                                                        Exit For
                                                    Else
                                                        colValue = ""
                                                    End If
                                                Next
                                                ' +1 IS ADDED FOR CELL ADJUSTMENT 
                                                'Else
                                                '    colValue = dtvalue.Rows(cnt).Item(j).ToString() ' added by balli on 2 june 
                                            End If
                                            'ElseIf dtField.Rows(j).Item("fieldtype") = "Child Item Total" Then

                                        Else

                                            For index As Integer = 0 To gridCols.Columns.Count - 1
                                                If DispName = gridCols.Columns(index).ColumnName.ToString Then
                                                    colValue = GR.Cells(index).Text.ToString()
                                                    Exit For
                                                Else
                                                    colValue = ""
                                                End If
                                            Next
                                            ' +1 IS ADDED FOR CELL ADJUSTMENT 
                                            If dtField.Rows(l).Item("displayname") = cDispName Then  '' new for getting child total
                                                If colValue <> "" Then
                                                    If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
                                                        Childtotal = Childtotal + Convert.ToDouble(colValue)
                                                    ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
                                                        If Convert.ToDouble(colValue) > MaxVal Then
                                                            MaxVal = Convert.ToDouble(colValue)
                                                            Childtotal = MaxVal
                                                        End If
                                                    End If
                                                End If
                                            End If
                                        End If
                                    End If

                                    'STRVal &= "'" & colValue & "'" & ","
                                    If String.IsNullOrEmpty(FileName) Then
                                        STRVal &= "'" & colValue & "'" & ","
                                    Else
                                        STRVal &= "'" & colValue & "'" & "," & "'" & FileName.ToString() & "',"
                                    End If
                                    FileName = String.Empty
                                    If childitemfilter.Length > 2 Then
                                        cDisName = childitemfilter.Split("=", "<", ">", ">=", "<=")
                                        cflag = 1
                                    End If
                                    If cflag = 1 Then
                                        If DispName.ToUpper = cDisName(0).ToUpper Then
                                            Dim comparestr As String = Replace(childitemfilter, cDisName(0), "")
                                            comparestr = colValue & comparestr
                                            ExcludeFlag = comparestring(comparestr)
                                        End If
                                    End If
                                Next
                                For index As Integer = 0 To gridCols.Columns.Count - 1
                                    If gridCols.Columns(index).ColumnName.ToString.ToUpper = "CMASTERTID" Then
                                        cmastertid = GR.Cells(index).Text.ToString()
                                        flg = 1
                                        Exit For
                                    End If
                                Next
                                If flg = 1 Then
                                    STRFld &= "DOCID,documenttype,isauth,cMasterTID)"
                                    STRVal &= docid & "," & "'" & formname & "'" & ",1," & cmastertid & ")"
                                Else
                                    STRFld &= "DOCID,documenttype,isauth,cMasterTID)"
                                    STRVal &= docid & "," & "'" & formname & "'" & ",1,0)"
                                End If


                                If ExcludeFlag = True Or childitemfilter = "" Then
                                    str &= STRFld & "values(" & STRVal
                                    ODA.SelectCommand.CommandText = str
                                    If con.State <> ConnectionState.Open Then
                                        con.Open()
                                    End If
                                    ODA.SelectCommand.ExecuteNonQuery()
                                    'cnt += 1
                                End If
                                'str &= STRFld & "values(" & STRVal
                                'ODA.SelectCommand.CommandText = str
                                'ODA.SelectCommand.ExecuteNonQuery()
                            End If
                            ' End If
                            'If dtField.Rows(j).Item("KC_VALUE").ToString.Length > 5 And dtField.Rows(j).Item("KC_STATUS").ToString.Length = 0 Then
                            ' updquery &= ob.UPDATEKICKING(dtField.Rows(j).Item("KC_VALUE").ToString(), dtvalue.Rows(i).Item(j).ToString(), pnlFields1)
                            ' End If
                        Else
                            Dim filterRows() As DataRow
                            filterRows = dtField.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''")
                            If filterRows.Length > 0 Then
                                dtField = filterRows.CopyToDataTable()
                            End If
                            'dtField = filterRows.CopyToDataTable()
                            For l As Integer = 0 To dtField.Rows.Count - 1
                                STRFld &= dtField.Rows(l).Item("fieldmapping").ToString & ","  'adding  j+1 for incremental
                                Dim colValue As String = ""
                                Dim FldID As String = ""
                                Dim DispName = dtField.Rows(l).Item("DisplayName").ToString
                                FldID = dtField.Rows(l).Item("fieldid").ToString()
                                If dtField.Rows(l).Item("inlineediting").ToString = "1" Then
                                    '' new added for getting child item total
                                    'If dtField.Rows(j).Item("displayname") = cDispName And dtField.Rows(j).Item("datatype").ToString.ToUpper = "NUMERIC" Then

                                    ' End If
                                    '' new for getting child item total 
                                    Dim ftype As String = dtField.Rows(l).Item("fieldtype").ToString()
                                    If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Or ftype.ToUpper() = "MULTI LOOKUP" Or ftype.ToUpper = "TEXT AREA" Or ftype.ToUpper = "FORMULA FIELD" Or ftype.ToUpper() = "PARENT VALUE" Or ftype.ToUpper() = "LT LOOKUP" Then
                                        ' Dim cb As TextBox = CType(GR.FindControl("fld" & j.ToString() & "_" & cnt), TextBox)
                                        'Prashant_21_7
                                        'If DispName = gridCols.Columns(j).ToString Then
                                        'End If
                                        Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & cnt), TextBox)
                                        If cb IsNot Nothing Then
                                            If (ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "LOOKUP" Or ftype.ToUpper() = "MULTI LOOKUP" Or ftype.ToUpper = "TEXT AREA" Or ftype.ToUpper = "FORMULA FIELD" Or ftype.ToUpper() = "PARENT VALUE" Or ftype.ToUpper() = "LT LOOKUP") And dtField.Rows(l).Item("datatype").ToString().ToUpper() = "TEXT" Then
                                                colValue = getSafeString(cb.Text.ToString)
                                            Else
                                                colValue = cb.Text.ToString
                                            End If
                                        Else
                                            colValue = "0"
                                        End If
                                        If dtField.Rows(l).Item("displayname") = cDispName Then  '' new for getting child total
                                            If colValue <> "" Then
                                                If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
                                                ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
                                                    If Convert.ToDouble(colValue) > MaxVal Then
                                                        MaxVal = Convert.ToDouble(colValue)
                                                        Childtotal = MaxVal
                                                    End If
                                                End If
                                            End If
                                        End If
                                    ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(l).Item("dropdowntype").ToString() = "FIX VALUED" Then
                                        'Dim cb As New DropDownList
                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                        If cb IsNot Nothing Then
                                            colValue = cb.SelectedItem.Text.ToString
                                        Else
                                            colValue = "0"
                                        End If
                                    ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(l).Item("dropdownTYPE") = "MASTER VALUED" Then
                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                        If cb IsNot Nothing Then
                                            colValue = cb.SelectedItem.Value.ToString  ' use value bcoz it's mastervalued - needs tid
                                        Else
                                            colValue = "0"
                                        End If
                                    ElseIf ftype.ToUpper() = "AUTOCOMPLETE" And dtField.Rows(l).Item("dropdownTYPE") = "MASTER VALUED" Then
                                        Dim cb As HiddenField = CType(GR.FindControl("HDN" & FldID & cnt), HiddenField)
                                        If cb IsNot Nothing Then
                                            colValue = cb.Value.ToString  ' use value bcoz it's mastervalued - needs tid
                                        Else
                                            colValue = "0"
                                        End If


                                    ElseIf ftype.ToUpper() = "CHECKBOX LIST" Then
                                        Dim cb As CheckBoxList = CType(GR.FindControl("fld" & FldID & "_" & cnt), CheckBoxList)
                                        If cb IsNot Nothing Then
                                            For Each item As ListItem In cb.Items
                                                If item.Selected Then
                                                    colValue &= item.Value & ","
                                                End If
                                            Next
                                            If colValue.Length > 0 Then
                                                colValue = colValue.Substring(0, colValue.Length - 1)
                                            End If
                                        Else
                                            colValue = ""
                                        End If
                                    ElseIf ftype.ToUpper() = "LOOKUPDDL" Or ftype.ToUpper() = "MULTI LOOKUPDDL" Then
                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                        If cb IsNot Nothing Then
                                            colValue = cb.SelectedItem.Value.ToString
                                        Else
                                            colValue = "0"
                                        End If
                                    ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
                                        '' here to code for getting file 
                                        Dim txtBox As FileUpload = CType(GR.FindControl("fld_" & FldID & "_" & cnt), FileUpload)
                                        'Prashant 
                                        Dim txtBox1 As Label = CType(GR.FindControl("lblf_" & FldID), Label)
                                        If txtBox.HasFile Then
                                            'Dim FN As String = ""
                                            'Dim ext As String = ""
                                            'FN = Left(txtBox.FileName, txtBox.FileName.LastIndexOf("."))
                                            'ext = txtBox.FileName.Substring(txtBox.FileName.LastIndexOf("."), (txtBox.FileName.Length - txtBox.FileName.LastIndexOf(".")))
                                            'colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext
                                            'txtBox.SaveAs(Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)
                                            ''Prashant
                                        End If
                                        If txtBox1.Text IsNot "" Then
                                            Dim errormsg As String = ""
                                            Dim FN As String = ""
                                            Dim ext As String = ""
                                            Dim flag As Integer = 0
                                            Try
                                                Dim o As JObject = JObject.Parse(txtBox1.Text)
                                                Dim name As String() = CType(o("result"), String).Split("|")
                                                Dim sourceFile As String = Server.MapPath("~/DOCS/temp/" + name(0))
                                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + name(0)))
                                                Dim curFileSize As Integer = finfo.Length
                                                ext = name(0).Substring(name(0).LastIndexOf("."), name(0).Length - name(0).LastIndexOf("."))
                                                FN = Left(name(0), name(0).LastIndexOf("."))
                                                Dim partOfPath As String = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(l).Item("FieldID").ToString() & "" & ext
                                                colValue = partOfPath
                                                FileName = name(1)
                                                STRFld &= "attachment,"
                                                File.Copy(sourceFile, Server.MapPath("DOCS/") & partOfPath)
                                            Catch ex As Exception
                                                Dim sourceFile As String = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
                                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))
                                                Dim curFileSize As Integer = finfo.Length
                                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                                FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
                                                Dim partOfPath As String = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(l).Item("FieldID").ToString() & "" & ext
                                                colValue = partOfPath
                                                File.Copy(sourceFile, Server.MapPath("DOCS/") & partOfPath)
                                            End Try
                                        End If
                                    Else
                                        For index As Integer = 0 To gridCols.Columns.Count - 1
                                            If DispName = gridCols.Columns(index).ColumnName.ToString Then
                                                colValue = GR.Cells(index).Text.ToString()
                                                Exit For
                                            Else
                                                colValue = ""
                                            End If
                                        Next


                                        If dtField.Rows(l).Item("displayname") = cDispName Then  '' new for getting child total
                                            If colValue <> "" Then
                                                If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
                                                ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
                                                    If Convert.ToDouble(colValue) > MaxVal Then
                                                        MaxVal = Convert.ToDouble(colValue)
                                                        Childtotal = MaxVal
                                                    End If
                                                End If
                                            End If
                                        End If
                                    End If
                                Else  ' if no inline editing 
                                    If dtField.Rows(l).Item("dropdownTYPE") = "MASTER VALUED" And dtField.Rows(l).Item("fieldtype") = "Drop Down" Then
                                        '' here code to get tid from session arrays by sp 13-jan-13
                                        Dim CH() As String = Session("COLHEAD")  ' {}
                                        Dim txt() As String = Session("DDLTXT") ' {}
                                        Dim Vals() As String = Session("DDLVAL") '{}
                                        Dim found As Boolean = False
                                        Dim searchHdr As String = formname & "_" & dtField.Rows(l).Item("displayname")
                                        For a As Integer = 0 To CH.Length - 1
                                            If CH(a).ToString = searchHdr And txt(a).ToString = GR.Cells(l).Text.ToString() Then ' if match found in array 
                                                colValue = Vals(a).ToString
                                                found = True
                                                Exit For
                                            End If

                                        Next
                                        If found = False Then
                                            'Prashant_21_7
                                            For index As Integer = 0 To gridCols.Columns.Count - 1
                                                If DispName = gridCols.Columns(index).ColumnName.ToString Then
                                                    colValue = gridCols.Rows(cnt).Item(DispName).ToString()
                                                    Exit For
                                                Else
                                                    colValue = ""
                                                End If
                                            Next
                                            ' +1 IS ADDED FOR CELL ADJUSTMENT 
                                            'Else
                                            '    colValue = dtvalue.Rows(cnt).Item(j).ToString() ' added by balli on 2 june 
                                        End If
                                        'ElseIf dtField.Rows(j).Item("fieldtype") = "Child Item Total" Then

                                    Else

                                        For index As Integer = 0 To gridCols.Columns.Count - 1
                                            If DispName = gridCols.Columns(index).ColumnName.ToString Then
                                                colValue = GR.Cells(index).Text.ToString()
                                                Exit For
                                            Else
                                                colValue = ""
                                            End If
                                        Next
                                        ' +1 IS ADDED FOR CELL ADJUSTMENT 
                                        If dtField.Rows(l).Item("displayname") = cDispName Then  '' new for getting child total
                                            If colValue <> "" Then
                                                If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
                                                ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
                                                    If Convert.ToDouble(colValue) > MaxVal Then
                                                        MaxVal = Convert.ToDouble(colValue)
                                                        Childtotal = MaxVal
                                                    End If
                                                End If
                                            End If
                                        End If
                                    End If
                                End If

                                If Not String.IsNullOrEmpty(FileName) Then
                                    STRVal &= "'" & colValue & "'" & ",'" & FileName.ToString() & "',"
                                Else
                                    STRVal &= "'" & colValue & "'" & ","
                                End If
                                If childitemfilter.Length > 2 Then
                                    cDisName = childitemfilter.Split("=", "<", ">", ">=", "<=")
                                    cflag = 1
                                End If
                                If cflag = 1 Then
                                    If DispName.ToUpper = cDisName(0).ToUpper Then
                                        Dim comparestr As String = Replace(childitemfilter, cDisName(0), "")
                                        comparestr = colValue & comparestr
                                        ExcludeFlag = comparestring(comparestr)
                                    End If
                                End If
                            Next
                            For index As Integer = 0 To gridCols.Columns.Count - 1

                                If gridCols.Columns(index).ColumnName.ToString.ToUpper = "CMASTERTID" Then
                                    cmastertid = GR.Cells(index).Text.ToString()
                                    flg = 1
                                    Exit For
                                End If
                            Next
                            If flg = 1 Then
                                STRFld &= "DOCID,documenttype,isauth,cMasterTID)"
                                STRVal &= docid & "," & "'" & formname & "'" & ",1," & cmastertid & ")"
                            Else
                                STRFld &= "DOCID,documenttype,isauth,cMasterTID)"
                                STRVal &= docid & "," & "'" & formname & "'" & ",1,0)"
                            End If

                            If ExcludeFlag = True Or childitemfilter = "" Then
                                str &= STRFld & "values(" & STRVal
                                ODA.SelectCommand.CommandText = str
                                If con.State <> ConnectionState.Open Then
                                    con.Open()
                                End If
                                ODA.SelectCommand.ExecuteNonQuery()
                                'cnt += 1
                            End If
                            'str &= STRFld & "values(" & STRVal
                            'ODA.SelectCommand.CommandText = str
                            'ODA.SelectCommand.ExecuteNonQuery()
                        End If

                    End If
                End If
            End If
            cnt += 1
            flg = 0
        Next
        If isTotal Then
            Dim childTotalUpdstr As String = ""
            childTotalUpdstr = "UPDATE mmm_mst_doc set " & dtTotal.Rows(0).Item("mFieldMapping").ToString & "=" & Childtotal & " where tid=" & docid

            ODA.SelectCommand.CommandType = CommandType.Text
            ODA.SelectCommand.CommandText = childTotalUpdstr
            ODA.SelectCommand.ExecuteNonQuery()
        End If

        dt.Dispose()
        dtTotal.Dispose()
        dtField.Dispose()
        dtvalue.Dispose()

        Session(formname) = Nothing
        Session(formname & "VAL") = Nothing
        ODA.Dispose()
    End Sub


    '' commentted on 2 apil 2015
    'Protected Sub SavingChildItem_DV(ByVal formname As String, ByVal docid As Integer, con As SqlConnection, tran As SqlTransaction)  ' this is code for HCL inline editing save code by  balli

    '    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '    Dim ODA As SqlDataAdapter = New SqlDataAdapter("", con)
    '    ODA.SelectCommand.Transaction = tran
    '    Dim dtField As New DataTable
    '    Dim updquery As String = ""
    '    Dim flg As Integer = 0
    '    Dim cmastertid As Integer = 0
    '    Dim ob As New DynamicForm()
    '    If Session(formname & "VAL") Is Nothing Then
    '        Exit Sub
    '    End If

    '    ' dtField = ViewState(formname)
    '    dtField = Session("D" & formname)
    '    Dim dtvalue As DataTable = Session(formname & "VAL")
    '    If con.State <> ConnectionState.Open Then
    '        con.Open()
    '    End If
    '    'Session("id")
    '    Dim dt As New DataTable
    '    ODA.SelectCommand.CommandText = "select * from mmm_mst_fields where eid=" & Session("eid") & " and documenttype='" & Session("Document") & "' and dropdown='" & formname & "'"
    '    ODA.SelectCommand.CommandType = CommandType.Text
    '    ODA.SelectCommand.Parameters.Clear()
    '    ODA.Fill(dt)

    '    Dim dtTotal As New DataTable
    '    ODA.SelectCommand.CommandType = CommandType.Text
    '    ODA.SelectCommand.CommandText = "SELECT F1.FieldID [MainFieldID],F2.FieldID [ChildFieldID],F2.displayName [CdisplayName],f1.fieldtype [MFIELDTYPE] ,F1.dropdown [mDropDown],F1.displayName [MdisplayName],F1.FieldMapping [MFieldMapping]  FROM MMM_MST_FIELDS F1 INNER JOIN MMM_MST_FIELDS F2 ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType in ('CHILD ITEM MAX','CHILD ITEM TOTAL') AND F2.DocumentType ='" & formname & "' AND F1.DOCUMENTTYPE='" & Session("Document") & "'"
    '    ODA.Fill(dtTotal)

    '    Dim isTotal As Boolean = False
    '    Dim cDispName As String = ""
    '    Dim Childtotal As Double = 0
    '    If dtTotal.Rows.Count = 1 Then
    '        isTotal = True
    '        cDispName = dtTotal.Rows(0).Item("cdisplayname").ToString
    '    End If

    '    'For Each dr As DataRow In DS1.Rows
    '    '    Dim txt As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("Fieldid").ToString()), TextBox)
    '    '    txt.Text = DS.Rows(rowcount - 1).Item(dr.Item("displayname")).ToString()
    '    'Next

    '    Dim GID As String = dt.Rows(0).Item("fieldId").ToString

    '    ' GID = Right(GID, GID.Length - 3)
    '    Dim GV As GridView = CType(pnlFields.FindControl("GRD" & GID.ToString()), GridView)

    '    ' by sunil for maxvalue 
    '    Dim MaxVal As Double = -999

    '    'Prashant_21_7
    '    Dim gridCols As DataTable = GV.DataSource

    '    'Prashant_17_7
    '    Dim LastRow As Integer = 0

    '    If IsNothing(ViewState("LastRow")) = False Then
    '        If ViewState("LastRow").ToString.Trim <> "" Then
    '            LastRow = Convert.ToInt32(ViewState("LastRow"))
    '        Else
    '            LastRow = GV.Rows.Count - 1
    '        End If
    '    Else
    '        LastRow = GV.Rows.Count - 1
    '    End If

    '    'Prashant_17_7

    '    Dim cnt As Integer = 0
    '    For Each GR As GridViewRow In GV.Rows
    '        If GR.RowIndex <= LastRow Then
    '            If GR.RowType = DataControlRowType.DataRow Then
    '                If GR.Cells(0).Text.ToUpper <> "TOTAL" Then
    '                    Dim str As String = "INSERT INTO MMM_MST_DOC_ITEM("
    '                    Dim STRFld As String = ""
    '                    Dim STRVal As String = ""
    '                    updquery = ""

    '                    'neha thakar 29/1/15 Code to save chilitems of Detail Form 
    '                    Dim DICT As New Dictionary(Of Integer, Integer)
    '                    DICT = CType(Session("AddedRow"), Dictionary(Of Integer, Integer))

    '                    If Not IsNothing(DICT) Then
    '                        If Not IsNothing(Session("AddedRow")) And DICT.ContainsKey(GR.RowIndex) Then
    '                            Dim filterRows() As DataRow
    '                            filterRows = dtField.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''")
    '                            If filterRows.Length > 0 Then
    '                                dtField = filterRows.CopyToDataTable()
    '                            End If
    '                            'dtField = filterRows.CopyToDataTable()
    '                            For j As Integer = 0 To dtField.Rows.Count - 1
    '                                STRFld &= dtField.Rows(j).Item("fieldmapping").ToString & ","  'adding  j+1 for incremental
    '                                Dim colValue As String = ""
    '                                Dim FldID As String = ""

    '                                Dim DispName = dtField.Rows(j).Item("DisplayName").ToString
    '                                FldID = dtField.Rows(j).Item("fieldid").ToString()
    '                                '' new for getting child item total 
    '                                Dim ftype As String = dtField.Rows(j).Item("fieldtype").ToString()
    '                                If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Then
    '                                    ' Dim cb As TextBox = CType(GR.FindControl("fld" & j.ToString() & "_" & cnt), TextBox)
    '                                    'Prashant_21_7
    '                                    'If DispName = gridCols.Columns(j).ToString Then
    '                                    'End If
    '                                    Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & cnt), TextBox)
    '                                    If cb IsNot Nothing Then
    '                                        If (ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "LOOKUP") And dtField.Rows(j).Item("datatype").ToString().ToUpper() = "TEXT" Then
    '                                            colValue = getSafeString(cb.Text.ToString)
    '                                        Else
    '                                            colValue = cb.Text.ToString
    '                                        End If
    '                                    Else
    '                                        colValue = "0"
    '                                    End If
    '                                    If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
    '                                        If colValue <> "" Then
    '                                            If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                                Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                            ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                If Convert.ToDouble(colValue) > MaxVal Then
    '                                                    MaxVal = Convert.ToDouble(colValue)
    '                                                    Childtotal = MaxVal
    '                                                End If
    '                                            End If
    '                                        End If
    '                                    End If
    '                                ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                    'Dim cb As New DropDownList
    '                                    Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                    If cb IsNot Nothing Then
    '                                        colValue = cb.SelectedItem.Text.ToString
    '                                    Else
    '                                        colValue = "0"
    '                                    End If
    '                                ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdownTYPE") = "MASTER VALUED" Then
    '                                    Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                    If cb IsNot Nothing Then
    '                                        colValue = cb.SelectedItem.Value.ToString  ' use value bcoz it's mastervalued - needs tid
    '                                    Else
    '                                        colValue = "0"
    '                                    End If
    '                                ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
    '                                    '' here to code for getting file 
    '                                    Dim txtBox As FileUpload = CType(GR.FindControl("fld_" & FldID & "_" & cnt), FileUpload)

    '                                    'Prashant 
    '                                    Dim txtBox1 As Label = CType(GR.FindControl("lblf_" & FldID), Label)

    '                                    If txtBox.HasFile Then
    '                                        'Dim FN As String = ""
    '                                        'Dim ext As String = ""
    '                                        'FN = Left(txtBox.FileName, txtBox.FileName.LastIndexOf("."))
    '                                        'ext = txtBox.FileName.Substring(txtBox.FileName.LastIndexOf("."), (txtBox.FileName.Length - txtBox.FileName.LastIndexOf(".")))
    '                                        'colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext
    '                                        'txtBox.SaveAs(Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)
    '                                        ''Prashant
    '                                    End If
    '                                    If txtBox1.Text IsNot "" Then
    '                                        Dim errormsg As String = ""
    '                                        Dim FN As String = ""
    '                                        Dim ext As String = ""
    '                                        Dim flag As Integer = 0
    '                                        Dim sourceFile As String = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
    '                                        Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))
    '                                        Dim curFileSize As Integer = finfo.Length
    '                                        ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                        FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
    '                                        colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext

    '                                        File.Copy(sourceFile, Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)

    '                                    End If
    '                                Else

    '                                    For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                        If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                            colValue = GR.Cells(index).Text.ToString()
    '                                            Exit For
    '                                        Else
    '                                            colValue = ""
    '                                        End If
    '                                    Next


    '                                    If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
    '                                        If colValue <> "" Then
    '                                            If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                                Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                            ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                If Convert.ToDouble(colValue) > MaxVal Then
    '                                                    MaxVal = Convert.ToDouble(colValue)
    '                                                    Childtotal = MaxVal
    '                                                End If
    '                                            End If
    '                                        End If

    '                                    End If
    '                                End If

    '                                STRVal &= "'" & colValue & "'" & ","
    '                            Next
    '                            'neha thakar 29/1/15 
    '                            STRFld &= "DOCID,documenttype,isauth,cMasterTID)"
    '                            STRVal &= docid & "," & "'" & formname & "'" & ",1,0)"


    '                            str &= STRFld & "values(" & STRVal
    '                            ODA.SelectCommand.CommandText = str
    '                            ODA.SelectCommand.ExecuteNonQuery()


    '                        Else
    '                            Dim filterRows() As DataRow
    '                            filterRows = dtField.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''")
    '                            If filterRows.Length > 0 Then
    '                                dtField = filterRows.CopyToDataTable()
    '                            End If
    '                            'dtField = filterRows.CopyToDataTable()
    '                            For l As Integer = 0 To dtField.Rows.Count - 1
    '                                STRFld &= dtField.Rows(l).Item("fieldmapping").ToString & ","  'adding  j+1 for incremental
    '                                Dim colValue As String = ""
    '                                Dim FldID As String = ""

    '                                Dim DispName = dtField.Rows(l).Item("DisplayName").ToString
    '                                FldID = dtField.Rows(l).Item("fieldid").ToString()



    '                                If dtField.Rows(l).Item("inlineediting").ToString = "1" Then
    '                                    '' new added for getting child item total
    '                                    'If dtField.Rows(j).Item("displayname") = cDispName And dtField.Rows(j).Item("datatype").ToString.ToUpper = "NUMERIC" Then

    '                                    ' End If
    '                                    '' new for getting child item total 
    '                                    Dim ftype As String = dtField.Rows(l).Item("fieldtype").ToString()
    '                                    If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Then
    '                                        ' Dim cb As TextBox = CType(GR.FindControl("fld" & j.ToString() & "_" & cnt), TextBox)
    '                                        'Prashant_21_7
    '                                        'If DispName = gridCols.Columns(j).ToString Then
    '                                        'End If
    '                                        Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & cnt), TextBox)
    '                                        If cb IsNot Nothing Then
    '                                            If (ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "LOOKUP") And dtField.Rows(l).Item("datatype").ToString().ToUpper() = "TEXT" Then
    '                                                colValue = getSafeString(cb.Text.ToString)
    '                                            Else
    '                                                colValue = cb.Text.ToString
    '                                            End If
    '                                        Else
    '                                            colValue = "0"
    '                                        End If
    '                                        If dtField.Rows(l).Item("displayname") = cDispName Then  '' new for getting child total
    '                                            If colValue <> "" Then
    '                                                If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                                ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                    If Convert.ToDouble(colValue) > MaxVal Then
    '                                                        MaxVal = Convert.ToDouble(colValue)
    '                                                        Childtotal = MaxVal
    '                                                    End If
    '                                                End If
    '                                            End If
    '                                        End If
    '                                    ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(l).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                        'Dim cb As New DropDownList
    '                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                        If cb IsNot Nothing Then
    '                                            colValue = cb.SelectedItem.Text.ToString
    '                                        Else
    '                                            colValue = "0"
    '                                        End If
    '                                    ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(l).Item("dropdownTYPE") = "MASTER VALUED" Then
    '                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                        If cb IsNot Nothing Then
    '                                            colValue = cb.SelectedItem.Value.ToString  ' use value bcoz it's mastervalued - needs tid
    '                                        Else
    '                                            colValue = "0"
    '                                        End If
    '                                    ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
    '                                        '' here to code for getting file 
    '                                        Dim txtBox As FileUpload = CType(GR.FindControl("fld_" & FldID & "_" & cnt), FileUpload)

    '                                        'Prashant 
    '                                        Dim txtBox1 As Label = CType(GR.FindControl("lblf_" & FldID), Label)

    '                                        If txtBox.HasFile Then
    '                                            'Dim FN As String = ""
    '                                            'Dim ext As String = ""
    '                                            'FN = Left(txtBox.FileName, txtBox.FileName.LastIndexOf("."))
    '                                            'ext = txtBox.FileName.Substring(txtBox.FileName.LastIndexOf("."), (txtBox.FileName.Length - txtBox.FileName.LastIndexOf(".")))
    '                                            'colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext
    '                                            'txtBox.SaveAs(Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)
    '                                            ''Prashant
    '                                        End If
    '                                        If txtBox1.Text IsNot "" Then
    '                                            Dim errormsg As String = ""
    '                                            Dim FN As String = ""
    '                                            Dim ext As String = ""
    '                                            Dim flag As Integer = 0
    '                                            Dim sourceFile As String = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
    '                                            Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))
    '                                            Dim curFileSize As Integer = finfo.Length
    '                                            ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                            FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
    '                                            colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(l).Item("FieldID").ToString() & "" & ext

    '                                            File.Copy(sourceFile, Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(l).Item("FieldID").ToString() & ext)

    '                                        End If
    '                                    Else

    '                                        For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                            If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                                colValue = GR.Cells(index).Text.ToString()
    '                                                Exit For
    '                                            Else
    '                                                colValue = ""
    '                                            End If
    '                                        Next


    '                                        If dtField.Rows(l).Item("displayname") = cDispName Then  '' new for getting child total
    '                                            If colValue <> "" Then
    '                                                If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                                ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                    If Convert.ToDouble(colValue) > MaxVal Then
    '                                                        MaxVal = Convert.ToDouble(colValue)
    '                                                        Childtotal = MaxVal
    '                                                    End If
    '                                                End If
    '                                            End If
    '                                        End If
    '                                    End If
    '                                Else  ' if no inline editing 
    '                                    If dtField.Rows(l).Item("dropdownTYPE") = "MASTER VALUED" And dtField.Rows(l).Item("fieldtype") = "Drop Down" Then
    '                                        '' here code to get tid from session arrays by sp 13-jan-13
    '                                        Dim CH() As String = Session("COLHEAD")  ' {}
    '                                        Dim txt() As String = Session("DDLTXT") ' {}
    '                                        Dim Vals() As String = Session("DDLVAL") '{}
    '                                        Dim found As Boolean = False
    '                                        Dim searchHdr As String = formname & "_" & dtField.Rows(l).Item("displayname")
    '                                        For a As Integer = 0 To CH.Length - 1
    '                                            If CH(a).ToString = searchHdr And txt(a).ToString = GR.Cells(l).Text.ToString() Then ' if match found in array 
    '                                                colValue = Vals(a).ToString
    '                                                found = True
    '                                                Exit For
    '                                            End If

    '                                        Next
    '                                        If found = False Then
    '                                            'Prashant_21_7
    '                                            For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                                If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                                    colValue = gridCols.Rows(cnt).Item(DispName).ToString()
    '                                                    Exit For
    '                                                Else
    '                                                    colValue = ""
    '                                                End If
    '                                            Next
    '                                            ' +1 IS ADDED FOR CELL ADJUSTMENT 
    '                                            'Else
    '                                            '    colValue = dtvalue.Rows(cnt).Item(j).ToString() ' added by balli on 2 june 
    '                                        End If
    '                                        'ElseIf dtField.Rows(j).Item("fieldtype") = "Child Item Total" Then

    '                                    Else

    '                                        For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                            If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                                colValue = GR.Cells(index).Text.ToString()
    '                                                Exit For
    '                                            Else
    '                                                colValue = ""
    '                                            End If
    '                                        Next
    '                                        ' +1 IS ADDED FOR CELL ADJUSTMENT 
    '                                        If dtField.Rows(l).Item("displayname") = cDispName Then  '' new for getting child total
    '                                            If colValue <> "" Then
    '                                                If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                                ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                    If Convert.ToDouble(colValue) > MaxVal Then
    '                                                        MaxVal = Convert.ToDouble(colValue)
    '                                                        Childtotal = MaxVal
    '                                                    End If
    '                                                End If
    '                                            End If
    '                                        End If
    '                                    End If
    '                                End If

    '                                STRVal &= "'" & colValue & "'" & ","
    '                                ' j = j - 1  ' for cell value  adjustment 
    '                                'this is for inserting child master TID  by balli
    '                            Next
    '                            For index As Integer = 0 To gridCols.Columns.Count - 1

    '                                If gridCols.Columns(index).ColumnName.ToString.ToUpper = "CMASTERTID" Then
    '                                    cmastertid = GR.Cells(index).Text.ToString()
    '                                    flg = 1
    '                                    Exit For
    '                                End If
    '                            Next
    '                            If flg = 1 Then
    '                                STRFld &= "DOCID,documenttype,isauth,cMasterTID)"
    '                                STRVal &= docid & "," & "'" & formname & "'" & ",1," & cmastertid & ")"
    '                            Else
    '                                STRFld &= "DOCID,documenttype,isauth,cMasterTID)"
    '                                STRVal &= docid & "," & "'" & formname & "'" & ",1,0)"
    '                            End If

    '                            str &= STRFld & "values(" & STRVal
    '                            ODA.SelectCommand.CommandText = str
    '                            ODA.SelectCommand.ExecuteNonQuery()

    '                        End If
    '                        ' End If
    '                        'If dtField.Rows(j).Item("KC_VALUE").ToString.Length > 5 And dtField.Rows(j).Item("KC_STATUS").ToString.Length = 0 Then
    '                        ' updquery &= ob.UPDATEKICKING(dtField.Rows(j).Item("KC_VALUE").ToString(), dtvalue.Rows(i).Item(j).ToString(), pnlFields1)
    '                        ' End If


    '                    Else
    '                        Dim filterRows() As DataRow
    '                        filterRows = dtField.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''")
    '                        If filterRows.Length > 0 Then
    '                            dtField = filterRows.CopyToDataTable()
    '                        End If
    '                        'dtField = filterRows.CopyToDataTable()
    '                        For l As Integer = 0 To dtField.Rows.Count - 1
    '                            STRFld &= dtField.Rows(l).Item("fieldmapping").ToString & ","  'adding  j+1 for incremental
    '                            Dim colValue As String = ""
    '                            Dim FldID As String = ""

    '                            Dim DispName = dtField.Rows(l).Item("DisplayName").ToString
    '                            FldID = dtField.Rows(l).Item("fieldid").ToString()



    '                            If dtField.Rows(l).Item("inlineediting").ToString = "1" Then
    '                                '' new added for getting child item total
    '                                'If dtField.Rows(j).Item("displayname") = cDispName And dtField.Rows(j).Item("datatype").ToString.ToUpper = "NUMERIC" Then

    '                                ' End If
    '                                '' new for getting child item total 
    '                                Dim ftype As String = dtField.Rows(l).Item("fieldtype").ToString()
    '                                If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Then
    '                                    ' Dim cb As TextBox = CType(GR.FindControl("fld" & j.ToString() & "_" & cnt), TextBox)
    '                                    'Prashant_21_7
    '                                    'If DispName = gridCols.Columns(j).ToString Then
    '                                    'End If
    '                                    Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & cnt), TextBox)
    '                                    If cb IsNot Nothing Then
    '                                        If (ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "LOOKUP") And dtField.Rows(l).Item("datatype").ToString().ToUpper() = "TEXT" Then
    '                                            colValue = getSafeString(cb.Text.ToString)
    '                                        Else
    '                                            colValue = cb.Text.ToString
    '                                        End If
    '                                    Else
    '                                        colValue = "0"
    '                                    End If
    '                                    If dtField.Rows(l).Item("displayname") = cDispName Then  '' new for getting child total
    '                                        If colValue <> "" Then
    '                                            If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                                Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                            ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                If Convert.ToDouble(colValue) > MaxVal Then
    '                                                    MaxVal = Convert.ToDouble(colValue)
    '                                                    Childtotal = MaxVal
    '                                                End If
    '                                            End If
    '                                        End If
    '                                    End If
    '                                ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(l).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                    'Dim cb As New DropDownList
    '                                    Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                    If cb IsNot Nothing Then
    '                                        colValue = cb.SelectedItem.Text.ToString
    '                                    Else
    '                                        colValue = "0"
    '                                    End If
    '                                ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(l).Item("dropdownTYPE") = "MASTER VALUED" Then
    '                                    Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                    If cb IsNot Nothing Then
    '                                        colValue = cb.SelectedItem.Value.ToString  ' use value bcoz it's mastervalued - needs tid
    '                                    Else
    '                                        colValue = "0"
    '                                    End If
    '                                ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
    '                                    '' here to code for getting file 
    '                                    Dim txtBox As FileUpload = CType(GR.FindControl("fld_" & FldID & "_" & cnt), FileUpload)

    '                                    'Prashant 
    '                                    Dim txtBox1 As Label = CType(GR.FindControl("lblf_" & FldID), Label)

    '                                    If txtBox.HasFile Then
    '                                        'Dim FN As String = ""
    '                                        'Dim ext As String = ""
    '                                        'FN = Left(txtBox.FileName, txtBox.FileName.LastIndexOf("."))
    '                                        'ext = txtBox.FileName.Substring(txtBox.FileName.LastIndexOf("."), (txtBox.FileName.Length - txtBox.FileName.LastIndexOf(".")))
    '                                        'colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext
    '                                        'txtBox.SaveAs(Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)
    '                                        ''Prashant
    '                                    End If
    '                                    If txtBox1.Text IsNot "" Then
    '                                        Dim errormsg As String = ""
    '                                        Dim FN As String = ""
    '                                        Dim ext As String = ""
    '                                        Dim flag As Integer = 0
    '                                        Dim sourceFile As String = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
    '                                        Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))
    '                                        Dim curFileSize As Integer = finfo.Length
    '                                        ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                        FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
    '                                        colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(l).Item("FieldID").ToString() & "" & ext

    '                                        File.Copy(sourceFile, Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(l).Item("FieldID").ToString() & ext)

    '                                    End If
    '                                Else

    '                                    For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                        If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                            colValue = GR.Cells(index).Text.ToString()
    '                                            Exit For
    '                                        Else
    '                                            colValue = ""
    '                                        End If
    '                                    Next


    '                                    If dtField.Rows(l).Item("displayname") = cDispName Then  '' new for getting child total
    '                                        If colValue <> "" Then
    '                                            If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                                Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                            ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                If Convert.ToDouble(colValue) > MaxVal Then
    '                                                    MaxVal = Convert.ToDouble(colValue)
    '                                                    Childtotal = MaxVal
    '                                                End If
    '                                            End If
    '                                        End If
    '                                    End If
    '                                End If
    '                            Else  ' if no inline editing 
    '                                If dtField.Rows(l).Item("dropdownTYPE") = "MASTER VALUED" And dtField.Rows(l).Item("fieldtype") = "Drop Down" Then
    '                                    '' here code to get tid from session arrays by sp 13-jan-13
    '                                    Dim CH() As String = Session("COLHEAD")  ' {}
    '                                    Dim txt() As String = Session("DDLTXT") ' {}
    '                                    Dim Vals() As String = Session("DDLVAL") '{}
    '                                    Dim found As Boolean = False
    '                                    Dim searchHdr As String = formname & "_" & dtField.Rows(l).Item("displayname")
    '                                    For a As Integer = 0 To CH.Length - 1
    '                                        If CH(a).ToString = searchHdr And txt(a).ToString = GR.Cells(l).Text.ToString() Then ' if match found in array 
    '                                            colValue = Vals(a).ToString
    '                                            found = True
    '                                            Exit For
    '                                        End If

    '                                    Next
    '                                    If found = False Then
    '                                        'Prashant_21_7
    '                                        For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                            If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                                colValue = gridCols.Rows(cnt).Item(DispName).ToString()
    '                                                Exit For
    '                                            Else
    '                                                colValue = ""
    '                                            End If
    '                                        Next
    '                                        ' +1 IS ADDED FOR CELL ADJUSTMENT 
    '                                        'Else
    '                                        '    colValue = dtvalue.Rows(cnt).Item(j).ToString() ' added by balli on 2 june 
    '                                    End If
    '                                    'ElseIf dtField.Rows(j).Item("fieldtype") = "Child Item Total" Then

    '                                Else

    '                                    For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                        If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                            colValue = GR.Cells(index).Text.ToString()
    '                                            Exit For
    '                                        Else
    '                                            colValue = ""
    '                                        End If
    '                                    Next
    '                                    ' +1 IS ADDED FOR CELL ADJUSTMENT 
    '                                    If dtField.Rows(l).Item("displayname") = cDispName Then  '' new for getting child total
    '                                        If colValue <> "" Then
    '                                            If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                                Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                            ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                If Convert.ToDouble(colValue) > MaxVal Then
    '                                                    MaxVal = Convert.ToDouble(colValue)
    '                                                    Childtotal = MaxVal
    '                                                End If
    '                                            End If
    '                                        End If
    '                                    End If
    '                                End If
    '                            End If

    '                            STRVal &= "'" & colValue & "'" & ","
    '                            ' j = j - 1  ' for cell value  adjustment 
    '                            'this is for inserting child master TID  by balli
    '                        Next
    '                        For index As Integer = 0 To gridCols.Columns.Count - 1

    '                            If gridCols.Columns(index).ColumnName.ToString.ToUpper = "CMASTERTID" Then
    '                                cmastertid = GR.Cells(index).Text.ToString()
    '                                flg = 1
    '                                Exit For
    '                            End If
    '                        Next
    '                        If flg = 1 Then
    '                            STRFld &= "DOCID,documenttype,isauth,cMasterTID)"
    '                            STRVal &= docid & "," & "'" & formname & "'" & ",1," & cmastertid & ")"
    '                        Else
    '                            STRFld &= "DOCID,documenttype,isauth,cMasterTID)"
    '                            STRVal &= docid & "," & "'" & formname & "'" & ",1,0)"
    '                        End If

    '                        str &= STRFld & "values(" & STRVal
    '                        ODA.SelectCommand.CommandText = str
    '                        ODA.SelectCommand.ExecuteNonQuery()
    '                    End If

    '                End If
    '            End If
    '        End If
    '        cnt += 1
    '        flg = 0
    '    Next
    '    If isTotal Then
    '        Dim childTotalUpdstr As String = ""
    '        childTotalUpdstr = "UPDATE mmm_mst_doc set " & dtTotal.Rows(0).Item("mFieldMapping").ToString & "=" & Childtotal & " where tid=" & docid

    '        ODA.SelectCommand.CommandType = CommandType.Text
    '        ODA.SelectCommand.CommandText = childTotalUpdstr
    '        ODA.SelectCommand.ExecuteNonQuery()
    '    End If


    '    dt.Dispose()
    '    dtTotal.Dispose()
    '    dtField.Dispose()
    '    dtvalue.Dispose()

    '    Session(formname) = Nothing
    '    Session(formname & "VAL") = Nothing
    '    ODA.Dispose()
    'End Sub

    Public Function getSafeString(ByVal strVar As String) As String
        Trim(strVar)
        strVar = Replace(strVar, "'", "")
        strVar = Replace(strVar, ";", "")
        strVar = Replace(strVar, "--", "")
        strVar = Replace(strVar, "%", "")
        strVar = Replace(strVar, "&", "")
        Return strVar
    End Function

    'Protected Sub SavingChildItem(ByVal formname As String, ByVal docid As Integer, con As SqlConnection, tran As SqlTransaction)
    '    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '    Dim ODA As SqlDataAdapter = New SqlDataAdapter("", con)
    '    ODA.SelectCommand.Transaction = tran
    '    Dim dtField As New DataTable
    '    Dim updquery As String = ""
    '    Dim ob As New DynamicForm()
    '    If Session(formname & "VAL") Is Nothing Then
    '        Exit Sub
    '    End If

    '    ' dtField = ViewState(formname)
    '    dtField = Session("D" & formname)
    '    Dim dtvalue As DataTable = Session(formname & "VAL")
    '    If con.State <> ConnectionState.Open Then
    '        con.Open()
    '    End If

    '    For i As Integer = 0 To dtvalue.Rows.Count - 1
    '        Dim str As String = "INSERT INTO MMM_MST_DOC_ITEM("
    '        Dim STRfLD As String = ""
    '        Dim STRVAL As String = ""
    '        updquery = ""
    '        For j As Integer = 0 To dtvalue.Columns.Count - 1
    '            If dtvalue.Columns(j).ColumnName.ToUpper <> "TID" Then
    '                STRfLD &= dtField.Rows(j).Item("fieldmapping").ToString & ","
    '                STRVAL &= "'" & dtvalue.Rows(i).Item(j).ToString() & "'" & ","
    '                If dtField.Rows(j).Item("KC_VALUE").ToString.Length > 5 And dtField.Rows(j).Item("KC_STATUS").ToString.Length = 0 Then
    '                    updquery &= ob.UPDATEKICKING(dtField.Rows(j).Item("KC_VALUE").ToString(), dtvalue.Rows(i).Item(j).ToString(), pnlFields1)
    '                End If
    '            End If
    '        Next
    '        STRfLD &= "DOCID,documenttype,isauth)"
    '        STRVAL &= docid & "," & "'" & formname & "'" & ",1)"
    '        str &= STRfLD & "values(" & STRVAL
    '        ODA.SelectCommand.CommandText = str
    '        ODA.SelectCommand.ExecuteNonQuery()

    '        '' Hit Kicking Field
    '        If updquery.Trim.Length > 5 Then
    '            ODA.SelectCommand.CommandText = updquery
    '            ODA.SelectCommand.ExecuteNonQuery()
    '        End If
    '    Next
    '    Session(formname) = Nothing
    '    Session(formname & "VAL") = Nothing
    '    ODA.Dispose()
    'End Sub

    Protected Sub SavingChildItem(ByVal formname As String, ByVal docid As Integer, con As SqlConnection, tran As SqlTransaction)
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim ODA As SqlDataAdapter = New SqlDataAdapter("", con)
        ODA.SelectCommand.Transaction = tran
        Dim dtField As New DataTable
        Dim updquery As String = ""
        Dim ob As New DynamicForm()
        If Session(formname & "VAL") Is Nothing Then
            Exit Sub
        End If
        ' dtField = ViewState(formname)
        dtField = Session("D" & formname)
        Dim dtvalue As DataTable = Session(formname & "VAL")
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If
        ' check if child form has rulefilter then exculde or include the records.
        ODA.SelectCommand.CommandText = "select childfilterrule from MMM_MST_Forms where eid=" & Session("EID").ToString() & " and formname='" & formname & "' "
        Dim childitemfilter As String = ODA.SelectCommand.ExecuteScalar.ToString
        For i As Integer = 0 To dtvalue.Rows.Count - 1
            Dim str As String = "INSERT INTO MMM_MST_DOC_ITEM("
            Dim STRfLD As String = ""
            Dim STRVAL As String = ""
            updquery = ""
            Dim cflag As Int16 = 0
            Dim opr As String = ""
            Dim ExcludeFlag As Boolean = False
            Dim cDisName As String()
            For j As Integer = 0 To dtvalue.Columns.Count - 1
                If dtvalue.Columns(j).ColumnName.ToUpper <> "TID" Then
                    STRfLD &= dtField.Rows(j).Item("fieldmapping").ToString & ","
                    STRVAL &= "'" & dtvalue.Rows(i).Item(j).ToString() & "'" & ","
                    If dtField.Rows(j).Item("KC_VALUE").ToString.Length > 5 And dtField.Rows(j).Item("KC_STATUS").ToString.Length = 0 Then
                        updquery &= ob.UPDATEKICKING(dtField.Rows(j).Item("KC_VALUE").ToString(), dtvalue.Rows(i).Item(j).ToString(), pnlFields1)
                    End If
                End If

                If childitemfilter.Length > 2 Then
                    cDisName = childitemfilter.Split("=", "<", ">", ">=", "<=")
                    cflag = 1
                End If
                If cflag = 1 Then
                    If dtvalue.Columns(j).ColumnName.ToUpper = cDisName(0).ToUpper Then
                        Dim comparestr As String = Replace(childitemfilter, cDisName(0), "")
                        comparestr = dtvalue.Rows(i).Item(j).ToString() & comparestr
                        ExcludeFlag = comparestring(comparestr)
                    End If
                End If
            Next
            If ExcludeFlag = True Or childitemfilter = "" Then
                STRfLD &= "DOCID,documenttype,isauth)"
                STRVAL &= docid & "," & "'" & formname & "'" & ",1)"
                str &= STRfLD & "values(" & STRVAL
                ODA.SelectCommand.CommandText = str
                ODA.SelectCommand.ExecuteNonQuery()

                '' Hit Kicking Field
                If updquery.Trim.Length > 5 Then
                    ODA.SelectCommand.CommandText = updquery
                    ODA.SelectCommand.ExecuteNonQuery()
                End If
            End If
        Next
        Session(formname) = Nothing
        Session(formname & "VAL") = Nothing
        ODA.Dispose()
    End Sub


    Protected Sub FILLCONTROLONEDIT(ByVal dtFields As DataTable, ByVal dtflds As DataTable, ByVal dtval As DataTable, ByRef pnlfield As Panel, ByRef updpnl As UpdatePanel, ByVal index As Integer)
        Dim drnewval As DataRow = dtval.NewRow()
        ViewState("Index") = index
        For i As Integer = 0 To dtval.Rows.Count - 1
            If i = index Then
                For j As Integer = 0 To dtFields.Rows.Count - 1
                    Dim dispName As String = dtFields.Rows(j).Item("displayname").ToString()

                    'Change By V 24 Dec
                    Dim edt As Integer = dtFields.Rows(j).Item("isEditable").ToString

                    Select Case dtFields.Rows(j).Item("FieldType").ToString().ToUpper()
                        Case "TEXT BOX"
                            Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & dtFields.Rows(j).Item("FieldID").ToString()), TextBox)
                            'drnew.Item(dtFields.Rows(i).Item("displayname")) = txtBox.Text
                            txtBox.Text = dtval.Rows(i).Item(j).ToString()
                        Case "DROP DOWN"
                            Dim ddl As DropDownList = CType(pnlFields.FindControl("fld" & dtFields.Rows(j).Item("FieldID").ToString()), DropDownList)
                            'drnew.Item(dtFields.Rows(i).Item("displayname")) = txtBox.SelectedItem.Text
                            'drnewval.Item(dtFields.Rows(i).Item("displayname")) = txtBox.SelectedItem.Value
                            If edt = 0 Then
                                ddl.Enabled = False
                            End If
                            ddl.SelectedIndex = ddl.Items.IndexOf(ddl.Items.FindByValue(dtval.Rows(i).Item(j).ToString()))
                        Case "CALCULATIVE FIELD"
                            Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & dtFields.Rows(j).Item("FieldID").ToString()), TextBox)
                            'drnew.Item(dtFields.Rows(i).Item("displayname")) = txtBox.Text
                            txtBox.Text = dtval.Rows(i).Item(j).ToString()
                        Case "LOOKUP"
                            Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & dtFields.Rows(j).Item("FieldID").ToString()), TextBox)
                            'drnew.Item(dtFields.Rows(i).Item("displayname")) = txtBox.Text
                            txtBox.Text = dtval.Rows(i).Item(j).ToString()
                        Case "FILE UPLOADER"
                            Dim lblFile As Label = CType(pnlFields.FindControl("lblf" & dtFields.Rows(j).Item("FieldID").ToString()), Label)
                            Dim hdnFile As HiddenField = CType(pnlFields.FindControl("hdnf" & dtFields.Rows(j).Item("FieldID").ToString()), HiddenField)
                            Dim hdnFlag As HiddenField = CType(pnlFields.FindControl("hdnflg_" & dtFields.Rows(j).Item("FieldID").ToString()), HiddenField)
                            Dim strFile = ""
                            If dtval.Rows(i).Item(j).ToString().Contains("/") Then
                                strFile = After(dtval.Rows(i).Item(j).ToString(), "/")
                            Else
                                strFile = dtval.Rows(i).Item(j).ToString()
                            End If

                            lblFile.Text = strFile
                            hdnFile.Value = strFile
                            hdnFlag.Value = 0
                        Case "ADVANCE FORMULA"
                            Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & dtFields.Rows(j).Item("FieldID").ToString()), TextBox)
                            txtBox.Text = dtval.Rows(i).Item(j).ToString()
                    End Select
                Next
            End If
        Next

    End Sub


    Protected Sub SavingChildItemOnEdit(ByVal FORMNAME As String)
        Dim dtFD As New DataTable
        Dim dtField As New DataTable
        Dim DTVALUE As New DataTable
        Dim errormsg As String = ""
        ' dtField = ViewState(FORMNAME)
        dtField = Session("D" & FORMNAME)

        Dim dvss As DataView = dtField.DefaultView
        dvss.RowFilter = "IsActive=1"
        Dim theFieldss As DataTable = dvss.ToTable
        Dim lstDatass As New List(Of UserData)
        Dim OBs As New DynamicForm()
        lstDatass = OBs.CreateCollection(pnlFields, theFieldss)
        'Added For Calculative Field by mayank 28-Feb-2015
        For Each dr As DataRow In dtField.Rows
            Dim cal_text As String = ""
            Dim cal_mpng As String = ""
            Dim stringf As String = ""
            Dim fldmpng As String = ""
            Dim orignlfinalstr As String = ""
            Dim finalstrr As String = ""
            Select Case dr.Item("FieldType").ToString().ToUpper()
                Case "CALCULATIVE FIELD"
                    Dim dispName1 As String = dr.Item("displayname").ToString()
                    Dim calfldmpng As String = dr.Item("FieldID").ToString()
                    cal_text = dr.Item("cal_text").ToString()
                    cal_mpng = dr.Item("fieldmapping").ToString()
                    'Chages fro multiple calculative Field Mayank
                    If (cal_text.Contains(",")) Then
                        Dim calar As String() = cal_text.Split(",")
                        For i As Integer = 0 To calar.Length - 1
                            Dim subcalar As String() = calar(i).ToString().Split("=")
                            If (subcalar.Length > 1) Then
                                If (subcalar(0) = "{" & dispName1 & "}") Then
                                    cal_text = ""
                                    cal_text = subcalar(0).ToString() & "=" & subcalar(1).ToString()
                                    Exit For
                                End If
                            End If
                        Next
                    Else
                        stringf = cal_text
                    End If

                    'Chages fro multiple calculative Field Mayank
                    stringf = cal_text
                    For l As Integer = 0 To dtField.Rows.Count - 1
                        If cal_text.Trim().Contains("{" & dtField.Rows(l).Item("displayname").ToString().Trim() & "}") Then
                            fldmpng = "fld" & dtField.Rows(l).Item("FieldID").ToString().Trim()
                            stringf = stringf.Replace("{" & dtField.Rows(l).Item("displayname").ToString().Trim() & "}", "{" & fldmpng.Trim() & "}")
                        End If
                    Next
                    stringf = stringf.Replace("{", "")
                    stringf = stringf.Replace("}", "")
                    Dim s As String() = Split(stringf, "=")
                    Dim resultfldd As String = s(0)
                    orignlfinalstr = s(1)
                    finalstrr = orignlfinalstr
                    Dim arr As String() = finalstrr.Split("*", "/", "-", "(", ")", "+", ",")
                    Dim ghn As String = ""
                    For i As Integer = 0 To arr.Length - 1
                        If arr(i).Contains("fld") Then
                            Dim txtBox1 As TextBox = CType(pnlFields.FindControl(arr(i)), TextBox)
                            ghn = txtBox1.Text
                            finalstrr = finalstrr.Replace(arr(i), ghn)
                        End If

                    Next
                    Dim res = New DataTable().Compute(finalstrr, 0).ToString()
                    Dim txtBox As TextBox = CType(pnlFields1.FindControl("fld" & calfldmpng), TextBox)
                    txtBox.Text = res
                Case "ADVANCE FORMULA"

                    'Dim ObjFormula As New FormulaEngine()
                    'Dim AdFormula As String = ""
                    'Dim FieldID = dr.Item("FieldID").ToString()
                    'ObjFormula.EID = Session("EID")
                    'ObjFormula.FormulaFIeld = FieldID
                    'AdFormula = dr.Item("Advance_formula").ToString()
                    'Dim val = ObjFormula.ExecuteFormula(AdFormula, Session("EID"), lstDatass, Nothing, False)
                    'Dim fField As New TextBox()
                    'fField = CType(pnlFields.FindControl("fld" & FieldID), TextBox)
                    'If (Not fField Is Nothing) Then
                    '    fField.Text = Convert.ToString(val)
                    '    lstDatass = OBs.CreateCollection(pnlFields, theFieldss)
                    'End If
            End Select
        Next



        If Session(FORMNAME) Is Nothing Then
            For Each dr As DataRow In dtField.Rows
                dtFD.Columns.Add(dr.Item("displayname"), GetType(String))
                DTVALUE.Columns.Add(dr.Item("Displayname"), GetType(String))
            Next
            dtFD.Columns.Add("tid", GetType(String))
        Else
            dtFD = Session(FORMNAME)
            DTVALUE = Session(FORMNAME & "VAL")
            If dtFD.Rows.Count > 1 Then
                dtFD.Rows.RemoveAt(dtFD.Rows.Count - 1)
            End If
        End If
        Dim drnew As DataRow = dtFD.NewRow()
        Dim DRNEWVAL As DataRow = DTVALUE.NewRow()
        For Each dr As DataRow In dtField.Rows
            Dim dispName As String = dr.Item("displayname").ToString()
            Select Case dr.Item("FieldType").ToString().ToUpper()
                Case "TEXT BOX"
                    Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
                    drnew.Item(dr.Item("displayname")) = txtBox.Text
                    DRNEWVAL.Item(dr.Item("displayname")) = txtBox.Text
                Case "DROP DOWN"
                    Dim txtBox As DropDownList = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), DropDownList)
                    drnew.Item(dr.Item("displayname")) = txtBox.SelectedItem.Text
                    DRNEWVAL.Item(dr.Item("displayname")) = txtBox.SelectedItem.Value
                Case "CALCULATIVE FIELD"
                    Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
                    drnew.Item(dr.Item("displayname")) = txtBox.Text
                    DRNEWVAL.Item(dr.Item("displayname")) = txtBox.Text
                Case "LOOKUP"
                    Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
                    drnew.Item(dr.Item("displayname")) = txtBox.Text
                    DRNEWVAL.Item(dr.Item("displayname")) = txtBox.Text

                Case "FILE UPLOADER"
                    Dim lblFile As Label = CType(pnlFields.FindControl("lblf" & dr.Item("FieldID").ToString()), Label)
                    Dim hdnFile As HiddenField = CType(pnlFields.FindControl("hdnf" & dr.Item("FieldID").ToString()), HiddenField)
                    Dim hdnFlag As HiddenField = CType(pnlFields.FindControl("hdnflg_" & dr.Item("FieldID").ToString()), HiddenField)

                    drnew.Item(dr.Item("displayname")) = lblFile.Text
                    DRNEWVAL.Item(dr.Item("displayname")) = lblFile.Text

                    hdnFlag.Value = 0
                Case "ADVANCE FORMULA"
                    Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
                    drnew.Item(dr.Item("displayname")) = txtBox.Text
                    DRNEWVAL.Item(dr.Item("displayname")) = txtBox.Text
            End Select
        Next

        Dim constr As String = ConfigurationManager.ConnectionStrings("constr").ConnectionString
        Dim con As New SqlConnection(constr)
        Dim oda As New SqlDataAdapter("", con)
        'With(nolock) added by Himank on 29th sep 2015
        oda.SelectCommand.CommandText = "select displayName,FieldMapping,KC_LOGIC  from mmm_mst_fields   WITH(NOLOCK)  where FieldType='Formula Field' and eid=" & Session("EID") & " and documenttype='" & FORMNAME & "' "
        Dim dt As New DataTable()
        oda.Fill(dt)
        drnew.Item("tid") = FORMNAME & "-" & dtFD.Rows.Count & "-" & ViewState("ID")
        'ViewState("Index") = dtFD.Rows.Count
        If dt.Rows.Count > 0 Then
            For i As Integer = 0 To dt.Rows.Count - 1
                '  dt.Rows(0)("Value") = ""
                Dim forchexec As String = String.Empty
                Dim formula As New formulaEditor()

                forchexec = formula.executeformulachielditem(dt.Rows(i).Item("KC_LOGIC"), drnew, dtFD)
                drnew.Item(dt.Rows(i).Item("displayName").ToString()) = forchexec
                DRNEWVAL.Item(dt.Rows(i).Item("displayName").ToString()) = forchexec
                ' forchexec = formula.executeformulachielditem(dt.Rows(i).Item("KC_LOGIC"), DRNEWVAL, DTVALUE)
                'DRNEWVAL.Item(dt.Rows(i).Item("displayName").ToString()) = forchexec
            Next
        End If


        Dim OB As New DynamicForm()
        If dtField.Rows.Count > 0 Then
            Dim str As String = OB.validateForm(dtField.Rows(0).Item("Documenttype").ToString, Session("EID"), pnlFields, dtField, "ADD", 0)
            If str.Length > 5 Then
                str = "Please " & str
                Label3.Text = str
                Exit Sub
            End If
        End If

        Dim retObj As New RuleResponse()
        Dim lstData As New List(Of UserData)
        Dim dtP As DataTable = Session("PFieldsData")
        lstData = OB.CreateCollection(pnlFields, dtP)
        Dim lstChildData As New List(Of UserData)
        Dim obj As New DynamicForm()
        'obj.CreateCollection(pnlFields, dtField)
        Dim onlyFiltered As DataView = dtField.DefaultView
        onlyFiltered.RowFilter = "InlineEditing='1'"
        Dim dtFields As DataTable = onlyFiltered.Table.DefaultView.ToTable()
        lstChildData = obj.CreateCollection(pnlFields1, dtField)
        'Initialising Rule objects


        Dim objRule As New RuleEngin(Session("EID"), FORMNAME, "CREATED", "Submit")
        Dim dsrule As DataSet = objRule.GetRules()
        Dim dtrule As New DataTable
        dtrule = dsrule.Tables(1)
        For Each dr As DataRow In dsrule.Tables(0).Rows
            retObj = objRule.ExecuteRule(lstData, lstChildData, True, "", dr, dtrule)
            If retObj.Success = False Then
                Label3.Text = retObj.ErrorMessage
                ModalPopupExtender1.Show()
                Exit Sub
            End If
        Next

        drnew.Item("tid") = FORMNAME & "-" & ViewState("Index") & "-" & ViewState("ID")
        'dtFD.Rows.Add(drnew)
        'Changes Start from here 
        'If dtFD.Rows.Count > 1 Then
        '    dtFD.Rows.RemoveAt(dtFD.Rows.Count - 1)
        'End If
        'dtFD.Rows.Add(drnew)
        'Changes  End from here 
        dtFD.Rows.RemoveAt(ViewState("Index"))
        dtFD.Rows.InsertAt(drnew, ViewState("Index"))
        'DTVALUE.Rows.Add(DRNEWVAL)
        DTVALUE.Rows.RemoveAt(ViewState("Index"))
        DTVALUE.Rows.InsertAt(DRNEWVAL, ViewState("Index"))
        Session(FORMNAME) = dtFD
        Session(FORMNAME & "VAL") = DTVALUE

        BINDGRID1(dtFD)
        ModalPopupExtender1.Hide()
    End Sub

    Protected Function ValidatingChildItem_DV(ByVal formname As String) As String

        'By neha Thakar 10/02/15 
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As New SqlConnection(conStr)
        Dim ODA As SqlDataAdapter = New SqlDataAdapter("", con)
        Dim dtField As New DataTable
        Dim updquery As String = "SAVE"

        'Prashant_22_7
        Dim dateFields As Integer = 0
        Dim Flag1 As Integer = 0
        Dim ErrFlag As String = ""
        Dim skipRow As Integer = 0
        Dim lastRow As Integer = 0
        Dim DefRows As Integer = 0
        'Prashant_22_7

        Dim ob As New DynamicForm()
        ' dtField = ViewState(formname)
        dtField = Session("D" & formname)
        Dim dtvalue As DataTable = Session(formname & "VAL")
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If
        'Session("id")

        Dim MaxVal As Double = -999

        Dim dt As New DataTable
        'With(nolock) added by Himank on 29th sep 2015
        ODA.SelectCommand.CommandText = "select * from mmm_mst_fields   WITH(NOLOCK) where eid=" & Session("eid") & " and documenttype='" & Session("Document") & "' and dropdown='" & formname & "'"
        ODA.SelectCommand.CommandType = CommandType.Text
        ODA.SelectCommand.Parameters.Clear()
        ODA.Fill(dt)

        Dim dtTotal As New DataTable
        ODA.SelectCommand.CommandType = CommandType.Text
        'With(nolock) added by Himank on 29th sep 2015
        ODA.SelectCommand.CommandText = "SELECT F1.FieldID [MainFieldID],F2.FieldID [ChildFieldID],F2.displayName [CdisplayName],f1.fieldtype [MFIELDTYPE] ,F1.dropdown [mDropDown],F1.displayName [MdisplayName],F1.FieldMapping [MFieldMapping]  FROM MMM_MST_FIELDS F1  WITH(NOLOCK)  INNER JOIN MMM_MST_FIELDS F2  WITH(NOLOCK)  ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType in ('CHILD ITEM MAX','CHILD ITEM TOTAL') AND F2.DocumentType ='" & formname & "' AND F1.DOCUMENTTYPE='" & Session("Document") & "'"
        ODA.Fill(dtTotal)

        Dim isTotal As Boolean = False
        Dim cDispName As String = ""
        Dim Childtotal As Double = 0
        If dtTotal.Rows.Count = 1 Then
            isTotal = True
            cDispName = dtTotal.Rows(0).Item("cdisplayname").ToString
        End If

        Dim GID As String = dt.Rows(0).Item("fieldId").ToString
        Dim GV As GridView = CType(pnlFields.FindControl("GRD" & GID.ToString()), GridView)
        Dim cnt As Integer = 0

        Dim prevRowIndex As Integer = 0
        Dim prevRowMsg As String = ""

        For Each GR As GridViewRow In GV.Rows
            If GR.RowType = DataControlRowType.DataRow Then
                If GR.Cells(0).Text.ToUpper <> "TOTAL" Then
                    'Dim str As String = "INSERT INTO MMM_MST_DOC_ITEM("
                    Dim STRFld As String = ""
                    Dim STRVal As String = ""

                    'Prashant_22_7
                    dateFields = 0
                    ErrFlag = ""
                    skipRow = 0
                    'Prashant_22_7
                    Dim DICT As New Dictionary(Of Integer, Integer)
                    DICT = CType(Session("AddedRow"), Dictionary(Of Integer, Integer))

                    If Not IsNothing(DICT) Then
                        If Not IsNothing(Session("AddedRow")) And DICT.ContainsKey(GR.RowIndex) Then
                            Dim filterRows() As DataRow
                            filterRows = dtField.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''")
                            ' dtField = filterRows.CopyToDataTable()
                            If filterRows.Length > 0 Then
                                dtField = filterRows.CopyToDataTable()
                            End If

                            For j As Integer = 0 To dtField.Rows.Count - 1
                                STRFld &= dtField.Rows(j).Item("fieldmapping").ToString & ","
                                Dim colValue As String = ""
                                Dim FldID As String = ""
                                FldID = dtField.Rows(j).Item("fieldid").ToString()
                                'If dtField.Rows(j).Item("inlineediting").ToString = "1" Then
                                Dim ftype As String = dtField.Rows(j).Item("fieldtype").ToString()
                                If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype = "MULTI LOOKUP" Or ftype.ToUpper() = "FORMULA FIELD" Or ftype.ToUpper() = "TEXT AREA" Or ftype.ToUpper() = "PARENT VALUE" Or ftype.ToUpper() = "AUTOCOMPLETE" Then
                                    If dtField.Rows(j).Item("datatype").ToString().ToUpper = "NUMERIC" And dtField.Rows(j).Item("isrequired") = 1 Then
                                        Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & GR.RowIndex), TextBox)
                                        If cb IsNot Nothing Then
                                            colValue = cb.Text
                                            If cb.Text.Trim = "" Then
                                                'updquery = "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, should be greater than 0"
                                                'Return updquery
                                                'Exit Function
                                                ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                                Flag1 += 1
                                            ElseIf Not IsNumeric(cb.Text.Trim) Then
                                                ErrFlag &= dtField.Rows(j).Item("displayName").ToString() & " must be numeric, "
                                                Flag1 += 1
                                            ElseIf cb.Text.Trim = "0" Then
                                                dateFields += 1
                                            Else
                                                skipRow = 1
                                                lastRow = GR.RowIndex
                                            End If
                                        Else
                                            colValue = "0"
                                        End If
                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
                                            If colValue <> "" Then
                                                Childtotal = Childtotal + Convert.ToDouble(colValue)
                                            End If
                                        End If

                                    ElseIf dtField.Rows(j).Item("datatype").ToString().ToUpper = "DATETIME" Then
                                        dateFields += 1
                                    ElseIf dtField.Rows(j).Item("datatype").ToString().ToUpper = "TEXT" And dtField.Rows(j).Item("isrequired") = 1 Then
                                        Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & GR.RowIndex), TextBox)
                                        If cb IsNot Nothing Then
                                            If cb.Text.Trim = "" Then
                                                ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                                Flag1 += 1
                                            Else
                                                skipRow = 1
                                                lastRow = GR.RowIndex
                                            End If
                                        End If
                                    ElseIf dtField.Rows(j).Item("datatype").ToString().ToUpper = "TEXT" And dtField.Rows(j).Item("isrequired") = 0 Then
                                        dateFields += 1
                                        Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & GR.RowIndex), TextBox)
                                        If cb.Text.Trim <> "" Then
                                            skipRow = 1
                                            lastRow = GR.RowIndex
                                        End If
                                    ElseIf dtField.Rows(j).Item("datatype").ToString().ToUpper = "NUMERIC" And dtField.Rows(j).Item("isrequired") = 0 Then
                                        dateFields += 1
                                        Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & GR.RowIndex), TextBox)
                                        If cb.Text.Trim <> "" And cb.Text.Trim <> "0" Then
                                            If Not IsNumeric(cb.Text) Then
                                                ErrFlag &= dtField.Rows(j).Item("displayName").ToString() & " must be numeric, "
                                                Flag1 += 1
                                            Else
                                                skipRow = 1
                                                lastRow = GR.RowIndex
                                            End If
                                        End If
                                    Else
                                        skipRow = 1
                                        lastRow = GR.RowIndex
                                    End If
                                End If
                                If ftype.ToUpper() = "LOOKUPDDL" Or ftype.ToUpper() = "MULTI LOOKUPDDL" Then
                                    Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                    If dtField.Rows(j).Item("isrequired") = 1 Then
                                        If cb IsNot Nothing Then
                                            colValue = cb.SelectedValue.ToString
                                        Else
                                            colValue = "0"
                                        End If
                                        If colValue = "0" OrElse colValue = "" OrElse colValue.ToUpper().Trim() = "SELECT" Then
                                            ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                            Flag1 += 1
                                        Else
                                            skipRow = 1
                                            lastRow = GR.RowIndex
                                        End If
                                    Else
                                        colValue = cb.SelectedValue.ToString
                                        dateFields += 1
                                        If colValue <> "0" And colValue <> "" And colValue.ToUpper() <> "SELECT" Then
                                            skipRow = 1
                                            lastRow = GR.RowIndex
                                        End If
                                    End If
                                End If
                                If ftype.ToUpper() = "DROP DOWN" Then
                                    Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)

                                    Dim dtFilter As New DataTable

                                    ODA.SelectCommand.CommandType = CommandType.Text
                                    ''ODA.SelectCommand.CommandText = "SELECT F1.FieldID [MainFieldID],F2.FieldID [ChildFieldID],F2.displayName [CdisplayName],f1.fieldtype [MFIELDTYPE] ,F1.dropdown [mDropDown],F1.displayName [MdisplayName],F1.FieldMapping [MFieldMapping]  FROM MMM_MST_FIELDS F1 INNER JOIN MMM_MST_FIELDS F2 ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType in ('CHILD ITEM MAX','CHILD ITEM TOTAL') AND F2.DocumentType ='" & formname & "' AND F1.DOCUMENTTYPE='" & Session("Document") & "'"

                                    If dtField.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
                                        If dtField.Rows(j).Item("isrequired") = 1 Then
                                            If cb IsNot Nothing Then
                                                colValue = cb.SelectedValue.ToString
                                            Else
                                                colValue = "0"
                                            End If
                                            If colValue = "0" OrElse colValue = "" Then
                                                ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                                Flag1 += 1
                                            Else
                                            End If
                                        Else
                                            colValue = cb.SelectedValue.ToString
                                            dateFields += 1
                                            If colValue <> "0" And colValue <> "" Then
                                                skipRow = 1
                                                lastRow = GR.RowIndex
                                            End If
                                        End If
                                    ElseIf dtField.Rows(j).Item("dropdowntype").ToString() = "MASTER VALUED" Then
                                        'With(nolock) added by Himank on 29th sep 2015
                                        Dim str = " Select * from MMM_MST_fields   WITH(NOLOCK) where Eid=" & Session("Eid") & " and KC_Logic Like '%-" & FldID & "'"
                                        ODA.SelectCommand.CommandText = str
                                        Dim dtPr As New DataTable()
                                        ODA.Fill(dtPr)
                                        If dtPr.Rows.Count > 0 Then
                                            'With(nolock) added by Himank on 29th sep 2015
                                            Dim strQuery As String = "select SUBSTRING(KC_Logic,0,CHARINDEX('-', KC_Logic)) ParentDropdown,SUBSTRING(KC_Logic,CHARINDEX('-', KC_Logic) + 1,len(KC_Logic)- CHARINDEX(',', KC_Logic)-2) Childdropdown"
                                            strQuery += "  from MMM_MST_fields   WITH(NOLOCK)  where documenttype ='" & Session("Document") & "' and eid=" & Session("EID") & " and fieldtype='Child Item' and dropdown='" & formname & "'"
                                            strQuery += " and  SUBSTRING(KC_Logic,CHARINDEX('-', KC_Logic) + 1,len(KC_Logic)- CHARINDEX(',', KC_Logic)-2)=" & FldID
                                            ODA.SelectCommand.CommandText = strQuery
                                            ODA.Fill(dtFilter)
                                        Else
                                            dtFilter.Columns.Add("ParentDropdown")
                                            dtFilter.Columns.Add("Childdropdown")
                                        End If

                                        If dtFilter.Rows.Count = 0 Then
                                            If dtField.Rows(j).Item("isrequired") = 1 Then
                                                If cb IsNot Nothing Then
                                                    colValue = cb.SelectedValue.ToString
                                                Else
                                                    colValue = "0"
                                                End If
                                                If colValue = "0" OrElse colValue = "" OrElse colValue.ToUpper().Trim() = "SELECT" Then
                                                    ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                                    Flag1 += 1
                                                Else
                                                    skipRow = 1
                                                    lastRow = GR.RowIndex
                                                End If
                                            Else
                                                colValue = cb.SelectedValue.ToString
                                                dateFields += 1
                                                If colValue <> "0" And colValue <> "" And colValue.ToUpper() <> "SELECT" Then
                                                    skipRow = 1
                                                    lastRow = GR.RowIndex
                                                End If
                                            End If
                                        Else
                                            colValue = cb.SelectedValue.ToString
                                            dateFields += 1
                                            'If colValue <> "0" And colValue <> "" And colValue.ToUpper() <> "SELECT" Then
                                            '    skipRow = 1
                                            '    lastRow = GR.RowIndex
                                            'End If
                                        End If

                                    End If

                                End If

                                If ftype.ToUpper() = "CHECKBOX LIST" Then
                                    Dim cb As CheckBoxList = CType(GR.FindControl("fld" & FldID & "_" & cnt), CheckBoxList)

                                    If dtField.Rows(j).Item("isrequired") = 1 Then
                                        If cb IsNot Nothing Then
                                            For Each item As ListItem In cb.Items
                                                If item.Selected Then
                                                    colValue &= item.Value & ","
                                                End If
                                            Next
                                        Else
                                            colValue = ""
                                        End If

                                        If colValue = "" Then
                                            ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                            Flag1 += 1
                                            If j = dtField.Rows.Count - 1 Then
                                                dateFields -= 1
                                            End If
                                        Else

                                        End If
                                    Else
                                        If cb IsNot Nothing Then
                                            For Each item As ListItem In cb.Items
                                                If item.Selected Then
                                                    colValue &= item.Value & ","
                                                End If
                                            Next
                                        Else
                                            colValue = ""
                                        End If
                                        dateFields += 1
                                        If colValue <> "" Then
                                            skipRow = 1
                                            lastRow = GR.RowIndex
                                        End If
                                    End If

                                End If
                                If ftype.ToUpper() = "FILE UPLOADER" Then

                                    Dim txtBox As FileUpload = CType(GR.FindControl("fld_" & FldID & "_" & cnt), FileUpload)

                                    'Prashant 30-6-2014
                                    Dim txtBox1 As Label = CType(GR.FindControl("lblf_" & FldID), Label)

                                    '    If txtBox.HasFile Then
                                    '        Dim FN As String = ""
                                    '        Dim ext As String = ""
                                    '        Dim flag As Integer = 0
                                    '        Dim Validext As String = ""
                                    '        FN = Left(txtBox.FileName, txtBox.FileName.LastIndexOf("."))
                                    '        ext = txtBox.FileName.Substring(txtBox.FileName.LastIndexOf("."), (txtBox.FileName.Length - txtBox.FileName.LastIndexOf(".")))
                                    '        If IsDBNull(dtField.Rows(j).Item("UploadAllowedTypes")) = True OrElse Trim(dtField.Rows(j).Item("UploadAllowedTypes")) = "" Then
                                    '        Else
                                    '            Dim type As String() = Split(dtField.Rows(j).Item("UploadAllowedTypes").ToString(), ",")

                                    '            For k As Integer = 0 To type.Length - 1
                                    '                If type(k) = ext Then
                                    '                    flag = 0 ' if file type is match then passed and saved into DB
                                    '                    Exit For
                                    '                Else
                                    '                    flag = 1 ' check for type of the not matched 
                                    '                    Validext &= type(k).ToString() & ","
                                    '                End If
                                    '            Next
                                    '            If flag = 0 Then
                                    '            Else
                                    '                updquery = "Invalid file type in (" & formname & ") allowed file types are (" & Validext.Substring(0, Validext.Length - 1) & ")"
                                    '                Return updquery
                                    '                Exit Function
                                    '            End If
                                    '        End If
                                    If txtBox1.Text IsNot "" Then
                                        'Prashant
                                        skipRow = 1
                                        lastRow = GR.RowIndex

                                        Dim ext As String = ""
                                        Dim flag As Integer = 0
                                        Dim Validext As String = ""
                                        Dim sourceFile As String = ""
                                        Dim curFileSize As Integer = 0
                                        If Not Request.QueryString("TID") Is Nothing Then
                                            sourceFile = Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text)
                                            Dim finfo As New FileInfo(Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text))

                                            ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                            curFileSize = finfo.Length
                                        Else
                                            sourceFile = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
                                            Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))

                                            ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                            curFileSize = finfo.Length
                                        End If
                                        If IsDBNull(dtField.Rows(j).Item("UploadAllowedTypes")) = True OrElse Trim(dtField.Rows(j).Item("UploadAllowedTypes")) = "" Then
                                        Else
                                            Dim type As String() = Split(dtField.Rows(j).Item("UploadAllowedTypes").ToString(), ",")
                                            For k As Integer = 0 To type.Length - 1
                                                If type(k) = ext Then
                                                    flag = 0 ' if file type is match then passed and saved into DB
                                                    Exit For
                                                Else
                                                    flag = 1 ' check for type of the not matched
                                                    Validext &= type(k).ToString() & ","
                                                End If
                                            Next
                                            If flag = 0 Then
                                            Else
                                                'updquery = "Invalid file type in (" & formname & ") allowed file types are (" & Validext.Substring(0, Validext.Length - 1) & ")"
                                                'Return updquery
                                                'Exit Function
                                                ErrFlag &= "Invalid file type in (" & formname & ") " & dtField.Rows(j).Item("displayName").ToString() & ", "
                                                Flag1 += 1
                                            End If
                                        End If

                                    Else
                                        If dtField.Rows(j).Item("isrequired").ToString = "1" Then
                                            ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                            Flag1 += 1
                                        Else
                                            'colValue = txtBox1.Text.ToString
                                            dateFields += 1
                                            'If txtBox1.Text.ToString.Trim = "" Then
                                            '    skipRow = 1
                                            '    lastRow = GR.RowIndex
                                            'End If
                                        End If

                                    End If
                                End If

                            Next
                        Else
                            Dim filterRows() As DataRow
                            filterRows = dtField.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''")
                            ' dtField = filterRows.CopyToDataTable()
                            If filterRows.Length > 0 Then
                                dtField = filterRows.CopyToDataTable()
                            End If
                            For j As Integer = 0 To dtField.Rows.Count - 1
                                STRFld &= dtField.Rows(j).Item("fieldmapping").ToString & ","
                                Dim colValue As String = ""
                                Dim FldID As String = ""
                                FldID = dtField.Rows(j).Item("fieldid").ToString()
                                If dtField.Rows(j).Item("inlineediting").ToString = "1" Then
                                    Dim ftype As String = dtField.Rows(j).Item("fieldtype").ToString()
                                    If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype = "MULTI LOOKUP" Or ftype.ToUpper() = "FORMULA FIELD" Or ftype.ToUpper() = "TEXT AREA" Or ftype.ToUpper() = "PARENT VALUE" Or ftype.ToUpper() = "AUTOCOMPLETE" Then
                                        If dtField.Rows(j).Item("datatype").ToString().ToUpper = "NUMERIC" And dtField.Rows(j).Item("isrequired") = 1 Then
                                            Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & GR.RowIndex), TextBox)
                                            If cb IsNot Nothing Then
                                                colValue = cb.Text
                                                If cb.Text.Trim = "" Then
                                                    'updquery = "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, should be greater than 0"
                                                    'Return updquery
                                                    'Exit Function
                                                    ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                                    Flag1 += 1
                                                ElseIf Not IsNumeric(cb.Text.Trim) Then
                                                    ErrFlag &= dtField.Rows(j).Item("displayName").ToString() & " must be numeric, "
                                                    Flag1 += 1
                                                ElseIf cb.Text.Trim = "0" Then
                                                    dateFields += 1
                                                Else
                                                    skipRow = 1
                                                    lastRow = GR.RowIndex
                                                End If
                                            Else
                                                colValue = "0"
                                            End If
                                            If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
                                                If colValue <> "" Then
                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
                                                End If
                                            End If

                                        ElseIf dtField.Rows(j).Item("datatype").ToString().ToUpper = "DATETIME" Then
                                            dateFields += 1
                                        ElseIf dtField.Rows(j).Item("datatype").ToString().ToUpper = "TEXT" And dtField.Rows(j).Item("isrequired") = 1 Then
                                            Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & GR.RowIndex), TextBox)
                                            If cb IsNot Nothing Then
                                                If cb.Text.Trim = "" Then
                                                    ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                                    Flag1 += 1
                                                Else
                                                    skipRow = 1
                                                    lastRow = GR.RowIndex
                                                End If
                                            End If
                                        ElseIf dtField.Rows(j).Item("datatype").ToString().ToUpper = "TEXT" And dtField.Rows(j).Item("isrequired") = 0 Then
                                            dateFields += 1
                                            Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & GR.RowIndex), TextBox)
                                            If cb.Text.Trim <> "" Then
                                                skipRow = 1
                                                lastRow = GR.RowIndex
                                            End If
                                        ElseIf dtField.Rows(j).Item("datatype").ToString().ToUpper = "NUMERIC" And dtField.Rows(j).Item("isrequired") = 0 Then
                                            dateFields += 1
                                            Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & GR.RowIndex), TextBox)
                                            If cb.Text.Trim <> "" And cb.Text.Trim <> "0" Then
                                                If Not IsNumeric(cb.Text.Trim) Then
                                                    ErrFlag &= dtField.Rows(j).Item("displayName").ToString() & " must be numeric, "
                                                    Flag1 += 1
                                                Else
                                                    skipRow = 1
                                                    lastRow = GR.RowIndex
                                                End If
                                            End If

                                        Else
                                            'skipRow = 1
                                            'lastRow = GR.RowIndex
                                        End If
                                    End If
                                    If ftype.ToUpper() = "LOOKUPDDL" Or ftype.ToUpper() = "MULTI LOOKUPDDL" Then
                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                        If dtField.Rows(j).Item("isrequired") = 1 Then
                                            If cb IsNot Nothing Then
                                                colValue = cb.SelectedValue.ToString
                                            Else
                                                colValue = "0"
                                            End If
                                            If colValue = "0" OrElse colValue = "" OrElse colValue.ToUpper().Trim() = "SELECT" Then
                                                ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                                Flag1 += 1
                                            Else
                                                skipRow = 1
                                                lastRow = GR.RowIndex
                                            End If
                                        Else
                                            colValue = cb.SelectedValue.ToString
                                            dateFields += 1
                                            If colValue <> "0" And colValue <> "" And colValue.ToUpper() <> "SELECT" Then
                                                skipRow = 1
                                                lastRow = GR.RowIndex
                                            End If
                                        End If
                                    End If
                                    If ftype.ToUpper() = "DROP DOWN" Then
                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)

                                        Dim dtFilter As New DataTable

                                        ODA.SelectCommand.CommandType = CommandType.Text
                                        ''ODA.SelectCommand.CommandText = "SELECT F1.FieldID [MainFieldID],F2.FieldID [ChildFieldID],F2.displayName [CdisplayName],f1.fieldtype [MFIELDTYPE] ,F1.dropdown [mDropDown],F1.displayName [MdisplayName],F1.FieldMapping [MFieldMapping]  FROM MMM_MST_FIELDS F1 INNER JOIN MMM_MST_FIELDS F2 ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType in ('CHILD ITEM MAX','CHILD ITEM TOTAL') AND F2.DocumentType ='" & formname & "' AND F1.DOCUMENTTYPE='" & Session("Document") & "'"


                                        If dtField.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
                                            If dtField.Rows(j).Item("isrequired") = 1 Then
                                                If cb IsNot Nothing Then
                                                    colValue = cb.SelectedValue.ToString

                                                Else
                                                    colValue = "0"
                                                End If
                                                If colValue = "0" OrElse colValue = "" Then
                                                    ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                                    Flag1 += 1
                                                Else
                                                End If
                                            Else
                                                colValue = cb.SelectedValue.ToString
                                                dateFields += 1
                                                If colValue <> "0" And colValue <> "" Then
                                                    skipRow = 1
                                                    lastRow = GR.RowIndex
                                                End If
                                            End If

                                        ElseIf dtField.Rows(j).Item("dropdowntype").ToString() = "MASTER VALUED" Then
                                            'With(nolock) added by Himank on 29th sep 2015
                                            Dim str = " Select * from MMM_MST_fields  WITH(NOLOCK)  where Eid=" & Session("Eid") & " and KC_Logic Like '%-" & FldID & "'"
                                            ODA.SelectCommand.CommandText = str
                                            Dim dtPr As New DataTable()
                                            ODA.Fill(dtPr)
                                            If dtPr.Rows.Count > 0 Then
                                                'With(nolock) added by Himank on 29th sep 2015
                                                Dim strQuery As String = "select SUBSTRING(KC_Logic,0,CHARINDEX('-', KC_Logic)) ParentDropdown,SUBSTRING(KC_Logic,CHARINDEX('-', KC_Logic) + 1,len(KC_Logic)- CHARINDEX(',', KC_Logic)-2) Childdropdown"
                                                strQuery += "  from MMM_MST_fields   WITH(NOLOCK) where documenttype ='" & Session("Document") & "' and eid=" & Session("EID") & " and fieldtype='Child Item' and dropdown='" & formname & "'"
                                                strQuery += " and  SUBSTRING(KC_Logic,CHARINDEX('-', KC_Logic) + 1,len(KC_Logic)- CHARINDEX(',', KC_Logic)-2)=" & FldID
                                                ODA.SelectCommand.CommandText = strQuery
                                                ODA.Fill(dtFilter)
                                            Else
                                                dtFilter.Columns.Add("ParentDropdown")
                                                dtFilter.Columns.Add("Childdropdown")
                                            End If

                                            If dtFilter.Rows.Count = 0 Then
                                                If dtField.Rows(j).Item("isrequired") = 1 Then
                                                    If cb IsNot Nothing Then
                                                        colValue = cb.SelectedValue.ToString
                                                    Else
                                                        colValue = "0"
                                                    End If
                                                    If colValue = "0" OrElse colValue = "" OrElse colValue.ToUpper().Trim() = "SELECT" Then
                                                        ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                                        Flag1 += 1
                                                    Else
                                                        skipRow = 1
                                                        lastRow = GR.RowIndex
                                                    End If
                                                Else
                                                    colValue = cb.SelectedValue.ToString
                                                    dateFields += 1
                                                    If colValue <> "0" And colValue <> "" And colValue.ToUpper() <> "SELECT" Then
                                                        skipRow = 1
                                                        lastRow = GR.RowIndex
                                                    End If
                                                End If
                                            Else
                                                colValue = cb.SelectedValue.ToString
                                                dateFields += 1
                                                'If colValue <> "0" And colValue <> "" And colValue.ToUpper() <> "SELECT" Then
                                                '    skipRow = 1
                                                '    lastRow = GR.RowIndex
                                                'End If
                                            End If

                                        End If

                                    End If

                                    If ftype.ToUpper() = "CHECKBOX LIST" Then
                                        Dim cb As CheckBoxList = CType(GR.FindControl("fld" & FldID & "_" & cnt), CheckBoxList)

                                        If dtField.Rows(j).Item("isrequired") = 1 Then
                                            If cb IsNot Nothing Then
                                                For Each item As ListItem In cb.Items
                                                    If item.Selected Then
                                                        colValue &= item.Value & ","
                                                    End If
                                                Next
                                            Else
                                                colValue = ""
                                            End If
                                            If colValue = "" Then
                                                ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                                Flag1 += 1
                                                If j = dtField.Rows.Count - 1 Then
                                                    dateFields -= 1
                                                End If
                                            Else
                                            End If
                                        Else
                                            If cb IsNot Nothing Then
                                                For Each item As ListItem In cb.Items
                                                    If item.Selected Then
                                                        colValue &= item.Value & ","
                                                    End If
                                                Next
                                            Else
                                                colValue = ""
                                            End If
                                            dateFields += 1
                                            If colValue <> "" Then
                                                skipRow = 1
                                                lastRow = GR.RowIndex
                                            End If
                                        End If

                                    End If

                                    If ftype.ToUpper() = "FILE UPLOADER" Then

                                        Dim txtBox As FileUpload = CType(GR.FindControl("fld_" & FldID & "_" & cnt), FileUpload)

                                        'Prashant 30-6-2014
                                        Dim txtBox1 As Label = CType(GR.FindControl("lblf_" & FldID), Label)

                                        '    If txtBox.HasFile Then
                                        '        Dim FN As String = ""
                                        '        Dim ext As String = ""
                                        '        Dim flag As Integer = 0
                                        '        Dim Validext As String = ""
                                        '        FN = Left(txtBox.FileName, txtBox.FileName.LastIndexOf("."))
                                        '        ext = txtBox.FileName.Substring(txtBox.FileName.LastIndexOf("."), (txtBox.FileName.Length - txtBox.FileName.LastIndexOf(".")))
                                        '        If IsDBNull(dtField.Rows(j).Item("UploadAllowedTypes")) = True OrElse Trim(dtField.Rows(j).Item("UploadAllowedTypes")) = "" Then
                                        '        Else
                                        '            Dim type As String() = Split(dtField.Rows(j).Item("UploadAllowedTypes").ToString(), ",")

                                        '            For k As Integer = 0 To type.Length - 1
                                        '                If type(k) = ext Then
                                        '                    flag = 0 ' if file type is match then passed and saved into DB
                                        '                    Exit For
                                        '                Else
                                        '                    flag = 1 ' check for type of the not matched 
                                        '                    Validext &= type(k).ToString() & ","
                                        '                End If
                                        '            Next
                                        '            If flag = 0 Then
                                        '            Else
                                        '                updquery = "Invalid file type in (" & formname & ") allowed file types are (" & Validext.Substring(0, Validext.Length - 1) & ")"
                                        '                Return updquery
                                        '                Exit Function
                                        '            End If
                                        '        End If
                                        If txtBox1.Text IsNot "" Then
                                            'Prashant
                                            skipRow = 1
                                            lastRow = GR.RowIndex

                                            Dim ext As String = ""
                                            Dim flag As Integer = 0
                                            Dim Validext As String = ""
                                            Dim sourceFile As String = ""
                                            Dim curFileSize As Integer = 0
                                            If Not Request.QueryString("TID") Is Nothing Then
                                                sourceFile = Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text)
                                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text))

                                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                                curFileSize = finfo.Length
                                            Else
                                                sourceFile = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
                                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))

                                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                                curFileSize = finfo.Length
                                            End If
                                            If IsDBNull(dtField.Rows(j).Item("UploadAllowedTypes")) = True OrElse Trim(dtField.Rows(j).Item("UploadAllowedTypes")) = "" Then
                                            Else
                                                Dim type As String() = Split(dtField.Rows(j).Item("UploadAllowedTypes").ToString(), ",")
                                                For k As Integer = 0 To type.Length - 1
                                                    If type(k) = ext Then
                                                        flag = 0 ' if file type is match then passed and saved into DB
                                                        Exit For
                                                    Else
                                                        flag = 1 ' check for type of the not matched
                                                        Validext &= type(k).ToString() & ","
                                                    End If
                                                Next
                                                If flag = 0 Then
                                                Else
                                                    'updquery = "Invalid file type in (" & formname & ") allowed file types are (" & Validext.Substring(0, Validext.Length - 1) & ")"
                                                    'Return updquery
                                                    'Exit Function
                                                    ErrFlag &= "Invalid file type in (" & formname & ") " & dtField.Rows(j).Item("displayName").ToString() & ", "
                                                    Flag1 += 1
                                                End If
                                            End If

                                        Else
                                            If dtField.Rows(j).Item("isrequired").ToString = "1" Then
                                                ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                                Flag1 += 1
                                            Else
                                                'colValue = txtBox1.Text.ToString
                                                dateFields += 1
                                                'If txtBox1.Text.ToString.Trim = "" Then
                                                '    skipRow = 1
                                                '    lastRow = GR.RowIndex
                                                'End If
                                            End If

                                        End If
                                    End If
                                Else

                                End If
                            Next
                        End If
                    Else
                        Dim filterRows() As DataRow
                        filterRows = dtField.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''")
                        ' dtField = filterRows.CopyToDataTable()
                        If filterRows.Length > 0 Then
                            dtField = filterRows.CopyToDataTable()
                        End If

                        For j As Integer = 0 To dtField.Rows.Count - 1
                            STRFld &= dtField.Rows(j).Item("fieldmapping").ToString & ","
                            Dim colValue As String = ""
                            Dim FldID As String = ""
                            FldID = dtField.Rows(j).Item("fieldid").ToString()
                            If dtField.Rows(j).Item("inlineediting").ToString = "1" Then
                                Dim ftype As String = dtField.Rows(j).Item("fieldtype").ToString()
                                If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "FORMULA FIELD" Or ftype.ToUpper() = "TEXT AREA" Or ftype.ToUpper() = "PARENT VALUE" Or ftype.ToUpper() = "AUTOCOMPLETE" Or ftype.ToUpper() = "LT LOOKUP" Then
                                    If dtField.Rows(j).Item("datatype").ToString().ToUpper = "NUMERIC" And dtField.Rows(j).Item("isrequired") = 1 Then
                                        Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & GR.RowIndex), TextBox)
                                        If cb IsNot Nothing Then
                                            If Not IsNothing(dtField.Rows(j).Item("RoundOff")) Then
                                                Dim numberOfDecimalPlaces As Integer = Convert.ToString(dtField.Rows(j).Item("RoundOff"))
                                                If numberOfDecimalPlaces <> -1 Then
                                                    Dim before As Double = cb.Text
                                                    Dim after As Double = Math.Round(before)
                                                    Dim formatstring As String = String.Concat("{0:F", numberOfDecimalPlaces, "}")
                                                    cb.Text = String.Format(formatstring, after)
                                                End If
                                            End If
                                            colValue = cb.Text
                                            If cb.Text.Trim = "" Then
                                                'updquery = "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, should be greater than 0"
                                                'Return updquery
                                                'Exit Function
                                                ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                                Flag1 += 1
                                            ElseIf Not IsNumeric(cb.Text.Trim) Then
                                                ErrFlag &= dtField.Rows(j).Item("displayName").ToString() & " must be numeric, "
                                                Flag1 += 1
                                            ElseIf cb.Text.Trim = "0" Then
                                                dateFields += 1
                                            Else
                                                skipRow = 1
                                                lastRow = GR.RowIndex
                                            End If
                                        Else
                                            colValue = "0"
                                        End If
                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
                                            If colValue <> "" Then
                                                Childtotal = Childtotal + Convert.ToDouble(colValue)
                                            End If
                                        End If

                                    ElseIf dtField.Rows(j).Item("datatype").ToString().ToUpper = "DATETIME" Then
                                        dateFields += 1
                                    ElseIf dtField.Rows(j).Item("datatype").ToString().ToUpper = "TEXT" And dtField.Rows(j).Item("isrequired") = 1 Then
                                        Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & GR.RowIndex), TextBox)
                                        If cb IsNot Nothing Then
                                            If cb.Text.Trim = "" Then
                                                ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                                Flag1 += 1
                                            Else
                                                skipRow = 1
                                                lastRow = GR.RowIndex
                                            End If
                                        End If
                                    ElseIf dtField.Rows(j).Item("datatype").ToString().ToUpper = "TEXT" And dtField.Rows(j).Item("isrequired") = 0 Then
                                        dateFields += 1
                                        Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & GR.RowIndex), TextBox)
                                        If cb.Text.Trim <> "" Then
                                            skipRow = 1
                                            lastRow = GR.RowIndex
                                        End If
                                    ElseIf dtField.Rows(j).Item("datatype").ToString().ToUpper = "NUMERIC" And dtField.Rows(j).Item("isrequired") = 0 Then
                                        dateFields += 1
                                        Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & GR.RowIndex), TextBox)
                                        If cb.Text.Trim <> "" And cb.Text.Trim <> "0" Then
                                            If Not IsNumeric(cb.Text.Trim) Then
                                                ErrFlag &= dtField.Rows(j).Item("displayName").ToString() & " must be numeric, "
                                                Flag1 += 1
                                            Else
                                                skipRow = 1
                                                lastRow = GR.RowIndex
                                            End If
                                        End If

                                    Else
                                        'skipRow = 1
                                        'lastRow = GR.RowIndex
                                    End If
                                End If
                                If ftype.ToUpper() = "LOOKUPDDL" Or ftype.ToUpper() = "MULTI LOOKUPDDL" Then
                                    Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                    If dtField.Rows(j).Item("isrequired") = 1 Then
                                        If cb IsNot Nothing Then
                                            colValue = cb.SelectedValue.ToString
                                        Else
                                            colValue = "0"
                                        End If
                                        If colValue = "0" OrElse colValue = "" OrElse colValue.ToUpper().Trim() = "SELECT" Then
                                            ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                            Flag1 += 1
                                        Else
                                            skipRow = 1
                                            lastRow = GR.RowIndex
                                        End If
                                    Else
                                        colValue = cb.SelectedValue.ToString
                                        dateFields += 1
                                        If colValue <> "0" And colValue <> "" And colValue.ToUpper() <> "SELECT" Then
                                            skipRow = 1
                                            lastRow = GR.RowIndex
                                        End If
                                    End If
                                End If
                                If ftype.ToUpper() = "DROP DOWN" Then
                                    Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)

                                    Dim dtFilter As New DataTable

                                    ODA.SelectCommand.CommandType = CommandType.Text
                                    ''ODA.SelectCommand.CommandText = "SELECT F1.FieldID [MainFieldID],F2.FieldID [ChildFieldID],F2.displayName [CdisplayName],f1.fieldtype [MFIELDTYPE] ,F1.dropdown [mDropDown],F1.displayName [MdisplayName],F1.FieldMapping [MFieldMapping]  FROM MMM_MST_FIELDS F1 INNER JOIN MMM_MST_FIELDS F2 ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType in ('CHILD ITEM MAX','CHILD ITEM TOTAL') AND F2.DocumentType ='" & formname & "' AND F1.DOCUMENTTYPE='" & Session("Document") & "'"


                                    If dtField.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
                                        If dtField.Rows(j).Item("isrequired") = 1 Then
                                            If cb IsNot Nothing Then
                                                colValue = cb.SelectedValue.ToString

                                            Else
                                                colValue = "0"
                                            End If
                                            If colValue = "0" OrElse colValue = "" Then
                                                ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                                Flag1 += 1
                                            Else
                                            End If
                                        Else
                                            colValue = cb.SelectedValue.ToString
                                            dateFields += 1
                                            If colValue <> "0" And colValue <> "" Then
                                                skipRow = 1
                                                lastRow = GR.RowIndex
                                            End If
                                        End If

                                    ElseIf dtField.Rows(j).Item("dropdowntype").ToString() = "MASTER VALUED" Then

                                        'With(nolock) added by Himank on 29th sep 2015
                                        Dim str = " Select * from MMM_MST_fields   WITH(NOLOCK) where Eid=" & Session("Eid") & " and KC_Logic Like '%-" & FldID & "'"
                                        ODA.SelectCommand.CommandText = str
                                        Dim dtPr As New DataTable()
                                        ODA.Fill(dtPr)
                                        If dtPr.Rows.Count > 0 Then
                                            'With(nolock) added by Himank on 29th sep 2015
                                            Dim strQuery As String = "select SUBSTRING(KC_Logic,0,CHARINDEX('-', KC_Logic)) ParentDropdown,SUBSTRING(KC_Logic,CHARINDEX('-', KC_Logic) + 1,len(KC_Logic)- CHARINDEX(',', KC_Logic)-2) Childdropdown"
                                            strQuery += "  from MMM_MST_fields  WITH(NOLOCK)  where documenttype ='" & Session("Document") & "' and eid=" & Session("EID") & " and fieldtype='Child Item' and dropdown='" & formname & "'"
                                            strQuery += " and  SUBSTRING(KC_Logic,CHARINDEX('-', KC_Logic) + 1,len(KC_Logic)- CHARINDEX(',', KC_Logic)-2)=" & FldID
                                            ODA.SelectCommand.CommandText = strQuery
                                            ODA.Fill(dtFilter)
                                        Else
                                            dtFilter.Columns.Add("ParentDropdown")
                                            dtFilter.Columns.Add("Childdropdown")
                                        End If


                                        If dtFilter.Rows.Count = 0 Then
                                            If dtField.Rows(j).Item("isrequired") = 1 Then
                                                If cb IsNot Nothing Then
                                                    colValue = cb.SelectedValue.ToString
                                                Else
                                                    colValue = "0"
                                                End If
                                                If colValue = "0" OrElse colValue = "" OrElse colValue.ToUpper().Trim() = "SELECT" Then
                                                    ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                                    Flag1 += 1
                                                Else
                                                    skipRow = 1
                                                    lastRow = GR.RowIndex
                                                End If
                                            Else
                                                colValue = cb.SelectedValue.ToString
                                                dateFields += 1
                                                If colValue <> "0" And colValue <> "" And colValue.ToUpper() <> "SELECT" Then
                                                    skipRow = 1
                                                    lastRow = GR.RowIndex
                                                End If
                                            End If
                                        Else
                                            colValue = cb.SelectedValue.ToString
                                            dateFields += 1
                                            'If colValue <> "0" And colValue <> "" And colValue.ToUpper() <> "SELECT" Then
                                            '    skipRow = 1
                                            '    lastRow = GR.RowIndex
                                            'End If
                                        End If

                                    End If

                                End If

                                If ftype.ToUpper() = "CHECKBOX LIST" Then
                                    Dim cb As CheckBoxList = CType(GR.FindControl("fld" & FldID & "_" & cnt), CheckBoxList)

                                    If dtField.Rows(j).Item("isrequired") = 1 Then
                                        If cb IsNot Nothing Then
                                            For Each item As ListItem In cb.Items
                                                If item.Selected Then
                                                    colValue &= item.Value & ","
                                                End If
                                            Next
                                        Else
                                            colValue = ""
                                        End If
                                        If colValue = "" Then
                                            ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                            Flag1 += 1
                                            If j = dtField.Rows.Count - 1 Then
                                                dateFields -= 1
                                            End If
                                        Else
                                            skipRow = 1
                                            lastRow = GR.RowIndex
                                        End If
                                    Else
                                        If cb IsNot Nothing Then
                                            For Each item As ListItem In cb.Items
                                                If item.Selected Then
                                                    colValue &= item.Value & ","
                                                End If
                                            Next
                                        Else
                                            colValue = ""
                                        End If
                                        dateFields += 1
                                        If colValue <> "" Then
                                            skipRow = 1
                                            lastRow = GR.RowIndex
                                        End If
                                    End If

                                End If

                                If ftype.ToUpper() = "FILE UPLOADER" Then

                                    Dim txtBox As FileUpload = CType(GR.FindControl("fld_" & FldID & "_" & cnt), FileUpload)

                                    'Prashant 30-6-2014
                                    Dim txtBox1 As Label = CType(GR.FindControl("lblf_" & FldID), Label)

                                    '    If txtBox.HasFile Then
                                    '        Dim FN As String = ""
                                    '        Dim ext As String = ""
                                    '        Dim flag As Integer = 0
                                    '        Dim Validext As String = ""
                                    '        FN = Left(txtBox.FileName, txtBox.FileName.LastIndexOf("."))
                                    '        ext = txtBox.FileName.Substring(txtBox.FileName.LastIndexOf("."), (txtBox.FileName.Length - txtBox.FileName.LastIndexOf(".")))
                                    '        If IsDBNull(dtField.Rows(j).Item("UploadAllowedTypes")) = True OrElse Trim(dtField.Rows(j).Item("UploadAllowedTypes")) = "" Then
                                    '        Else
                                    '            Dim type As String() = Split(dtField.Rows(j).Item("UploadAllowedTypes").ToString(), ",")

                                    '            For k As Integer = 0 To type.Length - 1
                                    '                If type(k) = ext Then
                                    '                    flag = 0 ' if file type is match then passed and saved into DB
                                    '                    Exit For
                                    '                Else
                                    '                    flag = 1 ' check for type of the not matched 
                                    '                    Validext &= type(k).ToString() & ","
                                    '                End If
                                    '            Next
                                    '            If flag = 0 Then
                                    '            Else
                                    '                updquery = "Invalid file type in (" & formname & ") allowed file types are (" & Validext.Substring(0, Validext.Length - 1) & ")"
                                    '                Return updquery
                                    '                Exit Function
                                    '            End If
                                    '        End If
                                    If txtBox1.Text IsNot "" Then
                                        'Prashant
                                        skipRow = 1
                                        lastRow = GR.RowIndex

                                        Dim ext As String = ""
                                        Dim flag As Integer = 0
                                        Dim Validext As String = ""
                                        Dim sourceFile As String = ""
                                        Dim curFileSize As Integer = 0
                                        If Not Request.QueryString("TID") Is Nothing Then
                                            sourceFile = Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text)
                                            Dim finfo As New FileInfo(Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text))
                                            ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                            curFileSize = finfo.Length
                                        Else
                                            Try
                                                Dim o As JObject = JObject.Parse(txtBox1.Text)
                                                Dim name As String() = CType(o("result"), String).Split("|")
                                                sourceFile = Server.MapPath("~/DOCS/temp/" + name(0))
                                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + name(0)))
                                                ext = name(0).Substring(name(0).LastIndexOf("."), name(0).Length - name(0).LastIndexOf("."))
                                                'ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                                curFileSize = finfo.Length
                                            Catch ex As Exception
                                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))
                                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                                curFileSize = finfo.Length
                                            End Try
                                            'sourceFile = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
                                            'Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))
                                            'ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                            'curFileSize = finfo.Length
                                        End If
                                        If IsDBNull(dtField.Rows(j).Item("UploadAllowedTypes")) = True OrElse Trim(dtField.Rows(j).Item("UploadAllowedTypes")) = "" Then
                                        Else
                                            Dim type As String() = Split(dtField.Rows(j).Item("UploadAllowedTypes").ToString(), ",")
                                            For k As Integer = 0 To type.Length - 1
                                                If type(k) = ext Then
                                                    flag = 0 ' if file type is match then passed and saved into DB
                                                    Exit For
                                                Else
                                                    flag = 1 ' check for type of the not matched
                                                    Validext &= type(k).ToString() & ","
                                                End If
                                            Next
                                            If flag = 0 Then
                                            Else
                                                'updquery = "Invalid file type in (" & formname & ") allowed file types are (" & Validext.Substring(0, Validext.Length - 1) & ")"
                                                'Return updquery
                                                'Exit Function
                                                ErrFlag &= "Invalid file type in (" & formname & ") " & dtField.Rows(j).Item("displayName").ToString() & ", "
                                                Flag1 += 1
                                            End If
                                        End If

                                    Else
                                        If dtField.Rows(j).Item("isrequired").ToString = "1" Then
                                            ErrFlag &= "Entered Child Value " & dtField.Rows(j).Item("displayName").ToString() & " is required, "
                                            Flag1 += 1
                                        Else
                                            'colValue = txtBox1.Text.ToString
                                            dateFields += 1
                                            'If txtBox1.Text.ToString.Trim = "" Then
                                            '    skipRow = 1
                                            '    lastRow = GR.RowIndex
                                            'End If
                                        End If

                                    End If
                                End If
                            Else

                            End If
                        Next

                    End If

                    cnt += 1
                End If
            End If

            If Flag1 < GV.Rows(0).Cells.Count - 1 - dateFields And ErrFlag.Trim <> "" Then
                If skipRow = 1 Then
                    updquery = ErrFlag
                    Return updquery.Substring(0, updquery.Length - 2)
                    Exit Function
                Else
                    prevRowIndex = GR.RowIndex
                    prevRowMsg = ErrFlag
                End If
            ElseIf Not prevRowMsg = "" And prevRowIndex < lastRow Then
                updquery = prevRowMsg
                Return updquery.Substring(0, updquery.Length - 2)
                Exit Function
            Else
                ''For Rule Engin
                If GR.RowType = DataControlRowType.DataRow Then
                    If GR.Cells(0).Text.ToUpper <> "TOTAL" And GR.RowIndex <= lastRow Then

                        Dim retObj As New RuleResponse()
                        Dim lstData As New List(Of UserData)
                        lstData = CType(Session("pColl"), List(Of UserData))
                        Dim lstChildData As New List(Of UserData)
                        Dim obj As New DynamicForm()
                        'obj.CreateCollection(pnlFields, dtField)
                        Dim onlyFiltered As DataView = dtField.DefaultView
                        onlyFiltered.RowFilter = "InlineEditing='1'"
                        Dim dtFields As DataTable = onlyFiltered.Table.DefaultView.ToTable()
                        lstChildData = obj.CreateGVCollection(GR, dtFields, GR.RowIndex)
                        'Initialising Rule objects


                        Dim objRule As New RuleEngin(Session("EID"), formname, "CREATED", "Submit")
                        Dim dsrule As DataSet = objRule.GetRules()
                        Dim dtrule As New DataTable
                        dtrule = dsrule.Tables(1)
                        For Each dr As DataRow In dsrule.Tables(0).Rows
                            retObj = objRule.ExecuteRule(lstData, lstChildData, True, "", dr, dtrule)
                            If retObj.Success = False Then
                                lblTab.Text = retObj.ErrorMessage
                                Return retObj.ErrorMessage
                                Exit Function
                            End If
                        Next
                        'retObj = objRule.ExecuteRule(lstData, lstChildData, True, "")
                        'If retObj.Success = False Then
                        '    Return retObj.ErrorMessage
                        '    Exit Function
                        'End If
                    End If
                End If
                DefRows = 1 + DefRows
            End If
        Next


        ''Return "Child form validated validated ..." & lastRow
        'Now Code For Unique validation
        Dim objU As New UpdateData()

        Dim dskeys As New DataSet()

        Dim DisplayMsg = ""

        dskeys = objU.GetKeys(Session("EID"), formname)

        Dim Keys As String = ""
        Dim arrlist As New ArrayList()
        If dskeys.Tables(0).Rows.Count > 0 Then
            If dskeys.Tables(0).Rows.Count > 0 Then
                For Each GR As GridViewRow In GV.Rows
                    Keys = ""
                    If GR.RowIndex <= lastRow Then
                        If GR.RowType = DataControlRowType.DataRow Then
                            If GR.Cells(0).Text.ToUpper <> "TOTAL" Then
                                DisplayMsg = ""
                                For m As Integer = 0 To dskeys.Tables(0).Rows.Count - 1
                                    Dim FieldID = dskeys.Tables(0).Rows(m).Item("FieldID").ToString
                                    Dim FieldType = dskeys.Tables(0).Rows(m).Item("FieldType").ToString
                                    If DisplayMsg = "" Then
                                        DisplayMsg = dskeys.Tables(0).Rows(m).Item("DisplayName").ToString
                                    Else
                                        DisplayMsg = DisplayMsg & ", " & dskeys.Tables(0).Rows(m).Item("DisplayName").ToString
                                    End If
                                    Select Case FieldType.Trim.ToUpper
                                        Case "TEXT BOX"
                                            Dim txtBox As TextBox = CType(GR.FindControl("fld" & FieldID & GR.RowIndex), TextBox)
                                            Keys = Keys & txtBox.Text.Trim.ToUpper()
                                        Case "DROP DOWN"
                                            Dim DDL As DropDownList = CType(GR.FindControl("fld" & FieldID & "_" & GR.RowIndex), DropDownList)
                                            Keys = Keys & DDL.SelectedItem.Value
                                        Case "CALCULATIVE FIELD"
                                            Dim txtBox As TextBox = CType(GR.FindControl("fld" & FieldID & GR.RowIndex), TextBox)
                                            Keys = Keys & txtBox.Text.Trim.ToUpper()
                                        Case "LOOKUP"
                                            Dim txtBox As TextBox = CType(GR.FindControl("fld" & FieldID & GR.RowIndex), TextBox)
                                            Keys = Keys & txtBox.Text.Trim.ToUpper()
                                        Case "LT LOOKUP"
                                            Dim txtBox As TextBox = CType(GR.FindControl("fld" & FieldID & GR.RowIndex), TextBox)
                                            Keys = Keys & txtBox.Text.Trim.ToUpper()
                                    End Select
                                Next
                                'Code For checking duplicate rows
                                Dim Test = Keys
                                Dim IsDuplicate = False
                                For Each item In arrlist
                                    If Keys.Trim.ToUpper = item.ToString.Trim.ToUpper Then
                                        IsDuplicate = True
                                    End If
                                Next
                                If IsDuplicate = False Then
                                    arrlist.Add(Test)
                                Else
                                    Return "Please check line number " & (GR.RowIndex + 1) & " of " & formname & "," & " Combination of " & DisplayMsg & " must be unique."
                                    Exit Function
                                End If
                            End If
                        End If
                    End If

                Next
            End If
        End If
        'Code for unique validation end here 
        Dim v = formname.Replace(" ", "_").Trim
        If DefRows > 0 And lastRow >= 0 Then
            ViewState("LastRow") = DefRows
        Else
            ViewState("LastRow") = lastRow
        End If

        Session(v & "LastRow") = lastRow
        ODA.Dispose()
        con.Close()
        con.Dispose()
        Return updquery

    End Function

#Region "Child Item Uploader"

    Protected Sub childClose(ByVal sender As Object, ByVal e As EventArgs)
        mdlChilditemUpload.Hide()
    End Sub

    Public Sub ShowChildItemUploadForm(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Dim btnDetails As Button = TryCast(sender, Button)
        Dim formname As String = btnDetails.Text
        formname = Right(formname, formname.Length - 7).Trim()
        Session("FN") = formname
        Session("ID") = Right(btnDetails.ID, btnDetails.ID.Length - 9)
        ViewState("ID") = "ADD" & Right(btnDetails.ID, btnDetails.ID.Length - 9).Trim()
        lblChldUpCaption.Text = "Upload " & formname
        UpChildItemUploader.Update()
        mdlChilditemUpload.Show()
    End Sub

    Protected Sub helpexport_Click(ByVal sender As Object, ByVal e As EventArgs)
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = Nothing
        Dim cmd As SqlCommand = Nothing
        Try
            Response.Clear()
            Response.Buffer = True
            Response.Charset = ""
            Response.ContentType = "application/vnd.ms-excel"

            con = New SqlConnection(conStr)
            'fill Product
            Dim ds As New DataSet
            Dim scrname As String = Right(lblChldUpCaption.Text, lblChldUpCaption.Text.Length - 7).Trim()
            Response.AddHeader("content-disposition", _
              "attachment;filename=" & scrname & ".xls")
            'With(nolock) added by Himank on 29th sep 2015
            Dim da As New SqlDataAdapter("SELECT displayName[Display Name],case isRequired when 0 then 'No' when 1 then 'Yes' end [Mandatory Fields],case datatype when 'text' then 'Text' when 'numeric' then 'Numeric Digits' when 'Datetime' then 'Date in (DD/MM/YY)' end [Data Type],case MinLen when 0 then '' else MinLen end [Minimum Length], case MaxLen when 0 then '' else maxlen end [Maximum Length] FROM MMM_MST_FIELDS   WITH(NOLOCK) where EID =" & Session("EID").ToString() & " and DocumentType ='" & scrname & "' AND ISACTIVE=1 AND FieldType<>'Lookup' AND FieldType <>'Formula Field' and FieldType <> 'Calculative Field' order by displayOrder ", con)
            Dim query As String = "SELECT displayName,case isRequired when 0 then 'No' when 1 then 'Yes' end [Mandatory Fields],case datatype when 'text' then 'Text' when 'numeric' then 'Numeric Digits' when 'Datetime' then 'Date in (DD/MM/YY)' end [Data Type],case MinLen when 0 then '' else MinLen end [Minimum Length], case MaxLen when 0 then '' else maxlen end [Maximum Length] FROM MMM_MST_FIELDS   WITH(NOLOCK) where EID =" & Session("EID").ToString() & " and DocumentType ='" & scrname & "' AND ISACTIVE=1 AND FieldType<>'Lookup' AND FieldType <>'Formula Field' and FieldType <> 'Calculative Field' order by displayOrder "
            cmd = New SqlCommand(query, con)
            con.Open()
            Dim dr As SqlDataReader = cmd.ExecuteReader(CommandBehavior.CloseConnection)
            Dim dt As DataTable = New DataTable()
            Dim dt2 As DataTable = New DataTable()
            Dim dt3 As DataTable = New DataTable()

            dt.Load(dr)
            da.Fill(ds, "data")
            dt3 = ds.Tables("data")
            dt2 = GetInversedDataTable(dt, "displayname", "")
            Dim gvex As New GridView()
            dt2.Rows.Add()

            gvex.AllowPaging = False
            gvex.DataSource = dt2
            gvex.DataBind()
            Dim gvexx As New GridView()
            gvexx.AllowPaging = False
            gvexx.DataSource = dt3

            gvexx.DataBind()
            Response.Clear()
            Response.Buffer = True
            Dim sw As New StringWriter()
            Dim hw As New HtmlTextWriter(sw)

            Dim tb As New Table()
            Dim tr1 As New TableRow()
            Dim cell1 As New TableCell()
            cell1.Controls.Add(gvex)
            tr1.Cells.Add(cell1)
            Dim cell3 As New TableCell()
            cell3.Controls.Add(gvexx)
            Dim cell2 As New TableCell()
            cell2.Text = "&nbsp;"

            Dim tr2 As New TableRow()
            tr2.Cells.Add(cell2)
            Dim tr3 As New TableRow()
            tr3.Cells.Add(cell3)
            tb.Rows.Add(tr1)
            tb.Rows.Add(tr2)
            tb.Rows.Add(tr3)

            tb.RenderControl(hw)

            'style to format numbers to string 
            Dim style As String = "<style> .textmode { mso-number-format:\@; } </style>"
            Response.Write(style)
            Response.Output.Write(sw.ToString())
            Response.Flush()
            Response.[End]()

        Catch ex As Exception
            lblMsg.ForeColor = Drawing.Color.Red
            lblMsg.Text = "An error occured when Downloading data. Please try again"
        Finally
            If Not con Is Nothing Then
                con.Close()
                con.Dispose()
            End If
            If Not cmd Is Nothing Then
                cmd.Dispose()
            End If
        End Try
    End Sub

    Function GetInversedDataTable(ByVal table As DataTable, ByVal columnX As String, ByVal nullValue As String) As DataTable

        Dim returnTable As New DataTable()
        If columnX = "" Then
            columnX = table.Columns(0).ColumnName
        End If

        Dim columnXValues As New List(Of String)()

        For Each dr As DataRow In table.Rows
            Dim columnXTemp As String = dr(columnX).ToString()
            If Not columnXValues.Contains(columnXTemp) Then
                columnXValues.Add(columnXTemp)
                returnTable.Columns.Add(columnXTemp)
            End If
        Next
        If nullValue <> "" Then
            For Each dr As DataRow In returnTable.Rows
                For Each dc As DataColumn In returnTable.Columns
                    If dr(dc.ColumnName).ToString() = "" Then
                        dr(dc.ColumnName) = nullValue
                    End If
                Next
            Next
        End If
        Return returnTable

    End Function

    Protected Sub btnUpload_Click(sender As Object, e As EventArgs)
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = Nothing
        Dim cmd As SqlCommand = Nothing
        Dim dt2 As DataTable = New DataTable()
        Dim SB As New StringBuilder()
        Dim ErrorLineNumber = 0
        Dim FormName = ""
        Dim scrname As String = Right(lblChldUpCaption.Text, lblChldUpCaption.Text.Length - 7).Trim()
        Dim dtData As New DataTable
        Dim dterrorResult As New DataTable
        FormName = Session("FN").ToString()
        Try
            'Code For Loading loading csv file
            If Not Session(FormName) Is Nothing Then
                Session(FormName) = Nothing
                Session(FormName & "VAL") = Nothing
            End If
            If FUPChilditem.HasFile Then
                If Right(FUPChilditem.FileName, 4).ToUpper() = ".CSV" Then
                    Dim filename As String = "COLL" & Now.Day & Now.Month & Now.Year & Now.Hour & Now.Minute & Now.Minute & Now.Second & Now.Millisecond & Right(FUPChilditem.FileName, 4).ToUpper()
                    FUPChilditem.PostedFile.SaveAs(Server.MapPath("Import/") & filename)
                    Dim ir As Integer = 0
                    Dim sField As String()
                    Dim csvReader As Microsoft.VisualBasic.FileIO.TextFieldParser
                    csvReader = My.Computer.FileSystem.OpenTextFieldParser(Server.MapPath("Import/") & filename, ",")
                    dtData = GetDataFromExcel(filename)
                    dterrorResult = dtData.Clone()
                    dterrorResult.Columns.Add("Service_response")
                    Dim Count As Integer = 0
                    Dim arr As String()
                    With csvReader
                        .TextFieldType = Microsoft.VisualBasic.FileIO.FieldType.Delimited
                        .Delimiters = New String() {","}
                        While Not .EndOfData
                            sField = .ReadFields()
                            'For Header Field
                            If Count = 0 Then
                                arr = sField
                            Else
                                For k As Integer = 0 To arr.Count - 1
                                    SB.Append("|")
                                    SB.Append(arr(k) & "::" & sField(k))
                                Next
                            End If
                            Count = Count + 1
                            SB.Append("{}")
                        End While
                    End With

                End If
            End If
            'Beaking each line
            Dim dtField As New DataTable
            Dim DTVALUE As New DataTable
            Dim DTError As New DataTable
            con = New SqlConnection(conStr)

            Dim DS As New DataSet
            'With(nolock) added by Himank on 29th sep 2015
            Dim oda As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF   WITH(NOLOCK) left outer JOIN MMM_MST_FORMS F   WITH(NOLOCK) on F.FormName = FF.DocumentType and F.EID = FF.EID  where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FormName = '" & FormName & "' order by displayOrder;select fieldid from mmm_mst_fields where dropdown='" & FormName & "' and eid=" & Session("EID") & "", con)
            con.Open()
            oda.Fill(DS, "CHILD")
            Session("CHILD") = DS.Tables("CHILD")
            Session("D" & FormName) = DS.Tables("CHILD")
            Dim dt As DataTable = New DataTable()
            dt2 = GetInversedDataTable(DS.Tables("CHILD"), "displayname", "")
            dtField = dt2.Clone()
            dtField.Columns.Add("tid")
            DTVALUE = dt2.Clone()
            'DTError
            DTError = dt2.Clone()
            'DTError.Columns.Add("ErrMsg")
            Dim strData = SB.ToString().Trim()
            Dim StrMessage = ""
            Dim ErrMsgLog = ""
            If strData <> "" Then
                Dim ArrData = Split(strData, "{}")
                If ArrData.Count > 0 Then
                    For m As Integer = 0 To ArrData.Count - 1

                        If ArrData(m) <> "" Then
                            ErrorLineNumber = ErrorLineNumber + 1
                            Dim lineItem As New LineitemWrap()
                            Dim Flag = False
                            StrMessage = CommanUtil.ValidateParameterByDocumentType(Session("EID"), scrname, Session("UID"), ArrData(m), lineItem, Flag, True)
                            Dim Count = dtField.Rows.Count
                            Dim CurRowIndex = 0
                            If Count > 0 Then
                                CurRowIndex = Count
                            End If
                            '2914 on call live 
                            '2903 on fixed pool
                            'Independent of BMP Config Hard Code For HFCL 
                            Dim DocumentType = Server.UrlDecode(Request.QueryString("SC"))
                            If Session("EID") = "32" And DocumentType = "Expense Claim Fixed Pool" Then
                                Dim DDLVCN = DirectCast(pnlFields.FindControl("fld" & "2903"), DropDownList)
                                If Not DDLVCN Is Nothing Then
                                    Dim VCNum = DDLVCN.SelectedItem.Text
                                    For Each data1 In lineItem.DataItem
                                        '2853 on call live 
                                        '2836 Fixed pool live 
                                        If data1.FieldID = "2836" Then
                                            If data1.DDLValue = VCNum Then
                                                If Flag = True Then
                                                    Flag = True
                                                End If
                                            Else
                                                'IF VC Number of parent document and child document do not maching it is invalid
                                                Flag = False
                                                StrMessage = "Please check 'Value Contract No' of document and 'VC No.' of child item,both should be same."
                                            End If
                                            Exit For
                                        End If
                                    Next
                                End If
                            End If
                            If Flag = True Then
                                dtField.Rows.Add()
                                DTVALUE.Rows.Add()
                                For Each column In dtField.Columns
                                    For Each data1 In lineItem.DataItem
                                        If column.ToString().Trim() = data1.DisplayName Then
                                            If data1.FieldType = "Drop Down" Or data1.FieldType = "LookupDDL" Then
                                                DTVALUE.Rows(CurRowIndex).Item(column.ToString()) = data1.Values
                                                dtField.Rows(CurRowIndex).Item(column.ToString()) = data1.DDLValue
                                            Else
                                                DTVALUE.Rows(CurRowIndex).Item(column.ToString()) = data1.Values
                                                dtField.Rows(CurRowIndex).Item(column.ToString()) = data1.Values
                                            End If
                                            Exit For
                                        End If
                                    Next
                                Next
                                dtField.Rows(CurRowIndex).Item("tid") = FormName & "-" & dtField.Rows.Count & "-" & ViewState("ID")
                                'push error data into a fix error table
                            Else
                                DTError.Rows.Add()
                                Dim Count1 = DTError.Rows.Count
                                Dim CurRowIndex1 = Count1 - 1
                                ErrMsgLog = ErrMsgLog & "$$" & ErrorLineNumber & "::" & StrMessage
                                GetRandomRows(dtData, ErrorLineNumber - 1, dterrorResult, ErrMsgLog)
                            End If
                        End If
                    Next
                End If
            End If
            'Executing Formula... 
            If dtField.Rows.Count > 0 Then
                For i As Integer = 0 To dtField.Rows.Count - 1
                    'loop For finding formula field
                    For Each column In dtField.Columns
                        Dim strSearch = "displayName='" & column.ToString() & "'"
                        Dim Dr As DataRow() = DS.Tables("CHILD").Select(strSearch)
                        If Not Dr Is Nothing And Dr.Length > 0 Then
                            If Not String.IsNullOrEmpty(Dr(0).Item("FieldType").ToString()) And Dr(0).Item("FieldType").ToString().ToUpper() = "FORMULA FIELD" Then
                                Dim forchexec As String = String.Empty
                                Dim formula As New formulaEditor()
                                forchexec = formula.executeformulachielditem(Dr(0).Item("KC_LOGIC"), dtField.Rows(i), dtField)
                                dtField.Rows(i).Item(column) = forchexec
                                DTVALUE.Rows(i).Item(column.ToString()) = forchexec
                            End If
                        End If
                    Next
                Next
                Session(FormName) = dtField
                Session(FormName & "VAL") = DTVALUE
                BINDGRID1(dtField)
            Else
                Dim GID As String = Right(ViewState("ID"), ViewState("ID").ToString().Length - 3)
                Dim GV As GridView = CType(pnlFields.FindControl("GRD" & GID.ToString()), GridView)
                GV.DataSource = Nothing
                GV.DataBind()
            End If
            If String.IsNullOrEmpty(ErrMsgLog.Trim()) Then
                Session("ErrUpload" & FormName) = Nothing
            Else
                ErrMsgLog = ErrMsgLog.Replace("Error(s) in document " & scrname & ".", "")
                Session("ErrUpload" & FormName) = ErrMsgLog.Trim()
                Dim imgExport As ImageButton = (pnlFields.FindControl("btnExportError" & DS.Tables("CHILD1").Rows(0)(0)))
                If Not IsNothing(imgExport) Then
                    AddHandler imgExport.Click, AddressOf Me.imgExport_Click
                End If

                Dim lblError As New Label()
                lblError = pnlFields1.FindControl("lblUpError" & FormName)
                Dim str = ShowDownLoadError(ErrMsgLog.Trim())
                lblError.Text = str.Trim()

                'lblUpError
            End If

            'ErrMsgLog
            If dterrorResult.Rows.Count > 0 Then
                ViewState("ERRORDATA") = dterrorResult
            Else
                ViewState("ERRORDATA") = Nothing
            End If
        Catch ex As Exception
            Dim lblError1 As New Label()
            lblError1 = pnlFields1.FindControl("lblUpError" & scrname)
            lblError1.Text = ex.Message
        Finally
            If Not con Is Nothing Then
                con.Close()
                con.Dispose()
            End If
            If Not cmd Is Nothing Then
                cmd.Dispose()
            End If
        End Try
    End Sub
    'This function will obsolete now  
    Protected Sub imgExport_Click(sender As Object, e As ImageClickEventArgs)
        Dim gvex As New GridView()
        If Not IsNothing(ViewState("ERRORDATA")) Then
            Response.Clear()
            Response.Buffer = True
            Response.Charset = ""
            Response.ContentType = "application/vnd.ms-excel"
            Dim filename As String = Session("FN").ToString()
            filename = filename.Replace(" ", "_")
            Response.AddHeader("content-disposition", "attachment;filename=" & filename & "_ERROR.xls")
            Dim dt2 As DataTable = ViewState("ERRORDATA")
            gvex.AllowPaging = False
            gvex.DataSource = dt2
            gvex.DataBind()
            Response.Clear()
            Response.Buffer = True
            Dim sw As New StringWriter()
            Dim hw As New HtmlTextWriter(sw)

            Dim tb As New Table()
            Dim tr1 As New TableRow()
            Dim cell1 As New TableCell()
            cell1.Controls.Add(gvex)
            tr1.Cells.Add(cell1)
            Dim cell2 As New TableCell()
            cell2.Text = "&nbsp;"
            Dim tr2 As New TableRow()
            tr2.Cells.Add(cell2)
            Dim tr3 As New TableRow()
            tb.Rows.Add(tr1)
            tb.Rows.Add(tr2)
            tb.Rows.Add(tr3)
            tb.RenderControl(hw)
            'style to format numbers to string 
            Dim style As String = "<style> .textmode { mso-number-format:\@; } </style>"
            Response.Write(style)
            Response.Output.Write(sw.ToString())
            Response.Flush()
            Response.[End]()
        End If

    End Sub
    Private Function GetRandomRows(ByVal table As DataTable, ByVal rowCount As Integer, ByVal restable As DataTable, ByVal str As String) As DataTable
        Dim selector As New Random
        'Dim selections As DataTable = table.Clone()
        Dim row As DataRow
        row = table.Rows(rowCount)
        restable.ImportRow(row)
        restable.Rows(restable.Rows.Count - 1).Item("Service_response") = str

        'For count As Integer = 1 To Math.Min(rowCount, table.Rows.Count)
        '    row = table.Rows(selector.Next(0, table.Rows.Count))
        '    row.Item("Service_response") = str
        '    restable.ImportRow(row)
        '    'table.Rows.Remove(row)
        'Next

        Return restable
    End Function

    Public Function GetDataFromExcel(ByVal strDataFilePath As String) As DataTable
        ' GetDataFromExcel123(strDataFilePath)
        Try
            Dim sr As New StreamReader(Server.MapPath("~/Import/" & strDataFilePath))
            Dim FileName = Server.MapPath("~/Import/" & strDataFilePath)
            Dim fullFileStr As String = sr.ReadToEnd()
            sr.Close()
            sr.Dispose()
            Dim lines As String() = fullFileStr.Split(ControlChars.Lf)
            Dim recs As New DataTable()
            Dim sArr As String() = lines(0).Split(","c)
            For Each s As String In sArr
                recs.Columns.Add(New DataColumn(s.Trim()))
            Next
            Dim row As DataRow
            Dim finalLine As String = ""
            Dim i As Integer = 0
            For Each line As String In lines
                If i > 0 And Not String.IsNullOrEmpty(line.Trim()) Then
                    row = recs.NewRow()
                    finalLine = line.Replace(Convert.ToString(ControlChars.Cr), "")
                    row.ItemArray = finalLine.Split(","c)
                    recs.Rows.Add(row)
                End If
                i = i + 1
            Next
            Return recs
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Protected Function ShowDownLoadError(strError As String) As String
        Dim str = ""
        Dim SB As New StringBuilder()
        SB.Append("<table cellpadding='2' width='100%' border='2px'><tr style='background-color:#000000; color:white;'><td>Error Line No.</td><td>Error.</td></tr>")
        Dim arr As String() = Split(strError, "$$")
        For i As Integer = 0 To arr.Count - 1
            If arr(i) <> "" Then
                Dim arr1 As String() = Split(arr(i), "::")
                SB.Append("<tr><td>" & arr1(0) & "</td><td style='color:red;' >" & arr1(1) & "</td></tr>")
            End If
        Next
        SB.Append("</table>")
        str = SB.ToString()
        Return str
    End Function

#End Region

    'Calculate Button by Komal on 18March2014
    Protected Sub CalculateFormulaP(sender As Object, e As EventArgs)
        Dim viewdoc As String = Request.QueryString("SC").ToString()
        CalculateFormulaParent(viewdoc)
    End Sub
    Protected Sub CalculateFormulaC(sender As Object, e As EventArgs)

        'Prashant 30-6-2014
        ResetGrid()
        Dim viewdoc As String = Session("FN").ToString
        CalculateFormulaChild(viewdoc)
    End Sub
    Protected Sub CalculateFormulaParent(Documenttype As String)
        Dim Formula As String
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim screenname As String = Request.QueryString("SC").ToString()
        Dim ob As New DynamicForm
        Dim viewdoc As String = screenname
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If
        'With(nolock) added by Himank on 29th sep 2015
        Dim da As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF  WITH(NOLOCK)  left outer JOIN MMM_MST_FORMS F  WITH(NOLOCK)  on F.FormName = FF.DocumentType and F.EID = FF.EID where (FF.isactive=1 or Fieldtype='auto number') and F.EID=" & Session("EID").ToString() & " and FormName = '" & Documenttype & "' and FF.isActive=1 order by displayOrder", con)
        Dim ds As New DataSet
        da.Fill(ds, "fields")


        Dim onlyFiltered As DataView = ds.Tables(0).DefaultView
        onlyFiltered.RowFilter = "Fieldtype='Formula Field'"
        Dim FormulaFlds As DataTable = onlyFiltered.Table.DefaultView.ToTable()           ' Formula Fields Datatable
        Dim CalculativeField() As DataRow = ds.Tables("fields").Select("Fieldtype='Formula Field'")
        viewdoc = viewdoc.Replace(" ", "_")

        If CalculativeField.Length > 0 Then
            For i As Integer = 0 To FormulaFlds.Rows.Count - 1
                Dim formulaeditorr As New formulaEditor
                Dim forvalue As String = String.Empty
                Formula = ob.FormulaCalculation(FormulaFlds.Rows(i).Item("KC_LOGIC"), FormulaFlds, ds.Tables("fields"), pnlFields)      'Get Values in formula Fileds from Control
                forvalue = formulaeditorr.CalculateFormulaonFly(Formula)
                'ob.FillFormulaControlsOnPanel(forvalue, FormulaFlds, pnlFields)
                Dim txtBox As New TextBox
                txtBox = CType(pnlFields.FindControl("fld" & FormulaFlds.Rows(i).Item("FieldID").ToString()), TextBox)
                txtBox.Text = forvalue
                'Dim upquery As String = "update " & CField.Item("DBTableName").ToString & "  set  " & CField.Item("FieldMapping").ToString & "='" & forvalue.ToString & "'  where tid =" & 32 & ""
                'da.SelectCommand.CommandText = upquery
                'da.SelectCommand.CommandType = CommandType.Text
                'da.SelectCommand.ExecuteNonQuery()
            Next
            con.Close()
        End If
    End Sub
    Protected Sub CalculateFormulaChild(Documenttype As String)
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim screenname As String = Request.QueryString("SC").ToString()
        Dim ob As New DynamicForm
        Dim viewdoc As String = screenname
        Dim forvalue As String = String.Empty
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If
        'With(nolock) added by Himank on 29th sep 2015
        Dim da As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF  WITH(NOLOCK)  left outer JOIN MMM_MST_FORMS F  WITH(NOLOCK)  on F.FormName = FF.DocumentType and F.EID = FF.EID where (FF.isactive=1 or Fieldtype='auto number') and F.EID=" & Session("EID").ToString() & " and FormName = '" & Documenttype & "' and FF.isActive=1 order by displayOrder", con)
        Dim ds As New DataSet
        da.Fill(ds, "fields")


        Dim onlyFiltered As DataView = ds.Tables(0).DefaultView
        onlyFiltered.RowFilter = "Fieldtype='Formula Field'"
        Dim FormulaFlds As DataTable = onlyFiltered.Table.DefaultView.ToTable()           ' Formula Fields Datatable
        Dim CalculativeField() As DataRow = ds.Tables("fields").Select("Fieldtype='Formula Field'")
        viewdoc = viewdoc.Replace(" ", "_")
        Dim a As String = Session("CHILD").ToString

        If CalculativeField.Length > 0 Then

        End If
        For i As Integer = 0 To FormulaFlds.Rows.Count - 1

        Next
        'Dim formulaeditorr As New formulaEditor
        'Dim forvalue As String = String.Empty
        'forvalue = formulaeditorr.CalculateFormulaonFlyc(FormulaFlds.Rows(i).Item("KC_LOGIC"), ds.Tables("fields"))
        Dim dtFD As New DataTable
        Dim dtField As New DataTable
        Dim DTVALUE As New DataTable
        Dim fileSize As Integer = 0
        Dim allowedSize As Integer = 0
        Dim flagFsize As Integer = 0
        Dim errormsg As String = "Please "
        dtField = ds.Tables("fields")     'datatable of Fields in Child Form'
        '' OB.ADDITEMTOGRID(dtField, FORMNAME, pnlFields1)
        'Check Child Fomr in Session'
        For Each dr As DataRow In dtField.Rows
            dtFD.Columns.Add(dr.Item("displayname"), GetType(String))             'Add fields Name in New Datatable'
            DTVALUE.Columns.Add(dr.Item("Displayname"), GetType(String))
        Next
        dtFD.Columns.Add("tid", GetType(String))
        Dim drnew As DataRow = dtFD.NewRow()
        Dim DRNEWVAL As DataRow = DTVALUE.NewRow()
        For Each dr As DataRow In dtField.Rows
            Dim dispName As String = dr.Item("displayname").ToString()
            Select Case dr.Item("FieldType").ToString().ToUpper()
                Case "TEXT BOX"
                    Dim txtBox As TextBox = CType(pnlFields1.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
                    If dr.Item("isrequired").ToString() = 1 And txtBox.Text.Trim.Length < 1 Then
                        errormsg &= dispName & ","

                    End If
                    If dr.Item("datatype") = "Datetime" Then
                        Dim str1 As String() = Split(txtBox.Text, "/")
                        If str1.Length = 3 Then
                            Dim strDate1 As String = str1(1) & "/" & str1(0) & "/" & str1(2)
                            txtBox.Text = strDate1

                        Else
                            errormsg &= "Date is not in correct format at " & dispName & ","
                            Continue For
                        End If
                        If Not IsDate(txtBox.Text) Then
                            errormsg &= "Date is not in correct format at " & dispName & ","
                            Continue For
                        Else
                            txtBox.Text = Format(Convert.ToDateTime(txtBox.Text.ToString), "dd/MM/yy")
                            Dim str As String() = Split(txtBox.Text, "/")
                            Dim strDate As String = str(0).PadLeft(2, "0") & "/" & str(1).PadLeft(2, "0") & "/" & str(2).PadLeft(2, "0")
                            txtBox.Text = strDate
                        End If
                    End If
                    If txtBox.Text.Length < CInt(dr.Item("minlen").ToString) And txtBox.Text.Length > 0 And dr.Item("datatype").ToString.ToUpper <> "DATETIME" Then
                        errormsg &= "Minimum  " & dr.Item("minlen").ToString() & " character in " & dispName & ","
                        Continue For
                    End If
                    If txtBox.Text.Length > CInt(dr.Item("maxlen").ToString) And txtBox.Text.Length > 0 And dr.Item("datatype").ToString.ToUpper <> "DATETIME" Then
                        errormsg &= "Maximum  " & dr.Item("maxlen").ToString() & " character in " & dispName & ","
                        Continue For
                    End If

                    If dr.Item("isunique").ToString() = "1" Then
                        If ob.checkduplicate("ADD", 0, dr.Item("DBTABLENAME").ToString, dr.Item("Fieldmapping").ToString(), txtBox.Text, dr.Item("DOCUMENTTYPE").ToString) Then
                            errormsg &= "unique " & dispName & " ,"
                            Exit For
                        End If
                    End If
                    drnew.Item(dr.Item("displayname")) = txtBox.Text
                Case "DROP DOWN"
                    Dim txtBox As DropDownList = CType(pnlFields1.FindControl("fld" & dr.Item("FieldID").ToString()), DropDownList)
                    If dr.Item("isrequired").ToString() = 1 And txtBox.SelectedItem.Text.ToUpper = "SELECT" Then
                        errormsg &= dispName & ","
                        Continue For
                    End If
                    If UCase(dr.Item("dropdowntype").ToString()) = "FIX VALUED" Then
                        drnew.Item(dr.Item("displayname")) = txtBox.SelectedItem.Text
                    Else
                        'Dim fldpair() As String = txtBox.SelectedValue.ToString().Split("|")
                        If dr.Item("lookupvalue").ToString().Length > 2 Then
                            Dim fldpair() As String = txtBox.SelectedValue.ToString().Split("|")
                            'dataField &= "'" & fldpair(0).ToString() & "',"
                            drnew.Item(dr.Item("displayname")) = txtBox.SelectedItem.Text
                        Else
                            'dataField &= "'" & txtBox.SelectedValue.ToString() & "',"
                            drnew.Item(dr.Item("displayname")) = txtBox.SelectedItem.Text
                        End If
                    End If
                Case "CALCULATIVE FIELD"
                    Dim txtBox As TextBox = CType(pnlFields1.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
                    If dr.Item("isrequired").ToString() = 1 And txtBox.Text.Length < 1 Then
                        errormsg &= dispName & ","
                        Continue For
                    End If
                    drnew.Item(dr.Item("displayname")) = txtBox.Text
                Case "LOOKUP"
                    Dim txtBox As TextBox = CType(pnlFields1.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
                    If dr.Item("isrequired").ToString() = 1 And txtBox.Text.Length < 1 Then
                        errormsg &= dispName & ","
                        Continue For
                    End If
                    drnew.Item(dr.Item("displayname")) = txtBox.Text
                Case "CHECKBOX LIST"
                    Dim txtBox As CheckBoxList = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), CheckBoxList)
                    If dr.Item("isrequired").ToString() = 1 And txtBox.SelectedItem.Text.Length < 1 Then
                        errormsg &= dispName & ","
                        Continue For
                    End If
                    Dim livalue As String = ""
                    Dim litext As String = ""
                    If UCase(dr.Item("dropdowntype").ToString()) = "FIX VALUED" Then
                        For Each li As ListItem In txtBox.Items
                            If li.Selected Then
                                livalue &= li.Text & ","
                            End If
                        Next
                        livalue = Left(livalue, livalue.Length - 1)
                        'dataField &= "'" & livalue & "',"
                        drnew.Item(dr.Item("displayname")) = livalue
                    Else
                        For Each li As ListItem In txtBox.Items
                            If li.Selected Then
                                livalue &= li.Value & ","
                                litext &= li.Text & ","
                            End If
                        Next
                        livalue = Left(livalue, livalue.Length - 1)
                        drnew.Item(dr.Item("displayname")) = litext
                    End If

                Case "LIST BOX"
                    Dim txtBox As ListBox = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), ListBox)
                    If dr.Item("isrequired").ToString() = 1 And txtBox.SelectedItem.Text.Length < 1 Then
                        errormsg &= dispName & ","
                        Continue For
                    End If
                    Dim livalue As String = ""
                    Dim litext As String = ""
                    If UCase(dr.Item("dropdowntype").ToString()) = "FIX VALUED" Then
                        For Each li As ListItem In txtBox.Items
                            If li.Selected Then
                                livalue &= li.Text & ","
                            End If
                        Next
                        livalue = Left(livalue, livalue.Length - 1)
                        drnew.Item(dr.Item("displayname")) = livalue
                    Else
                        For Each li As ListItem In txtBox.Items
                            If li.Selected Then
                                livalue &= li.Value & ","
                                litext &= li.Text & ","
                            End If
                        Next
                        livalue = Left(livalue, livalue.Length - 1)
                        drnew.Item(dr.Item("displayname")) = litext
                    End If
                Case "TEXT AREA"
                    Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
                    If dr.Item("isrequired").ToString() = 1 And txtBox.Text.Length < 1 Then
                        errormsg &= dispName & ","
                        Continue For
                    End If
                    drnew.Item(dr.Item("displayname")) = ob.getSafeString(txtBox.Text)
                    'qryField &= ds.Rows(i).Item("Fieldmapping").ToString() & ","
                    'dataField &= "'" & getSafeString(txtBox.Text) & "',"
                Case "CHILD ITEM TOTAL"
                    Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), TextBox)
                    drnew.Item(dr.Item("displayname")) = txtBox.Text
                    DRNEWVAL.Item(dr.Item("displayname")) = txtBox.Text
            End Select
        Next
        Dim oda As New SqlDataAdapter("", con)
        oda.SelectCommand.CommandText = "select displayName,FieldMapping,KC_LOGIC  from mmm_mst_fields  where FieldType='Formula Field' and eid=" & Session("EID") & " and documenttype='" & Documenttype & "' "
        Dim dt As New DataTable()
        oda.Fill(dt)
        drnew.Item("tid") = Documenttype & "-" & dtFD.Rows.Count & "-" & ViewState("ID")
        If dt.Rows.Count > 0 Then
            For i As Integer = 0 To dt.Rows.Count - 1
                '  dt.Rows(0)("Value") = ""
                Dim forchexec As String = String.Empty
                Dim formula As New formulaEditor()

                forchexec = formula.executeformulachielditem(dt.Rows(i).Item("KC_LOGIC"), drnew, dtFD)
                Dim txtBox As New TextBox
                txtBox = CType(pnlFields.FindControl("fld" & FormulaFlds.Rows(i).Item("FieldID").ToString()), TextBox)
                txtBox.Text = forchexec
            Next
            con.Close()
        End If
    End Sub

#Region "draft of documnet" ' by balli
    Protected Sub DraftDoc(ByVal sender As Object, ByVal e As EventArgs)
        'This code is copies from ValidateDate function  
        Dim ret As Integer = 0



        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim tran As SqlTransaction = Nothing
        con.Open()
        tran = con.BeginTransaction()
        If Not Request.QueryString("TID") Is Nothing Then
            ret = ValidateDatadraft("EDIT", con, tran)
            If ret = 0 Then
                tran.Rollback()
                Exit Sub
            Else
                lbldraftmsgpop.Text = "Updated System Draftid is " & Request.QueryString("TID")
                tran.Commit()
                upddraftmsg.Update()
                popupDraftmsg.Show()
            End If
        Else
            Dim screenname As String = Request.QueryString("SC").ToString()
            Dim da As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF left outer JOIN MMM_MST_FORMS F on F.FormName = FF.DocumentType and F.EID = FF.EID where (FF.isactive=1 or Fieldtype='auto number') and F.EID=" & Session("EID").ToString() & " and FormName = '" & screenname & "' order by displayOrder", con)
            da.SelectCommand.Transaction = tran
            Dim ds As New DataSet
            da.Fill(ds, "fields")
            Dim ob As New DynamicForm
            Dim FinalQry As String
            Dim msgAN As String = ""
            Dim DocID As Integer = 0
            Dim childvalidation As String = ""
            ' here is the code for calculation inline grid 
            Dim childDt() As DataRow = ds.Tables("fields").Select("fieldtype='child item'")
            For K As Integer = 0 To childDt.Length - 1
                CalculateGRid(screenname, childDt(K).Item("fieldid").ToString())
            Next
            'End here
            FinalQry = ob.ValidateAndGenrateQueryForControls("ADD", "INSERT INTO MMM_MST_DOC_DRAFT(EID,Documenttype,oUID,adate,", "VALUES (" & Session("EID").ToString() & ",'" & screenname & "'," & Session("UID").ToString() & ",getdate(),", ds.Tables("fields"), pnlFields, 0)
            If Trim(Left(FinalQry, 6)).ToUpper() = "PLEASE" Then
                lblTab.Text = FinalQry
            Else
                '' for checking the value of allowed size if file is valid or not 
                If IsDBNull(ds.Tables("fields").Rows(0).Item("AttahcedFileSize")) = True Or Val(ds.Tables("fields").Rows(0).Item("AttahcedFileSize").ToString()) = 0 Then
                Else
                    If Session("FileSize") > Val(Val(ds.Tables("fields").Rows(0).Item("AttahcedFileSize").ToString()) * 1024 * 1024) Then
                        lblTab.Text = "Please note your attachment cannot be uploaded as it exceeds prescribed limit. Please ensure that file size does not exceed '" & ds.Tables("fields").Rows(0).Item("attahcedfilesize").ToString() & "' MB and try again"
                        Session("FileSize") = Nothing
                        Exit Sub
                    End If
                End If
                ''Code For Rule Engine By Ajeet Kumar Dated :30-july-2014
                'Dim dv As DataView = ds.Tables("fields").DefaultView
                'dv.RowFilter = "IsActive=1"
                'Dim theFields As DataTable = dv.ToTable
                'Dim lstData As New List(Of UserData)
                'Dim obj As New DynamicForm()
                ''Creating collection for rule engine execution
                'lstData = obj.CreateCollection(pnlFields, theFields)
                ''Setting it to session for getting it's value for child Item validation
                'Session("pColl") = lstData
                ''validation for child item inline item 
                Dim validatechilditem() As DataRow = ds.Tables("fields").Select("Fieldtype='CHILD ITEM'")
                If validatechilditem.Length > 0 Then
                    For Each DR As DataRow In validatechilditem
                        '' new added for saving differently if def. value feature is on
                        Dim strDF As String = "select * from mmm_mst_forms where formname='" & DR.Item("DROPDOWN") & "' and formsource='DETAIL FORM' and EID=" & Session("EID") & " and  ( isnull(HasDefaultValue,0)=1 or isnull(IsDefaultRows,0)>0 or isnull(isinlineediting,0)=1)"
                        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
                        Dim dtIsdv As New DataTable
                        oda.SelectCommand.CommandText = strDF
                        oda.SelectCommand.Transaction = tran
                        oda.Fill(dtIsdv)
                        childvalidation = ValidatingChildItem_DV(DR.Item("DROPDOWN"))
                        If childvalidation.Length > 5 Then
                            lblTab.Text = childvalidation
                            Exit Sub
                        End If
                    Next
                End If
                'chidvalidation = ValidatingChildItem_DV(DR.Item("DROPDOWN"), fileid)
                FinalQry = FinalQry & ";Select @@identity"
                'save the data
                lblTab.Text = ""
                da.SelectCommand.CommandText = FinalQry
                da.SelectCommand.Transaction = tran
                If con.State <> ConnectionState.Open Then
                    con.Open()
                End If
                Dim fileid As Integer = da.SelectCommand.ExecuteScalar()
                DocID = fileid
                'Commented By Ajeet on 29March2014
                'Dim row As DataRow() = ds.Tables("fields").Select("Fieldtype='Auto Number'")
                'If row.Length > 0 Then
                '    da.SelectCommand.Parameters.Clear()
                '    da.SelectCommand.CommandText = "usp_GetAutoNoNew"
                '    da.SelectCommand.CommandType = CommandType.StoredProcedure
                '    da.SelectCommand.Parameters.AddWithValue("Fldid", row(0).Item("fieldid"))
                '    da.SelectCommand.Parameters.AddWithValue("docid", fileid)
                '    da.SelectCommand.Parameters.AddWithValue("fldmapping", row(0).Item("fieldmapping"))
                '    da.SelectCommand.Parameters.AddWithValue("FormType", "Document")
                '    Dim an As String = da.SelectCommand.ExecuteScalar()
                '    msgAN = "<br/> " & row(0).Item("displayname") & " is " & an & ""
                '    da.SelectCommand.Parameters.Clear()
                'End If
                'End
                Dim childitem() As DataRow = ds.Tables("fields").Select("Fieldtype='CHILD ITEM'")
                If childitem.Length > 0 Then
                    For Each DR As DataRow In childitem
                        '' by sunil for def value 13-jan-14 - starts
                        Dim strDF As String = "select * from mmm_mst_forms where formname='" & DR.Item("DROPDOWN") & "' and formsource='DETAIL FORM' and EID=" & Session("EID") & " and ( isnull(HasDefaultValue,0)=1 or isnull(IsDefaultRows,0)>0 or isnull(isinlineediting,0)=1)"
                        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
                        Dim dtIsdv As New DataTable
                        oda.SelectCommand.CommandText = strDF
                        oda.SelectCommand.Transaction = tran
                        oda.Fill(dtIsdv)
                        If dtIsdv.Rows.Count = 0 Then
                            'Commented By Komal on 28March2014
                            'SavingChildItem_DV_DRAFT(DR.Item("DROPDOWN"), fileid)
                            SavingChildItem_Draft(DR.Item("DROPDOWN"), fileid, con, tran)
                        Else
                            SavingChildItem_DV_draft(DR.Item("DROPDOWN"), fileid, con, tran)
                        End If
                    Next

                End If
                Dim ob1 As New DMSUtil()
                Dim CalculativeField() As DataRow = ds.Tables("fields").Select("Fieldtype='Formula Field'")
                Dim viewdoc As String = screenname
                viewdoc = viewdoc.Replace(" ", "_")
                If CalculativeField.Length > 0 Then
                    For Each CField As DataRow In CalculativeField
                        Dim formulaeditorr As New formulaEditor
                        Dim forvalue As String = String.Empty
                        'forvalue = formulaeditorr.ExecuteFormula(CField.Item("KC_LOGIC"), DocID, "v" + Session("eid").ToString + viewdoc)
                        'Changed By Komal on 28March2014
                        forvalue = formulaeditorr.ExecuteFormulaT(CField.Item("KC_LOGIC"), DocID, "dv" + Session("eid").ToString + viewdoc, Session("eid").ToString, 1, con, tran)
                        Dim documenttype As String = CField.Item("DBTableName").ToString & "_DRAFT"
                        Dim upquery As String = "update " & documenttype & "  set  " & CField.Item("FieldMapping").ToString & "='" & forvalue.ToString & "'  where tid =" & DocID & ""
                        da.SelectCommand.CommandText = upquery
                        da.SelectCommand.Transaction = tran
                        da.SelectCommand.CommandType = CommandType.Text
                        da.SelectCommand.ExecuteNonQuery()
                    Next
                End If
                Dim EID = Convert.ToInt32(Session("EID"))
                Dim pdfPath = ""

                tran.Commit()


                lbldraftmsgpop.Text = "System Draftid is " & fileid

                upddraftmsg.Update()
                popupDraftmsg.Show()
                ' Dim obj As New DMSUtil()
                'ob.CLEARDYNAMICFIELDS(pnlFields)
                'pdfPath = obj.GetDraftPDF(EID, DocID)
                'Dim link As String = "https://myndsaas.com" & pdfPath  ' for live url
                'Dim link As String = "https://http://:20353/Myndsaas.myndsolution.com Test/" & pdfPath   ' for local url


                'Dim absoultPath As String() = Request.Url.AbsolutePath.Split("/")
                'Dim requestedPath As String() = Request.Url.AbsoluteUri.Split("/")
                'For i As Integer = 0 To requestedPath.Length - 1
                '    If requestedPath(i).ToString() = absoultPath(1) Then
                '        link = link & requestedPath(i) & url
                '        Exit For
                '    Else
                '        link = link & requestedPath(i) & "/"
                '    End If
                'Next
                'Dim s As String = "window.open('" & link + "', 'alert', 'width=600,height=400,left=100,top=100,resizable=yes');"
                'ScriptManager.RegisterStartupScript(Me, Me.GetType(), "script", s, True)
                'ob.History(Session("EID"), fileid, Session("UID"), screenname, "MMM_MST_DOC", "ADD")
                'Commented By Ajeet on 29March2014
                'updMsg.Update()
                'btnForm_ModalPopupExtender.Show()
            End If
            da.Dispose()
            con.Dispose()
        End If

    End Sub

    Protected Sub SavingChildItem_DV_draft(ByVal formname As String, ByVal docid As Integer, con As SqlConnection, tran As SqlTransaction)

        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim ODA As SqlDataAdapter = New SqlDataAdapter("", con)
        ODA.SelectCommand.Transaction = tran
        Dim dtField As New DataTable
        Dim updquery As String = ""
        Dim ob As New DynamicForm()
        If Session(formname & "VAL") Is Nothing Then
            Exit Sub
        End If

        ' dtField = ViewState(formname)
        dtField = Session("D" & formname)
        Dim dtvalue As DataTable = Session(formname & "VAL")
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If
        'Session("id")
        Dim dt As New DataTable
        ODA.SelectCommand.CommandText = "select * from mmm_mst_fields where eid=" & Session("eid") & " and documenttype='" & Session("Document") & "' and dropdown='" & formname & "'"
        ODA.SelectCommand.CommandType = CommandType.Text
        ODA.SelectCommand.Parameters.Clear()
        ODA.Fill(dt)

        Dim dtTotal As New DataTable
        ODA.SelectCommand.CommandType = CommandType.Text
        ODA.SelectCommand.CommandText = "SELECT F1.FieldID [MainFieldID],F2.FieldID [ChildFieldID],F2.displayName [CdisplayName],f1.fieldtype [MFIELDTYPE] ,F1.dropdown [mDropDown],F1.displayName [MdisplayName],F1.FieldMapping [MFieldMapping]  FROM MMM_MST_FIELDS F1 INNER JOIN MMM_MST_FIELDS F2 ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType in ('CHILD ITEM MAX','CHILD ITEM TOTAL') AND F2.DocumentType ='" & formname & "' AND F1.DOCUMENTTYPE='" & Session("Document") & "'"
        ODA.Fill(dtTotal)

        Dim isTotal As Boolean = False
        Dim cDispName As String = ""
        Dim Childtotal As Double = 0
        If dtTotal.Rows.Count = 1 Then
            isTotal = True
            cDispName = dtTotal.Rows(0).Item("cdisplayname").ToString
        End If
        Dim dataitem As DataTable = Session("ITEM")
        'For Each dr As DataRow In DS1.Rows
        '    Dim txt As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("Fieldid").ToString()), TextBox)
        '    txt.Text = DS.Rows(rowcount - 1).Item(dr.Item("displayname")).ToString()
        'Next

        Dim GID As String = dt.Rows(0).Item("fieldId").ToString

        ' GID = Right(GID, GID.Length - 3)
        Dim GV As GridView = CType(pnlFields.FindControl("GRD" & GID.ToString()), GridView)

        ' by sunil for maxvalue 
        Dim MaxVal As Double = -999

        'Prashant_21_7
        Dim gridCols As DataTable = GV.DataSource

        'Prashant_17_7
        Dim LastRow As Integer = 0

        If IsNothing(ViewState("LastRow")) = False Then
            If ViewState("LastRow").ToString.Trim <> "" Then
                LastRow = Convert.ToInt32(ViewState("LastRow"))
            Else
                LastRow = GV.Rows.Count - 1
            End If
        Else
            LastRow = GV.Rows.Count - 1
        End If

        'Prashant_17_7

        Dim cnt As Integer = 0
        For Each GR As GridViewRow In GV.Rows
            If GR.RowIndex <= LastRow Then
                If GR.RowType = DataControlRowType.DataRow Then
                    If GR.Cells(0).Text.ToUpper <> "TOTAL" Then

                        If Not Request.QueryString("TID") Is Nothing Then
                            Dim str As String = "update MMM_MST_DOC_ITEM_draft Set "
                            Dim STRFld As String = ""
                            Dim STRVal As String = ""
                            updquery = ""
                            Dim querry As String = ""
                            ' For j As Integer = 0 To GR.Cells.Count - 1
                            For j As Integer = 0 To dtField.Rows.Count - 1
                                STRFld = dtField.Rows(j).Item("fieldmapping").ToString
                                Dim colValue As String = ""
                                Dim FldID As String = ""
                                querry = ""
                                FldID = dtField.Rows(j).Item("fieldid").ToString()
                                If dtField.Rows(j).Item("inlineediting").ToString = "1" Then
                                    '' new for getting child item total 
                                    Dim ftype As String = dtField.Rows(j).Item("fieldtype").ToString()
                                    Dim fldmapping As String = dtField.Rows(j).Item("fieldmapping").ToString()
                                    If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Or ftype.ToUpper = "MULTI LOOKUP" Then
                                        ' Dim cb As TextBox = CType(GR.FindControl("fld" & j.ToString() & "_" & cnt), TextBox)
                                        'Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & cnt), TextBox)
                                        Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & GR.RowIndex), TextBox)
                                        If cb IsNot Nothing Then
                                            colValue = Replace(cb.Text.ToString, "'", "")
                                            querry = fldmapping & "='" & colValue & "' " & ","
                                        Else
                                            colValue = "0"
                                        End If
                                        str &= querry

                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
                                            If colValue <> "" Then
                                                Childtotal = Childtotal + Convert.ToDouble(colValue)
                                            End If
                                        End If
                                    ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
                                        'Dim cb As New DropDownList
                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                        If cb IsNot Nothing Then
                                            colValue = cb.SelectedItem.Text.ToString
                                            querry = fldmapping & "='" & colValue & "' " & ","
                                        Else
                                            colValue = "0"
                                        End If

                                        str &= querry
                                    ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdownTYPE") = "MASTER VALUED" Then
                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                        If cb IsNot Nothing Then
                                            colValue = cb.SelectedItem.Value.ToString  ' use value bcoz it's mastervalued - needs tid
                                            querry = fldmapping & "='" & colValue & "' " & ","
                                        Else
                                            colValue = "0"
                                        End If

                                        str &= querry

                                    ElseIf ftype.ToUpper() = "LOOKUPDDL" Or ftype.ToUpper() = "MULTI LOOKUPDDL" Then
                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                        If cb IsNot Nothing Then
                                            colValue = cb.SelectedItem.Value.ToString
                                            querry = fldmapping & "='" & colValue & "' " & ","
                                        Else
                                            colValue = "0"
                                        End If

                                        str &= querry
                                    ElseIf ftype.ToUpper() = "CHECKBOX LIST" Then
                                        Dim cb As CheckBoxList = CType(GR.FindControl("fld" & FldID & "_" & cnt), CheckBoxList)
                                        If cb IsNot Nothing Then
                                            For Each item As ListItem In cb.Items
                                                If item.Selected Then
                                                    colValue &= item.Value & ","
                                                End If
                                            Next
                                            If colValue.Length > 0 Then
                                                querry = fldmapping & "='" & colValue & "' " & ","
                                                colValue = colValue.Substring(0, colValue.Length - 1)
                                            End If
                                        Else
                                            colValue = ""
                                        End If

                                        str &= querry
                                    ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
                                        '' here to code for getting file 
                                        Dim txtBox As FileUpload = CType(GR.FindControl("fld_" & FldID & "_" & cnt), FileUpload)

                                        Dim txtBox1 As Label = CType(GR.FindControl("lblf_" & FldID), Label)
                                        Dim hdn As HiddenField = CType(GR.FindControl("hdn_" & FldID), HiddenField)
                                        Dim hdnflg As HiddenField = CType(GR.FindControl("hdnf_" & FldID), HiddenField)

                                        txtBox1.Text = hdn.Value

                                        If txtBox1.Text IsNot "" And hdnflg.Value IsNot "0" Then
                                            Dim errormsg As String = ""
                                            Dim FN As String = ""
                                            Dim ext As String = ""
                                            Dim flag As Integer = 0
                                            Dim sourceFile As String = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
                                            Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))
                                            Dim curFileSize As Integer = finfo.Length
                                            ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                            FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
                                            colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext
                                            File.Copy(sourceFile, Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)
                                            querry = fldmapping & "='" & colValue & "' " & ","
                                        ElseIf txtBox1.Text IsNot "" And hdnflg.Value IsNot "1" Then
                                            colValue = Session("EID").ToString() & "/" & txtBox1.Text
                                            querry = fldmapping & "='" & colValue & "' " & ","
                                        Else
                                            colValue = ""
                                            querry = fldmapping & "='" & colValue & "' " & ","
                                        End If

                                        str &= querry
                                    Else
                                        colValue = GR.Cells(j).Text.ToString()
                                        querry = fldmapping & "='" & colValue & "' " & ","
                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
                                            If colValue <> "" Then
                                                Childtotal = Childtotal + Convert.ToDouble(colValue)
                                            End If
                                        End If

                                    End If
                                Else  ' if no inline editing 
                                    If dtField.Rows(j).Item("dropdownTYPE") = "MASTER VALUED" And dtField.Rows(j).Item("fieldtype") = "Drop Down" Then
                                        '' here code to get tid from session arrays by sp 13-jan-13
                                        Dim CH() As String = Session("COLHEAD")  ' {}
                                        Dim txt() As String = Session("DDLTXT") ' {}
                                        Dim Vals() As String = Session("DDLVAL") '{}
                                        Dim found As Boolean = False
                                        Dim searchHdr As String = formname & "_" & dtField.Rows(j).Item("displayname")
                                        For a As Integer = 0 To CH.Length - 1
                                            If CH(a).ToString = searchHdr And txt(a).ToString = GR.Cells(j).Text.ToString() Then ' if match found in array 
                                                colValue = Vals(a).ToString
                                                found = True
                                                Exit For
                                            End If
                                        Next
                                        If found = False Then
                                            colValue = dtvalue.Rows(cnt).Item(j).ToString()
                                        End If
                                        'ElseIf dtField.Rows(j).Item("fieldtype") = "Child Item Total" Then

                                    Else
                                        colValue = GR.Cells(j).Text.ToString()
                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
                                            If colValue <> "" Then
                                                Childtotal = Childtotal + Convert.ToDouble(colValue)
                                            End If
                                        End If
                                    End If
                                    querry = querry & STRFld & "='" & colValue & "' " & ","
                                End If
                                'str &= querry
                            Next
                            'str &= querry
                            If Right(str, 1) = "," Then
                                str = Left(str, str.Length - 1)
                            End If

                            str = str & "  where TID=" & gridCols.Rows(GR.RowIndex).Item("Tid").ToString()

                            ODA.SelectCommand.CommandText = str
                            ODA.SelectCommand.ExecuteNonQuery()
                        Else

                            Dim str As String = "INSERT INTO mmm_mst_doc_item_draft("
                            Dim STRFld As String = ""
                            Dim STRVal As String = ""
                            updquery = ""


                            For j As Integer = 0 To dtField.Rows.Count - 1
                                STRFld &= dtField.Rows(j).Item("fieldmapping").ToString & ","  'adding  j+1 for incremental
                                Dim colValue As String = ""
                                Dim FldID As String = ""

                                Dim DispName = dtField.Rows(j).Item("DisplayName").ToString

                                FldID = dtField.Rows(j).Item("fieldid").ToString()
                                If dtField.Rows(j).Item("inlineediting").ToString = "1" Then
                                    '' new added for getting child item total
                                    'If dtField.Rows(j).Item("displayname") = cDispName And dtField.Rows(j).Item("datatype").ToString.ToUpper = "NUMERIC" Then

                                    ' End If
                                    '' new for getting child item total 
                                    Dim ftype As String = dtField.Rows(j).Item("fieldtype").ToString()
                                    If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Or ftype.ToUpper = "MULTI LOOKUP" Then
                                        ' Dim cb As TextBox = CType(GR.FindControl("fld" & j.ToString() & "_" & cnt), TextBox)

                                        'Prashant_21_7
                                        'If DispName = gridCols.Columns(j).ToString Then

                                        'End If

                                        Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & cnt), TextBox)

                                        If cb IsNot Nothing Then
                                            If (ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "LOOKUP" Or ftype.ToUpper() = "MULTI LOOKUP") And dtField.Rows(j).Item("datatype").ToString().ToUpper() = "TEXT" Then
                                                colValue = getSafeString(cb.Text.ToString)
                                            Else
                                                colValue = cb.Text.ToString
                                            End If
                                        Else
                                            colValue = "0"
                                        End If

                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
                                            If colValue <> "" Then
                                                If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
                                                ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
                                                    If Convert.ToDouble(colValue) > MaxVal Then
                                                        MaxVal = Convert.ToDouble(colValue)
                                                        Childtotal = MaxVal
                                                    End If
                                                End If
                                            End If
                                        End If
                                    ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
                                        'Dim cb As New DropDownList
                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                        If cb IsNot Nothing Then
                                            colValue = cb.SelectedItem.Text.ToString
                                        Else
                                            colValue = "0"
                                        End If
                                    ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdownTYPE") = "MASTER VALUED" Then
                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                        If cb IsNot Nothing Then
                                            colValue = cb.SelectedItem.Value.ToString  ' use value bcoz it's mastervalued - needs tid
                                        Else
                                            colValue = "0"
                                        End If

                                    ElseIf ftype.ToUpper() = "LOOKUPDDL" Or ftype.ToUpper() = "MULTI LOOKUPDDL" Then
                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
                                        If cb IsNot Nothing Then
                                            colValue = cb.SelectedItem.Value.ToString
                                        Else
                                            colValue = "0"
                                        End If
                                    ElseIf ftype.ToUpper() = "CHECKBOX LIST" Then
                                        Dim cb As CheckBoxList = CType(GR.FindControl("fld" & FldID & "_" & cnt), CheckBoxList)
                                        If cb IsNot Nothing Then
                                            For Each item As ListItem In cb.Items
                                                If item.Selected Then
                                                    colValue &= item.Value & ","
                                                End If
                                            Next
                                            If colValue.Length > 0 Then
                                                colValue = colValue.Substring(0, colValue.Length - 1)
                                            End If

                                        Else
                                            colValue = ""
                                        End If
                                    ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
                                        '' here to code for getting file 
                                        Dim txtBox As FileUpload = CType(GR.FindControl("fld_" & FldID & "_" & cnt), FileUpload)

                                        'Prashant 
                                        Dim txtBox1 As Label = CType(GR.FindControl("lblf_" & FldID), Label)

                                        If txtBox.HasFile Then
                                            'Dim FN As String = ""
                                            'Dim ext As String = ""
                                            'FN = Left(txtBox.FileName, txtBox.FileName.LastIndexOf("."))
                                            'ext = txtBox.FileName.Substring(txtBox.FileName.LastIndexOf("."), (txtBox.FileName.Length - txtBox.FileName.LastIndexOf(".")))
                                            'colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext
                                            'txtBox.SaveAs(Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)
                                            ''Prashant
                                        End If
                                        If txtBox1.Text IsNot "" Then
                                            Dim errormsg As String = ""
                                            Dim FN As String = ""
                                            Dim ext As String = ""
                                            Dim flag As Integer = 0
                                            Dim sourceFile As String = ""
                                            Dim curFileSize As Integer = 0
                                            If Not Request.QueryString("TID") Is Nothing Then
                                                sourceFile = Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text)
                                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text))

                                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                                curFileSize = finfo.Length
                                            Else
                                                sourceFile = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
                                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))

                                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                                curFileSize = finfo.Length
                                            End If
                                            ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
                                            FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
                                            colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext

                                            File.Copy(sourceFile, Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)

                                        End If
                                    Else

                                        For index As Integer = 0 To gridCols.Columns.Count - 1
                                            If DispName = gridCols.Columns(index).ColumnName.ToString Then
                                                colValue = GR.Cells(index).Text.ToString()
                                                Exit For
                                            Else
                                                colValue = ""
                                            End If
                                        Next


                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
                                            If colValue <> "" Then
                                                If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
                                                ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
                                                    If Convert.ToDouble(colValue) > MaxVal Then
                                                        MaxVal = Convert.ToDouble(colValue)
                                                        Childtotal = MaxVal
                                                    End If
                                                End If
                                            End If
                                        End If
                                    End If
                                Else  ' if no inline editing 
                                    If dtField.Rows(j).Item("dropdownTYPE") = "MASTER VALUED" And dtField.Rows(j).Item("fieldtype") = "Drop Down" Then
                                        '' here code to get tid from session arrays by sp 13-jan-13
                                        Dim CH() As String = Session("COLHEAD")  ' {}
                                        Dim txt() As String = Session("DDLTXT") ' {}
                                        Dim Vals() As String = Session("DDLVAL") '{}
                                        Dim found As Boolean = False
                                        Dim searchHdr As String = formname & "_" & dtField.Rows(j).Item("displayname")
                                        For a As Integer = 0 To CH.Length - 1
                                            If CH(a).ToString = searchHdr And txt(a).ToString = GR.Cells(j).Text.ToString() Then ' if match found in array 
                                                colValue = Vals(a).ToString
                                                found = True
                                                Exit For
                                            End If
                                        Next
                                        If found = False Then
                                            'Prashant_21_7
                                            For index As Integer = 0 To gridCols.Columns.Count - 1
                                                If DispName = gridCols.Columns(index).ColumnName.ToString Then
                                                    colValue = dtvalue.Rows(cnt).Item(DispName).ToString()
                                                    Exit For
                                                Else
                                                    colValue = ""
                                                End If
                                            Next
                                            ' +1 IS ADDED FOR CELL ADJUSTMENT 
                                            'Else
                                            '    colValue = dtvalue.Rows(cnt).Item(j).ToString() ' added by balli on 2 june 
                                        End If
                                        'ElseIf dtField.Rows(j).Item("fieldtype") = "Child Item Total" Then

                                    Else

                                        For index As Integer = 0 To gridCols.Columns.Count - 1
                                            If DispName = gridCols.Columns(index).ColumnName.ToString Then
                                                colValue = GR.Cells(index).Text.ToString()
                                                Exit For
                                            Else
                                                colValue = ""
                                            End If
                                        Next
                                        ' +1 IS ADDED FOR CELL ADJUSTMENT 
                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
                                            If colValue <> "" Then
                                                If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
                                                ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
                                                    If Convert.ToDouble(colValue) > MaxVal Then
                                                        MaxVal = Convert.ToDouble(colValue)
                                                        Childtotal = MaxVal
                                                    End If
                                                End If
                                            End If
                                        End If
                                    End If
                                End If
                                STRVal &= "'" & colValue & "'" & ","
                                ' j = j - 1  ' for cell value  adjustment 


                            Next
                            ' End If
                            'If dtField.Rows(j).Item("KC_VALUE").ToString.Length > 5 And dtField.Rows(j).Item("KC_STATUS").ToString.Length = 0 Then
                            ' updquery &= ob.UPDATEKICKING(dtField.Rows(j).Item("KC_VALUE").ToString(), dtvalue.Rows(i).Item(j).ToString(), pnlFields1)
                            ' End If
                            STRFld &= "DOCID,documenttype,isauth)"
                            STRVal &= docid & "," & "'" & formname & "'" & ",1)"
                            str &= STRFld & "values(" & STRVal
                            ODA.SelectCommand.CommandText = str
                            ODA.SelectCommand.ExecuteNonQuery()
                        End If
                        cnt += 1
                    End If
                End If
            End If

        Next


        If isTotal Then
            Dim childTotalUpdstr As String = ""
            childTotalUpdstr = "UPDATE mmm_mst_doc_draft set " & dtTotal.Rows(0).Item("mFieldMapping").ToString & "=" & Childtotal & " where tid=" & docid

            ODA.SelectCommand.CommandType = CommandType.Text
            ODA.SelectCommand.CommandText = childTotalUpdstr
            ODA.SelectCommand.ExecuteNonQuery()
        End If


        dt.Dispose()
        dtTotal.Dispose()
        dtField.Dispose()
        dtvalue.Dispose()

        Session(formname) = Nothing
        Session(formname & "VAL") = Nothing
        ODA.Dispose()
    End Sub


    ' prev 
    'Protected Sub SavingChildItem_DV_draft(ByVal formname As String, ByVal docid As Integer, con As SqlConnection, tran As SqlTransaction)
    '    Dim flg As Integer = 0
    '    Dim cmastertid As Integer = 0
    '    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '    Dim ODA As SqlDataAdapter = New SqlDataAdapter("", con)
    '    ODA.SelectCommand.Transaction = tran
    '    Dim dtField As New DataTable
    '    Dim updquery As String = ""
    '    Dim ob As New DynamicForm()
    '    If Session(formname & "VAL") Is Nothing Then
    '        Exit Sub
    '    End If

    '    ' dtField = ViewState(formname)
    '    dtField = Session("D" & formname)
    '    Dim dtvalue As DataTable = Session(formname & "VAL")
    '    If con.State <> ConnectionState.Open Then
    '        con.Open()
    '    End If
    '    'Session("id")
    '    Dim dt As New DataTable
    '    ODA.SelectCommand.CommandText = "select * from mmm_mst_fields where eid=" & Session("eid") & " and documenttype='" & Session("Document") & "' and dropdown='" & formname & "'"
    '    ODA.SelectCommand.CommandType = CommandType.Text
    '    ODA.SelectCommand.Parameters.Clear()
    '    ODA.Fill(dt)

    '    Dim dtTotal As New DataTable
    '    ODA.SelectCommand.CommandType = CommandType.Text
    '    ODA.SelectCommand.CommandText = "SELECT F1.FieldID [MainFieldID],F2.FieldID [ChildFieldID],F2.displayName [CdisplayName],f1.fieldtype [MFIELDTYPE] ,F1.dropdown [mDropDown],F1.displayName [MdisplayName],F1.FieldMapping [MFieldMapping]  FROM MMM_MST_FIELDS F1 INNER JOIN MMM_MST_FIELDS F2 ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType in ('CHILD ITEM MAX','CHILD ITEM TOTAL') AND F2.DocumentType ='" & formname & "' AND F1.DOCUMENTTYPE='" & Session("Document") & "'"
    '    ODA.Fill(dtTotal)

    '    Dim isTotal As Boolean = False
    '    Dim cDispName As String = ""
    '    Dim Childtotal As Double = 0
    '    If dtTotal.Rows.Count = 1 Then
    '        isTotal = True
    '        cDispName = dtTotal.Rows(0).Item("cdisplayname").ToString
    '    End If

    '    'For Each dr As DataRow In DS1.Rows
    '    '    Dim txt As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("Fieldid").ToString()), TextBox)
    '    '    txt.Text = DS.Rows(rowcount - 1).Item(dr.Item("displayname")).ToString()
    '    'Next

    '    Dim GID As String = dt.Rows(0).Item("fieldId").ToString

    '    ' GID = Right(GID, GID.Length - 3)
    '    Dim GV As GridView = CType(pnlFields.FindControl("GRD" & GID.ToString()), GridView)

    '    ' by sunil for maxvalue 
    '    Dim MaxVal As Double = -999

    '    'Prashant_21_7
    '    Dim gridCols As DataTable = GV.DataSource

    '    'Prashant_17_7
    '    Dim LastRow As Integer = 0

    '    If IsNothing(ViewState("LastRow")) = False Then
    '        If ViewState("LastRow").ToString.Trim <> "" Then
    '            LastRow = Convert.ToInt32(ViewState("LastRow"))
    '        Else
    '            LastRow = GV.Rows.Count - 1
    '        End If
    '    Else
    '        LastRow = GV.Rows.Count - 1
    '    End If

    '    'Prashant_17_7

    '    Dim cnt As Integer = 0
    '    For Each GR As GridViewRow In GV.Rows
    '        If GR.RowIndex <= LastRow Then
    '            If GR.RowType = DataControlRowType.DataRow Then
    '                If GR.Cells(0).Text.ToUpper <> "TOTAL" Then

    '                    If Not Request.QueryString("TID") Is Nothing Then
    '                        Dim str As String = "update MMM_MST_DOC_ITEM_draft Set "
    '                        Dim STRFld As String = ""
    '                        Dim STRVal As String = ""
    '                        updquery = ""
    '                        Dim querry As String = ""
    '                        Dim DICT As New Dictionary(Of Integer, Integer)
    '                        DICT = CType(Session("AddedRow"), Dictionary(Of Integer, Integer))

    '                        If Not IsNothing(DICT) Then
    '                            If Not IsNothing(Session("AddedRow")) And DICT.ContainsKey(GR.RowIndex) Then
    '                                For j As Integer = 0 To dtField.Rows.Count - 1
    '                                    STRFld &= dtField.Rows(j).Item("fieldmapping").ToString & ","
    '                                    Dim colValue As String = ""
    '                                    Dim FldID As String = ""
    '                                    FldID = dtField.Rows(j).Item("fieldid").ToString()

    '                                    If dtField.Rows(j).Item("dropdownTYPE") = "MASTER VALUED" And dtField.Rows(j).Item("fieldtype") = "Drop Down" Then
    '                                        '' here code to get tid from session arrays by sp 13-jan-13
    '                                        Dim CH() As String = Session("COLHEAD")  ' {}
    '                                        Dim txt() As String = Session("DDLTXT") ' {}
    '                                        Dim Vals() As String = Session("DDLVAL") '{}
    '                                        Dim found As Boolean = False
    '                                        Dim searchHdr As String = formname & "_" & dtField.Rows(j).Item("displayname")
    '                                        For a As Integer = 0 To CH.Length - 1
    '                                            If CH(a).ToString = searchHdr And txt(a).ToString = GR.Cells(j).Text.ToString() Then ' if match found in array 
    '                                                colValue = Vals(a).ToString
    '                                                found = True
    '                                                Exit For
    '                                            End If
    '                                        Next
    '                                        If found = False Then
    '                                            colValue = dtvalue.Rows(cnt).Item(j).ToString()
    '                                        End If
    '                                        'ElseIf dtField.Rows(j).Item("fieldtype") = "Child Item Total" Then

    '                                    Else
    '                                        colValue = GR.Cells(j).Text.ToString()
    '                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
    '                                            If colValue <> "" Then
    '                                                Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                            End If
    '                                        End If
    '                                    End If

    '                                    'STRVal &= "'" & colValue & "'" & ","
    '                                    colValue = colValue


    '                                Next
    '                            Else
    '                                'Dim str As String = "INSERT INTO mmm_mst_doc_item_draft("
    '                                'Dim STRFld As String = ""
    '                                'Dim STRVal As String = ""
    '                                updquery = ""


    '                                For j As Integer = 0 To dtField.Rows.Count - 1
    '                                    STRFld &= dtField.Rows(j).Item("fieldmapping").ToString & ","  'adding  j+1 for incremental
    '                                    Dim colValue As String = ""
    '                                    Dim FldID As String = ""

    '                                    Dim DispName = dtField.Rows(j).Item("DisplayName").ToString

    '                                    FldID = dtField.Rows(j).Item("fieldid").ToString()
    '                                    If dtField.Rows(j).Item("inlineediting").ToString = "1" Then
    '                                        '' new added for getting child item total
    '                                        'If dtField.Rows(j).Item("displayname") = cDispName And dtField.Rows(j).Item("datatype").ToString.ToUpper = "NUMERIC" Then

    '                                        ' End If
    '                                        '' new for getting child item total 
    '                                        Dim ftype As String = dtField.Rows(j).Item("fieldtype").ToString()
    '                                        If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Then
    '                                            ' Dim cb As TextBox = CType(GR.FindControl("fld" & j.ToString() & "_" & cnt), TextBox)

    '                                            'Prashant_21_7
    '                                            'If DispName = gridCols.Columns(j).ToString Then

    '                                            'End If

    '                                            Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & cnt), TextBox)

    '                                            If cb IsNot Nothing Then
    '                                                If (ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "LOOKUP") And dtField.Rows(j).Item("datatype").ToString().ToUpper() = "TEXT" Then
    '                                                    colValue = getSafeString(cb.Text.ToString)
    '                                                Else
    '                                                    colValue = cb.Text.ToString
    '                                                End If
    '                                            Else
    '                                                colValue = "0"
    '                                            End If

    '                                            If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
    '                                                If colValue <> "" Then
    '                                                    If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                                        Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                                    ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                        If Convert.ToDouble(colValue) > MaxVal Then
    '                                                            MaxVal = Convert.ToDouble(colValue)
    '                                                            Childtotal = MaxVal
    '                                                        End If
    '                                                    End If
    '                                                End If
    '                                            End If
    '                                        ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                            'Dim cb As New DropDownList
    '                                            Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                            If cb IsNot Nothing Then
    '                                                colValue = cb.SelectedItem.Text.ToString
    '                                            Else
    '                                                colValue = "0"
    '                                            End If
    '                                        ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdownTYPE") = "MASTER VALUED" Then
    '                                            Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                            If cb IsNot Nothing Then
    '                                                colValue = cb.SelectedItem.Value.ToString  ' use value bcoz it's mastervalued - needs tid
    '                                            Else
    '                                                colValue = "0"
    '                                            End If
    '                                        ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
    '                                            '' here to code for getting file 
    '                                            Dim txtBox As FileUpload = CType(GR.FindControl("fld_" & FldID & "_" & cnt), FileUpload)

    '                                            'Prashant 
    '                                            Dim txtBox1 As Label = CType(GR.FindControl("lblf_" & FldID), Label)

    '                                            If txtBox.HasFile Then
    '                                                'Dim FN As String = ""
    '                                                'Dim ext As String = ""
    '                                                'FN = Left(txtBox.FileName, txtBox.FileName.LastIndexOf("."))
    '                                                'ext = txtBox.FileName.Substring(txtBox.FileName.LastIndexOf("."), (txtBox.FileName.Length - txtBox.FileName.LastIndexOf(".")))
    '                                                'colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext
    '                                                'txtBox.SaveAs(Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)
    '                                                ''Prashant
    '                                            End If
    '                                            If txtBox1.Text IsNot "" Then
    '                                                Dim errormsg As String = ""
    '                                                Dim FN As String = ""
    '                                                Dim ext As String = ""
    '                                                Dim flag As Integer = 0
    '                                                Dim sourceFile As String = ""
    '                                                Dim curFileSize As Integer = 0
    '                                                If Not Request.QueryString("TID") Is Nothing Then
    '                                                    sourceFile = Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text)
    '                                                    Dim finfo As New FileInfo(Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text))

    '                                                    ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                                    curFileSize = finfo.Length
    '                                                Else
    '                                                    sourceFile = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
    '                                                    Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))

    '                                                    ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                                    curFileSize = finfo.Length
    '                                                End If
    '                                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                                FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
    '                                                colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext

    '                                                File.Copy(sourceFile, Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)

    '                                            End If
    '                                        Else

    '                                            For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                                If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                                    colValue = GR.Cells(index).Text.ToString()
    '                                                    Exit For
    '                                                Else
    '                                                    colValue = ""
    '                                                End If
    '                                            Next


    '                                            If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
    '                                                If colValue <> "" Then
    '                                                    If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                                        Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                                    ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                        If Convert.ToDouble(colValue) > MaxVal Then
    '                                                            MaxVal = Convert.ToDouble(colValue)
    '                                                            Childtotal = MaxVal
    '                                                        End If
    '                                                    End If
    '                                                End If
    '                                            End If
    '                                        End If
    '                                    Else  ' if no inline editing 
    '                                        If dtField.Rows(j).Item("dropdownTYPE") = "MASTER VALUED" And dtField.Rows(j).Item("fieldtype") = "Drop Down" Then
    '                                            '' here code to get tid from session arrays by sp 13-jan-13
    '                                            Dim CH() As String = Session("COLHEAD")  ' {}
    '                                            Dim txt() As String = Session("DDLTXT") ' {}
    '                                            Dim Vals() As String = Session("DDLVAL") '{}
    '                                            Dim found As Boolean = False
    '                                            Dim searchHdr As String = formname & "_" & dtField.Rows(j).Item("displayname")
    '                                            For a As Integer = 0 To CH.Length - 1
    '                                                If CH(a).ToString = searchHdr And txt(a).ToString = GR.Cells(j).Text.ToString() Then ' if match found in array 
    '                                                    colValue = Vals(a).ToString
    '                                                    found = True
    '                                                    Exit For
    '                                                End If
    '                                            Next
    '                                            If found = False Then
    '                                                'Prashant_21_7
    '                                                For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                                    If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                                        colValue = dtvalue.Rows(cnt).Item(DispName).ToString()
    '                                                        Exit For
    '                                                    Else
    '                                                        colValue = ""
    '                                                    End If
    '                                                Next
    '                                                ' +1 IS ADDED FOR CELL ADJUSTMENT 
    '                                                'Else
    '                                                '    colValue = dtvalue.Rows(cnt).Item(j).ToString() ' added by balli on 2 june 
    '                                            End If
    '                                            'ElseIf dtField.Rows(j).Item("fieldtype") = "Child Item Total" Then

    '                                        Else

    '                                            For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                                If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                                    colValue = GR.Cells(index).Text.ToString()
    '                                                    Exit For
    '                                                Else
    '                                                    colValue = ""
    '                                                End If
    '                                            Next
    '                                            ' +1 IS ADDED FOR CELL ADJUSTMENT 
    '                                            If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
    '                                                If colValue <> "" Then
    '                                                    If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                                        Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                                    ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                        If Convert.ToDouble(colValue) > MaxVal Then
    '                                                            MaxVal = Convert.ToDouble(colValue)
    '                                                            Childtotal = MaxVal
    '                                                        End If
    '                                                    End If
    '                                                End If
    '                                            End If
    '                                        End If
    '                                    End If
    '                                    STRVal &= "'" & colValue & "'" & ","
    '                                    ' j = j - 1  ' for cell value  adjustment 


    '                                Next
    '                                ' End If
    '                                'If dtField.Rows(j).Item("KC_VALUE").ToString.Length > 5 And dtField.Rows(j).Item("KC_STATUS").ToString.Length = 0 Then
    '                                ' updquery &= ob.UPDATEKICKING(dtField.Rows(j).Item("KC_VALUE").ToString(), dtvalue.Rows(i).Item(j).ToString(), pnlFields1)
    '                                ' End If
    '                                STRFld &= "DOCID,documenttype,isauth)"
    '                                STRVal &= docid & "," & "'" & formname & "'" & ",1)"
    '                                str &= STRFld & "values(" & STRVal
    '                                ODA.SelectCommand.CommandText = str
    '                                ODA.SelectCommand.ExecuteNonQuery()
    '                                cnt += 1
    '                            End If

    '                        End If


    '                        If Right(str, 1) = "," Then
    '                            str = Left(str, str.Length - 1)
    '                        End If

    '                        str = str & "  where TID=" & GR.Cells(GR.Cells.Count - 1).Text

    '                        ODA.SelectCommand.CommandText = str
    '                        ODA.SelectCommand.ExecuteNonQuery()
    '                    Else

    '                        Dim str As String = "INSERT INTO mmm_mst_doc_item_draft("
    '                        Dim STRFld As String = ""
    '                        Dim STRVal As String = ""
    '                        updquery = ""
    '                        Dim DICT As New Dictionary(Of Integer, Integer)
    '                        DICT = CType(Session("AddedRow"), Dictionary(Of Integer, Integer))

    '                        If Not IsNothing(DICT) Then
    '                            If Not IsNothing(Session("AddedRow")) And DICT.ContainsKey(GR.RowIndex) Then
    '                                Dim filterRows() As DataRow
    '                                filterRows = dtField.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''")
    '                                ' dtField = filterRows.CopyToDataTable()
    '                                If filterRows.Length > 0 Then
    '                                    dtField = filterRows.CopyToDataTable()
    '                                End If

    '                                For j As Integer = 0 To dtField.Rows.Count - 1
    '                                    STRFld &= dtField.Rows(j).Item("fieldmapping").ToString & ","  'adding  j+1 for incremental
    '                                    Dim colValue As String = ""
    '                                    Dim FldID As String = ""

    '                                    Dim DispName = dtField.Rows(j).Item("DisplayName").ToString

    '                                    FldID = dtField.Rows(j).Item("fieldid").ToString()

    '                                    '' new added for getting child item total
    '                                    'If dtField.Rows(j).Item("displayname") = cDispName And dtField.Rows(j).Item("datatype").ToString.ToUpper = "NUMERIC" Then

    '                                    ' End If
    '                                    '' new for getting child item total 
    '                                    Dim ftype As String = dtField.Rows(j).Item("fieldtype").ToString()
    '                                    If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Then
    '                                        ' Dim cb As TextBox = CType(GR.FindControl("fld" & j.ToString() & "_" & cnt), TextBox)

    '                                        'Prashant_21_7
    '                                        'If DispName = gridCols.Columns(j).ToString Then

    '                                        'End If

    '                                        Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & cnt), TextBox)

    '                                        If cb IsNot Nothing Then
    '                                            If (ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "LOOKUP") And dtField.Rows(j).Item("datatype").ToString().ToUpper() = "TEXT" Then
    '                                                colValue = getSafeString(cb.Text.ToString)
    '                                            Else
    '                                                colValue = cb.Text.ToString
    '                                            End If
    '                                        Else
    '                                            colValue = "0"
    '                                        End If

    '                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
    '                                            If colValue <> "" Then
    '                                                If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                                ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                    If Convert.ToDouble(colValue) > MaxVal Then
    '                                                        MaxVal = Convert.ToDouble(colValue)
    '                                                        Childtotal = MaxVal
    '                                                    End If
    '                                                End If
    '                                            End If
    '                                        End If
    '                                    ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                        'Dim cb As New DropDownList
    '                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                        If cb IsNot Nothing Then
    '                                            colValue = cb.SelectedItem.Text.ToString
    '                                        Else
    '                                            colValue = "0"
    '                                        End If
    '                                    ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdownTYPE") = "MASTER VALUED" Then
    '                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                        If cb IsNot Nothing Then
    '                                            colValue = cb.SelectedItem.Value.ToString  ' use value bcoz it's mastervalued - needs tid
    '                                        Else
    '                                            colValue = "0"
    '                                        End If
    '                                    ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
    '                                        '' here to code for getting file 
    '                                        Dim txtBox As FileUpload = CType(GR.FindControl("fld_" & FldID & "_" & cnt), FileUpload)

    '                                        'Prashant 
    '                                        Dim txtBox1 As Label = CType(GR.FindControl("lblf_" & FldID), Label)

    '                                        If txtBox.HasFile Then
    '                                            'Dim FN As String = ""
    '                                            'Dim ext As String = ""
    '                                            'FN = Left(txtBox.FileName, txtBox.FileName.LastIndexOf("."))
    '                                            'ext = txtBox.FileName.Substring(txtBox.FileName.LastIndexOf("."), (txtBox.FileName.Length - txtBox.FileName.LastIndexOf(".")))
    '                                            'colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext
    '                                            'txtBox.SaveAs(Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)
    '                                            ''Prashant
    '                                        End If
    '                                        If txtBox1.Text IsNot "" Then
    '                                            Dim errormsg As String = ""
    '                                            Dim FN As String = ""
    '                                            Dim ext As String = ""
    '                                            Dim flag As Integer = 0
    '                                            Dim sourceFile As String = ""
    '                                            Dim curFileSize As Integer = 0
    '                                            If Not Request.QueryString("TID") Is Nothing Then
    '                                                sourceFile = Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text)
    '                                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text))

    '                                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                                curFileSize = finfo.Length
    '                                            Else
    '                                                sourceFile = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
    '                                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))

    '                                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                                curFileSize = finfo.Length
    '                                            End If
    '                                            ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                            FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
    '                                            colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext

    '                                            File.Copy(sourceFile, Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)

    '                                        End If
    '                                    Else

    '                                        For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                            If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                                colValue = GR.Cells(index).Text.ToString()
    '                                                Exit For
    '                                            Else
    '                                                colValue = ""
    '                                            End If
    '                                        Next


    '                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
    '                                            If colValue <> "" Then
    '                                                If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                                ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                    If Convert.ToDouble(colValue) > MaxVal Then
    '                                                        MaxVal = Convert.ToDouble(colValue)
    '                                                        Childtotal = MaxVal
    '                                                    End If
    '                                                End If
    '                                            End If
    '                                        End If
    '                                    End If


    '                                    STRVal &= "'" & colValue & "'" & ","
    '                                    ' j = j - 1  ' for cell value  adjustment 
    '                                Next
    '                            Else
    '                                Dim querry As String = ""
    '                                Dim filterRows() As DataRow
    '                                filterRows = dtField.Select("inlineEditing=1 or inlinemapping is not null and inlinemapping <>''")
    '                                ' dtField = filterRows.CopyToDataTable()
    '                                If filterRows.Length > 0 Then
    '                                    dtField = filterRows.CopyToDataTable()
    '                                End If

    '                                For l As Integer = 0 To dtField.Rows.Count - 1
    '                                    STRFld &= dtField.Rows(l).Item("fieldmapping").ToString & ","
    '                                    Dim colValue As String = ""
    '                                    Dim FldID As String = ""
    '                                    FldID = dtField.Rows(l).Item("fieldid").ToString()
    '                                    Dim DispName = dtField.Rows(l).Item("DisplayName").ToString
    '                                    If dtField.Rows(l).Item("inlineediting").ToString = "1" Then
    '                                        '' new for getting child item total 
    '                                        Dim ftype As String = dtField.Rows(l).Item("fieldtype").ToString()
    '                                        Dim fldmapping As String = dtField.Rows(l).Item("fieldmapping").ToString()
    '                                        If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Then
    '                                            ' Dim cb As TextBox = CType(GR.FindControl("fld" & j.ToString() & "_" & cnt), TextBox)
    '                                            'Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & cnt), TextBox)
    '                                            Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & GR.RowIndex), TextBox)
    '                                            If cb IsNot Nothing Then
    '                                                colValue = Replace(cb.Text.ToString, "'", "")
    '                                                'querry = fldmapping & "='" & colValue & "' " & ","

    '                                                'If (ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "LOOKUP") And dtField.Rows(l).Item("datatype").ToString().ToUpper() = "TEXT" Then
    '                                                '    colValue = getSafeString(cb.Text.ToString)
    '                                                'Else
    '                                                '    colValue = cb.Text.ToString
    '                                                'End If
    '                                            Else
    '                                                colValue = "0"
    '                                            End If
    '                                            'str &= querry

    '                                            If dtField.Rows(l).Item("displayname") = cDispName Then  '' new for getting child total
    '                                                If colValue <> "" Then
    '                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                                End If
    '                                            End If
    '                                        ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(l).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                            'Dim cb As New DropDownList
    '                                            Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                            If cb IsNot Nothing Then
    '                                                colValue = cb.SelectedItem.Text.ToString
    '                                                'querry = fldmapping & "='" & colValue & "' " & ","
    '                                            Else
    '                                                colValue = "0"
    '                                            End If

    '                                            'str &= querry
    '                                        ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(l).Item("dropdownTYPE") = "MASTER VALUED" Then
    '                                            Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                            If cb IsNot Nothing Then
    '                                                colValue = cb.SelectedItem.Value.ToString  ' use value bcoz it's mastervalued - needs tid
    '                                                'querry = fldmapping & "='" & colValue & "' " & ","
    '                                            Else
    '                                                colValue = "0"
    '                                            End If

    '                                            'str &= querry
    '                                        ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
    '                                            '' here to code for getting file 
    '                                            Dim txtBox As FileUpload = CType(GR.FindControl("fld_" & FldID & "_" & cnt), FileUpload)

    '                                            Dim txtBox1 As Label = CType(GR.FindControl("lblf_" & FldID), Label)
    '                                            Dim hdn As HiddenField = CType(GR.FindControl("hdn_" & FldID), HiddenField)
    '                                            Dim hdnflg As HiddenField = CType(GR.FindControl("hdnf_" & FldID), HiddenField)

    '                                            txtBox1.Text = hdn.Value

    '                                            If txtBox1.Text IsNot "" And hdnflg.Value IsNot "0" Then
    '                                                Dim errormsg As String = ""
    '                                                Dim FN As String = ""
    '                                                Dim ext As String = ""
    '                                                Dim flag As Integer = 0
    '                                                Dim sourceFile As String = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
    '                                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))
    '                                                Dim curFileSize As Integer = finfo.Length
    '                                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                                FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
    '                                                colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(l).Item("FieldID").ToString() & "" & ext
    '                                                File.Copy(sourceFile, Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(l).Item("FieldID").ToString() & ext)
    '                                                querry = fldmapping & "='" & colValue & "' " & ","
    '                                            ElseIf txtBox1.Text IsNot "" And hdnflg.Value IsNot "1" Then
    '                                                colValue = Session("EID").ToString() & "/" & txtBox1.Text
    '                                                querry = fldmapping & "='" & colValue & "' " & ","
    '                                            Else
    '                                                colValue = ""
    '                                                'querry = fldmapping & "='" & colValue & "' " & ","
    '                                            End If

    '                                            'str &= querry

    '                                        Else

    '                                            querry = fldmapping & "='" & colValue & "' " & ","
    '                                            If dtField.Rows(l).Item("displayname") = cDispName Then  '' new for getting child total
    '                                                If colValue <> "" Then
    '                                                    If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                                        Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                                    ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                        If Convert.ToDouble(colValue) > MaxVal Then
    '                                                            MaxVal = Convert.ToDouble(colValue)
    '                                                            Childtotal = MaxVal
    '                                                        End If
    '                                                    End If
    '                                                End If
    '                                            End If

    '                                        End If
    '                                    Else
    '                                        If dtField.Rows(l).Item("dropdownTYPE") = "MASTER VALUED" And dtField.Rows(l).Item("fieldtype") = "Drop Down" Then
    '                                            '' here code to get tid from session arrays by sp 13-jan-13
    '                                            Dim CH() As String = Session("COLHEAD")  ' {}
    '                                            Dim txt() As String = Session("DDLTXT") ' {}
    '                                            Dim Vals() As String = Session("DDLVAL") '{}
    '                                            Dim found As Boolean = False
    '                                            Dim searchHdr As String = formname & "_" & dtField.Rows(l).Item("displayname")
    '                                            For a As Integer = 0 To CH.Length - 1
    '                                                If CH(a).ToString = searchHdr And txt(a).ToString = GR.Cells(l).Text.ToString() Then ' if match found in array 
    '                                                    colValue = Vals(a).ToString
    '                                                    found = True
    '                                                    Exit For
    '                                                End If
    '                                            Next
    '                                            If found = False Then
    '                                                'colValue = dtvalue.Rows(cnt).Item(j).ToString()
    '                                                For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                                    If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                                        colValue = gridCols.Rows(cnt).Item(DispName).ToString()
    '                                                        Exit For
    '                                                    Else
    '                                                        colValue = ""
    '                                                    End If
    '                                                Next
    '                                            End If
    '                                            'ElseIf dtField.Rows(j).Item("fieldtype") = "Child Item Total" Then

    '                                        Else
    '                                            For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                                If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                                    colValue = GR.Cells(index).Text.ToString()
    '                                                    Exit For
    '                                                Else
    '                                                    colValue = ""
    '                                                End If
    '                                            Next

    '                                            If dtField.Rows(l).Item("displayname") = cDispName Then  '' new for getting child total
    '                                                If colValue <> "" Then
    '                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                                    ''If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                                    ''    Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                                    ''ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                    ''    If Convert.ToDouble(colValue) > MaxVal Then
    '                                                    ''        MaxVal = Convert.ToDouble(colValue)
    '                                                    ''        Childtotal = MaxVal
    '                                                    ''    End If
    '                                                    ''End If
    '                                                End If
    '                                            End If
    '                                        End If
    '                                    End If
    '                                    STRVal &= "'" & colValue & "'" & ","
    '                                Next

    '                                For index As Integer = 0 To gridCols.Columns.Count - 1

    '                                    If gridCols.Columns(index).ColumnName.ToString.ToUpper = "CMASTERTID" Then
    '                                        cmastertid = GR.Cells(index).Text.ToString()
    '                                        flg = 1
    '                                        Exit For
    '                                    End If
    '                                Next
    '                            End If
    '                        End If


    '                        ' End If
    '                        'If dtField.Rows(j).Item("KC_VALUE").ToString.Length > 5 And dtField.Rows(j).Item("KC_STATUS").ToString.Length = 0 Then
    '                        ' updquery &= ob.UPDATEKICKING(dtField.Rows(j).Item("KC_VALUE").ToString(), dtvalue.Rows(i).Item(j).ToString(), pnlFields1)
    '                        ' End If

    '                        If flg = 1 Then
    '                            STRFld &= "DOCID,documenttype,isauth,cMasterTID)"
    '                            STRVal &= docid & "," & "'" & formname & "'" & ",1," & cmastertid & ")"
    '                        Else
    '                            STRFld &= "DOCID,documenttype,isauth,cMasterTID)"
    '                            STRVal &= docid & "," & "'" & formname & "'" & ",1,0)"
    '                        End If

    '                        str &= STRFld & "values(" & STRVal
    '                        ODA.SelectCommand.CommandText = str
    '                        ODA.SelectCommand.ExecuteNonQuery()

    '                    End If
    '                End If
    '            End If
    '        End If
    '        cnt += 1
    '        flg = 0
    '    Next


    '    If isTotal Then
    '        Dim childTotalUpdstr As String = ""
    '        childTotalUpdstr = "UPDATE mmm_mst_doc_draft set " & dtTotal.Rows(0).Item("mFieldMapping").ToString & "=" & Childtotal & " where tid=" & docid

    '        ODA.SelectCommand.CommandType = CommandType.Text
    '        ODA.SelectCommand.CommandText = childTotalUpdstr
    '        ODA.SelectCommand.ExecuteNonQuery()
    '    End If


    '    dt.Dispose()
    '    dtTotal.Dispose()
    '    dtField.Dispose()
    '    dtvalue.Dispose()

    '    Session(formname) = Nothing
    '    Session(formname & "VAL") = Nothing
    '    ODA.Dispose()
    'End Sub





    'Protected Sub SavingChildItem_DV_draft(ByVal formname As String, ByVal docid As Integer, con As SqlConnection, trans As SqlTransaction)
    '    Dim ODA As SqlDataAdapter = New SqlDataAdapter("", con)
    '    ODA.SelectCommand.Transaction = trans
    '    Dim dtField As New DataTable
    '    ' Dim dtFD As New DataTable
    '    'Dim drnew As DataRow
    '    Dim updquery As String = ""
    '    Dim ob As New DynamicForm()
    '    If Session(formname & "VAL") Is Nothing Then
    '        Exit Sub
    '    End If

    '    ' dtField = ViewState(formname)
    '    dtField = Session("D" & formname)
    '    Dim dtvalue As DataTable = Session(formname & "VAL")
    '    'Session("id")
    '    Dim dt As New DataTable
    '    ODA.SelectCommand.CommandText = "select * from mmm_mst_fields where eid=" & Session("eid") & " and documenttype='" & ViewState("MDOCTYPE") & "' and dropdown='" & formname & "'"
    '    ODA.SelectCommand.CommandType = CommandType.Text
    '    ODA.SelectCommand.Parameters.Clear()
    '    ODA.Fill(dt)

    '    Dim dtTotal As New DataTable
    '    ODA.SelectCommand.CommandType = CommandType.Text
    '    ODA.SelectCommand.CommandText = "SELECT F1.FieldID [MainFieldID],F2.FieldID [ChildFieldID],F2.displayName [CdisplayName] ,F1.dropdown [mDropDown],F1.displayName [MdisplayName],F1.FieldMapping [MFieldMapping],f1.fieldtype [MFIELDTYPE]  FROM MMM_MST_FIELDS F1 INNER JOIN MMM_MST_FIELDS F2 ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType in ('CHILD ITEM MAX','CHILD ITEM TOTAL') AND F2.DocumentType ='" & formname & "' AND F1.DOCUMENTTYPE='" & ViewState("MDOCTYPE") & "'"
    '    ODA.Fill(dtTotal)

    '    Dim isTotal As Boolean = False
    '    Dim cDispName As String = ""
    '    Dim Childtotal As Double = 0
    '    If dtTotal.Rows.Count = 1 Then
    '        isTotal = True
    '        cDispName = dtTotal.Rows(0).Item("cdisplayname").ToString
    '    End If

    '    Dim GID As String = dt.Rows(0).Item("fieldId").ToString
    '    Dim dataitem As DataTable = Session("ITEM")

    '    ' GID = Right(GID, GID.Length - 3)
    '    'Dim itemDS As DataSet = Session("ITEM")
    '    Dim GV As GridView = CType(pnlFields.FindControl("GRD" & GID.ToString()), GridView)

    '    'Prashant_21_7
    '    Dim gridCols As DataTable = GV.DataSource
    '    Dim MaxVal As Double = -999
    '    'Prashant_17_7
    '    Dim LastRow As Integer = 0

    '    If IsNothing(ViewState("LastRow")) = False Then
    '        If ViewState("LastRow").ToString.Trim <> "" Then
    '            LastRow = Convert.ToInt32(ViewState("LastRow"))
    '        Else
    '            LastRow = GV.Rows.Count - 1
    '        End If
    '    Else
    '        LastRow = GV.Rows.Count - 1
    '    End If

    '    'Prashant_17_7

    '    Dim cnt As Integer = 0
    '    ' drnew = dtFD.NewRow()
    '    For Each GR As GridViewRow In GV.Rows
    '        If GR.RowIndex <= LastRow Then
    '            If GR.RowType = DataControlRowType.DataRow Then
    '                If GR.Cells(0).Text.ToUpper <> "TOTAL" Then
    '                    For i As Integer = 0 To dataitem.Rows.Count - 1
    '                        If GR.Cells(GR.Cells.Count - 1).Text.Trim() <> "" And GR.Cells(GR.Cells.Count - 1).Text.Trim() <> "&nbsp;" Then
    '                            Dim str As String = "update MMM_MST_DOC_ITEM Set "
    '                            Dim STRFld As String = ""
    '                            Dim STRVal As String = ""
    '                            updquery = ""
    '                            Dim querry As String = ""
    '                            ' For j As Integer = 0 To GR.Cells.Count - 1
    '                            For j As Integer = 0 To dtField.Rows.Count - 1
    '                                STRFld &= dtField.Rows(j).Item("fieldmapping").ToString & ","
    '                                Dim colValue As String = ""
    '                                Dim FldID As String = ""
    '                                FldID = dtField.Rows(j).Item("fieldid").ToString()
    '                                If dtField.Rows(j).Item("inlineediting").ToString = "1" Then
    '                                    '' new for getting child item total 
    '                                    Dim ftype As String = dtField.Rows(j).Item("fieldtype").ToString()
    '                                    Dim fldmapping As String = dtField.Rows(j).Item("fieldmapping").ToString()
    '                                    If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Then
    '                                        ' Dim cb As TextBox = CType(GR.FindControl("fld" & j.ToString() & "_" & cnt), TextBox)
    '                                        'Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & cnt), TextBox)
    '                                        Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & GR.RowIndex), TextBox)
    '                                        If cb IsNot Nothing Then
    '                                            colValue = cb.Text.ToString
    '                                            querry = fldmapping & "='" & colValue & "' " & ","
    '                                        Else
    '                                            colValue = "0"
    '                                        End If
    '                                        str &= querry

    '                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
    '                                            If colValue <> "" Then
    '                                                Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                            End If
    '                                        End If
    '                                    ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then
    '                                        'Dim cb As New DropDownList
    '                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                        If cb IsNot Nothing Then
    '                                            colValue = cb.SelectedItem.Text.ToString
    '                                            querry = fldmapping & "='" & colValue & "' " & ","
    '                                        Else
    '                                            colValue = "0"
    '                                        End If

    '                                        str &= querry
    '                                    ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdownTYPE") = "MASTER VALUED" Then
    '                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                        If cb IsNot Nothing Then
    '                                            colValue = cb.SelectedItem.Value.ToString  ' use value bcoz it's mastervalued - needs tid
    '                                            querry = fldmapping & "='" & colValue & "' " & ","
    '                                        Else
    '                                            colValue = "0"
    '                                        End If

    '                                        str &= querry
    '                                    ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
    '                                        '' here to code for getting file 
    '                                        Dim txtBox As FileUpload = CType(GR.FindControl("fld_" & FldID & "_" & cnt), FileUpload)

    '                                        Dim txtBox1 As Label = CType(GR.FindControl("lblf_" & FldID), Label)
    '                                        Dim hdn As HiddenField = CType(GR.FindControl("hdn_" & FldID), HiddenField)
    '                                        Dim hdnflg As HiddenField = CType(GR.FindControl("hdnf_" & FldID), HiddenField)

    '                                        txtBox1.Text = hdn.Value

    '                                        If txtBox1.Text IsNot "" And hdnflg.Value IsNot "0" Then
    '                                            Dim errormsg As String = ""
    '                                            Dim FN As String = ""
    '                                            Dim ext As String = ""
    '                                            Dim flag As Integer = 0
    '                                            Dim sourceFile As String = ""
    '                                            Dim curFileSize As Integer = 0
    '                                            If Not Request.QueryString("TID") Is Nothing Then
    '                                                sourceFile = Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text)
    '                                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text))

    '                                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                                curFileSize = finfo.Length
    '                                            Else
    '                                                sourceFile = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
    '                                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))

    '                                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                                curFileSize = finfo.Length
    '                                            End If
    '                                            ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                            FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
    '                                            colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext
    '                                            File.Copy(sourceFile, Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)
    '                                            querry = fldmapping & "='" & colValue & "' " & ","
    '                                        ElseIf txtBox1.Text IsNot "" And hdnflg.Value IsNot "1" Then
    '                                            colValue = Session("EID").ToString() & "/" & txtBox1.Text
    '                                            querry = fldmapping & "='" & colValue & "' " & ","
    '                                        Else
    '                                            colValue = ""
    '                                            querry = fldmapping & "='" & colValue & "' " & ","
    '                                        End If

    '                                        str &= querry

    '                                    Else
    '                                        colValue = GR.Cells(j).Text.ToString()
    '                                        querry = fldmapping & "='" & colValue & "' " & ","
    '                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
    '                                            If colValue <> "" Then
    '                                                Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                            End If
    '                                        End If

    '                                    End If
    '                                Else  ' if no inline editing 
    '                                    If dtField.Rows(j).Item("dropdownTYPE") = "MASTER VALUED" And dtField.Rows(j).Item("fieldtype") = "Drop Down" Then
    '                                        '' here code to get tid from session arrays by sp 13-jan-13
    '                                        Dim CH() As String = Session("COLHEAD")  ' {}
    '                                        Dim txt() As String = Session("DDLTXT") ' {}
    '                                        Dim Vals() As String = Session("DDLVAL") '{}
    '                                        Dim found As Boolean = False
    '                                        Dim searchHdr As String = formname & "_" & dtField.Rows(j).Item("displayname")
    '                                        For a As Integer = 0 To CH.Length - 1
    '                                            If CH(a).ToString = searchHdr And txt(a).ToString = GR.Cells(j).Text.ToString() Then ' if match found in array 
    '                                                colValue = Vals(a).ToString
    '                                                found = True
    '                                                Exit For
    '                                            End If
    '                                        Next
    '                                        If found = False Then
    '                                            colValue = dtvalue.Rows(cnt).Item(j).ToString()
    '                                        End If
    '                                        'ElseIf dtField.Rows(j).Item("fieldtype") = "Child Item Total" Then

    '                                    Else
    '                                        colValue = GR.Cells(j).Text.ToString()
    '                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
    '                                            If colValue <> "" Then
    '                                                Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                            End If
    '                                        End If
    '                                    End If
    '                                End If
    '                                'STRVal &= "'" & colValue & "'" & ","
    '                                colValue = colValue


    '                            Next
    '                            If Right(str, 1) = "," Then
    '                                str = Left(str, str.Length - 1)
    '                            End If

    '                            str = str & "  where TID=" & GR.Cells(GR.Cells.Count - 1).Text

    '                            ODA.SelectCommand.CommandText = str
    '                            ODA.SelectCommand.ExecuteNonQuery()
    '                            Exit For
    '                        Else

    '                            Dim str As String = "INSERT INTO MMM_MST_DOC_ITEM_draft("
    '                            Dim STRFld As String = ""
    '                            Dim STRVal As String = ""
    '                            updquery = ""
    '                            Dim querry As String = ""

    '                            For j As Integer = 0 To dtField.Rows.Count - 1
    '                                STRFld &= dtField.Rows(j).Item("fieldmapping").ToString & ","  'adding  j+1 for incremental
    '                                Dim colValue As String = ""
    '                                Dim FldID As String = ""

    '                                Dim DispName = dtField.Rows(j).Item("DisplayName").ToString

    '                                FldID = dtField.Rows(j).Item("fieldid").ToString()
    '                                If dtField.Rows(j).Item("inlineediting").ToString = "1" Then

    '                                    Dim ftype As String = dtField.Rows(j).Item("fieldtype").ToString()
    '                                    If ftype.ToUpper() = "TEXT BOX" Or ftype.ToUpper() = "CALCULATIVE FIELD" Or ftype.ToUpper() = "LOOKUP" Then


    '                                        Dim cb As TextBox = CType(GR.FindControl("fld" & FldID & cnt), TextBox)

    '                                        If cb IsNot Nothing Then
    '                                            colValue = cb.Text.ToString
    '                                        Else
    '                                            colValue = "0"
    '                                        End If


    '                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
    '                                            If colValue <> "" Then
    '                                                If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                                ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                    If Convert.ToDouble(colValue) > MaxVal Then
    '                                                        MaxVal = Convert.ToDouble(colValue)
    '                                                        Childtotal = MaxVal
    '                                                    End If
    '                                                End If
    '                                            End If
    '                                        End If
    '                                    ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdowntype").ToString() = "FIX VALUED" Then

    '                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                        If cb IsNot Nothing Then
    '                                            colValue = cb.SelectedItem.Text.ToString
    '                                        Else
    '                                            colValue = "0"
    '                                        End If
    '                                    ElseIf ftype.ToUpper() = "DROP DOWN" And dtField.Rows(j).Item("dropdownTYPE") = "MASTER VALUED" Then
    '                                        Dim cb As DropDownList = CType(GR.FindControl("fld" & FldID & "_" & cnt), DropDownList)
    '                                        If cb IsNot Nothing Then
    '                                            colValue = cb.SelectedItem.Value.ToString  ' use value bcoz it's mastervalued - needs tid
    '                                        Else
    '                                            colValue = "0"
    '                                        End If
    '                                    ElseIf ftype.ToUpper() = "FILE UPLOADER" Then
    '                                        '' here to code for getting file 
    '                                        Dim txtBox As FileUpload = CType(GR.FindControl("fld" & FldID & "_" & cnt), FileUpload)
    '                                        'Prashant 
    '                                        Dim txtBox1 As Label = CType(GR.FindControl("lblf_" & FldID), Label)

    '                                        Dim hdn As HiddenField = CType(GR.FindControl("hdn_" & FldID), HiddenField)

    '                                        Dim hdnflg As HiddenField = CType(GR.FindControl("hdnf_" & FldID), HiddenField)
    '                                        txtBox1.Text = hdn.Value

    '                                        If txtBox.HasFile Then
    '                                            'Dim FN As String = ""
    '                                            'Dim ext As String = ""
    '                                            'FN = Left(txtBox.FileName, txtBox.FileName.LastIndexOf("."))
    '                                            'ext = txtBox.FileName.Substring(txtBox.FileName.LastIndexOf("."), (txtBox.FileName.Length - txtBox.FileName.LastIndexOf(".")))
    '                                            'colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext
    '                                            'txtBox.SaveAs(Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)
    '                                            ''Prashant
    '                                        End If

    '                                        If txtBox1.Text IsNot "" And hdnflg.Value IsNot "0" Then
    '                                            Dim errormsg As String = ""
    '                                            Dim FN As String = ""
    '                                            Dim ext As String = ""
    '                                            Dim flag As Integer = 0
    '                                            Dim sourceFile As String = ""
    '                                            Dim curFileSize As Integer = 0
    '                                            If Not Request.QueryString("TID") Is Nothing Then
    '                                                sourceFile = Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text)
    '                                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/" & Session("EID") & "/" + txtBox1.Text))

    '                                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                                curFileSize = finfo.Length
    '                                            Else
    '                                                sourceFile = Server.MapPath("~/DOCS/temp/" + txtBox1.Text)
    '                                                Dim finfo As New FileInfo(Server.MapPath("~/DOCS/temp/" + txtBox1.Text))

    '                                                ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                                curFileSize = finfo.Length
    '                                            End If
    '                                            ext = txtBox1.Text.Substring(txtBox1.Text.LastIndexOf("."), txtBox1.Text.Length - txtBox1.Text.LastIndexOf("."))
    '                                            FN = Left(txtBox1.Text, txtBox1.Text.LastIndexOf("."))
    '                                            colValue = Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & "" & ext

    '                                            File.Copy(sourceFile, Server.MapPath("DOCS/") & Session("EID").ToString() & "/" & getSafeString(FN) & "_" & Now.Day & Now.Month & Now.Year & Now.Minute & Now.Second & Now.Millisecond & dtField.Rows(j).Item("FieldID").ToString() & ext)

    '                                        ElseIf txtBox1.Text IsNot "" And hdnflg.Value IsNot "1" Then
    '                                            colValue = txtBox1.Text
    '                                        End If
    '                                    Else

    '                                        For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                            If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                                colValue = GR.Cells(index).Text.ToString()
    '                                                Exit For
    '                                            Else
    '                                                colValue = ""
    '                                            End If
    '                                        Next


    '                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
    '                                            If colValue <> "" Then
    '                                                If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                                ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                    If Convert.ToDouble(colValue) > MaxVal Then
    '                                                        MaxVal = Convert.ToDouble(colValue)
    '                                                        Childtotal = MaxVal
    '                                                    End If
    '                                                End If
    '                                            End If
    '                                        End If
    '                                    End If
    '                                Else  ' if no inline editing 
    '                                    If dtField.Rows(j).Item("dropdownTYPE") = "MASTER VALUED" And dtField.Rows(j).Item("fieldtype") = "Drop Down" Then
    '                                        '' here code to get tid from session arrays by sp 13-jan-13
    '                                        Dim CH() As String = Session("COLHEAD")  ' {}
    '                                        Dim txt() As String = Session("DDLTXT") ' {}
    '                                        Dim Vals() As String = Session("DDLVAL") '{}
    '                                        Dim found As Boolean = False
    '                                        Dim searchHdr As String = formname & "_" & dtField.Rows(j).Item("displayname")
    '                                        For a As Integer = 0 To CH.Length - 1
    '                                            If CH(a).ToString = searchHdr And txt(a).ToString = GR.Cells(j).Text.ToString() Then ' if match found in array 
    '                                                colValue = Vals(a).ToString
    '                                                found = True
    '                                                Exit For
    '                                            End If
    '                                        Next
    '                                        If found = False Then
    '                                            'Prashant_21_7
    '                                            For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                                If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                                    colValue = dtvalue.Rows(cnt).Item(DispName).ToString()
    '                                                    Exit For
    '                                                Else
    '                                                    colValue = ""
    '                                                End If
    '                                            Next
    '                                            ' +1 IS ADDED FOR CELL ADJUSTMENT 
    '                                            'Else
    '                                            '    colValue = dtvalue.Rows(cnt).Item(j).ToString() ' added by balli on 2 june 
    '                                        End If
    '                                        'ElseIf dtField.Rows(j).Item("fieldtype") = "Child Item Total" Then

    '                                    Else

    '                                        For index As Integer = 0 To gridCols.Columns.Count - 1
    '                                            If DispName = gridCols.Columns(index).ColumnName.ToString Then
    '                                                colValue = GR.Cells(index).Text.ToString()
    '                                                Exit For
    '                                            Else
    '                                                colValue = ""
    '                                            End If
    '                                        Next
    '                                        ' +1 IS ADDED FOR CELL ADJUSTMENT 
    '                                        If dtField.Rows(j).Item("displayname") = cDispName Then  '' new for getting child total
    '                                            If colValue <> "" Then
    '                                                If dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then  ' by sunil for maxval
    '                                                    Childtotal = Childtotal + Convert.ToDouble(colValue)
    '                                                ElseIf dtTotal.Rows(0).Item("mfieldType").ToString().ToUpper = "CHILD ITEM MAX" Then  ' by sunil for maxval
    '                                                    If Convert.ToDouble(colValue) > MaxVal Then
    '                                                        MaxVal = Convert.ToDouble(colValue)
    '                                                        Childtotal = MaxVal
    '                                                    End If
    '                                                End If
    '                                            End If
    '                                        End If
    '                                    End If
    '                                End If
    '                                STRVal &= "'" & colValue & "'" & ","
    '                            Next

    '                            STRFld &= "DOCID,documenttype,isauth)"
    '                            STRVal &= docid & "," & "'" & formname & "'" & ",1)"
    '                            str &= STRFld & "values(" & STRVal
    '                            ODA.SelectCommand.CommandText = str
    '                            ODA.SelectCommand.ExecuteNonQuery()
    '                            Exit For
    '                        End If
    '                    Next
    '                    cnt += 1
    '                End If
    '            End If
    '        End If
    '    Next


    '    If isTotal Then
    '        Dim childTotalUpdstr As String = ""
    '        childTotalUpdstr = "UPDATE mmm_mst_doc_draft set " & dtTotal.Rows(0).Item("mFieldMapping").ToString & "=" & Childtotal & " where tid=" & docid

    '        ODA.SelectCommand.CommandType = CommandType.Text
    '        ODA.SelectCommand.CommandText = childTotalUpdstr
    '        ODA.SelectCommand.ExecuteNonQuery()
    '    End If

    '    dt.Dispose()
    '    dtTotal.Dispose()
    '    dtField.Dispose()
    '    dtvalue.Dispose()

    '    Session(formname) = Nothing
    '    Session(formname & "VAL") = Nothing
    '    'ViewState("MDOCTYPE") = Nothing
    '    ODA.Dispose()
    'End Sub
    ''Added By Komal on 28March2014
    Protected Sub SavingChildItem_Draft(ByVal formname As String, ByVal docid As Integer, con As SqlConnection, tran As SqlTransaction)
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim ODA As SqlDataAdapter = New SqlDataAdapter("", con)
        Dim dtField As New DataTable
        Dim updquery As String = ""
        Dim ob As New DynamicForm()
        If Session(formname & "VAL") Is Nothing Then
            Exit Sub
        End If

        ' dtField = ViewState(formname)
        dtField = Session("D" & formname)
        Dim dtvalue As DataTable = Session(formname & "VAL")
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If

        For i As Integer = 0 To dtvalue.Rows.Count - 1
            Dim str As String = "INSERT INTO MMM_MST_DOC_ITEM_DRAFT("
            Dim STRfLD As String = ""
            Dim STRVAL As String = ""
            updquery = ""
            For j As Integer = 0 To dtvalue.Columns.Count - 1
                If dtvalue.Columns(j).ColumnName.ToUpper <> "TID" Then
                    STRfLD &= dtField.Rows(j).Item("fieldmapping").ToString & ","
                    STRVAL &= "'" & dtvalue.Rows(i).Item(j).ToString() & "'" & ","
                    If dtField.Rows(j).Item("KC_VALUE").ToString.Length > 5 And dtField.Rows(j).Item("KC_STATUS").ToString.Length = 0 Then
                        updquery &= ob.UPDATEKICKING(dtField.Rows(j).Item("KC_VALUE").ToString(), dtvalue.Rows(i).Item(j).ToString(), pnlFields1)
                    End If
                End If
            Next
            STRfLD &= "DOCID,documenttype,isauth)"
            STRVAL &= docid & "," & "'" & formname & "'" & ",1)"
            str &= STRfLD & "values(" & STRVAL
            ODA.SelectCommand.CommandText = str
            ODA.SelectCommand.Transaction = tran
            ODA.SelectCommand.ExecuteNonQuery()

            '' Hit Kicking Field
            If updquery.Trim.Length > 5 Then
                ODA.SelectCommand.CommandText = updquery
                ODA.SelectCommand.Transaction = tran
                ODA.SelectCommand.ExecuteNonQuery()
            End If
        Next
        Session(formname) = Nothing
        Session(formname & "VAL") = Nothing
        ODA.Dispose()
        '  con.Close()
        ' con.Dispose()
    End Sub
#End Region

#Region "auto complete list" ' by balli 1 aprail march
    <WebMethod()> _
<Script.Services.ScriptMethod()> _
    Public Shared Function GetCompletionList(ByVal prefixText As String, ByVal count As Integer, ByVal contextKey As String) As String()

        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As New SqlConnection(conStr)
        Dim arr() As String
        arr = contextKey.Split("-")
        Dim TID As String = "TID"
        Dim TABLENAME As String = ""
        If UCase(arr(0).ToString()) = "MASTER" Then
            TABLENAME = "MMM_MST_MASTER"
        ElseIf UCase(arr(0).ToString()) = "DOCUMENT" Then
            TABLENAME = "MMM_MST_DOC"
        ElseIf UCase(arr(0).ToString()) = "CHILD" Then
            TABLENAME = "MMM_MST_DOC_ITEM"
        ElseIf UCase(arr(0).ToString) = "STATIC" Then
            If arr(1).ToString.ToUpper = "USER" Then
                TABLENAME = "MMM_MST_USER"
                TID = "UID"
            ElseIf arr(1).ToString().ToUpper = "LOCATION" Then
                TABLENAME = "MMM_MST_LOCATION"
                TID = "LOCID"
            End If
        End If
        HttpContext.Current.Session("tableTID") = TABLENAME & "||" & TID  ' this is initializing because we need this at textbox changed event  in dynamic class
        Dim panelfields As Panel = HttpContext.Current.Session("pnlFields")
        Dim updpanel As UpdatePanel = HttpContext.Current.Session("updatepanel1")
        'autofilExtender.ContextKey = ds.Rows(i).Item("dropdown").ToString() & "-" & ds.Rows(i).Item("FieldID").ToString() & "-" & ds.Rows(i).Item("dropdowntype").ToString() & "-" & ds.Rows(i).Item("autofilter").ToString() & "-" & ds.Rows(i).Item("InitialFilter").ToString()
        'context key contain  : dropdown-fieldid-dropdowntype-autofilter-InitialFilter' adding the fieldid in context key because later on we need id of field in web method 

        ''''for blank the lookup control on selection 


        'Dim sqlda As New SqlDataAdapter("select * from MMM_MST_Fields where eid=" & HttpContext.Current.Session("EID") & " and dropdown='" & arr(3) & "'", con)
        'Dim dtt As New DataTable
        'sqlda.Fill(dtt)
        'If dtt.Rows.Count > 0 Then
        '    For j As Integer = 0 To dtt.Rows.Count - 1
        '        If DynamicForm.GetControl(panelfields, "fld" & dtt.Rows(j).Item("fieldid").ToString) Then
        '            Dim txtbox As TextBox = CType(panelfields.FindControl("fld" & dtt.Rows(j).Item("fieldid").ToString), TextBox)
        '            Dim num As String = txtbox.Text
        '            txtbox.Text = String.Empty
        '        End If
        '    Next
        'End If
        'sqlda.Dispose()
        ''' end here to lookup check

        Dim lookUpqry As String = ""
        Dim str As String = ""
        If arr(0).ToUpper() = "CHILD" Then
            str = "select top 50  " & arr(2).ToString() & " As [name]," & TID & "[tid]  from " & TABLENAME & " M WHERE   DOCUMENTTYPE='" & arr(1).ToString() & "'"
        ElseIf arr(0).ToUpper() <> "STATIC" Then
            str = "select top 50  " & arr(2).ToString() & " As [name]," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
        Else
            If arr(2).ToString.ToUpper = "LOCATIONSTATE" Then
                str = "select DISTINCT " & arr(2).ToString() & " As [name],SID [tid]" & lookUpqry & " from " & TABLENAME & " M "
            Else
                str = "select " & arr(2).ToString() & " As [name]," & TID & "[tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
            End If
        End If

        Dim xwhr As String = ""
        Dim tids As String = ""
        Dim Rtids As String = ""   ' for prerole data filter
        'Dim tidarr() As String

        ''FILTER THE DATA ACCORDING TO USER 
        Dim ob As New DynamicForm
        tids = ob.UserDataFilter(contextKey.Split("-").ElementAt(1).ToString(), arr(1).ToString())
        Rtids = ob.UserDataFilter_PreRole(arr(1).ToString(), TABLENAME)  '' new by sunil for pre role data filter 22-feb

        If tids.Length >= 2 Then
            xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
            'ElseIf tids = "0" Then
            '    pnlFields.Visible = False
            '    btnActEdit.Visible = False
            '    UpdatePanel1.Update()
            '    xwhr = ""
        End If

        If Rtids.Length >= 2 Then
            If xwhr.ToString = "" Then
                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & Rtids & ")"
            Else
                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & "," & Rtids & ")"
            End If
        End If

        str = str & "  AND M.isauth=1 " & xwhr
        Dim AutoFilter As String = arr(5) 'ds.Rows(i).Item("AutoFilter").ToString()
        Dim InitFilterArr As String() = arr(6).Split(":") 'ds.Rows(i).Item("InitialFilter").ToString().Split(":")
        Dim da1 As New SqlDataAdapter("select isnull(sessionfieldVal,0) as sessionfieldVal from mmm_mst_fields where fieldid=" & arr(3) & " and eid=" & HttpContext.Current.Session("EID"), con)
        If con.State = ConnectionState.Closed Then
            con.Open()
        End If
        Dim SessionFieldvalue As String = Convert.ToString(da1.SelectCommand.ExecuteScalar())
        If AutoFilter.Length > 0 Then
            Dim filteriD As String = arr(3)
            Dim mval As String = ""
            Dim filterMasVal As String = ""
            Dim ODA As New SqlDataAdapter("", con)
            ' ODA.SelectCommand.CommandText = "select top 1 * from MMM_MSt_Fields where eid='" & HttpContext.Current.Session("EID") & "' and fieldtype in ('Drop Down','AutoComplete') and lookupvalue like '%" & filteriD & "-S%'"
            'With(nolock) added by Himank on 29th sep 2015
            ODA.SelectCommand.CommandText = "select top 1 * from MMM_MSt_Fields  WITH(NOLOCK)  where eid='" & HttpContext.Current.Session("EID") & "' and fieldtype in ('Drop Down','AutoComplete') and lookupvalue like '%" & filteriD & "-S%'"
            Dim dt As New DataSet()
            ODA.Fill(dt, "filtrId")
            If dt.Tables("filtrId").Rows.Count > 0 Then
                Dim fieldtype As String = dt.Tables("filtrId").Rows(0).Item("fieldtype").ToString
                If fieldtype.ToUpper = "DROP DOWN" Then
                    If dt.Tables("filtrId").Rows(0).Item("DropDownType").ToString = "SESSION VALUED" Then
                        ' 16 march balli  
                        'str = "select " & arr(2).ToString() & " As [name]," & TID & "[tid]" & lookUpqry & " from MMM_MST_USER M WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                        'Dim ddl As DropDownList = CType(panelfields.FindControl("fld" & dt.Tables("filtrId").Rows(0).Item("fieldid")), DropDownList)
                        'mval = ddl.SelectedItem.Value
                        'filterMasVal = " AND CONVERT(NVARCHAR(10)," & AutoFilter & ") = '" & mval & "' "
                    Else
                        Dim ddl As DropDownList = CType(panelfields.FindControl("fld" & dt.Tables("filtrId").Rows(0).Item("fieldid")), DropDownList)
                        mval = ddl.SelectedItem.Value
                        filterMasVal = " AND CONVERT(NVARCHAR(10)," & AutoFilter & ") = '" & mval & "' "
                    End If
                Else
                    Dim ddl As HiddenField = CType(panelfields.FindControl("HDN" & dt.Tables("filtrId").Rows(0).Item("fieldid")), HiddenField)  ' for hidden field
                    'Dim ddl As TextBox = CType(panelfields.FindControl("fld" & dt.Tables("filtrId").Rows(0).Item("fieldid")), TextBox)
                    'Dim MId As String() = Split(ddl.Text, "-")
                    'mval = Replace(MId(1), "[", "")
                    'mval = mval.Replace("]", "")
                    ' filterMasVal = " AND CONVERT(NVARCHAR(10)," & AutoFilter & ") = '" & mval & "' "
                    filterMasVal = " AND CONVERT(NVARCHAR(10)," & AutoFilter & ") = '" & Val(ddl.Value) & "' "
                End If
            End If
            ' for binding autocomplete with the selection of dropdo
            If arr(0).ToUpper() = "CHILD" Then
                If AutoFilter.ToUpper = "DOCID" Then
                    str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
                Else
                    str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
                End If
            ElseIf arr(0).ToUpper() <> "STATIC" Then
                'With(nolock) added by Himank on 29th sep 2015
                str = "select top 50 " & arr(2).ToString() & " As [name],convert(nvarchar(10),tid)  [tid]" & lookUpqry & " from " & TABLENAME & " M   WITH(NOLOCK) WHERE EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                str = str & "  AND M.isauth=1 " & xwhr
                If filterMasVal.Length > 1 Then
                    str = str & filterMasVal
                End If
            Else
                'With(nolock) added by Himank on 29th sep 2015
                str = "select top 50 " & arr(2).ToString() & " As [name],convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M  WITH(NOLOCK)  WHERE EID=" & HttpContext.Current.Session("EID") & " "
                str = str & "  AND M.isauth=1 " & xwhr
                If filterMasVal.Length > 1 Then
                    str = str & filterMasVal
                End If
            End If
        ElseIf SessionFieldvalue.Length > 0 Then
            Dim val As String() = SessionFieldvalue.ToString().Split("-")
            If arr(0).ToUpper() = "CHILD" Then
                If AutoFilter.ToUpper = "DOCID" Then
                    str = ob.GetQuery1(arr(1).ToString, arr(2).ToString())
                Else
                    str = ob.GetQuery(arr(1).ToString, arr(2).ToString)
                End If
            ElseIf arr(0).ToUpper() <> "STATIC" Then

                da1.SelectCommand.Parameters.Clear()
                da1.SelectCommand.CommandText = "select isnull(" & val(0) & ",0) from mmm_mst_user where eid=" & HttpContext.Current.Session("EID") & " and uid=" & HttpContext.Current.Session("UID")
                If con.State = ConnectionState.Closed Then
                    con.Open()
                End If
                Dim Conval As String = Replace(Convert.ToString(da1.SelectCommand.ExecuteScalar), ",", "','")
                str = "select " & arr(2).ToString() & "  As [name],convert(nvarchar(10)," & TID & ")  [tid] from " & TABLENAME & " M WHERE  EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                If Conval.Length > 1 Then
                    If SessionFieldvalue.Contains("-") Then
                        str = str & "  AND (M.isauth>0) " & xwhr & " and " & val(2) & " in('" & Conval & "') "
                    Else
                        str = str & "  AND (M.isauth>0) " & xwhr & " and  tid in ('" & Conval & "') "
                    End If

                Else
                    str = str & "  AND (M.isauth>0) " & xwhr
                End If

            Else
                str = "select " & arr(2).ToString() & "  As [name],convert(nvarchar(10)," & TID & ")  [tid]" & lookUpqry & " from " & TABLENAME & " M WHERE EID=" & HttpContext.Current.Session("EID") & " "
                str = str & "  AND (M.isauth>0) " & xwhr
            End If
        ElseIf InitFilterArr.Length > 1 Then
            Dim daa As New SqlDataAdapter("select * from MMM_MST_Fields where fieldid=" & InitFilterArr(0) & "", con)
            Dim dss As New DataSet
            daa.Fill(dss, "data")
            Dim row() As DataRow = dss.Tables("data").Select("fieldid=" & InitFilterArr(0).ToString())
            If arr(0).ToUpper() = "DOCUMENT" Or arr(0).ToUpper() = "MASTER" Then
                If row.Length > 0 Then
                    'With(nolock) added by Himank on 29th sep 2015
                    str = " Select top 50 " & arr(2).ToString() & "  As [name], convert(nvarchar(10),tid) [TID] FROM " & TABLENAME & " M  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("EID") & " AND  DOCUMENTTYPE='" & arr(1).ToString() & "'"
                    str = str & " AND " & InitFilterArr(1).ToString() & "='" & row(0).Item("defaultFieldVal").ToString & "'"
                    str = str & "  AND M.isauth=1 " & xwhr
                End If
            ElseIf arr(0).ToUpper() = "STATIC" Then
                If row.Length > 0 Then
                    'With(nolock) added by Himank on 29th sep 2015
                    str = " Select top 50 " & arr(2).ToString() & "As [name],convert(nvarchar(10)," & TID & ")  [tid]" & "FROM " & TABLENAME & " M  WITH(NOLOCK)  where EID=" & HttpContext.Current.Session("EID") & " "
                    str = str & " AND " & InitFilterArr(1).ToString() & "='" & row(0).Item("defaultFieldVal").ToString & "'"
                    str = str & "  AND M.isauth=1 " & xwhr
                End If
            End If
            dss.Dispose()
            daa.Dispose()
        End If
        ' Dim da As New SqlDataAdapter("select top 50 " & contextKey.Split("-").ElementAt(2) & " As [name] , tid from " & TABLENAME & "  where EID ='" & HttpContext.Current.Session("EID") & "' and documenttype ='" & contextKey.Split("-").ElementAt(1).ToString() & "' and " & contextKey.Split("-").ElementAt(2).ToString() & " like '" & prefixText & "%' ", con)
        ' for hidden field value check
        'Dim pnlHdnfld As HiddenField = CType(panelfields.FindControl("HDN" & arr(3)), HiddenField)


        ' Dim da As New SqlDataAdapter(str & " and " & contextKey.Split("-").ElementAt(2).ToString() & " like '%" & prefixText & "%'  order by " & arr(2).ToString(), con)
        Dim da As New SqlDataAdapter(str & " and " & contextKey.Split("-").ElementAt(2).ToString() & " like '%" & prefixText & "%'  order by LEN(" & arr(2).ToString() & ") ", con)
        Dim ds As New DataSet()
        da.Fill(ds, "data")
        Dim items As New List(Of String)
        Dim items1 As String = String.Empty
        For i As Integer = 0 To ds.Tables("data").Rows.Count - 1
            'items.Add(ds.Tables("data").Rows(i).Item("name").ToString() & "-[" & ds.Tables("data").Rows(i).Item("tid").ToString() & "]")
            items1 = AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(ds.Tables("data").Rows(i).Item("name").ToString(), ds.Tables("data").Rows(i).Item("tid").ToString())
            items.Add(items1)
        Next
        If ds.Tables("data").Rows.Count = 0 Then
            items1 = AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem("Matching records not found", 0)
            items.Add(items1)
        End If
        HttpContext.Current.Session("fieldid") = contextKey.Split("-").ElementAt(3)  ' this session id we need dynamic form for calculation the other field
        ds.Dispose()
        da.Dispose()

        con.Dispose()
        con = Nothing
        Return items.ToArray()
    End Function
#End Region



#Region "for autocomplete inline grid method by balli "
    Private Sub bindLookUp(ByVal id1 As Integer, ByVal ACROWS As GridViewRow, ByVal Acid As Integer)
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If
        'With(nolock) added by Himank on 29th sep 2015
        Dim oda As SqlDataAdapter = New SqlDataAdapter("select LOOKUPVALUE,dropdown,documenttype,dropdowntype from MMM_MST_FIELDS  WITH(NOLOCK)  WHERE FIELDID=" & id1 & "", con)
        Dim DS As New DataSet
        Dim xwhr As String = ""
        oda.Fill(DS, "data")

        Dim LOOKUPVALUE As String = DS.Tables("data").Rows(0).Item("lookupvalue").ToString()
        Dim documenttype() As String = DS.Tables("data").Rows(0).Item("dropdown").ToString.Split("-")

        If LOOKUPVALUE.Length > 0 Then
            Dim lookfld() As String = LOOKUPVALUE.ToString().Split(",")  '' get all controls to fill in lookup
            If lookfld.Length > 0 Then
                For iLookFld As Integer = 0 To lookfld.Length - 1            '' loop for lookup vals 
                    Dim fldPair() As String = lookfld(iLookFld).Split("-")   '' get fieldid and mapping
                    If fldPair.Length > 1 Then
                        'Dim obj As DynamicForm = New DynamicForm()
                        '                        If DynamicForm.GetControl(pnlFields, "fld" & Val(fldPair(0)).ToString()) Then   '' check if control to be filled exists
                        If Not IsNothing(ACROWS.FindControl("fld" & Val(fldPair(0)) & ACROWS.RowIndex)) Then
                            'With(nolock) added by Himank on 29th sep 2015
                            oda = New SqlDataAdapter("SELECT * FROM MMM_MST_FIELDS  WITH(NOLOCK)  WHERE FIELDID=" & fldPair(0) & "", con)  ' get fld dtl from fld master
                            Dim dt As New DataTable
                            oda.Fill(dt)
                            Dim STR As String = ""
                            If fldPair(1).ToString.ToUpper = "C" Then    '' fldpair(0) = fieldid to be filled 
                                Dim proc As String = dt.Rows(0).Item("CAL_FIELDS").ToString()
                                If proc.Length > 1 Then
                                    Dim DROPDOWN1 As String = dt.Rows(0).Item("AUTOFILTER").ToString()
                                    Dim DDL0 As DropDownList = TryCast(pnlFields.FindControl("fld" & DROPDOWN1), DropDownList)
                                    ' bindsunil
                                    If DDL0.SelectedItem.Text.ToUpper <> "SELECT" Then
                                        oda.SelectCommand.CommandType = CommandType.StoredProcedure
                                        oda.SelectCommand.Parameters.Clear()
                                        oda.SelectCommand.CommandText = proc
                                        oda.SelectCommand.Parameters.AddWithValue("DOCID", DDL0.SelectedValue)
                                        oda.SelectCommand.Parameters.AddWithValue("FIELDID", CInt(DROPDOWN1))
                                        oda.SelectCommand.Parameters.AddWithValue("VALUE", Acid)
                                        Dim dss As New DataTable
                                        oda.Fill(dss)
                                        Dim ddl1 As DropDownList = TryCast(pnlFields.FindControl("fld" & fldPair(0).ToString()), DropDownList)
                                        ddl1.Items.Clear()
                                        ddl1.Items.Add("SELECT")
                                        ddl1.Items(0).Value = "0"
                                        For i As Integer = 0 To dss.Rows.Count - 1
                                            ddl1.Items.Add(dss.Rows(i).Item(0).ToString())
                                            ddl1.Items(i + 1).Value = dss.Rows(i).Item("tID")
                                        Next
                                    End If
                                End If
                            ElseIf fldPair(1).ToString.ToUpper = "R" Then
                                Dim TAB1 As String = ""
                                Dim TAB2 As String = ""
                                Dim STID As String = ""
                                Dim TID As String = ""
                                If documenttype(0).ToString.ToUpper = "MASTER" Then
                                    TAB2 = "MMM_MST_MASTER"
                                    TID = "TID"
                                ElseIf documenttype(0).ToString.ToUpper = "DOCUMENT" Then
                                    TAB2 = "MMM_MST_DOC"
                                    TID = "TID"
                                ElseIf documenttype(1).ToString.ToUpper = "USER" Then
                                    TAB2 = "MMM_MST_USER"
                                    TID = "UID"
                                End If
                                Dim DOCTYPE() As String = dt.Rows(0).Item("DROPDOWN").ToString.Split("-")
                                If DOCTYPE(0).ToString.ToUpper = "MASTER" Then
                                    TAB1 = "MMM_MST_MASTER"
                                    STID = "TID"
                                ElseIf DOCTYPE(0).ToString.ToUpper = "DOCUMENT" Then
                                    TAB1 = "MMM_MST_DOC"
                                    STID = "TID"
                                ElseIf DOCTYPE(1).ToString.ToUpper = "USER" Then
                                    TAB1 = "MMM_MST_USER"
                                    STID = "UID"
                                End If
                                Dim DROPDOWN1 As String = dt.Rows(0).Item("AUTOFILTER").ToString()
                                ''Dim DDL0 As DropDownList = TryCast(pnlFields.FindControl("fld" & DROPDOWN1), DropDownList)
                                oda.SelectCommand.CommandType = CommandType.StoredProcedure
                                oda.SelectCommand.Parameters.Clear()
                                oda.SelectCommand.CommandText = "USP_GETMANNUALFILTER"
                                oda.SelectCommand.Parameters.AddWithValue("@EID", HttpContext.Current.Session("EID"))
                                oda.SelectCommand.Parameters.AddWithValue("@TAB1", TAB1)
                                oda.SelectCommand.Parameters.AddWithValue("@TAB2", TAB2)
                                oda.SelectCommand.Parameters.AddWithValue("@DOCUMENTTYPE", DOCTYPE(1).ToString)
                                oda.SelectCommand.Parameters.AddWithValue("@FLDMAPPING", DOCTYPE(2).ToString)
                                oda.SelectCommand.Parameters.AddWithValue("@AUTOFILTER", dt.Rows(0).Item("AUTOFILTER").ToString())
                                oda.SelectCommand.Parameters.AddWithValue("@TID", TID)
                                oda.SelectCommand.Parameters.AddWithValue("@STID", STID)
                                oda.SelectCommand.Parameters.AddWithValue("@VAL", Acid)
                                Dim dss As New DataTable
                                oda.Fill(dss)



                                Dim ddl1 As DropDownList = TryCast(pnlFields.FindControl("fld" & fldPair(0).ToString()), DropDownList)
                                ddl1.Items.Clear()
                                ddl1.Items.Add("SELECT")
                                ddl1.Items(0).Value = "0"
                                For i As Integer = 0 To dss.Rows.Count - 1
                                    ddl1.Items.Add(dss.Rows(i).Item(0).ToString())
                                    ddl1.Items(i + 1).Value = dss.Rows(i).Item("tID")
                                Next
                            Else    '' else of case 'R' and 'C' lookup (for -fld)
                                Dim DROPDOWN As String() = dt.Rows(0).Item("DROPDOWN").ToString.Split("-")  ' this contains tobe filled values 
                                Dim TABLENAME As String = ""
                                Dim TID As String = "TID"
                                If UCase(DROPDOWN(0).ToString()) = "MASTER" Then
                                    TABLENAME = "MMM_MST_MASTER"
                                ElseIf UCase(DROPDOWN(0).ToString()) = "DOCUMENT" Then
                                    TABLENAME = "MMM_MST_DOC"
                                ElseIf UCase(DROPDOWN(0).ToString()) = "CHILD" Then
                                    TABLENAME = "MMM_MST_DOC_ITEM"
                                ElseIf UCase(DROPDOWN(0).ToString()) = "STATIC" Then
                                    If UCase(DROPDOWN(1).ToString()) = "USER" Then
                                        TABLENAME = "MMM_MST_USER"
                                        TID = "UID"
                                    ElseIf UCase(DROPDOWN(1).ToString()) = "LOCATION" Then
                                        TABLENAME = "MMM_MST_LOCATION"
                                        If DROPDOWN(2).ToString.ToUpper = "LOCATIONSTATE" Then
                                            TID = "SID"
                                        Else
                                            TID = "LOCID"
                                        End If
                                    Else
                                        TABLENAME = dt.Rows(0).Item("DBTABLENAME").ToString
                                    End If
                                ElseIf UCase(DROPDOWN(0).ToString()) = "SESSION" Then
                                    TABLENAME = "MMM_MST_USER"
                                    TID = "UID"
                                End If
                                ' Dim SLVALUE As String() = Acid ''ddl.SelectedValue.Split("|")

                                If dt.Rows(0).Item("fieldtype").ToString.ToUpper() = "AUTOCOMPLETE" Then  '' check field type 
                                    If DynamicForm.GetControl(pnlFields, "fld" & Val(fldPair(0)).ToString()) Then
                                        Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & Val(fldPair(0)).ToString()), TextBox)
                                        txtBox.Text = String.Empty
                                    End If

                                ElseIf dt.Rows(0).Item("fieldtype").ToString.ToUpper() = "DROP DOWN" Then  '' check field type 
                                    Dim AUTOFILTER As String = dt.Rows(0).Item("AUTOFILTER").ToString()
                                    Dim tids As String = ""

                                    ''Filter Data according to Userid
                                    Dim obj As DynamicForm = New DynamicForm()
                                    tids = obj.UserDataFilter(DS.Tables("data").Rows(0).Item("documenttype").ToString(), DROPDOWN(1).ToString())
                                    If tids.Length > 2 Then
                                        xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
                                    Else
                                        xwhr = ""
                                    End If

                                    Dim ChildDoctype As String = ""

                                    If DS.Tables("data").Rows(0).Item("dropdowntype") = "CHILD VALUED" Then
                                        Dim ChildMid() As String = documenttype(1).ToString.Split(":")
                                        ChildDoctype = ChildMid(1).ToString
                                    End If

                                    oda.SelectCommand.CommandType = CommandType.StoredProcedure
                                    oda.SelectCommand.CommandText = "USP_BINDDDL"
                                    oda.SelectCommand.Parameters.Clear()
                                    oda.SelectCommand.Parameters.AddWithValue("@EID", HttpContext.Current.Session("EID"))
                                    oda.SelectCommand.Parameters.AddWithValue("@TableName", TABLENAME)
                                    oda.SelectCommand.Parameters.AddWithValue("@Val", Acid)
                                    oda.SelectCommand.Parameters.AddWithValue("@xwhr", xwhr)
                                    oda.SelectCommand.Parameters.AddWithValue("@tid", TID)
                                    If ChildDoctype.Length > 0 Then
                                        oda.SelectCommand.Parameters.AddWithValue("@documenttype", ChildDoctype)
                                    Else
                                        oda.SelectCommand.Parameters.AddWithValue("@documenttype", DROPDOWN(1))
                                    End If
                                    oda.SelectCommand.Parameters.AddWithValue("@fldmapping", DROPDOWN(2))
                                    oda.SelectCommand.Parameters.AddWithValue("@autofilter", AUTOFILTER)
                                    'oda.SelectCommand.CommandText = STR & " AND isAuth=1 " & xwhr & " Order by " & DROPDOWN(2).ToString()
                                    Dim dtFinal As New DataTable
                                    oda.Fill(dtFinal)

                                    Dim ddlo As DropDownList = TryCast(pnlFields.FindControl("fld" & fldPair(0).ToString()), DropDownList)
                                    ddlo.Items.Clear()
                                    ddlo.Items.Add("SELECT")
                                    ddlo.Items(0).Value = "0"
                                    For i As Integer = 0 To dtFinal.Rows.Count - 1
                                        ddlo.Items.Add(dtFinal.Rows(i).Item(0).ToString())
                                        ddlo.Items(i + 1).Value = dtFinal.Rows(i).Item("tID")
                                    Next
                                Else
                                    'Dim TID1 As String() = "" ''ddl.SelectedValue.ToString.Split("|")
                                    'Dim SELTID As String = ""
                                    'If TID1.Length > 1 Then
                                    '    SELTID = TID1(1).ToString
                                    'Else
                                    '    SELTID = TID1(0).ToString
                                    'End If
                                    Dim value As String = ""

                                    '' below changes made by sunil for child valued lookup on 12-dec-13
                                    Dim ChildDoctype As String = ""
                                    If DS.Tables("data").Rows(0).Item("dropdowntype") = "CHILD VALUED" Then
                                        Dim ChildMid() As String = documenttype(1).ToString.Split(":")
                                        ChildDoctype = ChildMid(1).ToString
                                    End If

                                    If Acid.ToString <> "0" And Acid.ToString <> "" Then
                                        oda = New SqlDataAdapter("", con)
                                        oda.SelectCommand.CommandType = CommandType.StoredProcedure
                                        oda.SelectCommand.Parameters.Clear()
                                        oda.SelectCommand.CommandText = "uspGetMasterValue"
                                        oda.SelectCommand.Parameters.AddWithValue("EID", HttpContext.Current.Session("EID"))
                                        If ChildDoctype.Length > 0 Then
                                            oda.SelectCommand.Parameters.AddWithValue("documentType", ChildDoctype)
                                        Else
                                            oda.SelectCommand.Parameters.AddWithValue("documentType", documenttype(1))
                                        End If
                                        oda.SelectCommand.Parameters.AddWithValue("Type", documenttype(0))
                                        oda.SelectCommand.Parameters.AddWithValue("TID", Acid)
                                        oda.SelectCommand.Parameters.AddWithValue("FLDMAPPING", fldPair(1))
                                        If con.State <> ConnectionState.Open Then
                                            con.Open()
                                        End If
                                        value = oda.SelectCommand.ExecuteScalar().ToString()
                                    End If
                                    Dim TXTBOX As TextBox = TryCast(ACROWS.FindControl("fld" & fldPair(0).ToString() & ACROWS.RowIndex), TextBox)
                                    TXTBOX.Text = value
                                    'Dim proc As String = dt.Rows(0).Item("dropdowntype").ToString()
                                    'If proc.Length > 1 Then
                                    '    Dim DROPDOWN1 As String = dt.Rows(0).Item("DROPDOWN").ToString()
                                    '    Dim DDL0 As DropDownList = TryCast(pnlFields.FindControl("fld" & DROPDOWN1), DropDownList)
                                    '    oda.SelectCommand.CommandType = CommandType.StoredProcedure
                                    '    oda.SelectCommand.Parameters.Clear()
                                    '    oda.SelectCommand.CommandText = proc
                                    '    oda.SelectCommand.Parameters.AddWithValue("VcNo", value)
                                    '    oda.SelectCommand.Parameters.AddWithValue("fldmapping", fldPair(1))
                                    '    oda.SelectCommand.Parameters.AddWithValue("FIELDID", CInt(DROPDOWN1))
                                    '    oda.SelectCommand.Parameters.AddWithValue("VALUE", DDL0.SelectedValue)
                                    '    Dim dss As New DataTable
                                    '    oda.Fill(dss)
                                    '    Dim ddl1 As DropDownList = TryCast(pnlFields.FindControl("fld" & dt.Rows(0).Item("autofilter").ToString()), DropDownList)
                                    '    ddl1.Items.Clear()
                                    '    ddl1.Items.Add("SELECT")
                                    '    ddl1.Items(0).Value = "0"
                                    '    For i As Integer = 0 To dss.Rows.Count - 1
                                    '        ddl1.Items.Add(dss.Rows(i).Item(0).ToString())
                                    '        ddl1.Items(i + 1).Value = dss.Rows(i).Item("tID")
                                    '    Next
                                    'End If
                                End If
                            End If
                        End If
                    End If
                Next
            End If
        End If
        con.Dispose()
        oda.Dispose()



    End Sub
    Private Sub txtbox_TextChanged(ByVal sender As Object, ByVal e As EventArgs)
        Try


            Dim Ac As TextBox = TryCast(sender, TextBox)
            Dim id As String = Ac.ID
            Dim hdnID = id.Replace("fld", "HDN")
            Dim idsa As String = Ac.Parent.ToString
            Dim HDN As HiddenField = CType(Ac.Parent.FindControl(hdnID), HiddenField)
            Dim hdnVal As Integer = HDN.Value
            Dim tablename As String() = Split(HttpContext.Current.Session("tableTID"), "||")
            If tablename.Length > 1 Then
                Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString.ToString()
                Dim con As New SqlConnection(conStr)
                'With(nolock) added by Himank on 29th sep 2015
                Dim da As New SqlDataAdapter("select * from " & tablename(0) & "  WITH(NOLOCK)  where eid=" & HttpContext.Current.Session("EID") & " and " & tablename(1) & "=" & hdnVal & " ", con)
                Dim ds As New DataSet
                da.Fill(ds, "fldID")
                If ds.Tables("fldID").Rows.Count = 1 Then
                    'With(nolock) added by Himank on 29th sep 2015
                    da.SelectCommand.CommandText = "select * from MMM_MST_FIElds  WITH(NOLOCK)  where fieldid=" & HttpContext.Current.Session("fieldid") & ""
                    da.Fill(ds, "AcFldid")
                    Dim ddlText As String = ds.Tables("AcFldid").Rows(0).Item("dropdown").ToString()
                    Dim arr As String() = ddlText.Split("-")
                    If ds.Tables("AcFldid").Rows(0).Item("lookupvalue").ToString.Length > 2 Then
                        Dim lookupvalue() As String = ds.Tables("AcFldid").Rows(0).Item("lookupvalue").ToString.Split(",")
                        For ii As Integer = 0 To lookupvalue.Length - 1
                            If ds.Tables("AcFldid").Rows(0).Item("lookupvalue").ToString.Contains("-S") Or ds.Tables("AcFldid").Rows(0).Item("lookupvalue").ToString.Contains("-R") Or ds.Tables("AcFldid").Rows(0).Item("lookupvalue").ToString.Contains("-C") Or ds.Tables("AcFldid").Rows(0).Item("lookupvalue").ToString.Contains("-fld") Then
                                bindLookUp(ds.Tables("AcFldid").Rows(0).Item("FIELDID"), Ac.Parent.Parent, hdnVal)
                            End If
                        Next
                    End If

                End If
            End If
        Catch ex As Exception
            Exit Sub
        End Try

    End Sub
#End Region


    Public Sub Filter(ByVal sender As Object, ByVal e As EventArgs)
        Try

            ' Session("BindGrdOnDdl") = Nothing  ' once click disposing the session of dynamic filter
            Dim i = 0
            Dim btnFilter As Button = TryCast(sender, Button)
            Dim btnID = btnFilter.ID
            Dim FieldID As String = ""
            Dim newdictionary As New Dictionary(Of Integer, Integer)
            'btn ID Is seperated by _ 
            Dim arr = btnID.Split("_")
            FieldID = arr(0).Replace("BTNFLTER", String.Empty)
            Dim ChildItemName = ""
            For J As Integer = 1 To arr.Length - 1
                ChildItemName = ChildItemName & " " & arr(J)
            Next
            ChildItemName = ChildItemName.Trim()
            Dim grd As GridView = pnlFields.FindControl("GRD" & FieldID)
            Dim DS As DataTable = CType(Session(ChildItemName), DataTable)

            Dim dt As New DataTable()
            dt = DS.Clone()
            'By NehaThakar 4/2/15
            If Not grd Is Nothing Then

                If grd.Rows.Count > 0 Then
                    'loop through all rows of grid
                    Try

                        For Each row As GridViewRow In grd.Rows
                            Dim chkBox As CheckBox
                            Dim DICT As New Dictionary(Of Integer, Integer)
                            DICT = CType(Session("AddedRow"), Dictionary(Of Integer, Integer))
                            If Not IsNothing(DICT) Then

                                If row.RowType = DataControlRowType.DataRow Then
                                    If Not IsNothing(Session("AddedRow")) And DICT.ContainsKey(row.RowIndex) Then
                                        ' 


                                        chkBox = CType(row.FindControl("fld" & row.RowIndex), CheckBox)
                                        If Not (chkBox Is Nothing) Then
                                            If chkBox.Checked = True Then
                                                dt.Rows.Add(dt.NewRow)

                                                If Not IsNothing(Session("FilterAddedRow")) Then
                                                    newdictionary = CType(Session("FilterAddedRow"), Dictionary(Of Integer, Integer))
                                                    newdictionary.Add(dt.Rows.Count - 1, dt.Rows.Count - 1)
                                                Else
                                                    newdictionary.Add(dt.Rows.Count - 1, dt.Rows.Count - 1)

                                                End If
                                                Session("FilterAddedRow") = newdictionary
                                            End If

                                        End If
                                    Else

                                        chkBox = CType(row.FindControl("fld" & row.RowIndex), CheckBox)
                                        If Not (chkBox Is Nothing) Then
                                            If chkBox.Checked = True Then
                                                Dim dr1 As DataRow = dt.NewRow()
                                                dr1 = DS.Rows(row.RowIndex)
                                                dt.Rows.Add(dr1.ItemArray)
                                            End If
                                        End If
                                    End If
                                End If
                            Else

                                chkBox = CType(row.FindControl("fld" & row.RowIndex), CheckBox)
                                If Not (chkBox Is Nothing) Then
                                    If chkBox.Checked = True Then
                                        Dim dr1 As DataRow = dt.NewRow()
                                        dr1 = DS.Rows(row.RowIndex)
                                        dt.Rows.Add(dr1.ItemArray)
                                    End If
                                End If

                            End If

                        Next
                    Catch ex As Exception

                    End Try

                End If
            End If
            'By NehaThakar 4/2/15
            Dim scrname = Request.QueryString("SC").ToString()
            'With(nolock) added by Himank on 29th sep 2015
            Dim StrQuery = "SELECT F1.FieldID,F2.displayName,F1.FieldType FROM MMM_MST_FIELDS F1  WITH(NOLOCK)  INNER JOIN MMM_MST_FIELDS F2  WITH(NOLOCK)  ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & "  AND F1.FieldType  in ('CHILD ITEM MAX','CHILD ITEM TOTAL')   AND F2.DocumentType ='" & ChildItemName & "' AND F1.DOCUMENTTYPE='" & scrname & "'"
            'oda.Fill(DS, "TOTAL")
            Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
            Dim dsTotal As New DataSet()
            Using con = New SqlConnection(conStr)
                Using da = New SqlDataAdapter(StrQuery, con)
                    da.Fill(dsTotal, "TOTAL")
                End Using
            End Using

            Session(ChildItemName) = dt
            Dim ob As New DynamicForm()

            ob.BINDITEMGRID1(Session(ChildItemName), pnlFields, FieldID, UpdatePanel1, dsTotal.Tables("TOTAL"), -1, -1, scrname, ChildItemName, Convert.ToInt32(Session("EID")))
            DdlFiltersAfterFilter(ChildItemName, FieldID.ToString())
            'grd.DataSource = dt
            'grd.DataBind()
            'UpdatePanel1.Update()
        Catch ex As Exception

        End Try
    End Sub

    Public Sub DdlFiltersAfterFilter(DocType As String, FieldID As String)
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim oda As New SqlDataAdapter("", con)
        Try
            Dim grd As GridView = CType(pnlFields.FindControl("GRD" & FieldID), GridView)
            If IsNothing(grd) Then
                Exit Sub
            End If
            'With(nolock) added by Himank on 29th sep 2015
            Dim qry = "Select * from mmm_mst_Fields  WITH(NOLOCK)  where Documenttype='" & DocType & "' and Eid=" & Session("Eid") & " and IsActive=1 and FieldType='Drop Down' and (nullif(lookupvalue,'') is not null or nullif(multilookUpVal,'') is not null or nullif(ddlmultilookUpVal,'') is not null) "
            oda.SelectCommand.CommandText = qry
            Dim dt As New DataTable()
            oda.Fill(dt)
            For i As Integer = 0 To dt.Rows.Count - 1
                For Each gr As GridViewRow In grd.Rows
                    Dim ddl As DropDownList = CType(gr.FindControl("fld" & dt.Rows(i).Item("FieldID") & "_" & gr.RowIndex), DropDownList)
                    If IsNothing(ddl) Then
                        Continue For
                    End If
                    GridDdl_TextChanged(ddl, Nothing)
                Next
            Next
        Catch ex As Exception
        End Try
    End Sub


    Public Sub DynamicGrdFilter(ByVal sender As Object, ByVal e As EventArgs)

        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim oda As New SqlDataAdapter("", con)
        Try
            Dim dtIsdv As New DataTable
            Dim strdf As String = ""
            Dim row() As DataRow = Session("ALLCHILD")
            If row.Length > 0 Then
                Dim btn1 As New Button
                For i As Integer = 0 To row.Length - 1
                    Dim PRitem() As String = row(i).Item("dropdown").ToString().Split("-")
                    'With(nolock) added by Himank on 29th sep 2015
                    strdf = "select * from mmm_mst_forms  WITH(NOLOCK)  where formname='" & PRitem(0).ToString() & "' and formsource='DETAIL FORM' and EID=" & Session("EID").ToString() & " and isnull(isinlineediting,0)=1"
                    oda.SelectCommand.CommandText = strdf    ' 
                    ViewState("ddlChange") = 1
                    oda.Fill(dtIsdv)
                    If dtIsdv.Rows.Count > 0 Then
                        insert_InlineEditing(PRitem(0).ToString, row(i).Item("FieldID").ToString())
                    End If
                    DdlFiltersAfterFilter(PRitem(0).ToString, row(i).Item("FieldID").ToString())
                Next
                oda.Dispose()
                dtIsdv.Dispose()
            End If
        Catch ex As Exception
        Finally
            con.Close()
            oda.Dispose()
        End Try

        'Try
        '    Dim childname As String() = Split(Session("BindGrdOnDdl"), "-")
        '    strdf = "select * from mmm_mst_forms where formname='" & childname(1) & "' and formsource='DETAIL FORM' and EID=" & Session("EID").ToString() & " and isnull(isinlineediting,0)=1"
        '    oda.SelectCommand.CommandText = strdf
        '    oda.Fill(dtIsdv)
        '    ViewState("ddlChange") = 1
        '    If dtIsdv.Rows.Count > 0 Then
        '        insert_InlineEditing(childname(1), childname(0))
        '    End If
        'Catch ex As Exception

        'Finally
        '    con.Dispose()
        '    oda.Dispose()
        'End Try
    End Sub


    'PRashant 30-6-2014

    Private Sub ResetGrid()

        Dim grd As GridView = DirectCast(Session("Grid"), GridView)

        If IsNothing(grd) = False Then

            For Each row As GridViewRow In grd.Rows

                If row.RowIndex < grd.Rows.Count - 1 Then

                    For i As Integer = 0 To row.Cells.Count - 1
                        For Each ctl As Control In row.Cells(i).Controls
                            If TypeOf ctl Is FileUpload Then
                                Dim fld As New FileUpload
                                fld = DirectCast(ctl, FileUpload)
                                Dim ar = fld.ID.Split("_")
                                Dim hdn As HiddenField = DirectCast(row.FindControl("hdn_" & ar(1)), HiddenField)
                                Dim lbl As Label = DirectCast(row.FindControl("lblf_" & ar(1)), Label)
                                If IsNothing(hdn) = False Then
                                    Dim str As String = hdn.Value
                                    Dim id As String = hdn.ID
                                    lbl.Text = str
                                End If
                            End If
                        Next
                    Next

                End If
            Next

        End If

        grd = Nothing
        Session("Grid") = Nothing

    End Sub





    'Prashnat_2_7 2014
    Public Sub GridDdl_TextChanged(ByVal sender As Object, ByVal e As EventArgs)
        Dim ddl As DropDownList = TryCast(sender, DropDownList)
        Dim id As String = Right(ddl.ID, ddl.ID.Length - 3)
        Dim ar() As String = id.Split("_")
        Dim id1 As Integer = CInt(ar(0))
        BindGRidLookup(ar(1), id1, ddl)
        Dim ob As New DynamicForm()
        ob.GridMultiLookup(ar(1), id1, ddl, lblTab, pnlFields)
        ob.GridLTLookup(ar(1), id1, ddl, lblTab, pnlFields)
        BindGRidLookupDDL(ar(1), id1, ddl)
    End Sub

    'Prashnat_2_7 2014
    Private Sub BindGRidLookup(rowIndex As Integer, ddlid As Integer, ByRef ddl As DropDownList)
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If
        'With(nolock) added by Himank on 29th sep 2015
        Dim oda As SqlDataAdapter = New SqlDataAdapter("select LOOKUPVALUE,dropdown,documenttype,dropdowntype from MMM_MST_FIELDS  WITH(NOLOCK)  WHERE FIELDID=" & ddlid & "", con)
        Try
            Dim DS As New DataSet
            Dim xwhr As String = ""
            Dim fldType As String = ""
            oda.Fill(DS, "data")
            Dim LOOKUPVALUE As String = DS.Tables("data").Rows(0).Item("lookupvalue").ToString()
            Dim documenttype() As String = DS.Tables("data").Rows(0).Item("dropdown").ToString.Split("-")
            If LOOKUPVALUE.Length > 0 Then
                Dim lookfld() As String = LOOKUPVALUE.ToString().Split(",")  '' get all controls to fill in lookup
                If lookfld.Length > 0 Then

                    For iLookFld As Integer = 0 To lookfld.Length - 1
                        Dim fldPair() As String = lookfld(iLookFld).Split("-")   '' get fieldid and mapping
                        If fldPair.Length > 1 Then
                            Dim GRD As GridView = TryCast(ddl.Parent.Parent.Parent.Parent, GridView)
                            Dim grdRow As GridViewRow
                            Dim control As Control = Nothing

                            If IsNothing(GRD) = False Then
                                'With(nolock) added by Himank on 29th sep 2015
                                oda = New SqlDataAdapter("SELECT * FROM MMM_MST_FIELDS  WITH(NOLOCK)  WHERE FIELDID=" & fldPair(0) & "", con)
                                Dim dt As New DataTable
                                oda.Fill(dt)
                                If IsLookupField(rowIndex, GRD.ID, "fld" & Val(fldPair(0)).ToString(), dt.Rows(0).Item("FieldType").ToString()) Then  '' check if control to be filled exists
                                    ' get fld dtl from fld master
                                    Dim STR As String = ""
                                    If fldPair(1).ToString.ToUpper = "C" Then    '' fldpair(0) = fieldid to be filled 
                                        Dim proc As String = dt.Rows(0).Item("CAL_FIELDS").ToString()
                                        If proc.Length > 1 Then
                                            Dim DROPDOWN1 As String = dt.Rows(0).Item("AUTOFILTER").ToString()
                                            Dim DDL0 As DropDownList
                                            If IsNothing(GRD) = False Then
                                                grdRow = GRD.Rows(rowIndex)
                                                Dim ctrlId As String = "fld" & DROPDOWN1
                                                For i As Integer = 0 To grdRow.Cells.Count - 1
                                                    control = grdRow.Cells(i).FindControl(ctrlId & "_" & rowIndex)
                                                    If IsNothing(control) = True Then
                                                        DDL0 = CType(control, DropDownList)
                                                    End If
                                                Next
                                            End If

                                            ' = TryCast(pnlFields.FindControl("fld" & DROPDOWN1), DropDownList)
                                            If DDL0.SelectedItem.Text.ToUpper <> "SELECT" Then
                                                oda.SelectCommand.CommandType = CommandType.StoredProcedure
                                                oda.SelectCommand.Parameters.Clear()
                                                oda.SelectCommand.CommandText = proc
                                                oda.SelectCommand.Parameters.AddWithValue("DOCID", DDL0.SelectedValue)
                                                oda.SelectCommand.Parameters.AddWithValue("FIELDID", CInt(DROPDOWN1))
                                                oda.SelectCommand.Parameters.AddWithValue("VALUE", ddl.SelectedValue)
                                                Dim dss As New DataTable
                                                oda.Fill(dss)
                                                Dim ddl1 As DropDownList '= TryCast(pnlFields.FindControl("fld" & fldPair(0).ToString()), DropDownList)
                                                If IsNothing(GRD) = False Then
                                                    grdRow = GRD.Rows(rowIndex)
                                                    Dim ctrlId As String = "fld" & Val(fldPair(0)).ToString()
                                                    For i As Integer = 0 To grdRow.Cells.Count - 1
                                                        control = grdRow.Cells(i).FindControl(ctrlId & "_" & rowIndex)
                                                        If IsNothing(control) = True Then
                                                            ddl1 = CType(control, DropDownList)
                                                        End If

                                                    Next
                                                End If
                                                If IsNothing(ddl1) = False Then
                                                    ddl1.Items.Clear()
                                                    ddl1.Items.Add("SELECT")
                                                    ddl1.Items(0).Value = "0"
                                                    For i As Integer = 0 To dss.Rows.Count - 1
                                                        ddl1.Items.Add(dss.Rows(i).Item(0).ToString())
                                                        ddl1.Items(i + 1).Value = dss.Rows(i).Item("tID")
                                                    Next
                                                End If

                                            End If
                                        End If
                                    ElseIf fldPair(1).ToString.ToUpper = "R" Then
                                        Dim TAB1 As String = ""
                                        Dim TAB2 As String = ""
                                        Dim STID As String = ""
                                        Dim TID As String = ""
                                        If documenttype(0).ToString.ToUpper = "MASTER" Then
                                            TAB2 = "MMM_MST_MASTER"
                                            TID = "TID"
                                        ElseIf documenttype(0).ToString.ToUpper = "DOCUMENT" Then
                                            TAB2 = "MMM_MST_DOC"
                                            TID = "TID"
                                        ElseIf documenttype(1).ToString.ToUpper = "USER" Then
                                            TAB2 = "MMM_MST_USER"
                                            TID = "UID"
                                        End If
                                        Dim DOCTYPE() As String = dt.Rows(0).Item("DROPDOWN").ToString.Split("-")
                                        If DOCTYPE(0).ToString.ToUpper = "MASTER" Then
                                            TAB1 = "MMM_MST_MASTER"
                                            STID = "TID"
                                        ElseIf DOCTYPE(0).ToString.ToUpper = "DOCUMENT" Then
                                            TAB1 = "MMM_MST_DOC"
                                            STID = "TID"
                                        ElseIf DOCTYPE(1).ToString.ToUpper = "USER" Then
                                            TAB1 = "MMM_MST_USER"
                                            STID = "UID"
                                        End If
                                        Dim DROPDOWN1 As String = dt.Rows(0).Item("AUTOFILTER").ToString()
                                        ''Dim DDL0 As DropDownList = TryCast(pnlFields.FindControl("fld" & DROPDOWN1), DropDownList)
                                        oda.SelectCommand.CommandType = CommandType.StoredProcedure
                                        oda.SelectCommand.Parameters.Clear()
                                        oda.SelectCommand.CommandText = "USP_GETMANNUALFILTER"
                                        oda.SelectCommand.Parameters.AddWithValue("@EID", HttpContext.Current.Session("EID"))
                                        oda.SelectCommand.Parameters.AddWithValue("@TAB1", TAB1)
                                        oda.SelectCommand.Parameters.AddWithValue("@TAB2", TAB2)
                                        oda.SelectCommand.Parameters.AddWithValue("@DOCUMENTTYPE", DOCTYPE(1).ToString)
                                        oda.SelectCommand.Parameters.AddWithValue("@FLDMAPPING", DOCTYPE(2).ToString)
                                        oda.SelectCommand.Parameters.AddWithValue("@AUTOFILTER", dt.Rows(0).Item("AUTOFILTER").ToString())
                                        oda.SelectCommand.Parameters.AddWithValue("@TID", TID)
                                        oda.SelectCommand.Parameters.AddWithValue("@STID", STID)
                                        oda.SelectCommand.Parameters.AddWithValue("@VAL", ddl.SelectedValue)
                                        Dim dss As New DataTable
                                        oda.Fill(dss)
                                        Dim ddl1 As DropDownList
                                        If IsNothing(GRD) = False Then
                                            grdRow = GRD.Rows(rowIndex)
                                            Dim ctrlId As String = "fld" & Val(fldPair(0)).ToString()
                                            For i As Integer = 0 To grdRow.Cells.Count - 1
                                                control = grdRow.Cells(i).FindControl(ctrlId & "_" & rowIndex)
                                                If IsNothing(control) = True Then
                                                    ddl1 = CType(control, DropDownList)
                                                End If

                                            Next
                                        End If
                                        If IsNothing(ddl1) = False Then
                                            ddl1.Items.Clear()
                                            ddl1.Items.Add("SELECT")
                                            ddl1.Items(0).Value = "0"
                                            For i As Integer = 0 To dss.Rows.Count - 1
                                                ddl1.Items.Add(dss.Rows(i).Item(0).ToString())
                                                ddl1.Items(i + 1).Value = dss.Rows(i).Item("tID")
                                            Next
                                        End If


                                    Else

                                        Dim DROPDOWN As String() = dt.Rows(0).Item("DROPDOWN").ToString.Split("-")  ' this contains to be filled values 
                                        Dim TABLENAME As String = ""
                                        Dim TID As String = "TID"
                                        If UCase(DROPDOWN(0).ToString()) = "MASTER" Then
                                            TABLENAME = "MMM_MST_MASTER"
                                        ElseIf UCase(DROPDOWN(0).ToString()) = "DOCUMENT" Then
                                            TABLENAME = "MMM_MST_DOC"
                                        ElseIf UCase(DROPDOWN(0).ToString()) = "CHILD" Then
                                            TABLENAME = "MMM_MST_DOC_ITEM"
                                        ElseIf UCase(DROPDOWN(0).ToString()) = "STATIC" Then
                                            If UCase(DROPDOWN(1).ToString()) = "USER" Then
                                                TABLENAME = "MMM_MST_USER"
                                                TID = "UID"
                                            ElseIf UCase(DROPDOWN(1).ToString()) = "LOCATION" Then
                                                TABLENAME = "MMM_MST_LOCATION"
                                                If DROPDOWN(2).ToString.ToUpper = "LOCATIONSTATE" Then
                                                    TID = "SID"
                                                Else
                                                    TID = "LOCID"
                                                End If
                                            Else
                                                TABLENAME = dt.Rows(0).Item("DBTABLENAME").ToString
                                            End If
                                        ElseIf UCase(DROPDOWN(0).ToString()) = "SESSION" Then
                                            TABLENAME = "MMM_MST_USER"
                                            TID = "UID"
                                        End If
                                        Dim SLVALUE As String() = ddl.SelectedValue.Split("|")
                                        If dt.Rows(0).Item("fieldtype").ToString.ToUpper() = "AUTOCOMPLETE" Then

                                            If IsLookupField(rowIndex, GRD.ID, "fld" & Val(fldPair(0)).ToString(), dt.Rows(0).Item("FieldType").ToString()) Then


                                                Dim txtBox As TextBox
                                                grdRow = GRD.Rows(rowIndex)
                                                For i As Integer = 0 To grdRow.Cells.Count - 1
                                                    control = grdRow.Cells(i).FindControl("fld" & Val(fldPair(0)).ToString())
                                                    If IsNothing(control) = True Then
                                                        txtBox = CType(control, TextBox)
                                                        txtBox.Text = String.Empty
                                                    End If

                                                Next


                                            End If

                                        ElseIf dt.Rows(0).Item("fieldtype").ToString.ToUpper() = "DROP DOWN" Then
                                            Dim ob As New DynamicForm
                                            Dim AUTOFILTER As String = dt.Rows(0).Item("AUTOFILTER").ToString()
                                            Dim tids As String = ""

                                            ''Filter Data according to Userid
                                            tids = ob.UserDataFilter(DS.Tables("data").Rows(0).Item("documenttype").ToString(), DROPDOWN(1).ToString())
                                            If tids.Length > 2 Then
                                                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
                                            Else
                                                xwhr = ""
                                            End If

                                            Dim ChildDoctype As String = ""

                                            If DS.Tables("data").Rows(0).Item("dropdowntype") = "CHILD VALUED" Then
                                                Dim ChildMid() As String = documenttype(1).ToString.Split(":")
                                                ChildDoctype = ChildMid(1).ToString
                                            End If

                                            oda.SelectCommand.CommandType = CommandType.StoredProcedure
                                            oda.SelectCommand.CommandText = "USP_BINDDDL"
                                            oda.SelectCommand.Parameters.Clear()
                                            oda.SelectCommand.Parameters.AddWithValue("@EID", HttpContext.Current.Session("EID"))
                                            oda.SelectCommand.Parameters.AddWithValue("@TableName", TABLENAME)
                                            oda.SelectCommand.Parameters.AddWithValue("@Val", SLVALUE(0))
                                            oda.SelectCommand.Parameters.AddWithValue("@xwhr", xwhr)
                                            oda.SelectCommand.Parameters.AddWithValue("@tid", TID)
                                            If ChildDoctype.Length > 0 Then
                                                oda.SelectCommand.Parameters.AddWithValue("@documenttype", ChildDoctype)
                                            Else
                                                oda.SelectCommand.Parameters.AddWithValue("@documenttype", DROPDOWN(1))
                                            End If
                                            oda.SelectCommand.Parameters.AddWithValue("@fldmapping", DROPDOWN(2))
                                            oda.SelectCommand.Parameters.AddWithValue("@autofilter", AUTOFILTER)
                                            'oda.SelectCommand.CommandText = STR & " AND isAuth=1 " & xwhr & " Order by " & DROPDOWN(2).ToString()
                                            Dim dtFinal As New DataTable
                                            oda.Fill(dtFinal)
                                            Dim ddlo As DropDownList

                                            If IsNothing(GRD) = False Then
                                                grdRow = GRD.Rows(rowIndex)
                                                Dim ctrlId As String = "fld" & Val(fldPair(0)).ToString()
                                                'For i As Integer = 0 To grdRow.Cells.Count - 1
                                                control = grdRow.FindControl(ctrlId & "_" & rowIndex)
                                                'control = grdRow.Cells(i).FindControl(ctrlId & "_" & rowIndex)
                                                If IsNothing(control) = False Then
                                                    ddlo = CType(control, DropDownList)
                                                End If

                                                ' Next
                                            End If
                                            If IsNothing(ddlo) = False Then
                                                ddlo.Items.Clear()
                                                ddlo.Items.Add("SELECT")
                                                ddlo.Items(0).Value = "0"
                                                For i As Integer = 0 To dtFinal.Rows.Count - 1
                                                    ddlo.Items.Add(dtFinal.Rows(i).Item(0).ToString())
                                                    ddlo.Items(i + 1).Value = dtFinal.Rows(i).Item("tID")
                                                Next
                                            End If

                                        Else
                                            Dim TID1 As String() = ddl.SelectedValue.ToString.Split("|")
                                            Dim SELTID As String = ""
                                            If TID1.Length > 1 Then
                                                SELTID = TID1(1).ToString
                                            Else
                                                SELTID = TID1(0).ToString
                                            End If
                                            Dim value As String = ""
                                            Dim ChildDoctype As String = ""
                                            If DS.Tables("data").Rows(0).Item("dropdowntype") = "CHILD VALUED" Then
                                                Dim ChildMid() As String = documenttype(1).ToString.Split(":")
                                                ChildDoctype = ChildMid(1).ToString
                                            End If

                                            If SELTID.ToString <> "0" And SELTID.ToString <> "" Then
                                                oda = New SqlDataAdapter("", con)
                                                oda.SelectCommand.CommandType = CommandType.StoredProcedure
                                                oda.SelectCommand.Parameters.Clear()
                                                oda.SelectCommand.CommandText = "uspGetMasterValue"
                                                oda.SelectCommand.Parameters.AddWithValue("EID", HttpContext.Current.Session("EID"))
                                                If ChildDoctype.Length > 0 Then
                                                    oda.SelectCommand.Parameters.AddWithValue("documentType", ChildDoctype)
                                                Else
                                                    oda.SelectCommand.Parameters.AddWithValue("documentType", documenttype(1))
                                                End If
                                                oda.SelectCommand.Parameters.AddWithValue("Type", documenttype(0))
                                                oda.SelectCommand.Parameters.AddWithValue("TID", SELTID)
                                                oda.SelectCommand.Parameters.AddWithValue("FLDMAPPING", fldPair(1))
                                                If con.State <> ConnectionState.Open Then
                                                    con.Open()
                                                End If
                                                value = oda.SelectCommand.ExecuteScalar().ToString()
                                            End If

                                            If IsLookupField(rowIndex, GRD.ID, "fld" & Val(fldPair(0)).ToString(), dt.Rows(0).Item("FieldType").ToString()) Then

                                                Dim txtBox As TextBox
                                                grdRow = GRD.Rows(rowIndex)
                                                For i As Integer = 0 To grdRow.Cells.Count - 1
                                                    control = grdRow.FindControl("fld" & Val(fldPair(0) & rowIndex).ToString())
                                                    If IsNothing(control) = False Then
                                                        txtBox = CType(control, TextBox)
                                                        txtBox.Text = value
                                                    End If

                                                Next


                                            End If

                                        End If


                                    End If
                                End If
                            End If
                        End If
                    Next
                End If
            End If


        Catch ex As Exception
        Finally
            If Not con Is Nothing Then
                con.Dispose()
            End If
            If Not oda Is Nothing Then
                oda.Dispose()
            End If
        End Try


    End Sub

    Private Sub BindGRidLookupDDL(rowIndex As Integer, ddlid As Integer, ByRef ddl As DropDownList)
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If
        'With(nolock) added by Himank on 29th sep 2015
        Dim oda As SqlDataAdapter = New SqlDataAdapter("select DDLLOOKUPVALUE,dropdown,documenttype,dropdowntype from MMM_MST_FIELDS  WITH(NOLOCK)  WHERE FIELDID=" & ddlid & "", con)
        Try
            Dim DS As New DataSet
            Dim xwhr As String = ""
            Dim fldType As String = ""
            oda.Fill(DS, "data")
            Dim LOOKUPVALUE As String = DS.Tables("data").Rows(0).Item("DDLlookupvalue").ToString()
            Dim documenttype() As String = DS.Tables("data").Rows(0).Item("dropdown").ToString.Split("-")
            If LOOKUPVALUE.Length > 0 Then
                Dim lookfld() As String = LOOKUPVALUE.ToString().Split(",")  '' get all controls to fill in lookup
                If lookfld.Length > 0 Then

                    For iLookFld As Integer = 0 To lookfld.Length - 1
                        Dim fldPair() As String = lookfld(iLookFld).Split("-")   '' get fieldid and mapping
                        If fldPair.Length > 1 Then
                            Dim GRD As GridView = TryCast(ddl.Parent.Parent.Parent.Parent, GridView)
                            Dim grdRow As GridViewRow
                            Dim control As Control = Nothing

                            If IsNothing(GRD) = False Then
                                oda = New SqlDataAdapter("SELECT * FROM MMM_MST_FIELDS WHERE FIELDID=" & fldPair(0) & "", con)
                                Dim dt As New DataTable
                                oda.Fill(dt)
                                If IsLookupDDLField(rowIndex, GRD.ID, "fld" & Val(fldPair(0)).ToString(), dt.Rows(0).Item("FieldType").ToString()) Then  '' check if control to be filled exists
                                    ' get fld dtl from fld master
                                    Dim STR As String = ""
                                    If fldPair(1).ToString.ToUpper = "C" Then    '' fldpair(0) = fieldid to be filled 
                                        Dim proc As String = dt.Rows(0).Item("CAL_FIELDS").ToString()
                                        If proc.Length > 1 Then
                                            Dim DROPDOWN1 As String = dt.Rows(0).Item("AUTOFILTER").ToString()
                                            Dim DDL0 As DropDownList
                                            If IsNothing(GRD) = False Then
                                                grdRow = GRD.Rows(rowIndex)
                                                Dim ctrlId As String = "fld" & DROPDOWN1
                                                For i As Integer = 0 To grdRow.Cells.Count - 1
                                                    control = grdRow.Cells(i).FindControl(ctrlId & "_" & rowIndex)
                                                    If IsNothing(control) = True Then
                                                        DDL0 = CType(control, DropDownList)
                                                    End If
                                                Next
                                            End If

                                            ' = TryCast(pnlFields.FindControl("fld" & DROPDOWN1), DropDownList)
                                            If DDL0.SelectedItem.Text.ToUpper <> "SELECT" Then
                                                oda.SelectCommand.CommandType = CommandType.StoredProcedure
                                                oda.SelectCommand.Parameters.Clear()
                                                oda.SelectCommand.CommandText = proc
                                                oda.SelectCommand.Parameters.AddWithValue("DOCID", DDL0.SelectedValue)
                                                oda.SelectCommand.Parameters.AddWithValue("FIELDID", CInt(DROPDOWN1))
                                                oda.SelectCommand.Parameters.AddWithValue("VALUE", ddl.SelectedValue)
                                                Dim dss As New DataTable
                                                oda.Fill(dss)
                                                Dim ddl1 As DropDownList '= TryCast(pnlFields.FindControl("fld" & fldPair(0).ToString()), DropDownList)
                                                If IsNothing(GRD) = False Then
                                                    grdRow = GRD.Rows(rowIndex)
                                                    Dim ctrlId As String = "fld" & Val(fldPair(0)).ToString()
                                                    For i As Integer = 0 To grdRow.Cells.Count - 1
                                                        control = grdRow.Cells(i).FindControl(ctrlId & "_" & rowIndex)
                                                        If IsNothing(control) = True Then
                                                            ddl1 = CType(control, DropDownList)
                                                        End If

                                                    Next
                                                End If
                                                If IsNothing(ddl1) = False Then
                                                    ddl1.Items.Clear()
                                                    ddl1.Items.Add("SELECT")
                                                    ddl1.Items(0).Value = "0"
                                                    For i As Integer = 0 To dss.Rows.Count - 1
                                                        ddl1.Items.Add(dss.Rows(i).Item(0).ToString())
                                                        ddl1.Items(i + 1).Value = dss.Rows(i).Item("tID")
                                                    Next
                                                End If

                                            End If
                                        End If
                                    ElseIf fldPair(1).ToString.ToUpper = "R" Then
                                        Dim TAB1 As String = ""
                                        Dim TAB2 As String = ""
                                        Dim STID As String = ""
                                        Dim TID As String = ""
                                        If documenttype(0).ToString.ToUpper = "MASTER" Then
                                            TAB2 = "MMM_MST_MASTER"
                                            TID = "TID"
                                        ElseIf documenttype(0).ToString.ToUpper = "DOCUMENT" Then
                                            TAB2 = "MMM_MST_DOC"
                                            TID = "TID"
                                        ElseIf documenttype(1).ToString.ToUpper = "USER" Then
                                            TAB2 = "MMM_MST_USER"
                                            TID = "UID"
                                        End If
                                        Dim DOCTYPE() As String = dt.Rows(0).Item("DROPDOWN").ToString.Split("-")
                                        If DOCTYPE(0).ToString.ToUpper = "MASTER" Then
                                            TAB1 = "MMM_MST_MASTER"
                                            STID = "TID"
                                        ElseIf DOCTYPE(0).ToString.ToUpper = "DOCUMENT" Then
                                            TAB1 = "MMM_MST_DOC"
                                            STID = "TID"
                                        ElseIf DOCTYPE(1).ToString.ToUpper = "USER" Then
                                            TAB1 = "MMM_MST_USER"
                                            STID = "UID"
                                        End If
                                        Dim DROPDOWN1 As String = dt.Rows(0).Item("AUTOFILTER").ToString()
                                        ''Dim DDL0 As DropDownList = TryCast(pnlFields.FindControl("fld" & DROPDOWN1), DropDownList)
                                        oda.SelectCommand.CommandType = CommandType.StoredProcedure
                                        oda.SelectCommand.Parameters.Clear()
                                        oda.SelectCommand.CommandText = "USP_GETMANNUALFILTER"
                                        oda.SelectCommand.Parameters.AddWithValue("@EID", HttpContext.Current.Session("EID"))
                                        oda.SelectCommand.Parameters.AddWithValue("@TAB1", TAB1)
                                        oda.SelectCommand.Parameters.AddWithValue("@TAB2", TAB2)
                                        oda.SelectCommand.Parameters.AddWithValue("@DOCUMENTTYPE", DOCTYPE(1).ToString)
                                        oda.SelectCommand.Parameters.AddWithValue("@FLDMAPPING", DOCTYPE(2).ToString)
                                        oda.SelectCommand.Parameters.AddWithValue("@AUTOFILTER", dt.Rows(0).Item("AUTOFILTER").ToString())
                                        oda.SelectCommand.Parameters.AddWithValue("@TID", TID)
                                        oda.SelectCommand.Parameters.AddWithValue("@STID", STID)
                                        oda.SelectCommand.Parameters.AddWithValue("@VAL", ddl.SelectedValue)
                                        Dim dss As New DataTable
                                        oda.Fill(dss)
                                        Dim ddl1 As DropDownList
                                        If IsNothing(GRD) = False Then
                                            grdRow = GRD.Rows(rowIndex)
                                            Dim ctrlId As String = "fld" & Val(fldPair(0)).ToString()
                                            For i As Integer = 0 To grdRow.Cells.Count - 1
                                                control = grdRow.Cells(i).FindControl(ctrlId & "_" & rowIndex)
                                                If IsNothing(control) = True Then
                                                    ddl1 = CType(control, DropDownList)
                                                End If

                                            Next
                                        End If
                                        If IsNothing(ddl1) = False Then
                                            ddl1.Items.Clear()
                                            ddl1.Items.Add("SELECT")
                                            ddl1.Items(0).Value = "0"
                                            For i As Integer = 0 To dss.Rows.Count - 1
                                                ddl1.Items.Add(dss.Rows(i).Item(0).ToString())
                                                ddl1.Items(i + 1).Value = dss.Rows(i).Item("tID")
                                            Next
                                        End If


                                    Else

                                        Dim DROPDOWN As String() = dt.Rows(0).Item("DROPDOWN").ToString.Split("-")  ' this contains to be filled values 
                                        Dim TABLENAME As String = ""
                                        Dim TID As String = "TID"
                                        If UCase(DROPDOWN(0).ToString()) = "MASTER" Then
                                            TABLENAME = "MMM_MST_MASTER"
                                        ElseIf UCase(DROPDOWN(0).ToString()) = "DOCUMENT" Then
                                            TABLENAME = "MMM_MST_DOC"
                                        ElseIf UCase(DROPDOWN(0).ToString()) = "CHILD" Then
                                            TABLENAME = "MMM_MST_DOC_ITEM"
                                        ElseIf UCase(DROPDOWN(0).ToString()) = "STATIC" Then
                                            If UCase(DROPDOWN(1).ToString()) = "USER" Then
                                                TABLENAME = "MMM_MST_USER"
                                                TID = "UID"
                                            ElseIf UCase(DROPDOWN(1).ToString()) = "LOCATION" Then
                                                TABLENAME = "MMM_MST_LOCATION"
                                                If DROPDOWN(2).ToString.ToUpper = "LOCATIONSTATE" Then
                                                    TID = "SID"
                                                Else
                                                    TID = "LOCID"
                                                End If
                                            Else
                                                TABLENAME = dt.Rows(0).Item("DBTABLENAME").ToString
                                            End If
                                        ElseIf UCase(DROPDOWN(0).ToString()) = "SESSION" Then
                                            TABLENAME = "MMM_MST_USER"
                                            TID = "UID"
                                        End If
                                        Dim SLVALUE As String() = ddl.SelectedValue.Split("|")
                                        If dt.Rows(0).Item("fieldtype").ToString.ToUpper() = "AUTOCOMPLETE" Then

                                            If IsLookupDDLField(rowIndex, GRD.ID, "fld" & Val(fldPair(0)).ToString(), dt.Rows(0).Item("FieldType").ToString()) Then


                                                Dim txtBox As TextBox
                                                grdRow = GRD.Rows(rowIndex)
                                                For i As Integer = 0 To grdRow.Cells.Count - 1
                                                    control = grdRow.Cells(i).FindControl("fld" & Val(fldPair(0)).ToString())
                                                    If IsNothing(control) = True Then
                                                        txtBox = CType(control, TextBox)
                                                        txtBox.Text = String.Empty
                                                    End If

                                                Next


                                            End If

                                        ElseIf dt.Rows(0).Item("fieldtype").ToString.ToUpper() = "DROP DOWN" Then
                                            Dim ob As New DynamicForm
                                            Dim AUTOFILTER As String = dt.Rows(0).Item("AUTOFILTER").ToString()
                                            Dim tids As String = ""

                                            ''Filter Data according to Userid
                                            tids = ob.UserDataFilter(DS.Tables("data").Rows(0).Item("documenttype").ToString(), DROPDOWN(1).ToString())
                                            If tids.Length > 2 Then
                                                xwhr = " AND CONVERT(NVARCHAR(10),TID) IN (" & tids & ")"
                                            Else
                                                xwhr = ""
                                            End If

                                            Dim ChildDoctype As String = ""

                                            If DS.Tables("data").Rows(0).Item("dropdowntype") = "CHILD VALUED" Then
                                                Dim ChildMid() As String = documenttype(1).ToString.Split(":")
                                                ChildDoctype = ChildMid(1).ToString
                                            End If

                                            oda.SelectCommand.CommandType = CommandType.StoredProcedure
                                            oda.SelectCommand.CommandText = "USP_BINDDDL"
                                            oda.SelectCommand.Parameters.Clear()
                                            oda.SelectCommand.Parameters.AddWithValue("@EID", HttpContext.Current.Session("EID"))
                                            oda.SelectCommand.Parameters.AddWithValue("@TableName", TABLENAME)
                                            oda.SelectCommand.Parameters.AddWithValue("@Val", SLVALUE(0))
                                            oda.SelectCommand.Parameters.AddWithValue("@xwhr", xwhr)
                                            oda.SelectCommand.Parameters.AddWithValue("@tid", TID)
                                            If ChildDoctype.Length > 0 Then
                                                oda.SelectCommand.Parameters.AddWithValue("@documenttype", ChildDoctype)
                                            Else
                                                oda.SelectCommand.Parameters.AddWithValue("@documenttype", DROPDOWN(1))
                                            End If
                                            oda.SelectCommand.Parameters.AddWithValue("@fldmapping", DROPDOWN(2))
                                            oda.SelectCommand.Parameters.AddWithValue("@autofilter", AUTOFILTER)
                                            'oda.SelectCommand.CommandText = STR & " AND isAuth=1 " & xwhr & " Order by " & DROPDOWN(2).ToString()
                                            Dim dtFinal As New DataTable
                                            oda.Fill(dtFinal)
                                            Dim ddlo As DropDownList

                                            If IsNothing(GRD) = False Then
                                                grdRow = GRD.Rows(rowIndex)
                                                Dim ctrlId As String = "fld" & Val(fldPair(0)).ToString()
                                                'For i As Integer = 0 To grdRow.Cells.Count - 1
                                                control = grdRow.FindControl(ctrlId & "_" & rowIndex)
                                                'control = grdRow.Cells(i).FindControl(ctrlId & "_" & rowIndex)
                                                If IsNothing(control) = False Then
                                                    ddlo = CType(control, DropDownList)
                                                End If

                                                ' Next
                                            End If
                                            If IsNothing(ddlo) = False Then
                                                ddlo.Items.Clear()
                                                ddlo.Items.Add("SELECT")
                                                ddlo.Items(0).Value = "0"
                                                For i As Integer = 0 To dtFinal.Rows.Count - 1
                                                    ddlo.Items.Add(dtFinal.Rows(i).Item(0).ToString())
                                                    ddlo.Items(i + 1).Value = dtFinal.Rows(i).Item("tID")
                                                Next
                                            End If

                                        Else
                                            Dim TID1 As String() = ddl.SelectedValue.ToString.Split("|")
                                            Dim SELTID As String = ""
                                            If TID1.Length > 1 Then
                                                SELTID = TID1(1).ToString
                                            Else
                                                SELTID = TID1(0).ToString
                                            End If
                                            Dim value As String = ""
                                            Dim ChildDoctype As String = ""
                                            If DS.Tables("data").Rows(0).Item("dropdowntype") = "CHILD VALUED" Then
                                                Dim ChildMid() As String = documenttype(1).ToString.Split(":")
                                                ChildDoctype = ChildMid(1).ToString
                                            End If

                                            If SELTID.ToString <> "0" And SELTID.ToString <> "" Then
                                                oda = New SqlDataAdapter("", con)
                                                oda.SelectCommand.CommandType = CommandType.StoredProcedure
                                                oda.SelectCommand.Parameters.Clear()
                                                oda.SelectCommand.CommandText = "uspGetMasterValue"
                                                oda.SelectCommand.Parameters.AddWithValue("EID", HttpContext.Current.Session("EID"))
                                                If ChildDoctype.Length > 0 Then
                                                    oda.SelectCommand.Parameters.AddWithValue("documentType", ChildDoctype)
                                                Else
                                                    oda.SelectCommand.Parameters.AddWithValue("documentType", documenttype(1))
                                                End If
                                                oda.SelectCommand.Parameters.AddWithValue("Type", documenttype(0))
                                                oda.SelectCommand.Parameters.AddWithValue("TID", SELTID)
                                                oda.SelectCommand.Parameters.AddWithValue("FLDMAPPING", fldPair(1))
                                                If con.State <> ConnectionState.Open Then
                                                    con.Open()
                                                End If
                                                value = oda.SelectCommand.ExecuteScalar().ToString()
                                            End If

                                            If IsLookupDDLField(rowIndex, GRD.ID, "fld" & Val(fldPair(0)).ToString(), dt.Rows(0).Item("FieldType").ToString()) Then

                                                Dim txtBox As DropDownList
                                                grdRow = GRD.Rows(rowIndex)
                                                For i As Integer = 0 To grdRow.Cells.Count - 1
                                                    control = grdRow.FindControl("fld" & Val(fldPair(0)) & "_" & rowIndex.ToString())

                                                    If IsNothing(control) = False Then
                                                        txtBox = CType(control, DropDownList)
                                                        txtBox.SelectedIndex = txtBox.Items.IndexOf(txtBox.Items.FindByText(value))
                                                        ' txtBox.Text = value
                                                    End If
                                                Next
                                            End If

                                        End If


                                    End If
                                End If
                            End If
                        End If
                    Next
                End If
            End If


        Catch ex As Exception
        Finally
            If Not con Is Nothing Then
                con.Dispose()
            End If
            If Not oda Is Nothing Then
                oda.Dispose()
            End If
        End Try


    End Sub

    Private Function IsLookupDDLField(rowIndex As Integer, grdId As String, ctrlId As String, fldType As String) As Boolean
        Try
            Dim GRD As GridView = TryCast(pnlFields.FindControl(grdId), GridView)
            Dim grdRow As GridViewRow
            Dim control As Control = Nothing

            If IsNothing(GRD) = False Then
                grdRow = GRD.Rows(rowIndex)
                If fldType.ToUpper = "LOOKUPDDL" Then
                    control = grdRow.FindControl(ctrlId & "_" & rowIndex)
                Else
                    control = grdRow.FindControl(ctrlId & rowIndex)
                End If

            End If
            If IsNothing(control) = False Then
                Return True
            Else
                Return False
            End If
        Catch ex As Exception
            Return False
        End Try

    End Function

    'Prashnat_2_7 2014
    Private Function IsLookupField(rowIndex As Integer, grdId As String, ctrlId As String, fldType As String) As Boolean
        Try
            Dim GRD As GridView = TryCast(pnlFields.FindControl(grdId), GridView)
            Dim grdRow As GridViewRow
            Dim control As Control = Nothing

            If IsNothing(GRD) = False Then
                grdRow = GRD.Rows(rowIndex)
                If fldType = "Drop Down" Then
                    control = grdRow.FindControl(ctrlId & "_" & rowIndex)
                Else
                    control = grdRow.FindControl(ctrlId & rowIndex)
                End If

            End If
            If IsNothing(control) = False Then
                Return True
            Else
                Return False
            End If
        Catch ex As Exception
            Return False
        End Try

    End Function

    'Prashnat_2_7 2014
    Private Function FillLookupField(rowIndex As Integer, grdId As String, ctrlId As String) As Boolean
        Try
            Dim GRD As GridView = TryCast(pnlFields.FindControl(grdId), GridView)
            Dim grdRow As GridViewRow
            Dim control As Control = Nothing

            If IsNothing(GRD) = False Then
                grdRow = GRD.Rows(rowIndex)
                For i As Integer = 0 To grdRow.Cells.Count - 1
                    control = grdRow.Cells(i).FindControl(ctrlId)
                    If IsNothing(control) = True Then
                        Return False
                    End If
                    Return True
                Next
            End If
            Return False
        Catch ex As Exception
            Return False
        End Try

    End Function

    'Prashant_11_7
    Protected Sub CalculateFromGrid(sender As Object, e As EventArgs)
        ResetGrid()
        Dim btn As Button = DirectCast(sender, Button)
        Dim ar() = btn.ID.Split("_")
        Dim scrname As String = Request.QueryString("SC").ToString()
        scrname = scrname.Replace("+", " ")
        CalculateGRid(scrname, Convert.ToInt32(ar(1)))
    End Sub

    'Protected Sub CalculateGRid(Documenttype As String, fldId As Integer)
    '    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '    Dim con As SqlConnection = New SqlConnection(conStr)

    '    Dim Max As Integer = 0
    '    Dim Total As Integer = 0

    '    Dim tab As String


    '    If con.State <> ConnectionState.Open Then
    '        con.Open()
    '    End If

    '    Dim da As SqlDataAdapter = New SqlDataAdapter("SELECT  Dropdown from MMM_MST_FIELDS where fieldID=" & fldId, con)
    '    Dim dsp As New DataSet
    '    da.Fill(dsp, "fields")
    '    tab = dsp.Tables(0).Rows(0).Item("Dropdown").ToString()


    '    Dim GV As GridView = CType(pnlFields.FindControl("GRD" & fldId.ToString()), GridView)
    '    Dim conStr1 As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '    Dim con1 As SqlConnection = New SqlConnection(conStr1)
    '    Dim query As String = "Select F1.FieldID,F1.displayName,f1.fieldtype,F1.IsTotal,F1.DocumentType,f2.dropdown,F1.InLineEditing  from MMM_MST_FIELDS f1 join MMM_MST_FIELDS f2 on F1.DOCUMENTTYPE =F2.dropdown where F1.DocumentType ='" & tab & "' and f2.DocumentType ='" & Documenttype & "' and f1.EID=" & Session("EID") & " And f1.IsActive=1  and f2.IsActive=1"
    '    Dim ODA As SqlDataAdapter = New SqlDataAdapter(query, con1)
    '    Dim dtFields As New DataTable
    '    ODA.Fill(dtFields)

    '    Dim ds1 As DataTable = GV.DataSource
    '    If Not ds1 Is Nothing Then
    '        'Dim dr2 As DataRow = ds1.NewRow()
    '        If ds1.Rows.Count > 0 Then

    '            For i As Integer = 0 To ds1.Columns.Count - 1

    '                For j As Integer = 0 To dtFields.Rows.Count - 1

    '                    If dtFields.Rows(j).Item("displayName").ToString = ds1.Columns(i).ColumnName And Convert.ToInt32(dtFields.Rows(j).Item("IsTotal")) = 1 Then
    '                        Dim sum As Double = 0
    '                        For Each gr As GridViewRow In GV.Rows
    '                            If gr.RowIndex < GV.Rows.Count - 1 Then

    '                                If dtFields.Rows(j).Item("InLineEditing").ToString() = "1" Then
    '                                    Dim txt1 As TextBox = CType(gr.FindControl("fld" & dtFields.Rows(j).Item("FieldID").ToString() & gr.RowIndex.ToString), TextBox)
    '                                    If Not txt1 Is Nothing Then
    '                                        If Not String.IsNullOrEmpty(txt1.Text.Trim) And Not txt1.Text.Trim.ToUpper = "NAN" Then 'NaN
    '                                            sum += Convert.ToDouble(txt1.Text)
    '                                        End If
    '                                    End If
    '                                Else
    '                                    If Not String.IsNullOrEmpty(gr.Cells(i).Text.Trim) And Not gr.Cells(i).Text.Trim.ToUpper = "NAN" Then
    '                                        sum += Convert.ToDouble(gr.Cells(i).Text)
    '                                    End If
    '                                End If
    '                            End If

    '                        Next
    '                        'dr2(i) = sum
    '                        GV.Rows(GV.Rows.Count - 1).Cells(i).Text = sum
    '                    End If
    '                Next
    '            Next
    '        End If

    '    Else
    '        If GV.Rows.Count > 0 Then
    '            For i As Integer = 0 To GV.HeaderRow.Cells.Count - 1
    '                For j As Integer = 0 To GV.Rows.Count - 1

    '                    If dtFields.Rows(j).Item("displayName").ToString = GV.HeaderRow.Cells(i).Text And Convert.ToInt32(dtFields.Rows(j).Item("IsTotal")) = 1 Then
    '                        Dim sum As Double = 0
    '                        For Each gr As GridViewRow In GV.Rows
    '                            If gr.RowIndex < GV.Rows.Count - 1 Then

    '                                If dtFields.Rows(j).Item("InLineEditing").ToString() = "1" Then
    '                                    Dim txt1 As TextBox = CType(gr.FindControl("fld" & dtFields.Rows(j).Item("FieldID").ToString() & gr.RowIndex.ToString), TextBox)
    '                                    If Not txt1 Is Nothing Then
    '                                        If Not String.IsNullOrEmpty(txt1.Text.Trim) And Not txt1.Text.Trim.ToUpper = "NAN" Then
    '                                            sum += Convert.ToDouble(txt1.Text)
    '                                        End If
    '                                    End If
    '                                Else
    '                                    If Not String.IsNullOrEmpty(gr.Cells(i).Text.Trim) And Not gr.Cells(i).Text.Trim.ToUpper = "NAN" Then
    '                                        sum += Convert.ToDouble(gr.Cells(i).Text)
    '                                    End If
    '                                End If
    '                            End If

    '                        Next
    '                        'dr2(i) = sum
    '                        GV.Rows(GV.Rows.Count - 1).Cells(i).Text = sum
    '                    End If
    '                Next
    '            Next

    '        End If

    '    End If

    '    da = New SqlDataAdapter("SELECT  * from MMM_MST_FIELDS where EID=" & Session("EID").ToString() & " and Documenttype='" & Documenttype & "' and FieldType in ('Child Item Total','Child Item MAX') and isActive=1 order by displayOrder", con)

    '    Dim ds As New DataSet
    '    da.Fill(ds, "fields")
    '    Dim dt As DataTable = ds.Tables("fields")


    '    If dt.Rows.Count > 0 Then
    '        Dim grd As GridView = TryCast(pnlFields.FindControl("GRD" & fldId.ToString), GridView)
    '        If Not grd Is Nothing Then
    '            For Each dr As DataRow In dt.Rows
    '                Total = 0
    '                Dim lookupId As Integer = Convert.ToInt32(dr.Item("dropdown"))
    '                For Each gr As GridViewRow In grd.Rows
    '                    If gr.RowIndex < grd.Rows.Count - 1 Then

    '                        Dim txt1 As TextBox = CType(gr.FindControl("fld" & dr.Item("dropdown").ToString() & gr.RowIndex.ToString), TextBox)
    '                        If Not txt1 Is Nothing Then
    '                            ' cell = i
    '                            If dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then
    '                                If txt1.Text.Trim = "" Then
    '                                Else
    '                                    Total += Convert.ToInt32(txt1.Text)
    '                                End If
    '                            ElseIf dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM MAX" Then
    '                                If txt1.Text.Trim = "" Then
    '                                Else
    '                                    If Max < Convert.ToInt32(txt1.Text) Then
    '                                        Max = Convert.ToInt32(txt1.Text)
    '                                    End If
    '                                End If
    '                            End If
    '                        End If

    '                    End If
    '                Next
    '                'If dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then

    '                '    For i As Integer = 0 To grd.Rows(0).Cells.Count - 1
    '                '        Dim cntrl = grd.Rows(0).Cells(i).Controls
    '                '        For Each c As Control In cntrl
    '                '            If TypeOf c Is TextBox Then
    '                '                Dim txt1 As TextBox = CType(c, TextBox)
    '                '                If txt1.ID = "fld" & dr.Item("dropdown").ToString() & "0" Then
    '                '                    cell = i
    '                '                End If
    '                '            End If
    '                '        Next
    '                '    Next
    '                '    If Not cell = 0 Then
    '                '        grd.Rows(grd.Rows.Count - 1).Cells(cell).Text = Total
    '                '    End If
    '                'End If

    '                Dim txt As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("Fieldid").ToString()), TextBox)
    '                If dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then
    '                    txt.Text = Total
    '                ElseIf dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM MAX" Then
    '                    txt.Text = Max
    '                End If
    '            Next

    '        End If

    '    End If

    'End Sub

    '' bkup on 21-Nov-14 b4 code for recalculate calculative field result by sh

    'Protected Sub CalculateGRid(ByVal Documenttype As String, ByVal fldId As Integer)
    '    Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '    Dim con As SqlConnection = New SqlConnection(conStr)

    '    Dim Max As Integer = 0
    '    Dim Total As Integer = 0

    '    Dim tab As String


    '    If con.State <> ConnectionState.Open Then
    '        con.Open()
    '    End If

    '    Dim da As SqlDataAdapter = New SqlDataAdapter("SELECT  Dropdown from MMM_MST_FIELDS where fieldID=" & fldId, con)
    '    Dim dsp As New DataSet
    '    da.Fill(dsp, "fields")
    '    tab = dsp.Tables(0).Rows(0).Item("Dropdown").ToString()


    '    Dim GV As GridView = CType(pnlFields.FindControl("GRD" & fldId.ToString()), GridView)
    '    Dim conStr1 As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
    '    Dim con1 As SqlConnection = New SqlConnection(conStr1)
    '    Dim query As String = "Select F1.FieldID,F1.displayName,f1.fieldtype,F1.IsTotal,F1.DocumentType,f2.dropdown,F1.InLineEditing  from MMM_MST_FIELDS f1 join MMM_MST_FIELDS f2 on F1.DOCUMENTTYPE =F2.dropdown where F1.DocumentType ='" & tab & "' and f2.DocumentType ='" & Documenttype & "' and f1.EID=" & Session("EID") & " And f1.IsActive=1  and f2.IsActive=1"
    '    Dim ODA As SqlDataAdapter = New SqlDataAdapter(query, con1)
    '    Dim dtFields As New DataTable
    '    ODA.Fill(dtFields)

    '    Dim ds1 As DataTable = GV.DataSource
    '    If Not ds1 Is Nothing Then
    '        'Dim dr2 As DataRow = ds1.NewRow()
    '        If ds1.Rows.Count > 0 Then

    '            For i As Integer = 0 To ds1.Columns.Count - 1

    '                For j As Integer = 0 To dtFields.Rows.Count - 1

    '                    If dtFields.Rows(j).Item("displayName").ToString = ds1.Columns(i).ColumnName And Convert.ToInt32(dtFields.Rows(j).Item("IsTotal")) = 1 Then
    '                        Dim sum As Double = 0
    '                        For Each gr As GridViewRow In GV.Rows
    '                            If gr.RowIndex < GV.Rows.Count - 1 Then

    '                                If dtFields.Rows(j).Item("InLineEditing").ToString() = "1" Then
    '                                    Dim txt1 As TextBox = CType(gr.FindControl("fld" & dtFields.Rows(j).Item("FieldID").ToString() & gr.RowIndex.ToString), TextBox)
    '                                    If Not txt1 Is Nothing Then
    '                                        If Not String.IsNullOrEmpty(txt1.Text.Trim) And Not txt1.Text.Trim.ToUpper = "NAN" Then 'NaN
    '                                            sum += Convert.ToDouble(txt1.Text)
    '                                        End If
    '                                    End If
    '                                Else
    '                                    If Not String.IsNullOrEmpty(gr.Cells(i).Text.Trim) And Not gr.Cells(i).Text.Trim.ToUpper = "NAN" Then
    '                                        sum += Convert.ToDouble(gr.Cells(i).Text)
    '                                    End If
    '                                End If
    '                            End If

    '                        Next
    '                        'dr2(i) = sum
    '                        GV.Rows(GV.Rows.Count - 1).Cells(i).Text = sum
    '                    End If
    '                Next
    '            Next
    '        End If

    '    Else
    '        If GV.Rows.Count > 0 Then
    '            For i As Integer = 0 To GV.HeaderRow.Cells.Count - 1
    '                For j As Integer = 0 To GV.Rows.Count - 1

    '                    If dtFields.Rows(j).Item("displayName").ToString = GV.HeaderRow.Cells(i).Text And Convert.ToInt32(dtFields.Rows(j).Item("IsTotal")) = 1 Then
    '                        Dim sum As Double = 0
    '                        For Each gr As GridViewRow In GV.Rows
    '                            If gr.RowIndex < GV.Rows.Count - 1 Then

    '                                If dtFields.Rows(j).Item("InLineEditing").ToString() = "1" Then
    '                                    Dim txt1 As TextBox = CType(gr.FindControl("fld" & dtFields.Rows(j).Item("FieldID").ToString() & gr.RowIndex.ToString), TextBox)
    '                                    If Not txt1 Is Nothing Then
    '                                        If Not String.IsNullOrEmpty(txt1.Text.Trim) And Not txt1.Text.Trim.ToUpper = "NAN" Then
    '                                            sum += Convert.ToDouble(txt1.Text)
    '                                        End If
    '                                    End If
    '                                Else
    '                                    If Not String.IsNullOrEmpty(gr.Cells(i).Text.Trim) And Not gr.Cells(i).Text.Trim.ToUpper = "NAN" Then
    '                                        sum += Convert.ToDouble(gr.Cells(i).Text)
    '                                    End If
    '                                End If
    '                            End If

    '                        Next
    '                        'dr2(i) = sum
    '                        GV.Rows(GV.Rows.Count - 1).Cells(i).Text = sum
    '                    End If
    '                Next
    '            Next

    '        End If

    '    End If

    '    da = New SqlDataAdapter("SELECT  * from MMM_MST_FIELDS where EID=" & Session("EID").ToString() & " and Documenttype='" & Documenttype & "' and FieldType in ('Child Item Total','Child Item MAX') and isActive=1 order by displayOrder", con)

    '    Dim ds As New DataSet
    '    da.Fill(ds, "fields")
    '    Dim dt As DataTable = ds.Tables("fields")


    '    If dt.Rows.Count > 0 Then
    '        Dim grd As GridView = TryCast(pnlFields.FindControl("GRD" & fldId.ToString), GridView)
    '        If Not grd Is Nothing Then
    '            For Each dr As DataRow In dt.Rows
    '                Total = 0
    '                Dim lookupId As Integer = Convert.ToInt32(dr.Item("dropdown"))
    '                For Each gr As GridViewRow In grd.Rows
    '                    If gr.RowIndex < grd.Rows.Count - 1 Then

    '                        Dim txt1 As TextBox = CType(gr.FindControl("fld" & dr.Item("dropdown").ToString() & gr.RowIndex.ToString), TextBox)
    '                        If Not txt1 Is Nothing Then
    '                            ' cell = i
    '                            If dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then
    '                                If txt1.Text.Trim = "" Then
    '                                Else
    '                                    Total += Convert.ToInt32(txt1.Text)
    '                                End If
    '                            ElseIf dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM MAX" Then
    '                                If txt1.Text.Trim = "" Then
    '                                Else
    '                                    If Max < Convert.ToInt32(txt1.Text) Then
    '                                        Max = Convert.ToInt32(txt1.Text)
    '                                    End If
    '                                End If
    '                            End If
    '                        End If

    '                    End If
    '                Next
    '                'If dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then

    '                '    For i As Integer = 0 To grd.Rows(0).Cells.Count - 1
    '                '        Dim cntrl = grd.Rows(0).Cells(i).Controls
    '                '        For Each c As Control In cntrl
    '                '            If TypeOf c Is TextBox Then
    '                '                Dim txt1 As TextBox = CType(c, TextBox)
    '                '                If txt1.ID = "fld" & dr.Item("dropdown").ToString() & "0" Then
    '                '                    cell = i
    '                '                End If
    '                '            End If
    '                '        Next
    '                '    Next
    '                '    If Not cell = 0 Then
    '                '        grd.Rows(grd.Rows.Count - 1).Cells(cell).Text = Total
    '                '    End If
    '                'End If

    '                ''' for checking the calculation  child item only for inlinediting feature "child item total"  added by balli 
    '                da = New SqlDataAdapter("SELECT  * from MMM_MST_FIELDS where EID=" & Session("EID").ToString() & " and Documenttype='" & tab & "' and fieldid='" & dr.Item("dropdown") & "'  and inlineediting=1 ", con)
    '                da.SelectCommand.CommandType = CommandType.Text
    '                da.Fill(ds, "childData")
    '                If ds.Tables("childData").Rows.Count > 0 Then
    '                    If ds.Tables("childData").Rows(0).Item("FieldId").ToString() = dr.Item("dropdown").ToString() Then
    '                        Dim txt As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("Fieldid").ToString()), TextBox)
    '                        If dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then
    '                            txt.Text = Total
    '                        ElseIf dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM MAX" Then
    '                            txt.Text = Max
    '                        End If
    '                    End If
    '                End If

    '            Next

    '        End If

    '    End If

    'End Sub

    Protected Sub CalculateGRid(ByVal Documenttype As String, ByVal fldId As Integer)
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim Max As Double = 0
        Dim Total As Double = 0
        Dim tab As String
        Try
            If con.State <> ConnectionState.Open Then
                con.Open()
            End If
            'With(nolock) added by Himank on 29th sep 2015
            Dim da As SqlDataAdapter = New SqlDataAdapter("SELECT  Dropdown from MMM_MST_FIELDS  WITH(NOLOCK)  where fieldID=" & fldId, con)
            Dim dsp As New DataSet
            da.Fill(dsp, "fields")
            tab = dsp.Tables(0).Rows(0).Item("Dropdown").ToString()
            Dim GV As GridView = CType(pnlFields.FindControl("GRD" & fldId.ToString()), GridView)
            Dim conStr1 As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
            Dim con1 As SqlConnection = New SqlConnection(conStr1)
            'With(nolock) added by Himank on 29th sep 2015
            Dim query As String = "Select F1.FieldID,F1.displayName,f1.fieldtype,F1.IsTotal,F1.DocumentType,f2.dropdown,F1.InLineEditing,F1.cal_text,F1.cal_fields,f1.RoundOff  from MMM_MST_FIELDS f1  WITH(NOLOCK)  join MMM_MST_FIELDS f2   WITH(NOLOCK) on F1.DOCUMENTTYPE =F2.dropdown where F1.DocumentType ='" & tab & "' and f2.DocumentType ='" & Documenttype & "' and f1.EID=" & Session("EID") & " And f1.IsActive=1  and f2.IsActive=1"
            Dim ODA As SqlDataAdapter = New SqlDataAdapter(query, con1)
            Dim dtFields As New DataTable
            ODA.Fill(dtFields)

            Dim ds1 As DataTable = GV.DataSource
            ' By Neha Thakar 03/02/2015
            If Not ds1 Is Nothing Then

                If ds1.Rows.Count > 0 Then

                    For i As Integer = 0 To ds1.Columns.Count - 1

                        For j As Integer = 0 To dtFields.Rows.Count - 1

                            If dtFields.Rows(j).Item("displayName").ToString = ds1.Columns(i).ColumnName And Convert.ToInt32(dtFields.Rows(j).Item("IsTotal")) = 1 Then
                                ' By Neha Thakar 03/02/2015
                                Dim sum As Double = 0
                                Dim DICT As New Dictionary(Of Integer, Integer)
                                DICT = CType(Session("AddedRow"), Dictionary(Of Integer, Integer))
                                For Each gr As GridViewRow In GV.Rows
                                    If gr.RowIndex < GV.Rows.Count - 1 Then

                                        If Not IsNothing(DICT) Then
                                            If Not IsNothing(Session("AddedRow")) And DICT.ContainsKey(gr.RowIndex) Then
                                                If dtFields.Rows(j).Item("fieldtype").ToString() = "Calculative Field" Then
                                                    Dim cal_text As String = ""
                                                    Dim cal_mpng As String = ""
                                                    Dim stringf As String = ""
                                                    Dim fldmpng As String = ""
                                                    Dim orignlfinalstr As String = ""
                                                    Dim finalstrr As String = ""

                                                    cal_text = dtFields.Rows(j).Item("cal_text").ToString()
                                                    '      cal_mpng = dtFields.Rows(j).Item("fieldmapping").ToString()

                                                    stringf = cal_text
                                                    For l As Integer = 0 To dtFields.Rows.Count - 1
                                                        If cal_text.Trim().Contains("{" & dtFields.Rows(l).Item("displayname").ToString().Trim() & "}") Then
                                                            fldmpng = "fld" & dtFields.Rows(l).Item("FieldID").ToString().Trim()
                                                            stringf = stringf.Replace("{" & dtFields.Rows(l).Item("displayname").ToString().Trim() & "}", "{" & fldmpng.Trim() & "}")
                                                        End If
                                                    Next
                                                    stringf = stringf.Replace("{", "")
                                                    stringf = stringf.Replace("}", "")
                                                    Dim s As String() = Split(stringf, "=")
                                                    Dim resultfldd As String = s(0)
                                                    orignlfinalstr = s(1)
                                                    finalstrr = orignlfinalstr
                                                    Dim arr As String() = finalstrr.Split("*", "/", "-", "(", ")", "+", ",")
                                                    Dim ghn As String = ""
                                                    For p As Integer = 0 To arr.Length - 1
                                                        If arr(p).Contains("fld") Then
                                                            Dim txtBox1 As TextBox = CType(gr.FindControl(arr(p) & gr.RowIndex.ToString), TextBox)
                                                            ghn = txtBox1.Text
                                                            finalstrr = finalstrr.Replace(arr(p), ghn)
                                                        Else

                                                        End If
                                                        'finalstrr = finalstrr.Replace(arr(p), ghn)
                                                    Next
                                                    ' added by balli
                                                    If Right(finalstrr, 1) = "," Then
                                                        finalstrr = Left(finalstrr, finalstrr.Length - 1)
                                                    End If
                                                    Dim res = New DataTable().Compute(finalstrr, 0).ToString()
                                                    ' Dim res = "89"
                                                    Dim txt1 As TextBox = CType(gr.FindControl("fld" & dtFields.Rows(j).Item("FieldID").ToString() & gr.RowIndex.ToString), TextBox)
                                                    If Not txt1 Is Nothing Then
                                                        If Not String.IsNullOrEmpty(txt1.Text.Trim) And Not txt1.Text.Trim.ToUpper = "NAN" Then 'NaN
                                                            txt1.Text = res
                                                            sum += Convert.ToDouble(txt1.Text)
                                                        End If
                                                    End If
                                                Else
                                                    Dim txt1 As TextBox = CType(gr.FindControl("fld" & dtFields.Rows(j).Item("FieldID").ToString() & gr.RowIndex.ToString), TextBox)
                                                    If Not txt1 Is Nothing Then
                                                        If Not String.IsNullOrEmpty(txt1.Text.Trim) And Not txt1.Text.Trim.ToUpper = "NAN" Then 'NaN
                                                            sum += Convert.ToDouble(txt1.Text)
                                                        End If
                                                    End If
                                                End If
                                            Else
                                                If Convert.ToInt32(dtFields.Rows(j).Item("IsTotal")) = 1 Then
                                                    If dtFields.Rows(j).Item("InLineEditing").ToString() = "1" Then
                                                        Dim txt1 As TextBox = CType(gr.FindControl("fld" & dtFields.Rows(j).Item("FieldID").ToString() & gr.RowIndex.ToString), TextBox)
                                                        If Not txt1 Is Nothing Then
                                                            If Not String.IsNullOrEmpty(txt1.Text.Trim) And Not txt1.Text.Trim.ToUpper = "NAN" Then
                                                                sum += Convert.ToDouble(txt1.Text)
                                                            End If
                                                        End If
                                                    Else
                                                        If Not String.IsNullOrEmpty(gr.Cells(i).Text.Trim) And Not gr.Cells(i).Text.Trim.ToUpper = "NAN" Then
                                                            sum += Convert.ToDouble(gr.Cells(i).Text)
                                                        End If
                                                    End If
                                                End If

                                            End If
                                        Else
                                            If Convert.ToInt32(dtFields.Rows(j).Item("IsTotal")) = 1 Then
                                                If dtFields.Rows(j).Item("InLineEditing").ToString() = "1" Then
                                                    Dim txt1 As TextBox = CType(gr.FindControl("fld" & dtFields.Rows(j).Item("FieldID").ToString() & gr.RowIndex.ToString), TextBox)
                                                    If Not txt1 Is Nothing Then
                                                        If Not String.IsNullOrEmpty(txt1.Text.Trim) And Not txt1.Text.Trim.ToUpper = "NAN" Then
                                                            If Not IsNothing(dtFields.Rows(j).Item("RoundOff")) Then
                                                                Dim numberOfDecimalPlaces As Integer = Convert.ToString(dtFields.Rows(j).Item("RoundOff"))
                                                                If numberOfDecimalPlaces <> -1 Then
                                                                    Dim before As Double = txt1.Text
                                                                    Dim after As Double = Math.Round(before)
                                                                    Dim formatstring As String = String.Concat("{0:F", numberOfDecimalPlaces, "}")
                                                                    txt1.Text = String.Format(formatstring, after)
                                                                End If
                                                            End If
                                                            sum += Convert.ToDouble(txt1.Text)
                                                        End If
                                                    End If
                                                Else
                                                    If Not String.IsNullOrEmpty(gr.Cells(i).Text.Trim) And Not gr.Cells(i).Text.Trim.ToUpper = "NAN" Then
                                                        If Not IsNothing(dtFields.Rows(j).Item("RoundOff")) Then
                                                            Dim numberOfDecimalPlaces As Integer = Convert.ToString(dtFields.Rows(j).Item("RoundOff"))
                                                            If numberOfDecimalPlaces <> -1 Then
                                                                Dim before As Double = gr.Cells(i).Text
                                                                Dim after As Double = Math.Round(before)
                                                                Dim formatstring As String = String.Concat("{0:F", numberOfDecimalPlaces, "}")
                                                                gr.Cells(i).Text = String.Format(formatstring, after)
                                                            End If
                                                        End If
                                                        sum += Convert.ToDouble(gr.Cells(i).Text)
                                                    End If
                                                End If
                                            End If
                                        End If
                                    End If
                                Next
                                GV.Rows(GV.Rows.Count - 1).Cells(i).Text = sum
                            End If

                        Next
                        'dr2(i) = sum
                    Next
                End If
            Else
                If GV.Rows.Count > 0 Then
                    For i As Integer = 0 To GV.HeaderRow.Cells.Count - 1
                        For j As Integer = 0 To GV.Rows.Count - 1

                            If dtFields.Rows(j).Item("displayName").ToString = GV.HeaderRow.Cells(i).Text And Convert.ToInt32(dtFields.Rows(j).Item("IsTotal")) = 1 Then
                                Dim sum As Double = 0
                                For Each gr As GridViewRow In GV.Rows
                                    If gr.RowIndex < GV.Rows.Count - 1 Then

                                        If dtFields.Rows(j).Item("InLineEditing").ToString() = "1" Then
                                            Dim txt1 As TextBox = CType(gr.FindControl("fld" & dtFields.Rows(j).Item("FieldID").ToString() & gr.RowIndex.ToString), TextBox)
                                            If Not txt1 Is Nothing Then
                                                If Not String.IsNullOrEmpty(txt1.Text.Trim) And Not txt1.Text.Trim.ToUpper = "NAN" Then
                                                    sum += Convert.ToDouble(txt1.Text)
                                                End If
                                            End If
                                        Else
                                            If Not String.IsNullOrEmpty(gr.Cells(i).Text.Trim) And Not gr.Cells(i).Text.Trim.ToUpper = "NAN" Then
                                                sum += Convert.ToDouble(gr.Cells(i).Text)
                                            End If
                                        End If
                                    End If

                                Next
                                'dr2(i) = sum
                                GV.Rows(GV.Rows.Count - 1).Cells(i).Text = sum
                            End If
                        Next
                    Next

                End If

            End If
            ' By Neha Thakar 03/02/2015
            'Changes By Mayank For Child Specific Text
            'da = New SqlDataAdapter("SELECT  * from MMM_MST_FIELDS where EID=" & Session("EID").ToString() & " and Documenttype='" & Documenttype & "' and FieldType in ('Child Item Total','Child Item MAX') and isActive=1 order by displayOrder", con)
            da = New SqlDataAdapter("SELECT  * from MMM_MST_FIELDS where EID=" & Session("EID").ToString() & " and Documenttype='" & Documenttype & "' and (FieldType in ('Child Item Total','Child Item MAX') or child_specific_text is not null) and isActive=1 order by displayOrder", con)
            Dim ds As New DataSet
            da.Fill(ds, "fields")
            Dim dt As DataTable = ds.Tables("fields")

            If dt.Rows.Count > 0 Then
                Dim grd As GridView = TryCast(pnlFields.FindControl("GRD" & fldId.ToString), GridView)
                If Not grd Is Nothing Then
                    'For Each dr As DataRow In dt.Rows
                    '    Total = 0
                    '    Dim lookupId As Integer = Convert.ToDouble(dr.Item("dropdown"))
                    '    For Each gr As GridViewRow In grd.Rows
                    '        If gr.RowIndex < grd.Rows.Count - 1 Then

                    '            Dim txt1 As TextBox = CType(gr.FindControl("fld" & dr.Item("dropdown").ToString() & gr.RowIndex.ToString), TextBox)
                    '            If Not txt1 Is Nothing Then
                    '                ' cell = i
                    '                If dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then
                    '                    If txt1.Text.Trim = "" Then
                    '                    Else
                    '                        Total += Convert.ToDouble(txt1.Text)
                    '                    End If
                    '                ElseIf dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM MAX" Then
                    '                    If txt1.Text.Trim = "" Then
                    '                    Else
                    '                        If Max < Convert.ToDouble(txt1.Text) Then
                    '                            Max = Convert.ToDouble(txt1.Text)
                    '                        End If
                    '                    End If
                    '                End If
                    '            End If

                    '        End If
                    '    Next
                    '    da = New SqlDataAdapter("SELECT  * from MMM_MST_FIELDS where EID=" & Session("EID").ToString() & " and Documenttype='" & tab & "' and fieldid='" & dr.Item("dropdown") & "'  and inlineediting=1 ", con)
                    '    da.SelectCommand.CommandType = CommandType.Text
                    '    da.Fill(ds, "childData")
                    '    If ds.Tables("childData").Rows.Count > 0 Then
                    '        If ds.Tables("childData").Rows(0).Item("FieldId").ToString() = dr.Item("dropdown").ToString() Then
                    '            Dim txt As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("Fieldid").ToString()), TextBox)
                    '            If dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then
                    '                txt.Text = Total
                    '            ElseIf dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM MAX" Then
                    '                txt.Text = Max
                    '            End If
                    '        End If
                    '    End If

                    'Next
                    For Each dr As DataRow In dt.Rows
                        Total = 0
                        If (dr.Item("child_specific_text").ToString() = String.Empty) Then
                            Dim lookupId As Integer = Convert.ToDouble(dr.Item("dropdown"))
                            For Each gr As GridViewRow In grd.Rows
                                If gr.RowIndex < grd.Rows.Count - 1 Then
                                    If (dr.Item("child_specific_text").ToString() = String.Empty) Then
                                        Dim txt1 As TextBox = CType(gr.FindControl("fld" & dr.Item("dropdown").ToString() & gr.RowIndex.ToString), TextBox)
                                        If Not txt1 Is Nothing Then
                                            ' cell = i
                                            If dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then
                                                If txt1.Text.Trim = "" Then
                                                Else
                                                    Total += Convert.ToDouble(txt1.Text)
                                                End If
                                            ElseIf dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM MAX" Then
                                                If txt1.Text.Trim = "" Then
                                                Else
                                                    If Max < Convert.ToDouble(txt1.Text) Then
                                                        Max = Convert.ToDouble(txt1.Text)
                                                    End If
                                                End If
                                            End If
                                        End If
                                        'Else
                                        '    Dim a As String() = dr.Item("child_specific_text").ToString().Split(":")
                                        '    If (a.Length > 1) Then
                                        '        Dim ddls As DropDownList = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), DropDownList)
                                        '        ddls.SelectedIndex = 0
                                        '        Dim ddl As DropDownList = CType(gr.FindControl("fld" & a(0).ToString() & "_" & gr.RowIndex.ToString), DropDownList)
                                        '        Dim test As String = ddl.SelectedValue
                                        '        If (ddl.SelectedValue = a(1).ToString()) Then
                                        '            ddls.SelectedValue = ddl.SelectedValue
                                        '        End If
                                        '    End If
                                    End If
                                End If
                            Next
                        Else
                            For Each gr As GridViewRow In grd.Rows
                                If gr.RowIndex < grd.Rows.Count - 1 Then
                                    If (dr.Item("child_specific_text").ToString() <> String.Empty) Then

                                        Dim a As String() = dr.Item("child_specific_text").ToString().Split(":")
                                        If (a.Length > 1) Then
                                            'With(nolock) added by Himank on 29th sep 2015
                                            da = New SqlDataAdapter("select count(*) from mmm_mst_fields   WITH(NOLOCK) where documenttype in(select dropdown from mmm_mst_fields where fieldid=" & fldId & ")  and eid=" & Session("EID") & " and fieldid=" & a(0), con)
                                            If con.State = ConnectionState.Closed Then
                                                con.Open()
                                            End If
                                            If Convert.ToInt32(da.SelectCommand.ExecuteScalar()) > 0 Then
                                                Dim ddls As DropDownList = CType(pnlFields.FindControl("fld" & dr.Item("FieldID").ToString()), DropDownList)
                                                ddls.SelectedIndex = 0
                                                Dim ddl As DropDownList = CType(gr.FindControl("fld" & a(0).ToString() & "_" & gr.RowIndex.ToString), DropDownList)
                                                If Not IsNothing(ddl) Then
                                                    Dim test As String = ddl.SelectedValue
                                                    If (ddl.SelectedValue = a(1).ToString()) Then
                                                        ddls.SelectedValue = ddl.SelectedValue
                                                        Exit For
                                                    End If
                                                End If
                                            End If
                                        End If
                                    End If
                                End If
                            Next
                        End If
                        If (dr.Item("child_specific_text").ToString() = String.Empty) Then
                            'With(nolock) added by Himank on 29th sep 2015
                            da = New SqlDataAdapter("SELECT  * from MMM_MST_FIELDS   WITH(NOLOCK) where EID=" & Session("EID").ToString() & " and Documenttype='" & tab & "' and fieldid='" & dr.Item("dropdown") & "'  and inlineediting=1 ", con)
                            da.SelectCommand.CommandType = CommandType.Text
                            da.Fill(ds, "childData")
                            If ds.Tables("childData").Rows.Count > 0 Then

                                For Each drr As DataRow In ds.Tables("childData").Rows
                                    If drr.Item("FieldId").ToString() = dr.Item("dropdown").ToString() Then
                                        Dim txt As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("Fieldid").ToString()), TextBox)
                                        If dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then
                                            txt.Text = Total
                                        ElseIf dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM MAX" Then
                                            txt.Text = Max
                                        End If
                                    End If
                                Next

                                'If ds.Tables("childData").Rows(0).Item("FieldId").ToString() = dr.Item("dropdown").ToString() Then
                                '    Dim txt As TextBox = CType(pnlFields.FindControl("fld" & dr.Item("Fieldid").ToString()), TextBox)
                                '    If dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM TOTAL" Then
                                '        txt.Text = Total
                                '    ElseIf dr.Item("FieldType").ToString().ToUpper = "CHILD ITEM MAX" Then
                                '        txt.Text = Max
                                '    End If
                                'End If

                            End If
                        End If
                    Next
                End If
            End If
        Catch ex As Exception
        Finally
            If Not con Is Nothing Then
                con.Close()
                con.Dispose()
            End If
        End Try
    End Sub


    Private Sub GetFiles()
        For Each ctrl As Control In pnlFields.Controls
            If TypeOf ctrl Is HiddenField Then
                Dim hdn As HiddenField = DirectCast(ctrl, HiddenField)
                If IsNothing(hdn) = False Then
                    Dim cid As String = DirectCast(ctrl, HiddenField).ID.ToString.Remove(0, 4)
                    Dim lbl As Label = TryCast(pnlFields.FindControl("lblf" & cid), Label)
                    If IsNothing(lbl) = False Then
                        lbl.Text = DirectCast(ctrl, HiddenField).Value
                    End If
                End If
            End If
        Next
    End Sub


    Public Sub EDITHIT()
        ViewState("IsEdit") = 1
        Dim pid As Integer = Convert.ToString(Request.QueryString("TID").ToString())
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        'With(nolock) added by Himank on 29th sep 2015
        Dim oda As SqlDataAdapter = New SqlDataAdapter("select FF.*,FM.* from MMM_MST_FIELDS FF  WITH(NOLOCK)  inner join mmm_mst_doc_draft M  WITH(NOLOCK)  on FF.DocumentType =M.DocumentType INNER JOIN MMM_MST_FORMS FM ON FF.DOCUMENTTYPE=FM.FORMNAME  where FF.EID=" & Session("EID") & " and FM.EID=" & Session("EID") & "  AND M.tid =" & pid & " and FF.isactive=1  order by displayOrder", con)
        Dim ds As New DataSet()
        oda.Fill(ds, "fields")
        Dim ob As New DynamicForm
        ob._CallerPage = 1
        pnlFields.Controls.Clear()
        ob.CreateControlsOnPanel(ds.Tables("fields"), pnlFields, UpdatePanel1, btnActEdit, 0)
        'Dim ROW1() As DataRow = ds.Tables("fields").Select("fieldtype='DROP DOWN' and (dropdowntype='MASTER VALUED' OR DROPDOWNTYPE='SESSION VALUED') and lookupvalue is not null")
        Dim ROW1() As DataRow = ds.Tables("fields").Select("fieldtype='DROP DOWN' and (dropdowntype='MASTER VALUED' OR DROPDOWNTYPE='SESSION VALUED') and (lookupvalue is not null or multilookupval is not null)")
        If ROW1.Length > 0 Then
            For i As Integer = 0 To ROW1.Length - 1
                Dim DDL As DropDownList = TryCast(pnlFields.FindControl("fld" & ROW1(i).Item("FieldID").ToString()), DropDownList)
                DDL.AutoPostBack = True
                DDL.EnableViewState = True
                AddHandler DDL.TextChanged, AddressOf bindvalue
            Next
        End If


        '' for inline grid ddl filter from main ddl by sunil 31_july_14
        Dim ROWC() As DataRow = ds.Tables("fields").Select("fieldtype='Child Item' and len(isnull(KC_LOGIC,''))>2")
        If ROWC.Length > 0 Then
            For i As Integer = 0 To ROWC.Length - 1
                Dim st() As String = ROWC(i).Item("kc_logic").ToString().Split("-")

                Dim DDL As DropDownList = TryCast(pnlFields.FindControl("fld" & st(0).ToString), DropDownList)
                Dim id As String = Right(DDL.ID, DDL.ID.Length - 3)
                DDL.AutoPostBack = True
                AddHandler DDL.TextChanged, AddressOf bindvalue_ILFilter
            Next
        End If
        '' for inline grid ddl filter from main ddl by sunil 31_july_14



        'Dim dtchild As DataTable = dt

        ob.FillControlsOnPanel(ds.Tables("fields"), pnlFields, "DOCUMENT", pid, True)
        Session("FIELDS") = ds.Tables("fields")
        Session("ACTION") = "EDIT"

        Dim dtchild As DataTable = ds.Tables("fields")

        Dim row() As DataRow = dtchild.Select("FieldType='CHILD ITEM'")
        If Session("ALLCHILD") Is Nothing Then
            Session("ALLCHILD") = row
        End If

        If row.Length > 0 Then
            Dim btn1 As New Button
            For i As Integer = 0 To row.Length - 1
                '' removed frm here by sp 13-jan-14
                'btn1 = pnlFields.FindControl("BTN" & row(i).Item("FieldID").ToString())
                'AddHandler btn1.Click, AddressOf ShowChildForm
                Dim PRitem() As String = row(i).Item("dropdown").ToString().Split("-")
                If PRitem.Length > 1 Then
                    Dim BTN2 As Button = pnlFields.FindControl("BTN" & PRitem(1).ToString & "-" & row(i).Item("FIELDID").ToString())
                    AddHandler BTN2.Click, AddressOf INSERTCHILDITEM
                End If

                Session("FNS") = Session("FNS") & PRitem(0).ToString() & ":" & row(i).Item("Fieldid").ToString() & ":"

                ' Dim array3Ds(,,) As String = New String(,,) {}

                Dim ColHEAD() As String = {}
                Dim DDLTXT() As String = {}
                Dim DDLVAL() As String = {}

                Session("COLHEAD") = ColHEAD
                Session("DDLTXT") = DDLTXT
                Session("DDLVAL") = DDLVAL
                '' by sunil for def value 16-dec-13 - ends


                Dim GRD As GridView = pnlFields.FindControl("GRD" & row(i).Item("Fieldid").ToString())
                ''AddHandler GRD.RowDataBound, AddressOf totalrow  '' moved frm here to below
                AddHandler GRD.RowCommand, AddressOf Delete
                AddHandler GRD.RowDeleting, AddressOf Deleting


                '' by sunil for def value insert for Aggrawal  16-dec-13 - starts
                Dim strDF As String = "select * from mmm_mst_forms where formname='" & PRitem(0).ToString() & "' and formsource='DETAIL FORM' and EID=" & Session("EID").ToString() & " and  isnull(isinlineediting,0)=1"
                Dim oda1 As SqlDataAdapter = New SqlDataAdapter("", con)
                Dim dtIsdv As New DataTable
                oda.SelectCommand.CommandText = strDF
                oda.Fill(dtIsdv)

                Dim dtIsDef As New DataTable
                Dim str As String = "select * from mmm_mst_forms where formname='" & PRitem(0).ToString() & "' and formsource='DETAIL FORM' and EID=" & Session("EID").ToString() & " and isnull(IsDefaultRows,0)>0"
                oda.SelectCommand.CommandText = str
                oda.Fill(dtIsDef)

                If dtIsdv.Rows.Count = 1 OrElse dtIsDef.Rows.Count = 1 Then '' found hasdefvalue prop. true proceed to display button 
                    ' Dim btnIDV As New Button
                    ' btnIDV = pnlFields.FindControl("BTN_" & row(i).Item("FieldID").ToString())  '  "BTN" & "_" & ROWCHILD(i).Item("FIELDID").ToString()
                    AddHandler GRD.RowDataBound, AddressOf gvData_InlineEdit
                Else
                    AddHandler GRD.RowDataBound, AddressOf totalrow
                    btn1 = pnlFields.FindControl("BTN" & row(i).Item("FieldID").ToString())
                    If IsNothing(btn1) = False Then
                        AddHandler btn1.Click, AddressOf ShowChildForm
                    End If

                End If
                ' oda.Dispose()
                'dtIsdv.Dispose()
                Dim str1 = "BTNFLTER" & row(i).Item("FIELDID").ToString() & "_" & row(i).Item("DROPDOWN").ToString().Replace(" ", "_")
                btn1 = pnlFields.FindControl(str1)
                If Not btn1 Is Nothing Then
                    'AddHandler btn1.Click, AddressOf Filter ' 
                    btn1.Visible = False
                End If

                Dim BTNUpload As New Button
                BTNUpload = pnlFields.FindControl("BTNUpload" & row(i).Item("FIELDID").ToString())
                If Not BTNUpload Is Nothing Then
                    BTNUpload.Visible = False
                End If



                If dtIsdv.Rows.Count = 1 Then '' found hasdefvalue prop. true proceed to display button 
                    'INSERT_DEFAULTVALUES(PRitem(0).ToString, row(i).Item("FieldID").ToString(), ds.Tables("childDocid").Rows(0).Item("tid"))  '  "BTN" & "_" & ROWCHILD(i).Item("FIELDID").ToString()
                    If dtIsdv.Rows(0).Item("isinlineediting") = 1 Then
                        ShowDefaultValuesinGrid()
                    Else
                        INSERT_DEFAULTVALUES_draft(PRitem(0).ToString, row(i).Item("FieldID").ToString(), pid, dtIsdv)
                    End If

                ElseIf dtIsDef.Rows.Count = 1 Then
                    INSERT_DEFAULTVALUES_draft(PRitem(0).ToString, row(i).Item("FieldID").ToString(), pid, dtIsDef)
                Else
                    oda.SelectCommand.Parameters.Clear()
                    oda.SelectCommand.CommandType = CommandType.StoredProcedure
                    oda.SelectCommand.CommandText = "uspGetDetailITEMByDocid_for_draft"
                    oda.SelectCommand.CommandType = CommandType.StoredProcedure
                    oda.SelectCommand.Parameters.AddWithValue("DOCID", pid)
                    oda.SelectCommand.Parameters.AddWithValue("FN", PRitem(0).ToString())
                    oda.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
                    ds.Tables.Clear()
                    oda.Fill(ds, "ITEM")
                    oda.SelectCommand.CommandType = CommandType.Text
                    'With(nolock) added by Himank on 29th sep 2015
                    oda.SelectCommand.CommandText = "SELECT F1.FieldID,F2.displayName,F1.FieldType  FROM MMM_MST_FIELDS F1   WITH(NOLOCK) INNER JOIN MMM_MST_FIELDS F2   WITH(NOLOCK) ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid) inner join mmm_mst_doc_draft D ON F1.DOCUMENTTYPE=D.DOCUMENTTYPE  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType ='CHILD ITEM TOTAL' AND F2.DocumentType ='" & row(i).Item("dropdown").ToString() & "' AND D.TID=" & pid & ""
                    oda.Fill(ds, "TOTAL")
                    'ob.BINDITEMGRID(ds.Tables("ITEM"), pnlFields, btn1.ID, updatePanelEdit, ds.Tables("TOTAL"))
                    ob.BINDITEMGRID1(ds.Tables("ITEM"), pnlFields, row(i).Item("FieldID"), UpdatePanel1, ds.Tables("TOTAL"))
                End If

                Dim btn As Button
                btn = pnlFields.FindControl("bntCalFromGrid_" & row(i).Item("FIELDID").ToString())
                If Not btn Is Nothing Then
                    AddHandler btn.Click, AddressOf CalculateFromGrid
                End If


            Next

            If Not Session("CHILD") Is Nothing Then
                pnlFields1.Controls.Clear()
                ob.CreateControlsOnPanel(Session("CHILD"), pnlFields1, updpnlchild, Button2, 0)
                Dim ROW2() As DataRow = Session("CHILD").Select("fieldtype='DROP DOWN' and dropdowntype='MASTER VALUED' and lookupvalue is not null or multilookUpVal is not null")
                If ROW2.Length > 0 Then
                    For i As Integer = 0 To ROW2.Length - 1
                        Dim DDL As DropDownList = TryCast(pnlFields1.FindControl("fld" & ROW2(i).Item("FieldID").ToString()), DropDownList)
                        DDL.AutoPostBack = True
                        AddHandler DDL.TextChanged, AddressOf bindvalue1
                    Next
                End If

                Dim ROW3() As DataRow = Session("CHILD").Select("fieldtype='DROP DOWN' and dropdowntype='MASTER VALUED' and kc_logic is not null And kc_logic <>''")
                If ROW3.Length > 0 Then
                    For i As Integer = 0 To ROW3.Length - 1
                        parentchild(ROW3(i).Item("FIELDID"), CInt(ROW3(i).Item("KC_LOGIC").ToString()))
                    Next
                End If



            End If


        End If

        ' UpdatePanel1.Update()

    End Sub

    Public Sub AddRow(sender As Object, e As EventArgs)
        Dim i = 0
        Dim btnAddRow As Button = TryCast(sender, Button)
        Dim btnID = btnAddRow.ID
        Dim FieldID As String = ""
        Dim tab As String
        'btn ID Is seperated by _ 
        Dim arr = btnID.Split("_")
        FieldID = arr(0).Replace("BTNFLTER", String.Empty)
        Dim ChildItemName = ""
        For J As Integer = 1 To arr.Length - 1
            ChildItemName = ChildItemName & " " & arr(J)
        Next
        ChildItemName = ChildItemName.Trim()
        'Dim grd As GridView = pnlFields.FindControl("GRD" & FieldID)
        'Dim DS As DataTable = CType(Session(ChildItemName), DataTable)

        Dim DSq As New DataSet
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        'With(nolock) added by Himank on 29th sep 2015
        Dim da As SqlDataAdapter = New SqlDataAdapter("SELECT  Dropdown from MMM_MST_FIELDS  WITH(NOLOCK)  where fieldID=" & ChildItemName, con)
        Dim dsp As New DataSet
        da.Fill(dsp, "fields")
        tab = dsp.Tables(0).Rows(0).Item("Dropdown").ToString()
        Session("Fn") = tab
        'With(nolock) added by Himank on 29th sep 2015
        Dim oda As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF  WITH(NOLOCK)  left outer JOIN MMM_MST_FORMS F   WITH(NOLOCK)  on F.FormName = FF.DocumentType and F.EID = FF.EID  where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FormName = '" & tab & "' order by displayOrder", con)
        oda.Fill(DSq, "CHILD")
        Session("CHILD") = DSq.Tables("CHILD")
        Session("D" & ChildItemName) = DSq.Tables("CHILD")
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If

        Try
            If con.State <> ConnectionState.Open Then
                con.Open()
            End If

            Dim GV As GridView = CType(pnlFields.FindControl("GRD" & ChildItemName.ToString()), GridView)
            Dim ds1 As DataTable = DirectCast(GV.DataSource, DataTable)

            Dim ob As New DynamicForm()
            Dim dtPrev = ob.GetChildItemValues(GV)

            Dim filterRows() As DataRow
            'filterRows = ds1.Select("All='Total'")
            'If filterRows.Length > 0 Then
            '    ds1.Rows.Remove(filterRows.FirstOrDefault)
            'End If
            If ds1.Columns.Contains("All") Then
                filterRows = ds1.Select("All='Total'")
                If filterRows.Length > 0 Then
                    ds1.Rows.Remove(filterRows.FirstOrDefault)
                End If
            ElseIf ds1.Rows(ds1.Rows.Count - 1).Item(0) = "Total" Then
                ds1.Rows.Remove(ds1.Rows(ds1.Rows.Count - 1))
            End If
            ds1.Rows.Add(ds1.NewRow())

            Dim dictionary As New Dictionary(Of Integer, Integer)
            dictionary.Add(ds1.Rows.Count - 1, ds1.Rows.Count - 1)
            If Not IsNothing(Session("AddedRow")) Then
                dictionary = CType(Session("AddedRow"), Dictionary(Of Integer, Integer))
                dictionary.Add(ds1.Rows.Count - 1, ds1.Rows.Count - 1)
            Else
                Session("AddedRow") = dictionary
            End If
            ADD_DV_ITEMSTOGRID(tab, ds1, ds1, ChildItemName)

            ob.FillChildItemValues(GV, dtPrev)

            oda.Dispose()
            DSq.Dispose()
            con.Dispose()
        Catch
        End Try


    End Sub

    Public Sub bindvalue_ILFilter(ByVal sender As Object, ByVal e As EventArgs)
        Dim c As Control = GetPostBackControl(Me.Page)
        '...
        If c IsNot Nothing Then
        End If
        If TypeOf c Is System.Web.UI.WebControls.DropDownList Then
            Dim ddl As DropDownList = TryCast(c, DropDownList)
            Dim id As String = Right(ddl.ID, ddl.ID.Length - 3)
            Dim id1 As Integer = CInt(id)
            Dim ob As New DynamicForm()
            ob.bind(id, pnlFields1, ddl)
            Call FilterILgrid(id)  '' new by sunil 31_july_14
        End If
    End Sub




    Protected Function ValidateDatadraft(ByVal actionType As String, con As SqlConnection, trans As SqlTransaction) As Integer
        Dim screen As String = Request.QueryString("SC").ToString()
        lblMsg.Text = ""
        Dim ret As Integer = 1
        Dim childvalidation As String = ""
        Dim pid As Integer = Convert.ToString(Request.QueryString("TID").ToString())
        Dim oda As SqlDataAdapter = New SqlDataAdapter("", con)
        oda.SelectCommand.Transaction = trans
        If UCase(actionType) = "EDIT" Then
            oda.SelectCommand.CommandText = "select FF.*,FM.* from MMM_MST_FIELDS FF inner join MMM_MST_DOC_draft M on FF.DocumentType =M.DocumentType left outer join MMM_MST_FORMS FM ON FF.DOCUMENTTYPE=FM.FORMNAME   where FF.EID=" & Session("EID") & " AND FM.EID=" & Session("EID") & "  AND M.tid =" & pid & " and FF.isactive=1  order by displayOrder"
        End If
        Dim ds As New DataSet
        oda.Fill(ds, "fields")

        ' here is the code for calculation inline grid 
        Dim childDt() As DataRow = ds.Tables("fields").Select("fieldtype='child item'")
        For K As Integer = 0 To childDt.Length - 1
            CalculateGRid(screen, childDt(K).Item("fieldid").ToString())
        Next
        'End here
        Dim ob As New DynamicForm



        Dim FinalQry As String


        FinalQry = ob.ValidateAndGenrateQueryForControls("UPDATE", "UPDATE MMM_MST_DOC_draft SET ", "", ds.Tables("fields"), pnlFields, pid)
        If Trim(Left(FinalQry, 6)).ToUpper() = "PLEASE" Then
            lblTab.Text = FinalQry
            UpdatePanel1.Update()
            ret = 0
            Return ret
        Else
            'Code For Rule Engine By Ajeet Kumar Dated :30-july-2014
            Dim dv As DataView = ds.Tables("fields").DefaultView
            dv.RowFilter = "IsActive=1"
            Dim theFields As DataTable = dv.ToTable
            Dim lstData As New List(Of UserData)
            Dim obj As New DynamicForm()
            'Creating collection for rule engine execution
            lstData = obj.CreateCollection(pnlFields, theFields)
            'Setting it to session for getting it's value for child Item validation
            Session("pColl") = lstData
            'Creating object of rule response
            Dim ObjRet As New RuleResponse()
            'Initialising rule Object
            Dim ObjRule As New RuleEngin(Session("EID"), ds.Tables("fields").Rows(0).Item("documenttype").ToString(), "CREATED", "SUBMIT")
            'Uncomment
            ObjRet = ObjRule.ExecuteRule(lstData, Nothing, False)
            If ObjRet.Success = False Then
                lblTab.Text = ObjRet.ErrorMessage
                UpdatePanel1.Update()
                ret = 0
                Return ret
            End If

            'Prashant_30_7
            Dim validatechilditem() As DataRow = ds.Tables("fields").Select("Fieldtype='CHILD ITEM'")
            If validatechilditem.Length > 0 Then
                For Each DR As DataRow In validatechilditem
                    '' new added for saving differently if def. value feature is on
                    Dim strDF As String = "select * from mmm_mst_forms where formname='" & DR.Item("DROPDOWN") & "' and formsource='DETAIL FORM' and EID=" & Session("EID") & " and (isnull(HasDefaultValue,0)=1 or isnull(IsDefaultRows,0)>0)"
                    Dim oda1 As SqlDataAdapter = New SqlDataAdapter("", con)
                    oda1.SelectCommand.Transaction = trans
                    Dim dtIsdv As New DataTable
                    oda1.SelectCommand.CommandText = strDF
                    oda1.Fill(dtIsdv)

                    If dtIsdv.Rows.Count > 0 Then
                        childvalidation = ValidatingChildItem_DV(DR.Item("DROPDOWN"))
                    End If
                    If childvalidation.Length > 5 Then
                        lblTab.Text = childvalidation
                        ret = 0
                        Return ret
                    End If


                    'childvalidation = ValidatingChildItem_DV(DR.Item("DROPDOWN"))
                    'If childvalidation.Length > 5 Then
                    '    lblDetail1.Text = childvalidation
                    '    ret = 0
                    '    Return ret

                    'End If
                Next
            End If
            '' here code for split functionality by sunil - create new document 
            Dim NewDocRES As String = ""


            If actionType <> "ADD" Then
                FinalQry = FinalQry & " WHERE tID=" & pid
            End If
            'save the data
            oda.SelectCommand.CommandText = FinalQry
            oda.SelectCommand.ExecuteNonQuery()

            '' new for updating amount value in old doc by sp 
            'If ViewState("status") = "SPLIT" Then
            '    If NewDocRES <> "ERROR" Then
            '        If Not ViewState("SplitUpdStr") = Nothing Then
            '            oda.SelectCommand.CommandText = ViewState("SplitUpdStr")
            '            oda.SelectCommand.ExecuteNonQuery()
            '        End If
            '    End If
            'End If
            Dim fileid As Integer = Convert.ToString(Request.QueryString("TID").ToString())
            '  Call Recalculate_CalfieldsonSave(fileid, con, trans) 'fOR cALCULATIV fIELD


            Dim childitem() As DataRow = ds.Tables("fields").Select("Fieldtype='CHILD ITEM'")
            If childitem.Length > 0 Then
                For Each DR As DataRow In childitem
                    '' new added for saving differently if def. value feature is on
                    '' by sunil for def value 13-jan-14 - starts
                    Dim strDF As String = "select * from mmm_mst_forms where formname='" & DR.Item("DROPDOWN") & "' and formsource='DETAIL FORM' and EID=" & Session("EID") & " and ( isnull(HasDefaultValue,0)=1 or isnull(isinlineediting,0)=1 or  isnull(NullIf(IsDefaultRows,''),0)<>0)"
                    Dim dtIsdv As New DataTable
                    oda.SelectCommand.CommandType = CommandType.Text
                    oda.SelectCommand.CommandText = strDF
                    oda.Fill(dtIsdv)
                    If dtIsdv.Rows.Count = 0 Then
                        '  SavingChildItem(DR.Item("DROPDOWN"), fileid)
                        '         oda.SelectCommand.CommandText = "UPDATE MMM_MST_DOC_ITEM_draft SET DOCID =" & fileid & " WHERE SESSIONID='" & Session.SessionID & "' AND DOCID IS NULL "
                        '        oda.SelectCommand.ExecuteNonQuery()
                        SavingChildItem_DV_draft(DR.Item("DROPDOWN"), fileid, con, trans)
                    Else
                        SavingChildItem_DV_draft(DR.Item("DROPDOWN"), fileid, con, trans)
                    End If
                    Try
                        Dim FormName As String = DR.Item("DROPDOWN")
                        Dim EID As Integer = 0
                        EID = Convert.ToInt32(Session("EID"))
                        If (fileid > 0) And (FormName <> "") Then
                            'Last parameter is for child item
                            Trigger.ExecuteTriggerT(FormName, EID, fileid, con, trans, 1, TriggerNature:="Update")
                        End If
                    Catch ex As Exception
                        Throw
                    End Try
                Next
            End If

            '' formula
            Dim CalculativeField() As DataRow = ds.Tables("fields").Select("Fieldtype='Formula Field'")
            Dim viewdoc As String = ds.Tables("fields").Rows(0).Item("documenttype").ToString()
            Dim doctype = ds.Tables("fields").Rows(0).Item("documenttype").ToString()
            viewdoc = viewdoc.Replace(" ", "_")

            If CalculativeField.Length > 0 Then
                For Each CField As DataRow In CalculativeField
                    Dim da As New SqlDataAdapter("", con)
                    da.SelectCommand.Transaction = trans
                    Dim formulaeditorr As New formulaEditor
                    Dim forvalue As String = String.Empty
                    forvalue = formulaeditorr.ExecuteFormulaT(CField.Item("KC_LOGIC"), fileid, "DV" + Session("eid").ToString + viewdoc, Session("eid").ToString, 1, con, trans)
                    Dim upquery As String = "update " & CField.Item("DBTableName").ToString & "_DRAFT" & "  set  " & CField.Item("FieldMapping").ToString & "='" & forvalue.ToString & "'  where tid =" & fileid & ""
                    If con.State <> ConnectionState.Open Then
                        con.Open()
                    End If
                    da.SelectCommand.CommandType = CommandType.Text
                    da.SelectCommand.CommandText = upquery
                    da.SelectCommand.ExecuteNonQuery()
                    da.Dispose()
                Next
            End If
            'formula end
            ob.HistoryT(Session("EID"), fileid, Session("UID"), ds.Tables("fields").Rows(0).Item("documenttype").ToString(), "MMM_MST_DOC_DRAFT", "UPDATE", con, trans)
            oda.SelectCommand.ExecuteNonQuery()
            Try
                ' fill the actionform in session 
                Trigger.ExecuteTriggerT(ds.Tables("fields").Rows(0).Item("documenttype").ToString(), Session("EID"), Request.QueryString("DOCID").ToString(), con, trans, TriggerNature:="Update")
            Catch ex As Exception
            End Try
            Dim ob1 As New DMSUtil

            ob.CLEARDYNAMICFIELDS(pnlFields)

            Dim remarks As String = ""

        End If
        oda.Dispose()
        'ModalEditPopup.Hide()
        UpdatePanel1.Update()


        Return ret

    End Function

    Public Shared Function After(ByVal value As String, ByVal a As String) As String
        Dim posA As Integer = value.LastIndexOf(a)
        If posA = -1 Then
            Return ""
        End If
        Dim adjustedPosA As Integer = posA + a.Length
        If adjustedPosA >= value.Length Then
            Return ""
        End If
        Return value.Substring(adjustedPosA)
    End Function

    ''''draft
    Protected Sub ADD_DV_ITEMSTOGRID_Draft(ByVal FORMNAME As String, ByVal DtDV As DataTable, ByVal DtDV_Vals As DataTable)
        Try

            Dim dtFD As New DataTable
            Dim dtField As New DataTable
            Dim DTVALUE As New DataTable
            Dim errormsg As String = "Please Enter "
            dtField = ViewState(FORMNAME)
            ' Dim OB As New DynamicForm()
            Session("ITEM") = DtDV_Vals
            dtFD = DtDV
            If Session(FORMNAME) Is Nothing Then
                dtFD = DtDV
                DTVALUE = DtDV_Vals
            Else
                DTVALUE = Session(FORMNAME)
            End If



            Session(FORMNAME) = dtFD
            Session(FORMNAME & "VAL") = DTVALUE
            BINDGRID1(dtFD)
            ' ModalPopupExtender1.Hide()

        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Public Sub INSERT_DEFAULTVALUES_draft(ByVal FN As String, ByVal fldID As String, ByVal DtForm As DataTable)
        '' new created for inserting def. values from master table in document on 17-Dec-13 by sunil pareek
        'Dim btnDetails As Button = TryCast(SENDER, Button)
        Dim formname As String = FN
        Dim FormnameDVM As String = ""
        'formname = Right(formname, formname.Length - 8).Trim()
        Session("FN") = formname
        'aaaa
        If DtForm.Rows(0).Item("hasdefaultvalue").ToString() = "1" Then
            ViewState("FN_DVM") = formname & "_MASTER"
            FormnameDVM = formname & "_MASTER"
        Else
            ViewState("FN_DVM") = formname
            FormnameDVM = formname
        End If

        'Dim ID() As String = btnDetails.ID.Split("_")
        Session("ID") = fldID.ToString  'ID(1).ToString
        ViewState("ID") = "BTN" & fldID.ToString  'ID(1).ToString

        'aaaa
        ViewState("Default") = DtForm.Rows(0).Item("IsDefaultRows").ToString() & "_" & DtForm.Rows(0).Item("hasdefaultvalue").ToString()



        Dim scrname As String = Request.QueryString("SC").ToString()
        'Dim scrname As String = ViewState("sc").ToString()
        Dim ob As New DynamicForm
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim DS As New DataSet
        'With(nolock) added by Himank on 29th sep 2015
        Dim oda As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF  WITH(NOLOCK)  left outer JOIN MMM_MST_FORMS F  WITH(NOLOCK)  on F.FormName = FF.DocumentType and F.EID = FF.EID  where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FormName = '" & formname & "' order by displayOrder", con)
        oda.Fill(DS, "CHILD")
        'Uncheck After testing 19/10/2016
        'Session("CHILD") = DS.Tables("CHILD")
        Session("D" & formname) = DS.Tables("CHILD")
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If

        Dim DefValMastDoctype As String = ""
        Dim CdocType As String = ""
        DS.Tables.Clear()
        ' Dim ddl As DropDownList = TryCast(pnlFields.FindControl("fld" & ID(0).ToString()), DropDownList)
        ' Dim docid() As String = ddl.SelectedValue.ToString.Split("|")
        oda.SelectCommand.Parameters.Clear()
        oda.SelectCommand.CommandText = "uspGetDefValuesFromMaster"
        oda.SelectCommand.CommandType = CommandType.StoredProcedure
        oda.SelectCommand.Parameters.AddWithValue("FN", FormnameDVM)
        oda.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
        oda.Fill(DS, "ITEM")
        '  DS.Tables("ITEM").Columns.Add("All", GetType(String)).SetOrdinal(0) ' adding checkbox for grid to select All
        '' for values 
        oda.SelectCommand.Parameters.Clear()
        oda.SelectCommand.CommandText = "uspGetDefValuesFromMaster_Vals"
        oda.SelectCommand.CommandType = CommandType.StoredProcedure
        oda.SelectCommand.Parameters.AddWithValue("FN", FormnameDVM)
        oda.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
        oda.Fill(DS, "ITEM_VALS")


        oda.SelectCommand.CommandType = CommandType.Text
        'With(nolock) added by Himank on 29th sep 2015
        oda.SelectCommand.CommandText = "SELECT F1.FieldID,F2.displayName,F1.FieldType FROM MMM_MST_FIELDS F1  WITH(NOLOCK)  INNER JOIN MMM_MST_FIELDS F2  WITH(NOLOCK)  ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType  in ('CHILD ITEM MAX','CHILD ITEM TOTAL')  AND F2.DocumentType ='" & formname & "' AND F1.DOCUMENTTYPE='" & scrname & "'"
        oda.Fill(DS, "TOTAL")

        '' WRITE here func that will add row by row values in grid ' write new function by sunil
        ADD_DV_ITEMSTOGRID_Draft(formname, DS.Tables("ITEM"), DS.Tables("ITEM_VALS"))

        '' arrays for holding master valued column data 
        'Dim array3Ds(,,) As String = New String(,,) {}

        Dim ColHead() As String = {}
        Dim DDLTxt() As String = {}
        Dim DDLval() As String = {}
        Dim aCnt As Integer = 0

        Dim dtC As DataTable = Session("D" & formname) 'DS.Tables("CHILD")

        For j = 0 To dtC.Rows.Count - 1
            If dtC.Rows(j).Item("fieldtype").ToString = "DROP DOWN" And dtC.Rows(j).Item("DROPDOWNTYPE") = "MASTER VALUED" Then
                For i As Integer = 0 To DS.Tables("item").Rows.Count - 1
                    For k As Integer = 0 To DS.Tables("item").Columns.Count - 1
                        If DS.Tables("item").Columns(k).ColumnName = dtC.Rows(j).Item("displayname").ToString Then  '' matched col. (mast. val.) 
                            ColHead(aCnt) = formname & "_" & dtC.Rows(j).Item("displayname").ToString
                            DDLTxt(aCnt) = DS.Tables("item").Rows(i).Item(DS.Tables("item").Columns(k).ColumnName).ToString
                            DDLval(aCnt) = DS.Tables("ITEM_VALS").Rows(i).Item(DS.Tables("item").Columns(k).ColumnName).ToString
                        End If
                    Next
                Next
            End If
        Next

        Session("COLHEAD") = ColHead
        Session("DDLTXT") = DDLTxt
        Session("DDLVAL") = DDLval

        dtC.Dispose()
        oda.Dispose()
        DS.Dispose()
        con.Dispose()
    End Sub

    Public Sub INSERT_DEFAULTVALUES_draft(ByVal FN As String, ByVal fldID As String, ByVal chidDocID As Integer, ByVal DtForm As DataTable, Optional ByVal inlineEdit As Integer = 0)

        Dim formname As String = FN
        Dim FormnameDVM As String = ""
        Session("FN") = formname
        'PRashant_30_7
        If DtForm.Rows(0).Item("hasdefaultvalue").ToString() = "1" Then
            ViewState("FN_DVM") = formname & "_MASTER"
            FormnameDVM = formname & "_MASTER"
        Else
            ViewState("FN_DVM") = formname
            FormnameDVM = formname
        End If

        ViewState("Default") = DtForm.Rows(0).Item("IsDefaultRows").ToString() & "_" & DtForm.Rows(0).Item("hasdefaultvalue").ToString()
        'PRashant_30_7


        Session("ID") = fldID.ToString  'ID(1).ToString
        ViewState("ID") = "BTN" & fldID.ToString  'ID(1).ToString


        Dim ob As New DynamicForm
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim DS As New DataSet

        'Dim oda As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF left outer JOIN MMM_MST_FORMS F on F.FormName = FF.DocumentType and F.EID = FF.EID  where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FormName = '" & formname & "' order by displayOrder", con)
        'With(nolock) added by Himank on 29th sep 2015
        Dim oda As SqlDataAdapter = New SqlDataAdapter("SELECT FF.*,F.*  FROM MMM_MST_FIELDS FF  WITH(NOLOCK)  left outer JOIN MMM_MST_FORMS F  WITH(NOLOCK)  on F.FormName = FF.DocumentType and F.EID = FF.EID  where FF.isactive=1 and F.EID=" & Session("EID").ToString() & " and FormName = '" & formname & "' order by displayOrder", con)
        oda.Fill(DS, "CHILD")

        'Uncheck after testing 19/10/2016
        'Session("CHILD") = DS.Tables("CHILD")
        Session("D" & formname) = DS.Tables("CHILD")
        If con.State <> ConnectionState.Open Then
            con.Open()
        End If

        oda.SelectCommand.CommandText = "select documenttype from  MMM_MST_DOC_draft where EID=" & Session("EID") & " and tid =" & chidDocID
        Dim dtdocType As New DataTable
        Dim scrname As String
        oda.Fill(dtdocType)
        If dtdocType.Rows.Count > 0 Then
            scrname = dtdocType.Rows(0).Item(0).ToString
            ViewState("MDOCTYPE") = scrname
        End If

        Dim DefValMastDoctype As String = ""
        DS.Tables.Clear()
        ' Dim ddl As DropDownList = TryCast(pnlFields.FindControl("fld" & ID(0).ToString()), DropDownList)
        ' Dim docid() As String = ddl.SelectedValue.ToString.Split("|")
        oda.SelectCommand.Parameters.Clear()
        oda.SelectCommand.CommandType = CommandType.StoredProcedure
        oda.SelectCommand.CommandText = "uspGetDetailITEMByDocid_for_draft"
        oda.SelectCommand.CommandType = CommandType.StoredProcedure
        oda.SelectCommand.Parameters.AddWithValue("DOCID", chidDocID)
        oda.SelectCommand.Parameters.AddWithValue("FN", FN)
        oda.SelectCommand.Parameters.AddWithValue("EID", Session("EID"))
        DS.Tables.Clear()

        Dim dtitem As New DataTable
        Dim dtVal As New DataTable

        If inlineEdit = 1 Then
            dtitem.Columns.Add("All", GetType(String))
        End If

        oda.Fill(dtitem)
        'Session("ITEM") = DS.Tables("ITEM")
        Session("ITEM") = dtitem

        If inlineEdit = 1 Then
            dtVal.Columns.Add("All", GetType(String))
        End If

        oda.Fill(dtVal)
        oda.SelectCommand.CommandType = CommandType.Text
        'With(nolock) added by Himank on 29th sep 2015
        oda.SelectCommand.CommandText = "SELECT F1.FieldID,F2.displayName FROM MMM_MST_FIELDS F1  WITH(NOLOCK)  INNER JOIN MMM_MST_FIELDS F2  WITH(NOLOCK)  ON F1.dropdown =CONVERT(NVARCHAR(20),F2.Fieldid)  WHERE F1.EID=" & Session("EID") & " AND F1.FieldType ='CHILD ITEM TOTAL' AND F2.DocumentType ='" & formname & "' AND F1.DOCUMENTTYPE='" & scrname & "'"
        oda.Fill(DS, "TOTAL")

        '' WRITE here func that will add row by row values in grid ' write new function by sunil
        'ADD_DV_ITEMSTOGRID(formname, DS.Tables("ITEM"), DS.Tables("ITEM_VALS"))
        ADD_DV_ITEMSTOGRID_Draft(formname, dtitem, dtVal)

        Dim ColHead() As String = {}
        Dim DDLTxt() As String = {}
        Dim DDLval() As String = {}
        Dim aCnt As Integer = 0

        Dim dtC As DataTable = Session("D" & formname) 'DS.Tables("CHILD")

        For j = 0 To dtC.Rows.Count - 1
            If dtC.Rows(j).Item("fieldtype").ToString = "DROP DOWN" And dtC.Rows(j).Item("DROPDOWNTYPE") = "MASTER VALUED" Then
                For i As Integer = 0 To DS.Tables("item").Rows.Count - 1
                    For k As Integer = 0 To DS.Tables("item").Columns.Count - 1
                        If DS.Tables("item").Columns(k).ColumnName = dtC.Rows(j).Item("displayname").ToString Then  '' matched col. (mast. val.) 
                            ColHead(aCnt) = formname & "_" & dtC.Rows(j).Item("displayname").ToString
                            DDLTxt(aCnt) = DS.Tables("item").Rows(i).Item(DS.Tables("item").Columns(k).ColumnName).ToString
                            DDLval(aCnt) = DS.Tables("ITEM_VALS").Rows(i).Item(DS.Tables("item").Columns(k).ColumnName).ToString
                        End If
                    Next
                Next
            End If
        Next

        Session("COLHEAD") = ColHead
        Session("DDLTXT") = DDLTxt
        Session("DDLVAL") = DDLval

        dtC.Dispose()
        oda.Dispose()
        DS.Dispose()
        con.Dispose()
    End Sub


    Public Function comparestring(ByVal cmprStr As String) As Boolean
        Dim diffVal As String() = cmprStr.Split(">", "<", "=", "<=", ">=")
        Dim opr As String
        If cmprStr.Contains(">=") Then
            opr = ">="
        ElseIf cmprStr.Contains("<=") Then
            opr = "<="
        ElseIf cmprStr.Contains("<") Then
            opr = "<"
        ElseIf cmprStr.Contains(">") Then
            opr = ">"
        ElseIf cmprStr.Contains("=") Then
            opr = "="
        End If
        If opr = ">=" Then
            If diffVal(0) >= diffVal(1) Then
                Return True
            Else
                Return False
            End If
            Exit Function
        End If
        If opr = "<=" Then
            If Val(diffVal(0)) <= Val(diffVal(1)) Then
                Return True
            Else
                Return False
            End If
            Exit Function
        End If
        If opr = "=" Then
            If Val(diffVal(0)) = Val(diffVal(1)) Then
                Return True
            Else
                Return False
            End If
            Exit Function
        End If
        If opr = ">" Then
            If Val(diffVal(0)) > Val(diffVal(1)) Then
                Return True
            Else
                Return False
            End If
            Exit Function
        End If
        If opr = "<" Then
            If Val(diffVal(0)) < Val(diffVal(1)) Then
                Return True
            Else
                Return False
            End If
            Exit Function
        End If
        Return False
    End Function

    'Add For show Existing Values
    Protected Sub btnShowExist_Click(sender As Object, e As EventArgs)
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim da As SqlDataAdapter = New SqlDataAdapter("", con)
        Dim dt As New DataTable
        da.SelectCommand.CommandType = CommandType.Text
        'With(nolock) added by Himank on 29th sep 2015
        da.SelectCommand.CommandText = "select FiledsForShowExisting,FiledsForShowExistingEX from mmm_mst_forms  WITH(NOLOCK)  where formname='" & Session("Document") & "' and eid=" & Session("EID")
        If con.State = ConnectionState.Closed Then
            con.Open()
        End If
        da.Fill(dt)
        If dt.Rows.Count > 0 Then
            Dim result As String = ""
            Dim resultEX As String = ""
            result = dt.Rows(0)(0).ToString()
            resultEX = dt.Rows(0)(1).ToString()
            Dim finalresult As String() = result.ToString().Split(",")
            Dim finalresultEX As String() = resultEX.ToString().Split(",")

            ValidateExistingValues(finalresult, finalresultEX)
        End If

        'result = Convert.ToString(da.SelectCommand.ExecuteScalar())
        'Dim finalresult As String() = result.ToString().Split(",")


    End Sub
    'Add For show Existing Values

    Public Function ValidateExistingValues(ByVal str As String(), ByVal strEX As String()) As String
        Dim finalvalidate As New List(Of ValidateExist)
        Dim ht As New Hashtable()
        Dim hb As New StringBuilder
        Dim list As New ArrayList
        Dim fList As New ArrayList
        For i As Integer = 0 To str.Length - 1
            If str(i).ToString() <> String.Empty Then
                If i = 0 Then
                    'With(nolock) added by Himank on 29th sep 2015
                    hb.Append("select fieldid,displayname,fieldType,fieldMapping from mmm_mst_fields  WITH(NOLOCK)  where documenttype='" & Session("Document") & "' and eid=" & Session("EID") & " and  fieldmapping in (")
                End If
                list.Add("'" & str(i).ToString() & "'")
                fList.Add(str(i).ToString())
            End If
        Next
        If hb.ToString() <> String.Empty Then
            hb.Append(String.Join(",", list.ToArray))
        End If

        For i As Integer = 0 To strEX.Length - 1
            If strEX(i).ToString() <> String.Empty Then
                list.Add("'" & strEX(i).ToString() & "'")
                fList.Add(strEX(i).ToString())
            End If

        Next
        If strEX.Length > 0 Then
            If hb.ToString() <> String.Empty Then
                hb.Append("," & String.Join(",", list.ToArray))
            End If
        End If
        If hb.ToString() <> String.Empty Then
            hb.Append(")")
        End If
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim con As SqlConnection = New SqlConnection(conStr)
        Dim da As SqlDataAdapter = New SqlDataAdapter("", con)
        da.SelectCommand.CommandType = CommandType.Text
        da.SelectCommand.CommandText = hb.ToString()
        Dim ds As New DataTable
        da.Fill(ds)
        If ds.Rows.Count > 0 Then
            For i As Integer = 0 To ds.Rows.Count - 1
                Dim bool As Boolean = False
                Dim sa As Integer
                sa = Array.FindIndex(str, (Function(c As String) c = ds.Rows(i).Item("fieldmapping").ToString()))
                If (sa = -1) Then
                    bool = True
                End If
                Select Case ds.Rows(i).Item("FieldType").ToString().ToUpper()
                    Case "MULTI LOOKUP"
                        Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), TextBox)
                        If txtBox.Text.Trim() = "" Then
                            If bool = False Then
                                ScriptManager.RegisterStartupScript(Page, Page.GetType, "MyScript", "alert('Please fill " & ds.Rows(i).Item("displayname").ToString() & "');", True)
                                Return ""
                            Else
                                finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                            End If

                        Else
                            ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), txtBox.Text)
                            finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                        End If
                    Case "MULTI LOOKUPDDL"
                        Dim txtBox As DropDownList = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), DropDownList)
                        If txtBox.Text.Trim() = "" Then
                            If bool = False Then
                                ScriptManager.RegisterStartupScript(Page, Page.GetType, "MyScript", "alert('Please fill " & ds.Rows(i).Item("displayname").ToString() & "');", True)
                                Return ""
                            Else
                                finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                            End If
                        Else
                            ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), txtBox.SelectedValue)
                            finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.SelectedItem.Text, txtBox.SelectedValue, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                        End If

                    Case "TEXT BOX"
                        Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), TextBox)
                        'Validation for Mandatory
                        If txtBox.Text.Trim() = "" Then
                            If bool = False Then
                                ScriptManager.RegisterStartupScript(Page, Page.GetType, "MyScript", "alert('Please fill " & ds.Rows(i).Item("displayname").ToString() & "');", True)
                                Return ""
                            Else
                                finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                            End If
                        Else
                            ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), txtBox.Text)
                            finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                        End If
                    Case "DROP DOWN", "AUTOCOMPLETE", "LOOKUPDDL"
                        If ds.Rows(i).Item("FieldType").ToString().ToUpper() = "AUTOCOMPLETE" Then
                            Dim txtbox As HiddenField = CType(pnlFields.FindControl("HDN" & ds.Rows(i).Item("FieldID").ToString()), HiddenField)
                            If txtbox.Value.Trim() = "" Then
                                If bool = False Then
                                    ScriptManager.RegisterStartupScript(Page, Page.GetType, "MyScript", "alert('Please fill " & ds.Rows(i).Item("displayname").ToString() & "');", True)
                                    Return ""
                                Else
                                    finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtbox.Value, txtbox.Value, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                                End If
                            Else
                                ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), txtbox.Value)
                                finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtbox.Value, txtbox.Value, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                            End If
                        Else
                            Dim txtBox As DropDownList = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), DropDownList)
                            If txtBox.SelectedIndex = 0 Then
                                If bool = False Then
                                    ScriptManager.RegisterStartupScript(Page, Page.GetType, "MyScript", "alert('Please fill " & ds.Rows(i).Item("displayname").ToString() & "');", True)
                                    Return ""
                                Else
                                    finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.SelectedItem.Text, txtBox.SelectedValue.Trim(), ds.Rows(i).Item("fieldmapping").ToString(), bool))
                                End If
                            Else
                                ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), txtBox.SelectedValue)
                                finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.SelectedItem.Text, txtBox.SelectedValue, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                            End If
                        End If
                    Case "CHECKBOX LIST"
                        Dim txtBox As CheckBoxList = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), CheckBoxList)
                        ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), txtBox.SelectedValue)
                        finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.SelectedItem.Text, txtBox.SelectedValue, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                    Case "LIST BOX"
                        Dim txtBox As ListBox = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), ListBox)
                        ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), txtBox.SelectedValue)
                        finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.SelectedItem.Text, txtBox.SelectedValue, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                    Case "TEXT AREA"
                        Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), TextBox)
                        If txtBox.Text.Trim() = "" Then
                            If bool = False Then
                                ScriptManager.RegisterStartupScript(Page, Page.GetType, "MyScript", "alert('Please fill " & ds.Rows(i).Item("displayname").ToString() & "');", True)
                                Return ""
                            Else
                                finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                            End If
                        Else
                            ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), txtBox.Text)
                            finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                        End If

                    Case "CHECK BOX"
                        Dim chkbox As CheckBox = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), CheckBox)
                        If (chkbox.Checked = True) Then
                            ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), "Yes")
                            finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), "Yes", "Yes", ds.Rows(i).Item("fieldmapping").ToString(), bool))
                        Else
                            ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), "No")
                            finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), "No", "No", ds.Rows(i).Item("fieldmapping").ToString(), bool))
                        End If
                    Case "GEO POINT"
                        Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), TextBox)
                        ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), txtBox.Text)
                        finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                    Case "GEO FENCE"
                        Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), TextBox)
                        ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), txtBox.Text)
                        finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                    Case "ADVANCE FORMULA"
                        Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), TextBox)
                        If txtBox.Text.Trim() = "" Then
                            If bool = False Then
                                ScriptManager.RegisterStartupScript(Page, Page.GetType, "MyScript", "alert('Please fill " & ds.Rows(i).Item("displayname").ToString() & "');", True)
                                Return ""
                            Else
                                finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                            End If
                        Else
                            ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), txtBox.Text)
                            finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                        End If


                    Case "LOOKUP"
                        Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), TextBox)
                        'Validation for Mandatory
                        If txtBox.Text.Trim() = "" Then
                            If bool = False Then
                                ScriptManager.RegisterStartupScript(Page, Page.GetType, "MyScript", "alert('Please fill " & ds.Rows(i).Item("displayname").ToString() & "');", True)
                                Return ""
                            Else
                                finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                            End If
                        Else
                            ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), txtBox.Text)
                            finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                        End If
                    Case "CALCULATIVE FIELD"
                        Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), TextBox)
                        If txtBox.Text.Trim() = "" Then
                            If bool = False Then
                                ScriptManager.RegisterStartupScript(Page, Page.GetType, "MyScript", "alert('Please fill " & ds.Rows(i).Item("displayname").ToString() & "');", True)
                                Return ""
                            Else
                                finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                            End If
                        Else
                            ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), txtBox.Text)
                            finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                        End If


                    Case "CHILD ITEM TOTAL"
                        Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), TextBox)

                        If txtBox.Text.Trim() = "" Then
                            If bool = False Then
                                ScriptManager.RegisterStartupScript(Page, Page.GetType, "MyScript", "alert('Please fill " & ds.Rows(i).Item("displayname").ToString() & "');", True)
                                Return ""
                            Else
                                finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                            End If
                        Else
                            ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), txtBox.Text)
                            finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                        End If


                    Case "CHILD ITEM MAX"  ' by sunil 04_jul_14
                        Dim txtBox As TextBox = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), TextBox)

                        If txtBox.Text.Trim() = "" Then
                            If bool = False Then
                                ScriptManager.RegisterStartupScript(Page, Page.GetType, "MyScript", "alert('Please fill " & ds.Rows(i).Item("displayname").ToString() & "');", True)
                                Return ""
                            Else
                                finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                            End If
                        Else
                            ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), txtBox.Text)
                            finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.Text, txtBox.Text, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                        End If


                    Case "SELF REFERENCE"
                        Dim txtBox As System.Web.UI.WebControls.Menu = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), System.Web.UI.WebControls.Menu)
                        'If ds.Rows(i).Item("isrequired").ToString() = 1 And txtBox.Text.Length < 1 Then
                        '    errorMsg &= dispName & ","
                        'End If

                        If txtBox.SelectedValue.Trim() = 0 Then
                            If bool = False Then
                                ScriptManager.RegisterStartupScript(Page, Page.GetType, "MyScript", "alert('Please fill " & ds.Rows(i).Item("displayname").ToString() & "');", True)
                                Return ""
                            Else
                                finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.SelectedItem.Text, txtBox.SelectedValue, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                            End If
                        Else
                            ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), txtBox.SelectedValue)
                            finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.SelectedItem.Text, txtBox.SelectedValue, ds.Rows(i).Item("fieldmapping").ToString(), bool))
                        End If


                    Case "PARENT FIELD"
                        Dim txtBox As System.Web.UI.WebControls.Menu = CType(pnlFields.FindControl("fld" & ds.Rows(i).Item("FieldID").ToString()), System.Web.UI.WebControls.Menu)
                        If txtBox.SelectedValue.Trim() = 0 Then
                            If bool = False Then
                                ScriptManager.RegisterStartupScript(Page, Page.GetType, "MyScript", "alert('Please fill " & ds.Rows(i).Item("displayname").ToString() & "');", True)
                                Return ""
                            Else
                                finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.SelectedItem.Text, txtBox.SelectedValue.Trim(), ds.Rows(i).Item("fieldmapping").ToString(), bool))
                            End If
                        Else
                            ht.Add(ds.Rows(i).Item("fieldmapping").ToString(), txtBox.SelectedValue)
                            finalvalidate.Add(New ValidateExist(ds.Rows(i).Item("FieldType").ToString().ToUpper(), ds.Rows(i).Item("displayname").ToString().ToUpper(), Convert.ToInt32(ds.Rows(i).Item("FIELDID")), txtBox.SelectedItem.Text, txtBox.SelectedValue.Trim(), ds.Rows(i).Item("fieldmapping").ToString(), bool))
                        End If


                End Select
            Next
            Dim executeqry As New StringBuilder
            Dim executeqry1 As New StringBuilder
            executeqry.Append("Select tid , ")
            executeqry1.Append(" Select tid from mmm_mst_doc  where documenttype='" & Session("Document") & "' and eid=" & Session("EID") & " and ")
            'If ht.Count > 0 Then
            '    Dim z As Integer = 0
            '    For Each de As DictionaryEntry In ht
            '        executeqry.Append(de.Key)
            '        executeqry1.Append(de.Key & "='" & de.Value & "' ")
            '        z = z + 1
            '        If z = ht.Count Then
            '        Else
            '            executeqry.Append(" , ")
            '            executeqry1.Append(" and ")
            '        End If
            '    Next
            '    Dim values As String = executeqry.Append(executeqry1.ToString()).ToString()
            'End If

            If finalvalidate.Count > 0 Then
                Dim z As Integer = 0
                Dim y As Integer = finalvalidate.Count
                Dim k As Integer = 0
                For Each de As ValidateExist In finalvalidate
                    z = z + 1
                    executeqry.Append(de.FieldMapping & " as [" & de.DisplayName & "]")
                    If de.IsExtraFields = False Then
                        executeqry1.Append(de.FieldMapping & "='" & de.DBFieldValue & "' ")
                    End If
                    If z <> y Then
                        executeqry.Append(" , ")
                        If de.IsExtraFields = False And k <> str.Length - 1 Then
                            executeqry1.Append(" and ")
                            k = k + 1
                        End If

                    End If


                Next
                'Dim values As String = executeqry.Append(executeqry1.ToString()).ToString()
                da.SelectCommand.CommandType = CommandType.StoredProcedure
                da.SelectCommand.CommandText = "uspGetDetailGridByDocid_forNewfeature"
                da.SelectCommand.Parameters.Clear()
                da.SelectCommand.Parameters.AddWithValue("@DocType", Session("Document"))
                da.SelectCommand.Parameters.AddWithValue("@eid", Session("EID"))
                da.SelectCommand.Parameters.AddWithValue("@TotField", String.Join(",", fList.ToArray()))
                da.SelectCommand.Parameters.AddWithValue("@ConField", executeqry1.ToString())
                Dim dsnew As New DataTable
                da.Fill(dsnew)
                'For Each col In dsnew.Columns
                '    For Each de As ValidateExist In finalvalidate
                '        If col.ToString().Trim() = de.DisplayName.ToString().Trim() Then
                '            For Each dr As DataRow In dsnew.Rows
                '                If (dr(col.ToString()) = de.DBFieldValue.Trim()) Then
                '                    dr(col.ToString()) = de.FieldValue.Trim()
                '                End If
                '            Next
                '        End If
                '    Next
                'Next
                grdShow.DataSource = dsnew
                grdShow.DataBind()
                lblShow.Text = "Existing Records save for " & Session("Document") & ""
                UP_Show.Update()
                UP_Show1.Update()
                MP_show.Show()
            End If
        End If
        Return ""
    End Function

    '' for canera other expense - 
    <System.Web.Services.WebMethod()>
    Public Shared Function GetdbSum(documentType As String, EmpCode As String, ExpenseType As String) As String
        Dim dsFields As New DataSet()
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim JsonString As String = ""
        Dim strQuery As String = ""
        Try
            'strQuery = "select RIGHT(fld1, CHARINDEX('/', fld1) + 2) ExpDate,sum(cast(fld12 as int)) ClaimAmt from mmm_mst_doc_item  where documenttype ='OTHER EXPENSE CLAIM' AND dms.udf_split('MASTER-GL Master-fld1',fld10) IN('Data Card Expenses','Mobile Expenses') group by RIGHT(fld1, CHARINDEX('/', fld1) + 2)"
            If ExpenseType = "Mobile" Then
                strQuery = "select RIGHT(i.fld1, CHARINDEX('/', i.fld1) + 2) ExpDate,sum(cast(i.fld12 as decimal)) ClaimAmt from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid where i.documenttype ='" & documentType & "' AND dms.udf_split('MASTER-GL Master-fld1',i.fld10) IN('Data Card Expenses','Mobile Expenses') AND d.EID=" & HttpContext.Current.Session("EID") & " AND d.fld1 =" & EmpCode & "  and i.fld12<>'' group by RIGHT(i.fld1, CHARINDEX('/', i.fld1) + 2)"
            ElseIf ExpenseType = "Business" Then
                strQuery = "select RIGHT(i.fld1, CHARINDEX('/', i.fld1) + 2) ExpDate,sum(cast(i.fld12 as decimal)) ClaimAmt from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid where i.documenttype ='" & documentType & "' AND dms.udf_split('MASTER-GL Master-fld1',i.fld10) IN('Business Entertainment Expense') AND d.EID=" & HttpContext.Current.Session("EID") & " AND d.fld1 =" & EmpCode & "  and i.fld12<>'' group by RIGHT(i.fld1, CHARINDEX('/', i.fld1) + 2)"
            End If

            dsFields = DataLib.ExecuteDataSet(conStr, CommandType.Text, strQuery)
            '(dsFields.Tables(0).Rows().Count > 0) Then
            JsonString = JsonConvert.SerializeObject(dsFields.Tables(0))
            '   End If

        Catch ex As Exception
            JsonString = ""
        End Try
        Return JsonString
    End Function


    '' Feeecharge Locla Conveyance child tab =========================================
    <System.Web.Services.WebMethod()>
    Public Shared Function GetfreechargedbSum(documentType As String, EmpGrade As String, ConveyanceType As String) As String
        Dim dsFields As New DataSet()
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim JsonString As String = ""
        Dim strQuery As String = ""
        Try
            'strQuery = "select RIGHT(fld1, CHARINDEX('/', fld1) + 2) ExpDate,sum(cast(fld12 as int)) ClaimAmt from mmm_mst_doc_item  where documenttype ='OTHER EXPENSE CLAIM' AND dms.udf_split('MASTER-GL Master-fld1',fld10) IN('Data Card Expenses','Mobile Expenses') group by RIGHT(fld1, CHARINDEX('/', fld1) + 2)"
            If ConveyanceType = "Fourwheeler" Then
                strQuery = "select RIGHT(i.fld1, CHARINDEX('/', i.fld1) + 2) ExpDate,sum(cast(i.fld12 as decimal)) ClaimAmt from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid where i.documenttype ='" & documentType & "' AND dms.udf_split('MASTER-Conveyance Mode-fld1',i.fld10) IN('Four Wheeler') AND d.EID=110 AND d.fld31 =" & EmpGrade & " group by RIGHT(i.fld1, CHARINDEX('/', i.fld1) + 2)"
            End If
            If ConveyanceType = "Twowheeler" Then
                strQuery = "select RIGHT(i.fld1, CHARINDEX('/', i.fld1) + 2) ExpDate,sum(cast(i.fld12 as decimal)) ClaimAmt from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid where i.documenttype ='" & documentType & "' AND dms.udf_split('MASTER-Conveyance Mode-fld1',i.fld10) IN('Two Wheeler') AND d.EID=110 AND d.fld31 =" & EmpGrade & " group by RIGHT(i.fld1, CHARINDEX('/', i.fld1) + 2)"
            End If
            If ConveyanceType = "Taxi" Then
                strQuery = "select RIGHT(i.fld1, CHARINDEX('/', i.fld1) + 2) ExpDate,sum(cast(i.fld12 as decimal)) ClaimAmt from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid where i.documenttype ='" & documentType & "' AND dms.udf_split('MASTER-Conveyance Mode-fld1',i.fld10) IN('Taxi') AND d.EID=110 AND d.fld31 =" & EmpGrade & " group by RIGHT(i.fld1, CHARINDEX('/', i.fld1) + 2)"
            End If
            If ConveyanceType = "AutoRickshaw" Then
                strQuery = "select RIGHT(i.fld1, CHARINDEX('/', i.fld1) + 2) ExpDate,sum(cast(i.fld12 as decimal)) ClaimAmt from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid where i.documenttype ='" & documentType & "' AND dms.udf_split('MASTER-Conveyance Mode-fld1',i.fld10) IN('Auto Rickshaw') AND d.EID=110 AND d.fld31 =" & EmpGrade & " group by RIGHT(i.fld1, CHARINDEX('/', i.fld1) + 2)"
            End If

            dsFields = DataLib.ExecuteDataSet(conStr, CommandType.Text, strQuery)
            JsonString = JsonConvert.SerializeObject(dsFields.Tables(0))

        Catch ex As Exception
            JsonString = ""
        End Try
        Return JsonString
    End Function

    ''//Canera Duplicate claims =========================================
    <System.Web.Services.WebMethod()>
    Public Shared Function checkdateforDb(EmpCode As String, Date1 As String) As String
        Dim dsFields As New DataSet()
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim JsonString As String = ""
        Dim strQuery As String = ""
        Try
            'strQuery = "select RIGHT(fld1, CHARINDEX('/', fld1) + 2) ExpDate,sum(cast(fld12 as int)) ClaimAmt from mmm_mst_doc_item  where documenttype ='OTHER EXPENSE CLAIM' AND dms.udf_split('MASTER-GL Master-fld1',fld10) IN('Data Card Expenses','Mobile Expenses') group by RIGHT(fld1, CHARINDEX('/', fld1) + 2)"
            strQuery = "select Count(*)[Count] from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid where i.documenttype ='lodging expense claim'" & " AND d.EID=114 AND d.fld1 =" & EmpCode & " and convert(date,'" & Date1 & "',3) between convert(date, i.fld10,3) and convert(date, i.fld11,3) AND i.fld12 IN ('1113489','1113490')"
            dsFields = DataLib.ExecuteDataSet(conStr, CommandType.Text, strQuery)
            If (dsFields.Tables(0).Rows().Count > 0) Then
                JsonString = JsonConvert.SerializeObject(dsFields.Tables(0).Rows(0)("Count"))
            End If

        Catch ex As Exception
            JsonString = ""
        End Try
        Return JsonString
    End Function

    <System.Web.Services.WebMethod()>
    Public Shared Function checkdateforDbFoodExpense(EmpCode As String, Date1 As String) As String
        Dim dsFields As New DataSet()
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim JsonString As String = ""
        Dim strQuery As String = ""
        Try
            'strQuery = "select RIGHT(fld1, CHARINDEX('/', fld1) + 2) ExpDate,sum(cast(fld12 as int)) ClaimAmt from mmm_mst_doc_item  where documenttype ='OTHER EXPENSE CLAIM' AND dms.udf_split('MASTER-GL Master-fld1',fld10) IN('Data Card Expenses','Mobile Expenses') group by RIGHT(fld1, CHARINDEX('/', fld1) + 2)"
            strQuery = "select Count(*)[Count] from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid where i.documenttype ='lodging expense claim'" & " AND d.EID=114 AND d.fld1 =" & EmpCode & " and convert(date,'" & Date1 & "',3) between convert(date, i.fld10,3) and convert(date, i.fld11,3) AND i.fld12 ='1113656' "
            dsFields = DataLib.ExecuteDataSet(conStr, CommandType.Text, strQuery)
            If (dsFields.Tables(0).Rows().Count > 0) Then
                JsonString = JsonConvert.SerializeObject(dsFields.Tables(0).Rows(0)("Count"))
            End If

        Catch ex As Exception
            JsonString = ""
        End Try
        Return JsonString
    End Function
    'Show data for start History Transaction
    Public Sub ShowHistory(sender As Object, e As EventArgs)
        Dim btnHistory As ImageButton = TryCast(sender, ImageButton)
        Dim btnHistID() = btnHistory.ID.ToString().Split("_")
        Dim objDT As New DataTable
        Dim objDC As New DataClass
        objDT = objDC.ExecuteQryDT("select isnull(History_ConditionalField,'')as History_ConditionalField ,isnull(History_DisplayField,'') as History_DisplayField,isnull(History_Days,0) as History_Days,fieldmapping,upper(fieldType) as fieldType,documenttype,displayname  from mmm_mst_fields where fieldid= " & btnHistID(1) & " and History_DisplayField is not null or History_DisplayField<>''")
        If objDT.Rows.Count > 0 Then
            Dim dynamicQry As String = " select TID, " & objDT.Rows(0)("History_DisplayField") & " from mmm_mst_doc where " & objDT.Rows(0)("fieldmapping") & " ="
            If objDT.Rows(0)("fieldType") = "AUTOCOMPLETE" Then
                Dim hdnfield As HiddenField = CType(pnlFields.FindControl("HDN" & btnHistID(1)), HiddenField)
                dynamicQry = dynamicQry & "'" & hdnfield.Value & "'"
                If hdnfield.Value = String.Empty Or hdnfield.Value = "0" Then
                    ScriptManager.RegisterStartupScript(Page, Page.GetType, "MyScript", "alert('Please fill " & objDT.Rows(0).Item("displayname").ToString() & "');", True)
                    Exit Sub
                End If
            ElseIf objDT.Rows(0)("fieldType") = "DROP DOWN" Then
                Dim ddl As DropDownList = CType(pnlFields.FindControl("HDN" & btnHistID(1)), DropDownList)
                dynamicQry = dynamicQry & "'" & ddl.SelectedValue & "'"
                If ddl.SelectedValue = "0" Or ddl.SelectedItem.Text = "SELECT" Then
                    ScriptManager.RegisterStartupScript(Page, Page.GetType, "MyScript", "alert('Please Select " & objDT.Rows(0).Item("displayname").ToString() & "');", True)
                    ddl.Focus()
                    Exit Sub
                End If
            End If
            dynamicQry = dynamicQry & " and eid=" & Session("EID") & " and documenttype='" & objDT.Rows(0)("documenttype") & "' and lastupdate between dateadd(dd,-" & objDT.Rows(0)("History_Days") & ", getdate()) and getdate()"
            If objDT.Rows(0)("History_ConditionalField") <> String.Empty Or objDT.Rows(0)("History_ConditionalField") = "" Then
                Dim conditionalFields As String() = objDT.Rows(0)("History_ConditionalField").ToString().Split(",")
                For i As Integer = 0 To conditionalFields.Length - 1
                    Dim ctrl = pnlFields.FindControl("fld" & conditionalFields(i))
                    If Not ctrl Is Nothing Then
                        If ctrl.GetType() Is GetType(System.Web.UI.WebControls.DropDownList) Then
                            Dim ddl As DropDownList = CType(pnlFields.FindControl("fld" & conditionalFields(i)), DropDownList)
                            dynamicQry = dynamicQry & " and " & conditionalFields(i) & " ='" & ddl.SelectedValue & "'"
                        ElseIf ctrl.GetType() Is GetType(System.Web.UI.WebControls.TextBox) Then
                            Dim txt As TextBox = CType(pnlFields.FindControl("fld" & conditionalFields(i)), TextBox)
                            dynamicQry = dynamicQry & " and " & conditionalFields(i) & " ='" & txt.Text & "'"
                        End If
                    End If
                Next

            End If
            Dim dtTempData As DataTable
            dtTempData = (objDC.ExecuteQryDT(dynamicQry))
            If dtTempData.Rows.Count > 0 Then
                grdShowPopupHistory.DataSource = dtTempData
                grdShowPopupHistory.DataBind()
            Else
                grdShowPopupHistory.DataSource = dtTempData
                grdShowPopupHistory.EmptyDataText = "There were no record found against this transaction"
                grdShowPopupHistory.DataBind()
            End If
            UpdatePanel_ShowPopupHistory.Update()
            btnShowPopupHistory_ModalPopupExtender.Show()
        Else
            ScriptManager.RegisterStartupScript(Page, Page.GetType, "MyScript", "alert('There were no configuration for transactional history');", True)
        End If
    End Sub
    Protected Sub grdShowPopupHistory_RowDataBound(sender As Object, e As GridViewRowEventArgs) Handles grdShowPopupHistory.RowDataBound
        If e.Row.RowType = DataControlRowType.DataRow Then
            e.Row.Attributes.Add("onclick", "javascript:return OpenWindow('DocDetail.aspx?DOCID=" & grdShowPopupHistory.DataKeys(e.Row.RowIndex).Value & "')")
            e.Row.Attributes("style") = "cursor:pointer"
            e.Row.Attributes("class") = "tdhover"
        End If
    End Sub

    'Show data for END History Transaction
    <System.Web.Services.WebMethod()>
    Public Shared Function checkBillNoforDb(EmpCode As String, BillNo As String) As String
        Dim dsFields As New DataSet()
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim JsonString As String = ""
        Dim strQuery As String = ""
        Try
            'strQuery = "select RIGHT(fld1, CHARINDEX('/', fld1) + 2) ExpDate,sum(cast(fld12 as int)) ClaimAmt from mmm_mst_doc_item  where documenttype ='OTHER EXPENSE CLAIM' AND dms.udf_split('MASTER-GL Master-fld1',fld10) IN('Data Card Expenses','Mobile Expenses') group by RIGHT(fld1, CHARINDEX('/', fld1) + 2)"
            If HttpContext.Current.Session("EID") = 114 Then
                strQuery = "select Count(*)[Count] from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid  where d.EID=" & HttpContext.Current.Session("EID") & " AND d.fld1 =" & EmpCode & " and i.fld10 IN ('1113659','1116055') and i.documenttype ='Other expense claim' and i.fld14='" & BillNo & "'"
            Else
                'strQuery = "select Count(*)[Count] from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid  where d.EID=" & HttpContext.Current.Session("EID") & " AND d.fld1 =" & EmpCode & " and i.fld10 IN ('1254308','1254312') and i.documenttype ='Other expense claim' and i.fld14='" & BillNo & "'"
                strQuery = "select Count(*)[Count],d.fld24 [Claim ID] from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid  where d.EID=" & HttpContext.Current.Session("EID") & " AND d.fld1 =" & EmpCode & " and i.fld10 IN ('1254308','1254312') and i.documenttype ='Other expense claim' and i.fld14='" & BillNo & "' group by d.fld24"
            End If

            dsFields = DataLib.ExecuteDataSet(conStr, CommandType.Text, strQuery)
            If (dsFields.Tables(0).Rows().Count > 0) Then
                JsonString = JsonConvert.SerializeObject(dsFields.Tables(0))
            End If

        Catch ex As Exception
            JsonString = ""
        End Try
        Return JsonString
    End Function



    '' for hcl - vendor invoice vp - retainer invoice duplicity check 
    <System.Web.Services.WebMethod()>
    Public Shared Function CheckWorkingDayForHCLVendorInvVP(EmpCode As String, Month As String) As String
        Dim dsFields As New DataSet()
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim JsonString As String = ""
        Dim strQuery As String = ""
        Try
            strQuery = "SELECT fld164 EMPCode,fld188 ForMonth,fld195 WorkingDay FROM MMM_MST_DOC WHERE EID =46 and  DocumentType='Vendor Invoice VP' AND fld164 =" & EmpCode & " AND fld188 =" & Month & ""

            dsFields = DataLib.ExecuteDataSet(conStr, CommandType.Text, strQuery)
            JsonString = JsonConvert.SerializeObject(dsFields.Tables(0))

        Catch ex As Exception
            JsonString = ""
        End Try
        Return JsonString
    End Function

    <System.Web.Services.WebMethod()>
    Public Shared Function checkOtherExpClaimForManth(documentType As String, EmpCode As String, monthYear As String, expenseType As String) As String
        Dim dsFields As New DataSet()
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim JsonString As String = ""
        Dim strQuery As String = ""
        Try
            'strQuery = "select RIGHT(fld1, CHARINDEX('/', fld1) + 2) ExpDate,sum(cast(fld12 as int)) ClaimAmt from mmm_mst_doc_item  where documenttype ='OTHER EXPENSE CLAIM' AND dms.udf_split('MASTER-GL Master-fld1',fld10) IN('Data Card Expenses','Mobile Expenses') group by RIGHT(fld1, CHARINDEX('/', fld1) + 2)"
            strQuery = "select RIGHT(i.fld1, CHARINDEX('/', i.fld1) + 2) ExpDate,i.fld12 ClaimAmt from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid where i.documenttype ='" & documentType & "' AND dms.udf_split('MASTER-GL Master-fld1',i.fld10) IN('" + expenseType + "') AND d.EID=" & HttpContext.Current.Session("EID") & " AND d.fld1 ='" & EmpCode & "' AND RIGHT(i.fld1, CHARINDEX('/', i.fld1) + 2) ='" & monthYear & "'"

            dsFields = DataLib.ExecuteDataSet(conStr, CommandType.Text, strQuery)
            '(dsFields.Tables(0).Rows().Count > 0) Then
            JsonString = JsonConvert.SerializeObject(dsFields.Tables(0))
            '   End If

        Catch ex As Exception
            JsonString = ""
        End Try
        Return JsonString
    End Function

    ' for canera - traveling exp. duplicity 

    <System.Web.Services.WebMethod()>
    Public Shared Function checkBillNoforDb_trvl_Conv_Lodging(EmpCode As String, BillNo As String, Type As String, CompareTypeVal As String) As String
        Dim dsFields As New DataSet()
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim JsonString As String = ""
        Dim strQuery As String = ""
        Try
            If Type = "Travel Expense Claim" Then
                strQuery = "select Count(*)[Count] from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid  where d.EID=" & HttpContext.Current.Session("EID") & " AND d.fld1 =" & EmpCode & " and   i.documenttype ='travel expense claim' and i.fld12='" & BillNo & "' and i.fld17='" & CompareTypeVal & "'"
            ElseIf Type = "Lodging Expense Claim" Then
                strQuery = "select Count(*)[Count] from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid  where d.EID=" & HttpContext.Current.Session("EID") & " AND d.fld1 =" & EmpCode & " and   i.documenttype ='" & Type & "' and i.fld16='" & BillNo & "' and i.fld12='" & CompareTypeVal & "'"
            Else
                strQuery = "select Count(*)[Count] from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid  where d.EID=" & HttpContext.Current.Session("EID") & " AND d.fld1 =" & EmpCode & " and   i.documenttype ='" & Type & "' and i.fld16='" & BillNo & "' and i.fld10 ='" & CompareTypeVal & "'"
            End If
            'strQuery = "select RIGHT(fld1, CHARINDEX('/', fld1) + 2) ExpDate,sum(cast(fld12 as int)) ClaimAmt from mmm_mst_doc_item  where documenttype ='OTHER EXPENSE CLAIM' AND dms.udf_split('MASTER-GL Master-fld1',fld10) IN('Data Card Expenses','Mobile Expenses') group by RIGHT(fld1, CHARINDEX('/', fld1) + 2)"

            dsFields = DataLib.ExecuteDataSet(conStr, CommandType.Text, strQuery)
            If (dsFields.Tables(0).Rows().Count > 0) Then
                JsonString = JsonConvert.SerializeObject(dsFields.Tables(0).Rows(0)("Count"))
            End If

        Catch ex As Exception
            JsonString = ""
        End Try
        Return JsonString
    End Function

    <System.Web.Services.WebMethod()>
    Public Shared Function checkdateforDbTravelExpense(EmpCode As String, BillNo As String, ArrCity As String, DeptCity As String) As String
        Dim dsFields As New DataSet()
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim JsonString As String = ""
        Dim strQuery As String = ""
        Try
            If HttpContext.Current.Session("EID") = 114 Then
                strQuery = "select Count(*)[Count] from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid where d.EID = " & HttpContext.Current.Session("EID") & "  AND d.fld1 =" & EmpCode & "  and i.documenttype ='travel expense claim' " & " and i.fld11='" & ArrCity & "' and i.fld16='" & DeptCity & "' and i.fld12='" & BillNo & "'"
            Else
                strQuery = "select Count(*)[Count] from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid where d.EID = " & HttpContext.Current.Session("EID") & "  AND d.fld1 =" & EmpCode & "  and i.documenttype ='travel expense claim' " & " and i.fld11='" & ArrCity & "' and i.fld16='" & DeptCity & "' and i.fld12='" & BillNo & "'"
            End If

            dsFields = DataLib.ExecuteDataSet(conStr, CommandType.Text, strQuery)
            If (dsFields.Tables(0).Rows().Count > 0) Then
                JsonString = JsonConvert.SerializeObject(dsFields.Tables(0).Rows(0)("Count"))
            End If

        Catch ex As Exception
            JsonString = ""
        End Try
        Return JsonString
    End Function

    <System.Web.Services.WebMethod()>
    Public Shared Function checkdateforDbTravelExpenseFromDB(EmpCode As String, Date1 As String, Date2 As String, ArrCity As String, DeptCity As String) As String
        Dim dsFields As New DataSet()
        Dim conStr As String = ConfigurationManager.ConnectionStrings("conStr").ConnectionString
        Dim JsonString As String = ""
        Dim strQuery As String = ""
        Try

            strQuery = "select Count(*)[Count] from mmm_mst_doc_item i INNER JOIN MMM_MST_DOC d ON i.DOCID = d.tid where d.EID = " & HttpContext.Current.Session("EID") & "  AND d.fld1 =" & EmpCode & "  and i.documenttype ='travel expense claim' " & " and i.fld11='" & ArrCity & "' and i.fld16='" & DeptCity & "' and ((convert(date,'" & Date1 & "',3) between convert(date,i.fld1,3) and convert(date,i.fld10,3)) or  " & "(convert(date,'" & Date1 & "',3) between convert(date,i.fld1,3) and convert(date,i.fld10,3)) )"
            dsFields = DataLib.ExecuteDataSet(conStr, CommandType.Text, strQuery)
            If (dsFields.Tables(0).Rows().Count > 0) Then
                JsonString = JsonConvert.SerializeObject(dsFields.Tables(0).Rows(0)("Count"))
            End If

        Catch ex As Exception
            JsonString = ""
        End Try
        Return JsonString
    End Function


End Class




Public Class ValidateExist
    Public fieldType As String
    Public DisplayName As String
    Public FieldID As Integer
    Public FieldValue As String
    Public DBFieldValue As String
    Public FieldMapping As String
    Public IsExtraFields As Boolean
    Public DOCID As Integer

    Public Sub New(ByVal _FieldType As String, ByVal _DisplayName As String, ByVal _FieldID As Integer, ByVal _FieldValue As String, ByVal _DBFieldValue As String, _Fieldmapping As String, _IsExtraFields As Boolean, Optional ByVal tid As Integer = 0)
        fieldType = _FieldType
        DisplayName = _DisplayName
        FieldID = _FieldID
        FieldValue = _FieldValue
        DBFieldValue = _DBFieldValue
        FieldMapping = _Fieldmapping
        IsExtraFields = _IsExtraFields
        DOCID = tid
    End Sub

End Class